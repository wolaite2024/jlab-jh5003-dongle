<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Hearable_Manual"></a>
APP HEARABLE Module Application Note </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.3</b></center><p><br />
 </p><center><b>2023/07/03</b></center> <div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_HEARABLE_Module_Revision_History"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V0.0.0.1  </td><td class="markdownTableBodyCenter">2021/08/31  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V0.0.0.2  </td><td class="markdownTableBodyCenter">2022/07/04  </td><td class="markdownTableBodyCenter">Add vendor effect, program   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.3  </td><td class="markdownTableBodyCenter">2023/07/03  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Revision_History">Revision History</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Table_List">Table List</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Introduction">1 Introduction</a><ul>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Introduction_Feature">1.1 Features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Configuration">2 Configuration</a><ul>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_MCUConfigTool_Configuration">2.1 MCUConfigTool Configuration</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_DSPConfigTool_Configuration">2.2 DSPConfigTool Configuration</a></li>
</ul>
</li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Overview">3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Initialize_HA_Module">3.1 Initialize HA module</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Mechanism">3.2 Set HA program effect Mechanism</a><ul>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Through_DSP_Config">3.2.1 Set HA program effect through dsp config</a></li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Through_Remote_peer">3.2.2 Set HA program effect through remote peer</a></li>
</ul>
</li>
<li><a class="el" href="_a_n055__a_p_p__h_e_a_r_a_b_l_e__m_o_d_u_l_e.html#APP_HEARABLE_Module_Source_Code_Access_HA_Program_Mechanism">3.3 Access HA program Mechanism</a> <div style="page-break-after: always;"></div></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="APP_HEARABLE_Module_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_HEARABLE_Module_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 Enable DSP APT in MCUConfig tool</a></li>
<li><a href="#figure_2_2">Figure 2-2 Set Power on listening mode in MCUConfig tool</a></li>
<li><a href="#figure_2_3">Figure 2-3 Enable RHA option in MCUConfig tool</a></li>
<li><a href="#figure_2_4">Figure 2-4 Enable DSP APT in DSPConfig tool</a></li>
<li><a href="#figure_2_5">Figure 2-5 Enable RHA option in DSPConfig tool</a> <div style="page-break-after: always;"></div></li>
</ul>
<h2><a class="anchor" id="APP_HEARABLE_Module_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">HA  </td><td class="markdownTableBodyCenter">Hearing Aids   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">HA program  </td><td class="markdownTableBodyCenter">A scenario for HA that stores HA effects' parameters, HA UI options   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">HA program effect  </td><td class="markdownTableBodyCenter">A HA effect which a group of paramaters, that is stored in HA program   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_HEARABLE_Module_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of the app hearable module for customer. The document describes how to use app hearable module in app project.</p>
<h3><a class="anchor" id="APP_HEARABLE_Module_Introduction_Feature"></a>
1.1 Features</h3>
<ul>
<li>Apply HA effects<ul>
<li>When the device enter DSP APT / DSP APT + ANC mode it would load HA effect store in the HA progrm that the program idx points to.</li>
<li>When the device is under DSP APT / DSP APT + ANC mode, and HA effects is adjust on the APP. It would apply HA effectes sent by the APP.</li>
</ul>
</li>
<li>Switch HA programs<ul>
<li>The device would apply the HA effects stored in the switched HA program.</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="APP_HEARABLE_Module_Configuration"></a>
2 Configuration</h2>
<p>To enable HA module. It needs to configure rcfg through McuConfigTool, and configure dsp config through DSPConfigTool.</p>
<h3><a class="anchor" id="APP_HEARABLE_Module_MCUConfigTool_Configuration"></a>
2.1 MCUConfigTool Configuration</h3>
<p>Enable Normal APT in "HW Feature" page.</p>
<center> <div class="image">
<img src="app_hearable_mcuconfig_enable_dspapt.png" alt="app_hearable_mcuconfig_enable_dspapt.png" width="800px" height="600px"/>
</div>
 <div id="figure_2_1"><b>Figure 2-1 Enable DSP APT in MCUConfig tool </b></div> </center> <div style="page-break-after: always;"></div><p>Select Listening mode status when power on option in "Audio" page. </p><center> <div class="image">
<img src="app_hearable_mcuconfig_power_on_listening_mode.png" alt="app_hearable_mcuconfig_power_on_listening_mode.png" width="800px" height="600px"/>
</div>
 <div id="figure_2_2"><b>Figure 2-2 Set Power on listening mode in MCUConfig tool</b></div> </center><p>Enable RHA option in "RHA" page.</p>
<center> <div class="image">
<img src="app_hearable_mcuconfig_enable_rha.png" alt="app_hearable_mcuconfig_enable_rha.png" width="811px" height="216px"/>
</div>
 <div id="figure_2_3"><b>Figure 2-3 Enable RHA option in MCUConfig tool</b></div> </center><h2><a class="anchor" id="APP_HEARABLE_Module_DSPConfigTool_Configuration"></a>
2.2 DSPConfigTool Configuration</h2>
<p>Enable APT and select Normal APT in "Audio" page.</p>
<center> <div class="image">
<img src="app_hearable_dspconfig_enable_dspapt.png" alt="app_hearable_dspconfig_enable_dspapt.png" width="677px" height="450px"/>
</div>
 <div id="figure_2_4"><b>Figure 2-4 Enable DSP APT in DSPConfig tool</b></div> </center><p>Checked Enable HA option in option bar.</p>
<center> <div class="image">
<img src="app_hearable_dspconfig_enable_rha.png" alt="app_hearable_dspconfig_enable_rha.png" width="905px" height="305px"/>
</div>
 <div id="figure_2_5"><b>Figure 2-5 Enable RHA option in DSPConfig tool</b></div> </center> <div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Overview"></a>
3 Source Code Overview</h2>
<p>The source code consists of <b>APP_HEARABLE</b> part. The details will be described in the following sections.</p>
<p>This section describes app hearable module. The reference file is shown as follows:</p>
<ul>
<li>Project source code directory: sdk\src\sample\rws\app_hearable.c <br />
 The file contains functions to handle hearable related behavior.</li>
<li>Project source code directory: sdk\src\sample\rws\app_cmd.c <br />
The file implements functions to handle SPP/BLE commands including commands specified for hearable module.</li>
</ul>
<h3><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Initialize_HA_Module"></a>
3.1 Initialize HA module</h3>
<p>Initialize HA module including following steps:</p><ul>
<li>Create HA effect instances.</li>
<li>Initialize the instance to read / write HA FTL.</li>
<li>Initialize HA program which store HA effect parameters, program object parameters.</li>
<li>Initialize HA timer cback for delay open APT, fade in APT volume usage.</li>
<li>Initialize HA relay cback for rws bud to sync control, data message.</li>
<li>Initialize HA cmd cback to handle payloads contains HA effect parameters which is sent through <a class="el" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a2e9ab999c2e3c21890ea725a1f8360e1">CMD_SEND_RAW_PAYLOAD</a>.</li>
<li>Initialize HA audio cback to apply HA effects when APT on, report audio volume posted by DSP.</li>
<li>Bind specify cback to call when APT on. The cback which currently used is to load HA program.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_ha_init()</div><div class="line">{</div><div class="line">    ha_effect_db = calloc(1, <span class="keyword">sizeof</span>(T_HA_EFFECT_DB));</div><div class="line">    ha_effect_db-&gt;queue = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___o_s___q_u_e_u_e.html">T_OS_QUEUE</a>));</div><div class="line">    <a class="code" href="group___o_s__87x3e___queue___exported__functions.html#gace09f1bc91cf55ef47b9c31109709947">os_queue_init</a>(ha_effect_db-&gt;queue);</div><div class="line"></div><div class="line">    ha_prog_db = calloc(1, <span class="keyword">sizeof</span>(T_HA_PROG_DB));</div><div class="line">    ha_prog_db-&gt;obj_queue = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___o_s___q_u_e_u_e.html">T_OS_QUEUE</a>));</div><div class="line">    <a class="code" href="group___o_s__87x3e___queue___exported__functions.html#gace09f1bc91cf55ef47b9c31109709947">os_queue_init</a>(ha_prog_db-&gt;obj_queue);</div><div class="line"></div><div class="line">    app_ha_effect_set_scheme();</div><div class="line"></div><div class="line">    ha_ext_ftl_storage_init();</div><div class="line"></div><div class="line">    app_ha_prog_init();</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga5d2a3ae9710b2036a2907647a1932f0f">app_timer_reg_cb</a>(app_ha_timeout_cb, &amp;ha_timer_id);</div><div class="line">    <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga3973f461a62ef1eadfe82daa3f18ce8e">app_relay_cback_register</a>(app_ha_relay_cback, app_ha_parse_cback,</div><div class="line">                             <a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedea0547a81bdc0db8a5e443124749a2bae5">APP_MODULE_TYPE_HA</a>, APP_REMOTE_MSG_HA_TOTAL);</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___functions.html#ga7e956f5a8476c6d9ff855116ed2456e1">app_cmd_cback_register</a>(app_ha_cmd_cback, <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggab3ed120700c8115bca3451a692de6849a0599aa1cf353c40d8ebe42385cfba274">APP_CMD_MODULE_TYPE_HA</a>);</div><div class="line">    <a class="code" href="group___a_u_d_i_o___m_a_n_a_g_e_r___a_u_d_i_o.html#ga67189dab89dfb141cf0ada6529f057bd">audio_mgr_cback_register</a>(app_ha_audio_cback);</div><div class="line">    app_ha_effect_apply_cback_register(app_ha_effect_apply_cback);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Mechanism"></a>
3.2 Set HA program effect Mechanism</h3>
<p>HA program effect can be set from two routes. It can be set from dsp config which contains HA program effect parameters, either can be set from remote peer (ex: AudioConnect APP) through <a class="el" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a2e9ab999c2e3c21890ea725a1f8360e1">CMD_SEND_RAW_PAYLOAD</a> cmd that can transfer custom HA program effect parameters to specify ear buds.</p>
<h4><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Through_DSP_Config"></a>
3.2.1 Set HA program effect through dsp config</h4>
<p>When HA version column marked in HA FTL is different from the same column marked in dsp config, then HA FTL would be initialized through preset HA program stored in dsp config. Which HA program effect is set when Initializing HA program.</p>
<p>source code directory: sdk/src/sample/rws/app_hearable.c </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_ha_prog_init()</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">if</span> (buf[3] != app_ha_version_get())</div><div class="line">    {</div><div class="line">        <span class="comment">//need to init FTL, prog db from scratch or dsp config</span></div><div class="line">        <span class="keywordflow">if</span> (app_ha_dsp_prog_is_set())</div><div class="line">        {</div><div class="line">            app_ha_dsp_prog_load();</div><div class="line">            is_init = app_ha_prog_db_load();</div><div class="line">        }</div><div class="line">        ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Set_HA_Program_Effect_Through_Remote_peer"></a>
3.2.2 Set HA program effect through remote peer</h4>
<p>HA program effect that needs to transfer to ear buds may larger than SPP/BLE MTU size. To handle this situation, the ear bud is expected to handle HA program effect through <a class="el" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a2e9ab999c2e3c21890ea725a1f8360e1">CMD_SEND_RAW_PAYLOAD</a>. The cmd handler has the compatibility to restore segment data into origin data and send to specify ear bud or both buds.</p>
<p>The HA program effect that needs to transfer to ear buds could be generated by calling APP SDK's rha_lib HA program effect api. The api has implemented the cmd protocol. </p><div style="page-break-after: always;"></div><p>The code below shows the flow to handle cmd payload and send to opposite ear bud if needed.</p>
<p>source code directory: sdk/src/sample/rws/app_cmd.c </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_m_d___exported___functions.html#gae6e146af6a4381218d925b2dc90433e8">app_cmd_handler</a>(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t rx_seqn,</div><div class="line">                     uint8_t app_idx)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (cmd_id)</div><div class="line">    {</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a2e9ab999c2e3c21890ea725a1f8360e1">CMD_SEND_RAW_PAYLOAD</a>:</div><div class="line">        ...</div><div class="line">        {</div><div class="line">            app_cmd_general_cmd_handle(cmd_ptr, cmd_len, cmd_path, app_idx, ack_pkt);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_cmd.c </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_cmd_general_cmd_handle(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t app_idx, uint8_t *ack_pkt)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (cmd_id)</div><div class="line">    {</div><div class="line">    ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a2e9ab999c2e3c21890ea725a1f8360e1">CMD_SEND_RAW_PAYLOAD</a>:</div><div class="line">        {</div><div class="line">            ...</div><div class="line">            <span class="keywordflow">if</span> (cmd_len - 2 &lt; 6)</div><div class="line">            {</div><div class="line">                ack_pkt[2] = <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggaa6202e31ef44974e323bcaeef3e60f49ae252bdc2f058b8511d74ef56171fcb26">CMD_SET_STATUS_PARAMETER_ERROR</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gabf4d3a159acbed0d34f07aba5c0d6b9d">app_audio_get_seg_send_status</a>())</div><div class="line">            {</div><div class="line">                ack_pkt[2] = <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggaa6202e31ef44974e323bcaeef3e60f49a5fae420c415915c4f8040452067d2e36">CMD_SET_STATUS_DISALLOW</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> == <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a52f9edca7136cdeaabe8942e059fa05e">REMOTE_SESSION_ROLE_PRIMARY</a> &amp;&amp;</div><div class="line">                    (direction != <a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a070baa3999451473bc481de199ca10a2">bud_side</a> || direction == DEVICE_BUD_SIDE_BOTH))</div><div class="line">                {</div><div class="line">                    <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga6413b2e9fd31055e1305419884f36042">app_relay_async_single_with_raw_msg</a>(<a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedea4bc7b05c0be534051c7e58f12cab200f">APP_MODULE_TYPE_CMD</a>, <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga3dc51a6820aa382d74353d811cbd7b0ea43a16455e556fdf385bfa7c07ce25d62">APP_REMOTE_MSG_SYNC_RAW_PAYLOAD</a>,</div><div class="line">                                                        cmd_ptr + 2, cmd_len - 2);</div><div class="line">                }</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (direction == <a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a070baa3999451473bc481de199ca10a2">bud_side</a> || direction == DEVICE_BUD_SIDE_BOTH)</div><div class="line">                {</div><div class="line">                    ack_pkt[2] = app_cmd_compose_payload(cmd_ptr + 2, cmd_len - 2);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gab68a0f6aaed4553d0c5bad7608f434dc">app_report_event</a>(cmd_path, <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a224b309b64b9729b2ce0b57bc39a84a4">EVENT_ACK</a>, app_idx, ack_pkt, 3);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Restored cmd payload that contains HA program effect would be distribute to app_ha_cmd_cback() that is binded with <a class="el" href="group___a_p_p___c_m_d___exported___types.html#ggab3ed120700c8115bca3451a692de6849a0599aa1cf353c40d8ebe42385cfba274">APP_CMD_MODULE_TYPE_HA</a>.</p>
<p>source code directory: <a class="el" href="rws_2app__cmd_8h_source.html">sdk/src/sample/rws/app_cmd.h</a> <br />
 </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggab3ed120700c8115bca3451a692de6849a50dfae167406c90b974bef8392489a72">APP_CMD_MODULE_TYPE_NONE</a>              = 0x00,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggab3ed120700c8115bca3451a692de6849a5fc7cf6e4562ae8ae6a2201ff0ffcfd5">APP_CMD_MODULE_TYPE_AUDIO_POLICY</a>      = 0x01,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggab3ed120700c8115bca3451a692de6849a0599aa1cf353c40d8ebe42385cfba274">APP_CMD_MODULE_TYPE_HA</a>                = 0x02,</div><div class="line">} <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gab3ed120700c8115bca3451a692de6849">T_APP_CMD_MODULE_TYPE</a>;</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_cmd.c <br />
 </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> app_cmd_compose_payload(uint8_t *data, uint16_t data_len)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">if</span> (type == <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggacf2df9d1b470b58a11c9c3a3b9129defae278f99403c6c815fc5b80721d1eb020">PKT_TYPE_SINGLE</a> || type == <a class="code" href="group___a_p_p___c_m_d___exported___types.html#ggacf2df9d1b470b58a11c9c3a3b9129defa95cbe6e6fd7efe9ece7aad63564c6c73">PKT_TYPE_END</a>)</div><div class="line">    {</div><div class="line">        app_cmd_distribute_payload(buf, total_len);</div><div class="line">        ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> app_cmd_distribute_payload(uint8_t *buf, uint16_t len)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">while</span> (p_item != <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (p_item-&gt;module_type == module_type)</div><div class="line">        {</div><div class="line">            p_item-&gt;parse_cback(msg_type, buf + 2, len - 2);</div><div class="line"></div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line"></div><div class="line">        p_item = p_item-&gt;p_next;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><p>The handler would determine the msg type containd in the HA program effect payload then call function to parse HA program effect cmd payload, and apply contained parameters to DSP then write on HA FTL.</p>
<p>source code directory: sdk/src/sample/rws/app_hearable.c <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_ha_cmd_cback(uint8_t msg_type, uint8_t *buf, uint16_t len)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (msg_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> APP_HA_CMD_MSG_SET_EFFECT_CMD:</div><div class="line">        {</div><div class="line">            app_ha_handle_effect_payload(buf);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_hearable.c <br />
 </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_ha_handle_effect_payload(uint8_t *buf)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span> (effect_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_WDRC:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_NR:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_GRAPHIC_EQ:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_FBC:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_OVP:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_BF:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_WNR:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_INR:</div><div class="line">    <span class="keywordflow">case</span> HA_EFFECT_RNS:</div><div class="line">        {</div><div class="line">            ...</div><div class="line">            <span class="keywordflow">if</span> (effect_len &gt; 0)</div><div class="line">            {</div><div class="line">                app_ha_effect_set((T_APP_HA_EFFECT)effect_type, buf + effect_offset, effect_len);</div><div class="line">                app_ha_effect_apply((T_APP_HA_EFFECT)effect_type);</div><div class="line">                app_ha_prog_set_object(ha_prog_db-&gt;selectable_prog_idx,</div><div class="line">                                       HA_EFFECT_TO_PROG_OBJ(effect_type),</div><div class="line">                                       buf + effect_offset);</div><div class="line">                ...</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_HEARABLE_Module_Source_Code_Access_HA_Program_Mechanism"></a>
3.3 Access HA program Mechanism</h3>
<p>The ear bud is expected to be accessed from CMD_HA_ACCESS_PROGRAM. The cmd handler can determine which type of access operaion to be processed by the cmd payload. Peer device (ex: AudioConnect APP) could send CMD_HA_ACCESS_PROGRAM with sub opcode defined in T_APP_HA_PROG_OPCODE to access HA programs data stored in ear bud's HA FTL.</p>
<p>The code below shows the flow to hanlde CMD_HA_ACCESS_PROGRAM and process specify operation according to sub opcode contained in cmd payload.</p>
<p>source code directory: sdk/src/sample/rws/app_cmd.c <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_m_d___exported___functions.html#gaae86df03df99e0ebc206b13157ab3c18">app_handle_cmd_set</a>(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t rx_seqn,</div><div class="line">                        uint8_t app_idx)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (cmd_id)</div><div class="line">    {</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> CMD_HA_ACCESS_PROGRAM:</div><div class="line">    ...</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#aed4876ba812c23a247c7b4379fba4c3e">enable_ha</a>)</div><div class="line">            {</div><div class="line">                app_ha_cmd_handle(cmd_ptr, cmd_len, cmd_path, app_idx, ack_pkt);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_hearable.c <br />
 </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    HA_PROG_OPCODE_GET_NUM      = 0x00,</div><div class="line">    HA_PROG_OPCODE_GET_ID       = 0x01,</div><div class="line">    HA_PROG_OPCODE_SET_ID       = 0x02,</div><div class="line">    HA_PROG_OPCODE_GET_OBJ      = 0x03,</div><div class="line">    HA_PROG_OPCODE_SET_OBJ      = 0x04,</div><div class="line">    HA_PROG_OPCODE_GET_ALL_OBJ  = 0x05,</div><div class="line">    HA_PROG_OPCODE_SET_ALL_OBJ  = 0x06,</div><div class="line">    HA_PROG_OPCODE_RESET_OBJ    = 0x07,</div><div class="line">    HA_PROG_OPCODE_TOTAL        = 0x08,</div><div class="line">} T_APP_HA_PROG_OPCODE;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_ha_cmd_handle(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t app_idx, uint8_t *ack_pkt)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> CMD_HA_ACCESS_PROGRAM:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (cmd_ptr[2])</div><div class="line">            {</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_GET_NUM:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_GET_ID:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_SET_ID:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_GET_OBJ:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_SET_OBJ:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_GET_ALL_OBJ:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_SET_ALL_OBJ:</div><div class="line">                ...</div><div class="line">            <span class="keywordflow">case</span> HA_PROG_OPCODE_RESET_OBJ:</div><div class="line">                ...</div><div class="line">            }</div><div class="line">        }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
