<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="BLE_STACK_Page"></a>
BLE Stack User Manual    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.4</b></center><p><br />
 </p><center><b>2024/01/05</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Revision"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2022/10/24  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/03/13  </td><td class="markdownTableBodyCenter">Adjust the document structure   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.2  </td><td class="markdownTableBodyCenter">2023/03/17  </td><td class="markdownTableBodyCenter">Adjust the document structure   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.3  </td><td class="markdownTableBodyCenter">2023/05/30  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.4  </td><td class="markdownTableBodyCenter">2024/01/05  </td><td class="markdownTableBodyCenter">Modify chapter2.4.1   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Content"></a>
Contents</h2>
<ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Revision">Revision History</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Table_List">Table List</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Figure_List">Figure List</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Glossary">Glossary</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Introduction">1 Overview</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Supported_Bluetooth_Technology_Features">1.1 Supported Bluetooth Technology Features</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Architecture">1.2 Bluetooth LE Profile Architecture</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP">1.2.1 GAP</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GATT_Based_Profile">1.2.2 GATT Based Profile</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_APIs">1.3 Bluetooth LE APIs</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_GAP">2 GAP</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Structure_Overview">2.1 GAP Structure Overview</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Location">2.1.1 GAP Location</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Capacity">2.1.2 GAP Capacity</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_State">2.1.3 GAP State</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Message">2.1.4 GAP Message</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#APP_Message_Flow">2.1.5 APP Message Flow</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Startup_Flow">2.2.2 GAP Startup Flow</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message_Overview">2.3.1 Overview</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message_Device_State_Message">2.3.2 Device State Message</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message_Connection_Related_Message">2.3.3 Connection Related Message</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message_Authentication_Related_Message">2.3.4 Authentication Related Message</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message_Extended_Advertising_State_Message">2.3.5 Extended Advertising State Message</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback_Message_Overview">2.4.1 Bluetooth LE GAP Callback Message Overview</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Use_Case">2.5 Bluetooth LE GAP Use Case</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Airplane_Mode_Setting">2.5.1 Airplane Mode Setting</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Local_IRK_Setting">2.5.2 Local IRK Setting</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Service_Characteristic_Writeable">2.5.3 GAP Service Characteristic Writeable</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#set_Local_Static_Random_Address">2.5.4 set Local Static Random Address</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Phy_Setting">2.5.5 Physical (PHY) Setting</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_Technology_Stack_Features_Setting">2.5.6 Bluetooth Technology Stack Features Setting</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Request_Pairing">2.5.7 Request Pairing</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Information_Storage">2.6 GAP Information Storage</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#FTL_Introduction">2.6.1 FTL Introduction</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Local_Stack_Information_Storage">2.6.2 Local Stack Information Storage</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bond_Information_Storage">2.6.3 Bond Information Storage</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Privacy">2.7 Bluetooth LE Privacy</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_PRIVACY_IND">2.7.1 Introduction</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_PRIVACY_MODULE">2.7.2 Privacy Management Module</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_Address">2.8 BLE Address</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_ADDR_Intro">2.8.1 Introduction</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_ADDR_Setting">2.8.2 BLE Address Setting</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GATT_Profile">3 GATT Profile</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Server">3.1 Bluetooth LE Profile Server</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_OVERVIEW">3.1.1 Overview</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_SUPPORTED">3.1.2 Supported Profile and Service</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_INTERACTION">3.1.3 Profile Server Interaction</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_IMPLEMENT_SPECIFIC_SERVICE">3.1.4 Implement Specific Service</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Client">3.2 Bluetooth LE Profile Client</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_OV">3.2.1 Overview</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_SUPPORTED">3.2.2 Supported Clients</a></li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_INTERACTION">3.2.3 Profile Client Layer</a></li>
</ul>
</li>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GATT_Profile_Use_Case">3.3 GATT Profile Use Case</a><ul>
<li><a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#ANCS_Client">3.3.1 ANCS Client</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_1_1">Table 1-1 Supported Bluetooth Technology Features</a></li>
<li><a href="#table_1_2">Table 1-2 Supported GAP APIs</a></li>
<li><a href="#table_1_3">Table 1-3 Supported GATT APIs</a></li>
<li><a href="#table_2_1">Table 2-1 Extended Advertising Parameters Setting With Legacy Advertising PDUs</a></li>
<li><a href="#table_2_2">Table 2-2 Extended Advertising Parameters Setting With Legacy Advertising PDUs</a></li>
<li><a href="#table_2_3">Table 2-3 Extended Advertising Parameters Setting With Extended Advertising PDUs</a></li>
<li><a href="#table_2_4">Table 2-4 Extended Advertising Parameters Setting With Extended Advertising PDUs</a></li>
<li><a href="#table_2_5">Table 2-5 Authentication Related Message</a></li>
<li><a href="#table_2_6">Table 2-6 gap_le.h Related Messages</a></li>
<li><a href="#table_2_7">Table 2-7 gap_conn_le.h Related Messages</a></li>
<li><a href="#table_2_8">Table 2-8 gap_bond_le.h Related Messages</a></li>
<li><a href="#table_2_9">Table 2-9 gap_scan.h Related Messages</a></li>
<li><a href="#table_2_10">Table 2-10 gap_adv.h Related Messages</a></li>
<li><a href="#table_2_11">Table 2-11 gap_dtm.h Related Messages</a></li>
<li><a href="#table_2_12">Table 2-12 gap_ext_scan.h Related Messages</a></li>
<li><a href="#table_2_13">Table 2-13 gap_ext_adv.h Related Messages</a></li>
<li><a href="#table_2_14">Table 2-14 Address Type List</a></li>
<li><a href="#table_3_1">Table 3-1 APIs in profile_server.h and profile_server_ext.h</a></li>
<li><a href="#table_3_2">Table 3-2 Profile List</a></li>
<li><a href="#table_3_3">Table 3-3 Service List</a></li>
<li><a href="#table_3_4">Table 3-4 Flags Option Value And Description</a></li>
<li><a href="#table_3_5">Table 3-5 Flags Value Select Mode</a></li>
<li><a href="#table_3_6">Table 3-6 Value Of Permissions</a></li>
<li><a href="#table_3_7">Table 3-7 Service Table Example</a></li>
<li><a href="#table_3_8">Table 3-8 Clients List</a></li>
<li><a href="#table_3_9">Table 3-9 Discovery State</a></li>
<li><a href="#table_3_10">Table 3-10 Discovery Result</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 Bluetooth LE Stack APIs</a></li>
<li><a href="#figure_1_2">Figure 1-2 GATT Based Profile Hierarchy</a></li>
<li><a href="#figure_2_1">Figure 2-1 GAP Location In SDK</a></li>
<li><a href="#figure_2_2">Figure 2-2 Advertising State Change Machine</a></li>
<li><a href="#figure_2_3">Figure 2-3 Scan State Change Machine</a></li>
<li><a href="#figure_2_4">Figure 2-4 Active State Change Machine</a></li>
<li><a href="#figure_2_5">Figure 2-5 Passive State Change Machine</a></li>
<li><a href="#figure_2_6">Figure 2-6 Extended Advertising State Transition Mechanism For One Advertising Set</a></li>
<li><a href="#figure_2_7">Figure 2-7 App Message Flow</a></li>
<li><a href="#figure_2_8">Figure 2-8 GAP Internal Initialization Flow</a></li>
<li><a href="#figure_2_9">Figure 2-9 Bluetooth Technology Stack Features Setting in Mcu Cfg Tool</a></li>
<li><a href="#figure_2_10">Figure 2-10 LE FTL Layout</a></li>
<li><a href="#figure_2_11">Figure 2-11 Add a Bond Device</a></li>
<li><a href="#figure_2_12">Figure 2-12 Remove a Bond Device</a></li>
<li><a href="#figure_2_13">Figure 2-13 Clear All Bond Devices</a></li>
<li><a href="#figure_2_14">Figure 2-14 Set a Bond Device High Priority</a></li>
<li><a href="#figure_2_15">Figure 2-15 Get High Priority Device</a></li>
<li><a href="#figure_2_16">Figure 2-16 Get Low Priority Device</a></li>
<li><a href="#figure_2_17">Figure 2-17 Priority Manager Example</a></li>
<li><a href="#figure_2_18">Figure 2-18 Format of Static Address</a></li>
<li><a href="#figure_2_19">Figure 2-19 Format of non-resolvable Private Address</a></li>
<li><a href="#figure_2_20">Figure 2-20 Format of Resolvable Private Address</a></li>
<li><a href="#figure_2_21">Figure 2-21 Transport Specific Key Distribution</a></li>
<li><a href="#figure_2_22">Figure 2-22 Logical Representation of The Resolving List and Device White List</a></li>
<li><a href="#figure_3_1">Figure 3-1 Profile Server Hierarchy</a></li>
<li><a href="#figure_3_2">Figure 3-2 Add Services to Server</a></li>
<li><a href="#figure_3_3">Figure 3-3 Register Services Process</a></li>
<li><a href="#figure_3_4">Figure 3-4 Read Characteristic Value - Attribute Value Supply in Attribute Element</a></li>
<li><a href="#figure_3_5">Figure 3-5 Read Characteristic Value - Attribute Value Supply by Application Without Result Pending</a></li>
<li><a href="#figure_3_6">Figure 3-6 Read Characteristic Value - Attribute Value Supply by Application With Result Pending</a></li>
<li><a href="#figure_3_7">Figure 3-7 Write Characteristic Value - Attribute Value Supply in Attribute Element</a></li>
<li><a href="#figure_3_8">Figure 3-8 Write Characteristic Value - Attribute Value Supply by Application Without Result Pending</a></li>
<li><a href="#figure_3_9">Figure 3-9 Write Characteristic Value - Attribute Value Supply by Application With Result Pending</a></li>
<li><a href="#figure_3_10">Figure 3-10 Write Characteristic Value - Write CCCD Value</a></li>
<li><a href="#figure_3_11">Figure 3-11 Write Without Response / Signed Write Without Response - Attribute Value Supply in Attribute Element</a></li>
<li><a href="#figure_3_12">Figure 3-12 Write Without Response / Signed Write Without Response - Attribute Value Supply by Application</a></li>
<li><a href="#figure_3_13">Figure 3-13 Write Without Response / Signed Write Without Response - Write CCCD Value</a></li>
<li><a href="#figure_3_14">Figure 3-14 Write Long Characteristic Values / Reliable Writes - Prepare Write Procedure</a></li>
<li><a href="#figure_3_15">Figure 3-15 Write Long Characteristic Values / Reliable Writes - Execute Write Without Result Pending</a></li>
<li><a href="#figure_3_16">Figure 3-16 Write Long Characteristic Values / Reliable Writes - Execute Write With Result Pending</a></li>
<li><a href="#figure_3_17">Figure 3-17 Characteristic Value Notification</a></li>
<li><a href="#figure_3_18">Figure 3-18 Characteristic Value Indication</a></li>
<li><a href="#figure_3_19">Figure 3-19 Profile Client Hierarchy</a></li>
<li><a href="#figure_3_20">Figure 3-20 Add Specific Clients To Profile Client Layer</a></li>
<li><a href="#figure_3_21">Figure 3-21 GATT Discovery Procedure</a></li>
<li><a href="#figure_3_22">Figure 3-22 Read Characteristic Value By Handle</a></li>
<li><a href="#figure_3_23">Figure 3-23 Read Characteristic Value By UUID</a></li>
<li><a href="#figure_3_24">Figure 3-24 Write Characteristic Value</a></li>
<li><a href="#figure_3_25">Figure 3-25 Write Long Characteristic Value</a></li>
<li><a href="#figure_3_26">Figure 3-26 Write Without Response</a></li>
<li><a href="#figure_3_27">Figure 3-27 Signed Write Without Response</a></li>
<li><a href="#figure_3_28">Figure 3-28 Characteristic Value Notification</a></li>
<li><a href="#figure_3_29">Figure 3-29 Characteristic Value Indication Without Result Pending</a></li>
<li><a href="#figure_3_30">Figure 3-30 Characteristic Value Indication With Result Pending</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ATT  </td><td class="markdownTableBodyCenter">Attribute protocol   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE  </td><td class="markdownTableBodyCenter">Bluetooth Low Energy   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">GAP  </td><td class="markdownTableBodyCenter">General Access Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">GATT  </td><td class="markdownTableBodyCenter">General Attribute Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">L2CAP  </td><td class="markdownTableBodyCenter">Logical Link Control and Adaptation protocol   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">SDK  </td><td class="markdownTableBodyCenter">Software Development Kit   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">SMP  </td><td class="markdownTableBodyCenter">Security Manager protocol   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">SOC  </td><td class="markdownTableBodyCenter">System on Chip   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_Introduction"></a>
1 Overview</h2>
<p>The purpose of this document is to give an overview of Bluetooth LE Stack APIs. Bluetooth LE Stack APIs can be divided into Generic Access Profile (GAP) APIs and Generic Attribute Profile (GATT) APIs. GAP APIs will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_GAP">2 GAP</a> and GATT APIs will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GATT_Profile">3 GATT Profile</a>.<br />
 </p><div class="image">
<img src="GATT_GAP_API_arch.png" alt="GATT_GAP_API_arch.png"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 Bluetooth LE Stack APIs </b></div></center><p> Figure 1-1 shows the relationship between Applications and GAP/GATT and Bluetooth Protocol Stack. Above the dotted line is developed by the Applications. Below the dotted line is developed by Realtek.<br />
 Applications can interact with GAP/GATT through APIs, MSG or Callback functions. Applications could use GAP API to control GAP, and then GAP to control Bluetooth stack. Bluetooth stack could notify GAP when bluetooth state changes, and GAP could use GAP MSG or GAP callback to notify applications. Applications could also use GATT API to control GATT, and then GATT to control Bluetooth stack. Bluetooth stack could notify GATT when bluetooth state changes, and GATT could use service or client callback to notify application.<br />
</p>
<h3><a class="anchor" id="Supported_Bluetooth_Technology_Features"></a>
1.1 Supported Bluetooth Technology Features</h3>
<p>Table 1-1 shows supported Bluetooth technology Features in rtl87x3e/rtl87x3d/rtl87x3g. </p><center><div id="table_1_1"><b>Table 1-1 Supported Bluetooth Technology Features </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Bluetooth technology feature  </th><th class="markdownTableHeadCenter">87x3e(4M)  </th><th class="markdownTableHeadCenter">87x3e(2M)  </th><th class="markdownTableHeadCenter">87x3g  </th><th class="markdownTableHeadCenter">87x3   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.0  </td><td class="markdownTableBodyCenter">Advertiser  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 4.0  </td><td class="markdownTableBodyCenter">Scanner  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.0  </td><td class="markdownTableBodyCenter">Initiator  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 4.0  </td><td class="markdownTableBodyCenter">Master  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.0  </td><td class="markdownTableBodyCenter">Slave  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 4.1  </td><td class="markdownTableBodyCenter">Low Duty Cycle Directed Advertising  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.1  </td><td class="markdownTableBodyCenter">LE L2CAP Connection<br />
Oriented Channel  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
</table>
<div style="page-break-after: always;"></div> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Bluetooth technology feature  </th><th class="markdownTableHeadCenter">87x3e(4M)  </th><th class="markdownTableHeadCenter">87x3e(2M)  </th><th class="markdownTableHeadCenter">87x3g  </th><th class="markdownTableHeadCenter">87x3   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.1  </td><td class="markdownTableBodyCenter">LE Scatternet  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 4.1  </td><td class="markdownTableBodyCenter">LE Ping  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.2  </td><td class="markdownTableBodyCenter">LE Data Packet Length Extension  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 4.2  </td><td class="markdownTableBodyCenter">LE Secure Connections  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 4.2  </td><td class="markdownTableBodyCenter">Link Layer Privacy  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.0  </td><td class="markdownTableBodyCenter">2M PHY for LE  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 5.0  </td><td class="markdownTableBodyCenter">LE Long Range  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.0  </td><td class="markdownTableBodyCenter">High Duty Cycle <br />
Non-Connectable Advertising  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 5.0  </td><td class="markdownTableBodyCenter">LE Advertising Extensions  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.0  </td><td class="markdownTableBodyCenter">LE Channel Selection Algorithm #2  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 5.1  </td><td class="markdownTableBodyCenter">GATT Caching  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.1  </td><td class="markdownTableBodyCenter">AOA&amp;AOD  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 5.1  </td><td class="markdownTableBodyCenter">Host channel classification<br />
 for secondary advertising  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.2  </td><td class="markdownTableBodyCenter">LE Isochronous Channels  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE 5.2  </td><td class="markdownTableBodyCenter">Enhanced Attribute Protocol  </td><td class="markdownTableBodyCenter">Y  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BLE 5.2  </td><td class="markdownTableBodyCenter">LE Power Control  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N  </td><td class="markdownTableBodyCenter">N   </td></tr>
</table>
<h3><a class="anchor" id="Bluetooth_LE_Profile_Architecture"></a>
1.2 Bluetooth LE Profile Architecture</h3>
<p>Definition of profile in Bluetooth specification is different from that of Protocol. Protocol is defined as layer protocols in Bluetooth specification such as Link Layer, Logical Link Control and Adaptation protocol (L2CAP), Security Manager protocol (SMP), and Attribute protocol (ATT). Profile defines features and functions that are available in Protocol, and implementation of interaction details between devices, so as to accommodate Bluetooth protocol stack to application development in various scenarios.</p>
<h4><a class="anchor" id="GAP"></a>
1.2.1 GAP</h4>
<p>GAP is a basic Profile which must be implemented by all Bluetooth devices, and used to describe actions and methods including:<br />
</p><ul>
<li>device discovery<br />
</li>
<li>device connection<br />
</li>
<li>device security requirement<br />
</li>
<li>device authentication<br />
</li>
</ul>
<p>GAP for Bluetooth Low Energy also defines 4 application roles: Broadcaster, Observer, Peripheral and Central for optimization in various application scenarios.<br />
</p><ul>
<li>Broadcaster<br />
 A device operating in the Broadcaster role is a device that sends advertising events or periodic advertising events.<br />
</li>
<li>Observer<br />
 A device operating in the Observer role is a device that receives advertising events or periodic advertising events.<br />
</li>
<li>Peripheral<br />
 Any device that accepts the establishment of an LE active physical link is referred to as being in the Peripheral role.<br />
</li>
<li>Central<br />
 A device that supports the Central role initiates the establishment of an LE active physical link.<br />
</li>
</ul>
<h4><a class="anchor" id="GATT_Based_Profile"></a>
1.2.2 GATT Based Profile</h4>
<p>In Bluetooth specification, another commonly used Profile is GATT Based Profile. GATT is a standard based on server-client interaction defined in Bluetooth specification, and is used to implement provision of service data and access to service data. <br />
 Profile is made up in the form of Service and Characteristic, as shown in Figure 1-2. </p><div class="image">
<img src="GATT_Based_Profile_Hierarchy.png" alt="GATT_Based_Profile_Hierarchy.png"/>
</div>
 <center><div id="figure_1_2"><b>Figure 1-2 GATT Based Profile Hierarchy </b></div></center><h3><a class="anchor" id="Bluetooth_LE_APIs"></a>
1.3 Bluetooth LE APIs</h3>
<p>This chapter gives us simple description of GAP/GATT APIs. GAP/GATT related APIs provided in sdk\inc\bluetooth directory.<br />
 Table 1-2 shows the simple description of GAP APIs. GAP related APIs provided in sdk\inc\bluetooth\gap. </p><div style="page-break-after: always;"></div> <center><div id="table_1_2"><b>Table 1-2 Supported GAP APIs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">APIs  </th><th class="markdownTableHeadNone">Header file  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Advertisement  </td><td class="markdownTableBodyNone"><a class="el" href="gap__adv_8h_source.html" title="Head file for Gap adv. ">gap_adv.h</a>  </td><td class="markdownTableBodyNone">Start/Stop legacy Advertisement etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Advertisement  </td><td class="markdownTableBodyNone"><a class="el" href="gap__ext__adv_8h_source.html" title="Header file for Gap ext adv. ">gap_ext_adv.h</a>  </td><td class="markdownTableBodyNone">Start/Stop extended Advertisement etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Advertisement  </td><td class="markdownTableBodyNone"><a class="el" href="gap__pa__adv_8h_source.html" title="Header file for GAP PA adv. ">gap_pa_adv.h</a>  </td><td class="markdownTableBodyNone">Start/Stop periodic Advertisement etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Scan  </td><td class="markdownTableBodyNone"><a class="el" href="gap__scan_8h_source.html" title="Head file for Gap Observer role. ">gap_scan.h</a>  </td><td class="markdownTableBodyNone">Start/Stop legacy scan etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Scan  </td><td class="markdownTableBodyNone"><a class="el" href="gap__ext__scan_8h_source.html" title="Header file for Gap ext scan. ">gap_ext_scan.h</a>  </td><td class="markdownTableBodyNone">Start/Stop extended scan etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Connection  </td><td class="markdownTableBodyNone"><a class="el" href="gap__conn__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_conn_le.h</a>  </td><td class="markdownTableBodyNone">Set/Get connection parameters, disconnect BLE link etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Bond  </td><td class="markdownTableBodyNone"><a class="el" href="gap__storage__le_8h_source.html" title="key storage function. ">gap_storage_le.h</a>  </td><td class="markdownTableBodyNone">Save/Load BLE key etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Bond  </td><td class="markdownTableBodyNone"><a class="el" href="gap__bond__le_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_bond_le.h</a>  </td><td class="markdownTableBodyNone">Set/Get bond parameters, display/input bond keys etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Bond  </td><td class="markdownTableBodyNone"><a class="el" href="gap__bond__manager_8h_source.html" title="This file contains all the functions prototypes for the GAP bond manager related functions. ">gap_bond_manager.h</a>  </td><td class="markdownTableBodyNone">Definition GAP bond manager module APIs   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">DTM  </td><td class="markdownTableBodyNone"><a class="el" href="gap__dtm_8h_source.html">gap_dtm.h</a>  </td><td class="markdownTableBodyNone">Start/Stop DTM receiver/transmitter test   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AOA/AOD  </td><td class="markdownTableBodyNone"><a class="el" href="gap__aox_8h_source.html" title="Head file for GAP AoA/AoD. ">gap_aox.h</a>  </td><td class="markdownTableBodyNone">Register callback, Read antenna information etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">AOA/AOD  </td><td class="markdownTableBodyNone"><a class="el" href="gap__aox__conn_8h_source.html" title="Head file for GAP AoA/AoD connection. ">gap_aox_conn.h</a>  </td><td class="markdownTableBodyNone">Start/Stop Constant Tone Extension Request procedure etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">AOA/AOD  </td><td class="markdownTableBodyNone">gap_aox_connless_<br />
receiver.h  </td><td class="markdownTableBodyNone">Enable/Disable capturing IQ samples etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">AOA/AOD  </td><td class="markdownTableBodyNone">gap_aox_connless_<br />
transmitter.h  </td><td class="markdownTableBodyNone">Enable/Disable Constant Tone Extensions<br />
in periodic advertising   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Callback  </td><td class="markdownTableBodyNone"><a class="el" href="gap__callback__le_8h_source.html" title="This file contains function prototype for all GAP roles. ">gap_callback_le.h</a>  </td><td class="markdownTableBodyNone">Definition GAP callback messages   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Message  </td><td class="markdownTableBodyNone"><a class="el" href="gap__msg_8h_source.html" title="This file contains function prototype for all GAP roles. ">gap_msg.h</a>  </td><td class="markdownTableBodyNone">Definition GAP messages   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">LE privacy  </td><td class="markdownTableBodyNone"><a class="el" href="gap__privacy_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_privacy.h</a>  </td><td class="markdownTableBodyNone">Set/Get privacy parameters, enable/disable privacy etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">Credit Based  </td><td class="markdownTableBodyNone"><a class="el" href="gap__credit__based__conn_8h_source.html" title="header file of LE Credit-Based Connection message handle. ">gap_credit_based_conn.h</a>  </td><td class="markdownTableBodyNone">GAP LE Credit Based Connection Exported Functions   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Credit Based  </td><td class="markdownTableBodyNone"><a class="el" href="gap__ecfc_8h_source.html" title="This file contains all the constants and functions prototypes for L2CAP enhanced credit based flow co...">gap_ecfc.h</a>  </td><td class="markdownTableBodyNone">GAP enhanced credit based flow control mode<br />
Exported Functions   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">general  </td><td class="markdownTableBodyNone"><a class="el" href="gap_8h_source.html" title="This file contains all the constants and functions prototypes for GAP. ">gap.h</a>  </td><td class="markdownTableBodyNone">Set/Get GAP general parameters such as bd address,<br />
airplane mode etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">general  </td><td class="markdownTableBodyNone"><a class="el" href="gap__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_le.h</a>  </td><td class="markdownTableBodyNone">Initialize/set/get LE parameters of GAP etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">general  </td><td class="markdownTableBodyNone"><a class="el" href="gap__le__types_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_le_types.h</a>  </td><td class="markdownTableBodyNone">Definition types of device Appearance,<br />
Advertising Data Type, PHY etc.   </td></tr>
</table>
<p>Table 1-3 shows the simple description of GATT APIs. GATT related APIs provided in sdk\inc\bluetooth\profile. </p><center><div id="table_1_3"><b>Table 1-3 Supported GATT APIs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">APIs  </th><th class="markdownTableHeadNone">Header file  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">client  </td><td class="markdownTableBodyNone"><a class="el" href="profile__client_8h_source.html" title="Head file for profile client structure. ">profile_client.h</a>  </td><td class="markdownTableBodyNone">Register client callback with conn id, send read/write request etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">client  </td><td class="markdownTableBodyNone"><a class="el" href="profile__client__def_8h_source.html" title="Head file for profile client structure. ">profile_client_def.h</a>  </td><td class="markdownTableBodyNone">Initialize client parameters, definition discovery procedure etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">client  </td><td class="markdownTableBodyNone"><a class="el" href="profile__client__ext_8h_source.html" title="Head file for profile client structure. ">profile_client_ext.h</a>  </td><td class="markdownTableBodyNone">Register client callback with conn handle, send read/write request etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">server  </td><td class="markdownTableBodyNone"><a class="el" href="profile__server_8h_source.html" title="Head file for server structure. ">profile_server.h</a>  </td><td class="markdownTableBodyNone">Register server callback with conn id, send indication/notification etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyNone">server  </td><td class="markdownTableBodyNone"><a class="el" href="profile__server__def_8h_source.html" title="Head file for server structure. ">profile_server_def.h</a>  </td><td class="markdownTableBodyNone">Initialize server parameters, register builtin service etc.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyNone">server  </td><td class="markdownTableBodyNone"><a class="el" href="profile__server__ext_8h_source.html" title="Head file for server structure. ">profile_server_ext.h</a>  </td><td class="markdownTableBodyNone">Register server callback with conn handle, <br />
send indication/notification etc.   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_STACK_GAP"></a>
2 GAP</h2>
<p>GAP layer will be introduced according to the following several parts:<br />
</p><ol type="1">
<li>GAP layer structure will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Structure_Overview">2.1 GAP Structure Overview</a>.<br />
</li>
<li>Configuration of GAP parameters and GAP internal startup flow please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a>.<br />
</li>
<li>GAP message type definitions and GAP Message processes flow please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>.<br />
</li>
<li>GAP message callback function is used by GAP Layer to send messages to application, more information about GAP message callback please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>.<br />
</li>
<li>How to use GAP interfaces please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Use_Case">2.5 Bluetooth LE GAP Use Case</a>.<br />
</li>
<li>Local stack information and bonding device information storage implemented by GAP layer will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Information_Storage">2.6 GAP Information Storage</a>.<br />
</li>
<li>Bluetooth LE supports a feature that reduces the ability to track a LE device over a period of time by changing the Bluetooth device address on a frequent basis. More information please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Privacy">2.7 Bluetooth LE Privacy</a>.</li>
<li>Devices are identified using a device address and an address type; the address type indicates either a public device address or a random device address. A public device address and a random device address are both 48 bits in length. More information please refer to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_Address">2.8 BLE Address</a>.</li>
</ol>
<h3><a class="anchor" id="GAP_Structure_Overview"></a>
2.1 GAP Structure Overview</h3>
<p>The purpose of this chapter is to give an overview of GAP Structure which include GAP Location, GAP Capacity, GAP State and GAP Message etc.<br />
</p>
<h4><a class="anchor" id="GAP_Location"></a>
2.1.1 GAP Location</h4>
<p>GAP(Generic Access Profile) is used to describe how devices behave in standby and connecting states in order to guarantee links and channels always can be established between Bluetooth devices, and multi-profile operation can be possible. Special focus is put on discovery, link establishment and security procedures. As shown in Figure 2-1, the <b>GAP layer</b> provides a method for application and Profiles to communicate with Bluetooth Stack. Application could use GAP to control Bluetooth stack to start an operation such as authentication, create connection and so on. Bluetooth stack could use GAP to notify application on state changes in Bluetooth such as supervision timeout, link disconnected by remote side and so on. </p><div class="image">
<img src="GAP-intro-overview.jpg" alt="GAP-intro-overview.jpg"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 GAP Location In SDK </b></div></center><h4><a class="anchor" id="GAP_Capacity"></a>
2.1.2 GAP Capacity</h4>
<p>The capacity provided by GAP API is as below.<br />
</p>
<ul>
<li>Advertising related<ul>
<li>Set / get advertising parameters.</li>
<li>Start / stop advertising.</li>
</ul>
</li>
<li>Scan related<ul>
<li>Set / get scan parameters.</li>
<li>Start / stop scan.</li>
</ul>
</li>
<li>Connection related<ul>
<li>Set connection parameters.</li>
<li>Create a connection.</li>
<li>Terminate the existing connection.</li>
<li>Update connection parameter.</li>
</ul>
</li>
<li>Pairing related<ul>
<li>Set pairing parameters.</li>
<li>Trigger pairing procedure.</li>
<li>Input / display passkey using passkey entry.</li>
<li>Delete keys of bonded device.</li>
</ul>
</li>
<li>Key management<ul>
<li>Find key entry by device address and address type.</li>
<li>Save / load keys about bond information.</li>
<li>Resolve random address.</li>
</ul>
</li>
<li>Others<ul>
<li>Set GAP common parameter including device appearance, device name, etc.</li>
<li>Get maximum number of BLE link supported.</li>
<li>Modify local white list.</li>
<li>Generate local random address and set local random address.</li>
<li>Configure local identity address.</li>
<li>...</li>
</ul>
</li>
</ul>
<p><b>Note:</b><br />
 <b>GAP APIs do not support multiple threads</b>, operations of calling APIs and handling message must be in the same task. APIs supplied in SDK can be divided into synchronous API and asynchronous API. The result of synchronous API is represented by return value, such as <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param()</a>. If return value of <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param()</a> is GAP_CAUSE_SUCCESS, APP sets a GAP parameter successfully. The result of asynchronous API is notified by GAP message which is defined in <a class="el" href="gap__callback__le_8h_source.html">gap_callback_le.h</a>, such as <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga36252f7752759c51513639e0b1622901">le_modify_white_list()</a>. If return value of <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga36252f7752759c51513639e0b1622901">le_modify_white_list()</a> is GAP_CAUSE_SUCCESS, request of modify whitelist has been sent successfully. The result of modify whitelist is notified by GAP message <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga1b98e295b6d3c065b9e01b5ba67506d6">GAP_MSG_LE_MODIFY_WHITE_LIST</a>.</p>
<h4><a class="anchor" id="GAP_State"></a>
2.1.3 GAP State</h4>
<p>GAP State consists of advertising state, scan state, connection state. If LE Advertising Extensions is enabled, extended advertising state is used. Each state has corresponding sub-states, and this part will introduce the state machine of each sub-state.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.3.1 Advertising State</h5>
<p>Advertising State has 4 sub-states including idle state, start state, advertising state and stop state. Advertising sub-state is defined in <a class="el" href="gap__msg_8h_source.html">gap_msg.h</a>. <br />
<br />
 </p><div class="fragment"><div class="line"><span class="comment">/* GAP Advertising State */</span></div><div class="line"><span class="preprocessor">#define GAP_ADV_STATE_IDLE           0   // Idle, no advertising</span></div><div class="line"><span class="preprocessor">#define GAP_ADV_STATE_START          1   // Start Advertising. A temporary state, hasn&#39;t received the result.</span></div><div class="line"><span class="preprocessor">#define GAP_ADV_STATE_ADVERTISING    2   // Advertising</span></div><div class="line"><span class="preprocessor">#define GAP_ADV_STATE_STOP           3   // Stop Advertising. A temporary state, hasn&#39;t received the result.</span></div></div><!-- fragment --><div class="image">
<img src="gap_le_state_adv.png" alt="gap_le_state_adv.png"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Advertising State Change Machine </b></div></center><ul>
<li>Idle state<ul>
<li>No advertising and it is default state.</li>
</ul>
</li>
<li>Start state<ul>
<li>Start advertising from idle state. But the process of enabling advertising has not completed yet. It is a temporary state. If it successfully starts advertising, Advertising State would enter advertising state, if not, Advertising State would turn back to idle state.</li>
</ul>
</li>
<li>Advertising state<ul>
<li>Start advertising completely. In this state, the device is sending advertising packets. If advertising type is high duty cycle directed advertising, Advertising State would enter idle state once it is out of time.</li>
</ul>
</li>
<li>Stop state<ul>
<li>Stop advertising from advertising state. But the process of disabling advertising has not completed yet. It is a temporary state. If it uccessfully stops advertising, Advertising State would enter idle state, if not, Advertising State would turn back to advertising state.</li>
</ul>
</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.3.2 Scan State</h5>
<p>Scan State has 4 sub-states including idle state, start state, scanning state and stop state. Scan sub-state is defined in <a class="el" href="gap__msg_8h_source.html">gap_msg.h</a>. <br />
<br />
 </p><div class="fragment"><div class="line"><span class="comment">/* GAP Scan State */</span></div><div class="line"><span class="preprocessor">#define GAP_SCAN_STATE_IDLE          0   //Idle, no scanning</span></div><div class="line"><span class="preprocessor">#define GAP_SCAN_STATE_START         1   //Start scanning. A temporary state, hasn&#39;t received the result.</span></div><div class="line"><span class="preprocessor">#define GAP_SCAN_STATE_SCANNING      2   //Scanning</span></div><div class="line"><span class="preprocessor">#define GAP_SCAN_STATE_STOP          3   //Stop scanning, A temporary state, hasn&#39;t received the result</span></div></div><!-- fragment --><div class="image">
<img src="gap_le_state_scan.png" alt="gap_le_state_scan.png"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Scan State Change Machine </b></div></center><ul>
<li>Idle state<ul>
<li>No scan and it is default state.</li>
</ul>
</li>
<li>Start state<ul>
<li>Start scanning from idle state. But the process of enabling scan has not completed yet. It is a temporary state. If it successfully starts scanning, Scan State would enter scanning state, if not, Scan State would turn back to idle state.</li>
</ul>
</li>
<li>Scanning state<ul>
<li>Start scanning completely. In this state, the device is scanning advertising packets.</li>
</ul>
</li>
<li>Stop state<ul>
<li>Stop scanning from scanning state. But the process of disabling scan has not completed yet. It is a temporary state. If it successfully stops scanning, Scan State would enter idle state, if not, Scan State would turn back to scanning state.</li>
</ul>
</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.3.3 Connection State</h5>
<p>Due to supporting multi link, the link could be connected or disconnected when GAP Connection State is idle state. Hence, gap state and link state must be considered simultaneously when the connection state changes. GAP connection sub-state is defined in <a class="el" href="gap__msg_8h_source.html">gap_msg.h</a> which includes idle state and connecting state.<br />
 </p><div class="fragment"><div class="line"><span class="comment">/* GAP Connection State */</span></div><div class="line"><span class="preprocessor">#define GAP_CONN_DEV_STATE_IDLE          0   // Idle</span></div><div class="line"><span class="preprocessor">#define GAP_CONN_DEV_STATE_INITIATING    1   // Initiating Connection</span></div></div><!-- fragment --><p><b>Note:</b> GAP could only create one link at the same time, which means application could not create another link when GAP Connection State is GAP_CONN_DEV_STATE_INITIATING.</p>
<p>Link sub-state is defined in <a class="el" href="gap__msg_8h_source.html">gap_msg.h</a> which includes disconnected state, connecting state, connected state and disconnecting state.<br />
 </p><div class="fragment"><div class="line"><span class="comment">/* Link Connection State */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>, <span class="comment">// Disconnected.</span></div><div class="line">    <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44ea0c9f4740bbcfdd7a32fb036663ef9b06">GAP_CONN_STATE_CONNECTING</a>,   <span class="comment">// Connecting.</span></div><div class="line">    <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>,    <span class="comment">// Connected.</span></div><div class="line">    <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44ea8d4bbf58375d4401fcc49676d9de5407">GAP_CONN_STATE_DISCONNECTING</a> <span class="comment">// Disconnecting.</span></div><div class="line">} <a class="code" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>;</div></div><!-- fragment --><p>Creating a connection actively as the master role and receiving a connection indication passively as the slave role are different for Connection state change. This section would describe these two cases separately.</p>
<p><b>1. Active State Change</b> <br />
</p>
<div class="image">
<img src="gap_le_state_conn_active.png" alt="gap_le_state_conn_active.png"/>
</div>
 <center><div id="figure_2_4"><b>Figure 2-4 Active State Change Machine </b></div></center><ul>
<li>Idle | Disconnected state<ul>
<li>GAP is in idle state and link has not connected.</li>
</ul>
</li>
<li>Connecting | Connecting state<ul>
<li>Master creates a connection and the process has not completed yet. It is a temporary state. GAP Connection State enters connecting state, and Link State enters connecting state. If it successfully creates a connection, Link State would change to connected state, and GAP Connection State would change to idle state again. If creating a connection was unsuccessfully, Link State would turn back to disconnected state, and GAP Connection State would turn back to idle state. In this state, master could also disconnect the link, then Link State would change to disconnecting state and GAP Connection State would change to idle state.</li>
</ul>
</li>
<li>Idle | Connected state<ul>
<li>A connection has been created. GAP Connection State is idle state and Link State is connected state.</li>
</ul>
</li>
<li>Idle | Disconnecting state<ul>
<li>Master terminates the link and the process has not completed yet. It is a temporary state. GAP Connection State is idle state and Link State is disconnecting state. If it successfully terminates the link, Link State would change to disconnected state.</li>
</ul>
</li>
</ul>
<p><b>2. Passive State Change</b> <br />
</p>
<div class="image">
<img src="gap_le_state_conn_passive.png" alt="gap_le_state_conn_passive.png"/>
</div>
 <center><div id="figure_2_5"><b>Figure 2-5 Passive State Change Machine </b></div></center><ul>
<li>Slave accepts connection<br />
 When slave receives a connect indication, GAP Advertising State would change to idle state from the advertising state and Link State would change to the connecting state from the disconnected state. After the process of creating connection has completed, Link State turns into the connected state.</li>
<li>Disconnected by peer<br />
 When peer device disconnects the link and disconnect indication is received by local device, local device's Link State would change to the disconnected state from the connected state.</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.3.4 Extended Advertising State</h5>
<p>Without LE Advertising Extensions, the device uses Advertising State can be considered that there is one simplified advertising set. This section is only applied to devices that uses LE Advertising Extensions. Due to the support of LE Advertising Extensions, device may enable or disable one or more advertising sets at a time, so the change of Extended Advertising State has to be combined with advertising set. Extended Advertising State has 4 sub-states including idle state, start state, advertising state and stop state. Extended Advertising sub-state is defined in <a class="el" href="gap__ext__adv_8h_source.html">gap_ext_adv.h</a>.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2af1ce6f46f5fa7618f5fc93116c2a3011">EXT_ADV_STATE_IDLE</a>,         </div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2a1933ea55945a455c8aa6647f6966abd5">EXT_ADV_STATE_START</a>,        </div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2a6e791b28520bc2c3de61bfc08e01558c">EXT_ADV_STATE_ADVERTISING</a>,  </div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2a27df522e5b87a64a573c7d337de8bdb6">EXT_ADV_STATE_STOP</a>,         </div><div class="line">} <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ga583d6dcf8cbca81419d777863bf58da2">T_GAP_EXT_ADV_STATE</a>;</div></div><!-- fragment --><div class="image">
<img src="extend_adv_state.png" alt="extend_adv_state.png"/>
</div>
 <center><div id="figure_2_6"><b>Figure 2-6 Extended Advertising State Transition Mechanism For One Advertising Set </b></div></center><ol type="1">
<li>Idle state<br />
 No advertising, default state.<br />
</li>
<li>Start state<br />
 Start extended advertising in idle state, but process of enabling extended advertising has not completed yet. It is a temporary state. If extended advertising successfully starts, Extended Advertising State will turn into advertising state; otherwise Extended Advertising State will turn back to idle state.<br />
</li>
<li>Advertising state<br />
 Start extended advertising successfully. In this state, the device is sending advertising packets. If duration is non-zero, Extended Advertising State will turn into idle state once duration is expired. If maximum number of extended advertising events is non-zero, Extended Advertising State will turn into idle state once the maximum number has been reached.<br />
</li>
<li>Stop state<br />
 Stop extended advertising in advertising state, but process of disabling extended advertising has not been completed yet. It is a temporary state. If extended advertising is successfully stopped, Extended Advertising State will turn into idle state; otherwise Extended Advertising State will turn back to advertising state.<br />
</li>
</ol>
<h4><a class="anchor" id="GAP_Message"></a>
2.1.4 GAP Message</h4>
<p>GAP message includes BT status message and GAP API message. BT status message is used to notify APP of information including device state change, connection state change, bond state change, etc. GAP API message is used to notify APP of function exec status after the API has been invoked. Each API has an associated message. Please refers to chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a> and chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.4.1 Bluetooth Technology Status Message</h5>
<p>BT status message is defined in <a class="el" href="gap__msg_8h_source.html">gap_msg.h</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/* BT status message */</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DEV_STATE_CHANGE        0x01 // Device state change msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_CONN_STATE_CHANGE       0x02 // Connection state change msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_CONN_PARAM_UPDATE       0x03 // Connection parameter update change msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_CONN_MTU_INFO           0x04 // Connection MTU size info msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_AUTHEN_STATE_CHANGE     0x05 // Authentication state change msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_PASSKEY_DISPLAY    0x06 // Bond passkey display msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_PASSKEY_INPUT      0x07 // Bond passkey input msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_OOB_INPUT          0x08 // Bond passkey oob input msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_USER_CONFIRMATION  0x09 // Bond user confirmation msg type.</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_JUST_WORK          0x0A // Bond user confirmation msg type.</span></div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.1.4.2 GAP API Message</h5>
<p>GAP API message is defined in <a class="el" href="gap__callback__le_8h_source.html">gap_callback_le.h</a>.<br />
 Please refer to the API comments for each function-related messages.</p>
<div class="fragment"><div class="line"><span class="comment">/* GAP API message */</span></div><div class="line"><span class="comment">//gap_le.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_MODIFY_WHITE_LIST                0x01 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_SET_RAND_ADDR                    0x02 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_SET_HOST_CHANN_CLASSIF           0x03 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_WRITE_DEFAULT_DATA_LEN           0x04 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_conn_le.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_READ_RSSI                        0x10 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_READ_CHANN_MAP                   0x11 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DISABLE_SLAVE_LATENCY            0x12 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_SET_DATA_LEN                     0x13 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DATA_LEN_CHANGE_INFO             0x14 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_CONN_UPDATE_IND                  0x15 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_CREATE_CONN_IND                  0x16 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PHY_UPDATE_INFO                  0x17 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_UPDATE_PASSED_CHANN_MAP          0x18 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_REMOTE_FEATS_INFO                0x19 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_READ_REMOTE_VERSION              0x1B </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_bond_le.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_MODIFY_INFO                 0x20 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_KEYPRESS_NOTIFY                  0x21 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_KEYPRESS_NOTIFY_INFO             0x22 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_GATT_SIGNED_STATUS_INFO          0x23 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">/* The type of callback will only be used when gap_param_key_manager equals 2 and no matching key entry is found*/</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BOND_KEY_REQ                     0x24 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_scan.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_SCAN_INFO                        0x30 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DIRECT_ADV_INFO                  0x31 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_adv.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_ADV_UPDATE_PARAM                 0x40 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_ADV_READ_TX_POWER                0x41 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_dtm.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_RECEIVER_TEST                0x70 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_TRANSMITTER_TEST             0x71 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_TEST_END                     0x72 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_ENHANCED_RECEIVER_TEST       0x73 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_ENHANCED_TRANSMITTER_TEST    0x74 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_RECEIVER_TEST_V3             0x75 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_DTM_TRANSMITTER_TEST_V3          0x76 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_ext_scan.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_REPORT_INFO                      0x50 </span></div><div class="line"><span class="preprocessor"></span><span class="comment">/* The type of callback will only be used after APP calls @ref le_ext_scan_gap_msg_info_way(false). */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_SCAN_STATE_CHANGE_INFO               0x51 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_pa_sync.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_SYNC_MODIFY_PERIODIC_ADV_LIST         0x54 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PERIODIC_ADV_REPORT_INFO                 0x55 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_SYNC_DEV_STATE_CHANGE_INFO            0x56 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_SYNC_STATE_CHANGE_INFO                0x57 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_SYNC_SET_PERIODIC_ADV_RECEIVE_ENABLE  0x58 </span></div><div class="line"><span class="preprocessor">//gap_past_sender.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PAST_SENDER_PERIODIC_ADV_SYNC_TRANSFER   0x59 </span></div><div class="line"><span class="preprocessor">//gap_past_recipient.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PAST_RECIPIENT_SET_DEFAULT_PERIODIC_ADV_SYNC_TRANSFER_PARAMS   0x5A </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PAST_RECIPIENT_SET_PERIODIC_ADV_SYNC_TRANSFER_PARAMS           0x5B </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PAST_RECIPIENT_PERIODIC_ADV_SYNC_TRANSFER_RECEIVED_INFO        0x5C </span></div><div class="line"><span class="preprocessor">//gap_pa_sync.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_BIGINFO_ADV_REPORT_INFO          0x5D </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_ext_adv.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_START_SETTING            0x60 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_REMOVE_SET               0x61 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_CLEAR_SET                0x62 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_ENABLE                   0x63 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_DISABLE                  0x64 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_SCAN_REQ_RECEIVED_INFO           0x65 </span></div><div class="line"><span class="preprocessor"></span><span class="comment">/* The type of callback will only be used after APP calls @ref le_ext_adv_gap_msg_info_way(false). */</span><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_EXT_ADV_STATE_CHANGE_INFO        0x66 </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="comment">//gap_pa_adv.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_ADV_START_SETTING             0x6A </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_ADV_SET_PERIODIC_ADV_ENABLE   0x6B </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PA_ADV_STATE_CHANGE_INFO         0x6C </span></div><div class="line"><span class="preprocessor">//gap_past_sender.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_PAST_SENDER_PERIODIC_ADV_SET_INFO_TRANSFER  0x6E </span></div><div class="line"><span class="preprocessor"></span></div><div class="line"><span class="preprocessor">#define GAP_MSG_EXT_ADV_HANDLE_PRIORITY_SET         0xA7 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_GAP_STATE_MSG                    0xB0</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_BT_LE_FIX_CHANN_SUPPORT</span></div><div class="line"><span class="comment">//gap_fix_chann_conn.h</span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_FIXED_CHANN_DATA_SEND            0xC0 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_FIXED_CHANN_DATA_IND             0xC1 </span></div><div class="line"><span class="preprocessor">#define GAP_MSG_LE_FIXED_CHANN_REG                  0xC2 </span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><h4><a class="anchor" id="APP_Message_Flow"></a>
2.1.5 APP Message Flow</h4>
<p>APP message flow is shown in Figure 2-7 Step in solid line box is mandatory and step in dashed line box is optional.</p>
<div class="image">
<img src="gap_le_message_flow.png" alt="gap_le_message_flow.png"/>
</div>
 <center><div id="figure_2_7"><b>Figure 2-7 App Message Flow </b></div></center><ol type="1">
<li><p class="startli">Two methods of sending message to APP<br />
</p>
<p class="startli">1) Callback function In this method, APP should first register the callback function. When a message is upstream to GAP layer, the GAP layer will call this callback function to handle message. <br />
 2) Message queue In this method, APP should first create a message queue. When a message is upstream to GAP layer, the GAP layer would send the message into the queue, and app would loop to receive message from queue. <br />
</p>
</li>
<li><p class="startli">Initialization<br />
</p>
<p class="startli">1) Register callback function<br />
</p><ul>
<li>For receiving GAP API messages, APP should register the app callback function through <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a> function. <br />
</li>
<li>For receiving airplane mode messages, APP should register the app callback function through <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9afcebae2c58617ed03c21918ca7a442">gap_register_app_cb</a> function. <br />
</li>
<li>For receiving gaps characteristic write messages, APP should register the app callback function through <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gadeefecf776f21919de999f1f9ce546d1">gatt_register_callback</a> function. <br />
</li>
<li>For receiving server messages, APP should register the service callback function through <b>xxx_add_service()</b> function and <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a> function. <br />
</li>
<li>For receiving client messages, app should register the client callback function through <b>xxx_add_client()</b> function. <br />
<br />
</li>
</ul>
<p class="startli">2) Create message queue<br />
 For receiving BT status messages, APP should create IO message queue through <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a> function. <br />
 <br />
</p>
</li>
<li>Loop to receive message<br />
<br />
 App main task loops to receive messages. If it is a io message, APP calls app_handle_io_msg function to handle this message in APP layer. Otherwise APP invokes <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gadc91ccdf8fda07b12ab307882d2b8b7d">gap_handle_msg</a> function to handle this message in GAP layer. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab31ebd8f8c8b560ef3c96e2b599dd653">app_main_task</a>(<span class="keywordtype">void</span> *p_param)</div><div class="line">{</div><div class="line">    uint8_t event;</div><div class="line"></div><div class="line">    <a class="code" href="group___o_s__87x3d___message.html#ga78583ff4df155099dbb1592bd71dedfb">os_msg_queue_create</a>(&amp;<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, <span class="stringliteral">&quot;ioQ&quot;</span>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#ga2f27fdd94800589c67000bd6fc3500bd">MAX_NUMBER_OF_IO_MESSAGE</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a>));</div><div class="line">    <a class="code" href="group___o_s__87x3d___message.html#ga78583ff4df155099dbb1592bd71dedfb">os_msg_queue_create</a>(&amp;<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <span class="stringliteral">&quot;evtQ&quot;</span>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#ga4fdf16dedee495c8378188760eb5d9a0">MAX_NUMBER_OF_EVENT_MESSAGE</a>, <span class="keyword">sizeof</span>(uint8_t));</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaaf45be3842e5882f90db4267ffbfe036">MAX_NUMBER_OF_GAP_MESSAGE</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#ga300297f5ace3035cb59d05dde7b7ae2f">data_uart_init</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>);</div><div class="line">    <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___functions.html#ga633294c4bacb300a67a19c283e3553c5">user_cmd_init</a>(&amp;user_cmd_if, <span class="stringliteral">&quot;central&quot;</span>);</div><div class="line"></div><div class="line">    <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#ga431d3b5cbaad02e4dba35c48dc7bd161">driver_init</a>();</div><div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___o_s__87x3d___message.html#ga10998e34fdfdd3297af840e60d03b09b">os_msg_recv</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, &amp;event, 0xFFFFFFFF) == <span class="keyword">true</span>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (event == <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggae013f504d288fa3c19ec0f1af745975ca54fa1d4504aab64b0e290572ad56a13e">EVENT_IO_TO_APP</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_msg;</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___o_s__87x3d___message.html#ga10998e34fdfdd3297af840e60d03b09b">os_msg_recv</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, &amp;io_msg, 0) == <span class="keyword">true</span>)</div><div class="line">                {</div><div class="line">                    app_handle_io_msg(io_msg);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gadc91ccdf8fda07b12ab307882d2b8b7d">gap_handle_msg</a>(event);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li>Handle message<br />
<br />
 If message is sent by the callback function, the function registered in initialization steps should handle this message. If message is sent by the message queue, APP task will receive this message and handle it.</li>
</ol>
<h3><a class="anchor" id="GAP_Initialization_and_Startup_Flow"></a>
2.2 GAP Initialization and Startup Flow</h3>
<p>The purpose of this chapter is to give an overview of GAP Initialization and Startup Flow which include how to configure LE gap parameters and gap internal startup flow.<br />
</p>
<h4><a class="anchor" id="GAP_Parameters_Initialization"></a>
2.2.1 GAP Parameters Initialization</h4>
<p>Parameter initialize is fulfilled in main.c only by modifying codes for <a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a> in main.c. Function <a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init()</a> is used to initialize the GAP parameters.</p>
<h5>2.2.1.1 Configure Device Name and Device Appearance</h5>
<ol type="1">
<li>Device name configuration <br />
<br />
 It is used to set the value of Device Name Characteristic in GAP Service for the device. If Device Name is set in Advertising data too, the Device Name set in Advertising data should be the same with the value of Device Name Characteristic in GAP Service. Otherwise there may be an interoperability problem in them. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t adv_data[] =</div><div class="line">{</div><div class="line">    <span class="comment">/* Flags */</span></div><div class="line">    0x02,             <span class="comment">/* length */</span></div><div class="line">    <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#gab1bd711d70038fc779c4bf6a2c5166d0">GAP_ADTYPE_FLAGS</a>, <span class="comment">/* type=&quot;Flags&quot; */</span></div><div class="line">    <a class="code" href="group___a_d_v___t_y_p_e___f_l_a_g_s.html#gacca2aead661f7f7c66ccd4c56abb4fce">GAP_ADTYPE_FLAGS_LIMITED</a> | <a class="code" href="group___a_d_v___t_y_p_e___f_l_a_g_s.html#gabdd659cecc51bfb0f6458c27fda8864d">GAP_ADTYPE_FLAGS_BREDR_NOT_SUPPORTED</a>,</div><div class="line">    <span class="comment">/* Service */</span></div><div class="line">    0x03,             <span class="comment">/* length */</span></div><div class="line">    <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga035ae8edc40c2ddc9bc77fb29ee08d75">GAP_ADTYPE_16BIT_COMPLETE</a>,</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga054119128484dbbb8db6ffbae614d08d">GATT_UUID_SIMPLE_PROFILE</a>),</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga054119128484dbbb8db6ffbae614d08d">GATT_UUID_SIMPLE_PROFILE</a>),</div><div class="line">    <span class="comment">/* Local name */</span></div><div class="line">    0x0F,             <span class="comment">/* length */</span></div><div class="line">    <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga73e43d425fe3ddbea114d87b2300c6a1">GAP_ADTYPE_LOCAL_NAME_COMPLETE</a>,</div><div class="line">    <span class="charliteral">&#39;B&#39;</span>, <span class="charliteral">&#39;L&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;_&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;I&#39;</span>, <span class="charliteral">&#39;P&#39;</span>, <span class="charliteral">&#39;H&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;A&#39;</span>, <span class="charliteral">&#39;L&#39;</span>,</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_PERIPHERAL&quot;</span>;</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
 The permitted length of character string for Device Name is up to 40 bytes (including end mark) in BT Stack currently, so here the length of Device name defined is up to 40 bytes. If the string is longer than 40 bytes, it will be cut off. <br />
<br />
 <div class="fragment"><div class="line"><span class="preprocessor">#define GAP_DEVICE_NAME_LEN           (39+1)</span></div></div><!-- fragment --> <br />
</li>
<li>Device Appearance Configuration <br />
<br />
 It is used to set the value of Device Appearance Characteristic in GAP Service for the device. If Device Appearance is set in Advertising data, the Device Appearance set in Advertising data should be the same with the value of Device Appearance Characteristic in GAP Service. Otherwise there may be an interoperability problem in them. <br />
 Device Appearance is used to set the type of a device, such as keyboard, mouse, thermometer, blood pressure meter, etc. <br />
 Available values are defined in GAP_LE_APPEARANCE_VALUES in <a class="el" href="gap__le__types_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_le_types.h</a>. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>[] =</div><div class="line">{</div><div class="line">    0x03,                             <span class="comment">/* length */</span></div><div class="line">    <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga73192f11d357968c4e9c3f89fa494021">GAP_ADTYPE_APPEARANCE</a>,            <span class="comment">/* type=&quot;Appearance&quot; */</span></div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(GATT_APPEARANCE_UNKNOWN),</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(GATT_APPEARANCE_UNKNOWN),</div><div class="line">};</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h5>2.2.1.2 Configure Advertising Parameters</h5>
<p>APP can use <a class="el" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params()</a> to configure advertising parameters. More information please refer to <a class="el" href="_u_m020__b_l_e__e_x_t_e_n_d_e_d__a_d_v_e_r_t_i_s_i_n_g__m_a_n_a_g_e_r.html#BLEExtAdvertisingManager_Page">BLE Extended Advertising Manager User Manual </a>. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___t_t_s___o_t_a___exported___functions.html#ga9cc1b5f72081250b45c8fe4d675334f3">app_ble_common_adv_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gaac37315eefb7c0b74fb9daad93b5fd2b">T_LE_EXT_ADV_LEGACY_ADV_PROPERTY</a> adv_event_prop = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2ba221e1dd75ec84b8536143e2e2b9245ac">LE_EXT_ADV_LEGACY_ADV_CONN_SCAN_UNDIRECTED</a>;</div><div class="line">    uint16_t adv_interval_min = 0xA0;</div><div class="line">    uint16_t adv_interval_max = 0xB0;</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98ab751d2722a1890be60daf72ca879555a">GAP_LOCAL_ADDR_LE_RANDOM</a>;</div><div class="line">    <span class="keywordflow">if</span> (le_common_adv.use_static_addr_type)</div><div class="line">    {</div><div class="line">        own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98ab751d2722a1890be60daf72ca879555a">GAP_LOCAL_ADDR_LE_RANDOM</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> peer_address_type = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    uint8_t  peer_address[6] = {0, 0, 0, 0, 0, 0};</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac0433c68ddb7484621ec659b7f8edd76">T_GAP_ADV_FILTER_POLICY</a> filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76a610241ea5e48e993bbf893c19e1b2794">GAP_ADV_FILTER_ANY</a>;</div><div class="line"></div><div class="line">    uint8_t data_len = <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga17b6d1eb8e8d2202a76a297c94b338ff">bud_local_addr</a>) + <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga9ab366b1e959fedb95907ecbf3daa8bb">company_id</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga22fc5e8ca6953eb544ecedd25a90bca8">app_ble_gap_gen_scan_rsp_data</a>(&amp;<a class="code" href="group___a_p_p___b_l_e___g_a_p.html#gaf79d883b90bf38f70f8787d9bd2b34b1">scan_rsp_data_len</a>, <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>);</div><div class="line"></div><div class="line">    uint8_t le_random_addr[6] = {0};</div><div class="line">    app_ble_rand_addr_get(le_random_addr);</div><div class="line"></div><div class="line">    <a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;le_common_adv.adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                    adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                    filter_policy, 23 + data_len, app_ble_common_adv_data,</div><div class="line">                                    <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#gaf79d883b90bf38f70f8787d9bd2b34b1">scan_rsp_data_len</a>, <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, le_random_addr);</div><div class="line"></div><div class="line">    <a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga21de10157b31a9041d2e7e7dc862e912">ble_ext_adv_mgr_register_callback</a>(app_ble_common_adv_callback, le_common_adv.adv_handle);</div><div class="line">}</div></div><!-- fragment --><h5>2.2.1.3 Configure Scan Parameters</h5>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> start_ble_scan_test(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_l_e___s_c_a_n.html#ga48324e5e441f6231c66817e11252b885">BLE_SCAN_HDL</a> ble_scan_hdl = <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html">BLE_SCAN_PARAM</a> param;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html">BLE_SCAN_FILTER</a> scan_filter;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html">BLE_SCAN_ADDR</a> scan_addr[2];</div><div class="line"></div><div class="line">    memset(&amp;param, 0, <span class="keyword">sizeof</span>(param));</div><div class="line">    memset(&amp;scan_filter, 0, <span class="keyword">sizeof</span>(scan_filter));</div><div class="line"></div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#ab08b28686a1178811d1f997322fe765d">scan_type</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggabfb4b8a4f61a086b7bcc9fc0369290b7a730b8f936a57599ba75c866d530c3972">GAP_SCAN_MODE_PASSIVE</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#aee6704e14e4d5c590990ef4b80857b94">scan_interval</a> = scan_interval;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#a85da8bab044d1c19454c091830144e06">scan_window</a> = scan_window;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a1bdc8d4bd8f6fc6f3f9a305c5108cb85">ext_filter_duplicate</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggad7846be79e9f41b65818abce198a5315a5b2214ab2c2f0c314f06985ec3b9afee">GAP_SCAN_FILTER_DUPLICATE_DISABLE</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a2602980e7850f3bd7ebad822d96aca1f">ext_filter_policy</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac68db1c94fc5894dc41dc41dc08306baa87b63b24448174322f2c2bba50e11f12">GAP_SCAN_FILTER_WHITE_LIST</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a273c4e7e26f8ceb5956b41b4ed145fb3">own_addr_type</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#aca5c8aaca87d1cd1edb67093f5bd834d">phys</a> = <a class="code" href="group___e_x_t___s_c_a_n___p_h_y.html#gaf648a1f46211910207c388eaa8409a5d">GAP_EXT_SCAN_PHYS_1M_BIT</a>;</div><div class="line"></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a1ec1d6d9e718df1221acd726ffeaaa38">filter_flags</a> = (<a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#ga82090afc72d60f492dab655a1e074a3d">BLE_SCAN_FILTER_EVT_TYPE_BIT</a> | <a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#gad60bb7ae2c3a2cc5f82b80f03093ffa5">BLE_SCAN_FILTER_ADV_DATA_BIT</a> |</div><div class="line">                                <a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#gabc7cb9b364bbc4cf2c3e4c79c32b4eee">BLE_SCAN_FILTER_REMOTE_ADDR_BIT</a>);</div><div class="line"></div><div class="line">    <span class="comment">//filter advertising data</span></div><div class="line">    ad_struct[0] = <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga035ae8edc40c2ddc9bc77fb29ee08d75">GAP_ADTYPE_16BIT_COMPLETE</a>; <span class="comment">//the first byte of ad_struct should be @ref ADV_DATA_TYPE</span></div><div class="line">    ad_struct[1] = <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(GATT_UUID_BATTERY);</div><div class="line">    ad_struct[2] = <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(GATT_UUID_BATTERY);</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a0ce3d6cfbec8e5a2e4deabc25adaae49">ad_len</a> = 3;</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a3493e7e17d3d1d502dc9d10759bf9622">ad_struct</a> = ad_struct;</div><div class="line"></div><div class="line">    <span class="comment">//filter remote address(es)</span></div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#adb055acc222d266d5c08de4ffa2a2b7b">bd_type</a> = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[0] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[1] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[2] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[3] = 0x56;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[4] = 0x22;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[5] = 0x03;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#adb055acc222d266d5c08de4ffa2a2b7b">bd_type</a> = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[0] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[1] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[2] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[3] = 0x56;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[4] = 0x22;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[5] = 0x03;</div><div class="line"></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#afe49eef223d34e5580b7e50f40409deb">addr_num</a> = 2;</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a111dd0eb922fe6fec76382297c307526">p_scan_addr</a> = scan_addr;</div><div class="line"></div><div class="line">    <span class="comment">//filter adv event property</span></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a7a0e5818bea96ca447ef65877c68c1b1">evt_type</a> = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2bacb7ee78262ffe57a2d2ec9ed621f9ae7">LE_EXT_ADV_LEGACY_ADV_NON_SCAN_NON_CONN_UNDIRECTED</a>;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> rtn = <a class="code" href="group___b_l_e___s_c_a_n.html#ga12be8ce6c567ac815613d2a34e5b13b2">ble_scan_start</a>(&amp;ble_scan_hdl, bud_scan_cb, &amp;param, &amp;scan_filter);</div><div class="line">    <span class="keywordflow">return</span> rtn;</div><div class="line">}</div></div><!-- fragment --><p>Parameter Description:</p><ol type="1">
<li>scan_type - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gabfb4b8a4f61a086b7bcc9fc0369290b7">T_GAP_SCAN_MODE</a></li>
<li>scan_interval - Scan Interval, range: 0x0004 to 0x4000 (units of 625us)</li>
<li>scan_window - Scan window, range: 0x0004 to 0x4000 (units of 625us)</li>
<li>ext_filter_policy - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac68db1c94fc5894dc41dc41dc08306ba">T_GAP_SCAN_FILTER_POLICY</a></li>
<li>ext_filter_duplicate - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gad7846be79e9f41b65818abce198a5315">T_GAP_SCAN_FILTER_DUPLICATE</a></li>
<li>scan_filter - APP can filter advertising report by advertising data, remote address or adv event property.</li>
</ol>
<h5>2.2.1.4 Configure Bond Manager Parameters</h5>
<p>A part of parameter types are defined in <a class="el" href="group___g_a_p___common___exported___types.html#ga6b5a306a5b8edce2b24cc7c6019073a2">T_GAP_PARAM_TYPE</a> in <a class="el" href="gap_8h_source.html" title="This file contains all the constants and functions prototypes for GAP. ">gap.h</a>. <br />
 The others are defined in <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#ga440dc453d051aeef569a5861c0f66b82">T_LE_BOND_PARAM_TYPE</a> in <a class="el" href="gap__bond__le_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_bond_le.h</a>. <br />
 Bond manager parameters which can be configured by customers are listed below:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* GAP Bond Manager parameters */</span></div><div class="line">    uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    uint8_t  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    ......</div><div class="line">    <span class="comment">/* Setup the GAP Bond Manager */</span></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> Parameter Description:<br />
</p><ul>
<li><b>auth_pair_mode</b> - <a class="el" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html">Pairing Modes</a>, determines whether the device can be paired in current status.<ul>
<li>GAP_PAIRING_MODE_PAIRABLE: the device can be paired,</li>
<li>GAP_PAIRING_MODE_NO_PAIRING: the device cannot be paired.</li>
</ul>
</li>
<li><b>auth_flags</b> - <a class="el" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html">Mitm And Bonding Flags</a>, a bit field that indicates the requested security properties.</li>
<li><b>auth_io_cap</b> - <a class="el" href="group___g_a_p___common___exported___types.html#gafa5f8a475a6c3126ab20d51881e8dc8d">T_GAP_IO_CAP</a>, indicates I/O capacity of the device.</li>
<li><b>auth_oob</b> - indicates whether oob is enabled.<ul>
<li>true : set oob flag</li>
<li>false : not set oob flag</li>
</ul>
</li>
<li><b>auth_use_fix_passkey</b> - indicates whether an automatically assigned passkey will be used if pairing mode is passkey entry and the local device needs a passkey.<ul>
<li>true : use fixed passkey</li>
<li>false : use random passkey</li>
</ul>
</li>
<li><b>auth_fix_passkey</b> - The default value for passkey used during pairing, which is valid when auth_use_fix_passkey is true.</li>
<li><b>auth_sec_req_enable</b> - determines whether to send SMP security request when connected.</li>
<li><b>auth_sec_req_flags</b> - <a class="el" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html">Mitm And Bonding Flags</a>, a bit field that indicates the requested security properties.</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>2.2.1.5 Configure LE Advertising Extensions Parameters</h5>
<p>This section is only applied to device which uses LE Advertising Extensions.</p><ul>
<li>First, the device needs to configure <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a> to use LE Advertising Extensions.</li>
<li>Then the device configures LE Advertising Extensions advertising related parameters or/and extended scan related parameters according to GAP role of the device.<br />
 For detailed information please refers to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Peripheral_Application">7 BLE BT5 Peripheral Application</a> and <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Central_Application">8 BLE BT5 Central Application</a>.</li>
</ul>
<p><b>Note</b>: <br />
 if use LE Advertising Extensions, and scan exist at the same time, shall use extended scan related API to start scan.</p>
<ol type="1">
<li>Configure GAP Parameter to Use LE Advertising Extensions <br />
<br />
 1) Configure GAP_PARAM_USE_EXTENDED_ADV <br />
 <br />
 To use LE Advertising Extensions, it is necessary to configure <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a> as true.<br />
 <br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* LE Advertising Extensions parameters */</span></div><div class="line">    <span class="keywordtype">bool</span> use_extended = <span class="keyword">true</span>;</div><div class="line">    ......</div><div class="line">    <span class="comment">/* Use LE Advertising Extensions */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, <span class="keyword">sizeof</span>(use_extended), &amp;use_extended);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
 if not use LE Advertising Extensions, it is necessary to configure <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a> as false.<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* LE Advertising Extensions parameters */</span></div><div class="line">    <span class="keywordtype">bool</span> use_extended = <span class="keyword">false</span>;</div><div class="line">    ......</div><div class="line">    <span class="comment">/* Use LE Advertising Extensions */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, <span class="keyword">sizeof</span>(use_extended), &amp;use_extended);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
 2) Configure LE Advertising Extensions advertising parameters <br />
 <br />
 APP can use LE Advertising Extensions to start legacy advertising PDUs or extended advertising PDUs. The adv_event_prop defines property of advertising, and different properties of advertising needs different parameters. The advertising event properties are divided into two categories according to advertising PDUs, which are advertising event properties with legacy advertising PDUs and advertising event properties with extended advertising PDUs.<br />
 <br />
 legacy advertising PDUs:<br />
 <br />
 The advertising event properties with legacy advertising PDUs are listed in Table 2-1 and Table 2-2. If legacy advertising PDU types are used, the amount of data shall not exceed 31 octets. <br />
<br />
 <center><div id="table_2_1"><b>Table 2-1 Extended Advertising Parameters Setting With Legacy Advertising PDUs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">adv_event_prop  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
LEGACY_ADV_<br />
CONN_SCAN_<br />
UNDIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
LEGACY_ADV_<br />
CONN_HIGH_DUTY_<br />
DIRECTED   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><div style="width:250px">adv_handle</div>  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_interval_min  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">primary_adv_interval_max  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_channel_map  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">peer_address_type  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">p_peer_address  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">filter_policy  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_phy  </td><td class="markdownTableBodyLeft">1M PHY  </td><td class="markdownTableBodyLeft">1M PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">secondary_adv_phy  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">allow establish link  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Advertising data  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Scan response data  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
</table>
<div style="page-break-after: always;"></div> <center><div id="table_2_2"><b>Table 2-2 Extended Advertising Parameters Setting With Legacy Advertising PDUs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">adv_event_prop  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
LEGACY_ADV_<br />
SCAN_<br />
UNDIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
LEGACY_ADV_<br />
NON_SCAN_<br />
NON_CONN_<br />
UNDIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
LEGACY_ADV_<br />
CONN_<br />
LOW_DUTY_<br />
DIRECTED   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><div style="width:250px">adv_handle</div>  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_interval_min  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">primary_adv_interval_max  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_channel_map  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">peer_address_type  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">p_peer_address  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">filter_policy  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_phy  </td><td class="markdownTableBodyLeft">1M PHY  </td><td class="markdownTableBodyLeft">1M PHY  </td><td class="markdownTableBodyLeft">1M PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">secondary_adv_phy  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">allow establish link  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Advertising data  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Scan response data  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
</table>
extended advertising PDUs:<br />
 The advertising event properties with extended advertising PDUs are listed in Table 2-3 and Table 2-4. The sample codes about extended advertising related parameters setting with extended advertising PDUs are provided in bt5_peripheral_stack_api.h and bt5_peripheral_stack_api.c. <br />
</li>
</ol>
<center><div id="table_2_3"><b>Table 2-3 Extended Advertising Parameters Setting With Extended Advertising PDUs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">adv_event_prop  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
NON_SCAN_<br />
NON_CONN_<br />
UNDIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
NON_SCAN_<br />
NON_CONN_<br />
DIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
CONN_<br />
UNDIRECTED   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">adv_handle  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_interval_min  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">primary_adv_interval_max  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_channel_map  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">peer_address_type  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">p_peer_address  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">filter_policy  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_phy  </td><td class="markdownTableBodyLeft">1M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/Coded PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">secondary_adv_phy  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">allow establish link  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Advertising data  </td><td class="markdownTableBodyLeft">Y(1024 bytes)  </td><td class="markdownTableBodyLeft">Y(1024 bytes)  </td><td class="markdownTableBodyLeft">Y(245 bytes)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Scan response data  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
</table>
<div style="page-break-after: always;"></div> <center><div id="table_2_4"><b>Table 2-4 Extended Advertising Parameters Setting With Extended Advertising PDUs </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">adv_event_prop  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
CONN_<br />
DIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
SCAN_<br />
UNDIRECTED  </th><th class="markdownTableHeadLeft">LE_EXT_ADV_<br />
EXTENDED_ADV_<br />
SCAN_<br />
DIRECTED   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">adv_handle  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_interval_min  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">primary_adv_interval_max  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_channel_map  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">peer_address_type  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">p_peer_address  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">filter_policy  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">primary_adv_phy  </td><td class="markdownTableBodyLeft">1M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/Coded PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">secondary_adv_phy  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY  </td><td class="markdownTableBodyLeft">1M/2M/Coded PHY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">allow establish link  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Advertising data  </td><td class="markdownTableBodyLeft">Y(239 bytes)  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Scan response data  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y(991 bytes)  </td><td class="markdownTableBodyLeft">Y(991 bytes)   </td></tr>
</table>
<p>If only one advertising set is used, the maximum length of data is listed in Table 2-3 and Table 2-4.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.2.5.3 Configure Extended Scan Related Parameters</h5>
<p>This section is applied to observer role or central role. For detailed information on extended scan and extended create connection please refers to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Central_Application">8 BLE BT5 Central Application</a>.</p>
<p><b>Note</b>: <br />
 To use Extended Scan, it is necessary to configure <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a> as true.<br />
</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> start_ble_scan_test(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_l_e___s_c_a_n.html#ga48324e5e441f6231c66817e11252b885">BLE_SCAN_HDL</a> ble_scan_hdl = <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html">BLE_SCAN_PARAM</a> param;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html">BLE_SCAN_FILTER</a> scan_filter;</div><div class="line">    <a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html">BLE_SCAN_ADDR</a> scan_addr[2];</div><div class="line"></div><div class="line">    memset(&amp;param, 0, <span class="keyword">sizeof</span>(param));</div><div class="line">    memset(&amp;scan_filter, 0, <span class="keyword">sizeof</span>(scan_filter));</div><div class="line"></div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#ab08b28686a1178811d1f997322fe765d">scan_type</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggabfb4b8a4f61a086b7bcc9fc0369290b7a730b8f936a57599ba75c866d530c3972">GAP_SCAN_MODE_PASSIVE</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#aee6704e14e4d5c590990ef4b80857b94">scan_interval</a> = scan_interval;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a09250adeb6d03f7181095f905fd4e6c9">scan_param_1m</a>.<a class="code" href="struct_t___g_a_p___l_e___e_x_t___s_c_a_n___p_a_r_a_m.html#a85da8bab044d1c19454c091830144e06">scan_window</a> = scan_window;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a1bdc8d4bd8f6fc6f3f9a305c5108cb85">ext_filter_duplicate</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggad7846be79e9f41b65818abce198a5315a5b2214ab2c2f0c314f06985ec3b9afee">GAP_SCAN_FILTER_DUPLICATE_DISABLE</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a2602980e7850f3bd7ebad822d96aca1f">ext_filter_policy</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac68db1c94fc5894dc41dc41dc08306baa87b63b24448174322f2c2bba50e11f12">GAP_SCAN_FILTER_WHITE_LIST</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#a273c4e7e26f8ceb5956b41b4ed145fb3">own_addr_type</a> = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___s_c_a_n___p_a_r_a_m.html#aca5c8aaca87d1cd1edb67093f5bd834d">phys</a> = <a class="code" href="group___e_x_t___s_c_a_n___p_h_y.html#gaf648a1f46211910207c388eaa8409a5d">GAP_EXT_SCAN_PHYS_1M_BIT</a>;</div><div class="line"></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a1ec1d6d9e718df1221acd726ffeaaa38">filter_flags</a> = (<a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#ga82090afc72d60f492dab655a1e074a3d">BLE_SCAN_FILTER_EVT_TYPE_BIT</a> | <a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#gad60bb7ae2c3a2cc5f82b80f03093ffa5">BLE_SCAN_FILTER_ADV_DATA_BIT</a> |</div><div class="line">                                <a class="code" href="group___b_l_e___s_c_a_n___f_i_l_t_e_r.html#gabc7cb9b364bbc4cf2c3e4c79c32b4eee">BLE_SCAN_FILTER_REMOTE_ADDR_BIT</a>);</div><div class="line"></div><div class="line">    <span class="comment">//filter advertising data</span></div><div class="line">    ad_struct[0] = <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga035ae8edc40c2ddc9bc77fb29ee08d75">GAP_ADTYPE_16BIT_COMPLETE</a>; <span class="comment">//the first byte of ad_struct should be @ref ADV_DATA_TYPE</span></div><div class="line">    ad_struct[1] = <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(GATT_UUID_BATTERY);</div><div class="line">    ad_struct[2] = <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(GATT_UUID_BATTERY);</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a0ce3d6cfbec8e5a2e4deabc25adaae49">ad_len</a> = 3;</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a3493e7e17d3d1d502dc9d10759bf9622">ad_struct</a> = ad_struct;</div><div class="line"></div><div class="line">    <span class="comment">//filter remote address(es)</span></div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#adb055acc222d266d5c08de4ffa2a2b7b">bd_type</a> = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[0] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[1] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[2] = 0x66;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[3] = 0x56;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[4] = 0x22;</div><div class="line">    scan_addr[0].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[5] = 0x03;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#adb055acc222d266d5c08de4ffa2a2b7b">bd_type</a> = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[0] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[1] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[2] = 0x77;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[3] = 0x56;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[4] = 0x22;</div><div class="line">    scan_addr[1].<a class="code" href="struct_b_l_e___s_c_a_n___a_d_d_r.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>[5] = 0x03;</div><div class="line"></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#afe49eef223d34e5580b7e50f40409deb">addr_num</a> = 2;</div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a111dd0eb922fe6fec76382297c307526">p_scan_addr</a> = scan_addr;</div><div class="line"></div><div class="line">    <span class="comment">//filter adv event property</span></div><div class="line">    scan_filter.<a class="code" href="struct_b_l_e___s_c_a_n___f_i_l_t_e_r.html#a7a0e5818bea96ca447ef65877c68c1b1">evt_type</a> = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2bacb7ee78262ffe57a2d2ec9ed621f9ae7">LE_EXT_ADV_LEGACY_ADV_NON_SCAN_NON_CONN_UNDIRECTED</a>;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> rtn = <a class="code" href="group___b_l_e___s_c_a_n.html#ga12be8ce6c567ac815613d2a34e5b13b2">ble_scan_start</a>(&amp;ble_scan_hdl, bud_scan_cb, &amp;param, &amp;scan_filter);</div><div class="line">    <span class="keywordflow">return</span> rtn;</div><div class="line">}</div></div><!-- fragment --><p>Parameter Description:</p><ol type="1">
<li>scan_type - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gabfb4b8a4f61a086b7bcc9fc0369290b7">T_GAP_SCAN_MODE</a></li>
<li>scan_interval - Scan Interval, range: 0x0004 to 0x4000 (units of 625us)</li>
<li>scan_window - Scan window, range: 0x0004 to 0x4000 (units of 625us)</li>
<li>ext_filter_policy - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac68db1c94fc5894dc41dc41dc08306ba">T_GAP_SCAN_FILTER_POLICY</a></li>
<li>ext_filter_duplicate - <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gad7846be79e9f41b65818abce198a5315">T_GAP_SCAN_FILTER_DUPLICATE</a></li>
<li>scan_filter - APP can filter advertising report by advertising data, remote address or adv event property.</li>
</ol>
<h5>2.2.1.6 Configure Other Parameters</h5>
<p>Configure GAP_PARAM_SLAVE_INIT_GATT_MTU_REQ <br />
</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t  slave_init_mtu_req = <span class="keyword">false</span>;</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaf04baac1b9d2ef5d9695b5f5c8159f43">GAP_PARAM_SLAVE_INIT_GATT_MTU_REQ</a>, <span class="keyword">sizeof</span>(slave_init_mtu_req),</div><div class="line">                     &amp;slave_init_mtu_req);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> This parameter is used only for peripheral role. This parameter determines whether to send exchange MTU request when connected.</p>
<h4><a class="anchor" id="GAP_Startup_Flow"></a>
2.2.2 GAP Startup Flow</h4>
<ol type="1">
<li>Initialize GAP <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___s_p_p___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>();</div><div class="line">    ......</div><div class="line">    app_le_profile_init();</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <b><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a></b> - Initialize GAP and set link number <br />
 <b><a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a></b> - Initialize gap_utils.lib <br />
 <b><a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a></b> - Initialize GAP parameters <br />
 <b>app_le_profile_init</b> - Initialize GATT Profile <br />
<br />
</li>
<li>Start BT stack in app task <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab31ebd8f8c8b560ef3c96e2b599dd653">app_main_task</a>(<span class="keywordtype">void</span> *p_param)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaaf45be3842e5882f90db4267ffbfe036">MAX_NUMBER_OF_GAP_MESSAGE</a>);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> App needs to call <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a> to start BT stack and start GAP initialization flow. <br />
<br />
</li>
<li>GAP internal initialization flow <br />
 GAP internal initialization flow is shown in Figure 2-8. <br />
<br />
 <div class="image">
<img src="periph_gap_flow.png" alt="periph_gap_flow.png"/>
</div>
 <center><div id="figure_2_8"><b>Figure 2-8 GAP Internal Initialization Flow </b></div></center></li>
</ol>
<p>Flow chart Description:</p><ul>
<li><b>gap_start_bt_stack</b> : Make upper stack ready to be used, by sending the register request.</li>
<li><b>receive act info</b> : Used by Upper Stack to inform the GAP layer that it is ready.</li>
<li><b>set pair mode</b> : Set values of <br />
 <a class="el" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <br />
 <a class="el" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>,<br />
 <a class="el" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>,<br />
 <a class="el" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>.<br />
</li>
<li><b>set local IRK</b> : Set local IRK.<br />
 If <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a7d04b9c55fee77335aefca0382a3b626">GAP_PARAM_BOND_GEN_LOCAL_IRK_AUTO</a> is set to true, GAP will use automatic generation IRK and save the IRK to flash. Otherwise, use <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a6f8f3f86524ea06894173ac8b722fb9b">GAP_PARAM_BOND_SET_LOCAL_IRK</a> value.</li>
<li><b>set privacy timeout</b> : Optional procedure. If app calls <a class="el" href="group___gap___privacy___exported___functions.html#ga7d7a1903770c7c9ff3b3d4c1b9aff6c6" title="Set a LE privacy parameter. ">le_privacy_set_param()</a> to set <a class="el" href="group___gap___privacy___exported___types.html#ggaba54ef708e4581b2dfc8ee4d3f6c4b77aeb2173b4dd3b7dcba93e43db5a17f45c">GAP_PARAM_PRIVACY_TIMEOUT</a>, GAP layer will set privacy timeout in initialization flow.</li>
<li><b>set extended mode</b> : Optional procedure. If app calls <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79" title="Set a GAP Common parameter. ">le_set_gap_param()</a> to set <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, GAP layer will set extended mode in initialization flow.</li>
<li><b>set random address</b> : Optional procedure. If app calls <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79" title="Set a GAP Common parameter. ">le_set_gap_param()</a> to set <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea5bd740d56a0caf83579e00a85f95e52c">GAP_PARAM_RANDOM_ADDR</a> , GAP layer will set random address in initialization flow.</li>
<li><b>set fixed passkey</b> : Set values of <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a> and <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>.</li>
<li><b>set default physical</b> : Optional procedure. If app calls <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79" title="Set a GAP Common parameter. ">le_set_gap_param()</a> to set <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1b6bd46140c4e94e8ae79c9a23f281e6">GAP_PARAM_DEFAULT_PHYS_PREFER</a>, <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaa183de337bb7d026d5484d6944556990">GAP_PARAM_DEFAULT_TX_PHYS_PREFER</a> or <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eacd2c2351754a7a6972fb319f9e356ee3">GAP_PARAM_DEFAULT_RX_PHYS_PREFER</a>, GAP layer will set default physical in initialization flow.</li>
<li><b>register GATT services</b> : Register all GATT services to upper stack.</li>
<li><b>send GAP_INIT_STATE_STACK_READY</b> to APP : GAP initialization flow is completed.</li>
</ul>
<h3><a class="anchor" id="Bluetooth_LE_GAP_Message"></a>
2.3 Bluetooth LE GAP Message</h3>
<h4><a class="anchor" id="Bluetooth_LE_GAP_Message_Overview"></a>
2.3.1 Overview</h4>
<p>The purpose of this chapter is to give an overview of <b>LE GAP Message Module</b>. The GAP message type definitions and message data structures are defined in <a class="el" href="gap__msg_8h_source.html" title="This file contains function prototype for all GAP roles. ">gap_msg.h</a>. <br />
 GAP message can divide into four types:<br />
</p><ul>
<li>Device State Message</li>
<li>Connection Related Message</li>
<li>Authentication Related Message</li>
<li>Extended Advertising State Message</li>
</ul>
<p>LE GAP Message processes flow: <br />
</p><ol type="1">
<li>APP can call <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a> to initialize the LE GAP message module. The initialize codes are given below: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab31ebd8f8c8b560ef3c96e2b599dd653">app_main_task</a>(<span class="keywordtype">void</span> *p_param)</div><div class="line">{</div><div class="line">    ......</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaaf45be3842e5882f90db4267ffbfe036">MAX_NUMBER_OF_GAP_MESSAGE</a>);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li>GAP layer sends the GAP message to <a class="el" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>. App task receives the GAP messages and calls app_handle_io_msg to handle. ( Event: <a class="el" href="group___a_p_p___m_s_g___exported___types.html#ggae013f504d288fa3c19ec0f1af745975ca54fa1d4504aab64b0e290572ad56a13e">EVENT_IO_TO_APP</a>, type: <a class="el" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074a79100fd91a7425e96a85a7db3a7f308e">IO_MSG_TYPE_BT_STATUS</a>). <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab31ebd8f8c8b560ef3c96e2b599dd653">app_main_task</a>(<span class="keywordtype">void</span> *p_param)</div><div class="line">{</div><div class="line">    ......</div><div class="line">            <span class="keywordflow">if</span> (event == <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggae013f504d288fa3c19ec0f1af745975ca54fa1d4504aab64b0e290572ad56a13e">EVENT_IO_TO_APP</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_msg;</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___o_s__87x3d___message.html#ga10998e34fdfdd3297af840e60d03b09b">os_msg_recv</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>, &amp;io_msg, 0) == <span class="keyword">true</span>)</div><div class="line">                {</div><div class="line">                    app_handle_io_msg(io_msg);</div><div class="line">                }</div><div class="line">            }</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li>The GAP messages handler function are given below: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_io_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_msg)</div><div class="line">{</div><div class="line">    uint16_t msg_type = io_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (msg_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074a79100fd91a7425e96a85a7db3a7f308e">IO_MSG_TYPE_BT_STATUS</a>:</div><div class="line">        {</div><div class="line">            app_handle_gap_msg(&amp;io_msg);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">switch</span> (p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae9874bb97b4d115932f5f124be42ad92">GAP_MSG_LE_DEV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_dev_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#a7c69580dcb030e2dc78819f2e6cafdbc">new_state</a>,</div><div class="line">                                     gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                      (<a class="code" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>)gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                      gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a15f45b2c898ca276b537e9c749fced6b">disc_cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad09d9df87275d5f64d9b1885af179800">GAP_MSG_LE_CONN_MTU_INFO</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_mtu_info_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                         gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a7494d27aae03bdf1d9092563e1cc1026">mtu_size</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga0d1a35f4e8a0e57d172fe10f12807066">GAP_MSG_LE_CONN_PARAM_UPDATE</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_param_update_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                             gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#ade818037fd6c985038ff29656089758d">status</a>,</div><div class="line">                                             gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gaf4e6edb01c279d7966d8114ad2f55437">GAP_MSG_LE_AUTHEN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_authen_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                        gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                        gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a5393c99e246925076b1dfd69a64177ef">status</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gac03fcf124046d4d4ee2e8b9a21ed4bab">GAP_MSG_LE_BOND_JUST_WORK</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae4f8067dc7ca40f371ae85922619205c">GAP_MSG_LE_BOND_PASSKEY_DISPLAY</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gada28f27ecd48284a36b0fb69934c1c94">GAP_MSG_LE_BOND_USER_CONFIRMATION</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad3378cc599f99bec96a48a40ade535fb">GAP_MSG_LE_BOND_PASSKEY_INPUT</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae2a234929d028693a7a2970e35f94c3b">GAP_MSG_LE_BOND_OOB_INPUT</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="Bluetooth_LE_GAP_Message_Device_State_Message"></a>
2.3.2 Device State Message</h4>
<p>This message is used to inform GAP Device state(<a class="el" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> ). <br />
 GAP device state contains four sub states: <br />
</p><ul>
<li>gap_init_state : <a class="el" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html">GAP Initial State</a></li>
<li>gap_adv_state : <a class="el" href="group___g_a_p___a_d_v___s_t_a_t_e.html">GAP Advertising State</a><ul>
<li>gap_adv_sub_state : <a class="el" href="group___g_a_p___a_d_v___s_u_b___s_t_a_t_e.html">GAP Advertising Substate</a>, used when gap_adv_state = <a class="el" href="group___g_a_p___a_d_v___s_t_a_t_e.html#ga1c5587685f9f5db48cec93fb7edf052d">GAP_ADV_STATE_IDLE</a></li>
</ul>
</li>
<li>gap_scan_state : <a class="el" href="group___g_a_p___s_c_a_n___s_t_a_t_e.html">GAP Scan State</a></li>
<li>gap_conn_state : <a class="el" href="group___g_a_p___c_o_n_n___s_t_a_t_e.html">GAP Connection State</a></li>
</ul>
<p>Message data: <a class="el" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html">T_GAP_DEV_STATE_CHANGE</a> <br />
</p>
<p>The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP stack ready&quot;</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_scan_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a> == <a class="code" href="group___g_a_p___s_c_a_n___s_t_a_t_e.html#ga9ddd1c1e4c5f3215bfd929df4d482428">GAP_SCAN_STATE_IDLE</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP scan stop&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a> == <a class="code" href="group___g_a_p___s_c_a_n___s_t_a_t_e.html#ga2450c039188dbde99019d20f5fe6e6e8">GAP_SCAN_STATE_SCANNING</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP scan start&quot;</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_adv_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a> == <a class="code" href="group___g_a_p___a_d_v___s_t_a_t_e.html#ga1c5587685f9f5db48cec93fb7edf052d">GAP_ADV_STATE_IDLE</a>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa67638004f4a165547051d9eab991b5">gap_adv_sub_state</a> == <a class="code" href="group___g_a_p___a_d_v___s_u_b___s_t_a_t_e.html#ga3f4e0614e54d9116380a17334edc6e10">GAP_ADV_TO_IDLE_CAUSE_CONN</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP adv stoped: because connection created&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP adv stoped&quot;</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a> == <a class="code" href="group___g_a_p___a_d_v___s_t_a_t_e.html#ga566b8260d553042a0ad484eaa9c5b743">GAP_ADV_STATE_ADVERTISING</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP adv start&quot;</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_conn_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a29c134a279511591376fff5b0097edb5">gap_conn_state</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;conn state: %d -&gt; %d&quot;</span>,</div><div class="line">                        gap_dev_state.gap_conn_state,</div><div class="line">                        new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a29c134a279511591376fff5b0097edb5">gap_conn_state</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="Bluetooth_LE_GAP_Message_Connection_Related_Message"></a>
2.3.3 Connection Related Message</h4>
<h5>2.3.3.1 GAP_MSG_LE_CONN_STATE_CHANGE</h5>
<p>This message is used to inform GAP Connection state(<a class="el" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> ). <br />
 Message data: <a class="el" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html">T_GAP_CONN_STATE_CHANGE</a> <br />
</p>
<p>The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state, uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: conn_id %d old_state %d new_state %d, disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, gap_conn_state, new_state, disc_cause);</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___t_y_p_e_s.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___t_y_p_e_s.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___t_y_p_e_s.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___t_y_p_e_s.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: connection lost cause 0x%x&quot;</span>, disc_cause);</div><div class="line">            }</div><div class="line"></div><div class="line">            <a class="code" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a>();</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">            ......</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    gap_conn_state = new_state;</div><div class="line">}</div></div><!-- fragment --><h5>2.3.3.2 GAP_MSG_LE_CONN_PARAM_UPDATE</h5>
<p>This message is used to inform APP of connection parameter update procedure status. Message data please reference: <a class="el" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html">T_GAP_CONN_PARAM_UPDATE</a> <br />
<br />
 connection parameter update have three status:</p><ul>
<li>GAP_CONN_PARAM_UPDATE_STATUS_PENDING: If local device calls <a class="el" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga8c982b448421ad52c90509386de5d9cd">le_update_conn_param</a> to update connection parameter. GAP Layer will send this status when connection parameter update request is successful and connection update complete event is not notified. <br />
</li>
<li>GAP_CONN_PARAM_UPDATE_STATUS_SUCCESS: update succeeded. <br />
</li>
<li>GAP_CONN_PARAM_UPDATE_STATUS_FAIL: update failed, and parameter cause expresses the failure reason. <br />
</li>
</ul>
<p>The sample codes are given below: <br />
<br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_param_update_evt(uint8_t conn_id, uint8_t status, uint16_t cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e___s_t_a_t_u_s.html#gaf94551f437ede78ee5b0b8ec626798d5">GAP_CONN_PARAM_UPDATE_STATUS_SUCCESS</a>:</div><div class="line">         ......</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e___s_t_a_t_u_s.html#gafa55630c73b2762cc31475c72ffd51ee">GAP_CONN_PARAM_UPDATE_STATUS_FAIL</a>:</div><div class="line">         ......</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e___s_t_a_t_u_s.html#gaa1b0947fa704666db1b34c304c088bca">GAP_CONN_PARAM_UPDATE_STATUS_PENDING</a>:</div><div class="line">         ......</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h5>2.3.3.3 GAP_MSG_LE_CONN_MTU_INFO</h5>
<p>This message is used to inform APP that exchange MTU procedure is completed.</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html">T_GAP_CONN_MTU_INFO</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_mtu_info_evt(uint8_t conn_id, uint16_t mtu_size)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_handle_conn_mtu_info_evt: conn_id %d, mtu_size %d&quot;</span>, conn_id, mtu_size);</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="Bluetooth_LE_GAP_Message_Authentication_Related_Message"></a>
2.3.4 Authentication Related Message</h4>
<p>The relationship of pairing method and authentication message is shown in Table 2-5.</p>
<center><div id="table_2_5"><b>Table 2-5 Authentication Related Message </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Pairing Method  </th><th class="markdownTableHeadLeft">Message   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Just Works  </td><td class="markdownTableBodyLeft">GAP_MSG_LE_BOND_JUST_WORK   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Numeric Comparison  </td><td class="markdownTableBodyLeft">GAP_MSG_LE_BOND_USER_CONFIRMATION   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Passkey Entry  </td><td class="markdownTableBodyLeft">GAP_MSG_LE_BOND_PASSKEY_INPUT <br />
GAP_MSG_LE_BOND_PASSKEY_DISPLAY   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Out Of Band (OOB)  </td><td class="markdownTableBodyLeft">GAP_MSG_LE_BOND_OOB_INPUT   </td></tr>
</table>
<h5>2.3.4.1 GAP_MSG_LE_AUTHEN_STATE_CHANGE</h5>
<p>This message indicates the new authentication state. <br />
 <a class="el" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga2e41e8a62b92033c157ebf6de37b0f48">GAP_AUTHEN_STATE_STARTED</a> : authentication starts <br />
 <a class="el" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga74ca456a387d4acd1465fcc2a7419605">GAP_AUTHEN_STATE_COMPLETE</a> : authentication completed, and parameter cause expresses the authentication result.</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html">T_GAP_AUTHEN_STATE</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_authen_state_evt(uint8_t conn_id, uint8_t new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga2e41e8a62b92033c157ebf6de37b0f48">GAP_AUTHEN_STATE_STARTED</a>:</div><div class="line">         ......</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga74ca456a387d4acd1465fcc2a7419605">GAP_AUTHEN_STATE_COMPLETE</a>:</div><div class="line">         ......</div><div class="line">         <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.3.4.2 GAP_MSG_LE_BOND_PASSKEY_DISPLAY</h5>
<p>This message indicates that the pairing mode is passkey entry(a key is displayed in local device, and the same key is input in the remote device). Upon receiving the message, App can display the passkey at its UI terminal (how to handle it depends on App itself). App also needs to call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga33841a325f5047b6d4bd0294c52d9ced">le_bond_passkey_display_confirm</a> to confirm whether to pair with remote device.</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___d_i_s_p_l_a_y.html">T_GAP_BOND_PASSKEY_DISPLAY</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae4f8067dc7ca40f371ae85922619205c">GAP_MSG_LE_BOND_PASSKEY_DISPLAY</a>:</div><div class="line">        {</div><div class="line">            uint32_t display_value = 0;</div><div class="line">            conn_id = gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a14cdf60b156e5767b3d7c1913204bc0b">gap_bond_passkey_display</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___d_i_s_p_l_a_y.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>;</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gad39ad8689c5c4ed4d62584918d19648e">le_bond_get_display_key</a>(conn_id, &amp;display_value);</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_PASSKEY_DISPLAY:passkey %d&quot;</span>, display_value);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga33841a325f5047b6d4bd0294c52d9ced">le_bond_passkey_display_confirm</a>(conn_id, <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.3.4.3 GAP_MSG_LE_BOND_PASSKEY_INPUT</h5>
<p>This message indicates that the pairing mode is passkey entry(a key is displayed in remote device, and the same key is input in the local device). Upon receiving the message, App can call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9f42bea4127cb8a461ebe2569b1e1d28">le_bond_passkey_input_confirm</a> to input the key and confirm whether to pair with remote device.</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___i_n_p_u_t.html">T_GAP_BOND_PASSKEY_INPUT</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad3378cc599f99bec96a48a40ade535fb">GAP_MSG_LE_BOND_PASSKEY_INPUT</a>:</div><div class="line">        {</div><div class="line">            uint32_t passkey = 888888;</div><div class="line">            conn_id = gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ac6262590cdef5a2dd624fa2cef04ccf1">gap_bond_passkey_input</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___i_n_p_u_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>;</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_PASSKEY_INPUT: conn_id %d&quot;</span>, conn_id);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9f42bea4127cb8a461ebe2569b1e1d28">le_bond_passkey_input_confirm</a>(conn_id, passkey, <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.3.4.4 GAP_MSG_LE_BOND_OOB_INPUT</h5>
<p>This message indicates that the pairing mode is OOB(the local device needs to provide a OOB data which was exchanged with the remote device).</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___b_o_n_d___o_o_b___i_n_p_u_t.html">T_GAP_BOND_OOB_INPUT</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> LE_GAP_MSG_TYPE_BOND_OOB_INPUT:</div><div class="line">        {</div><div class="line">            uint8_t oob_data[<a class="code" href="group___g_a_p___common___macros.html#ga93dbe22884ddc94ca3aa206765b95d61">GAP_OOB_LEN</a>] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};</div><div class="line">            conn_id = gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afc0d340d369ed1e8bf9b1cd699b70a93">gap_bond_oob_input</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___o_o_b___i_n_p_u_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>;</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_OOB_INPUT&quot;</span>);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a07d9cda9192f5ef3cd56dbc0a8ec50ab">GAP_PARAM_BOND_OOB_DATA</a>, <a class="code" href="group___g_a_p___common___macros.html#ga93dbe22884ddc94ca3aa206765b95d61">GAP_OOB_LEN</a>, oob_data);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gaef7f9d74ed20610687e75bed8bcfb4cb">le_bond_oob_input_confirm</a>(conn_id, <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.3.4.5 GAP_MSG_LE_BOND_USER_CONFIRMATION</h5>
<p>This message is used to indicate that the pairing mode is Numeric Comparison. The keys are displayed at both local device and remote device, and user needs to check whether the keys are the same. APP needs to call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga4d31b81e3c1c0e487126e1b313062a04">le_bond_user_confirm()</a> to confirm whether to pair with remote device.</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___b_o_n_d___u_s_e_r___c_o_n_f.html">T_GAP_BOND_USER_CONF</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gada28f27ecd48284a36b0fb69934c1c94">GAP_MSG_LE_BOND_USER_CONFIRMATION</a>:</div><div class="line">        {</div><div class="line">            uint32_t display_value = 0;</div><div class="line">            conn_id = gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afde50b1f06980787643f56943b4ef36c">gap_bond_user_conf</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___u_s_e_r___c_o_n_f.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>;</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gad39ad8689c5c4ed4d62584918d19648e">le_bond_get_display_key</a>(conn_id, &amp;display_value);</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_USER_CONFIRMATION: passkey %d&quot;</span>, display_value);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga4d31b81e3c1c0e487126e1b313062a04">le_bond_user_confirm</a>(conn_id, <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><h5>2.3.4.6 GAP_MSG_LE_BOND_JUST_WORK</h5>
<p>This message indicates that the pairing mode is Just work(App needs to call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gaca42e7586eff9859728cb7001594dfef">le_bond_just_work_confirm</a> to confirm whether to pair with remote device).</p>
<p>Message data: <a class="el" href="struct_t___g_a_p___b_o_n_d___j_u_s_t___w_o_r_k___c_o_n_f.html">T_GAP_BOND_JUST_WORK_CONF</a> <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gac03fcf124046d4d4ee2e8b9a21ed4bab">GAP_MSG_LE_BOND_JUST_WORK</a>:</div><div class="line">        {</div><div class="line">            conn_id = gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afd6dc52537ee4e70bc3443a4fb329c49">gap_bond_just_work_conf</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___j_u_s_t___w_o_r_k___c_o_n_f.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>;</div><div class="line">            <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gaca42e7586eff9859728cb7001594dfef">le_bond_just_work_confirm</a>(conn_id, <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_JUST_WORK&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="Bluetooth_LE_GAP_Message_Extended_Advertising_State_Message"></a>
2.3.5 Extended Advertising State Message</h4>
<h5>2.3.5.1 GAP_MSG_LE_EXT_ADV_STATE_CHANGE</h5>
<p>This message is used to inform extended advertising state (T_GAP_EXT_ADV_STATE). Message data structure is <a class="el" href="struct_t___g_a_p___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html" title="The msg_data of GAP_MSG_LE_EXT_ADV_STATE_CHANGE. ">T_GAP_EXT_ADV_STATE_CHANGE</a>. The sample codes are given as below:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_ext_adv_state_evt(uint8_t adv_handle, <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ga583d6dcf8cbca81419d777863bf58da2">T_GAP_EXT_ADV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="comment">/* device is idle */</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2af1ce6f46f5fa7618f5fc93116c2a3011">EXT_ADV_STATE_IDLE</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;EXT_ADV_STATE_IDLE: adv_handle %d, cause 0x%x&quot;</span>, adv_handle, cause);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="comment">/* device is advertising */</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gga583d6dcf8cbca81419d777863bf58da2a6e791b28520bc2c3de61bfc08e01558c">EXT_ADV_STATE_ADVERTISING</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;EXT_ADV_STATE_ADVERTISING: adv_handle %d, cause 0x%x&quot;</span>, adv_handle, cause);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Bluetooth_LE_GAP_Callback"></a>
2.4 Bluetooth LE GAP Callback</h3>
<p>The purpose of this chapter is to give an overview of <b>BLE GAP Callback</b>. This registered callback function is used by LE GAP Layer to send messages to App. <br />
 Different from <b>BLE GAP Message</b>, the Callback function is actually directly called on the GAP layer, so it is <b>not recommended to perform any time-consuming operation in the App Callback function.</b> Any time-consuming operation will keep any underlying process waiting and suspending, which may cause a exception in some cases. If Application does need to perform a time-consuming operation immediately after receiving a message from GAP Layer, it is <b>recommended to send this message to the event queue in Application through the App Callback function before being handled by Application.</b> In such case, App Callback function will terminate after sending message to the queue, so it will not keep underlying process waiting.<br />
</p>
<p>The use of LE GAP Callback in Application includes the following steps:</p>
<ul>
<li>Register the callback function: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_gap_callback);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li>Handle the GAP callback messages: <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#gaf0402630f5cd20214a6e9cff4ecac7bd">GAP_MSG_LE_DATA_LEN_CHANGE_INFO</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;GAP_MSG_LE_DATA_LEN_CHANGE_INFO: conn_id %d, tx octets 0x%x, max_tx_time 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#aa3da8be7b43d1b243885c4a9c733ba7f">max_tx_octets</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#aa003e7a864b65c381f67031acb6295b4">max_tx_time</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
</ul>
<h4><a class="anchor" id="Bluetooth_LE_GAP_Callback_Message_Overview"></a>
2.4.1 Bluetooth LE GAP Callback Message Overview</h4>
<p>This section describes GAP callback messages. GAP callback message type and message data are defined in <a class="el" href="gap__callback__le_8h_source.html" title="This file contains function prototype for all GAP roles. ">gap_callback_le.h</a>. in Table 2-6 to Table 2-13, Reference API provided by GAP Layer are asynchronous, and GAP Layer uses the callback function with Callback data and Callback type to send response. <br />
 <b>For example:</b><br />
 Reference API is <a class="el" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga4835945c8e2368325970316179e41fdb">le_read_rssi()</a><br />
 Callback data(p_cb_data) is <a class="el" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html" title="Response for read rssi. ">T_LE_READ_RSSI_RSP</a> *p_le_read_rssi_rsp <br />
 Callback type(cb_type) is <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga6e7052b75a1a71ca8de684a3e8e58675">GAP_MSG_LE_READ_RSSI</a> <br />
 App call <a class="el" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga4835945c8e2368325970316179e41fdb" title="Read rssi value of the connection. RSSI value will be returned by app_gap_callback with cb_type GAP_M...">le_read_rssi()</a> to read rssi. <br />
When the return value is <a class="el" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>, that means sending request successfully. when read rssi complete, GAP will call gap_app_cb() with Callback data <a class="el" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html">T_LE_READ_RSSI_RSP</a> and Callback type <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga6e7052b75a1a71ca8de684a3e8e58675">GAP_MSG_LE_READ_RSSI</a>, and then application needs to wait <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga6e7052b75a1a71ca8de684a3e8e58675">GAP_MSG_LE_READ_RSSI</a> to get the result.<br />
</p>
<p><b>Note:</b> <br />
 All Reference API provided in this chapter shall be called after BLE stack ready. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_ble_gap_handle_dev_state_change_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga2ba15753eabd039b34277085aca716f1">APP_PRINT_TRACE5</a>(<span class="stringliteral">&quot;app_ble_gap_handle_dev_state_change_evt: le_state.gap_adv_state %d, new_state.gap_adv_state %d, &quot;</span></div><div class="line">                     <span class="stringliteral">&quot;le_state.gap_scan_state %d, new_state.gap_scan_state %d, cause 0x%04x&quot;</span>,</div><div class="line">                     le_state.gap_adv_state,</div><div class="line">                     new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>,</div><div class="line">                     le_state.gap_scan_state,</div><div class="line">                     new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a>,</div><div class="line">                     cause);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (le_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            <span class="comment">// GAP_INIT_STATE_STACK_READY means BLE stack ready. All Reference API provided in this chapter shall be called after BLE stack ready.</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    le_state = new_state;</div><div class="line">}</div></div><!-- fragment --><p>LE GAP Message details are listed below: <br />
</p>
<ol type="1">
<li><a class="el" href="gap__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_le.h</a> Related Messages <center><div id="table_2_6"><b>Table 2-6 <a class="el" href="gap__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_le.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
MODIFY_WHITE_LIST  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___m_o_d_i_f_y___w_h_i_t_e___l_i_s_t___r_s_p.html" title="Response of le modify white list request. ">T_LE_MODIFY_WHITE_LIST_RSP</a><br />
*p_le_modify_white_list_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga36252f7752759c51513639e0b1622901">le_modify_white_list</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
SET_RAND_ADDR  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___s_e_t___r_a_n_d___a_d_d_r___r_s_p.html" title="Response of le set random address request. ">T_LE_SET_RAND_ADDR_RSP</a><br />
*p_le_set_rand_addr_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga3267488a63f551a2d78b91fbdd6a4661">le_set_rand_addr</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
SET_HOST_<br />
CHANN_CLASSIF  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___s_e_t___h_o_s_t___c_h_a_n_n___c_l_a_s_s_i_f___r_s_p.html" title="Response of le set channel classification request. ">T_LE_SET_HOST_CHANN_CLASSIF_RSP</a><br />
*p_le_set_host_chann_classif_rsp;  </td><td class="markdownTableBodyLeft">le_set_host_<br />
chann_classif   </td></tr>
</table>
</li>
</ol>
<p><br />
2. <a class="el" href="gap__conn__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_conn_le.h</a> Related Messages </p><div style="page-break-after: always;"></div> <center><div id="table_2_7"><b>Table 2-7 <a class="el" href="gap__conn__le_8h_source.html" title="This file contains all the constants and functions prototypes for GAP protocol. ">gap_conn_le.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
READ_RSSI  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html" title="Response for read rssi. ">T_LE_READ_RSSI_RSP</a><br />
*p_le_read_rssi_rsp  </td><td class="markdownTableBodyLeft">le_read_rssi   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
READ_CHANN_MAP  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___r_e_a_d___c_h_a_n_n___m_a_p___r_s_p.html" title="Response for read chanel map. ">T_LE_READ_CHANN_MAP_RSP</a><br />
*p_le_read_chann_map_rsp  </td><td class="markdownTableBodyLeft">le_read_chann_map   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DISABLE_SLAVE_LATENCY  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___d_i_s_a_b_l_e___s_l_a_v_e___l_a_t_e_n_c_y___r_s_p.html" title="Response for disable slave latency. ">T_LE_DISABLE_SLAVE_LATENCY_RSP</a><br />
*p_le_disable_slave_latency_rsp  </td><td class="markdownTableBodyLeft">le_disable_<br />
slave_latency   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
SET_DATA_LEN  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___s_e_t___d_a_t_a___l_e_n___r_s_p.html" title="Response for set data length, which is used for BT4.2 data length extension. ">T_LE_SET_DATA_LEN_RSP</a><br />
*p_le_set_data_len_rsp  </td><td class="markdownTableBodyLeft">le_set_data_len   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DATA_LEN_CHANGE_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html" title="Notification for data length change info, which is used for BT4.2 data length extension. ">T_LE_DATA_LEN_CHANGE_INFO</a><br />
*p_le_data_len_change_info  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
CONN_UPDATE_IND  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html" title="Indication for connection paramete update. ">T_LE_CONN_UPDATE_IND</a><br />
*p_le_conn_update_ind  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
UPDATE_PASSED_<br />
CHANN_MAP  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___u_p_d_a_t_e___p_a_s_s_e_d___c_h_a_n_n___m_a_p___r_s_p.html" title="Response for update passed channel map. ">T_LE_UPDATE_PASSED_CHANN_MAP_RSP</a><br />
*p_le_update_passed_chann_map_rsp  </td><td class="markdownTableBodyLeft">le_update_passed<br />
_chann_map   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
CREATE_CONN_IND  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html" title="Indication for connection paramete update. ">T_LE_CONN_UPDATE_IND</a><br />
*p_le_conn_update_ind  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
PHY_UPDATE_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___p_h_y___u_p_d_a_t_e___i_n_f_o.html" title="Notification information when phy changed. ">T_LE_PHY_UPDATE_INFO</a><br />
*p_le_phy_update_info  </td><td class="markdownTableBodyLeft">le_set_phy   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
REMOTE_FEATS_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html" title="Information for remote device features. ">T_LE_REMOTE_FEATS_INFO</a><br />
*p_le_remote_feats_info  </td><td class="markdownTableBodyLeft">NA   </td></tr>
</table>
<p><br />
GAP_MSG_LE_DATA_LEN_CHANGE_INFO <br />
 <br />
 This message notifies the Application of a change in either the maximum Payload length or the maximum transmission time of packets in any direction in Link Layer.<br />
 <br />
GAP_MSG_LE_CONN_UPDATE_IND <br />
 <br />
 This message is only used by central. When the remote Bluetooth device requests connection parameter update, GAP Layer will call this message. GAP Layer will check the return result, and App can return APP_RESULT_ACCEPT to accept the parameter or return APP_RESULT_REJECT to reject the parameter. <br />
 </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    ......</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga2d2b24b33dcecc6feb9598941dcf593a">GAP_MSG_LE_CONN_UPDATE_IND</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;GAP_MSG_LE_CONN_UPDATE_IND: conn_id %d, conn_interval_max 0x%x, conn_interval_min 0x%x, conn_latency 0x%x,supervision_timeout 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a6314eb8c5825b90229985ed248052631">conn_interval_max</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a129a79eddd12f561d6719759c83cbec6">conn_interval_min</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a1981f631548663fa86eb12cabcce2167">conn_latency</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#ab9a2dab79f1bab2d97d672571c060bbc">supervision_timeout</a>);</div><div class="line">        <span class="comment">/* if reject the proposed connection parameter from peer device, use APP_RESULT_REJECT. */</span></div><div class="line">        result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a301a48ddc8615894d01263a3858d4a90">APP_RESULT_ACCEPT</a>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p> <br />
GAP_MSG_LE_CREATE_CONN_IND <br />
 <br />
 This message is only used by peripheral. It is used by App to decide whether to establish a connection. When the remote central device initiates connection, GAP Layer doesn't send this message by default and accepts this connection. If App wants to open this function, it needs to set <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaa8edb10ccf33f7b6f75ca7d9a6b88bb3">GAP_PARAM_HANDLE_CREATE_CONN_IND</a> to true. <br />
 The sample codes are given below: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    uint8_t handle_conn_ind = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaa8edb10ccf33f7b6f75ca7d9a6b88bb3">GAP_PARAM_HANDLE_CREATE_CONN_IND</a>, <span class="keyword">sizeof</span>(handle_conn_ind), &amp;handle_conn_ind);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    ......</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga94586ed223a10f6d813b7d0527811602">GAP_MSG_LE_CREATE_CONN_IND</a>:</div><div class="line">        <span class="comment">/* if reject the connection from peer device, use APP_RESULT_REJECT. */</span></div><div class="line">        result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a301a48ddc8615894d01263a3858d4a90">APP_RESULT_ACCEPT</a>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p> When the remote central device initiates connection with local device, GAP Layer will call this message. GAP Layer will check the return result, and App can return APP_RESULT_ACCEPT to accept the connection or return APP_RESULT_REJECT to reject the connection. <br />
 <br />
GAP_MSG_LE_PHY_UPDATE_INFO <br />
 <br />
 This message is used to indicate that the Controller has changed the transmitter PHY or receiver PHY in use. <br />
 <br />
GAP_MSG_LE_REMOTE_FEATS_INFO <br />
 <br />
 This message is used to indicate the completion of the process of the Controller obtaining the features used on the connection and the features supported by the remote Bluetooth device. <br />
</p>
<p><br />
3. <a class="el" href="gap__bond__le_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_bond_le.h</a> Related Messages </p><div style="page-break-after: always;"></div> <center><div id="table_2_8"><b>Table 2-8 <a class="el" href="gap__bond__le_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_bond_le.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
BOND_MODIFY_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html" title="Structure for modify bonding information. ">T_LE_BOND_MODIFY_INFO</a><br />
*p_le_bond_modify_info;  </td><td class="markdownTableBodyLeft"></td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
KEYPRESS_NOTIFY  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___k_e_y_p_r_e_s_s___n_o_t_i_f_y___r_s_p.html" title="Structure for notify keypress result. ">T_LE_KEYPRESS_NOTIFY_RSP</a><br />
*p_le_keypress_notify_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga48d94ef96e639afe8badea7b1c7c9157">le_bond_keypress_notify</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
KEYPRESS_NOTIFY_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___k_e_y_p_r_e_s_s___n_o_t_i_f_y___i_n_f_o.html" title="Structure for notify keypress information. ">T_LE_KEYPRESS_NOTIFY_INFO</a><br />
*p_le_keypress_notify_info;  </td><td class="markdownTableBodyLeft"></td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
GATT_SIGNED_STATUS_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___g_a_t_t___s_i_g_n_e_d___s_t_a_t_u_s___i_n_f_o.html" title="Structure for LE signed information. ">T_LE_GATT_SIGNED_STATUS_INFO</a><br />
*p_le_gatt_signed_status_info;  </td><td class="markdownTableBodyLeft"></td></tr>
</table>
<p><br />
GAP_MSG_LE_KEYPRESS_NOTIFY_INFO <br />
 <br />
 This message is used to indicate that the SMP Layer has received the keypress notification. <br />
 <br />
GAP_MSG_LE_GATT_SIGNED_STATUS_INFO <br />
 <br />
 This is notification message type for LE signed status information. <br />
 <br />
GAP_MSG_LE_BOND_MODIFY_INFO <br />
 <br />
 This message is used to notify app that bond information has been modified. More information please refer to <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Information_Storage">2.6 GAP Information Storage</a>. <br />
</p>
<p><br />
4. <a class="el" href="gap__scan_8h_source.html" title="Head file for Gap Observer role. ">gap_scan.h</a> Related Messages </p><center><div id="table_2_9"><b>Table 2-9 <a class="el" href="gap__scan_8h_source.html" title="Head file for Gap Observer role. ">gap_scan.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
SCAN_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___s_c_a_n___i_n_f_o.html" title="Information of le scan information. ">T_LE_SCAN_INFO</a> *p_le_scan_info;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___observer___exported___functions.html#gaf132aa10672c3f34a0e6796152cbad73">le_scan_start</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DIRECT_ADV_INFO  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___d_i_r_e_c_t___a_d_v___i_n_f_o.html" title="Information of le direct advertising. ">T_LE_DIRECT_ADV_INFO</a> *p_le_direct_adv_info;  </td><td class="markdownTableBodyLeft"></td></tr>
</table>
<p><br />
GAP_MSG_LE_SCAN_INFO <br />
 <br />
 Scan state is GAP_SCAN_STATE_SCANNING. When BT stack receives advertising data and scans response data, GAP Layer will use this message to inform application. <br />
 <br />
GAP_MSG_LE_DIRECT_ADV_INFO <br />
 <br />
 Scan state is GAP_SCAN_STATE_SCANNING and Scan filter policy is GAP_SCAN_FILTER_ANY_RPA or GAP_SCAN_FILTER_WHITE_LIST_RPA. When BT stack receives directed advertising packets where the initiator's address is resolvable private address that cannot be resolved, GAP Layer will send this message to application. <br />
</p>
<p><br />
5. <a class="el" href="gap__adv_8h_source.html" title="Head file for Gap adv. ">gap_adv.h</a> Related Messages </p><center><div id="table_2_10"><b>Table 2-10 <a class="el" href="gap__adv_8h_source.html" title="Head file for Gap adv. ">gap_adv.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
ADV_UPDATE_PARAM  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___a_d_v___u_p_d_a_t_e___p_a_r_a_m___r_s_p.html" title="LE advertising paramter update result. ">T_LE_ADV_UPDATE_PARAM_RSP</a><br />
*p_le_adv_update_param_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___broadcaster___exported___functions.html#ga54576b0dc8d832f16947bb8ec7fc5e92">le_adv_update_param</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
ADV_READ_TX_POWER  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___a_d_v___r_e_a_d___t_x___p_o_w_e_r___r_s_p.html" title="Response of le read advertising transmitter power request. ">T_LE_ADV_READ_TX_POWER_RSP</a><br />
*p_le_adv_read_tx_power_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___broadcaster___exported___functions.html#ga708fdf908eccf8ebdbcdd6cbdf51c4e9">le_adv_read_tx_power</a>   </td></tr>
</table>
<p><br />
6. <a class="el" href="gap__dtm_8h_source.html">gap_dtm.h</a> Related Messages </p><center><div id="table_2_11"><b>Table 2-11 <a class="el" href="gap__dtm_8h_source.html">gap_dtm.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DTM_RECEIVER_TEST  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___d_t_m___exported___functions.html#ga3229a5dc426998810fb3ab9f54a5ad5e">le_dtm_receiver_test</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DTM_TRANSMITTER_TEST  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___d_t_m___exported___functions.html#gab422c6b8255c7245fa23ffc40d9bfa65">le_dtm_transmitter_test</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DTM_TEST_END  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___d_t_m___t_e_s_t___e_n_d___r_s_p.html" title="Response of le receiver test request. ">T_LE_DTM_TEST_END_RSP</a><br />
*p_le_dtm_test_end_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___d_t_m___exported___functions.html#ga349fc08f071eb32a556b1771dffb395e">le_dtm_test_end</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DTM_ENHANCED_<br />
RECEIVER_TEST  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___d_t_m___exported___functions.html#gab4b3a4cf5bb97e160318c97c9b475cac">le_dtm_enhanced_receiver_test</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
DTM_ENHANCED_<br />
TRANSMITTER_TEST  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___d_t_m___exported___functions.html#ga3c6177a5d756ad54bed2e39f9a20d424">le_dtm_enhanced_transmitter_test</a>   </td></tr>
</table>
<p><br />
7. GAP Lib Related Messages <br />
 <br />
 GAP Lib provides extended functionalities. <br />
 <br />
 <b><a class="el" href="gap__ext__scan_8h_source.html" title="Header file for Gap ext scan. ">gap_ext_scan.h</a> Related Messages</b> <br />
 </p><center><div id="table_2_12"><b>Table 2-12 <a class="el" href="gap__ext__scan_8h_source.html" title="Header file for Gap ext scan. ">gap_ext_scan.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type<br />
(cb_type)  </th><th class="markdownTableHeadLeft">Callback data<br />
(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_REPORT_INFO  </td><td class="markdownTableBodyLeft">T_LE_EXT_ADV_REPORT_INFO*<br />
p_le_ext_adv_report_info;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#ga1ce7a95160849ea71b74ef51a8856847">le_ext_scan_start</a>   </td></tr>
</table>
<p>GAP_MSG_LE_EXT_ADV_REPORT_INFO <br />
 <br />
 Using LE Advertising Extensions, scan state is GAP_SCAN_STATE_SCANNING. When Bluetooth Technology stack receives advertising data or scan response data, GAP Layer will use this message to inform application. <br />
 <br />
 <b><a class="el" href="gap__ext__adv_8h_source.html" title="Header file for Gap ext adv. ">gap_ext_adv.h</a> Related Messages</b> <br />
 </p><div style="page-break-after: always;"></div> <center><div id="table_2_13"><b>Table 2-13 <a class="el" href="gap__ext__adv_8h_source.html" title="Header file for Gap ext adv. ">gap_ext_adv.h</a> Related Messages </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Callback type(cb_type)  </th><th class="markdownTableHeadLeft">Callback data(p_cb_data)  </th><th class="markdownTableHeadLeft">Reference API   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_START_SETTING  </td><td class="markdownTableBodyLeft">T_LE_EXT_ADV_START_SETTING_RSP*<br />
p_le_ext_adv_start_setting_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga3d54b134c35a3ad6290ca04954e29b2c">le_ext_adv_start_setting</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_REMOVE_SET  </td><td class="markdownTableBodyLeft">T_LE_EXT_ADV_REMOVE_SET_RSP*<br />
p_le_ext_adv_remove_set_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga7a15faab15a7d17360212daa2f61ae6e">le_ext_adv_remove_set</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_CLEAR_SET  </td><td class="markdownTableBodyLeft">T_LE_EXT_ADV_CLEAR_SET_RSP*<br />
p_le_ext_adv_clear_et_rsp;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#gac2129c593f97738ad05169309f729530">le_ext_adv_clear_set</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_ENABLE  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#gaf66fd3a592e2638bdd56a5c61857933c">le_ext_adv_enable</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP_MSG_LE_<br />
EXT_ADV_DISABLE  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___l_e___c_a_u_s_e.html">T_LE_CAUSE</a> le_cause;  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga017b1326b3e42dda27721eab484d4cc2">le_ext_adv_disable</a>   </td></tr>
</table>
<p><br />
 GAP_MSG_LE_EXT_ADV_START_SETTING <br />
 <br />
 This message is used to indicate the completion of the process that local device sets extended advertising related parameters for an advertising set. <br />
 <br />
 GAP_MSG_LE_EXT_ADV_REMOVE_SET<br />
 <br />
 This message is used to indicate the completion of the process that local device removes an advertising set. <br />
 <br />
 GAP_MSG_LE_EXT_ADV_CLEAR_SET<br />
 <br />
 This message is used to indicate the completion of the process that local device removes all existing advertising sets. <br />
 <br />
 GAP_MSG_LE_EXT_ADV_ENABLE<br />
 <br />
 This message is used to indicate the completion of the process that local device enables extended advertising for one or more advertising sets. <br />
 <br />
 GAP_MSG_LE_EXT_ADV_DISABLE<br />
 <br />
 This message is used to indicate the completion of the process that local device disables extended advertising for one or more advertising sets. <br />
 <br />
 GAP_MSG_LE_SCAN_REQ_RECEIVED_INFO<br />
 <br />
 Extended advertising state is EXT_ADV_STATE_ADVERTISING, and scan request notifications is enabled by calling <a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga212bd4ecbf31844ad9647a023f41574d" title="Set GAP extended advertising parameters for an advertising set. ">le_ext_adv_set_adv_param()</a>. When Bluetooth Technology stack receives scan request, GAP Layer will use this message to inform application. <br />
</p>
<h3><a class="anchor" id="Bluetooth_LE_GAP_Use_Case"></a>
2.5 Bluetooth LE GAP Use Case</h3>
<p>The purpose of this chapter is to give an overview of how to use LE GAP interfaces. This document is to give some of typical use cases such as Airplane Mode Setting, Local IRK Setting, Static Random Address set, PHY Setting etc.<br />
</p>
<h4><a class="anchor" id="Airplane_Mode_Setting"></a>
2.5.1 Airplane Mode Setting</h4>
<p>The sample code is located in <b>BLE scatternet project</b>. <br />
</p><ol type="1">
<li><b>Register GAP Common Callback</b> <br />
 <br />
 APP needs to call gap_register_app_cb to register callback function. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9afcebae2c58617ed03c21918ca7a442">gap_register_app_cb</a>(app_gap_common_callback);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>GAP Common Callback Handler</b> <br />
 <br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_gap_common_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___g_a_p___c_b___d_a_t_a.html">T_GAP_CB_DATA</a> cb_data;</div><div class="line">    memcpy(&amp;cb_data, p_cb_data, <span class="keyword">sizeof</span>(<a class="code" href="union_t___g_a_p___c_b___d_a_t_a.html">T_GAP_CB_DATA</a>));</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_gap_common_callback: cb_type = %d&quot;</span>, cb_type);</div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___c_o_m_m_o_n___m_s_g___t_y_p_e.html#ga1c21c101ef6695b547ce011978970460">GAP_MSG_WRITE_AIRPLAN_MODE</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_WRITE_AIRPLAN_MODE: cause 0x%x&quot;</span>,</div><div class="line">                        cb_data.<a class="code" href="union_t___g_a_p___c_b___d_a_t_a.html#aeeb32e9cdc04ea9efbbd77a63b91e195">p_gap_write_airplan_mode_rsp</a>-&gt;<a class="code" href="struct_t___g_a_p___w_r_i_t_e___a_i_r_p_l_a_n___m_o_d_e___r_s_p.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___c_o_m_m_o_n___m_s_g___t_y_p_e.html#gaf4d8ea75e94eee599f71d8cc1ac5eaaa">GAP_MSG_READ_AIRPLAN_MODE</a>:</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
 This callback function is used to handle message <a class="el" href="group___g_a_p___c_o_m_m_o_n___m_s_g___t_y_p_e.html#ga1c21c101ef6695b547ce011978970460">GAP_MSG_WRITE_AIRPLAN_MODE</a> and <a class="el" href="group___g_a_p___c_o_m_m_o_n___m_s_g___t_y_p_e.html#gaf4d8ea75e94eee599f71d8cc1ac5eaaa">GAP_MSG_READ_AIRPLAN_MODE</a>.<br />
 <br />
</li>
<li><b>Related APIs</b> <br />
 <br />
 <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gaa97cd1293511c913574fc16ab3846ced">gap_write_airplan_mode()</a> function is used to write airplan mode. <br />
 <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga97e20b8ce82c33400d378dfb4802ce0a">gap_read_airplan_mode()</a> function is used to read airplan mode. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_wairplane(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line">    uint8_t mode = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    cause = <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gaa97cd1293511c913574fc16ab3846ced">gap_write_airplan_mode</a>(mode);</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_rairplane(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line">    cause = <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga97e20b8ce82c33400d378dfb4802ce0a">gap_read_airplan_mode</a>();</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="Local_IRK_Setting"></a>
2.5.2 Local IRK Setting</h4>
<p>Identity Resolving Key (IRK) is a 128-bit key used to generate and resolve random addresses. <br />
 GAP layer provides two methods to set Local IRK.<br />
</p>
<ol type="1">
<li><b>Auto generate local IRK</b> <br />
 <br />
 If App wants to open this function, it needs to set <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a7d04b9c55fee77335aefca0382a3b626">GAP_PARAM_BOND_GEN_LOCAL_IRK_AUTO</a> to true. <br />
 When the GAP layer starts up, GAP layer will call <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3959368b59ec2269d1ba42c07a6c9456">flash_load_local_irk()</a> to load local IRK. If GAP layer fails to load local IRK, GAP layer will automatically generate local IRK and call <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gac7363d0591a839679368804978437ca7">flash_save_local_irk()</a> to save local IRK. So when this function is opened, APP can't use <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3959368b59ec2269d1ba42c07a6c9456" title="Load local IRK from flash. ">flash_load_local_irk()</a> and <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gac7363d0591a839679368804978437ca7" title="Save local IRK to flash. ">flash_save_local_irk()</a>. <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    uint8_t irk_auto = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a7d04b9c55fee77335aefca0382a3b626">GAP_PARAM_BOND_GEN_LOCAL_IRK_AUTO</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;irk_auto);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>APP generates local IRK</b> <br />
 <br />
 GAP layer uses this method by default. Default local IRK is all zero. APP can call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param()</a> to set <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a6f8f3f86524ea06894173ac8b722fb9b">GAP_PARAM_BOND_SET_LOCAL_IRK</a> to change local IRK. <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t___l_o_c_a_l___i_r_k.html">T_LOCAL_IRK</a> le_local_irk = {0, 1, 0, 5, 0, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 9};</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a6f8f3f86524ea06894173ac8b722fb9b">GAP_PARAM_BOND_SET_LOCAL_IRK</a>, <a class="code" href="group___g_a_p___common___macros.html#gafcd7b4ce2e2d0ab0478f76a93fa97a62">GAP_KEY_LEN</a>, le_local_irk.<a class="code" href="struct_t___l_o_c_a_l___i_r_k.html#a2208a4fedd99aeff47419d4967f7e2b6">local_irk</a>);</div><div class="line">}</div></div><!-- fragment --> This parameter is effective in the GAP layer startup process. So APP needs to set <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a6f8f3f86524ea06894173ac8b722fb9b">GAP_PARAM_BOND_SET_LOCAL_IRK</a> before calling <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga337f0e91aaa1af727c165620e64d91af">gap_start_bt_stack()</a>. <br />
 APP can generate local IRK by itself and use <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gac7363d0591a839679368804978437ca7">flash_save_local_irk()</a> to save. Then APP can use <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3959368b59ec2269d1ba42c07a6c9456">flash_load_local_irk()</a> to load local IRK and set <a class="el" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a6f8f3f86524ea06894173ac8b722fb9b">GAP_PARAM_BOND_SET_LOCAL_IRK</a> to change local IRK.</li>
</ol>
<h4><a class="anchor" id="GAP_Service_Characteristic_Writeable"></a>
2.5.3 GAP Service Characteristic Writeable</h4>
<p>The sample code is located in <b>BLE scatternet project</b>.</p>
<p>Device name characteristic and appearance characteristic of GAP service have a optional writable property. The writable property is closed by default. APP can call <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a> to set <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fbaf54e0d607e3238d446c85ea5f844af5c">GAPS_PARAM_APPEARANCE_PROPERTY</a> and <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fba5aa51fed2c85fc4c0fcd496967039450">GAPS_PARAM_DEVICE_NAME_PROPERTY</a> to config writeable property.</p>
<ol type="1">
<li><b>Writeable Property Configuration</b> <br />
 <br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t appearance_prop = <a class="code" href="group___g_a_p_s___write___p_r_o_p_e_r_t_y.html#gade3d8f5c2191e7ac51e3bda3cf225c2e">GAPS_PROPERTY_WRITE_ENABLE</a>;</div><div class="line">    uint8_t device_name_prop = <a class="code" href="group___g_a_p_s___write___p_r_o_p_e_r_t_y.html#gade3d8f5c2191e7ac51e3bda3cf225c2e">GAPS_PROPERTY_WRITE_ENABLE</a>;</div><div class="line">    <a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html">T_LOCAL_APPEARANCE</a> appearance_local;</div><div class="line">    <a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html">T_LOCAL_NAME</a> local_device_name;</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga0787406d86e51be9e599c6d6c527173d">flash_load_local_appearance</a>(&amp;appearance_local) == 0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fba3849419000f384d71d10c6224fd19ef1">GAPS_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(uint16_t), &amp;appearance_local.<a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html#a2be33a131837b177c6392baedb555220">local_appearance</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaf0269765d3bdf4549141d649b959077f">flash_load_local_name</a>(&amp;local_device_name) == 0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fbac498fa7c44e396f7bd483fe40e290daa">GAPS_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, local_device_name.<a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html#ae7e6461cedc48b63f0cb62bba5c76b2c">local_name</a>);</div><div class="line"></div><div class="line">    }</div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fbaf54e0d607e3238d446c85ea5f844af5c">GAPS_PARAM_APPEARANCE_PROPERTY</a>, <span class="keyword">sizeof</span>(appearance_prop), &amp;appearance_prop);</div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fba5aa51fed2c85fc4c0fcd496967039450">GAPS_PARAM_DEVICE_NAME_PROPERTY</a>, <span class="keyword">sizeof</span>(device_name_prop), &amp;device_name_prop);</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gadeefecf776f21919de999f1f9ce546d1">gatt_register_callback</a>(gap_service_callback);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>GAP Service Callback Handler</b> <br />
 <br />
 APP needs to use <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gadeefecf776f21919de999f1f9ce546d1">gatt_register_callback</a> to register callback function.<br />
 This callback function is used to handle gap service messages.<br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> gap_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_para)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_GAPS_CALLBACK_DATA</a> *p_gap_data = (<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_GAPS_CALLBACK_DATA</a> *)p_para;</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;gap_service_callback conn_id = %d msg_type = %d\n&quot;</span>, p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                    p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>);</div><div class="line">    <span class="keywordflow">if</span> (p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a> == <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7af703b5b6b80a4d6ce89f9e7e46163199">SERVICE_CALLBACK_TYPE_WRITE_CHAR_VALUE</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">switch</span> (p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ae955d56b058f65fa91af53556f880dff">msg_data</a>.<a class="code" href="struct_t___g_a_p_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a5c1b56e6bccc2a95dbddf1a08e56e87d">opcode</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___w_r_i_t_e___t_y_p_e.html#gaf21994c809b5d2b6d3059a7ef66b5a58">GAPS_WRITE_DEVICE_NAME</a>:</div><div class="line">            {</div><div class="line">                <a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html">T_LOCAL_NAME</a> device_name;</div><div class="line">                memcpy(device_name.<a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html#ae7e6461cedc48b63f0cb62bba5c76b2c">local_name</a>, p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ae955d56b058f65fa91af53556f880dff">msg_data</a>.<a class="code" href="struct_t___g_a_p_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a7e38674b09ada3bb654e2c2146044d30">p_value</a>, p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ae955d56b058f65fa91af53556f880dff">msg_data</a>.<a class="code" href="struct_t___g_a_p_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a8aed22e2c7b283705ec82e0120515618">len</a>);</div><div class="line">                device_name.<a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html#ae7e6461cedc48b63f0cb62bba5c76b2c">local_name</a>[p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ae955d56b058f65fa91af53556f880dff">msg_data</a>.<a class="code" href="struct_t___g_a_p_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a8aed22e2c7b283705ec82e0120515618">len</a>] = 0;</div><div class="line">                <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga8a555625abc7ac124ee9649f25d51088">flash_save_local_name</a>(&amp;device_name);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___w_r_i_t_e___t_y_p_e.html#gab24d1764f90d7eef9b8c9efc27c84d8c">GAPS_WRITE_APPEARANCE</a>:</div><div class="line">            {</div><div class="line">                uint16_t appearance_val;</div><div class="line">                <a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html">T_LOCAL_APPEARANCE</a> appearance;</div><div class="line">                <a class="code" href="group___b_t___t_y_p_e_s.html#ga73e8b73b296cf9a3914c60e4747e66c1">LE_ARRAY_TO_UINT16</a>(appearance_val, p_gap_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ae955d56b058f65fa91af53556f880dff">msg_data</a>.<a class="code" href="struct_t___g_a_p_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a7e38674b09ada3bb654e2c2146044d30">p_value</a>);</div><div class="line">                appearance.<a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html#a2be33a131837b177c6392baedb555220">local_appearance</a> = appearance_val;</div><div class="line">                <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaec89f7c962fc7f3044cee9792594edb8">flash_save_local_appearance</a>(&amp;appearance);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --> APP needs to save device name and appearance to FTL. Please refer to GAPStorage_Stack.</li>
</ol>
<h4><a class="anchor" id="set_Local_Static_Random_Address"></a>
2.5.4 set Local Static Random Address</h4>
<p>The sample code is located in <b>BLE scatternet project</b>. Local address type that is used in advertising, scanning and connection is Public Address by default, and local address type could be configured as Static Random Address.</p>
<ol type="1">
<li><b>Set local address type</b> <br />
 <br />
 APP can configure local address type to use Static Random Address.<br />
 Sample codes are listed as below:<br />
 <br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98ab751d2722a1890be60daf72ca879555a">GAP_LOCAL_ADDR_LE_RANDOM</a>;</div></div><!-- fragment --> <br />
</li>
<li><b>Generation, storage and configuration of Random Address</b> <br />
 <br />
 APP may call <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga7a160b17460c4697f6f3289293e602fd">le_gen_rand_addr()</a> to generate random address for the first time, and save generated random address to Flash. If random address has been saved in Flash, APP gets random address by loading from storage. Then APP calls <a class="el" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params()</a> to set random address and other advertising parameters. It is valid only when APP called <a class="el" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params()</a> before stack ready.<br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_LE_USE_STATIC_RANDOM_ADDR</span></div><div class="line">    app_adv_init_conn_random();</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    app_adv_init_conn_public();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_adv_init_conn_random(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98ab751d2722a1890be60daf72ca879555a">GAP_LOCAL_ADDR_LE_RANDOM</a>;</div><div class="line">    <span class="keywordtype">bool</span> gen_addr = <span class="keyword">true</span>;</div><div class="line">    T_APP_STATIC_RANDOM_ADDR random_addr;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_adv_load_static_random_address(&amp;random_addr) == 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> ((random_addr.is_exist == <span class="keyword">true</span>) &amp;&amp; ((random_addr.bd_addr[5] &amp; 0xC0) == 0xC0))</div><div class="line">        {</div><div class="line">            gen_addr = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gen_addr)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga7a160b17460c4697f6f3289293e602fd">le_gen_rand_addr</a>(<a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga22a2d99be7d398d8316d16992be41c6eacd5a63fcc32c1c3d6f77d28431abfe70">GAP_RAND_ADDR_STATIC</a>, random_addr.bd_addr) == <a class="code" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>)</div><div class="line">        {</div><div class="line">            random_addr.is_exist = <span class="keyword">true</span>;</div><div class="line">            app_adv_save_static_random_address(&amp;random_addr);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                    adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                    filter_policy, <span class="keyword">sizeof</span>(adv_data), adv_data,</div><div class="line">                                    <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>), <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, random_addr.bd_addr);</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="Phy_Setting"></a>
2.5.5 Physical (PHY) Setting</h4>
<p>The sample code is located in <b>BLE scatternet project</b>. BLE have three types of PHY:</p><ul>
<li><b>LE 1M PHY</b><br />
 LE mandatory symbol rate is 1 megasymbol per second (Msym/s), where 1 symbol represents 1 bit. Therefore supporting a bit rate of 1 megabit per second (Mb/s) is referred to as the <b>LE 1M PHY</b>.</li>
<li><b>LE Coded PHY</b><br />
 The 1 Msym/s symbol rate may optionally support error correction coding, which is referred to as the <b>LE Coded PHY</b>. This may use either of two coding schemes: S=2, where 2 symbols represent 1 bit therefore supporting a bit rate of 500 kb/s, and S=8, where 8 symbols represent 1 bit therefore supporting a bit rate of 125 kb/s.</li>
<li><b>LE 2M PHY</b><br />
 An optional symbol rate of 2 Msym/s may be supported, with a bit rate of 2 Mb/s, which is referred to as the <b>LE 2M PHY</b>. The 2 Msym/s symbol rate supports uncoded data only.</li>
</ul>
<ol type="1">
<li><b>Set Default PHY</b> <br />
 <br />
 APP can specify its preferred values for the transmitter PHY and receiver PHY to be used for all subsequent connections over the LE transport. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t  phys_prefer = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gafb9a26e72087dfebc5a3c7e453039d65">GAP_PHYS_PREFER_ALL</a>;</div><div class="line">    uint8_t  tx_phys_prefer = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a> | <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a> |</div><div class="line">                              <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaabab2dd6adaf073deb92af970b404b7e">GAP_PHYS_PREFER_CODED_BIT</a>;</div><div class="line">    uint8_t  rx_phys_prefer = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a> | <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a> |</div><div class="line">                              <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaabab2dd6adaf073deb92af970b404b7e">GAP_PHYS_PREFER_CODED_BIT</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1b6bd46140c4e94e8ae79c9a23f281e6">GAP_PARAM_DEFAULT_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(phys_prefer), &amp;phys_prefer);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaa183de337bb7d026d5484d6944556990">GAP_PARAM_DEFAULT_TX_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(tx_phys_prefer), &amp;tx_phys_prefer);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eacd2c2351754a7a6972fb319f9e356ee3">GAP_PARAM_DEFAULT_RX_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(rx_phys_prefer), &amp;rx_phys_prefer);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Read connection PHY type</b> <br />
 <br />
 After the connection is successful, APP can call <a class="el" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param()</a> to get TX PHY and RX PHY type. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state, uint16_t disc_cause)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___macros.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">            ......</div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Connected success conn_id %d\r\n&quot;</span>, conn_id);</div><div class="line"><span class="preprocessor">#if F_BT_LE_5_0_SET_PHY_SUPPORT</span></div><div class="line">            {</div><div class="line">                uint8_t tx_phy;</div><div class="line">                uint8_t rx_phy;</div><div class="line">                <a class="code" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558ae6d66a109761e0a62b061dc955ab2e38">GAP_PARAM_CONN_RX_PHY_TYPE</a>, &amp;rx_phy, conn_id);</div><div class="line">                <a class="code" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558a3d74995cdc144af6e961c9298cfa1b6d">GAP_PARAM_CONN_TX_PHY_TYPE</a>, &amp;tx_phy, conn_id);</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;GAP_CONN_STATE_CONNECTED: tx_phy %d, rx_phy %d&quot;</span>, tx_phy, rx_phy);</div><div class="line">            }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></li>
<li><b>Remote Features Info Check</b> <br />
 <br />
 After the successful connection is established, BT stack will read remote features. GAP Layer will send GAP_MSG_LE_REMOTE_FEATS_INFO to inform remote features. APP can check whether remote device supports 2M or CODED PHY. <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line"><span class="preprocessor">#if F_BT_LE_5_0_SET_PHY_SUPPORT</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga4827bcd4905852561061dd87720c9d0d">GAP_MSG_LE_REMOTE_FEATS_INFO</a>:</div><div class="line">        {</div><div class="line">            uint8_t  remote_feats[8];</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;GAP_MSG_LE_REMOTE_FEATS_INFO: conn id %d, cause 0x%x, remote_feats %b&quot;</span>,</div><div class="line">                            p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a2bdf37e91e4b846095c2eeeeb5fffa10">p_le_remote_feats_info</a>-&gt;<a class="code" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                            p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a2bdf37e91e4b846095c2eeeeb5fffa10">p_le_remote_feats_info</a>-&gt;<a class="code" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>,</div><div class="line">                            <a class="code" href="group___t_r_a_c_e.html#ga03cf46dce6a4203e1317aaa89f6875d5">TRACE_BINARY</a>(8, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a2bdf37e91e4b846095c2eeeeb5fffa10">p_le_remote_feats_info</a>-&gt;<a class="code" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html#a5e18ec5972bb070b3a5f5579eb3b89b0">remote_feats</a>));</div><div class="line">            <span class="keywordflow">if</span> (p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a2bdf37e91e4b846095c2eeeeb5fffa10">p_le_remote_feats_info</a>-&gt;<a class="code" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a> == <a class="code" href="group___b_t___t_y_p_e_s.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line">                memcpy(remote_feats, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a2bdf37e91e4b846095c2eeeeb5fffa10">p_le_remote_feats_info</a>-&gt;<a class="code" href="struct_t___l_e___r_e_m_o_t_e___f_e_a_t_s___i_n_f_o.html#a5e18ec5972bb070b3a5f5579eb3b89b0">remote_feats</a>, 8);</div><div class="line">                <span class="keywordflow">if</span> (remote_feats[<a class="code" href="group___b_t___t_y_p_e_s.html#ga7c6d92cf8fae3a4408e068e8a08f0df1">LE_SUPPORT_FEATURES_MASK_ARRAY_INDEX1</a>] &amp; <a class="code" href="group___b_t___t_y_p_e_s.html#ga8ae91e09131aafb641bb296d353be13f">LE_SUPPORT_FEATURES_LE_2M_MASK_BIT</a>)</div><div class="line">                {</div><div class="line">                    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP_MSG_LE_REMOTE_FEATS_INFO: support 2M&quot;</span>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">if</span> (remote_feats[<a class="code" href="group___b_t___t_y_p_e_s.html#ga7c6d92cf8fae3a4408e068e8a08f0df1">LE_SUPPORT_FEATURES_MASK_ARRAY_INDEX1</a>] &amp; <a class="code" href="group___b_t___t_y_p_e_s.html#ga36fc6c9dcb5e2e3192434a626aa36d35">LE_SUPPORT_FEATURES_LE_CODED_PHY_MASK_BIT</a>)</div><div class="line">                {</div><div class="line">                    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP_MSG_LE_REMOTE_FEATS_INFO: support CODED&quot;</span>);</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></li>
<li><b>Set PHY</b> <br />
 <br />
 <a class="el" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gab098b1132273017baf0e010f259aeda1">le_set_phy()</a> is used to set the PHY preferences for the connection identified. The Controller may not be able to make the change (e.g. because the peer does not support the requested PHY) or it may decide that the current PHY is preferable. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_setphy(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    uint8_t conn_id = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    uint8_t all_phys;</div><div class="line">    uint8_t tx_phys;</div><div class="line">    uint8_t rx_phys;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga8f1c32cd9fe124cb2f083d5b6ef86bf4">T_GAP_PHYS_OPTIONS</a> phy_options = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga8f1c32cd9fe124cb2f083d5b6ef86bf4ad962f9c13e7c6e6af8dd6e137dd1795e">GAP_PHYS_OPTIONS_CODED_PREFER_S8</a>;</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[1] == 0)</div><div class="line">    {</div><div class="line">        all_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gafb9a26e72087dfebc5a3c7e453039d65">GAP_PHYS_PREFER_ALL</a>;</div><div class="line">        tx_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a>;</div><div class="line">        rx_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[1] == 1)</div><div class="line">    {</div><div class="line">        all_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gafb9a26e72087dfebc5a3c7e453039d65">GAP_PHYS_PREFER_ALL</a>;</div><div class="line">        tx_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a>;</div><div class="line">        rx_phys = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___macros.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a>;</div><div class="line">    }</div><div class="line">    ......</div><div class="line">    cause = <a class="code" href="group___g_a_p___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gab098b1132273017baf0e010f259aeda1">le_set_phy</a>(conn_id, all_phys, tx_phys, rx_phys, phy_options);</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div></div><!-- fragment --></li>
<li><b>PHY Update</b> <br />
 <br />
 <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga8513d4d00cf8368b5ab0e6f8d96be9c2">GAP_MSG_LE_PHY_UPDATE_INFO</a> is used to indicate that the Controller has changed the transmitter PHY or receiver PHY in use. <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line"><span class="preprocessor">#if F_BT_LE_5_0_SET_PHY_SUPPORT</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga8513d4d00cf8368b5ab0e6f8d96be9c2">GAP_MSG_LE_PHY_UPDATE_INFO</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;GAP_MSG_LE_PHY_UPDATE_INFO:conn_id %d, cause 0x%x, rx_phy %d, tx_phy %d&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a825ec3d740b2453765e5993a483fce5b">p_le_phy_update_info</a>-&gt;<a class="code" href="struct_t___l_e___p_h_y___u_p_d_a_t_e___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a825ec3d740b2453765e5993a483fce5b">p_le_phy_update_info</a>-&gt;<a class="code" href="struct_t___l_e___p_h_y___u_p_d_a_t_e___i_n_f_o.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a825ec3d740b2453765e5993a483fce5b">p_le_phy_update_info</a>-&gt;<a class="code" href="struct_t___l_e___p_h_y___u_p_d_a_t_e___i_n_f_o.html#ae3afc505396293ea9ea5328b42363ce7">rx_phy</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a825ec3d740b2453765e5993a483fce5b">p_le_phy_update_info</a>-&gt;<a class="code" href="struct_t___l_e___p_h_y___u_p_d_a_t_e___i_n_f_o.html#aa9098961ece4021ff4d5cd3859b3f817">tx_phy</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="Bluetooth_Technology_Stack_Features_Setting"></a>
2.5.6 Bluetooth Technology Stack Features Setting</h4>
<p>Figure 2-9 config LE link number is 2, LE master link is 1, LE slave link number is 1, LE bond device number is 4. </p><div class="image">
<img src="ble_stack_cfgtool.png" alt="ble_stack_cfgtool.png"/>
</div>
 <center><div id="figure_2_9"><b>Figure 2-9 Bluetooth Technology Stack Features Setting in Mcu Cfg Tool </b></div></center><ol type="1">
<li>Configuration of LE Link number <br />
 <br />
 Due to support of multi link and requirements of APP, user can use mcu cfg tool to configure LE Link number. This section takes BLE scatternet project as an example to introduce configuration of LE Link number. Based on the assumption that BLE scatternet project supports one link as master role and one link as slave role at the same time, therefore:<br />
<ul>
<li>LE Link number shall be no less than 2<br />
</li>
<li>LE master Link number shall be no less than 1<br />
</li>
<li>LE slave Link number shall be no less than 1<br />
<br />
</li>
</ul>
</li>
<li>Configure LE maximum bonded device number <br />
 <br />
 Due to support of multilink, device needs to save bonding informations of multiple peer devices. BLE scatternet project can use mcu cfg tool to configure LE maximum bonded device number.<br />
<br />
</li>
<li>Initialize LE Link number in APP <br />
 <br />
 As described in GAP Startup Flow, APP calls <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd" title="Initialize parameters of GAP. ">le_gap_init()</a> to initialize GAP and set link number. Link number configured by <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd" title="Initialize parameters of GAP. ">le_gap_init()</a> shall be less than or equal to LE Link Number configured by MCU cfg tool. <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">   ......</div><div class="line">    <span class="comment">/*Initialize ble link*/</span></div><div class="line">    uint8_t supported_max_le_link_num = <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga13f6449e757dab08b87c3f08a855d1a5">le_get_max_link_num</a>();</div><div class="line">    uint8_t link_num = ((<a class="code" href="group___a_p_p___l_i_n_k.html#ga9875ca18a9c76318637e0df3774093ed">MAX_BLE_LINK_NUM</a> &lt;= supported_max_le_link_num) ? <a class="code" href="group___a_p_p___l_i_n_k.html#ga9875ca18a9c76318637e0df3774093ed">MAX_BLE_LINK_NUM</a> :</div><div class="line">                        supported_max_le_link_num);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(link_num);</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="Request_Pairing"></a>
2.5.7 Request Pairing</h4>
<p>iOS system does not supply interface to initiate security procedure. If the slave device wants to pair with iOS device, the slave device need request pairing.</p>
<p>There are two ways to initiate security procedure, and one way that local device with GATT Server could request iOS device to initiate security procedure.</p>
<ol type="1">
<li><b>Configure GAP_PARAM_BOND_SEC_REQ_ENABLE</b> <br />
 <br />
 Parameter GAP_PARAM_BOND_SEC_REQ_ENABLE determines whether to initiate security procedure when connection is established. If the parameter is configured as true, the GAP layer will automatically initiate security procedure when connection is established. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">true</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a> | <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga8c6188c207f5f749b0733453f7bf9ee0">GAP_AUTHEN_BIT_SC_FLAG</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),&amp;auth_sec_req_flags);</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Call function le_bond_pair</b> <br />
 <br />
 Application can call <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga3ef0dc8beeb331ee2fc3c942118dc287" title="Start authentication the link. ">le_bond_pair()</a> to initiate security procedure. The function can only be called when LE link state is GAP_CONN_STATE_CONNECTED. <br />
<br />
</li>
<li><b>Security Requirement of Service</b> <br />
 <br />
 The GATT Profile procedures are used to access information that may require the client to be authenticated and have an encrypted connection before a characteristic can be read or written. If such a request is issued when the physical link is unauthenticated or unencrypted, the server shall send an Error Response. The client wanting to read or write this characteristic can then request that the physical link be authenticated using the GAP authentication procedure, and once this has been completed, send the request again. When iOS system receives the unauthenticated or unencrypted error reponse, iOS system will initiate security procedure. <br />
 Attribute element is elementary unit of service. The structure of attribute element is defined in <a class="el" href="gatt_8h_source.html">gatt.h</a>.</li>
</ol>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint16_t    flags;              </div><div class="line">    uint8_t     type_value[2 + 14]; </div><div class="line">    uint16_t    value_len;          </div><div class="line">    <span class="keywordtype">void</span>        *p_value_context;   </div><div class="line">    uint32_t    permissions;        </div><div class="line">} <a class="code" href="struct_t___a_t_t_r_i_b___a_p_p_l.html">T_ATTRIB_APPL</a>;</div></div><!-- fragment --><p>The sample code about authentication requirement of characteristic is as follows. This characteristic requires an authenticated link before this characteristic can be read and write. </p><div class="fragment"><div class="line"><span class="comment">/* client characteristic configuration */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad635d8a11455092a560c22eecb2953a6">ATTRIB_FLAG_CCCD_APPL</a>,                   <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <span class="comment">/* NOTE: this value has an instantiation for each client */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>), <span class="comment">/* client char. config. bit field */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>)</div><div class="line">        },</div><div class="line">        2,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4c77e25cace082931491c9d1cef5462f">GATT_PERM_READ_AUTHEN_REQ</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga381d748f8cada97b47b8d278e3bb0734">GATT_PERM_WRITE_AUTHEN_REQ</a>)          <span class="comment">/* permissions */</span></div><div class="line">    },</div></div><!-- fragment --><h3><a class="anchor" id="GAP_Information_Storage"></a>
2.6 GAP Information Storage</h3>
<p>The purpose of this chapter is to give an overview of <b>GAP Storage</b>. The constants and functions prototype are defined in <a class="el" href="gap__storage__le_8h_source.html" title="key storage function. ">gap_storage_le.h</a>. Local stack and bond information such as device name, device appearance, IRK, LTK, CSRK etc. should be persisted on the device and cannot be lost after power off. So we store these informations into FTL. Local stack and bond information FTL layout is shown in Figure 2-10. </p><div class="image">
<img src="ble_ftl_layout.jpg" alt="ble_ftl_layout.jpg"/>
</div>
 <center><div id="figure_2_10"><b>Figure 2-10 LE FTL Layout </b></div></center><p> <b>Note:</b> FTL offset <b>0x0000 to 0x0C00</b> are used by the bluetooth stack, <b>and the APP cannot occupy.</b><br />
 LE key storage space can be divided into two regions:<br />
</p><ul>
<li>LE bond priority manager module: LE priority control block. GAPStorage_Priority<br />
</li>
<li>LE bonded device keys storage module:<ul>
<li>LE REMOTE BD: Save remote device address<br />
</li>
<li>LE LOCAL LTK: Save local LTK<br />
</li>
<li>LE REMOTE LTK: Save remote LTK<br />
</li>
<li>LE REMOTE IRK: Save remote IRK<br />
</li>
<li>LE LOCAL CSRK: Save local CSRK<br />
</li>
<li>LE REMOTE CSRK: Save remote CSRK<br />
</li>
<li>LE CCCD DATA: Save CCCD data<br />
</li>
</ul>
</li>
</ul>
<p>The reason for save CCCD data is that after bonded some phone will not write CCCD again. <br />
GATT service table will not be saved here, if APP wants to save GATT service table, APP can refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Central_Application">5 BLE Central Application</a> and saved it by themself.</p>
<h4><a class="anchor" id="FTL_Introduction"></a>
2.6.1 FTL Introduction</h4>
<p>Bluetooth Technology stack and user application use FTL as abstraction layer to save/load data in flash. More information on FTL can be found in <a class="el" href="_u_m007__f_l_a_s_h.html#FLASH">Flash User Guide </a>.</p>
<h4><a class="anchor" id="Local_Stack_Information_Storage"></a>
2.6.2 Local Stack Information Storage</h4>
<p>Local stack information is stored in Local stack information storage space.</p><ol type="1">
<li>Device Name Storage <br />
 <br />
 The permitted length of character string for device name is up to 40 bytes (including end mark) in GAP layer currently. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga8a555625abc7ac124ee9649f25d51088" title="Save local device name to flash. ">flash_save_local_name()</a> function is used to save the local name to FTL. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaf0269765d3bdf4549141d649b959077f" title="Load local device name from flash. ">flash_load_local_name()</a> function is used to load the local name from FTL. When device name characteristic of GAP service is writeable, application can use this function to save the device name. <br />
 <br />
</li>
<li>Device Appearance Storage <br />
 <br />
 Device Appearance is used to set the type of a device, such as keyboard, mouse, thermometer, blood pressure meter, etc. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaec89f7c962fc7f3044cee9792594edb8" title="Save local device appearance to flash. ">flash_save_local_appearance()</a> function is used to save the appearance to FTL. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga0787406d86e51be9e599c6d6c527173d" title="Load local device appearance from flash. ">flash_load_local_appearance()</a> function is used to load the appearance from FTL. When device appearance characteristic of GAP service is writeable, application can use this function to save the device appearance. <br />
 <br />
</li>
<li>Local IRK Storage <br />
 <br />
 Identity Resolving Key (IRK) is a 128-bit key used to generate and resolve random addresses. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gac7363d0591a839679368804978437ca7" title="Save local IRK to flash. ">flash_save_local_irk()</a> function is used to save the local IRK to FTL. <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3959368b59ec2269d1ba42c07a6c9456" title="Load local IRK from flash. ">flash_load_local_irk()</a> function is used to load the local IRK from FTL.</li>
</ol>
<h4><a class="anchor" id="Bond_Information_Storage"></a>
2.6.3 Bond Information Storage</h4>
<p><a class="anchor" id="invalid"></a></p><h5>2.6.3.1 Bonded Device Priority Manager</h5>
<p>GAP layer implements bonded device priority management mechanism. Priority control block will be saved to FTL. Both LE and Legacy devices have independent storage spaces and priority control blocks.<br />
 Key priority control block contains two part:</p><ul>
<li><b>bond_num</b>: Save bonded devices number</li>
<li><b>bond_idx</b> array: Save bonded devices index array. GAP layer can use bonded device index to find out the start offset of FTL.</li>
</ul>
<p><b>Note:</b> In Figure 2-11 to Figure 2-17 the red font represents the device performing the operation. the Bond_idx[0] is the lowest priority device. the Bond_num is the number of bonded devices stored in FTL.<br />
</p>
<p>Priority manager consists of operations listed below:<br />
 <br />
 <b>1. Add a bond device</b> <br />
 <br />
 GAP LE API: Not provided, and only for internal use.<br />
 Figure 2-11 shows how add a new device 3 into Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_add.jpg" alt="gap_key_prio_add.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_11"><b>Figure 2-11 Add a Bond Device </b></div></center><p> <br />
 <b>2. Remove a bond device</b> <br />
 <br />
 GAP LE API: <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gab756312c25010e21530800b648458c99" title="Delete bond information by index. ">le_bond_delete_by_idx()</a> or <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9e3feb4b34147535f5a43754a22f64e0" title="Delete bond information by bluetooth device address and address type. ">le_bond_delete_by_bd()</a><br />
 Figure 2-12 shows how to remove device 1 from Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_remove.jpg" alt="gap_key_prio_remove.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_12"><b>Figure 2-12 Remove a Bond Device </b></div></center><p> <br />
 <b>3. Clear all bond devices</b> <br />
 <br />
 GAP LE API: <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a" title="Erase all link keys of bonded devices. ">le_bond_clear_all_keys()</a><br />
 Figure 2-13 shows how clear all bond devices in Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_clear.jpg" alt="gap_key_prio_clear.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_13"><b>Figure 2-13 Clear All Bond Devices </b></div></center><p> <br />
 <b>4. Set a bond device high priority</b> <br />
 <br />
 GAP LE API: <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3f93c0a8ad1ca6349c9f9cbba53a0f7e" title="Make the specified bonded device with the high priority. ">le_set_high_priority_bond()</a><br />
 Figure 2-14 shows how set device 0 as the high priority device in Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_set_high.jpg" alt="gap_key_prio_set_high.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_14"><b>Figure 2-14 Set a Bond Device High Priority </b></div></center><p> <br />
 <b>5. Get high priority device</b> <br />
 <br />
 The highest priority device is bond_idx[bond_num - 1]. <br />
 GAP LE API: <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga7bf1d938e49aaae07870f9cd8e64ac90" title="Get the high priority bond device key entry. ">le_get_high_priority_bond()</a><br />
 Figure 2-15 shows how get high priority device in Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_get_high.jpg" alt="gap_key_prio_get_high.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_15"><b>Figure 2-15 Get High Priority Device </b></div></center><p> <br />
 <b>6. Get low priority device</b> <br />
 <br />
 The lowest priority device is bond_idx[0]. <br />
 GAP LE API: <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga796485dca7bd2f870cffea925fbb80a6" title="Get the low priority bond device key entry. ">le_get_low_priority_bond()</a><br />
 Figure 2-16 shows how get low priority device in Priority manager queue.<br />
 </p><div class="image">
<img src="gap_key_prio_get_low.jpg" alt="gap_key_prio_get_low.jpg" width="300px" height="120px"/>
</div>
 <center><div id="figure_2_16"><b>Figure 2-16 Get Low Priority Device </b></div></center><p> <br />
 A priority manager example is shown in Figure 2-17 </p><div class="image">
<img src="gap_key_priority.jpg" alt="gap_key_priority.jpg"/>
</div>
 <center><div id="figure_2_17"><b>Figure 2-17 Priority Manager Example </b></div></center><p><a class="anchor" id="invalid"></a></p><h5>2.6.3.2 BLE Key Storage</h5>
<p>BLE Key information is stored in LE key storage space. <br />
</p>
<p><b>Configuration</b> <br />
 <br />
 The size of LE key storage space is related to the following two parameters: <br />
</p><ol type="1">
<li><b>LE Maximum Bonded Device Number</b><br />
 1) Default value is 4.<br />
 2) It can be configured by MCU Configure Tool.<br />
 <br />
</li>
<li><b>Maximum CCCD Number</b><br />
 1) Default value is 16.<br />
 2) It can be configured by MCU Configure Tool.<br />
</li>
</ol>
<p><b>LE Key Entry Structure</b> <br />
 <br />
 GAP layer use struct <a class="el" href="struct_t___l_e___k_e_y___e_n_t_r_y.html" title="LE key entry. ">T_LE_KEY_ENTRY</a> to manage bonded device. </p><div class="fragment"><div class="line"><span class="preprocessor">#define LE_KEY_STORE_REMOTE_BD_BIT   0x01</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_LOCAL_LTK_BIT   0x02</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_REMOTE_LTK_BIT  0x04</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_REMOTE_IRK_BIT  0x08</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_LOCAL_CSRK_BIT  0x10</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_REMOTE_CSRK_BIT 0x20</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_CCCD_DATA_BIT   0x40</span></div><div class="line"><span class="preprocessor">#define LE_KEY_STORE_LOCAL_IRK_BIT   0x80</span></div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> is_used;</div><div class="line">    uint8_t idx;</div><div class="line">    uint16_t flags;</div><div class="line">    uint8_t local_bd_type;</div><div class="line">    uint8_t reserved[3];</div><div class="line">    <a class="code" href="struct_t___l_e___r_e_m_o_t_e___b_d.html">T_LE_REMOTE_BD</a> remote_bd;</div><div class="line">    <a class="code" href="struct_t___l_e___r_e_m_o_t_e___b_d.html">T_LE_REMOTE_BD</a> resolved_remote_bd;</div><div class="line">} <a class="code" href="struct_t___l_e___k_e_y___e_n_t_r_y.html">T_LE_KEY_ENTRY</a>, *P_LE_KEY_ENTRY;</div></div><!-- fragment --><p> Parameter Description: <br />
</p><ol type="1">
<li><b>is_used</b> - Whether to use.<br />
</li>
<li><b>idx</b> - Device index. GAP layer can use idx to find out storage location in FTL.<br />
</li>
<li><b>flags</b> - <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___b_i_t_s.html">LE Key Storage Bits</a>, a bit field that indicates whether the key is existing.<br />
</li>
<li><b>local_bd_type</b> - Local address type used in pairing process. <a class="el" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a><br />
</li>
<li><b>remote_bd</b> - Remote device address.<br />
</li>
<li><b>resolved_remote_bd</b> - Indentity address of remote device.<br />
</li>
</ol>
<p><b>GAP BLE Key Manager</b> <br />
 <br />
 When local device pairs with remote device or encrypts with bonded device, GAP layer will send <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#gaf4e6edb01c279d7966d8114ad2f55437">GAP_MSG_LE_AUTHEN_STATE_CHANGE</a> to notify authentication state change.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_authen_state_evt(uint8_t conn_id, uint8_t new_state, uint16_t</div><div class="line">cause)</div><div class="line"></div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt:conn_id %d, cause 0x%x&quot;</span>, conn_id, cause);</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga2e41e8a62b92033c157ebf6de37b0f48">GAP_AUTHEN_STATE_STARTED</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt: GAP_AUTHEN_STATE_STARTED&quot;</span>);</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga74ca456a387d4acd1465fcc2a7419605">GAP_AUTHEN_STATE_COMPLETE</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (cause == <a class="code" href="group___b_t___t_y_p_e_s.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Pair success\r\n&quot;</span>);</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt: GAP_AUTHEN_STATE_COMPLETE pair success&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Pair failed: cause 0x%x\r\n&quot;</span>, cause);</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt: GAP_AUTHEN_STATE_COMPLETE pair failed&quot;</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#ga8495d380ca9f6315b5f1e73431bf9afe">GAP_MSG_LE_BOND_MODIFY_INFO</a> is used to notify app that bond information has been modified. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#ga34614c3a2044cd45d90bc1ad3ea2db02">T_LE_BOND_MODIFY_TYPE</a> type;</div><div class="line">    P_LE_KEY_ENTRY        p_entry;</div><div class="line">} <a class="code" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html">T_LE_BOND_MODIFY_INFO</a>;</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga8495d380ca9f6315b5f1e73431bf9afe">GAP_MSG_LE_BOND_MODIFY_INFO</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_MODIFY_INFO: type 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a0ab7c39155dc574b04984d65da1b7f4a">p_le_bond_modify_info</a>-&gt;<a class="code" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html#a08f0ca54422ea36b82cddf6f990434af">type</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Bond modify type is defined as below: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02a724414e1a7bc79d7be59275d26878f31">LE_BOND_DELETE</a>,</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02adc54f154e109acc1e86c0fc845d4d0c9">LE_BOND_ADD</a>,</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02a7390c63fbb0321521cf051ea81adcfb3">LE_BOND_CLEAR</a>,</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02ac7a83ac22f807dcccc35c0a64eb88fdd">LE_BOND_FULL</a>,</div><div class="line">    <a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02af7c7923a520063ae8a20e599ab83f08c">LE_BOND_KEY_MISSING</a>,</div><div class="line">    LE_BOND_IRK_SAVED</div><div class="line">} <a class="code" href="group___gap___c_b___msg___exported___types.html#ga34614c3a2044cd45d90bc1ad3ea2db02">T_LE_BOND_MODIFY_TYPE</a>;</div></div><!-- fragment --><p> <br />
</p><ol type="1">
<li><b>LE_BOND_DELETE</b> <br />
 <br />
 LE_BOND_DELETE message means a bond information has been deleted. It will be triggered in following conditions. <br />
 1) Invoke <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gab756312c25010e21530800b648458c99" title="Delete bond information by index. ">le_bond_delete_by_idx()</a> function.<br />
 2) Invoke <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9e3feb4b34147535f5a43754a22f64e0" title="Delete bond information by bluetooth device address and address type. ">le_bond_delete_by_bd()</a> function.<br />
 3) The link encryption failed.<br />
 4) Key storage space is full, and information of the lowest priority bond will be deleted.<br />
 <br />
</li>
<li><b>LE_BOND_ADD</b> <br />
 <br />
 LE_BOND_ADD message means a new device is bonded. It will only be triggered when pairing with the remote device for the first time. <br />
<br />
</li>
<li><b>LE_BOND_CLEAR</b> <br />
 <br />
 LE_BOND_CLEAR message means all bond information has been deleted. It will only be triggered after invoking <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a" title="Erase all link keys of bonded devices. ">le_bond_clear_all_keys()</a> function. <br />
<br />
</li>
<li><b>LE_BOND_FULL</b> <br />
 <br />
 LE_BOND_FULL message means key storage space is full. This message only be triggered when parameter of GAP_PARAM_BOND_KEY_MANAGER was set to true. If so, GAP will not delete keys automatically. Otherwise, GAP will delete the lowest priority key and save this key firstly, then trigger LE_BOND_DELETE message. <br />
<br />
</li>
<li><b>LE_BOND_KEY_MISSING</b> <br />
 <br />
 LE_BOND_KEY_MISSING message means the link encryption failed and the key is no longer valid. This message only be triggered when parameter of upperstack_cfg. gap_bond_manager was set to true. <br />
<br />
 <div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_GAP_BOND_MANAGER_SUPPORT</span></div><div class="line">            <span class="keywordflow">if</span> (upperstack_cfg.gap_bond_manager)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (acl_info-&gt;p.authen.cause == (<a class="code" href="group___b_t___t_y_p_e_s.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___t_y_p_e_s.html#ga2c5b6c578a06d58d7b0b2fc2a25146b0">HCI_ERR_KEY_MISSING</a>))</div><div class="line">                {</div><div class="line">                    <a class="code" href="struct_t___l_e___k_e_y___e_n_t_r_y.html">T_LE_KEY_ENTRY</a> *p_entry = <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">                    p_entry = <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaf3ed869340ae99c394b08e5428274e91">le_find_key_entry</a>(acl_info-&gt;bd_addr, (<a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a>)acl_info-&gt;remote_addr_type);</div><div class="line">                    <span class="keywordflow">if</span> (p_entry != <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">                    {</div><div class="line">                        le_bond_send_bond_modify_info(<a class="code" href="group___gap___c_b___msg___exported___types.html#gga34614c3a2044cd45d90bc1ad3ea2db02af7c7923a520063ae8a20e599ab83f08c">LE_BOND_KEY_MISSING</a>, p_entry);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
</ol>
<p><br />
 <b>BLE device priority manager in GAP layer</b> <br />
<br />
</p><ol type="1">
<li>Pair with a new device <br />
<br />
 1) Key storage space is not full <br />
 GAP layer will add the bonded device to priority control block and send LE_BOND_ADD to APP. This added device is high priority. <br />
 2) Key storage space is full <br />
<ul>
<li>When GAP_PARAM_BOND_KEY_MANAGER is true, GAP layer will send LE_BOND_FULL to APP. <br />
</li>
<li>When GAP_PARAM_BOND_KEY_MANAGER is flase, GAP layer will remove lowest priority bonded device from priority control block and send LE_BOND_DELETE to APP.<br />
 Then GAP layer will add the bonded device to priority control block and send LE_BOND_ADD to APP. <br />
 This added device is high priority. <br />
<br />
</li>
</ul>
</li>
<li>Encryption with bonded device succeeded. <br />
 GAP layer will set this bonded device to high priority. <br />
<br />
</li>
<li>Encryption with bonded device failed. <br />
 1) When upperstack_cfg.gap_bond_manager is true, GAP layer will send LE_BOND_KEY_MISSING to APP. <br />
</li>
</ol>
<p><b>gap storage APIs</b> <br />
 <br />
 </p><div class="fragment"><div class="line"><span class="comment">/* gap_storage_le.h */</span></div><div class="line">P_LE_KEY_ENTRY <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaf3ed869340ae99c394b08e5428274e91">le_find_key_entry</a>(uint8_t *bd_addr, <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> bd_type);</div><div class="line">P_LE_KEY_ENTRY <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gad182e8557c1fff52850186e6c793998f">le_find_key_entry_by_idx</a>(uint8_t idx);</div><div class="line">uint8_t <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gab12418479ef2c6cf09b683e351da17fb">le_get_bond_dev_num</a>(<span class="keywordtype">void</span>);</div><div class="line">P_LE_KEY_ENTRY <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga796485dca7bd2f870cffea925fbb80a6">le_get_low_priority_bond</a>(<span class="keywordtype">void</span>);</div><div class="line">P_LE_KEY_ENTRY <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga7bf1d938e49aaae07870f9cd8e64ac90">le_get_high_priority_bond</a>(<span class="keywordtype">void</span>);</div><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga3f93c0a8ad1ca6349c9f9cbba53a0f7e">le_set_high_priority_bond</a>(uint8_t *bd_addr, <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> bd_type);</div><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaa8859ac48e090f3cda9c0d7cb56e2669">le_resolve_random_address</a>(uint8_t *unresolved_addr, uint8_t *resolved_addr,</div><div class="line">                               <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac6324ef7af2a4a3bddb9143033bd4c18">T_GAP_IDENT_ADDR_TYPE</a> *resolved_addr_type);</div><div class="line"><span class="comment">/* gap_bond_le.h */</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a">le_bond_clear_all_keys</a>(<span class="keywordtype">void</span>);</div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#gab756312c25010e21530800b648458c99">le_bond_delete_by_idx</a>(uint8_t idx);</div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9e3feb4b34147535f5a43754a22f64e0">le_bond_delete_by_bd</a>(uint8_t *bd_addr, <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> bd_type);</div></div><!-- fragment --><h3><a class="anchor" id="Bluetooth_LE_Privacy"></a>
2.7 Bluetooth LE Privacy</h3>
<h4><a class="anchor" id="BLE_PRIVACY_IND"></a>
2.7.1 Introduction</h4>
<p>The purpose of this chapter is to give an overview of Bluetooth LE Privacy. Bluetooth LE supports a feature that reduces the ability to track a LE device over a period of time by changing the Bluetooth device address on a frequent basis. In order for a device using the privacy feature to reconnect to known devices, the device address, referred to as the private address, must be resolved by the other device. The private address is generated using the device's IRK exchanged during the bonding procedure.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.7.1.1 Device Address</h5>
<p>Devices are identified using a device address. Device addresses may be either a public device address or a random device address. The random device address may be of either of the following two sub-types:</p><ul>
<li>Static address</li>
<li>Private address The private address may be of either of the following two sub-types:</li>
<li>Non-resolvable private address</li>
<li>Resolvable private address</li>
</ul>
<p><b>Static address</b> <br />
</p>
<p>The format of a static address is shown in Figure 2-18 </p><div class="image">
<img src="static_address_format.png" alt="static_address_format.png"/>
</div>
 <center><div id="figure_2_18"><b>Figure 2-18 Format of Static Address </b></div></center><p><b>Non-resolvable private address</b> <br />
</p>
<p>The format of a non-resolvable private address is shown in Figure 2-19 </p><div class="image">
<img src="non-resolvable_address_format.png" alt="non-resolvable_address_format.png"/>
</div>
 <center><div id="figure_2_19"><b>Figure 2-19 Format of non-resolvable Private Address </b></div></center><p><b>resolvable private address</b> <br />
</p>
<p>The format of the resolvable private address is shown in Figure 2-20 </p><div class="image">
<img src="resolvable_address_format.png" alt="resolvable_address_format.png"/>
</div>
 <center><div id="figure_2_20"><b>Figure 2-20 Format of Resolvable Private Address </b></div></center><p>A device's Identity Address is a Public Device Address or Random Static Device Address that it uses in packets it transmits. If a device is using Resolvable Private Addresses, it shall also have an Identity Address. To generate a resolvable private address, the device must have either the Local Identity Resolving Key (IRK) or the Peer Identity Resolving Key (IRK). The resolvable private address shall be generated with the IRK and a randomly generated 24-bit number. A resolvable private address can be resolved by the corresponding device's IRK. If a resolvable private address is resolved, the device can associate this address with the peer device.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.7.1.2 IRK and Identity Address</h5>
<p>The Security Manager (SM) uses a key distribution approach to perform identity and encryption functionalities in radio communication. Identity Resolving Key (IRK) is a 128-bit key used to generate and resolve random addresses. A master that has received IRK from a slave can resolve that slave's random device addresses. A slave that has received IRK from a master can resolve that master's random device addresses. The privacy concept only protects against devices that are not part of the set to which the IRK has been given. Identity Information is used to distribute the IRK. An all zero Identity Resolving Key data field indicates that a device does not have a valid resolvable private address. Identity Address Information is used to distribute its public device address or static random address. Figure 2-21 shows an example of all keys and values being distributed by Master and Slave.</p>
<div class="image">
<img src="key_distribution.png" alt="key_distribution.png"/>
</div>
 <center><div id="figure_2_21"><b>Figure 2-21 Transport Specific Key Distribution </b></div></center><p><a class="anchor" id="invalid"></a></p><h5>2.7.1.3 Resolving List and Resolution</h5>
<p><b>Resolving List and White List</b> <br />
</p>
<p>The Host maintains a resolving list by adding and removing device identities. A device identity consists of the peer's identity address and a local and peer's IRK pair. When the Controller performs address resolution and the Host needs to refer to a peer device that is included in the resolving list, it uses the peer's device identity address. Likewise, all incoming events from the Controller to the Host will use the peer's device identity, provided that the peer's device address has been resolved. Device filtering becomes possible when address resolution is performed in the Controller because the peer's device identity address can be resolved prior to checking whether it is in the White List. Figure 2-22 shows a logical representation of the relationship between the Controller resolving list and the Controller White List.</p>
<div class="image">
<img src="resolving_list.png" alt="resolving_list.png"/>
</div>
 <center><div id="figure_2_22"><b>Figure 2-22 Logical Representation of The Resolving List and Device White List </b></div></center><p>The White List and filter policies set by the Host are applied to the associated Identity Address once the Resolvable Private Address has been resolved.</p>
<p><b>Address Resolution</b> <br />
</p>
<p>If address resolution is enabled in the Controller, the Controller will use the resolving list whenever the Controller receives a local or peer Resolvable Private Address.</p>
<p>Address resolution can be enabled at any time except when: <br />
</p><ul>
<li>Advertising is enabled<br />
</li>
<li>Scanning is enabled<br />
</li>
<li>Create connection command is outstanding<br />
</li>
</ul>
<p>When address resolution is enabled in the Controller, all references to peer devices that are included in the resolving list from Host to the Controller shall be done using the peer's device identity address. Likewise, all incoming events from the Controller to the Host will use the peer's device identity, if the peer's device address has been resolved.</p>
<h4><a class="anchor" id="BLE_PRIVACY_MODULE"></a>
2.7.2 Privacy Management Module</h4>
<p>Development of Privacy Management Module is based on header file <a class="el" href="gap__privacy_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_privacy.h</a>. If user needs to use the Privacy Management Module, user can't use the header file <a class="el" href="gap__privacy_8h_source.html" title="This file contains all the functions prototypes for the GAP bond and pairing related functions...">gap_privacy.h</a>. Therefore, user can use header file privacy_mgnt.h to develop the privacy related applications.</p>
<p>Directory of Privacy Management Module files is as follows:<br />
</p>
<ul>
<li>Source code: sdk\ src\ble\privacy\privacy_mgnt.c</li>
<li>Header file: sdk\ src\ble\privacy\privacy_mgnt.h</li>
</ul>
<p>User needs to add the privacy_mgnt.c file in the app group of the project, and add header file directory into the include path.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.7.2.1 APIs</h5>
<p>Interfaces of Privacy Management Module are defined in header file privacy_mgnt.h.</p>
<div class="fragment"><div class="line"><span class="comment">/* privacy_mgnt.h APIs */</span></div><div class="line"><span class="keyword">typedef</span> void(*P_FUN_PRIVACY_STATE_CB)(T_PRIVACY_CB_TYPE type, T_PRIVACY_CB_DATA cb_data);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> privacy_init(P_FUN_PRIVACY_STATE_CB p_fun, <span class="keywordtype">bool</span> whitelist);</div><div class="line"></div><div class="line">T_PRIVACY_STATE privacy_handle_resolv_list(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> privacy_handle_bond_modify_msg(<a class="code" href="group___gap___c_b___msg___exported___types.html#ga34614c3a2044cd45d90bc1ad3ea2db02">T_LE_BOND_MODIFY_TYPE</a> type, <a class="code" href="struct_t___l_e___k_e_y___e_n_t_r_y.html">T_LE_KEY_ENTRY</a> *p_entry,<span class="keywordtype">bool</span> handle_add);</div><div class="line"></div><div class="line"><span class="keywordtype">bool</span> privacy_add_device(<a class="code" href="struct_t___l_e___k_e_y___e_n_t_r_y.html">T_LE_KEY_ENTRY</a> *p_entry);</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> privacy_set_addr_resolution(<span class="keywordtype">bool</span> enable);</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> privacy_read_peer_resolv_addr(<a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> peer_address_type,uint8_t *peer_address);</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> privacy_read_local_resolv_addr(<a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> peer_address_type,uint8_t *peer_address);</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>2.7.2.2 Usage of Privacy Management Module</h5>
<p>The sample code is located in BLE peripheral privacy project. This chapter is used to show how to use Privacy Management Module.</p>
<p><a class="anchor" id="invalid"></a></p><h6>2.7.2.2.1 Initialization</h6>
<p>APP needs to call privacy_init() to initialize the Privacy Management Module and register callback function.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"></div><div class="line">    <span class="comment">/* register gap message callback */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_gap_callback);</div><div class="line"><span class="preprocessor">#if APP_PRIVACY_EN</span></div><div class="line">    privacy_init(app_privacy_callback, <span class="keyword">true</span>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><p>The parameter whitelist of privacy_init() is used to configure management of white list. If the parameter whitelist is set to true, Privacy Management Module will manage the white list when Privacy Management Module modifys resolving list. If the parameter whitelist is set to false, application needs to manage the white list. The callback function is used to handle messages which are sent by Privacy Management Module.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_privacy_callback(T_PRIVACY_CB_TYPE type, T_PRIVACY_CB_DATA cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_privacy_callback: type %d&quot;</span>, type);</div><div class="line">    <span class="keywordflow">switch</span> (type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> PRIVACY_STATE_MSGTYPE:</div><div class="line">        app_privacy_state = cb_data.privacy_state;</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;PRIVACY_STATE_MSGTYPE: status %d&quot;</span>, app_privacy_state);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> PRIVACY_RESOLUTION_STATUS_MSGTYPE:</div><div class="line">        app_privacy_resolution_state = cb_data.resolution_state;</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;PRIVACY_RESOLUTION_STATUS_MSGTYPE: status %d&quot;</span>, app_privacy_resolution_state);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h6>2.7.2.2.2 Resolving List Management</h6>
<p>The key function of Privacy Management Module is used to manage the resolving list and white list when bonding informations are changed. The white list management is an optional feature. The parameter whitelist of privacy_init() is used to configure management of white list.</p>
<p>Application shall call function privacy_handle_bond_modify_msg() when application handles message GAP_MSG_LE_BOND_MODIFY_INFO.<br />
 Privacy Management Module will handle the resolving list according to modification type of bonding information.<br />
 process is shown as follows:<br />
</p>
<p><b>LE_BOND_DELETE:</b> Delete the device from the resolving list.<br />
 <b>LE_BOND_ADD:</b> Add the device to the resolving list.<br />
 <b>LE_BOND_CLEAR:</b> Clear the resolving list.<br />
</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line"><span class="preprocessor">#if APP_PRIVACY_EN</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga8495d380ca9f6315b5f1e73431bf9afe">GAP_MSG_LE_BOND_MODIFY_INFO</a>:</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_BOND_MODIFY_INFO: type 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a0ab7c39155dc574b04984d65da1b7f4a">p_le_bond_modify_info</a>-&gt;<a class="code" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html#a08f0ca54422ea36b82cddf6f990434af">type</a>);</div><div class="line">        privacy_handle_bond_modify_msg(p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a0ab7c39155dc574b04984d65da1b7f4a">p_le_bond_modify_info</a>-&gt;<a class="code" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html#a08f0ca54422ea36b82cddf6f990434af">type</a>,</div><div class="line">                                       p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a0ab7c39155dc574b04984d65da1b7f4a">p_le_bond_modify_info</a>-&gt;<a class="code" href="struct_t___l_e___b_o_n_d___m_o_d_i_f_y___i_n_f_o.html#ab4c2f4d46e52e38123fdb597d2334c42">p_entry</a>, <span class="keyword">true</span>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><p>Modification procedure of resolving list cannot be executed when address resolution is enabled and:<br />
</p><ul>
<li>Advertising is enabled</li>
<li>Scanning is enabled</li>
<li>Create connection command is outstanding</li>
</ul>
<p>Modification procedure of resolving list can be executed at any time when address resolution is disabled. Application shall call function privacy_handle_resolv_list() when the gap device state is idle state. The function privacy_handle_resolv_list() handles the pending modification procedure of resolving list.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_handle_dev_state_evt: init state %d, adv state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>, new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>, cause);</div><div class="line"><span class="preprocessor">#if APP_PRIVACY_EN</span></div><div class="line">    <span class="keywordflow">if</span> ((new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        &amp;&amp; (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a> == <a class="code" href="group___g_a_p___a_d_v___s_t_a_t_e.html#ga1c5587685f9f5db48cec93fb7edf052d">GAP_ADV_STATE_IDLE</a>)</div><div class="line">        &amp;&amp; (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a29c134a279511591376fff5b0097edb5">gap_conn_state</a> == <a class="code" href="group___g_a_p___c_o_n_n___s_t_a_t_e.html#ga9df61c005acd382288dd7f533e42c44c">GAP_CONN_DEV_STATE_IDLE</a>))</div><div class="line">    {</div><div class="line">        privacy_handle_resolv_list();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div></div><!-- fragment --><p>The callback type PRIVACY_STATE_MSGTYPE is used to inform the state of the resolving list modification procedure. The callback data is T_PRIVACY_STATE.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    PRIVACY_STATE_INIT,</div><div class="line">    PRIVACY_STATE_IDLE,</div><div class="line">    PRIVACY_STATE_BUSY</div><div class="line">} T_PRIVACY_STATE;</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h6>2.7.2.2.3 Address Resolution</h6>
<p>If peer device uses the resolvable private address, and application wants to use the white list to filter this peer device. Then, application needs to call function privacy_set_addr_resolution() to enable the address resolution. If application wants to pair with new devices, application needs to call function privacy_set_addr_resolution() to disable the address resolution. When the address resolution is enabled, the local device cannot connect with the device which is not in the resolving list.<br />
 The sample code is shown as follows. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_adv_start(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t  adv_evt_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggacf74b995831649442ea0c341e0b02ff1a7d472577d57ea1d8ff3ecff264594a2b">GAP_ADTYPE_ADV_IND</a>;</div><div class="line">    uint8_t  adv_filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76a610241ea5e48e993bbf893c19e1b2794">GAP_ADV_FILTER_ANY</a>;</div><div class="line"><span class="preprocessor">#if APP_PRIVACY_EN</span></div><div class="line">    <a class="code" href="struct_t___l_e___k_e_y___e_n_t_r_y.html">T_LE_KEY_ENTRY</a> *p_entry;</div><div class="line">    p_entry = <a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga7bf1d938e49aaae07870f9cd8e64ac90">le_get_high_priority_bond</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (p_entry == <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* No bonded device, send connectable undirected advertisement without using whitelist*/</span></div><div class="line">        app_work_mode = APP_PAIRABLE_MODE;</div><div class="line">        adv_filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76a610241ea5e48e993bbf893c19e1b2794">GAP_ADV_FILTER_ANY</a>;</div><div class="line">        <span class="keywordflow">if</span> (app_privacy_resolution_state == PRIVACY_ADDR_RESOLUTION_ENABLED)</div><div class="line">        {</div><div class="line">            privacy_set_addr_resolution(<span class="keyword">false</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        app_work_mode = APP_RECONNECTION_MODE;</div><div class="line">        adv_filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76af461c3e763d26822ab86809b7442248f">GAP_ADV_FILTER_WHITE_LIST_ALL</a>;</div><div class="line">        <span class="keywordflow">if</span> (app_privacy_resolution_state == PRIVACY_ADDR_RESOLUTION_DISABLED)</div><div class="line">        {</div><div class="line">            privacy_set_addr_resolution(<span class="keyword">true</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <a class="code" href="group___g_a_p___broadcaster___exported___functions.html#ga4176895d52a9ca0c130f1a2e8500d38c">le_adv_set_param</a>(<a class="code" href="group___g_a_p___broadcaster___exported___types.html#ggaf151893614db4dc36de4ad9a83b7b3a6a34cb97e9f56f71274e58191aad0c0e5c">GAP_PARAM_ADV_EVENT_TYPE</a>, <span class="keyword">sizeof</span>(adv_evt_type), &amp;adv_evt_type);</div><div class="line">    <a class="code" href="group___g_a_p___broadcaster___exported___functions.html#ga4176895d52a9ca0c130f1a2e8500d38c">le_adv_set_param</a>(<a class="code" href="group___g_a_p___broadcaster___exported___types.html#ggaf151893614db4dc36de4ad9a83b7b3a6a150f9aa741e715cc577687823b9d8ca6">GAP_PARAM_ADV_FILTER_POLICY</a>, <span class="keyword">sizeof</span>(adv_filter_policy), &amp;adv_filter_policy);</div><div class="line">    <a class="code" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a>();</div><div class="line">}</div></div><!-- fragment --><p> The function privacy_set_addr_resolution() is used to enable resolution of Resolvable Private Addresses in the Controller. This causes the Controller to use the resolving list whenever the Controller receives a local or peer Resolvable Private Address. This function can be used at any time except when:<br />
</p>
<ul>
<li>Advertising is enabled</li>
<li>Scanning is enabled</li>
<li>Create connection command is outstanding</li>
</ul>
<p>The callback type PRIVACY_RESOLUTION_STATUS_MSGTYPE is used to inform the state of address resolution. The callback data is T_PRIVACY_ADDR_RESOLUTION_STATE.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    PRIVACY_ADDR_RESOLUTION_DISABLED,</div><div class="line">    PRIVACY_ADDR_RESOLUTION_DISABLING,</div><div class="line">    PRIVACY_ADDR_RESOLUTION_ENABLING,</div><div class="line">    PRIVACY_ADDR_RESOLUTION_ENABLED</div><div class="line">} T_PRIVACY_ADDR_RESOLUTION_STATE;</div></div><!-- fragment --><h3><a class="anchor" id="BLE_Address"></a>
2.8 BLE Address</h3>
<h4><a class="anchor" id="BLE_ADDR_Intro"></a>
2.8.1 Introduction</h4>
<p>The purpose of this chapter is to give an overview of BLE address. All BLE devices shall have a BLE Address that uniquely identifies the device to another BLE device. BLE devices have multiple types of device addresses. The specific classification is shown in the table below.</p>
<center><div id="table_2_14"><b>Table 2-14 Address Type List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">type  </th><th class="markdownTableHeadLeft">sub-type  </th><th class="markdownTableHeadLeft">sub-type  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Public address  </td><td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">Same with legacy address.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Random address  </td><td class="markdownTableBodyLeft">Static address  </td><td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">It changes at every power cycle.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">Private address  </td><td class="markdownTableBodyLeft">Resolvable address  </td><td class="markdownTableBodyLeft">The Address needs to be parsed<br />
before it can be identified so it<br />
is more secure   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">NA  </td><td class="markdownTableBodyLeft">Non-resolvable address  </td><td class="markdownTableBodyLeft">This address type is not commonly used.   </td></tr>
</table>
<p>Static device address changes every time the device is powered on, the following problems are encountered.</p><ol type="1">
<li>The mobile phone will recognize the headset as different devices.</li>
<li>Because the address changes, the previous paring information can not be used. So it has to pair again.</li>
</ol>
<h4><a class="anchor" id="BLE_ADDR_Setting"></a>
2.8.2 BLE Address Setting</h4>
<p>In order to solve the above problems and meet the special requirements of customers, some setting methods are provided here. A few sample scenarios are shown below.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.8.2.1 Sample 1</h5>
<p><b>Customer requirement:</b></p>
<p>The static device address is needed, but it will not change at every power cycle. BLE and BREDR are considered as two different devices. The solution for <b>rws project</b> is as follows. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_ble_rand_addr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a6eb174a1d8256d8c0cd82f43532524b0">le_single_random_addr</a>[5] &amp; 0xC0) != 0xC0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga7a160b17460c4697f6f3289293e602fd">le_gen_rand_addr</a>(<a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga22a2d99be7d398d8316d16992be41c6eacd5a63fcc32c1c3d6f77d28431abfe70">GAP_RAND_ADDR_STATIC</a>, <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a6eb174a1d8256d8c0cd82f43532524b0">le_single_random_addr</a>);</div><div class="line">        <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#gab297c89769dd5a96e5d0e10c194869bc">app_cfg_store</a>(&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a6eb174a1d8256d8c0cd82f43532524b0">le_single_random_addr</a>, 6);</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_ble_rand_addr_init: le_single_random_addr %s&quot;</span>,</div><div class="line">                         <a class="code" href="group___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a6eb174a1d8256d8c0cd82f43532524b0">le_single_random_addr</a>));</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___o_s__87x3e___queue.html#gace09f1bc91cf55ef47b9c31109709947">os_queue_init</a>(&amp;addr_mgr.cb_queue);</div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_ERWS_SUPPORT</span></div><div class="line">    <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga3973f461a62ef1eadfe82daa3f18ce8e">app_relay_cback_register</a>(<a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, (<a class="code" href="group___a_p_p___r_e_l_a_y.html#gab939643c0895c2c6df4c44c598784476">P_APP_PARSE_CBACK</a>)relay_parse,</div><div class="line">                             <a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedea144431134179b3afbcbce19af8e4ebd1">APP_MODULE_TYPE_BLE_RAND_ADDR</a>, REMOTE_MSG_MAX);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><p> Using the above code, the random address is generated only when the device is powered on at the first time after downloading binary files. and app_cfg_nv.le_single_random_addr will be saved. The solution for <b>ble_scatternet project</b> is as follows. </p><div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_LE_USE_STATIC_RANDOM_ADDR</span></div><div class="line"></div><div class="line">    T_APP_STATIC_RANDOM_ADDR random_addr;</div><div class="line"></div><div class="line">    <span class="keywordtype">bool</span> gen_addr = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    uint8_t local_bd_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98ab751d2722a1890be60daf72ca879555a">GAP_LOCAL_ADDR_LE_RANDOM</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_load_static_random_address(&amp;random_addr) == 0)</div><div class="line"></div><div class="line">    {</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (random_addr.is_exist == <span class="keyword">true</span>)</div><div class="line"></div><div class="line">        {</div><div class="line"></div><div class="line">            gen_addr = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gen_addr)</div><div class="line"></div><div class="line">    {</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga7a160b17460c4697f6f3289293e602fd">le_gen_rand_addr</a>(<a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga22a2d99be7d398d8316d16992be41c6eacd5a63fcc32c1c3d6f77d28431abfe70">GAP_RAND_ADDR_STATIC</a>, random_addr.bd_addr) == <a class="code" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>)</div><div class="line"></div><div class="line">        {</div><div class="line"></div><div class="line">            random_addr.is_exist = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">            app_save_static_random_address(&amp;random_addr);</div><div class="line"></div><div class="line">        }</div><div class="line"></div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga02fcbafd90ad0d1768542d7d93b71b76">le_cfg_local_identity_address</a>(random_addr.bd_addr, <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac6324ef7af2a4a3bddb9143033bd4c18a1ad4d124a5286b86f5be1913868e7d81">GAP_IDENT_ADDR_RAND</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea5bd740d56a0caf83579e00a85f95e52c">GAP_PARAM_RANDOM_ADDR</a>, 6, random_addr.bd_addr);</div><div class="line"></div><div class="line">    <span class="comment">//only for peripheral,broadcaster</span></div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___broadcaster___exported___functions.html#ga4176895d52a9ca0c130f1a2e8500d38c">le_adv_set_param</a>(<a class="code" href="group___g_a_p___broadcaster___exported___types.html#ggaf151893614db4dc36de4ad9a83b7b3a6a4cb51d7749e45e3eabf14b59c42a47c6">GAP_PARAM_ADV_LOCAL_ADDR_TYPE</a>, <span class="keyword">sizeof</span>(local_bd_type), &amp;local_bd_type);</div><div class="line"></div><div class="line">    <span class="comment">//only for central,observer</span></div><div class="line"></div><div class="line">    <a class="code" href="group___observer___exported___functions.html#ga0a4fd893b544bba374c6a07732445a35">le_scan_set_param</a>(<a class="code" href="group___observer___exported___types.html#ggaadafeb993b69ae6913eab0c6d60b03b0a6dab20d4b0b7758eadb75118d4c033f5">GAP_PARAM_SCAN_LOCAL_ADDR_TYPE</a>, <span class="keyword">sizeof</span>(local_bd_type), &amp;local_bd_type);</div><div class="line"></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p> Using the above code, the random address is generated only at the first time to reset after downloading binary files. Then it will be saved in FTL.</p>
<p><a class="anchor" id="invalid"></a></p><h5>2.8.2.2 Sample 2</h5>
<p><b>Customer requirement:</b></p>
<p>The static device address is needed, but it will not change at every power cycle and it is related to the value of public device address. BLE and BREDR are considered as two different devices. As the value of static device address needs to be related to the public device address, the legacy bluetooth device address should be first obtained. Then calculate the value of static device address according to requirement and set up. The specific steps are as follows:</p><ol type="1">
<li>In initialization, if static device address is used to start broadcasting, the following settings is needed: <br />
<br />
 <div class="fragment"><div class="line">uint8_t le_random_addr[6] = {0};</div><div class="line">app_ble_rand_addr_get(le_random_addr);</div><div class="line"></div><div class="line"><a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;le_common_adv.adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                filter_policy, 23 + data_len, app_ble_common_adv_data,</div><div class="line">                                <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#gaf79d883b90bf38f70f8787d9bd2b34b1">scan_rsp_data_len</a>, <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, le_random_addr);</div></div><!-- fragment --> <br />
</li>
<li><p class="startli">After GAP is ready (GAP_INIT_STATE_STACK_READY): <br />
<br />
 1). Obtain the public device address by gap_get_param(GAP_PARAM_BD_ADDR, g_public_addr).</p>
<p class="startli">2). Calculate the value of static device address according to requirement.</p>
<p class="startli">3). Set the static device address by <a class="el" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga6756396eee77befbe5bbc0d34cf9f1eb">ble_ext_adv_mgr_set_random</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___t_t_s___o_t_a___exported___functions.html#gad4f6ef524ec8c51a4b159a2b605c7335">app_ble_common_adv_set_random</a>(uint8_t *random_address)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga6756396eee77befbe5bbc0d34cf9f1eb">ble_ext_adv_mgr_set_random</a>(le_common_adv.adv_handle, random_address);</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="BLE_ADDR_Sample3"></a>
4.2.3 Sample 3</h4>
<p><b>Customer requirement:</b></p>
<p>The broadcast device addresses of BLE and legacy need to be the same. BLE and BREDR are considered as a device.</p>
<p><b>Note:</b></p>
<p>BLE and BREDR shall set same device name, otherwise there will be some problems.</p>
<p><b>The benefits is</b></p>
<ol type="1">
<li>It can open LTK derive to Linkkey functions <a class="el" href="group___a_p_p___f_l_a_g_s.html#gae0f4f0a2868af471361930c15d5061da">F_APP_SC_KEY_DERIVE_SUPPORT</a>. When BLE pair success, it will generate BREDR linkkey, so BREDR do not need to pair again.</li>
<li>Android and IOS(version after 13.0) only show one device in setting. <div style="page-break-after: always;"></div></li>
</ol>
<h2><a class="anchor" id="GATT_Profile"></a>
3 GATT Profile</h2>
<p>The purpose of this chapter is to give an overview of GATT Profile. The implementation of GATT Based Profile consists of two components: <b>Profile-Server</b> and <b>Profile-Client</b>.<br />
</p><ul>
<li><b>Profile-Server</b> is a public interface abstracted from implementation of server terminal of GATT Based Profile. More information could be found in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Server">3.1 Bluetooth LE Profile Server</a>.<br />
</li>
<li><b>Profile-Client</b> is a public interface abstracted from implementation of client terminal of GATT Based Profile. More information could be found in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Client">3.2 Bluetooth LE Profile Client</a>.<br />
</li>
</ul>
<h3><a class="anchor" id="Bluetooth_LE_Profile_Server"></a>
3.1 Bluetooth LE Profile Server</h3>
<p>The purpose of this chapter is to give an overview of profile server. Profile server layer will be introduced according to the following several parts:<br />
</p>
<ul>
<li>Profile Server definition will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_OVERVIEW">3.1.1 Overview</a>.</li>
<li>Supported Profile Service will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_SUPPORTED">3.1.2 Supported Profile and Service</a>.</li>
<li>Interaction between profile server layer and bluetooth protocol stack will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_INTERACTION">3.1.3 Profile Server Interaction</a>.</li>
<li>The implement of specific service will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_SERVER_IMPLEMENT_SPECIFIC_SERVICE">3.1.4 Implement Specific Service</a></li>
</ul>
<h4><a class="anchor" id="PROFILE_SERVER_OVERVIEW"></a>
3.1.1 Overview</h4>
<p>This chapter gives us simple description of the defination of profile server and profile server hierarchy.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.1.1 About Profile Server</h5>
<p>Server is the device that accepts incoming commands and requests from the client and sends responses, indications and notifications to a client. GATT (generic attribute profile) profile defines how BLE (Bluetooth low energy) devices transfer data between GATT server and GATT client. Profile may contains one or more GATT services, and service is a group of characteristics in set, through which GATT server exposes its characteristics. Profile Server exports APIs that user can use to implement a specific service.</p>
<p>Profile Server provides two exports APIs calling mechanisms:</p><ul>
<li>one is defined in <a class="el" href="profile__server_8h_source.html">profile_server.h</a>, which can interact with service data through conn_id.</li>
<li>one is defined in <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a>, which can interact with service data through conn_handle and cid.</li>
</ul>
<p>Note: <br />
 <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a> and <a class="el" href="profile__server_8h_source.html">profile_server.h</a> cannot be mixed use.</p><ul>
<li>if <b>F_APP_GATT_SERVER_EXT_API_SUPPORT</b> is set to 1, APP shall use interface in <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a> and shall not use interface in <a class="el" href="profile__server_8h_source.html">profile_server.h</a>.</li>
<li>if APP use ATT over BREDR, EATT over LE, EATT over BREDR, APP shall use API in <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a> and <b>F_APP_GATT_SERVER_EXT_API_SUPPORT</b> shall be set to 1.</li>
<li>if <b>F_APP_GATT_SERVER_EXT_API_SUPPORT</b> is set to 0, APP shall use interface in <a class="el" href="profile__server_8h_source.html">profile_server.h</a> and shall not use interface in <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a>.</li>
</ul>
<p>The following table lists the corespondence between the APIs in <a class="el" href="profile__server_8h_source.html">profile_server.h</a> and <a class="el" href="profile__server__ext_8h_source.html">profile_server_ext.h</a>. </p><div style="page-break-after: always;"></div> <center><div id="table_3_1"><b>Table 3-1 APIs in <a class="el" href="profile__server_8h_source.html" title="Head file for server structure. ">profile_server.h</a> and <a class="el" href="profile__server__ext_8h_source.html" title="Head file for server structure. ">profile_server_ext.h</a> </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">APIs in <a class="el" href="profile__server_8h_source.html" title="Head file for server structure. ">profile_server.h</a>  </th><th class="markdownTableHeadLeft">APIs in <a class="el" href="profile__server__ext_8h_source.html" title="Head file for server structure. ">profile_server_ext.h</a>  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">T_SEND_<br />
DATA_RESULT  </td><td class="markdownTableBodyLeft">T_EXT_SEND_<br />
DATA_RESULT  </td><td class="markdownTableBodyLeft">Service send data result   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">T_SERVER_<br />
CB_DATA  </td><td class="markdownTableBodyLeft">T_SERVER_EXT<br />
_CB_DATA  </td><td class="markdownTableBodyLeft">Service callback data   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">T_SERVER_<br />
APP_CB_DATA  </td><td class="markdownTableBodyLeft">T_SERVER_EXT<br />
_APP_CB_DATA  </td><td class="markdownTableBodyLeft">APP callback data   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">P_FUN_WRITE_<br />
IND_POST_PROC  </td><td class="markdownTableBodyLeft">P_FUN_EXT_WRITE_<br />
IND_POST_PROC  </td><td class="markdownTableBodyLeft">Write post callback function   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">P_FUN_GATT_READ_<br />
ATTR_CB  </td><td class="markdownTableBodyLeft">P_FUN_GATT_EXT_READ_<br />
ATTR_CB  </td><td class="markdownTableBodyLeft">Read callback function   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">P_FUN_GATT_WRITE<br />
_ATTR_CB  </td><td class="markdownTableBodyLeft">P_FUN_GATT_EXT_WRITE_<br />
ATTR_CB  </td><td class="markdownTableBodyLeft">Write callback function   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">P_FUN_GATT_CCCD_<br />
UPDATE_CB  </td><td class="markdownTableBodyLeft">P_FUN_GATT_EXT_CCCD_<br />
UPDATE_CB  </td><td class="markdownTableBodyLeft">CCCD update callback function   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">P_FUN_SERVER_<br />
GENERAL_CB  </td><td class="markdownTableBodyLeft">P_FUN_EXT_SERVER_<br />
GENERAL_CB  </td><td class="markdownTableBodyLeft">General callback function   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">T_FUN_GATT_<br />
SERVICE_CBS  </td><td class="markdownTableBodyLeft">T_FUN_GATT_<br />
EXT_SERVICE_CBS  </td><td class="markdownTableBodyLeft">Service calback struct   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">server_add_service  </td><td class="markdownTableBodyLeft">server_ext_add_service  </td><td class="markdownTableBodyLeft">Register specific service   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">server_add_service<br />
_by_start_handle  </td><td class="markdownTableBodyLeft">server_ext_add_service<br />
_by_start_handle  </td><td class="markdownTableBodyLeft">Register specific service<br />
with start handle   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">server_register_app_cb  </td><td class="markdownTableBodyLeft">server_ext_register_app_cb  </td><td class="markdownTableBodyLeft">Register callback function<br />
for application   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">server_attr_read_confirm  </td><td class="markdownTableBodyLeft">server_ext_attr_read_confirm  </td><td class="markdownTableBodyLeft">Confirm for read Request   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">server_exec_write_confirm  </td><td class="markdownTableBodyLeft">server_ext_exec_write_confirm  </td><td class="markdownTableBodyLeft">Confirm for Execute Write Request   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">server_attr_write_confirm  </td><td class="markdownTableBodyLeft">server_ext_attr_write_confirm  </td><td class="markdownTableBodyLeft">Confirm for Write Request   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">server_send_data  </td><td class="markdownTableBodyLeft">server_ext_send_data  </td><td class="markdownTableBodyLeft">Send notification/indication   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">server_get_write_<br />
cmd_data_buffer  </td><td class="markdownTableBodyLeft">server_ext_get_write_<br />
cmd_data_buffer  </td><td class="markdownTableBodyLeft">Get write command data buffer   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">server_send_multi_notify  </td><td class="markdownTableBodyLeft">server_ext_send_multi_notify  </td><td class="markdownTableBodyLeft">Send the multiple<br />
variable notification   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">server_get_cccd_info  </td><td class="markdownTableBodyLeft">server_ext_get_cccd_info  </td><td class="markdownTableBodyLeft">Get the CCCD information   </td></tr>
</table>
<p>This document set <b>F_APP_GATT_SERVER_EXT_API_SUPPORT</b> to 0 for default and use interface in <a class="el" href="profile__server_8h_source.html">profile_server.h</a> as an example to illustrate the usage of GATT Server APIs.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.1.2 Profile Server Hierarchy</h5>
<p>The profile server hierarchy is shown in Figure 3-1.</p>
<div class="image">
<img src="profile_server_hierarchy.png" alt="profile_server_hierarchy.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Profile Server Hierarchy </b></div></center><p>The content of profile server includes profile server layer and specific profile service.</p><ul>
<li>Profile server layer is above protocol stack and it encapsulates interfaces for specific service to access protocol stack. Therefore the development of specific services can consider less protocol stack process, making the design simplier and clearer.</li>
<li>Specific service is implemented by application layer which is based on the profile server layer. The specific service consists of attribute value and provides interfaces for application to transmit data.</li>
</ul>
<h4><a class="anchor" id="PROFILE_SERVER_SUPPORTED"></a>
3.1.2 Supported Profile and Service</h4>
<p>This chapter gives us simple description of Supported Profile and Service. Supported profile list is shown below.</p>
<center><div id="table_3_2"><b>Table 3-2 Profile List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Abbr  </th><th class="markdownTableHeadLeft">Definition  </th><th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadLeft">GATT server  </th><th class="markdownTableHeadLeft">GATT client   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP  </td><td class="markdownTableBodyLeft">Generic Access Profile  </td><td class="markdownTableBodyCenter">NA  </td><td class="markdownTableBodyLeft">Server role shall support<br />
GAS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">PXP  </td><td class="markdownTableBodyLeft">Proximity Profile  </td><td class="markdownTableBodyCenter">1.0.1  </td><td class="markdownTableBodyLeft">Proximity Reporter role shall support<br />
LLS(M), IAS(O), TPS(O)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ScPP  </td><td class="markdownTableBodyLeft">Scan Parameters Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Scan Server role shall support<br />
ScPS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">HTP  </td><td class="markdownTableBodyLeft">Health Thermometer<br />
Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Thermometer role shall support<br />
HTS(M), DIS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">HRP  </td><td class="markdownTableBodyLeft">Heart Rate Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Heart Rate Sensor role shall support<br />
HRS(M), DIS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">LNP  </td><td class="markdownTableBodyLeft">Location and Navigation Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">LN Sensor role shall support<br />
LNS(M), DIS(O), BAS(O)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">WSP  </td><td class="markdownTableBodyLeft">Weight Scale Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Weight Scale role shall support<br />
WSS(M), DIS(M), BAS(O)  </td><td class="markdownTableBodyLeft">WSS(M)<br />
DIS(M)<br />
BAS(O)   </td></tr>
</table>
<div style="page-break-after: always;"></div> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Abbr  </th><th class="markdownTableHeadLeft">Definition  </th><th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadLeft">GATT server  </th><th class="markdownTableHeadLeft">GATT client   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GLP  </td><td class="markdownTableBodyLeft">Glucose Profile  </td><td class="markdownTableBodyCenter">1.0.1  </td><td class="markdownTableBodyLeft">Glucose Sensor role shall support<br />
GLS(M), DIS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">FMP  </td><td class="markdownTableBodyLeft">Fine Me Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Find Me Target role shall support<br />
IAS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">HOGP  </td><td class="markdownTableBodyLeft">HID over GATT Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">HID Device shall support<br />
HIDS(M)<br />
BAS(M)<br />
DIS(O)<br />
ScPS(O)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">RSCP  </td><td class="markdownTableBodyLeft">Running Speed and Cadence Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">RSC Sensor role shall support<br />
RSCS(M), DIS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CSCP  </td><td class="markdownTableBodyLeft">Cycling Speed and Cadence Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">CSC Sensor role shall support<br />
CSCS(M), DIS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">IPSP  </td><td class="markdownTableBodyLeft">Internet Protocol Support Profile  </td><td class="markdownTableBodyCenter">1.0  </td><td class="markdownTableBodyLeft">Node role shall support<br />
IPSS(M)  </td><td class="markdownTableBodyLeft">NA   </td></tr>
</table>
<p><b>NOTE:</b> M: mandatory; O: optional</p>
<p>Supported service list is shown below.</p>
<center><div id="table_3_3"><b>Table 3-3 Service List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Abbr.  </th><th class="markdownTableHeadLeft">Definition  </th><th class="markdownTableHeadLeft">Interface   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GATTS  </td><td class="markdownTableBodyLeft">Generic Attribute Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e.html">GAP and GATT Inbox Services</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">GAS  </td><td class="markdownTableBodyLeft">Generic Access Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e.html">GAP and GATT Inbox Services</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">BAS  </td><td class="markdownTableBodyLeft">Battery Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___b_a_s.html">Battery Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">DIS  </td><td class="markdownTableBodyLeft">Device Information Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___d_i_s.html">Device Information Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ScPS  </td><td class="markdownTableBodyLeft">Scan Parameters Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___s_p_s.html">Scan Parameters Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">TPS  </td><td class="markdownTableBodyLeft">Tx Power Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___t_p_s.html">Tx Power Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">IAS  </td><td class="markdownTableBodyLeft">Immediate Alert Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___i_a_s.html">Immediate Alert Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">LLS  </td><td class="markdownTableBodyLeft">Link Loss Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___l_l_s.html">Link Loss Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">HTS  </td><td class="markdownTableBodyLeft">Health Thermometer Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___h_t_s.html">Health Thermometer Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">HRS  </td><td class="markdownTableBodyLeft">Heart Rate Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___h_r_s.html">Heart Rate Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">LNS  </td><td class="markdownTableBodyLeft">Location and Navigation Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___l_n_s.html">Location And Navigation Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">WSS  </td><td class="markdownTableBodyLeft">Weight Scale Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___w_s_s.html">Weight Scale Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">RSCS  </td><td class="markdownTableBodyLeft">Running Speed and Cadence Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___r_s_c_s.html">Running Speed and Cadence Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CSCS  </td><td class="markdownTableBodyLeft">Cycling Speed and Cadence Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___c_s_c_s.html">Cycling Speed and Cadence Service</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GLS  </td><td class="markdownTableBodyLeft">Glucose Service  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_l_s.html">Glucose Service</a>   </td></tr>
</table>
<h4><a class="anchor" id="PROFILE_SERVER_INTERACTION"></a>
3.1.3 Profile Server Interaction</h4>
<p>This chapter gives us simple description of profile server interactions. Profile server layer handles interaction with protocol stack layer and provides interfaces to design specific service, including:</p><ul>
<li>adding service to server</li>
<li>characteristic value read</li>
<li>characteristic value write</li>
<li>characteristic value notification</li>
<li>characteristic value indication</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.3.1 Add service</h5>
<p>Protocol stack maintains information of all services which are added from profile server layer. The number of total service attribute table to be added shall be first initialized. Profile server layer provides <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a> function to initialize service table number.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_profile_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(2);</div><div class="line">    simp_srv_id = <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service</a>(app_profile_callback);</div><div class="line">    bas_srv_id  = <a class="code" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a>(app_profile_callback);</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a>(app_profile_callback);</div><div class="line">        ...</div><div class="line">}</div></div><!-- fragment --><p>Profile server layer provides <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a> interface to add services to server.</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service</a>(<span class="keywordtype">void</span> *p_func)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>(&amp;simp_service_id,</div><div class="line">                                    (uint8_t *)simple_ble_service_tbl,</div><div class="line">                                    <span class="keyword">sizeof</span>(simple_ble_service_tbl),</div><div class="line">                                    simp_ble_service_cbs))</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;simp_ble_service_add_service: fail&quot;</span>);</div><div class="line">        simp_service_id = 0xff;</div><div class="line">        <span class="keywordflow">return</span> simp_service_id;</div><div class="line">    }</div><div class="line"></div><div class="line">    pfn_simp_ble_service_cb = (<a class="code" href="group___p___f_u_n___s_e_r_v_e_r___g_e_n_e_r_a_l___c_b.html#ga58463a252b3e4f0362285a5e7e8cf2dd">P_FUN_SERVER_GENERAL_CB</a>)p_func;</div><div class="line">    <span class="keywordflow">return</span> simp_service_id;</div><div class="line">}</div></div><!-- fragment --><p>A server contains serval service tables is shown in Figure 3-2.</p>
<div class="image">
<img src="profile_add_services.png" alt="profile_add_services.png"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 Add Services to Server </b></div></center><p>After service is added to profile server layer, GAP initialization steps will register all services and send message <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a> to GAP layer upon completing the registration process. Register services' process is shown in Figure 3-3.</p>
<div class="image">
<img src="profile_register_services.png" alt="profile_register_services.png"/>
</div>
 <center><div id="figure_3_3"><b>Figure 3-3 Register Services Process </b></div></center><p>Registration of services is started by sending service register request to protocol stack during initialization of GAP, and then all services which have been added will be registered. If server general callback function is not NULL, once the last service is registered properly, profile server layer will send <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a> message to application through <b>gatt_srv_cb</b> function.</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>:<span class="comment">// srv register result event.</span></div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;PROFILE_EVT_SRV_REG_COMPLETE: result %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#a4a385380321b6b14cb5cc01f89d4ed02">service_reg_result</a>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        ...</div><div class="line"></div><div class="line">        }</div><div class="line">        ...</div><div class="line">     }</div><div class="line">     ...</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.1.3.2 Service's Callback</h5>
<ul>
<li><b>Server General Callback</b><br />
 Server general callback function is used to send events to application which including:<ul>
<li>service register complete event <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>.</li>
<li>notification or indication send data complete event <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>.<br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_profile_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a>(app_profile_callback);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>:<span class="comment">// srv register result event.</span></div><div class="line">            ...</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>:</div><div class="line">            ...</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
</ul>
</li>
<li><b>Specify Service Callback</b><br />
 For some attributes' value is supplied by application, to access these attributes' value, service's callback functions shall be implemented in specific service, which are used to handle read / write attribute value and update CCCD value process from client. This callback function struct shall be initialized with <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a> function. Attribute element structure is defiend in <a class="el" href="profile__server_8h_source.html">profile_server.h</a>. <br />
<br />
 <div class="fragment"><div class="line"><span class="comment">/* service related callback functions struct */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#gaede6b33f181b4924f41289adf1ca4fe5">P_FUN_GATT_READ_ATTR_CB</a> read_attr_cb;          <span class="comment">// Read callback function pointer</span></div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#ga6a45cb050776603d2de30c9f40217096">P_FUN_GATT_WRITE_ATTR_CB</a> write_attr_cb;        <span class="comment">// Write callback function pointer</span></div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#ga8f4141b203c607fb2764f70e0a78df81">P_FUN_GATT_CCCD_UPDATE_CB</a> cccd_update_cb;      <span class="comment">// update cccd callback function pointer</span></div><div class="line">} <a class="code" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html">T_FUN_GATT_SERVICE_CBS</a>;</div></div><!-- fragment --> <br />
 Attribute read callback: <b>read_attr_cb</b><br />
 When the client side expects to read the attribute value, read_attr_cb is used to notify the application to provide the read value.<br />
 Attribute write callback: <b>write_attr_cb</b><br />
 Attribute write callback, When the client side expects to write the attribute value, write_attr_cb is used to notify the application of the value written by the client.<br />
 Client characteristic configuration descriptor value update callback: <b>cccd_update_cb</b><br />
 When the client side expects to update CCCD , cccd_update_cb is used to notify the application of the CCCD value.<br />
 <br />
 <div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html">T_FUN_GATT_SERVICE_CBS</a> simp_ble_service_cbs =</div><div class="line">{</div><div class="line">    simp_ble_service_attr_read_cb,  <span class="comment">// Read callback function pointer</span></div><div class="line">    simp_ble_service_attr_write_cb, <span class="comment">// Write callback function pointer</span></div><div class="line">    simp_ble_service_cccd_update_cb <span class="comment">// CCCD update callback function pointer</span></div><div class="line">};</div></div><!-- fragment --> <br />
</li>
<li><b>Write Indication Post Procedure Callback</b><br />
 Write indication post procedure callback function is used to execute some post procedure after handling write request from client. This call back function is initialized in write attribute callback function. If no more post procedure will be executed, the pointer of <b>p_write_post_proc</b> in write attribute callback function shall be assigned with null. Write indication post procedure callback function is defined in <a class="el" href="profile__server_8h_source.html">profile_server.h</a>.</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.3.3 Characteristic Value Read</h5>
<p>This procedure is used to read a characteristic value from a server. There are four sub-procedures that can be used to read a characteristic value, including:</p><ul>
<li>read characteristic value</li>
<li>read using characteristic UUID</li>
<li>read long characteristic values</li>
<li>read multiple characteristic values.</li>
</ul>
<p>If a attribute wants to be readable, it shall be configured with readable perimissions. Attribute value can be read from service or application by using different attribute flag.</p>
<p><b>Attribute Value Supply in Attribute Element</b></p>
<p>Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> and it may involve to this procedure.</p>
<div class="fragment"><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a>,                         <span class="comment">/* flags */</span></div><div class="line">    {                                               <span class="comment">/* type_value */</span></div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(0x2A04),</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(0x2A04),</div><div class="line">        100,</div><div class="line">        200,</div><div class="line">        0,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(2000),</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(2000)</div><div class="line">    },</div><div class="line">    5,                                              <span class="comment">/* bValueLen */</span></div><div class="line">    <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                                  <span class="comment">/* permissions */</span></div><div class="line">},</div></div><!-- fragment --><p> The procedure executed between each layer is shown in Figure 3-4. Protocol stack layer will read value in attribute element, and response attribute value in read response directly.</p>
<div class="image">
<img src="profile_read_supply_in_attribute.png" alt="profile_read_supply_in_attribute.png"/>
</div>
 <center><div id="figure_3_4"><b>Figure 3-4 Read Characteristic Value - Attribute Value Supply in Attribute Element </b></div></center><p><b>Attribute Value Supply by Application without Result Pending</b></p>
<p>Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> and it may involve to this procedure. </p><div class="fragment"><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a>,</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga6e9956e003767612a2d8ffdd1c29e07f">GATT_UUID_CHAR_SIMPLE_V1_READ</a>),</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga6e9956e003767612a2d8ffdd1c29e07f">GATT_UUID_CHAR_SIMPLE_V1_READ</a>)</div><div class="line">    },</div><div class="line">    0,</div><div class="line">    <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">    <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a></div><div class="line">},</div></div><!-- fragment --><p>The procedure executed between each layer is shown in Figure 3-5. When handling read request, protocol stack will send read indication to profile server layer, and profile server layer will get the value in specific service by calling read attribute callback. Following that, profile server layer will return the data to GATT layer through read confirmation.</p>
<div class="image">
<img src="profile_read_supply_by_application_without.png" alt="profile_read_supply_by_application_without.png"/>
</div>
 <center><div id="figure_3_5"><b>Figure 3-5 Read Characteristic Value - Attribute Value Supply by Application Without Result Pending </b></div></center><p>The sample code is shown below, and app_profile_callback shall return with result APP_RESULT_SUCCESS:</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7a84062d7216785555446ac9bf65f4e6a7">SERVICE_CALLBACK_TYPE_READ_CHAR_VALUE</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a33e4249eb6be718fef909fd0f9f60dba">read_value_index</a> == <a class="code" href="group___s_i_m_p___service___read___info.html#gaf02b25189ebccdb9412cd449099daac5">SIMP_READ_V1</a>)</div><div class="line">                {</div><div class="line">                    uint8_t value[2] = {0x01, 0x02};</div><div class="line">                    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_READ_V1&quot;</span>);</div><div class="line">                    <a class="code" href="group___s_i_m_p___service___exported___functions.html#gaa29100fb1c2f5e6a5ff98f2ad193dacb">simp_ble_service_set_parameter</a>(<a class="code" href="group___s_i_m_p___service___application___parameters.html#gga6009accdec69dbabca17ccf779751722a5e33be9e87bc045ca06bfb88d3f25d4b">SIMPLE_BLE_SERVICE_PARAM_V1_READ_CHAR_VAL</a>, 2, &amp;value);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --><p><b>Attribute Value Supply by Application with Result Pending</b></p>
<p>Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> and it may involve to this procedure. For some reason, attribute value from application can't be read immediately. In this case, read confirmation shall be invoked by specify service itself. The procedure executed between each layer is shown in Figure 3-6.</p>
<div class="image">
<img src="profile_read_supply_by_application_pending.png" alt="profile_read_supply_by_application_pending.png"/>
</div>
 <center><div id="figure_3_6"><b>Figure 3-6 Read Characteristic Value - Attribute Value Supply by Application With Result Pending </b></div></center><p>The sample code is shown below, and app_profile_callback shall return with result APP_RESULT_PENDING:</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a9f877e20e6ad5feed31bf5f59346ae2d">APP_RESULT_PENDING</a>;</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7a84062d7216785555446ac9bf65f4e6a7">SERVICE_CALLBACK_TYPE_READ_CHAR_VALUE</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a33e4249eb6be718fef909fd0f9f60dba">read_value_index</a> == <a class="code" href="group___s_i_m_p___service___read___info.html#gaf02b25189ebccdb9412cd449099daac5">SIMP_READ_V1</a>)</div><div class="line">                {</div><div class="line">                    uint8_t value[2] = {0x01, 0x02};</div><div class="line">                    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_READ_V1&quot;</span>);</div><div class="line">                    <a class="code" href="group___s_i_m_p___service___exported___functions.html#gaa29100fb1c2f5e6a5ff98f2ad193dacb">simp_ble_service_set_parameter</a>(<a class="code" href="group___s_i_m_p___service___application___parameters.html#gga6009accdec69dbabca17ccf779751722a5e33be9e87bc045ca06bfb88d3f25d4b">SIMPLE_BLE_SERVICE_PARAM_V1_READ_CHAR_VAL</a>, 2, &amp;value);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.1.3.4 Characteristic Value Write</h5>
<p>This procedure is used to write a characteristic value to a server. There are five sub-procedures that can be used to write a characteristic value, including:</p><ul>
<li>write without response</li>
<li>signed write without response</li>
<li>write characteristic value</li>
<li>write long characteristic values</li>
<li>reliable writes <br />
</li>
</ul>
<ol type="1">
<li>Write Characteristic Value<ul>
<li><b>Attribute Value Supply in Attribute Element</b> <br />
<br />
 Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> and it may involve to this procedure. The procedure executed between each layer is shown in Figure 3-7. The write request is used to request the server to write the value of an attribute and acknowledge that this has been achieved with a write response directly. <br />
<br />
 <div class="image">
<img src="profile_write_supply_in_attribute.png" alt="profile_write_supply_in_attribute.png"/>
</div>
 <center><div id="figure_3_7"><b>Figure 3-7 Write Characteristic Value - Attribute Value Supply in Attribute Element </b></div></center> <br />
<br />
</li>
<li><b>Attribute Value Supply by Application without Result Pending</b> <br />
<br />
 Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> and it may involve to this procedure. The procedure executed between each layer is shown in Figure 3-8. When handling write request, protocol stack will send write request indication to profile server layer, and profile server layer will write the value to specific service by calling write attribute callback. Following that, Profile server layer will return write result through write request confirmation. Optionally, if server need to execute more subsequent procedure after profile server layer returns write confirm, the pointer of callback function <b>write_ind_post_proc</b> will be invoked if it isn't null. <br />
<br />
 <div class="image">
<img src="profile_write_supply_by_application_without.png" alt="profile_write_supply_by_application_without.png"/>
</div>
 <center><div id="figure_3_8"><b>Figure 3-8 Write Characteristic Value - Attribute Value Supply by Application Without Result Pending </b></div></center> <br />
 The sample code is shown below and app_profile_callback shall return with result <a class="el" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>. Application will be notified with <b>srv_cbs</b> registerred by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>. And the <b>write_type</b> will be <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga07c105220cd4d1b097c670b9d2841114a95e45bfe2fd04a2ffe173dfeebcac493">WRITE_REQUEST</a>. <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line"></div><div class="line">             <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7af703b5b6b80a4d6ce89f9e7e46163199">SERVICE_CALLBACK_TYPE_WRITE_CHAR_VALUE</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a5c1b56e6bccc2a95dbddf1a08e56e87d">opcode</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___write___info.html#ga078baadd237775e5b7033ddf09fc24b6">SIMP_WRITE_V2</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;SIMP_WRITE_V2: write type %d, len %d&quot;</span>, p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a9fa22f41670984ebc874937ebc9dd3f5">write_type</a>,</div><div class="line">                                        p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a8aed22e2c7b283705ec82e0120515618">len</a>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Attribute Value Supply by Application with Result Pending</b> <br />
<br />
 Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> and it may involve to this procedure. If writing attribute value result can not be completed immediately, write request confirmation shall be invoked by specific service itself. The procedure executed between each layer is shown in Figure 3-9. Write indication post procedure is optional. <br />
<br />
 <div class="image">
<img src="profile_write_supply_by_application_pending.png" alt="profile_write_supply_by_application_pending.png"/>
</div>
 <center><div id="figure_3_9"><b>Figure 3-9 Write Characteristic Value - Attribute Value Supply by Application With Result Pending </b></div></center> <br />
<br />
 Application will be notified with <b>srv_cbs</b> registerred by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>. And the <b>write_type</b> will be <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga07c105220cd4d1b097c670b9d2841114a95e45bfe2fd04a2ffe173dfeebcac493">WRITE_REQUEST</a>. The sample code is shown below and app_profile_callback shall return with result <a class="el" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a9f877e20e6ad5feed31bf5f59346ae2d">APP_RESULT_PENDING</a>. <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a9f877e20e6ad5feed31bf5f59346ae2d">APP_RESULT_PENDING</a>;</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7af703b5b6b80a4d6ce89f9e7e46163199">SERVICE_CALLBACK_TYPE_WRITE_CHAR_VALUE</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a5c1b56e6bccc2a95dbddf1a08e56e87d">opcode</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___write___info.html#ga078baadd237775e5b7033ddf09fc24b6">SIMP_WRITE_V2</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;SIMP_WRITE_V2: write type %d, len %d&quot;</span>, p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a9fa22f41670984ebc874937ebc9dd3f5">write_type</a>,</div><div class="line">                                        p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a0aecfe1e480658dc54ab9ae90d065be0">write</a>.<a class="code" href="struct_t_s_i_m_p___w_r_i_t_e___m_s_g.html#a8aed22e2c7b283705ec82e0120515618">len</a>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Write CCCD Value</b> <br />
<br />
 If receiving write request from client of writing characteristic configuration declaration, protocol stack will update CCCD information, and profile server layer will update CCCD information to application with update CCCD callback function. The procedure executed between each layer is shown in Figure 3-10. <br />
<br />
 <div class="image">
<img src="profile_write_cccd.png" alt="profile_write_cccd.png"/>
</div>
 <center><div id="figure_3_10"><b>Figure 3-10 Write Characteristic Value - Write CCCD Value </b></div></center> <br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> simp_ble_service_cccd_update_cb(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, uint16_t index,</div><div class="line">                                     uint16_t cccbits)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> callback_data;</div><div class="line">    <span class="keywordtype">bool</span> is_handled = <span class="keyword">false</span>;</div><div class="line">    callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a> = conn_id;</div><div class="line">    callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a> = <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>;</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;simp_ble_service_cccd_update_cb: index = %d, cccbits 0x%x&quot;</span>, index, cccbits);</div><div class="line">    <span class="keywordflow">switch</span> (index)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> SIMPLE_BLE_SERVICE_CHAR_NOTIFY_CCCD_INDEX:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (cccbits &amp; <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga30626766a65551424d839b4a50217c6a">GATT_CLIENT_CHAR_CONFIG_NOTIFY</a>)</div><div class="line">            {</div><div class="line">                <span class="comment">// Enable Notification</span></div><div class="line">                callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a> = <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga18622464158f0f8e8dee4322e53fd7fc">SIMP_NOTIFY_INDICATE_V3_ENABLE</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="comment">// Disable Notification</span></div><div class="line">                callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a> = <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga0980392b0636a27e85adfec6e4f980a8">SIMP_NOTIFY_INDICATE_V3_DISABLE</a>;</div><div class="line">            }</div><div class="line">            is_handled =  <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> SIMPLE_BLE_SERVICE_CHAR_INDICATE_CCCD_INDEX:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (cccbits &amp; <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga0aff5024fc5440d802040d5149e95724">GATT_CLIENT_CHAR_CONFIG_INDICATE</a>)</div><div class="line">            {</div><div class="line">                <span class="comment">// Enable Indication</span></div><div class="line">                callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a> = <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga14507f3a5594feab7984534d9c3fc097">SIMP_NOTIFY_INDICATE_V4_ENABLE</a>;</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="comment">// Disable Indication</span></div><div class="line">                callback_data.<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a> = <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga90e15e6bbc694b7c2311c8058e8f7046">SIMP_NOTIFY_INDICATE_V4_DISABLE</a>;</div><div class="line">            }</div><div class="line">            is_handled =  <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    <span class="comment">/* Notify Application. */</span></div><div class="line">    <span class="keywordflow">if</span> (pfn_simp_ble_service_cb &amp;&amp; (is_handled == <span class="keyword">true</span>))</div><div class="line">    {</div><div class="line">        pfn_simp_ble_service_cb(service_id, (<span class="keywordtype">void</span> *)&amp;callback_data);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <br />
<br />
 Application will be notified with <b>srv_cbs</b> registerred by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>. And the <b>msg_type</b> will be <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>. <br />
<br />
 <div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line">                            <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga18622464158f0f8e8dee4322e53fd7fc">SIMP_NOTIFY_INDICATE_V3_ENABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_NOTIFY_INDICATE_V3_ENABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga0980392b0636a27e85adfec6e4f980a8">SIMP_NOTIFY_INDICATE_V3_DISABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_NOTIFY_INDICATE_V3_DISABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga14507f3a5594feab7984534d9c3fc097">SIMP_NOTIFY_INDICATE_V4_ENABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_NOTIFY_INDICATE_V4_ENABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga90e15e6bbc694b7c2311c8058e8f7046">SIMP_NOTIFY_INDICATE_V4_DISABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;SIMP_NOTIFY_INDICATE_V4_DISABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
</ul>
</li>
<li>Write Without Response / Signed Write Without Response <br />
<br />
 The difference between write characteristic value procedure and write without response / signed write without response procedure is that server shall not response write result to client, and application will not be notified with any callback. <br />
<br />
<ul>
<li><b>Attribute Value Supply in Attribute Element</b> <br />
<br />
 Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> and it may involve to this procedure. The procedure executed between each layer is shown in Figure 3-11. <br />
<br />
 <div class="image">
<img src="profile_write_without_supply_in_attribute.png" alt="profile_write_without_supply_in_attribute.png"/>
</div>
 <center><div id="figure_3_11"><b>Figure 3-11 Write Without Response / Signed Write Without Response - Attribute Value Supply in Attribute Element </b></div></center> <br />
<br />
</li>
<li><b>Attribute Value Supply by Application</b> <br />
<br />
 Attribute of its flag is <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> and it may involve to this procedure. The procedure executed between each layer is shown in Figure 3-12. <b>write_attr_cb</b> registered by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a> will be called. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#gaede6b33f181b4924f41289adf1ca4fe5">P_FUN_GATT_READ_ATTR_CB</a> read_attr_cb;          </div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#ga6a45cb050776603d2de30c9f40217096">P_FUN_GATT_WRITE_ATTR_CB</a> write_attr_cb;        </div><div class="line">    <a class="code" href="group___p___f_u_n___s_e_r_v_e_r___s_p_e_c_i_f_i_c___c_b.html#ga8f4141b203c607fb2764f70e0a78df81">P_FUN_GATT_CCCD_UPDATE_CB</a> cccd_update_cb;        </div><div class="line">} <a class="code" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html">T_FUN_GATT_SERVICE_CBS</a>;</div></div><!-- fragment --> Application will be notified with <b>srv_cbs</b> registerred by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>. And the <b>write_type</b> will be <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga07c105220cd4d1b097c670b9d2841114aa391b62e14b0d860d74927e63a23b65c">WRITE_WITHOUT_RESPONSE</a> or <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga07c105220cd4d1b097c670b9d2841114a8ab8293a9eddf198ec94fc28a28309a2">WRITE_SIGNED_WITHOUT_RESPONSE</a>. <br />
<br />
 <div class="image">
<img src="profile_write_without_supply_by_application.png" alt="profile_write_without_supply_by_application.png"/>
</div>
 <center><div id="figure_3_12"><b>Figure 3-12 Write Without Response / Signed Write Without Response - Attribute Value Supply by Application </b></div></center> <br />
<br />
</li>
<li><b>Write CCCD Value</b> <br />
<br />
 The procedure executed between each layer is shown in Figure 3-13. <br />
<br />
 <div class="image">
<img src="profile_write_without_cccd.png" alt="profile_write_without_cccd.png"/>
</div>
 <center><div id="figure_3_13"><b>Figure 3-13 Write Without Response / Signed Write Without Response - Write CCCD Value </b></div></center> <br />
</li>
</ul>
</li>
<li>Write Long Characteristic Values <br />
<br />
<ul>
<li><b>Prepare Write</b> <br />
<br />
 If the characteristic value is longer than that can be sent in a single write request attribute protocol message, prepare write request will be used by client. when profile server layer handles the prepare write request indication, the write values are stored in profile server layer buffer first and profile server layer will response prepare write confirmation. This procedure executed between each layer is shown in Figure 3-14. <br />
<br />
 <div class="image">
<img src="profile_write_long_prepare_write.png" alt="profile_write_long_prepare_write.png"/>
</div>
 <center><div id="figure_3_14"><b>Figure 3-14 Write Long Characteristic Values / Reliable Writes - Prepare Write Procedure </b></div></center> <br />
<br />
</li>
<li><b>Execute Write without Result Pending</b> <br />
<br />
 After prepare write, execute write request is used to write complete value. Application will be notified with <b>srv_cbs</b> registered by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>. And the <b>write_type</b> will be <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga07c105220cd4d1b097c670b9d2841114a9577b36fc4a1cd3273b5b205a0fe52a9">WRITE_LONG</a>. Write indication post procedure is optional. This procedure executed between each layer is shown in Figure 3-15. <br />
<br />
 <div class="image">
<img src="profile_write_long_execute_without.png" alt="profile_write_long_execute_without.png"/>
</div>
 <center><div id="figure_3_15"><b>Figure 3-15 Write Long Characteristic Values / Reliable Writes - Execute Write Without Result Pending </b></div></center> <br />
<br />
</li>
<li><b>Execute Write with Result Pending</b> <br />
<br />
 If write value can't be completed immediately, execute write confirmation shall be invoked by specify service itself. Write indication post procedure is optional. This procedure executed between each layer is shown in Figure 3-16 <br />
<br />
 <div class="image">
<img src="profile_write_long_execute_pending.png" alt="profile_write_long_execute_pending.png"/>
</div>
 <center><div id="figure_3_16"><b>Figure 3-16 Write Long Characteristic Values / Reliable Writes - Execute Write With Result Pending </b></div></center></li>
</ul>
</li>
</ol>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.3.5 Characteristic Value Notification</h5>
<p>This procedure is used to notify a client of the value of a characteristic value from a server. Service sends data by actively invoking <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga60d379433a73a0e377e4ad3dda22ac1c">server_send_data</a> function. After send data procedure is completed, it is optional to inform application by server general callback function. This procedure executed between each layer is shown in Figure 3-17</p>
<div class="image">
<img src="profile_server_notification.png" alt="profile_server_notification.png"/>
</div>
 <center><div id="figure_3_17"><b>Figure 3-17 Characteristic Value Notification </b></div></center><p> <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga8d644966c8211083be66835b367d2f4c">simp_ble_service_send_v3_notify</a>(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_value,</div><div class="line">                                     uint16_t length)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;simp_ble_service_send_v3_notify&quot;</span>);</div><div class="line">    <span class="comment">// send notification to client</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga60d379433a73a0e377e4ad3dda22ac1c">server_send_data</a>(conn_id, service_id, SIMPLE_BLE_SERVICE_CHAR_V3_NOTIFY_INDEX, p_value,</div><div class="line">                            length,<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ggadc8629288ad4dc04523014696c756e04a0822a5e97023e0da17c29e7485c36e52">GATT_PDU_TYPE_ANY</a>);</div><div class="line">}</div></div><!-- fragment --><p>Because notification does not require a response, notification does not have any flow control in the ATT layer. However, because of the limitation of resource, our bt protocal stack has flow control for notification. Flow control for notification is implemented with a credits value maintained in GAP layer, which allows APP to send notification in number of credits, without waiting for response from BT stack. BT stack can cache the data of the notification in number of credits for the upper layer.</p>
<ul>
<li>Credit count decreases by one when profile server layer sends notification to BT stack.</li>
<li>Credit count increases by one when profile server layer receives the response from BT stack. When the notification is sent to air, BT stack will send response to profile server layer.</li>
<li>Notification shall only be sent when credit count is greater than zero.</li>
</ul>
<p>if APP wants to send multiple data to BT protocal stack. Firstly APP can call <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga98fbde07c878c872f1af36ce1363ccc5">le_get_gap_param</a> to get credit. If credit &gt; 0, it means the BT protocol stack still has buffer cache data, and the APP can send data to the BT protocol stack. if credit is 0, it means that the BT protocol stack has no more buffer cache data, and the Notification needs to wait for the buffer to be released before sending it. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> test(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/*get remain credit*/</span></div><div class="line">    uint8_t credit;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga98fbde07c878c872f1af36ce1363ccc5">le_get_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea82fe88a02906a2d53b27fbe341403fc5">GAP_PARAM_LE_REMAIN_CREDITS</a>, &amp;credit);</div><div class="line"></div><div class="line">    <span class="comment">/*If multiple data need to be sent*/</span></div><div class="line">    <span class="keywordflow">while</span> (credit &gt; 0)</div><div class="line">    {</div><div class="line">        ......</div><div class="line">        <span class="comment">/*If credit &gt; 0, the BT protocol stack still has buffer cache data, and the APP can send data to the BT protocol stack*/</span></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga60d379433a73a0e377e4ad3dda22ac1c">server_send_data</a>(conn_id, service_id, attr_idx,</div><div class="line">                            data, data_length, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ggadc8629288ad4dc04523014696c756e04a54d0b92a538dd91649ac58e51b188969">GATT_PDU_TYPE_NOTIFICATION</a>))</div><div class="line">        {</div><div class="line">            credit--;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/*if credit is 0, It means that the BT protocol stack has no more buffer cache data, </span></div><div class="line"><span class="comment">    and the Notification needs to wait for the buffer to be released before sending it.*/</span></div><div class="line">}</div></div><!-- fragment --><p> After Notification data is sent successfully, Service callback function can be informed the current credit. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_xxx_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;eventId)</div><div class="line">        {</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>:</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;app_xxx_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE conn_id %d, cause 0x%x, service_id %d, attrib_idx 0x%x, credits %d&quot;</span>,</div><div class="line">                            p_param-&gt;event_data.send_data_result.conn_id,</div><div class="line">                            p_param-&gt;event_data.send_data_result.cause,</div><div class="line">                            p_param-&gt;event_data.send_data_result.service_id,</div><div class="line">                            p_param-&gt;event_data.send_data_result.attrib_idx,</div><div class="line">                            p_param-&gt;event_data.send_data_result.credits);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (p_param-&gt;event_data.send_data_result.cause == <a class="code" href="group___b_t___t_y_p_e_s.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_xxx_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE success&quot;</span>);</div><div class="line">                uint8_t credit = p_param-&gt;event_data.send_data_result.credits;</div><div class="line"></div><div class="line">                <span class="comment">/*Buffer has been freed, if more data still needs to be sent*/</span></div><div class="line">                <span class="keywordflow">while</span> (credit &gt; 0)</div><div class="line">                {</div><div class="line">                    ......</div><div class="line">                    <span class="keywordflow">if</span> (<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga60d379433a73a0e377e4ad3dda22ac1c">server_send_data</a>(conn_id, service_id, attr_idx,</div><div class="line">                                        data, data_length, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ggadc8629288ad4dc04523014696c756e04a54d0b92a538dd91649ac58e51b188969">GATT_PDU_TYPE_NOTIFICATION</a>))</div><div class="line">                    {</div><div class="line">                        credit--;</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;app_xxx_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE failed&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.1.3.6 Characteristic Value Indication</h5>
<p>This procedure is used to indicate client of the value of a characteristic value from a server. Once the indication is received, the client shall respond with a confirmation. After receiving handle value confirmation, it is optional to inform application by server general callback function. This procedure executed between each layer is shown in Figure 3-18</p>
<div class="image">
<img src="profile_server_indication.png" alt="profile_server_indication.png"/>
</div>
 <center><div id="figure_3_18"><b>Figure 3-18 Characteristic Value Indication </b></div></center><p> <br />
<br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga1ce4a85c68f96d9c00d944802265ff73">simp_ble_service_send_v4_indicate</a>(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_value,</div><div class="line">                                       uint16_t length)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;simp_ble_service_send_v4_indicate&quot;</span>);</div><div class="line">    <span class="comment">// send indication to client</span></div><div class="line">    <span class="keywordflow">return</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga60d379433a73a0e377e4ad3dda22ac1c">server_send_data</a>(conn_id, service_id, SIMPLE_BLE_SERVICE_CHAR_V4_INDICATE_INDEX, p_value,</div><div class="line">                            length, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ggadc8629288ad4dc04523014696c756e04a0822a5e97023e0da17c29e7485c36e52">GATT_PDU_TYPE_ANY</a>);</div><div class="line">}</div></div><!-- fragment --><p> app_profile_callback will be called after handle value confirmation. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_profile_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">                ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>:</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;PROFILE_EVT_SEND_DATA_COMPLETE: conn_id %d, cause 0x%x, service_id %d, attrib_idx 0x%x, credits %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a094c03474c2092d3d653930fecb969e8">service_id</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#ad5892381ad0f7e319f5b34de243258df">attrib_idx</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a607393b49e6ef198a64152b0ba95ca31">credits</a>);</div><div class="line">            <span class="keywordflow">if</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a> == <a class="code" href="group___b_t___t_y_p_e_s.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;PROFILE_EVT_SEND_DATA_COMPLETE success&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;PROFILE_EVT_SEND_DATA_COMPLETE failed&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div></div><!-- fragment --><h4><a class="anchor" id="PROFILE_SERVER_IMPLEMENT_SPECIFIC_SERVICE"></a>
3.1.4 Implement Specific Service</h4>
<p>This chapter gives us simple description of implementation of specific services. A profile is composed of one or more services required to fulfill a use case. A service is composed of characteristics. Each characteristic contains a value and optional information about the value. The service, characteristic and components of characteristic (i.e. value and descriptors) contain the profile data and they are all stored in attributes on the server.</p>
<p>The guideline on how to develop a specific service is as follows:</p>
<ul>
<li>Define Service and Profile Spec.</li>
<li>Define Service Attribute Table.</li>
<li>Define interface between Service and App.</li>
<li>Define <b>xxx_add_service()</b>, <b>xxx_set_parameter()</b>, <b>xxx_notify()</b>, <b>xxx_indicate()</b> API, etc.</li>
<li>Implement <b>xxx_ble_service_cbs</b> with type of <a class="el" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html">T_FUN_GATT_SERVICE_CBS</a> APIs.</li>
</ul>
<p>In this chapter, we will take simple ble service as an example to give you a guide on how to implement a specific service. You can refer to source code in simple_ble_service.c and <a class="el" href="simple__ble__service_8h_source.html">simple_ble_service.h</a> for more details.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.4.1 Define Service and Profile Spec</h5>
<p>In order to implement a specific service, we need to define the service and profile spec. The simple ble service and profile spec have been defined here, and you can refer to <a class="el" href="group___s_i_m_p___service.html">Simple Ble Service</a> for details.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.4.2 Define Service Table</h5>
<p>Service are defined by a service table, which consists of many services. And a service inlcudes many attribute elements.</p>
<p><a class="anchor" id="invalid"></a></p><h6>3.1.4.2.1 Attribute Element</h6>
<p>Attribute element is basic union of service. The structure of attribute element is defiend in <a class="el" href="gatt_8h_source.html">gatt.h</a>.</p>
<div class="fragment"><div class="line"><span class="comment">/* attribute element struct */</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint16_t    flags;               <span class="comment">// Attribute flags \ref GATT_ATTRIBUTE_FLAG</span></div><div class="line">    uint8_t     type_value[2 + 14];  <span class="comment">// 16 bit UUID + included value or 128 bit UUID</span></div><div class="line">    uint16_t    value_len;           <span class="comment">// Length of value */</span></div><div class="line">    <span class="keywordtype">void</span>        *p_value_context;    <span class="comment">// Point to an immutable constant. and shall not be used when flag is \ref ATTRIB_FLAG_VALUE_INCL or \ref ATTRIB_FLAG_VALUE_APPL.</span></div><div class="line">    uint32_t    permissions;         <span class="comment">// Attribute permission \ref GATT_ATTRIBUTE_PERMISSIONS</span></div><div class="line">} <a class="code" href="struct_t___a_t_t_r_i_b___a_p_p_l.html">T_ATTRIB_APPL</a>;</div></div><!-- fragment --><p><b>flags</b></p>
<p>Flags option value and description are shown in Table 3-4.</p>
<center><div id="table_3_4"><b>Table 3-4 Flags Option Value And Description </b></div></center> <div class="image">
<img src="profile_flags_value.png" alt="profile_flags_value.png"/>
</div>
<p>Note:</p>
<p><a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9ed938e151847702c51963b47cc099ac">ATTRIB_FLAG_LE</a> can be used only by attribute in type of primary service declaration, to indicate that primary service allows LE link access.</p>
<p><a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga3fac5404c6b558183c66370c68c4e10d">ATTRIB_FLAG_VOID</a>, ATTRIB_FLAG_VALUE_INCL and ATTRIB_FLAG_VALUE_APPL shall be used only one on an attribute element.</p>
<p><a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> flag means attribute value will put into the last fourteen bytes of type_value (the first two bytes of type_value is used to contain UUID), and value_len is the number of the bytes put into the area of the last fourteen bytes. As attribute value has been provided in type_value, p_value_context pointer is assigned with NULL.</p>
<p><a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a> flag means attribute value is provided from application. As long as the stack is involved in operation of the attribute value, it will interact with application to fulfil the corresponding operation process. As attribute value is provided by application, only UUID of attribute is required to be put into type_value, while value_len is 0 and p_value_context pointer is assigned with NULL.</p>
<p><a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga3fac5404c6b558183c66370c68c4e10d">ATTRIB_FLAG_VOID</a> flag means attribute value is neither provided in the fourteen bytes of type_value nor provided from application. Only UUID of attribute is required in type_value, while p_value_context pointer points attribute value and value_len indicates the length of the attribute value.</p>
<p>Table 3-5 shows the falgs value and actual value got by read attribute proccess. </p><div style="page-break-after: always;"></div> <center><div id="table_3_5"><b>Table 3-5 Flags Value Select Mode </b></div></center> <div class="image">
<img src="profile_flags_select_mode.png" alt="profile_flags_select_mode.png"/>
</div>
<p><b>permissions</b></p>
<p>The permissions associated with the attribute specify the security level required for read and / or write access, as well as notification and / or indication. The values of permissions are used to indicate permission of the attribute. Attribute permissions are a combination of access permissions, encryption permissions, authentication permissions and authorization permissions. And its acceptable values are given in Table 3-6. </p><center><div id="table_3_6"><b>Table 3-6 Value Of Permissions </b></div></center> <div class="image">
<img src="profile_permission_values.png" alt="profile_permission_values.png"/>
</div>
<p><a class="anchor" id="invalid"></a></p><h6>3.1.4.2.2 Service Table</h6>
<p>Service contains a group of attributes that is called service table. A service table contains various types of attributes, such as service declaration, characteristic declaration, characteristic value and characteristic descriptor declaration. An example of service table is given in Table 3-7, and it is implemented in <b>simple_ble_service.c</b> of ble_peripheral sample project. </p><center><div id="table_3_7"><b>Table 3-7 Service Table Example </b></div></center> <div class="image">
<img src="profile_service_table.png" alt="profile_service_table.png"/>
</div>
<p>Note:<br />
</p>
<p>The elements in quotation mark are UUID value, which are either defined in core spec or customized.</p>
<p><b>LE</b> is abbreviation of <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9ed938e151847702c51963b47cc099ac">ATTRIB_FLAG_LE</a><br />
</p>
<p><b>INCL</b> is abbreviation of <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a><br />
</p>
<p><b>APPL</b> is abbreviation of <a class="el" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a><br />
</p>
<p>The sample code for service table is as follows:<br />
</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___a_t_t_r_i_b___a_p_p_l.html">T_ATTRIB_APPL</a> simple_ble_service_tbl[] =</div><div class="line">{</div><div class="line">    <span class="comment">/* &lt;&lt;Primary Service&gt;&gt;, .. */</span></div><div class="line">    {</div><div class="line">        (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9ed938e151847702c51963b47cc099ac">ATTRIB_FLAG_LE</a>),  <span class="comment">/* flags     */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6cdb84bf021bfc60917741147207df25">GATT_UUID_PRIMARY_SERVICE</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6cdb84bf021bfc60917741147207df25">GATT_UUID_PRIMARY_SERVICE</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga054119128484dbbb8db6ffbae614d08d">GATT_UUID_SIMPLE_PROFILE</a>),      <span class="comment">/* service UUID */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga054119128484dbbb8db6ffbae614d08d">GATT_UUID_SIMPLE_PROFILE</a>)</div><div class="line">        },</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4778df0abc2cfce291c096e4628ff0eb">UUID_16BIT_SIZE</a>,                            <span class="comment">/* bValueLen     */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,                                       <span class="comment">/* p_value_context */</span></div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions  */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* &lt;&lt;Characteristic&gt;&gt; demo for read */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad18d3dc2be887e777685e87a19723be8">GATT_CHAR_PROP_READ</a>                     <span class="comment">/* characteristic properties */</span></div><div class="line">            <span class="comment">/* characteristic UUID not needed here, is UUID of next attrib. */</span></div><div class="line">        },</div><div class="line">        1,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga6e9956e003767612a2d8ffdd1c29e07f">GATT_UUID_CHAR_SIMPLE_V1_READ</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga6e9956e003767612a2d8ffdd1c29e07f">GATT_UUID_CHAR_SIMPLE_V1_READ</a>)</div><div class="line">        },</div><div class="line">        0,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga3fac5404c6b558183c66370c68c4e10d">ATTRIB_FLAG_VOID</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga997a683a8d062e5476f4545ddd324622">ATTRIB_FLAG_ASCII_Z</a>,     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga036199d3d5e7c0b555ae0cb4ba7b2811">GATT_UUID_CHAR_USER_DESCR</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga036199d3d5e7c0b555ae0cb4ba7b2811">GATT_UUID_CHAR_USER_DESCR</a>),</div><div class="line">        },</div><div class="line">        (<span class="keyword">sizeof</span>(v1_user_descr) - 1),                                           <span class="comment">/* bValueLen */</span></div><div class="line">        (<span class="keywordtype">void</span> *)v1_user_descr,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>           <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* &lt;&lt;Characteristic&gt;&gt; demo for write */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga1d5efd96c404cc4533e5142d4918adf9">GATT_CHAR_PROP_WRITE</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaed5b4982a5a190d4f3975441ff59ce78">GATT_CHAR_PROP_WRITE_NO_RSP</a>) <span class="comment">/* characteristic properties */</span></div><div class="line">            <span class="comment">/* characteristic UUID not needed here, is UUID of next attrib. */</span></div><div class="line">        },</div><div class="line">        1,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                          <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga1fa545bf33f4abfb4733a613d6917151">GATT_UUID_CHAR_SIMPLE_V2_WRITE</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga1fa545bf33f4abfb4733a613d6917151">GATT_UUID_CHAR_SIMPLE_V2_WRITE</a>)</div><div class="line">        },</div><div class="line">        0,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad281304472fd25c9a111147b64504fb6">GATT_PERM_WRITE</a>                             <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* &lt;&lt;Characteristic&gt;&gt;, demo for notify */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                          <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga730623fb09044f3ff589987839cc2b3e">GATT_CHAR_PROP_NOTIFY</a>)                 <span class="comment">/* characteristic properties */</span></div><div class="line">            <span class="comment">/* characteristic UUID not needed here, is UUID of next attrib. */</span></div><div class="line">        },</div><div class="line">        1,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                         <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga2ac4be14c63f98414ca653eedb3f7d38">GATT_UUID_CHAR_SIMPLE_V3_NOTIFY</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga2ac4be14c63f98414ca653eedb3f7d38">GATT_UUID_CHAR_SIMPLE_V3_NOTIFY</a>)</div><div class="line">        },</div><div class="line">        0,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaea432e630e2a11c9d559e3c22f1477ff">GATT_PERM_NONE</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* client characteristic configuration */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad635d8a11455092a560c22eecb2953a6">ATTRIB_FLAG_CCCD_APPL</a>,                 <span class="comment">/* flags */</span></div><div class="line">        {                                          <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <span class="comment">/* NOTE: this value has an instantiation for each client, a write to */</span></div><div class="line">            <span class="comment">/* this attribute does not modify this default value:                */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>), <span class="comment">/* client char. config. bit field */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>)</div><div class="line">        },</div><div class="line">        2,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad281304472fd25c9a111147b64504fb6">GATT_PERM_WRITE</a>)          <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* &lt;&lt;Characteristic&gt;&gt; demo for indicate */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gac16db52eb20cdb9585c56aecbc150faf">GATT_UUID_CHARACTERISTIC</a>),</div><div class="line">            (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga79a31c62c7a3fc2b5091dbfcada5e759">GATT_CHAR_PROP_INDICATE</a>)               <span class="comment">/* characteristic properties */</span></div><div class="line">            <span class="comment">/* characteristic UUID not needed here, is UUID of next attrib. */</span></div><div class="line">        },</div><div class="line">        1,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga4ccb0e187fec4eaa6e1b4dbd19231fb9">ATTRIB_FLAG_VALUE_APPL</a>,                     <span class="comment">/* flags */</span></div><div class="line">        {                                           <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga863b1b8b3cceb7438aed763732e737eb">GATT_UUID_CHAR_SIMPLE_V4_INDICATE</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___s_i_m_p___u_u_i_ds.html#ga863b1b8b3cceb7438aed763732e737eb">GATT_UUID_CHAR_SIMPLE_V4_INDICATE</a>)</div><div class="line">        },</div><div class="line">        0,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaea432e630e2a11c9d559e3c22f1477ff">GATT_PERM_NONE</a>                              <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">    <span class="comment">/* client characteristic configuration */</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga6d7ff5ec9538346817d85b4e1c92e091">ATTRIB_FLAG_VALUE_INCL</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad635d8a11455092a560c22eecb2953a6">ATTRIB_FLAG_CCCD_APPL</a>,                 <span class="comment">/* flags */</span></div><div class="line">        {                                         <span class="comment">/* type_value */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga988efbd41382f887ff4917e0552844c2">GATT_UUID_CHAR_CLIENT_CONFIG</a>),</div><div class="line">            <span class="comment">/* NOTE: this value has an instantiation for each client, a write to */</span></div><div class="line">            <span class="comment">/* this attribute does not modify this default value:                */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>), <span class="comment">/* client char. config. bit field */</span></div><div class="line">            <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaca9ea0b43e6c1295294304ffbe00a38e">GATT_CLIENT_CHAR_CONFIG_DEFAULT</a>)</div><div class="line">        },</div><div class="line">        2,                                          <span class="comment">/* bValueLen */</span></div><div class="line">        <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">        (<a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gaf7dfff08c78e40d0a47ba133af5ba8b2">GATT_PERM_READ</a> | <a class="code" href="group___g_a_t_t___a_t_t_r_i_b_u_t_e.html#gad281304472fd25c9a111147b64504fb6">GATT_PERM_WRITE</a>)          <span class="comment">/* permissions */</span></div><div class="line">    },</div><div class="line">};</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.1.4.3 Define interface between Service and App</h5>
<p>When a service attribute value is read or written, the notification will be passed to aplication by callback registered by application. Taking simple ble service as an example, we define a data with type <a class="el" href="group___t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> to hold notification result. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t                 conn_id;</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ga1ae3e282729216efbd709224940575a7">T_SERVICE_CALLBACK_TYPE</a> msg_type;</div><div class="line">    <a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html">TSIMP_UPSTREAM_MSG_DATA</a> msg_data;</div><div class="line">} <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a>;</div></div><!-- fragment --><p><b>msg_type</b> indicates it is a read, write or cccd update operation. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a> = 1, </div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7a84062d7216785555446ac9bf65f4e6a7">SERVICE_CALLBACK_TYPE_READ_CHAR_VALUE</a> = 2, </div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7af703b5b6b80a4d6ce89f9e7e46163199">SERVICE_CALLBACK_TYPE_WRITE_CHAR_VALUE</a> = 3, </div><div class="line">} <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ga1ae3e282729216efbd709224940575a7">T_SERVICE_CALLBACK_TYPE</a>;</div></div><!-- fragment --><p> <b>msg_data</b> holds the data of read, write or cccd update operation.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.4.4 Define xxx_add_service(), xxx_set_parameter(), xxx_notify(), xxx_indicate() API, etc.</h5>
<p><b>xxx_add_service()</b> is used to add service table to BT stack, and register a callback when service attribute was read, written or cccd updated.<br />
</p>
<p><b>xxx_set_parameter()</b>is used to set service related data from application.<br />
</p>
<p><b>xxx_notify()</b> is used to send notication data.<br />
</p>
<p><b>xxx_indicate()</b> is used to send indication data.<br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.4.5 Implement xxx_ble_service_cbs with type of  <a class="el" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html" title="GATT service callbacks. ">T_FUN_GATT_SERVICE_CBS</a> APIs</h5>
<p><b>xxx_ble_service_cbs</b> is used to handle read, write or cccd update operation from remote profile client.<br />
</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___f_u_n___g_a_t_t___s_e_r_v_i_c_e___c_b_s.html">T_FUN_GATT_SERVICE_CBS</a> simp_ble_service_cbs =</div><div class="line">{</div><div class="line">    simp_ble_service_attr_read_cb,  <span class="comment">// Read callback function pointer</span></div><div class="line">    simp_ble_service_attr_write_cb, <span class="comment">// Write callback function pointer</span></div><div class="line">    simp_ble_service_cccd_update_cb <span class="comment">// CCCD update callback function pointer</span></div><div class="line">};</div></div><!-- fragment --><p> And the callback is registered by <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a> which is called in <b>xxx_ble_service_add_service</b>. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service</a>(<span class="keywordtype">void</span> *p_func)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (<span class="keyword">false</span> == <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga0a1a154168440ec5d4621accfc44a5a0">server_add_service</a>(&amp;simp_service_id,</div><div class="line">                                    (uint8_t *)simple_ble_service_tbl,</div><div class="line">                                    <span class="keyword">sizeof</span>(simple_ble_service_tbl),</div><div class="line">                                    simp_ble_service_cbs))</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;simp_ble_service_add_service: fail&quot;</span>);</div><div class="line">        simp_service_id = 0xff;</div><div class="line">        <span class="keywordflow">return</span> simp_service_id;</div><div class="line">    }</div><div class="line"></div><div class="line">    pfn_simp_ble_service_cb = (<a class="code" href="group___p___f_u_n___s_e_r_v_e_r___g_e_n_e_r_a_l___c_b.html#ga58463a252b3e4f0362285a5e7e8cf2dd">P_FUN_SERVER_GENERAL_CB</a>)p_func;</div><div class="line">    <span class="keywordflow">return</span> simp_service_id;</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Bluetooth_LE_Profile_Client"></a>
3.2 Bluetooth LE Profile Client</h3>
<p>The purpose of this chapter is to give an overview of profile client. Profile client layer will be introduced according to the following several parts:<br />
</p>
<ul>
<li>Profile Client definition will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_OV">3.2.1 Overview</a>.</li>
<li>Supported Profile Client will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_SUPPORTED">3.2.2 Supported Clients</a>.</li>
<li>Interaction between profile client layer and bluetooth protocol stack will be introduced in chapter <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#PROFILE_CLIENT_INTERACTION">3.2.3 Profile Client Layer</a>.</li>
</ul>
<h4><a class="anchor" id="PROFILE_CLIENT_OV"></a>
3.2.1 Overview</h4>
<p>This chapter gives us simple description of the defination of profile client and profile client hierarchy.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.1.1 About Profile Client</h5>
<p>GATT profile defines how BLE devices transfer data between <b>GATT server</b> and <b>GATT client</b>. Implementation and use of <b>GATT server</b> are detailed in <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Server">3.1 Bluetooth LE Profile Server</a>. Implementation and use of <b>GATT client</b> are described here.<br />
 Client interface of profile offers developers the functions to discovery services at GATT Server, receive and handle indications and notifications from GATT Server, and make read/write request to GATT Server.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.1.2 Profile Client Hierarchy</h5>
<p>The profile client hierarchy is shown in Figure 3-19</p>
<div class="image">
<img src="profile_client_hierarchy.png" alt="profile_client_hierarchy.png"/>
</div>
 <center><div id="figure_3_19"><b>Figure 3-19 Profile Client Hierarchy </b></div></center><p>The content of profile includes profile client layer and specific profile client. Profile client layer is above protocol stack and it encapsulates interfaces for specific client to access protocol stack. Therefore the development of specific clients can consider less protocol stack process, making the design simplier and clearer. Specific client is implemented by application layer which is based on the profile client layer. Implementation of specific profile client is quite different from that of profile service. Profile client does not involve attribute table, and it uses functions to collect and acquire information instead of providing service and information.</p>
<h4><a class="anchor" id="PROFILE_CLIENT_SUPPORTED"></a>
3.2.2 Supported Clients</h4>
<p>This chapter gives us simple description of supported clients. Supported clients list is shown below.</p>
<center><div id="table_3_8"><b>Table 3-8 Clients List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Terms  </th><th class="markdownTableHeadLeft">Definitions  </th><th class="markdownTableHeadLeft">Interface   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">GAP Client  </td><td class="markdownTableBodyLeft">Attribute Service Client  </td><td class="markdownTableBodyLeft"><a class="el" href="group___g_a_p_s___client.html">GAP Service Client</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">BAS Client  </td><td class="markdownTableBodyLeft">Battery Service Client  </td><td class="markdownTableBodyLeft"><a class="el" href="group___b_a_s___c_l_i_e_n_t.html">Battery Service Client</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">ANCS Client  </td><td class="markdownTableBodyLeft">Apple Notification Center Service Client  </td><td class="markdownTableBodyLeft"><a class="el" href="group___a_n_c_s___c_l_i_e_n_t.html">ANCS Client</a>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">SIMP Client  </td><td class="markdownTableBodyLeft">Simple BLE Service Client  </td><td class="markdownTableBodyLeft"><a class="el" href="group___s_i_m_p___client.html">Simple BLE Service Client</a>   </td></tr>
</table>
<h4><a class="anchor" id="PROFILE_CLIENT_INTERACTION"></a>
3.2.3 Profile Client Layer</h4>
<p>This chapter gives us simple description of profile client layer. Profile client layer handles interaction with protocol stack layer, and provides interfaces to design specific client. Client will discover services and characteristics of server, read and write attribute, receive and handle notifications and indications from server.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.3.1 Client General Callback</h5>
<p>Client general callback function is used to send <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga85ebe07880c727d884cfd93e61bacacd" title="Send discovery all primary services request. ">client_all_primary_srv_discovery()</a> result to application when client_id is <a class="el" href="group___g_a_t_t___client___common___exported___macros.html#ga94e1b4c7a2509ddd01c4519683160525">CLIENT_PROFILE_GENERAL_ID</a>. This callback function can be initialized with <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga0322d316c79d74ed656cca4f77f3af56">client_register_general_client_cb</a> function. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_profile_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a>(3);</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_t_t___client___exported___functions.html#ga0322d316c79d74ed656cca4f77f3af56">client_register_general_client_cb</a>(app_client_callback);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_srvdis(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    uint8_t conn_id = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line"></div><div class="line">    cause = <a class="code" href="group___g_a_t_t___client___exported___functions.html#ga85ebe07880c727d884cfd93e61bacacd">client_all_primary_srv_discovery</a>(conn_id, <a class="code" href="group___g_a_t_t___client___common___exported___macros.html#ga94e1b4c7a2509ddd01c4519683160525">CLIENT_PROFILE_GENERAL_ID</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_client_callback: client_id %d, conn_id %d&quot;</span>,</div><div class="line">                    client_id, conn_id);</div><div class="line">    <span class="keywordflow">if</span> (client_id == <a class="code" href="group___g_a_t_t___client___common___exported___macros.html#ga94e1b4c7a2509ddd01c4519683160525">CLIENT_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html">T_CLIENT_APP_CB_DATA</a> *p_client_app_cb_data = (<a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html">T_CLIENT_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_client_app_cb_data-&gt;<a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html#a70b1275c6f7ff519922dfba8c350c1f4">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___general__cb__data.html#gga7b98a0f6df8596398cbb3314d955ae00a763d2c5ecbc047886c29010fb652f5c0">CLIENT_APP_CB_TYPE_DISC_STATE</a>:</div><div class="line">            ......</div><div class="line">}</div></div><!-- fragment --><p> If APP does not use <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga85ebe07880c727d884cfd93e61bacacd" title="Send discovery all primary services request. ">client_all_primary_srv_discovery()</a> with CLIENT_PROFILE_GENERAL_ID, APP does not need to register this general callback.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.3.2 Specify Client Callback</h5>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.2.1 Add Client</h6>
<p>Profile client layer maintains information of all specific clients which are added. The number of total client table to be added shall be initialized first, and profile client layer provides <a class="el" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a> function to initialize client table number. Profile client layer provides <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga3fb7b464e7189d637bad5b4a76fbc651">client_register_spec_client_cb</a> interface to register specific client callbacks. The client layer contains serval specific client tables is shown in Figure 3-20. Specific client is added from APP to Profile Client Layer, and a client id is returned to each specific client added. Application will record this client id for the implementation of subsequent data interaction process.</p>
<div class="image">
<img src="profile_add_clients.png" alt="profile_add_clients.png"/>
</div>
 <center><div id="figure_3_20"><b>Figure 3-20 Add Specific Clients To Profile Client Layer </b></div></center><p><a class="anchor" id="invalid"></a></p><h6>3.2.3.2.2 Callbacks</h6>
<p>Specific client's callback functions shall be implemented in specific client module. The specific client callback structure is defiend in <a class="el" href="profile__client_8h_source.html">profile_client.h</a>.<br />
 </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#gaede3bf166a818611c3f076d1ad813887">P_FUN_DISCOVER_STATE_CB</a>    discover_state_cb;   </div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#gab967430ed4c785d66e0758be7a18325f">P_FUN_DISCOVER_RESULT_CB</a>   discover_result_cb;  </div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#gac96af4e5079bc6dc771c9551be9e9df4">P_FUN_READ_RESULT_CB</a>       read_result_cb;      </div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#gaf23fc6ba51f7615cde15c20f5985622d">P_FUN_WRITE_RESULT_CB</a>      write_result_cb;     </div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#ga675388393f298846a13dcad58dcff694">P_FUN_NOTIFY_IND_RESULT_CB</a> notify_ind_result_cb;</div><div class="line">    <a class="code" href="group___t___f_u_n___c_l_i_e_n_t___c_b_s___d_e_f.html#gadded5d413b32028058e0567a06505ffb">P_FUN_DISCONNECT_CB</a>        disconnect_cb;       </div><div class="line">} <a class="code" href="struct_t___f_u_n___c_l_i_e_n_t___c_b_s.html">T_FUN_CLIENT_CBS</a>;</div></div><!-- fragment --><p> <b>discover_state_cb</b>: Discovery state callback, which is used to inform specific client module of the discovery state of client_xxx_discovery.<br />
</p>
<p><b>discover_result_cb</b>: Discovery result callback, which is used to inform specific client module of the discovery result of client_xxx_discovery.<br />
</p>
<p><b>read_result_cb</b>: Read result callback, which is used to inform specific client module of the read result of <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga9503a28ec49617052f251d31154fa85d" title="Read characteristic by handle request. ">client_attr_read()</a> or <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga9909595615e9ed652006bedb58a2822a" title="Read characteristic by 16 bit UUID request. ">client_attr_read_using_uuid()</a>.<br />
</p>
<p><b>write_result_cb</b>: Write result callback, which is used to inform specific client module of the write result of <a class="el" href="group___g_a_t_t___client___exported___functions.html#gad9e99a3bdae8b20b6db8cc053b6e6d96" title="Write characteristic request. ">client_attr_write()</a>.<br />
</p>
<p><b>notify_ind_result_cb</b>: Notify indication callback, which is used to inform specific client module that notification or indication data is received from server.<br />
</p>
<p><b>disconnect_cb</b>: Disconnection callback, which is used to inform specific client module that one LE link is disconnected.<br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.3.3 Discovery Procedure</h5>
<p>After creating connection with the server, the client generally performs a discovery process if the local device does not store the handle information of server. Specific client needs to call client_xxx_discovery to start discovery procedure. Then Specific client needs to handle discovery state in callback <b>discover_state_cb</b> and discovery result in callback <b>discover_result_cb</b>. The procedure executed between each layer is shown in Figure 3-21. <br />
<br />
 </p><div class="image">
<img src="gatt_discovery.png" alt="gatt_discovery.png"/>
</div>
 <center><div id="figure_3_21"><b>Figure 3-21 GATT Discovery Procedure </b></div></center><p><a class="anchor" id="invalid"></a></p><h6>3.2.3.3.1 Discovery State</h6>
<center><div id="table_3_9"><b>Table 3-9 Discovery State </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Reference API  </th><th class="markdownTableHeadLeft">T_DISCOVERY_STATE   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga85ebe07880c727d884cfd93e61bacacd" title="Send discovery all primary services request. ">client_all_primary_srv_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_SRV_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga4e73254c121bd754c7deb811d423a33d" title="Send discovery services by 16 bit UUID request. ">client_by_uuid_srv_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_SRV_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga78a036a82fb79f4751a855eeb67ff483" title="Send discovery services by 128 bit UUID request. ">client_by_uuid128_srv_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_SRV_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga0681013ba5ed1abc6d73184548804c9a" title="Send discovery characteristics request. ">client_all_char_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_CHAR_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga218b856e5e748a7f7843aa9d820ceb1a" title="Send discovery characteristics descriptor request. ">client_all_char_descriptor_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_CHAR_DESCRIPTOR_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga8c3382ce90841d952fd4dfe51a566bfe" title="Send discovery relationship services request. ">client_relationship_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_RELATION_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga399607b146d6c08162e9eb83e5be9254" title="Send discovery characteristics request by caracteristic uuid. ">client_by_uuid_char_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_CHAR_UUID16_DONE<br />
DISC_STATE_FAILED   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft"><a class="el" href="group___g_a_t_t___client___exported___functions.html#ga0169e620f8d37400e6daa85712a24127" title="Send discovery characteristics request by caracteristic uuid. ">client_by_uuid128_char_discovery()</a>  </td><td class="markdownTableBodyLeft">DISC_STATE_CHAR_UUID128_DONE<br />
DISC_STATE_FAILED   </td></tr>
</table>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.3.2 Discovery Result</h6>
<center><div id="table_3_10"><b>Table 3-10 Discovery Result </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Reference API  </th><th class="markdownTableHeadLeft">T_DISCOVERY_<br />
RESULT_TYPE  </th><th class="markdownTableHeadLeft"><a class="el" href="union_t___d_i_s_c_o_v_e_r_y___r_e_s_u_l_t___d_a_t_a.html" title="Discovery result data. ">T_DISCOVERY_RESULT_DATA</a>   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_all_primary_srv_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
ALL_SRV_UUID16  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___s_e_r_v_i_c_e___e_l_e_m16.html">T_GATT_SERVICE_ELEM16</a><br />
*p_srv_uuid16_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">client_all_primary_srv_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
ALL_SRV_UUID128  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___s_e_r_v_i_c_e___e_l_e_m128.html">T_GATT_SERVICE_ELEM128</a><br />
*p_srv_uuid128_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_by_uuid_srv_discovery<br />
client_by_uuid128_srv_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
SRV_DATA  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___s_e_r_v_i_c_e___b_y___u_u_i_d___e_l_e_m.html">T_GATT_SERVICE_BY_UUID_ELEM</a><br />
*p_srv_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">client_all_char_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
CHAR_UUID16  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___e_l_e_m16.html" title="Characteristic declaration for 16 bit UUID. ">T_GATT_CHARACT_ELEM16</a><br />
*p_char_uuid16_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_all_char_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
CHAR_UUID128  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___e_l_e_m128.html" title="Characteristic declaration for 128 bit UUID. ">T_GATT_CHARACT_ELEM128</a><br />
*p_char_uuid128_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">client_all_char_<br />
descriptor_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
CHAR_DESC_UUID16  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___d_e_s_c___e_l_e_m16.html" title="Characteristic descriptor for 16 bit UUID. ">T_GATT_CHARACT_DESC_ELEM16</a><br />
*p_char_desc_uuid16_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_all_char_<br />
descriptor_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
CHAR_DESC_UUID128  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___d_e_s_c___e_l_e_m128.html" title="Characteristic descriptor for 128 bit UUID. ">T_GATT_CHARACT_DESC_ELEM128</a><br />
*p_char_desc_uuid128_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">client_relationship_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
RELATION_UUID16  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___r_e_l_a_t_i_o_n___e_l_e_m16.html" title="Relationship discovery for 16 bit UUID. ">T_GATT_RELATION_ELEM16</a><br />
*p_relation_uuid16_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_relationship_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
RELATION_UUID128  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___r_e_l_a_t_i_o_n___e_l_e_m128.html" title="Relationship discovery for 128 bit UUID. ">T_GATT_RELATION_ELEM128</a><br />
*p_relation_uuid128_disc_data;   </td></tr>
</table>
<div style="page-break-after: always;"></div> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Reference API  </th><th class="markdownTableHeadLeft">T_DISCOVERY_<br />
RESULT_TYPE  </th><th class="markdownTableHeadLeft"><a class="el" href="union_t___d_i_s_c_o_v_e_r_y___r_e_s_u_l_t___d_a_t_a.html" title="Discovery result data. ">T_DISCOVERY_RESULT_DATA</a>   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">client_by_uuid_char_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
BY_UUID16_CHAR  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___e_l_e_m16.html" title="Characteristic declaration for 16 bit UUID. ">T_GATT_CHARACT_ELEM16</a><br />
*p_char_uuid16_disc_data;   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">client_by_uuid128_char_discovery  </td><td class="markdownTableBodyLeft">DISC_RESULT_<br />
BY_UUID128_CHAR  </td><td class="markdownTableBodyLeft"><a class="el" href="struct_t___g_a_t_t___c_h_a_r_a_c_t___e_l_e_m128.html" title="Characteristic declaration for 128 bit UUID. ">T_GATT_CHARACT_ELEM128</a><br />
*p_char_uuid128_disc_data;   </td></tr>
</table>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.3.4 Characteristic Value Read</h5>
<p>This procedure is used to read a characteristic value of a server. There are two sub-procedures in profile client layer that can be used to read a Characteristic value: Read Characteristic Value By Handle and Read Characteristic Value By UUID.</p>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.4.1 Read Characteristic Value By Handle</h6>
<p>This sub-procedure is used to read a Characteristic Value from a server when the client knows the Characteristic Value Handle. Reading characteritic value by hande is a three-phase process. The phase 1 and phase 3 are always used. The phase 2 is an optional phase(see Figure 3-22):</p><ul>
<li>Phase 1: Call <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga9503a28ec49617052f251d31154fa85d" title="Read characteristic by handle request. ">client_attr_read()</a> to read Characteristic Value.</li>
<li>Phase 2: Optional phase. If the Characteristic Value is greater than (ATT_MTU - 1) octets in length, the Read Response only contains the first portion of the Characteristic Value and the Read Long Characteristic Value procedure will be used.</li>
<li>Phase 3: Profile client layer calls read_result_cb to return read result. The procedure executed between each layer is shown in Figure 3-22. <div class="image">
<img src="gatt_read_attribute_by_handle.png" alt="gatt_read_attribute_by_handle.png"/>
</div>
 <center><div id="figure_3_22"><b>Figure 3-22 Read Characteristic Value By Handle </b></div></center></li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.4.2 Read Characteristic Value By UUID</h6>
<p>This sub-procedure is used to read a Characteristic Value from a server when the client only knows the characteristic UUID and does not know the handle of the characteristic. Reading characteritic value by UUID is a three-phase process. The phase 1 and phase 3 are always used. The phase 2 is an optional phase(see Figure 3-23):</p><ul>
<li>Phase 1: Call <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga9909595615e9ed652006bedb58a2822a" title="Read characteristic by 16 bit UUID request. ">client_attr_read_using_uuid()</a> to read Characteristic Value.</li>
<li>Phase 2: Optional phase. If the Characteristic Value is greater than (ATT_MTU - 4) octets in length, the Read By Type Response only contains the first portion of the Characteristic Value and the Read Long Characteristic Value procedure will be used.</li>
<li>Phase 3: Profile client layer calls read_result_cb to return read result.</li>
</ul>
<p>The procedure executed between each layer is shown in Figure 3-23.</p>
<div class="image">
<img src="gatt_read_attribute_by_uuid.png" alt="gatt_read_attribute_by_uuid.png"/>
</div>
 <center><div id="figure_3_23"><b>Figure 3-23 Read Characteristic Value By UUID </b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.2.3.5 Characteristic Value Write</h5>
<p>This procedure is used to write a Characteristic Value to a server. There are four sub-procedures in profile client layer that can be used to write a Characteristic Value: Write Without Response, Signed Write Without Response, Write Characteristic Value and Write Long Characteristic Values.</p>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.5.1 Write Characteristic Value</h6>
<p>This sub-procedure is used to write a Characteristic Value to a server when the client knows the Characteristic Value Handle. When the length of value is less than or equal to (ATT_MTU - 3) octets, the procedure will be used. Otherwise, the Write Long Characteristic Values sub-procedure will be used instead. The procedure executed between each layer is shown in Figure 3-24.</p>
<div class="image">
<img src="gatt_write_attribute.png" alt="gatt_write_attribute.png"/>
</div>
 <center><div id="figure_3_24"><b>Figure 3-24 Write Characteristic Value </b></div></center><p><a class="anchor" id="invalid"></a></p><h6>3.2.3.5.2 Write Long Characteristic Values</h6>
<p>This sub-procedure is used to write a Characteristic Value to a server when the client knows the Characteristic Value Handle and the length of value is greater than (ATT_MTU - 3) octets. The procedure executed between each layer is shown in Figure 3-25.</p>
<div class="image">
<img src="gatt_write_long_attribute.png" alt="gatt_write_long_attribute.png"/>
</div>
 <center><div id="figure_3_25"><b>Figure 3-25 Write Long Characteristic Value </b></div></center><p><a class="anchor" id="invalid"></a></p><h6>3.2.3.5.3 Write Without Response</h6>
<p>This sub-procedure is used to write a Characteristic Value to a server when the client knows the Characteristic Value Handle and the client does not need an acknowledgment that the write was successfully performed. The length of value can't be greater than (ATT_MTU - 3) octets. The procedure executed between each layer is shown in Figure 3-26.</p>
<div class="image">
<img src="gatt_write_command.png" alt="gatt_write_command.png"/>
</div>
 <center><div id="figure_3_26"><b>Figure 3-26 Write Without Response </b></div></center><p><a class="anchor" id="invalid"></a></p><h6>3.2.3.5.4 Signed Write Without Response</h6>
<p>This sub-procedure is used to write a Characteristic Value to a server when the client knows the Characteristic Value Handle and the ATT Bearer is not encrypted. This sub-procedure shall only be used if the Characteristic Properties authenticated bit is enabled and the client and server device share a bond. The length of value can't be greater than (ATT_MTU - 15) octets. The procedure executed between each layer is shown in Figure 3-27.</p>
<div class="image">
<img src="gatt_signed_write_command.png" alt="gatt_signed_write_command.png"/>
</div>
 <center><div id="figure_3_27"><b>Figure 3-27 Signed Write Without Response </b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.2.3.6 Characteristic Value Notification</h5>
<p>This procedure is used when a server is configured to notify a Characteristic Value to a client without expecting any Attribute Protocol layer acknowledgment that the notification was successfully received. The procedure executed between each layer is shown in Figure 3-28.</p>
<div class="image">
<img src="gatt_notification.png" alt="gatt_notification.png"/>
</div>
 <center><div id="figure_3_28"><b>Figure 3-28 Characteristic Value Notification </b></div></center><p>Because profile client layer does not store the service hande informations, profile client layer is not sure which specific client is sent to. So profile client layer will call all registered specific clients. The specific client needs to check whether the notification is sent to itself. Sample code is shown below: </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> bas_client_notify_ind_cb(uint8_t conn_id, <span class="keywordtype">bool</span> notify, uint16_t handle,</div><div class="line">                                             uint16_t value_size, uint8_t *p_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_BAS_CLIENT_CB_DATA</a> cb_data;</div><div class="line">    uint16_t *hdl_cache;</div><div class="line"></div><div class="line">    hdl_cache = bas_table[conn_id].hdl_cache;</div><div class="line">    cb_data.<a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html#af6030b18ec2f5e13c5776c79d8e3eef2">cb_type</a> = <a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga7ba1c1c50db3353743256e1695df82c3a15938454740b48d949e33271ee86fb17">BAS_CLIENT_CB_TYPE_NOTIF_IND_RESULT</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (handle == hdl_cache[<a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga319921dc4dbb4ebb3a2a037d1d019d45a45eb747d50ade16f6058c5f9926e46e7">HDL_BAS_BATTERY_LEVEL</a>])</div><div class="line">    {</div><div class="line">        cb_data.<a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html#a5aaa59609d4ec98e61e714acc458f4f4">cb_content</a>.<a class="code" href="union_t___b_a_s___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#a458959039a8dddac36d4f2f0f15fa624">notify_data</a>.<a class="code" href="struct_t___b_a_s___n_o_t_i_f_y___d_a_t_a.html#a3c0aee7bfb6e464e575c6fe45ebf9b86">battery_level</a> = *p_value;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (bas_client_cb)</div><div class="line">    {</div><div class="line">        app_result = (*bas_client_cb)(bas_client, conn_id, &amp;cb_data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.2.3.7 Characteristic Value Indication</h5>
<p>This procedure is used when a server is configured to indicate a Characteristic Value to a client with expecting an Attribute Protocol layer acknowledgment that the indication was successfully received.</p>
<ol type="1">
<li><b>Characteristic Value Indication Without Result Pending</b> <br />
 <br />
 Callback function <b>notify_ind_result_cb</b> return result is not <a class="el" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a9f877e20e6ad5feed31bf5f59346ae2d">APP_RESULT_PENDING</a>. <br />
 The procedure executed between each layer is shown in Figure 3-29. <br />
<br />
 <div class="image">
<img src="gatt_indication.png" alt="gatt_indication.png"/>
</div>
 <center><div id="figure_3_29"><b>Figure 3-29 Characteristic Value Indication Without Result Pending </b></div></center> <br />
</li>
<li><b>Characteristic Value Indication With Result Pending</b> <br />
 <br />
 Callback function <b>notify_ind_result_cb</b> return result is <a class="el" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a9f877e20e6ad5feed31bf5f59346ae2d">APP_RESULT_PENDING</a>. APP needs to call <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga0949efa63b1d4579eca15030080ad84c" title="Confirm from application when receive indication from server. ">client_attr_ind_confirm()</a> to send cofirmation. The procedure executed between each layer is shown in Figure 3-30. <div class="image">
<img src="gatt_indication_pending.png" alt="gatt_indication_pending.png"/>
</div>
 <center><div id="figure_3_30"><b>Figure 3-30 Characteristic Value Indication With Result Pending </b></div></center> <br />
<br />
 Because profile client layer does not store the service hande informations, profile client layer is not sure which specific client is sent to. So profile client layer will call all registered specific clients. The specific client needs to check whether the indication is sent to itself. Sample code is shown below: <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> simp_ble_client_notif_ind_result_cb(uint8_t conn_id, <span class="keywordtype">bool</span> notify,</div><div class="line">                                                        uint16_t handle, uint16_t value_size, uint8_t *p_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html">T_SIMP_CLIENT_CB_DATA</a> cb_data;</div><div class="line">    uint16_t *hdl_cache;</div><div class="line">    hdl_cache = simp_table[conn_id].hdl_cache;</div><div class="line"></div><div class="line">    cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#af97819e1a38466d63db711b413c921eb">cb_type</a> = <a class="code" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16a03017f1265b9f8c438501a916fbc6ac6">SIMP_CLIENT_CB_TYPE_NOTIF_IND_RESULT</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (handle == hdl_cache[<a class="code" href="group___s_i_m_p___client___exported___types.html#ggaad16f56b3dab2181d7f4ac60b18841a1af6a12e886ffe0a7da7555b6c565baff0">HDL_SIMBLE_V3_NOTIFY</a>])</div><div class="line">    {</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa70a8a418eab810322196b1e2dc339e4">type</a> = <a class="code" href="group___s_i_m_p___client___exported___types.html#gga2296b6dfa97539acbe5c52633e38f72ca45b39c0c44f921a50aa41b2f898a932a">SIMP_V3_NOTIFY</a>;</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa808f7b2c706643c7f5e3f45ea5189ca">data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___v_a_l_u_e.html#a3958d142c677695fa42baeb461843f6f">value_size</a> = value_size;</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa808f7b2c706643c7f5e3f45ea5189ca">data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___v_a_l_u_e.html#a7e38674b09ada3bb654e2c2146044d30">p_value</a> = p_value;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (handle == hdl_cache[<a class="code" href="group___s_i_m_p___client___exported___types.html#ggaad16f56b3dab2181d7f4ac60b18841a1ac0219b202273fe1119164862857dca40">HDL_SIMBLE_V4_INDICATE</a>])</div><div class="line">    {</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa70a8a418eab810322196b1e2dc339e4">type</a> = <a class="code" href="group___s_i_m_p___client___exported___types.html#gga2296b6dfa97539acbe5c52633e38f72ca25d0f74dbb4612cceb8e117ceabcaf2f">SIMP_V4_INDICATE</a>;</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa808f7b2c706643c7f5e3f45ea5189ca">data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___v_a_l_u_e.html#a3958d142c677695fa42baeb461843f6f">value_size</a> = value_size;</div><div class="line">        cb_data.<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#a5ddc058e7a0b9efee26acd358e3bc722">cb_content</a>.<a class="code" href="union_t___s_i_m_p___c_l_i_e_n_t___c_b___c_o_n_t_e_n_t.html#ac2ea97bb06071b5fbb1fa7476ded5c0a">notif_ind_data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___d_a_t_a.html#aa808f7b2c706643c7f5e3f45ea5189ca">data</a>.<a class="code" href="struct_t___s_i_m_p___n_o_t_i_f___i_n_d___v_a_l_u_e.html#a7e38674b09ada3bb654e2c2146044d30">p_value</a> = p_value;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> app_result;</div><div class="line">    }</div><div class="line">    <span class="comment">/* Inform application the notif/ind result. */</span></div><div class="line">    <span class="keywordflow">if</span> (simp_client_cb)</div><div class="line">    {</div><div class="line">        app_result = (*simp_client_cb)(simp_client, conn_id, &amp;cb_data);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> app_result;</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<p><a class="anchor" id="invalid"></a></p><h5>3.2.3.8 Sequential Protocol</h5>
<p><a class="anchor" id="invalid"></a></p><h6>3.2.3.8.1 Request-response protocol</h6>
<p>Many attribute protocol PDUs use a sequential request-response protocol. Once a client sends a request to a server, the client shall not send other requests to the same server until a response PDU has been received. The following procedure needs to observe sequential request-response protocol.</p><ul>
<li>Discovery Procedure</li>
<li>Read Characteristic Value By Handle</li>
<li>Read Characteristic Value By UUID</li>
<li>Write Characteristic Value</li>
<li>Write Long Characteristic Values</li>
</ul>
<p>Before the running procedure is completed, APP can't start another procedure. Otherwise the other procedure will fail to be sent. Because the bt protocal stack may send exchange mtu request when connection creation is successful, GAP layer will send message GAP_MSG_LE_CONN_MTU_INFO to inform application that the exchange mtu procedure is completed. So APP can start upper several procedures after receiving GAP_MSG_LE_CONN_MTU_INFO. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_mtu_info_evt(uint8_t conn_id, uint16_t mtu_size)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_handle_conn_mtu_info_evt: conn_id %d, mtu_size %d&quot;</span>, conn_id, mtu_size);</div><div class="line">    app_discov_services(conn_id, <span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.2.3.8.2 Commands</h5>
<p>Commands in ATT includes:</p><ul>
<li>Write Without Response(write command)</li>
<li>Signed Write Without Response(sign write command)</li>
</ul>
<p>Because Command does not require a response, command does not have any flow control in the ATT layer. However, because of the limitation of resource, our bt protocal stack has flow control for commands. Flow control for Write Command and Signed Write Command is implemented with a credits value maintained in GAP layer, which allows APP to send Write Command in number of credits, without waiting for response from BT stack. BT stack can cache the data of the Write Command in number of credits for the upper layer.</p><ul>
<li>Credit count decreases by one when profile client layer sends command to BT stack.</li>
<li>Credit count increases by one when profile client layer receives the response from BT stack. When the command is sent to air, BT stack will send response to profile client layer.</li>
<li>Command shall only be sent when credit count is greater than zero.</li>
</ul>
<p>Callback function write_result_cb can inform the current credit. Or APP can call le_get_gap_param to get <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea82fe88a02906a2d53b27fbe341403fc5">GAP_PARAM_LE_REMAIN_CREDITS</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> test(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t credit;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga98fbde07c878c872f1af36ce1363ccc5">le_get_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea82fe88a02906a2d53b27fbe341403fc5">GAP_PARAM_LE_REMAIN_CREDITS</a>, &amp;credit);</div><div class="line"></div><div class="line">    <span class="keywordflow">while</span> (credit &gt; 0)</div><div class="line">    {</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___g_a_t_t___client___exported___functions.html#gad9e99a3bdae8b20b6db8cc053b6e6d96">client_attr_write</a>(0, 0, <a class="code" href="group___g_a_t_t___client___common___exported___types.html#gga571f50f2070e99f32e7ba9c17d043024a11b28ebca7e14661bf1722ec3ec4d24a">GATT_WRITE_TYPE_CMD</a>, handle, length, p_data) == <a class="code" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>)</div><div class="line">        {</div><div class="line">            credit--;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="GATT_Profile_Use_Case"></a>
3.3 GATT Profile Use Case</h3>
<p>This chapter is used to show how to use GATT profile interfaces. This chapter is to give some of typical use case such as <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#ANCS_Client">3.3.1 ANCS Client</a>.</p>
<h4><a class="anchor" id="ANCS_Client"></a>
3.3.1 ANCS Client</h4>
<p>The sample code is located in <b>BLE peripheral project</b>. ANCS routines are defined in ancs.c and <a class="el" href="ancs_8h_source.html" title="ancs ">ancs.h</a>. If other applications want to achieve this function, the procedures is shown below.<br />
</p><ol type="1">
<li><b>Copy <a class="el" href="ancs_8h_source.html" title="ancs ">ancs.h</a> and ancs.c to the target application directory.</b> <br />
<br />
</li>
<li><b>Configure parameter auth_sec_req_enable to true.</b> <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_BT_ANCS_CLIENT_SUPPORT</span></div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">true</span>;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Initialize ancs in app_le_profile_init().</b> <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_le_profile_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_ANCS_CLIENT_SUPPORT</span></div><div class="line">    <a class="code" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a>(1);</div><div class="line">    <a class="code" href="group___p_e_r_i_p_h___a_n_c_s___exported___functions.html#ga75ade1d10e9f77f9eaf1012a21087bd7">ancs_init</a>(APP_MAX_LINKS);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --> <br />
</li>
<li><b>Start ANCS discovery when authentication procedure is completed.</b> <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_authen_state_evt(uint8_t conn_id, uint8_t new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___s_t_a_t_e___d_e_f_i_n_e_s.html#ga74ca456a387d4acd1465fcc2a7419605">GAP_AUTHEN_STATE_COMPLETE</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (cause == <a class="code" href="group___b_t___t_y_p_e_s.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line"><span class="preprocessor">#if F_BT_ANCS_CLIENT_SUPPORT</span></div><div class="line">                <a class="code" href="group___a_n_c_s___c_l_i_e_n_t___exported___functions.html#ga4c0e3cc3eeae09f1a0e391a14103cad4">ancs_start_discovery</a>(conn_id);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt:  GAP_AUTHEN_STATE_COMPLETE pair success&quot;</span>);</div><div class="line"></div><div class="line"></div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_authen_state_evt:  GAP_AUTHEN_STATE_COMPLETE pair failed&quot;</span>);</div><div class="line"></div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">   ......</div><div class="line">}</div></div><!-- fragment --> <br />
</li>
<li><b>Customize the ANCS routines in ancs.c.</b> <br />
<br />
 More information on ANCS Client can be found in <a class="el" href="group___p_e_r_i_p_h___a_n_c_s.html">Peripheral ANCS</a>. </li>
</ol>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
