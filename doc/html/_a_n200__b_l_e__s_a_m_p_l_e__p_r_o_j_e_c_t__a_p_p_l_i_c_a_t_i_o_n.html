<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="BLE_Sample_Project_Page"></a>
BLE Sample Project Application Note </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/05/30</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/03/30  </td><td class="markdownTableBodyCenter">Modify Document Structure   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/05/30  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Content"></a>
Contents</h2>
<ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Sample_Project_Rev">Revision History</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Sample_Project_Table_List">Table List</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Sample_Project_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Sample_Project_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Sample_Project_Overview">1 Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Broadcaster_Application">2 BLE Broadcaster Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Intro">2.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_BROADCAST_ROLE">2.1.1 Broadcaster role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_EXP_FEATURE">2.1.2 Expose features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Proj">2.2 Project Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Ov">2.3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_INIT">2.3.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_GAP_MSG_HANDLER">2.3.2 GAP Message Handler</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Config">2.4 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_DLPS">2.4.1 DLPS</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Test">2.5 Test Procedure</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_TEST">2.5.1 Test with BLE Observer Application Device</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Observer_Application">3 BLE Observer Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Intro">3.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_OBSERVER_ROLE">3.1.1 Observer role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_EXP_FEATURE">3.1.2 Expose features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Proj">3.2 Project Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Ov">3.3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_INIT">3.3.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_GAP_MSG_HANDLER">3.3.2 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_GAP_CB_HANDLER">3.3.3 GAP Callback Handler</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Config">3.4 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_DLPS">3.4.1 DLPS</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Test">3.5 Test Procedure</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Peripheral_Application">4 BLE Peripheral Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Intro">4.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_PERIPHERAL_ROLE">4.1.1 Peripheral role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_EXP_FEATURE">4.1.2 Expose features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Proj">4.2 Project Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Ov">4.3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_INIT">4.3.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_GAP_MSG_HANDLER">4.3.2 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_GAP_CB_HANDLER">4.3.3 GAP Callback Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_PROFILE_SERVER_CB">4.3.4 Profile Message Callback</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Config">4.4 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_DLPS">4.4.1 DLPS</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_ANCS_CLIENT">4.4.2 ANCS Client</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Test">4.5 Test Procedure</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_IOS_TEST">4.5.1 Test with iOS Phones</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_BLE_CENTRAL_TEST">4.5.2 Test with BLE Central Application Device</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Central_Application">5 BLE Central Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Intro">5.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_CENTRAL_ROLE">5.1.1 Central role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_EXP_FEATURE">5.1.2 Expose features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Proj">5.2 Project Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Ov">5.3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_INIT">5.3.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_MULTI_LINK">5.3.2 Multi link Manager</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_GAP_MSG_HANDLER">5.3.3 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_GAP_CB_HANDLER">5.3.4 GAP Callback Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_PROFILE_MSG_CB">5.3.5 Profile Message Callback</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_DIS_GATT_SERVICE_PROC">5.3.6 Discover GATT Services Procedure</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Config">5.4 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_GATT_SERVICE_STORAGE">5.4.1 GATT services handles storage</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Cmd">5.5 User Command</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Test">5.6 Test Procedure</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Test_Periph">5.6.1 Test with BLE Peripheral Application Device</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Scatternet_Application">6 BLE Scatternet Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Introduction">6.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_SCATTERNET_FEATURE">6.1.1 Scatternet topology featrues</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_EXP_FEATURE">6.1.2 Expose features</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Proj">6.2 Project Overview</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Ov">6.3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_INIT">6.3.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_MULTI_LINK">6.3.2 Multilink Manager</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_GAP_MSG_HANDLER">6.3.3 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_GAP_CB_HANDLER">6.3.4 GAP Callback Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_PROFILE_CLIENT_MSG_CB">6.3.5 Profile Client Message Callback</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_PROFILE_SERVICE_MSG_CB">6.3.6 Profile Service Message Callback</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Config">6.4 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_AIRPLAN_MODE">6.4.1 Airplane mode setting</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_GA_SERVICE_WRITE">6.4.2 GAP Service characteristic writeable</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_STATIC_ADDR">6.4.3 Use static random address</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_PHY_SET">6.4.4 PHY setting</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Cmd">6.5 User Command</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Test_with_ble_peripheral_project_and_ble_central_project">6.5.1 Test with ble_peripheral project and ble_central project</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Peripheral_Application">7 BLE BT5 Peripheral Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Periph_Intro">7.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_PERIPHERAL_ROLE">7.1.1 Peripheral role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_EXP_FEATURE">7.1.2 Expose features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Compatibility">7.1.3 Compatibility</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Ov">7.2 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_INIT">7.2.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_GAP_MSG_HANDLER">7.2.2 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_GAP_CB_HANDLER">7.2.3 GAP Callback Handler</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Config">7.3 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_DLPS">7.3.1 DLPS</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Test">7.4 Test Procedure</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_BLE_CENTRAL_TEST">7.4.1 Test with BLE BT5 Central Application Device</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Central_Application">8 BLE BT5 Central Application</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Intro">8.1 Introduction</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_CENTRAL_ROLE">8.1.1 Central role features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_EXP_FEATURE">8.1.2 Expose features</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_Compatibility">8.1.3 Compatibility</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Ov">8.2 Source Code Overview</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_INIT">8.2.1 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_GAP_MSG_HANDLER">8.2.2 GAP Message Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_GAP_CB_HANDLER">8.2.3 GAP Callback Handler</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Config">8.3 APP Configurable Functions</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_Recombine_advertising_data">8.3.1 Recombine advertising data</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Cmd">8.4 User Command</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Commands_about_Extended_Scanning">8.4.1 Commands about Extended Scanning</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Command_about_Extended_Create_Connection">8.4.2 Commands about Extended Create Connection</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_command_about_Recombining_Advertising_Data">8.4.3 Commands about Recombining Advertising Data</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Test">8.5 Test Procedure</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Test_Periph">8.5.1 Test with BLE BT5 Peripheral Application Device</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Intro">9.1 Introduction</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Rl">9.2 User Command Implementation</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Related_file">9.2.1 Related file</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UART_Initialization">9.2.2 Initialization</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Data_UART_RX_Handler">9.2.3 Data UART RX Handler</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Data_UART_TX_Handler">9.2.4 Data UART TX Handler</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Con">9.3 Data UART Connection</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Cmd">9.4 User Commands (Central And Scatternet APP)</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Common">9.4.1 Common Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Bond">9.4.2 Bond Related Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Central">9.4.3 Central Related Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Client">9.4.4 GATT Client Related Commands</a></li>
</ul>
</li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Cmd_Sc">9.5 User Commands (Scatternet APP)</a><ul>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Common2">9.5.1 Common Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Central2">9.5.2 Central Related Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Client2">9.5.3 GATT Client Related Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Periph">9.5.4 Peripheral Related Commands</a></li>
<li><a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Sv">9.5.5 GATT Services Related Commands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_2_1">Table 2-1 Broadcast File List</a></li>
<li><a href="#table_3_1">Table 3-1 Observer File List</a></li>
<li><a href="#table_4_1">Table 4-1 Peripheral File List</a></li>
<li><a href="#table_5_1">Table 5-1 Central File List</a></li>
<li><a href="#table_6_1">Table 6-1 Scatternet File List</a></li>
<li><a href="#table_7_1">Table 7-1 Compatibility Of Peripheral Device With LE Advertising Extensions</a></li>
<li><a href="#table_8_1">Table 8-1 Compatibility Of Central Device With LE Advertising Extensions</a></li>
<li><a href="#table_9_1">Table 9-1 Related File List</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 Broadcaster Project Directory Structure</a></li>
<li><a href="#figure_3_1">Figure 3-1 Observer Project Directory Structure</a></li>
<li><a href="#figure_4_1">Figure 4-1 Peripheral Project Directory Structure</a></li>
<li><a href="#figure_4_2">Figure 4-2 Test With IOS Device</a></li>
<li><a href="#figure_5_1">Figure 5-1 Central Project Directory Structure</a></li>
<li><a href="#figure_5_2">Figure 5-2 app_central_client_discov_services() Flow Chart</a></li>
<li><a href="#figure_5_3">Figure 5-3 app_central_client_discov_services() Flow Chart (F_BT_GATT_SRV_HANDLE_STORAGE)</a></li>
<li><a href="#figure_5_4">Figure 5-4 Peripheral Ble Address Set</a></li>
<li><a href="#figure_6_1">Figure 6-1 Scatternet Project Directory Structure</a></li>
<li><a href="#figure_8_1">Figure 8-1 GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE</a></li>
<li><a href="#figure_8_2">Figure 8-2 GAP_EXT_ADV_EVT_DATA_STATUS_MORE</a></li>
<li><a href="#figure_9_1">Figure 9-1 Data UART Connection of PC and EVB</a></li>
<li><a href="#figure_9_2">Figure 9-2 Serial Port Setting</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE  </td><td class="markdownTableBodyCenter">Bluetooth Low Energy   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">GAP  </td><td class="markdownTableBodyCenter">Generic Access Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">GATT  </td><td class="markdownTableBodyCenter">Generic Attribute Profile   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Sample_Project_Overview"></a>
1 Overview</h2>
<p>There are four GAP roles defined for devices operating over an LE physical transport. SDK provides corresponding demo application for user's reference in development. <br />
</p>
<ol type="1">
<li>Broadcaster <br />
<br />
 1) Send advertising events <br />
 2) Cannot create connections <br />
 3) Demo application: BLE Broadcaster Application <br />
<br />
</li>
<li>Observer <br />
 <br />
 1) Scan for advertising events <br />
 2) Cannot initiate connections <br />
 3) Demo application: BLE Observer Application <br />
<br />
</li>
<li>Peripheral <br />
<br />
 1) Send advertising events <br />
 2) Can accept the establishment of LE link and become a slave role in the link <br />
 3) Demo application: BLE Peripheral Application <br />
<br />
</li>
<li>Central <br />
 <br />
 1) Scan for advertising events <br />
 2) Can initiate connection and become a master role in the link <br />
 3) Demo application: BLE Central Application <br />
<br />
</li>
<li>Multiple role <br />
<br />
 1) Peripheral + Central <br />
 2) Demo application: BLE Scatternet Application <br />
<br />
</li>
<li>Peripheral + LE Advertising Extensions <br />
<br />
 1) Send advertising events with LE Advertising Extensions <br />
 2) Enable one or more advertising sets at a time <br />
 3) Enable advertising set for a duration or maximum number of extended advertising events <br />
 4) Transmit more data with extended advertising PDUs (observer or central support LE Advertising Extensions) <br />
 5) Can accept the establishment of LE link and become a slave role in the link on LE 1M PHY LE 2M PHY or LE Coded PHY (central support LE Advertising Extensions) <br />
 6) Demo application: BLE BT5 Peripheral Application <br />
<br />
</li>
<li>Central + LE Advertising Extensions <br />
 <br />
 1) Extended scan for advertising packets on the primary advertising channel(LE 1M PHY or/and LE Coded PHY <br />
 2) Scan for a duration: periodic scan <br />
 3) Can initiate connection and become a master role in the link on LE 1M PHY LE 2M PHY or LE Coded PHY (peripheral support LE Advertising Extensions) <br />
 4) Demo application: BLE BT5 Central Application <br />
<br />
</li>
<li>Peripheral + Privacy <br />
 <br />
 1) Send advertising events <br />
 2) Can accept the establishment of LE link and become a slave role in the link <br />
 3) Can use white list when remote device uses resolvable private address. <br />
 4) Demo application: BLE Peripheral Privacy Application <br />
</li>
</ol>
<center><div id="figure_1_1"><b>Table 1-1 Bluetooth LE Sample Projects </b></div></center> <div class="image">
<img src="BLE_Sample_Project_roles.png" alt="BLE_Sample_Project_roles.png"/>
</div>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Broadcaster_Application"></a>
2 BLE Broadcaster Application</h2>
<h3><a class="anchor" id="Broadcaster_Intro"></a>
2.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE broadcaster application. The BLE broadcaster project implements a very simple BLE broadcaster device and it can be used as a framework to develop many different broadcaster-role based applications. BLE Broadcaster Application will be introduced according to the following several parts:<br />
</p><ul>
<li>Broadcaster role support features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_BROADCAST_ROLE">2.1.1 Broadcaster role features</a>.</li>
<li>BLE Broadcaster Application expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_EXP_FEATURE">2.1.2 Expose features</a>.</li>
<li>BLE Broadcaster Application Project Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Proj">2.2 Project Overview</a>.</li>
<li>BLE Broadcaster Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Ov">2.3 Source Code Overview</a>.</li>
<li>BLE Broadcaster Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Config">2.4 APP Configurable Functions</a>.</li>
<li>BLE Broadcaster Application Test Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Broadcaster_Test">2.5 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN202_BROADCAST_ROLE"></a>
2.1.1 Broadcaster role features</h4>
<ul>
<li>Send non-connectable advertising events.</li>
<li>Cannot create connections.</li>
</ul>
<h4><a class="anchor" id="AN202_EXP_FEATURE"></a>
2.1.2 Expose features</h4>
<p>This application exposes the following features:</p><ul>
<li>DLPS:<ul>
<li>Need to configure F_BT_DLPS_EN to open. (Default opened)</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="Broadcaster_Proj"></a>
2.2 Project Overview</h3>
<p>This section describes project directory and project structure. Reference files directory is as follows:</p><ul>
<li>Project directory: sdk\board\evb\ble_broadcaster</li>
<li>Project source code directory: sdk\src\sample\ble_broadcaster</li>
</ul>
<p>Directory structure of the project is shown in Figure 2-1. </p><div class="image">
<img src="broadcaster_project.jpg" alt="broadcaster_project.jpg"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Broadcaster Project Directory Structure </b></div></center><p>The file list is divided into the following groups: </p><center><div id="table_2_1"><b>Table 2-1 Broadcast File Listt </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Directory  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">include  </td><td class="markdownTableBodyLeft">ROM UUID header files. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lib  </td><td class="markdownTableBodyLeft">The protocol stack and gap library file. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">cmsis  </td><td class="markdownTableBodyLeft">The cmsis source code. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">app  </td><td class="markdownTableBodyLeft">The application source code.<br />
More information on these files can be found in <a class="el" href="group___b_r_o_a_d_c_a_s_t_e_r___d_e_m_o.html">BLE Broadcaster App</a>.   </td></tr>
</table>
<h3><a class="anchor" id="Broadcaster_Ov"></a>
2.3 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Broadcaster Role. This chapter will be introduced according to the following several parts:</p><ul>
<li>Broadcaster related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_INIT">2.3.1 Initialization</a>.</li>
<li>Broadcaster related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN202_GAP_MSG_HANDLER">2.3.2 GAP Message Handler</a>.</li>
</ul>
<h4><a class="anchor" id="AN202_INIT"></a>
2.3.1 Initialization</h4>
<p>Main function is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(0);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    app_broadcaster_gap_init();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Please refer to <a class="el" href="group___b_r_o_a_d_c_a_s_t_e_r___d_e_m_o___m_a_i_n.html">Broadcaster Main</a> for initialization function declaration.</p>
<p>app_broadcaster_gap_init() function is used to initialize the GAP parameters. User can easily customize the application by modifying the following parameter values. <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_broadcaster_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* register gap message callback */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_broadcaster_gap_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_broadcaster_gap_ble_mgr_init();</div><div class="line"></div><div class="line">    <span class="comment">/*advertising parameters initialize*/</span></div><div class="line">    app_broadcaster_adv_init_nonconn_public();</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb()</a> register gap message callback function app_broadcaster_gap_callback and all gap callback messages will be handled in this callback. <br />
<br />
</li>
<li>app_broadcaster_gap_ble_mgr_init() Initialize ble manager lib module to config support ble advertisement and set advertisement numbers. <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_broadcaster_gap_ble_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html">BLE_MGR_PARAMS</a> param = {0};</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a719280eb2fedb81d95d276e2addd979a">adv_num</a> = 1;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga9da52972f80798ac2d87254a8231fcd6">ble_mgr_init</a>(&amp;param);</div><div class="line">}</div></div><!-- fragment --> <br />
<br />
</li>
<li>app_broadcaster_adv_init_nonconn_public() Initialize non-connectable advertising parameters and register advertising callback. <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_broadcaster_adv_init_nonconn_public(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gaac37315eefb7c0b74fb9daad93b5fd2b">T_LE_EXT_ADV_LEGACY_ADV_PROPERTY</a> adv_event_prop = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2ba1d02f7494ec8f1b95bade945bc7d5d5c">LE_EXT_ADV_LEGACY_ADV_SCAN_UNDIRECTED</a>;</div><div class="line">    uint16_t adv_interval_min = 0xA0;</div><div class="line">    uint16_t adv_interval_max = 0xB0;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> peer_address_type = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    uint8_t  peer_address[6] = {0, 0, 0, 0, 0, 0};</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac0433c68ddb7484621ec659b7f8edd76">T_GAP_ADV_FILTER_POLICY</a> filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76a610241ea5e48e993bbf893c19e1b2794">GAP_ADV_FILTER_ANY</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                    adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                    filter_policy, <span class="keyword">sizeof</span>(adv_data), adv_data,</div><div class="line">                                    <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>), <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga21de10157b31a9041d2e7e7dc862e912">ble_ext_adv_mgr_register_callback</a>(app_broadcaster_adv_callback, adv_handle);</div><div class="line">}</div></div><!-- fragment --> A device in the broadcast mode shall send data using non-connectable advertising events. <br />
 So parameter adv_evt_type shall be configured to <a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2ba1d02f7494ec8f1b95bade945bc7d5d5c">LE_EXT_ADV_LEGACY_ADV_SCAN_UNDIRECTED</a> or <a class="el" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2bacb7ee78262ffe57a2d2ec9ed621f9ae7">LE_EXT_ADV_LEGACY_ADV_NON_SCAN_NON_CONN_UNDIRECTED</a>. <br />
 More information on LE GAP initialization and startup flow can be found in <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a>.</li>
</ol>
<h4><a class="anchor" id="AN202_GAP_MSG_HANDLER"></a>
2.3.2 GAP Message Handler</h4>
<p>app_broadcaster_gap_handle_gap_msg() function is invoked whenever a GAP message is received from the GAP. More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_broadcaster_gap_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t___l_e___g_a_p___m_s_g.html">T_LE_GAP_MSG</a> gap_msg;</div><div class="line">    memcpy(&amp;gap_msg, &amp;p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>, <span class="keyword">sizeof</span>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>));</div><div class="line"></div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#gaa3f9acaeff2921be050227c988665a73">ble_mgr_handle_gap_msg</a>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>, &amp;gap_msg);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_broadcaster_gap_handle_gap_msg: subtype %d&quot;</span>, p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae9874bb97b4d115932f5f124be42ad92">GAP_MSG_LE_DEV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_broadcaster_gap_handle_dev_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#a7c69580dcb030e2dc78819f2e6cafdbc">new_state</a>,</div><div class="line">                                                     gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_broadcaster_gap_handle_gap_msg: unknown subtype %d&quot;</span>,</div><div class="line">                         p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Broadcaster application will call app_broadcaster_adv_start() to start advertising when receiving <a class="el" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>. if app_broadcaster_adv_start() return true, it means BLE protocol stack has already receive this command and ready to execute, when this command execution complete, BLE protocol stack will send BLE_EXT_ADV_MGR_ADV_ENABLED to app_broadcaster_adv_callback(). When BLE broadcaster application runs on evolution board, the device will send non-connectable advertising events. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_broadcaster_gap_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_broadcaster_gap_handle_dev_state_evt: init state %d, adv state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>, new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>, cause);</div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_broadcaster_gap_handle_dev_state_evt: GAP stack ready&quot;</span>);</div><div class="line">            <span class="comment">/*stack ready*/</span></div><div class="line">            app_broadcaster_adv_start(0);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_broadcaster_adv_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a> cb_data;</div><div class="line">    memcpy(&amp;cb_data, p_cb_data, <span class="keyword">sizeof</span>(<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#gad2dc0692029ca3df07b95326745fcddd">BLE_EXT_ADV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_broadcaster_adv_callback: adv_state %d, adv_handle %d&quot;</span>,</div><div class="line">                             cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a96dc09ff81c490ab93ccf8145b2f9429">adv_handle</a>);</div><div class="line">            adv_state = cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_broadcaster_adv_callback: BLE_EXT_ADV_MGR_ADV_ENABLED&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3acf6402209e91954f506dfeaf6f040123">BLE_EXT_ADV_MGR_ADV_DISABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_broadcaster_adv_callback: BLE_EXT_ADV_MGR_ADV_DISABLED&quot;</span>);</div><div class="line">                <span class="keywordflow">switch</span> (cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#ad3d8bfc3b831e3263f0877dc3f5a1457">stop_cause</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94baeb976cff376dc38e2553dd8199139aa3">BLE_EXT_ADV_STOP_CAUSE_APP</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94ba23881d3656b475aef3ca0db362452964">BLE_EXT_ADV_STOP_CAUSE_CONN</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94ba23cbe8577be16b94ddb2e3b182da839f">BLE_EXT_ADV_STOP_CAUSE_TIMEOUT</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_broadcaster_adv_callback: stack stop adv cause 0x%x, app stop adv cause 0x%02x&quot;</span>,</div><div class="line">                                 cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#ad3d8bfc3b831e3263f0877dc3f5a1457">stop_cause</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a3bba94b017ab9d128675a73aa52056eb">app_cause</a>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Broadcaster_Config"></a>
2.4 APP Configurable Functions</h3>
<p>The main purpose of this chapter is to help APP developers familiar with APP configurable functions. APP Configurable Functions are defined in app_broadcaster_flags.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_DLPS_EN                        1</span></div></div><!-- fragment --><p> Config DLPS:<br />
</p><ul>
<li>F_BT_DLPS_EN 0-Disable DLPS</li>
<li>F_BT_DLPS_EN 1-Enable DLPS <br />
 User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</li>
</ul>
<h4><a class="anchor" id="AN202_DLPS"></a>
2.4.1 DLPS</h4>
<p>If the user wants to enable DLPS, DLPS reference code is shown below: </p><div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line"><span class="preprocessor">#include &quot;pm.h&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> pwr_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga973442724abf827f29d83a4b2f9369e2acc50404a0e14859034d4d8d7643e6977">BTPOWER_DEEP_SLEEP</a>);</div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddafefe15dc6f9b2184fb58be2274d5bb4e">POWER_DLPS_MODE</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h3><a class="anchor" id="Broadcaster_Test"></a>
2.5 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE Broadcaster application to the evolution board.</li>
<li>When BLE Broadcaster Application is running on evolution board, the device will send non-connectable advertising events.</li>
<li>User can use air sniffer or observer application or Phone APP to view the advertising.</li>
</ol>
<h4><a class="anchor" id="AN202_TEST"></a>
2.5.1 Test with BLE Observer Application Device</h4>
<p>Please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Test">3.5 Test Procedure</a> for the test procedure.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Observer_Application"></a>
3 BLE Observer Application</h2>
<h3><a class="anchor" id="Observer_Intro"></a>
3.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE Observer application. The BLE Observer project implements a very simple BLE Observer device and it can be used as a framework to develop many different observer-role based applications. BLE Observer Application will be introduced according to the following several parts:<br />
</p><ul>
<li>Observer role support features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_OBSERVER_ROLE">3.1.1 Observer role features</a>.</li>
<li>BLE Observer Application expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_EXP_FEATURE">3.1.2 Expose features</a>.</li>
<li>BLE Observer Application Project Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Proj">3.2 Project Overview</a>.</li>
<li>BLE Observer Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Ov">3.3 Source Code Overview</a>.</li>
<li>BLE Observer Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Config">3.4 APP Configurable Functions</a>.</li>
<li>BLE Observer ApplicationTest Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Observer_Test">3.5 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN203_OBSERVER_ROLE"></a>
3.1.1 Observer role features</h4>
<ul>
<li>Receive advertising events</li>
<li>Cannot initiate connections</li>
</ul>
<h4><a class="anchor" id="AN203_EXP_FEATURE"></a>
3.1.2 Expose features</h4>
<p>This application exposes the following features:</p><ul>
<li>DLPS:<ul>
<li>Need to configure F_BT_DLPS_EN to open. (Default opened)</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="Observer_Proj"></a>
3.2 Project Overview</h3>
<p>This section describes project directory and project structure. Reference files directory is as follows:</p><ul>
<li>Project directory: sdk\board\evb\ble_observer</li>
<li>Project source code directory: sdk\src\sample\ble_observer</li>
</ul>
<p>Directory structure of the project is shown in Figure 3-1. </p><div class="image">
<img src="observer_project.jpg" alt="observer_project.jpg"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Observer Project Directory Structure </b></div></center><p>The file list is divided into the following groups: </p><center><div id="table_3_1"><b>Table 3-1 Observer File List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Directory  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">include  </td><td class="markdownTableBodyLeft">ROM UUID header files. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lib  </td><td class="markdownTableBodyLeft">The protocol stack and gap library file. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">cmsis  </td><td class="markdownTableBodyLeft">The cmsis source code. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">app  </td><td class="markdownTableBodyLeft">The application source code.<br />
More information on these files can be found in <a class="el" href="group___o_b___d_e_m_o.html">BLE Observer App</a>.   </td></tr>
</table>
<h3><a class="anchor" id="Observer_Ov"></a>
3.3 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Observer Role. This chapter will be introduced according to the following several parts:</p><ul>
<li>Observer related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_INIT">3.3.1 Initialization</a>.</li>
<li>Observer related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_GAP_MSG_HANDLER">3.3.2 GAP Message Handler</a>.</li>
<li>Observer related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN203_GAP_CB_HANDLER">3.3.3 GAP Callback Handler</a>.</li>
</ul>
<h4><a class="anchor" id="AN203_INIT"></a>
3.3.1 Initialization</h4>
<p>Main function is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(0);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Please refer to <a class="el" href="group___o_b___d_e_m_o___m_a_i_n.html">Observer Main</a> for initialization function declaration.</p>
<p><a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a> function is used to initialize the scan parameters. User can easily customise the application by modifying the following parameter values.<br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* register gap message callback */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_gap_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_gap_ble_mgr_init();</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb()</a> register gap message callback function app_gap_callback and all gap callback messages will be handled in this callback. <br />
<br />
</li>
<li>app_gap_ble_mgr_init() Initialize ble manager lib module to config support ble scan. <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_gap_ble_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html">BLE_MGR_PARAMS</a> param = {0};</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a50e84e72fc87e7f0652f7519248d96ab">ble_scan</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga9da52972f80798ac2d87254a8231fcd6">ble_mgr_init</a>(&amp;param);</div><div class="line">}</div></div><!-- fragment --> More information on LE GAP initialization and startup flow can be found in <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a>.</li>
</ol>
<h4><a class="anchor" id="AN203_GAP_MSG_HANDLER"></a>
3.3.2 GAP Message Handler</h4>
<p>app_handle_gap_msg function is invoked whenever a GAP messages is received from the GAP. More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>.</p>
<p>Observer application will call app_scan_start() to start scan when receiving <a class="el" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>. <br />
 When BLE Observer Application is running on Evolution Board, the BLE device will start scan. if advertising report has been received, ble_mgr lib will send <a class="el" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> to app_scan_cb(). <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_handle_dev_state_evt: init state %d, scan state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a>, cause);</div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_handle_dev_state_evt: GAP stack ready&quot;</span>);</div><div class="line">            <span class="comment">/*stack ready*/</span></div><div class="line">            app_scan_start(APP_SCAN_INTERVAL, APP_SCAN_WINDOW);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_scan_cb(<a class="code" href="group___l_e___s_c_a_n___exported___types.html#ga6e85fb50ee707c971663f65652348926">BLE_SCAN_EVT</a> evt, <a class="code" href="union_b_l_e___s_c_a_n___e_v_t___d_a_t_a.html">BLE_SCAN_EVT_DATA</a> *data)</div><div class="line">{</div><div class="line">    uint8_t scan_state = <a class="code" href="group___l_e___s_c_a_n___exported___functions.html#ga0787889d67b266a772ff060bee38df31">ble_scan_get_cur_state</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga76eac5d2f173d1e601bd9d2bd4a4d809">APP_PRINT_INFO6</a>(<span class="stringliteral">&quot;app_scan_cb: BLE_SCAN_REPORT event_type 0x%x, bd_addr %s, addr_type %d, rssi %d, data_len %d, data_status 0x%x&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;event_type,</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr),</div><div class="line">                        data-&gt;report-&gt;addr_type,</div><div class="line">                        data-&gt;report-&gt;rssi,</div><div class="line">                        data-&gt;report-&gt;data_len,</div><div class="line">                        data-&gt;report-&gt;data_status);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN203_GAP_CB_HANDLER"></a>
3.3.3 GAP Callback Handler</h4>
<p>app_gap_callback function is used to handle GAP callback messages. More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>. <br />
</p>
<p>When the device is in scanning mode, the device may receive advertising data. <br />
 Ble mgr lib will send <a class="el" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> to application when receiving advertising data and scan response data. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_scan_cb(<a class="code" href="group___l_e___s_c_a_n___exported___types.html#ga6e85fb50ee707c971663f65652348926">BLE_SCAN_EVT</a> evt, <a class="code" href="union_b_l_e___s_c_a_n___e_v_t___d_a_t_a.html">BLE_SCAN_EVT_DATA</a> *data)</div><div class="line">{</div><div class="line">    uint8_t scan_state = <a class="code" href="group___l_e___s_c_a_n___exported___functions.html#ga0787889d67b266a772ff060bee38df31">ble_scan_get_cur_state</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga76eac5d2f173d1e601bd9d2bd4a4d809">APP_PRINT_INFO6</a>(<span class="stringliteral">&quot;app_scan_cb: BLE_SCAN_REPORT event_type 0x%x, bd_addr %s, addr_type %d, rssi %d, data_len %d, data_status 0x%x&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;event_type,</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr),</div><div class="line">                        data-&gt;report-&gt;addr_type,</div><div class="line">                        data-&gt;report-&gt;rssi,</div><div class="line">                        data-&gt;report-&gt;data_len,</div><div class="line">                        data-&gt;report-&gt;data_status);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Observer_Config"></a>
3.4 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_observer_flags.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_DLPS_EN                        1</span></div></div><!-- fragment --><p> User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN203_DLPS"></a>
3.4.1 DLPS</h4>
<p>DLPS reference code is shown below: </p><div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line"><span class="preprocessor">#include &quot;pm.h&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> pwr_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga973442724abf827f29d83a4b2f9369e2acc50404a0e14859034d4d8d7643e6977">BTPOWER_DEEP_SLEEP</a>);</div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddafefe15dc6f9b2184fb58be2274d5bb4e">POWER_DLPS_MODE</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h3><a class="anchor" id="Observer_Test"></a>
3.5 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE Observer application to the Evolution Board.</li>
<li>Please use DebugAnalyser Tool to get the log.</li>
<li>When BLE Observer Application is running on Evolution Board, the BLE device will start scan.</li>
</ol>
<p>If receiving advertising data and scan response data, application will receive event <a class="el" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a>. <br />
 Logs are shown below: </p><div class="fragment"><div class="line">[APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x13, bd_addr F7::14::7F::1B::CB::D7, addr_type 1, rssi -94, data_len 31, data_status 0x0</div><div class="line">[APP] !!!app_gap_callback: unhandled cb_type 0x50</div><div class="line">[APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x10, bd_addr 29::47::75::92::9B::26, addr_type 1, rssi -85, data_len 31, data_status 0x0</div><div class="line">[APP] !!!app_gap_callback: unhandled cb_type 0x50</div><div class="line">[APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x10, bd_addr 45::C6::E2::DD::01::B0, addr_type 1, rssi -102, data_len 31, data_status 0x0</div><div class="line">[APP] !!!app_gap_callback: unhandled cb_type 0x50</div><div class="line">[APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x10, bd_addr 14::87::6A::54::76::54, addr_type 0, rssi -94, data_len 21, data_status 0x0</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Peripheral_Application"></a>
4 BLE Peripheral Application</h2>
<h3><a class="anchor" id="Periph_Intro"></a>
4.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE Peripheral application. The BLE Peripheral project implements a very simple BLE Peripheral device and it can be used as a framework to develop many different Peripheral-role based applications. BLE Peripheral Application will be introduced according to the following several parts:<br />
</p><ul>
<li>Peripheral role support features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_PERIPHERAL_ROLE">4.1.1 Peripheral role features</a>.</li>
<li>BLE Peripheral Application expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_EXP_FEATURE">4.1.2 Expose features</a>.</li>
<li>BLE Peripheral Application Project Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Proj">4.2 Project Overview</a>.</li>
<li>BLE Peripheral Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Ov">4.3 Source Code Overview</a>.</li>
<li>BLE Peripheral Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Config">4.4 APP Configurable Functions</a>.</li>
<li>BLE Peripheral Application Test Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Periph_Test">4.5 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN200_PERIPHERAL_ROLE"></a>
4.1.1 Peripheral role features</h4>
<ol type="1">
<li>Send advertising events.<br />
</li>
<li>Can accept the establishment of LE link and become a slave role in the link.<br />
</li>
</ol>
<h4><a class="anchor" id="AN200_EXP_FEATURE"></a>
4.1.2 Expose features</h4>
<p>This application exposes the following features: <br />
</p>
<ol type="1">
<li>DLPS:<br />
 Need to configure F_BT_DLPS_EN to open. (Default opened) <br />
 <br />
</li>
<li>Link number: <br />
 APP_MAX_LINKS in app_peripheral_flags.h. (Default one link) <br />
 <br />
</li>
<li>Support GATT services: <br />
 1) <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e.html">GAP and GATT Inbox Services</a> <br />
 2) <a class="el" href="group___b_a_s.html">Battery Service</a> <br />
 3) <a class="el" href="group___s_i_m_p___service.html">Simple Ble Service</a> <br />
 <br />
</li>
<li>Support GATT clients: <br />
 <a class="el" href="group___a_n_c_s___c_l_i_e_n_t.html">ANCS Client</a> : Need to configure F_BT_ANCS_CLIENT_SUPPORT to open.(Default closed) <br />
</li>
</ol>
<h3><a class="anchor" id="Periph_Proj"></a>
4.2 Project Overview</h3>
<p>This section describes project directory and project structure. Reference files directory is as follows:</p><ul>
<li>Project directory: sdk\board\evb\ble_peripheral</li>
<li>Project source code directory: sdk\src\sample\ble_peripheral</li>
</ul>
<p>Directory structure of the project is shown in Figure 4-1. </p><div class="image">
<img src="periph_project.jpg" alt="periph_project.jpg"/>
</div>
 <center><div id="figure_4_1"><b>Figure 4-1 Peripheral Project Directory Structure </b></div></center><p>The file list is divided into the following groups: </p><div style="page-break-after: always;"></div> <center><div id="table_4_1"><b>Table 4-1 Peripheral File List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Directory  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">include  </td><td class="markdownTableBodyLeft">ROM UUID header files. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lib  </td><td class="markdownTableBodyLeft">The protocol stack and gap library file. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">cmsis  </td><td class="markdownTableBodyLeft">The cmsis source code. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">profile  </td><td class="markdownTableBodyLeft">The GATT profiles source code.<br />
More information on these files can be found in <a class="el" href="group___p_r_o_f_i_l_e___a_p_i.html">Profile</a>.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">app  </td><td class="markdownTableBodyLeft">The application source code.<br />
More information on these files can be found in <a class="el" href="group___p_e_r_i_p_h___d_e_m_o.html">BLE Peripheral App</a>.   </td></tr>
</table>
<h3><a class="anchor" id="Periph_Ov"></a>
4.3 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Peripheral Role. This chapter will be introduced according to the following several parts:</p><ul>
<li>Peripheral related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_INIT">4.3.1 Initialization</a>.</li>
<li>Peripheral related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_GAP_MSG_HANDLER">4.3.2 GAP Message Handler</a>.</li>
<li>Peripheral related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_GAP_CB_HANDLER">4.3.3 GAP Callback Handler</a>.</li>
<li>Peripheral related GATT Profile message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_PROFILE_SERVER_CB">4.3.4 Profile Message Callback</a>.</li>
</ul>
<h4><a class="anchor" id="AN200_INIT"></a>
4.3.1 Initialization</h4>
<p>Main function is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    app_peripheral_gap_init();</div><div class="line">    app_peripheral_service_init();</div><div class="line">    app_peripheral_client_init();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Please refer to <a class="el" href="group___p_e_r_i_p_h___d_e_m_o___m_a_i_n.html">Peripheral Main</a> for initialization function declaration.</p>
<p>GAP and GATT Profiles initialization flow: <br />
</p>
<ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init()</a> Initialize GAP and set link number.<br />
<br />
</li>
<li><a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init()</a> Initialize GAP utils lib.<br />
<br />
</li>
<li><p class="startli">app_peripheral_gap_init() <br />
</p>
<p class="startli">1) device name and appearance </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Device name and device appearance */</span></div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_PERIPHERAL&quot;</span>;</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">2) slave initialize mtu request </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* slave initialize mtu request */</span></div><div class="line">    uint8_t  slave_init_mtu_req = <span class="keyword">false</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaf04baac1b9d2ef5d9695b5f5c8159f43">GAP_PARAM_SLAVE_INIT_GATT_MTU_REQ</a>,</div><div class="line">                     <span class="keyword">sizeof</span>(slave_init_mtu_req), &amp;slave_init_mtu_req);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">3) GAP Bond Manager parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">   uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a> | <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga8c6188c207f5f749b0733453f7bf9ee0">GAP_AUTHEN_BIT_SC_FLAG</a>;</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#gafa5f8a475a6c3126ab20d51881e8dc8d">T_GAP_IO_CAP</a>  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a> | <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga8c6188c207f5f749b0733453f7bf9ee0">GAP_AUTHEN_BIT_SC_FLAG</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">4) le_register_app_cb(app_peripheral_gap_callback) <br />
 register gap message callback function app_peripheral_gap_callback and all gap callback messages will be handled in this callback.</p>
<p class="startli">5) advertising related parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_peripheral_gap_ble_mgr_init();</div><div class="line"></div><div class="line">    <span class="comment">/*advertising parameters initialize*/</span></div><div class="line">    app_peripheral_adv_init_conn_public();</div><div class="line">}</div></div><!-- fragment --><p> app_peripheral_gap_ble_mgr_init() <br />
 Initialize ble manager lib module to config support ble advertisement and set advertisement numbers. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_ble_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html">BLE_MGR_PARAMS</a> param = {0};</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a719280eb2fedb81d95d276e2addd979a">adv_num</a> = 1;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga9da52972f80798ac2d87254a8231fcd6">ble_mgr_init</a>(&amp;param);</div><div class="line">}</div></div><!-- fragment --><p> app_peripheral_adv_init_conn_public() <br />
 Initialize connectable advertising parameters and register advertising callback. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_adv_init_conn_public(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#gaac37315eefb7c0b74fb9daad93b5fd2b">T_LE_EXT_ADV_LEGACY_ADV_PROPERTY</a> adv_event_prop = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggaac37315eefb7c0b74fb9daad93b5fd2ba221e1dd75ec84b8536143e2e2b9245ac">LE_EXT_ADV_LEGACY_ADV_CONN_SCAN_UNDIRECTED</a>;</div><div class="line">    uint16_t adv_interval_min = 0xA0;</div><div class="line">    uint16_t adv_interval_max = 0xB0;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> own_address_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> peer_address_type = <a class="code" href="group___g_a_p___common___exported___types.html#gga41dd9d848e985c7c492f8f43e1da9249a0f8c733d0498ba8895498a882385afb1">GAP_REMOTE_ADDR_LE_PUBLIC</a>;</div><div class="line">    uint8_t  peer_address[6] = {0, 0, 0, 0, 0, 0};</div><div class="line">    <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gac0433c68ddb7484621ec659b7f8edd76">T_GAP_ADV_FILTER_POLICY</a> filter_policy = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ggac0433c68ddb7484621ec659b7f8edd76a610241ea5e48e993bbf893c19e1b2794">GAP_ADV_FILTER_ANY</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                    adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                    filter_policy, <span class="keyword">sizeof</span>(adv_data), adv_data,</div><div class="line">                                    <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>), <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga21de10157b31a9041d2e7e7dc862e912">ble_ext_adv_mgr_register_callback</a>(app_peripheral_adv_callback, adv_handle);</div><div class="line">}</div></div><!-- fragment --><p> <br />
</p>
</li>
<li>app_peripheral_service_init() Initialize GATT service. <br />
<br />
</li>
<li>app_peripheral_client_init() Initialize GATT client.</li>
</ol>
<p>More information on LE GAP initialization and startup flow can be found in <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a>.</p>
<h4><a class="anchor" id="AN200_GAP_MSG_HANDLER"></a>
4.3.2 GAP Message Handler</h4>
<p>app_peripheral_gap_handle_msg() function is invoked whenever a GAP messages is received from the GAP. More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">switch</span> (p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae9874bb97b4d115932f5f124be42ad92">GAP_MSG_LE_DEV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_dev_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#a7c69580dcb030e2dc78819f2e6cafdbc">new_state</a>,</div><div class="line">                                                    gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_conn_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                     (<a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>)gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                                     gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a15f45b2c898ca276b537e9c749fced6b">disc_cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad09d9df87275d5f64d9b1885af179800">GAP_MSG_LE_CONN_MTU_INFO</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_conn_mtu_info_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                        gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a7494d27aae03bdf1d9092563e1cc1026">mtu_size</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga0d1a35f4e8a0e57d172fe10f12807066">GAP_MSG_LE_CONN_PARAM_UPDATE</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_conn_param_update_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                            gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#ade818037fd6c985038ff29656089758d">status</a>,</div><div class="line">                                                            gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gaf4e6edb01c279d7966d8114ad2f55437">GAP_MSG_LE_AUTHEN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_authen_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                       gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                                       gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a5393c99e246925076b1dfd69a64177ef">status</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gac03fcf124046d4d4ee2e8b9a21ed4bab">GAP_MSG_LE_BOND_JUST_WORK</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_bond_just_work(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afd6dc52537ee4e70bc3443a4fb329c49">gap_bond_just_work_conf</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___j_u_s_t___w_o_r_k___c_o_n_f.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                     <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae4f8067dc7ca40f371ae85922619205c">GAP_MSG_LE_BOND_PASSKEY_DISPLAY</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_bond_passkey_display(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a14cdf60b156e5767b3d7c1913204bc0b">gap_bond_passkey_display</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___d_i_s_p_l_a_y.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                           <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gada28f27ecd48284a36b0fb69934c1c94">GAP_MSG_LE_BOND_USER_CONFIRMATION</a>:</div><div class="line">        {</div><div class="line">            app_peripheral_gap_handle_bond_user_confirmation(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afde50b1f06980787643f56943b4ef36c">gap_bond_user_conf</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___u_s_e_r___c_o_n_f.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                             <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad3378cc599f99bec96a48a40ade535fb">GAP_MSG_LE_BOND_PASSKEY_INPUT</a>:</div><div class="line">        {</div><div class="line">            uint32_t passkey = 888888;</div><div class="line">            app_peripheral_gap_handle_bond_passkey_input(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ac6262590cdef5a2dd624fa2cef04ccf1">gap_bond_passkey_input</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___p_a_s_s_k_e_y___i_n_p_u_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                                         passkey,</div><div class="line">                                                         <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae2a234929d028693a7a2970e35f94c3b">GAP_MSG_LE_BOND_OOB_INPUT</a>:</div><div class="line">        {</div><div class="line">            uint8_t oob_data[<a class="code" href="group___g_a_p___common___macros.html#ga93dbe22884ddc94ca3aa206765b95d61">GAP_OOB_LEN</a>] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};</div><div class="line">            app_peripheral_gap_handle_bond_oob_input(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#afc0d340d369ed1e8bf9b1cd699b70a93">gap_bond_oob_input</a>.<a class="code" href="struct_t___g_a_p___b_o_n_d___o_o_b___i_n_p_u_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>, oob_data,</div><div class="line">                                                     <a class="code" href="group___g_a_p___common___exported___types.html#gga17c405b4388243cdfbfdbd543ddd09b2ae7659210dbfb11ce24973bba8aaa6b6c">GAP_CFM_CAUSE_ACCEPT</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_msg: unknown subtype %d&quot;</span>, p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Peripheral application will call app_peripheral_adv_start() to start advertising when receiving <a class="el" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>. When BLE Peripheral Application is running on Evolution Board, the BLE device becomes discoverable and connectable. Remote device can scan the peripheral device and create connection with peripheral device. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_dev_state_evt: init state %d, adv state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>, new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>, cause);</div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_dev_state_evt: GAP stack ready&quot;</span>);</div><div class="line">            <span class="comment">/*start advertising*/</span></div><div class="line">            app_peripheral_adv_start(0);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div></div><!-- fragment --><p> Peripheral application will call app_peripheral_adv_start() to start advertising when receiving <a class="el" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>. After disconnection, Peripheral Application will be discoverable and connectable again. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state,</div><div class="line">                                              uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_conn_state_evt: conn_id %d old_state %d new_state %d, disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, gap_conn_state, new_state, disc_cause);</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_conn_state_evt: connection lost cause 0x%x&quot;</span>,</div><div class="line">                                 disc_cause);</div><div class="line">            }</div><div class="line">            <span class="comment">/*start advertising*/</span></div><div class="line">            app_peripheral_adv_start(0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        ......</div><div class="line">    }</div><div class="line">    gap_conn_state = new_state;</div><div class="line">}</div></div><!-- fragment --><p>if app_peripheral_adv_start() return true, it means BLE protocol stack has already receive this command and ready to execute, when this command execution complete, BLE protocol stack will send <a class="el" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a> to app_peripheral_adv_callback(). <br />
 </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_peripheral_adv_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a> cb_data;</div><div class="line">    memcpy(&amp;cb_data, p_cb_data, <span class="keyword">sizeof</span>(<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#gad2dc0692029ca3df07b95326745fcddd">BLE_EXT_ADV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: adv_state %d, adv_handle %d&quot;</span>,</div><div class="line">                             cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a96dc09ff81c490ab93ccf8145b2f9429">adv_handle</a>);</div><div class="line">            adv_state = cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: BLE_EXT_ADV_MGR_ADV_ENABLED&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3acf6402209e91954f506dfeaf6f040123">BLE_EXT_ADV_MGR_ADV_DISABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: BLE_EXT_ADV_MGR_ADV_DISABLED&quot;</span>);</div><div class="line">                <span class="keywordflow">switch</span> (cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#ad3d8bfc3b831e3263f0877dc3f5a1457">stop_cause</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94baeb976cff376dc38e2553dd8199139aa3">BLE_EXT_ADV_STOP_CAUSE_APP</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94ba23881d3656b475aef3ca0db362452964">BLE_EXT_ADV_STOP_CAUSE_CONN</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggab396c9a4b54ee7b3ea205128030dc94ba23cbe8577be16b94ddb2e3b182da839f">BLE_EXT_ADV_STOP_CAUSE_TIMEOUT</a>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: stack stop adv cause 0x%x, app stop adv cause 0x%02x&quot;</span>,</div><div class="line">                                 cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#ad3d8bfc3b831e3263f0877dc3f5a1457">stop_cause</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a3bba94b017ab9d128675a73aa52056eb">app_cause</a>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#ga2dd2f17ba3ae875441107f1c21f8d994">BLE_EXT_ADV_SET_CONN_INFO</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: BLE_EXT_ADV_SET_CONN_INFO conn_id 0x%x&quot;</span>,</div><div class="line">                         cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#aaf7574159a4584c55e5e470de76aee5c">p_ble_conn_info</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_e_t___c_o_n_n___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN200_GAP_CB_HANDLER"></a>
4.3.3 GAP Callback Handler</h4>
<p>app_peripheral_gap_callback() function is used to handle GAP callback messages. More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_peripheral_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga50575af7f1139b4fec93ecd40ea2b83d">ble_mgr_handle_gap_cb</a>(cb_type, p_cb_data);</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#gaf0402630f5cd20214a6e9cff4ecac7bd">GAP_MSG_LE_DATA_LEN_CHANGE_INFO</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_peripheral_gap_callback: GAP_MSG_LE_DATA_LEN_CHANGE_INFO conn_id %d, tx octets 0x%x, max_tx_time 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#aa3da8be7b43d1b243885c4a9c733ba7f">max_tx_octets</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#abaed928f204eb66d93e63779504e0546">p_le_data_len_change_info</a>-&gt;<a class="code" href="struct_t___l_e___d_a_t_a___l_e_n___c_h_a_n_g_e___i_n_f_o.html#aa003e7a864b65c381f67031acb6295b4">max_tx_time</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga1b98e295b6d3c065b9e01b5ba67506d6">GAP_MSG_LE_MODIFY_WHITE_LIST</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_peripheral_gap_callback: GAP_MSG_LE_MODIFY_WHITE_LIST operation %d, cause 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#acdb7bfbcebca8b955ca60d7f29279300">p_le_modify_white_list_rsp</a>-&gt;<a class="code" href="struct_t___l_e___m_o_d_i_f_y___w_h_i_t_e___l_i_s_t___r_s_p.html#ae587b54ed97d693cf14a2c68ab8d4a8f">operation</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#acdb7bfbcebca8b955ca60d7f29279300">p_le_modify_white_list_rsp</a>-&gt;<a class="code" href="struct_t___l_e___m_o_d_i_f_y___w_h_i_t_e___l_i_s_t___r_s_p.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_peripheral_gap_callback: unhandled cb_type 0x%x&quot;</span>, cb_type);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN200_PROFILE_SERVER_CB"></a>
4.3.4 Profile Message Callback</h4>
<p>When APP uses XXX_add_service to register specific service, APP shall register the callback function to handle the message from the specific service. APP shall call <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a> to register the callback function used to handle the message from the profile server layer. APP can register different callback functions to handle different services or register the common callback function to handle all messages from specific services and profile server layer. app_peripheral_service_callback() function is the common callback function. app_peripheral_service_callback() can distinguish different services by service id. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_service_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(2);</div><div class="line">    simp_srv_id = <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service</a>(app_peripheral_service_callback);</div><div class="line">    bas_srv_id  = <a class="code" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a>(app_peripheral_service_callback);</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a>(app_peripheral_service_callback);</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init()</a> Initialize parameters of GATT Server and set the number of services that needs to register. <br />
<br />
</li>
<li><a class="el" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service()</a> Add simple BLE service to the BLE stack database. <br />
<br />
</li>
<li><a class="el" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a> Add battery service to the BLE stack database. <br />
<br />
</li>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a> Register server callback function to send events to application.</li>
</ol>
<p>More information can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Server">3.1 Bluetooth LE Profile Server</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>4.3.4.1 General profile server callback</h5>
<p><a class="el" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a> is the service id used by profile server layer. Profile server layer contains two message type: <br />
</p><ul>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a> : Services registration process has been completed in GAP Start Flow.</li>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a> : This message is used by profile server layer to inform the result of sending the notification/indication.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_peripheral_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>:</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: PROFILE_EVT_SRV_REG_COMPLETE result %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#a4a385380321b6b14cb5cc01f89d4ed02">service_reg_result</a>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>:</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE conn_id %d, cause 0x%x, service_id %d, attrib_idx 0x%x, credits %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a094c03474c2092d3d653930fecb969e8">service_id</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#ad5892381ad0f7e319f5b34de243258df">attrib_idx</a>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#a607393b49e6ef198a64152b0ba95ca31">credits</a>);</div><div class="line">            <span class="keywordflow">if</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#ada03afcbd69eb297393220a612a5b6f1">send_data_result</a>.<a class="code" href="struct_t___s_e_n_d___d_a_t_a___r_e_s_u_l_t.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a> == <a class="code" href="group___b_t___g_a_p___e_r_r_o_r.html#gae28a99be86971489212b23df8633291c">GAP_SUCCESS</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE success&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: PROFILE_EVT_SEND_DATA_COMPLETE failed&quot;</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>4.3.4.2 Battery Service Callback</h5>
<p>bas_srv_id is the service id of battery service. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_peripheral_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (service_id == bas_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_BAS_CALLBACK_DATA</a> *p_bas_cb_data = (<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_BAS_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_bas_cb_data-&gt;<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">switch</span> (p_bas_cb_data-&gt;<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html#aeff72c044508f8021cf6c2017b1fa668">msg_data</a>.<a class="code" href="union_t___b_a_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___b_a_s___exported___macros.html#gac0adc239b9fdec9ce16b257b0dbf01d5">BAS_NOTIFY_BATTERY_LEVEL_ENABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: BAS_NOTIFY_BATTERY_LEVEL_ENABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___b_a_s___exported___macros.html#gaeed574ebb33e4fbbff68194ff697c477">BAS_NOTIFY_BATTERY_LEVEL_DISABLE</a>:</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: BAS_NOTIFY_BATTERY_LEVEL_DISABLE&quot;</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                <span class="keywordflow">default</span>:</div><div class="line">                    <span class="keywordflow">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7a84062d7216785555446ac9bf65f4e6a7">SERVICE_CALLBACK_TYPE_READ_CHAR_VALUE</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (p_bas_cb_data-&gt;<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html#aeff72c044508f8021cf6c2017b1fa668">msg_data</a>.<a class="code" href="union_t___b_a_s___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a33e4249eb6be718fef909fd0f9f60dba">read_value_index</a> == <a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga801969ec8dd873ff9d2f07016ca0d8ccadfab201a96c7dad7c934b90219f7efda">BAS_READ_BATTERY_LEVEL</a>)</div><div class="line">                {</div><div class="line">                    uint8_t battery_level = 90;</div><div class="line">                    <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_peripheral_service_callback: BAS_READ_BATTERY_LEVEL %d&quot;</span>, battery_level);</div><div class="line">                    <a class="code" href="group___b_a_s___exported___functions.html#ga9b26cf59876b3aa6cf1e2d4e793539d8">bas_set_parameter</a>(<a class="code" href="group___b_a_s___exported___types.html#gga136e68decf44cb87a91f719d1700ce1cae41c5865c36b5cbf40036253423ee603">BAS_PARAM_BATTERY_LEVEL</a>, 1, &amp;battery_level);</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        ......</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___b_a_s.html">Battery Service</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>4.3.4.3 Simple BLE Service Callback</h5>
<p>simp_srv_id is the service id of simple BLE service. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_peripheral_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>:</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___s_i_m_p___service.html">Simple Ble Service</a>.</p>
<h3><a class="anchor" id="Periph_Config"></a>
4.4 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_peripheral_flags.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_DLPS_EN                        1</span></div><div class="line"><span class="preprocessor">#define F_BT_ANCS_CLIENT_SUPPORT            0</span></div><div class="line"><span class="preprocessor">......</span></div></div><!-- fragment --><p> User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN200_DLPS"></a>
4.4.1 DLPS</h4>
<p>DLPS reference code is shown below: </p><div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line"><span class="preprocessor">#include &quot;pm.h&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> pwr_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga973442724abf827f29d83a4b2f9369e2acc50404a0e14859034d4d8d7643e6977">BTPOWER_DEEP_SLEEP</a>);</div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddafefe15dc6f9b2184fb58be2274d5bb4e">POWER_DLPS_MODE</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h4><a class="anchor" id="AN200_ANCS_CLIENT"></a>
4.4.2 ANCS Client</h4>
<p>F_BT_ANCS_CLIENT_SUPPORT needs to be configured to open. <br />
 More information can be found in <a class="el" href="_a_n018__a_n_c_s__c_l_i_e_n_t__a_p_p_l_i_c_a_t_i_o_n.html#ANCS_CLIENT_Page">ANCS Client Application Note </a>.</p>
<h3><a class="anchor" id="Periph_Test"></a>
4.5 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE Peripheral application to the Evolution Board.</li>
<li>When BLE Peripheral Application is running on Evolution Board, the BLE device becomes discoverable and connectable. Remote device can scan the peripheral device and create a connection with peripheral device.</li>
<li>After disconnection, BLE Peripheral Application will be discoverable and connectable again.</li>
</ol>
<h4><a class="anchor" id="AN200_IOS_TEST"></a>
4.5.1 Test with iOS Phones</h4>
<p>Procedure Description: <br />
 ios phones are always compatible with BLE, however BLE advertising can not be discovered in ios phone's Setting interface. So it is recommended to use BLE-related App (e.g. LightBlue) in App Store to perform search and connection test.</p>
<p>Procedure: <br />
 Open LightBlue on iOS Phone to search an advertising named BLE_PERIPHERAL and connect it, as shown in Figure 4-2. </p><div class="image">
<img src="periph_ios_test.jpg" alt="periph_ios_test.jpg"/>
</div>
 <center><div id="figure_4_2"><b>Figure 4-2 Test With IOS Device </b></div></center><h4><a class="anchor" id="AN200_BLE_CENTRAL_TEST"></a>
4.5.2 Test with BLE Central Application Device</h4>
<p>BLE peripheral Application can test with BLE central application. More information on central application can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Central_Application">5 BLE Central Application</a>. Please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Test_Periph">5.6.1 Test with BLE Peripheral Application Device</a> for the test procedure .</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Central_Application"></a>
5 BLE Central Application</h2>
<h3><a class="anchor" id="Central_Intro"></a>
5.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE Central application. The BLE Central project implements a very simple BLE Central device and it can be used as a framework to develop many different Central-role based applications. BLE Central Application will be introduced according to the following several parts:<br />
</p><ul>
<li>Central role support features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_CENTRAL_ROLE">5.1.1 Central role features</a>.</li>
<li>BLE Central Application expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_EXP_FEATURE">5.1.2 Expose features</a>.</li>
<li>BLE Central Application Project Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Proj">5.2 Project Overview</a>.</li>
<li>BLE Central Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Ov">5.3 Source Code Overview</a>.</li>
<li>BLE Central Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Config">5.4 APP Configurable Functions</a>.</li>
<li>BLE Central Application User Command will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Cmd">5.5 User Command</a>.</li>
<li>BLE Central Application Test Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Central_Test">5.6 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN201_CENTRAL_ROLE"></a>
5.1.1 Central role features</h4>
<ul>
<li>Scan for advertising events</li>
<li>Can initiate connection and become a master role in the link</li>
<li>Can connect with more than one peripheral device</li>
</ul>
<h4><a class="anchor" id="AN201_EXP_FEATURE"></a>
5.1.2 Expose features</h4>
<p>This application exposes the following features:</p><ul>
<li>Link number:<ul>
<li>APP_MAX_LINKS in app_central_flags.h. (Default two links) <br />
<br />
</li>
</ul>
</li>
<li>GATT services handles storage:<ul>
<li>Need to configure F_BT_GATT_SRV_HANDLE_STORAGE to open. (Default closed) <br />
<br />
</li>
</ul>
</li>
<li>Support GATT services:<ul>
<li><a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e.html">GAP and GATT Inbox Services</a> <br />
<br />
</li>
</ul>
</li>
<li>Support GATT clients:<ul>
<li><a class="el" href="group___g_a_p_s___client.html">GAP Service Client</a></li>
<li><a class="el" href="group___s_i_m_p___client.html">Simple BLE Service Client</a></li>
<li><a class="el" href="group___b_a_s___c_l_i_e_n_t.html">Battery Service Client</a></li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="Central_Proj"></a>
5.2 Project Overview</h3>
<p>This section describes project directory and project structure. Reference files directory is as follows:</p><ul>
<li>Project directory: sdk\board\evb\ble_central</li>
<li>Project source code directory: sdk\src\sample\ble_central</li>
</ul>
<p>Directory structure of the project is shown in Figure 5-1. </p><div class="image">
<img src="central_project.jpg" alt="central_project.jpg"/>
</div>
 <center><div id="figure_5_1"><b>Figure 5-1 Central Project Directory Structure </b></div></center><p> The file list is divided into the following groups: </p><div style="page-break-after: always;"></div> <center><div id="table_5_1"><b>Table 5-1 Central File List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Directory  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">include  </td><td class="markdownTableBodyLeft">ROM UUID header files. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lib  </td><td class="markdownTableBodyLeft">The protocol stack and gap library file. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">cmsis  </td><td class="markdownTableBodyLeft">The cmsis source code. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">profile  </td><td class="markdownTableBodyLeft">The GATT profiles source code.<br />
More information on these files can be found in <a class="el" href="group___p_r_o_f_i_l_e___a_p_i.html">Profile</a>.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">app  </td><td class="markdownTableBodyLeft">The application source code.<br />
More information on these files can be found in <a class="el" href="group___c_e_n_t_r_a_l___d_e_m_o.html">BLE Central App</a>.   </td></tr>
</table>
<h3><a class="anchor" id="Central_Ov"></a>
5.3 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Central Role. This chapter will be introduced according to the following several parts:</p><ul>
<li>Central related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_INIT">5.3.1 Initialization</a>.</li>
<li>Central related multi link manager please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_MULTI_LINK">5.3.2 Multi link Manager</a>.</li>
<li>Central related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_GAP_MSG_HANDLER">5.3.3 GAP Message Handler</a>.</li>
<li>Central related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_GAP_CB_HANDLER">5.3.4 GAP Callback Handler</a>.</li>
<li>Central related GATT Profile message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_PROFILE_MSG_CB">5.3.5 Profile Message Callback</a>.</li>
<li>Central related GATT service discover flow please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_DIS_GATT_SERVICE_PROC">5.3.6 Discover GATT Services Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN201_INIT"></a>
5.3.1 Initialization</h4>
<p><a class="el" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Entry of APP code. ">main()</a> is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>();</div><div class="line">    app_central_client_init();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Please refer to <a class="el" href="group___c_e_n_t_r_a_l___d_e_m_o___m_a_i_n.html">Central Main</a> for initialization function declaration. <br />
 GAP and GATT Profiles initialization flow:</p><ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init()</a> Initialize GAP and set link number. <br />
<br />
</li>
<li><a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init()</a> Initialize GAP utils lib. <br />
<br />
</li>
<li><p class="startli"><a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447" title="gap module init. ">app_gap_init()</a> User can easily customize the application by modifying the following parameter values. <br />
<br />
 1) device name and appearance </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Device name and device appearance */</span></div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_CENTRAL&quot;</span>;</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">2) Use LE Advertising Extensions </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* Use LE Advertising Extensions */</span></div><div class="line">    uint8_t use_extended = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, <span class="keyword">sizeof</span>(use_extended), &amp;use_extended);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">3) GAP Bond Manager parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    uint8_t  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">4) le_register_app_cb(app_gap_callback) <br />
 register gap message callback function app_gap_callback and all gap callback messages will be handled in this callback.</p>
<p class="startli">5) ble manager module initialize Initialize ble manager lib module to config support ble scan. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_gap_ble_mgr_init();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_gap_ble_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html">BLE_MGR_PARAMS</a> param = {0};</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a50e84e72fc87e7f0652f7519248d96ab">ble_scan</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga9da52972f80798ac2d87254a8231fcd6">ble_mgr_init</a>(&amp;param);</div><div class="line">}</div></div><!-- fragment --></li>
<li>app_central_client_init() Initialize GATT Profile. <div class="fragment"><div class="line"><span class="keywordtype">void</span> app_central_client_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a>(3);</div><div class="line">    gaps_client_id  = <a class="code" href="group___g_a_p_s___client___exported___functions.html#gaf8deaa2a8975bdd3ca7700e536292acf">gaps_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">    simple_ble_client_id = <a class="code" href="group___s_i_m_p___client___exported___functions.html#ga76bea50116d524128da76b093954ed64">simp_ble_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">    bas_client_id = <a class="code" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gaeeb647a2ef6ccaa581cb5ca91c171ec5">bas_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">}</div></div><!-- fragment --> 1) <a class="el" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init()</a> <br />
 Initialize parameters of GATT client and set the number of clients that needs to register. <br />
 <br />
 2) <a class="el" href="group___g_a_p_s___client___exported___functions.html#gaf8deaa2a8975bdd3ca7700e536292acf">gaps_add_client()</a> <br />
 Add gap service client to application. <br />
 <br />
 3) <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga76bea50116d524128da76b093954ed64">simp_ble_add_client()</a> <br />
 Add simple ble service client to application. <br />
 <br />
 4) <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gaeeb647a2ef6ccaa581cb5ca91c171ec5">bas_add_client()</a> <br />
 Add battery service client to application. <br />
</li>
</ol>
<p>More information on LE GAP initialization and startup flow can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a>.</p>
<h4><a class="anchor" id="AN201_MULTI_LINK"></a>
5.3.2 Multi link Manager</h4>
<p>Application link control block is defined in app_central_link_mgr.h. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>        conn_state;          </div><div class="line">    uint8_t                 discovered_flags;    </div><div class="line">    uint8_t                 srv_found_flags;     </div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a>  bd_type;             </div><div class="line">    uint8_t                 bd_addr[<a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>]; </div><div class="line">} T_APP_LINK;</div><div class="line"><span class="keyword">extern</span> T_APP_LINK app_link_table[APP_MAX_LINKS];</div></div><!-- fragment --><p> app_link_table is used to save the connection link related information.</p><ol type="1">
<li>conn_state <a class="el" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> <br />
<br />
</li>
<li>discovered_flags Indicates whether a service discovery process has been performed. <br />
 1) gap service discovery process done <div class="fragment"><div class="line">app_link_table[conn_id].discovered_flags |= APP_DISCOV_GAPS_FLAG;</div></div><!-- fragment --> <br />
 2) simple ble service discovery process done <div class="fragment"><div class="line">app_link_table[conn_id].discovered_flags |= APP_DISCOV_SIMP_FLAG;</div></div><!-- fragment --> <br />
 3) battery service discovery process done <div class="fragment"><div class="line">app_link_table[conn_id].discovered_flags |= APP_DISCOV_BAS_FLAG;</div></div><!-- fragment --> <br />
</li>
<li>srv_found_flags Indicates a service discovery result. <br />
 1) gap service discovery success <div class="fragment"><div class="line">app_link_table[conn_id].srv_found_flags |= APP_DISCOV_GAPS_FLAG;</div></div><!-- fragment --> <br />
 2) simple ble service discovery success <div class="fragment"><div class="line">app_link_table[conn_id].srv_found_flags |= APP_DISCOV_SIMP_FLAG;</div></div><!-- fragment --> <br />
 3) battery service discovery success <div class="fragment"><div class="line">app_link_table[conn_id].srv_found_flags |= APP_DISCOV_BAS_FLAG;</div></div><!-- fragment --> <br />
</li>
<li>remote address and address type <a class="el" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a></li>
</ol>
<h4><a class="anchor" id="AN201_GAP_MSG_HANDLER"></a>
5.3.3 GAP Message Handler</h4>
<p>app_handle_gap_msg function is invoked whenever a GAP messages is received from the GAP. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t___l_e___g_a_p___m_s_g.html">T_LE_GAP_MSG</a> gap_msg;</div><div class="line">    uint8_t conn_id;</div><div class="line">    memcpy(&amp;gap_msg, &amp;p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>, <span class="keyword">sizeof</span>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>));</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#gaa3f9acaeff2921be050227c988665a73">ble_mgr_handle_gap_msg</a>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>, &amp;gap_msg);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_handle_gap_msg: subtype %d&quot;</span>, p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>);</div><div class="line">    <span class="keywordflow">switch</span> (p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae9874bb97b4d115932f5f124be42ad92">GAP_MSG_LE_DEV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_dev_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#a7c69580dcb030e2dc78819f2e6cafdbc">new_state</a>,</div><div class="line">                                     gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a954c83c52f825a89defd2a605856ddc6">gap_dev_state_change</a>.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e___c_h_a_n_g_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                      (<a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>)gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                      gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a6a83ad4e1b8be5c1034798aff59b2133">gap_conn_state_change</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___s_t_a_t_e___c_h_a_n_g_e.html#a15f45b2c898ca276b537e9c749fced6b">disc_cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad09d9df87275d5f64d9b1885af179800">GAP_MSG_LE_CONN_MTU_INFO</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_mtu_info_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                         gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#ae2be840c7e5da11e7bcdbfdfa5d8aea9">gap_conn_mtu_info</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___m_t_u___i_n_f_o.html#a7494d27aae03bdf1d9092563e1cc1026">mtu_size</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga0d1a35f4e8a0e57d172fe10f12807066">GAP_MSG_LE_CONN_PARAM_UPDATE</a>:</div><div class="line">        {</div><div class="line">            app_handle_conn_param_update_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                             gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#ade818037fd6c985038ff29656089758d">status</a>,</div><div class="line">                                             gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a52f6f7f3fc7e335ed20406b51e41be6c">gap_conn_param_update</a>.<a class="code" href="struct_t___g_a_p___c_o_n_n___p_a_r_a_m___u_p_d_a_t_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gaf4e6edb01c279d7966d8114ad2f55437">GAP_MSG_LE_AUTHEN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_handle_authen_state_evt(gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                                        gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a58f2bd48909950e16039c2319519f79f">new_state</a>,</div><div class="line">                                        gap_msg.<a class="code" href="struct_t___l_e___g_a_p___m_s_g.html#aacaf516d5422b24dd9d731c5cea7b220">msg_data</a>.<a class="code" href="union_t___l_e___g_a_p___m_s_g___d_a_t_a.html#a1a684b1d96e900c8e75ea0fc737fd511">gap_authen_state</a>.<a class="code" href="struct_t___g_a_p___a_u_t_h_e_n___s_t_a_t_e.html#a5393c99e246925076b1dfd69a64177ef">status</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gac03fcf124046d4d4ee2e8b9a21ed4bab">GAP_MSG_LE_BOND_JUST_WORK</a>:</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae4f8067dc7ca40f371ae85922619205c">GAP_MSG_LE_BOND_PASSKEY_DISPLAY</a>:</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gada28f27ecd48284a36b0fb69934c1c94">GAP_MSG_LE_BOND_USER_CONFIRMATION</a>:</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad3378cc599f99bec96a48a40ade535fb">GAP_MSG_LE_BOND_PASSKEY_INPUT</a>:</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae2a234929d028693a7a2970e35f94c3b">GAP_MSG_LE_BOND_OOB_INPUT</a>:</div><div class="line">        {</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line"></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>. When receiving message <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>, app_handle_conn_state_evt will update the information in app_link_table. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state, uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (conn_id &gt;= APP_MAX_LINKS)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: conn_id %d, conn_state(%d -&gt; %d), disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, app_link_table[conn_id].conn_state, new_state, disc_cause);</div><div class="line"></div><div class="line">    app_link_table[conn_id].conn_state = new_state;</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#gaecc521002738db2512fb90bdd2dbde1c">APP_PRINT_ERROR2</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: connection lost, conn_id %d, cause 0x%x&quot;</span>, conn_id,</div><div class="line">                                 disc_cause);</div><div class="line">            }</div><div class="line"></div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Disconnect conn_id %d\r\n&quot;</span>, conn_id);</div><div class="line">            memset(&amp;app_link_table[conn_id], 0, <span class="keyword">sizeof</span>(T_APP_LINK));</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga607918b3e0e11cd01b24cd05cafaeb96">le_get_conn_addr</a>(conn_id, app_link_table[conn_id].bd_addr,</div><div class="line">                             &amp;app_link_table[conn_id].bd_type);</div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Connected success conn_id %d\r\n&quot;</span>, conn_id);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN201_GAP_CB_HANDLER"></a>
5.3.4 GAP Callback Handler</h4>
<p>app_gap_callback function is used to handle GAP callback messages. More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>.</p>
<h4><a class="anchor" id="AN201_PROFILE_MSG_CB"></a>
5.3.5 Profile Message Callback</h4>
<p>When APP uses XXX_add_client to register specific client, APP shall register the callback function to handle the message from the specific client. <br />
</p>
<p>APP can register different callback functions to handle different clients or register the common callback function to handle all messages from specific clients. app_central_client_callback function is the common callback function. app_central_client_callback can distinguish different clients by client id. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_central_client_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a>(3);</div><div class="line">    gaps_client_id  = <a class="code" href="group___g_a_p_s___client___exported___functions.html#gaf8deaa2a8975bdd3ca7700e536292acf">gaps_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">    simple_ble_client_id = <a class="code" href="group___s_i_m_p___client___exported___functions.html#ga76bea50116d524128da76b093954ed64">simp_ble_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">    bas_client_id = <a class="code" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gaeeb647a2ef6ccaa581cb5ca91c171ec5">bas_add_client</a>(app_central_client_callback, APP_MAX_LINKS);</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Client">3.2 Bluetooth LE Profile Client</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>5.3.5.1 gap service client</h5>
<p>gaps_client_id is the client id of gap service client. we can get <a class="el" href="group___g_a_p_s___client___exported___types.html#ggab875ae96297917a6abba4e091783b5dba984bb5328b9f376336229ea3eecd5a42">GAPS_CLIENT_CB_TYPE_DISC_STATE</a> and <a class="el" href="group___g_a_p_s___client___exported___types.html#ggab875ae96297917a6abba4e091783b5dba7590f1dadf5290cb1990814fe515cda5">GAPS_CLIENT_CB_TYPE_READ_RESULT</a> in this callback function. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_central_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_central_client_callback: client_id %d, conn_id %d&quot;</span>,</div><div class="line">                    client_id, conn_id);</div><div class="line">    <span class="keywordflow">if</span> (client_id == gaps_client_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_GAPS_CLIENT_CB_DATA</a> *p_gaps_cb_data = (<a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_GAPS_CLIENT_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_gaps_cb_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html#a324b415febc97f791d4f5b446395f90f">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___client___exported___types.html#ggab875ae96297917a6abba4e091783b5dba984bb5328b9f376336229ea3eecd5a42">GAPS_CLIENT_CB_TYPE_DISC_STATE</a>:</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___client___exported___types.html#ggab875ae96297917a6abba4e091783b5dba7590f1dadf5290cb1990814fe515cda5">GAPS_CLIENT_CB_TYPE_READ_RESULT</a>:</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___g_a_p_s___client.html">GAP Service Client</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>5.3.5.2 Battery Service Client</h5>
<p>bas_client_id is the client id of battery service client. we can get <a class="el" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga7ba1c1c50db3353743256e1695df82c3aee5cdea9e9cf8805ca63c8c93877e2ad">BAS_CLIENT_CB_TYPE_DISC_STATE</a> and <a class="el" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga7ba1c1c50db3353743256e1695df82c3a29e4816367d61d9a4fc9d12ae42a81b0">BAS_CLIENT_CB_TYPE_READ_RESULT</a> in this callback function. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_central_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_central_client_callback: client_id %d, conn_id %d&quot;</span>,</div><div class="line">                    client_id, conn_id);</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client_id == bas_client_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_BAS_CLIENT_CB_DATA</a> *p_bas_cb_data = (<a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_BAS_CLIENT_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_bas_cb_data-&gt;<a class="code" href="struct_t___b_a_s___c_l_i_e_n_t___c_b___d_a_t_a.html#af6030b18ec2f5e13c5776c79d8e3eef2">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga7ba1c1c50db3353743256e1695df82c3aee5cdea9e9cf8805ca63c8c93877e2ad">BAS_CLIENT_CB_TYPE_DISC_STATE</a>:</div><div class="line">        ......</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga7ba1c1c50db3353743256e1695df82c3a29e4816367d61d9a4fc9d12ae42a81b0">BAS_CLIENT_CB_TYPE_READ_RESULT</a>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___b_a_s___c_l_i_e_n_t.html">Battery Service Client</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>5.3.5.3 Simple BLE Service Client</h5>
<p>simple_ble_client_id is the client id of simple BLE service client. we can get related callback message in this callback function, such as:</p><ul>
<li><a class="el" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16a25ace9f93f2be96bc36def5c6dc827fa">SIMP_CLIENT_CB_TYPE_DISC_STATE</a></li>
<li><a class="el" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16a6d8f7a501cb2c6d988363a68f7eb878d">SIMP_CLIENT_CB_TYPE_READ_RESULT</a></li>
<li><a class="el" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16ab65daf2543231429c295fb288f98f4ed">SIMP_CLIENT_CB_TYPE_WRITE_RESULT</a></li>
<li><a class="el" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16a03017f1265b9f8c438501a916fbc6ac6">SIMP_CLIENT_CB_TYPE_NOTIF_IND_RESULT</a></li>
</ul>
<p>The sample code is as follows: </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_central_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_central_client_callback: client_id %d, conn_id %d&quot;</span>,</div><div class="line">                    client_id, conn_id);</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client_id == simple_ble_client_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html">T_SIMP_CLIENT_CB_DATA</a> *p_simp_client_cb_data = (<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html">T_SIMP_CLIENT_CB_DATA</a> *)p_data;</div><div class="line">        uint16_t value_size;</div><div class="line">        uint8_t *p_value;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_client_cb_data-&gt;<a class="code" href="struct_t___s_i_m_p___c_l_i_e_n_t___c_b___d_a_t_a.html#af97819e1a38466d63db711b413c921eb">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___client___exported___types.html#gga15bd4ec4037490fcf6d38d0b98dbac16a25ace9f93f2be96bc36def5c6dc827fa">SIMP_CLIENT_CB_TYPE_DISC_STATE</a>:</div><div class="line">        ......</div><div class="line">}</div></div><!-- fragment --><p>More information can be found in <a class="el" href="group___s_i_m_p___client.html">Simple BLE Service Client</a>.</p>
<h4><a class="anchor" id="AN201_DIS_GATT_SERVICE_PROC"></a>
5.3.6 Discover GATT Services Procedure</h4>
<p>This central application will automatically discover services after receiving message LE_GAP_MSG_TYPE_CONN_MTU_INFO. Discover GATT services procedure is defined in app_central_client_discov_services . More information can be found in CENTRAL_SRV_DIS . </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_mtu_info_evt(uint8_t conn_id, uint16_t mtu_size)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_handle_conn_mtu_info_evt: conn_id %d, mtu_size %d&quot;</span>, conn_id, mtu_size);</div><div class="line">    app_central_client_discov_services(conn_id, <span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><p> app_central_client_discov_services() flow chart is shown in Figure 5-2. </p><div class="image">
<img src="central_discover.png" alt="central_discover.png"/>
</div>
 <center><div id="figure_5_2"><b>Figure 5-2 app_central_client_discov_services() Flow Chart </b></div></center><p>The application will call app_central_client_discov_services() when receiving <a class="el" href="group___g_a_p_s___client___exported___types.html#gga051c4949b48749537e1bcc0e0c06be32aa93ae87db3cce47d601cd7ea3895ba88">DISC_GAPS_DONE</a> , <a class="el" href="group___s_i_m_p___client___exported___types.html#gga4a33a494451eff165a7a3e5ded36b7c4a325ea9c10baadbd6a125c8ebe5edbdf4">DISC_SIMP_DONE</a> and <a class="el" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga74ea5a0016191efcf9e25a45b15bff30a93c41b2a4379e8b7f9b83b9223ba691f">DISC_BAS_DONE</a> . <br />
 Reference code is shown below: </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_central_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___client___exported___types.html#gga051c4949b48749537e1bcc0e0c06be32aa93ae87db3cce47d601cd7ea3895ba88">DISC_GAPS_DONE</a>:</div><div class="line">        app_link_table[conn_id].discovered_flags |= APP_DISCOV_GAPS_FLAG;</div><div class="line">        app_link_table[conn_id].srv_found_flags |= APP_DISCOV_GAPS_FLAG;</div><div class="line">        app_central_client_discov_services(conn_id, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">/* Discovery Simple BLE service procedure successfully done. */</span></div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_central_client_callback: discover gaps procedure done.&quot;</span>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___client___exported___types.html#gga4a33a494451eff165a7a3e5ded36b7c4a325ea9c10baadbd6a125c8ebe5edbdf4">DISC_SIMP_DONE</a>:</div><div class="line">        <span class="comment">/* Discovery Simple BLE service procedure successfully done. */</span></div><div class="line">        app_link_table[conn_id].discovered_flags |= APP_DISCOV_SIMP_FLAG;</div><div class="line">        app_link_table[conn_id].srv_found_flags |= APP_DISCOV_SIMP_FLAG;</div><div class="line">        app_central_client_discov_services(conn_id, <span class="keyword">false</span>);</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_central_client_callback: discover simp procedure done.&quot;</span>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga74ea5a0016191efcf9e25a45b15bff30a93c41b2a4379e8b7f9b83b9223ba691f">DISC_BAS_DONE</a>:</div><div class="line">        <span class="comment">/* Discovery BAS procedure successfully done. */</span></div><div class="line">        app_link_table[conn_id].discovered_flags |= APP_DISCOV_BAS_FLAG;</div><div class="line">        app_link_table[conn_id].srv_found_flags |= APP_DISCOV_BAS_FLAG;</div><div class="line">        app_central_client_discov_services(conn_id, <span class="keyword">false</span>);</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_central_client_callback: discover bas procedure done&quot;</span>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">     ......</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Central_Config"></a>
5.4 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_central_flags.h. <br />
 Config GATT services storage. the default value is 0, If configure to 1, the GATT services discovery results will save to the flash. <br />
 </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_GATT_SRV_HANDLE_STORAGE     0</span></div></div><!-- fragment --><p> User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN201_GATT_SERVICE_STORAGE"></a>
5.4.1 GATT services handles storage</h4>
<p>app_save_srvs_hdl_table() is used to save the information to flash. <br />
 app_load_srvs_hdl_table() is used to load the information from flash. <br />
 Reference code is shown below: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t      srv_found_flags;</div><div class="line">    uint8_t      bd_type;         </div><div class="line">    uint8_t      bd_addr[<a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>];  </div><div class="line">    uint32_t     reserved;</div><div class="line">    uint16_t     gaps_hdl_cache[<a class="code" href="group___g_a_p_s___client___exported___types.html#gga11fe06609db5a4d8d442d1422611c7f5ac8d722f7bf15a94b708a67726ba3089a">HDL_GAPS_CACHE_LEN</a>];</div><div class="line">    uint16_t     simp_hdl_cache[<a class="code" href="group___s_i_m_p___client___exported___types.html#ggaad16f56b3dab2181d7f4ac60b18841a1ab2c55dc1a8ffa0cbd5ca709277c9a2a3">HDL_SIMBLE_CACHE_LEN</a>];</div><div class="line">    uint16_t     bas_hdl_cache[<a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga319921dc4dbb4ebb3a2a037d1d019d45a5a4de443cc8dbbb3873195336c2c6407">HDL_BAS_CACHE_LEN</a>];</div><div class="line">} T_APP_SRVS_HDL_TABLE;</div><div class="line"></div><div class="line">uint32_t app_save_srvs_hdl_table(T_APP_SRVS_HDL_TABLE *p_info)</div><div class="line">uint32_t app_load_srvs_hdl_table(T_APP_SRVS_HDL_TABLE *p_info)</div></div><!-- fragment --><p>app_central_client_discov_services() flow chart is shown in Figure 5-3. </p><div class="image">
<img src="central_discover2.png" alt="central_discover2.png"/>
</div>
 <center><div id="figure_5_3"><b>Figure 5-3 app_central_client_discov_services() Flow Chart (F_BT_GATT_SRV_HANDLE_STORAGE) </b></div></center><h3><a class="anchor" id="Central_Cmd"></a>
5.5 User Command</h3>
<p>BLE Central Application need to perform interaction by inputting command through Data UART in PC. <br />
 More information on user command can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a>. <br />
</p>
<h3><a class="anchor" id="Central_Test"></a>
5.6 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE Central application to the Evolution Board.</li>
<li>By using the commands described in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a>, some processes of GAP Central Role and GATT Client can be demonstrated.</li>
<li>Please use DebugAnalyser Tool to get the log.</li>
</ol>
<h4><a class="anchor" id="Central_Test_Periph"></a>
5.6.1 Test with BLE Peripheral Application Device</h4>
<p>BLE Central Application can test with BLE peripheral application. More information on peripheral can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Peripheral_Application">4 BLE Peripheral Application</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>5.6.1.1 one link test</h5>
<p>Please prepare two Evolution Board:</p><ul>
<li>one Evolution Board build and download the BLE Central application image.</li>
<li>one Evolution Board build and download the BLE Peripheral application image. Please modify BLE address to "x00 x11 x22 x33 x44 x00".<br />
</li>
</ul>
<p>Bluetooth address can be configured by MCU Configure Tool. <br />
</p>
<div class="image">
<img src="central_ble_address.png" alt="central_ble_address.png"/>
</div>
 <center><div id="figure_5_4"><b>Figure 5-4 Peripheral Ble Address Set </b></div></center><p><b>Scanning</b> <br />
 <br />
 Scanning Procedure Description: <br />
 Demonstrate searching for any BLE device discoverable nearby. <br />
 Scanning Procedure:</p><ul>
<li>UserCmd_scan 0 - Start scan and view information on BLE device discovered nearby.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**GAP scan start</div><div class="line">[APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x13, bd_addr 00::11::22::33::44::00, addr_type 0, rssi -42, data_len 23, data_status 0x0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_stopscan - Stop scan.<br />
 Log tool shows : <br />
 <div class="fragment"><div class="line">[APP] !**GAP scan stop</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_showdev - Show scan device list, and the device list is filtered by simple BLE service uuid.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Advertising and Scan response: filter uuid = 0xA00A dev list</div><div class="line">RemoteBd[0] = [00:11:22:33:44:00] type = 0</div></div><!-- fragment --></li>
</ul>
<p><br />
 <b>Connection and Reconnection</b> <br />
 <br />
 Procedure Description: <br />
 Demonstrate connecting to and disconnecting from the device at opposite terminal. <br />
 Procedure:</p><ul>
<li>UserCmd_condev 0 - Initiate connection.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_showcon - Show connection information.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">ShowCon conn_id 0 state 0x00000002 role 1</div><div class="line">RemoteBd = [00:11:22:33:44:00] type = 0</div><div class="line">active link num 1,  idle link num 1</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_conupdreq 0 1 - Initiate connection parameter update request.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**app_handle_conn_param_update_evt update success:conn_id 0, conn_interval 0xa, conn_slave_latency 0x0, conn_supervision_timeout 0x3e8</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_disc 0 - Disconnect from the peripheral device.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Disconnect conn_id 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_condev 0 - Reconnect with the peripheral device.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 0</div></div><!-- fragment --></li>
</ul>
<p><br />
 <b>Pair</b> <br />
 <br />
 Procedure Description: <br />
 Demonstrate pairing with the peripheral device. <br />
 Procedure:</p><ul>
<li>UserCmd_sauth 0 - Send authentication request.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Pair success</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_bondinfo - Show bonding information.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">bond_dev[0]: bd 0x001122334400, addr_type 0, flags 0x000000bf</div></div><!-- fragment --></li>
</ul>
<p><br />
 <b>GATT services</b> <br />
 <br />
 Procedure Description: <br />
 Demonstrate GATT services referenced procedures. <br />
 <br />
 GAP service procedure:</p><ul>
<li>UserCmd_gaphdl 0 - Print out the list of handles acquired in GAP service.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">--&gt;Index 0 -- Handle 0x00000005</div><div class="line">--&gt;Index 1 -- Handle 0x0000000d</div><div class="line">--&gt;Index 2 -- Handle 0x00000007</div><div class="line">--&gt;Index 3 -- Handle 0x00000009</div><div class="line">--&gt;Index 4 -- Handle 0x0000000d</div><div class="line">--&gt;Index 5 -- Handle 0x00000000</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_gapread 0 0 - Read the value of device name.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___g_a_p_s___client___exported___types.html#gga11cedc47297e91fd4fa5dce50d0e13e5a68709b64fad897382415f76f9f05c532">GAPS_READ_DEVICE_NAME</a>: device name BLE_PERIPHERAL.</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_gapread 0 1 - Read the value of appearance.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___g_a_p_s___client___exported___types.html#gga11cedc47297e91fd4fa5dce50d0e13e5a1a7f95427532c3c1218b461439205ecd">GAPS_READ_APPEARANCE</a>: appearance 0</div></div><!-- fragment --> <br />
</li>
</ul>
<p>Battery service procedure: <br />
</p><ul>
<li>UserCmd_bashdl 0 - Print out the list of handles acquired in battery service.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">--&gt;Index 0 -- Handle 0x00000019</div><div class="line">--&gt;Index 1 -- Handle 0x0000ffff</div><div class="line">--&gt;Index 2 -- Handle 0x0000001b</div><div class="line">--&gt;Index 3 -- Handle 0x0000001c</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_basread 0 0 - Read the value of battery level value.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga801969ec8dd873ff9d2f07016ca0d8ccadfab201a96c7dad7c934b90219f7efda">BAS_READ_BATTERY_LEVEL</a>: battery level 90</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_basread 0 1 - Read CCCD bit of battery level characteristic.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga801969ec8dd873ff9d2f07016ca0d8cca3cfb702985c2434ebbe0e808a4e81979">BAS_READ_NOTIFY</a>: notify 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_bascccd 0 1 - Write CCCD bit of battery level characteristic.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___b_a_s___c_l_i_e_n_t_____exported___types.html#gga6fa6b2111df9d59e3a7199f6d147d102a977f04ea6e11e7bca0c36f16c6a663c0">BAS_WRITE_NOTIFY_ENABLE</a>: write result 0x0</div></div><!-- fragment --> <br />
</li>
</ul>
<p>Simple ble service procedure:</p><ul>
<li>UserCmd_simphdl 0 - Print out the list of handles acquired in simple ble service.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">--&gt;Index 0 -- Handle 0x0000000e</div><div class="line">--&gt;Index 1 -- Handle 0x00000018</div><div class="line">--&gt;Index 2 -- Handle 0x00000010</div><div class="line">--&gt;Index 3 -- Handle 0x00000012</div><div class="line">--&gt;Index 4 -- Handle 0x00000014</div><div class="line">--&gt;Index 5 -- Handle 0x00000015</div><div class="line">--&gt;Index 6 -- Handle 0x00000017</div><div class="line">--&gt;Index 7 -- Handle 0x00000018</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpread 0 0 0 - Read the value of V1 characteristic through handle.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#ggac3c7ddfdf09444d51e049fec331f12e6afd71a262e2bc8b7c490c29e8c77eb9fc">SIMP_READ_V1_READ</a>: value_size 2, value 01-02</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpread 0 0 1 - Read the value of V1 characteristic through uuid.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#ggac3c7ddfdf09444d51e049fec331f12e6afd71a262e2bc8b7c490c29e8c77eb9fc">SIMP_READ_V1_READ</a>: value_size 2, value 01-02</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpread 0 1 0 - Read CCCD bit of V3 characteristic.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#ggac3c7ddfdf09444d51e049fec331f12e6a7d8ddf29a225d538d6e6ece1bd67a00f">SIMP_READ_V3_NOTIFY_CCCD</a>: notify 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpread 0 2 0 - Read CCCD bit of V4 characteristic.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#ggac3c7ddfdf09444d51e049fec331f12e6a603a8a502e3d2ba120f80ba2e4097e88">SIMP_READ_V4_INDICATE_CCCD</a>: indicate 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpcccd 0 0 1 - Write CCCD bit of V3 characteristic.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#gga3ea56e3c02ba1f7ff3bd95829763399da225fbc87d6a7be35b17582598a06c51f">SIMP_WRITE_V3_NOTIFY_CCCD</a>: write result 0x0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_simpwritev2 0 1 10 - Write V2 characteristic value using write request.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___s_i_m_p___client___exported___types.html#gga3ea56e3c02ba1f7ff3bd95829763399da2fac6036d3fcdd172926c72657e73802">SIMP_WRITE_V2_WRITE</a>: write result 0x0</div></div><!-- fragment --></li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>5.6.1.2 two links test</h5>
<p>Please prepare three Evolution Board:</p><ul>
<li>one Evolution Board build and download the BLE Central application image</li>
<li>one Evolution Board build and download the BLE Peripheral application image. Please set BLE address to "x00 x11 x22 x33 x44 x00"</li>
<li>one Evolution Board build and download the BLE Peripheral application image. Please set BLE address to "x00 x11 x22 x33 x44 x01"</li>
</ul>
<p>Bluetooth address can be configured by MCU Configure Tool. <br />
</p>
<p>Test Procedure:</p><ul>
<li>UserCmd_scan 0 - Start scan and view information on BLE device discovered nearby.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**GAP scan start </div><div class="line">0009074  09-26#15:05:42.022  119  0044787.825  [APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x13, bd_addr 00::11::22::33::44::00, addr_type 0, rssi -42, data_len 23, data_status 0x0</div><div class="line">0009074  09-26#15:05:42.022  119  0044787.825  [APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x13, bd_addr 00::11::22::33::44::01, addr_type 0, rssi -42, data_len 23, data_status 0x0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_stopscan - Stop scan.<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**GAP scan stop</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_showdev - Show scan device list, and the device list is filtered by simple ble serice uuid.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Advertising and Scan response: filter uuid = 0xA00A dev list</div><div class="line">RemoteBd[0] = [00:11:22:33:44:00] type = 0</div><div class="line">RemoteBd[1] = [00:11:22:33:44:01] type = 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_condev 0 - Initiate connection for the first peripheral device.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 0</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_condev 1 - Initiate connection for the second peripheral device.<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 1</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_sauth 0 - Send authentication request(conn_id=0).<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Pair success</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_sauth 1 - Send authentication request(conn_id=1).<br />
 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Pair success</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_gapread 0 0 - Read the value of device name(conn_id=0).<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___g_a_p_s___client___exported___types.html#gga11cedc47297e91fd4fa5dce50d0e13e5a68709b64fad897382415f76f9f05c532">GAPS_READ_DEVICE_NAME</a>: device name BLE_PERIPHERAL.</div></div><!-- fragment --> <br />
</li>
<li>UserCmd_gapread 1 0 - Read the value of device name(conn_id=1).<br />
 Log tool shows: <br />
 <div class="fragment"><div class="line">[APP] !**<a class="code" href="group___g_a_p_s___client___exported___types.html#gga11cedc47297e91fd4fa5dce50d0e13e5a68709b64fad897382415f76f9f05c532">GAPS_READ_DEVICE_NAME</a>: device name BLE_PERIPHERAL.</div></div><!-- fragment --></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Scatternet_Application"></a>
6 BLE Scatternet Application</h2>
<h3><a class="anchor" id="Scatternet_Introduction"></a>
6.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE scatternet application. The BLE scatternet project can be used as a framework to develop multiple-role based applications. This project supports multiple-role including broadcaster, observer, peripheral and central role.</p><ul>
<li>Scatternet topology featrues will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_SCATTERNET_FEATURE">6.1.1 Scatternet topology featrues</a>.</li>
<li>BLE Scatternet Application Project Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Proj">6.2 Project Overview</a>.</li>
<li>BLE Scatternet Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Ov">6.3 Source Code Overview</a>.</li>
<li>BLE Scatternet Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Config">6.4 APP Configurable Functions</a>.</li>
<li>BLE Scatternet Application User Command will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#Scatternet_Cmd">6.5 User Command</a>.</li>
</ul>
<h4><a class="anchor" id="AN204_SCATTERNET_FEATURE"></a>
6.1.1 Scatternet topology featrues</h4>
<ul>
<li>Slaves are permitted to have physical links to more than one master at a time.</li>
<li>A device is permitted to be master and slave at the same time.</li>
<li>Do not support role switch.</li>
</ul>
<h4><a class="anchor" id="AN204_EXP_FEATURE"></a>
6.1.2 Expose features</h4>
<p>This application exposes the following features:</p><ul>
<li>Link number:<ul>
<li>APP_MAX_LINKS in app_scatternet_flags.h. (Default two links) <br />
<br />
</li>
</ul>
</li>
<li>Support GATT services:<ul>
<li><a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e.html">GAP and GATT Inbox Services</a></li>
<li><a class="el" href="group___s_i_m_p___service.html">Simple Ble Service</a></li>
<li><a class="el" href="group___b_a_s.html">Battery Service</a> <br />
<br />
</li>
</ul>
</li>
<li>Support GATT clients:<ul>
<li><a class="el" href="group___g_a_p_s___client.html">GAP Service Client</a></li>
<li><a class="el" href="group___s_i_m_p___client.html">Simple BLE Service Client</a></li>
<li><a class="el" href="group___b_a_s___c_l_i_e_n_t.html">Battery Service Client</a> <br />
<br />
</li>
</ul>
</li>
<li>Airplane mode setting:<ul>
<li>Need to configure F_BT_AIRPLANE_MODE_SUPPORT to open. (Default closed) <br />
<br />
</li>
</ul>
</li>
<li>GAP Service characteristic writeable:<ul>
<li>Need to configure F_BT_GAPS_CHAR_WRITEABLE to open. (Default closed) <br />
<br />
</li>
</ul>
</li>
<li>Use static random address:<ul>
<li>Need to configure F_BT_LE_USE_STATIC_RANDOM_ADDR to open. (Default closed) <br />
<br />
</li>
</ul>
</li>
<li>Physical channel setting:<ul>
<li>Need to configure F_BT_LE_5_0_SET_PHY_SUPPORT to open. (Default opened)</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="Scatternet_Proj"></a>
6.2 Project Overview</h3>
<p>This section describes project directory and project structure. Reference files directory is as follows:</p><ul>
<li>Project directory: sdk\board\evb\ble_scatternet</li>
<li>Project source code directory: sdk\src\sample\ble_scatternet Directory structure of the project is shown in Figure 6-1. <div class="image">
<img src="scatternet_project.jpg" alt="scatternet_project.jpg"/>
</div>
 <center><div id="figure_6_1"><b>Figure 6-1 Scatternet Project Directory Structure </b></div></center></li>
</ul>
<p>The file list is divided into the following groups: </p><center><div id="table_6_1"><b>Table 6-1 Scatternet File List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Directory  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">include  </td><td class="markdownTableBodyLeft">ROM UUID header files. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">lib  </td><td class="markdownTableBodyLeft">The protocol stack and gap library file. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">cmsis  </td><td class="markdownTableBodyLeft">The cmsis source code. Users do not need to modify it.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">profile  </td><td class="markdownTableBodyLeft">The GATT profiles source code.<br />
More information on these files can be found in <a class="el" href="group___p_r_o_f_i_l_e___a_p_i.html">Profile</a>.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">app  </td><td class="markdownTableBodyLeft">The application source code.<br />
More information on these files can be found in <a class="el" href="group___s_c_a_t_t_e_r_n_e_t___d_e_m_o.html">BLE Scatternet App</a>.   </td></tr>
</table>
<h3><a class="anchor" id="Scatternet_Ov"></a>
6.3 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Scatternet Role. This chapter will be introduced according to the following several parts:</p><ul>
<li>Scatternet related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_INIT">6.3.1 Initialization</a>.</li>
<li>Scatternet related multi link manager please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_MULTI_LINK">6.3.2 Multilink Manager</a>.</li>
<li>Scatternet related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_GAP_MSG_HANDLER">6.3.3 GAP Message Handler</a>.</li>
<li>Scatternet related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_GAP_CB_HANDLER">6.3.4 GAP Callback Handler</a>.</li>
<li>Scatternet related GATT Profile message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_PROFILE_CLIENT_MSG_CB">6.3.5 Profile Client Message Callback</a> and <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN204_PROFILE_SERVICE_MSG_CB">6.3.6 Profile Service Message Callback</a>.</li>
</ul>
<h4><a class="anchor" id="AN204_INIT"></a>
6.3.1 Initialization</h4>
<p>Main function is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>();</div><div class="line">    app_service_init();</div><div class="line">    app_client_init();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> Please refer to <a class="el" href="group___s_c_a_t_t_e_r_n_e_t___d_e_m_o___m_a_i_n.html">Scatternet Main</a> for initialization function declaration. <br />
</p>
<p>GAP and GATT Profiles initialization flow:</p><ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init()</a> Initialize GAP and set link number. <br />
<br />
</li>
<li><a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init()</a> Initialize GAP utils lib. <br />
<br />
</li>
<li><p class="startli"><a class="el" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init()</a> User can easily customize the application by modifying the following parameter values.<br />
 1) device name and appearance </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Device name and device appearance */</span></div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_SCATTERNET&quot;</span>;</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">2) slave initialize mtu request </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* slave initialize mtu request */</span></div><div class="line">    uint8_t slave_init_mtu_req = <span class="keyword">false</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaf04baac1b9d2ef5d9695b5f5c8159f43">GAP_PARAM_SLAVE_INIT_GATT_MTU_REQ</a>,</div><div class="line">                     <span class="keyword">sizeof</span>(slave_init_mtu_req), &amp;slave_init_mtu_req);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">3) GAP Bond Manager parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* GAP Bond Manager parameters */</span></div><div class="line">    uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    uint8_t  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">4) airplan mode set </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_AIRPLANE_MODE_SUPPORT</span></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9afcebae2c58617ed03c21918ca7a442">gap_register_app_cb</a>(app_gap_common_callback);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">5) gaps characteristic writeable </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_GAPS_CHAR_WRITEABLE</span></div><div class="line">    uint8_t appearance_prop = <a class="code" href="group___g_a_p_s___write___p_r_o_p_e_r_t_y.html#gade3d8f5c2191e7ac51e3bda3cf225c2e">GAPS_PROPERTY_WRITE_ENABLE</a>;</div><div class="line">    uint8_t device_name_prop = <a class="code" href="group___g_a_p_s___write___p_r_o_p_e_r_t_y.html#gade3d8f5c2191e7ac51e3bda3cf225c2e">GAPS_PROPERTY_WRITE_ENABLE</a>;</div><div class="line">    <a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html">T_LOCAL_APPEARANCE</a> appearance_local;</div><div class="line">    <a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html">T_LOCAL_NAME</a> local_device_name;</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#ga0787406d86e51be9e599c6d6c527173d">flash_load_local_appearance</a>(&amp;appearance_local) == 0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fba3849419000f384d71d10c6224fd19ef1">GAPS_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(uint16_t), &amp;appearance_local.<a class="code" href="struct_t___l_o_c_a_l___a_p_p_e_a_r_a_n_c_e.html#a2be33a131837b177c6392baedb555220">local_appearance</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gaf0269765d3bdf4549141d649b959077f">flash_load_local_name</a>(&amp;local_device_name) == 0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fbac498fa7c44e396f7bd483fe40e290daa">GAPS_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, local_device_name.<a class="code" href="struct_t___l_o_c_a_l___n_a_m_e.html#ae7e6461cedc48b63f0cb62bba5c76b2c">local_name</a>);</div><div class="line">    }</div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fbaf54e0d607e3238d446c85ea5f844af5c">GAPS_PARAM_APPEARANCE_PROPERTY</a>, <span class="keyword">sizeof</span>(appearance_prop), &amp;appearance_prop);</div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gaf412bd8dc6e226d04fc9511922ffe7f5">gaps_set_parameter</a>(<a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___types.html#gga6f7de4bf3e9bb746fb058d191a3646fba5aa51fed2c85fc4c0fcd496967039450">GAPS_PARAM_DEVICE_NAME_PROPERTY</a>, <span class="keyword">sizeof</span>(device_name_prop), &amp;device_name_prop);</div><div class="line">    <a class="code" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#gadeefecf776f21919de999f1f9ce546d1">gatt_register_callback</a>(gap_service_callback);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">6) set prefer phy </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_LE_5_0_SET_PHY_SUPPORT</span></div><div class="line">    uint8_t  phys_prefer = <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gafb9a26e72087dfebc5a3c7e453039d65">GAP_PHYS_PREFER_ALL</a>;</div><div class="line">    uint8_t  tx_phys_prefer = <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a> | <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a> |</div><div class="line">                              <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gaabab2dd6adaf073deb92af970b404b7e">GAP_PHYS_PREFER_CODED_BIT</a>;</div><div class="line">    uint8_t  rx_phys_prefer = <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gae18d92b1f3fd298616dcf660d0549318">GAP_PHYS_PREFER_1M_BIT</a> | <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gaa57613bd029225e61b1267f8e66376b3">GAP_PHYS_PREFER_2M_BIT</a> |</div><div class="line">                              <a class="code" href="group___g_a_p___p_h_y_s___p_r_e_f_e_r.html#gaabab2dd6adaf073deb92af970b404b7e">GAP_PHYS_PREFER_CODED_BIT</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1b6bd46140c4e94e8ae79c9a23f281e6">GAP_PARAM_DEFAULT_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(phys_prefer), &amp;phys_prefer);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaa183de337bb7d026d5484d6944556990">GAP_PARAM_DEFAULT_TX_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(tx_phys_prefer), &amp;tx_phys_prefer);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eacd2c2351754a7a6972fb319f9e356ee3">GAP_PARAM_DEFAULT_RX_PHYS_PREFER</a>, <span class="keyword">sizeof</span>(rx_phys_prefer), &amp;rx_phys_prefer);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">7) le_register_app_cb(app_gap_callback) register gap message callback function app_gap_callback and all gap callback messages will be handled in this callback.</p>
<p class="startli">8) ble manager module initialize Initialize ble manager lib module to config support ble scan and ble advertising. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_gap_ble_mgr_init();</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_gap_ble_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html">BLE_MGR_PARAMS</a> param = {0};</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a50e84e72fc87e7f0652f7519248d96ab">ble_scan</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#ac842b6c1dcb3b1f11b611620199dc55c">enable</a> = <span class="keyword">true</span>;</div><div class="line">    param.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a4bd7683baadc3ca1ca7ae8c1b895611a">ble_ext_adv</a>.<a class="code" href="struct_b_l_e___m_g_r___p_a_r_a_m_s.html#a719280eb2fedb81d95d276e2addd979a">adv_num</a> = 1;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga9da52972f80798ac2d87254a8231fcd6">ble_mgr_init</a>(&amp;param);</div><div class="line">}</div></div><!-- fragment --><p class="startli">9) initialize advertising parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_LE_USE_STATIC_RANDOM_ADDR</span></div><div class="line">    app_adv_init_conn_random();</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    app_adv_init_conn_public();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
<li>app_service_init() Initialize GATT service. <br />
<br />
</li>
<li>app_client_init() Initialize GATT client.</li>
</ol>
<p>More information on LE GAP initialization and startup flow can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a>.</p>
<h4><a class="anchor" id="AN204_MULTI_LINK"></a>
6.3.2 Multilink Manager</h4>
<p>Application link control block is defined in app_scatternet_link_mgr.h </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>        conn_state;          </div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a>  bd_type;             </div><div class="line">    uint8_t                 bd_addr[<a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>]; </div><div class="line">} T_APP_LINK;</div><div class="line"></div><div class="line"><span class="keyword">extern</span> T_APP_LINK app_link_table[APP_MAX_LINKS];</div></div><!-- fragment --><p> app_link_table is used to save the connection link related information.</p>
<h4><a class="anchor" id="AN204_GAP_MSG_HANDLER"></a>
6.3.3 GAP Message Handler</h4>
<p>app_handle_gap_msg function is invoked whenever a GAP messages is received from the GAP. <br />
 More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>. <br />
</p>
<p>When receiving message <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>, app_handle_conn_state_evt() will update the information in app_link_table. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state,uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (conn_id &gt;= APP_MAX_LINKS)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: conn_id %d, conn_state(%d -&gt; %d), disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, app_link_table[conn_id].conn_state, new_state, disc_cause);</div><div class="line"></div><div class="line">    app_link_table[conn_id].conn_state = new_state;</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#gaecc521002738db2512fb90bdd2dbde1c">APP_PRINT_ERROR2</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: connection lost, conn_id %d, cause 0x%x&quot;</span>, conn_id,disc_cause);</div><div class="line">            }</div><div class="line"></div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Disconnect conn_id %d\r\n&quot;</span>, conn_id);</div><div class="line">            memset(&amp;app_link_table[conn_id], 0, <span class="keyword">sizeof</span>(T_APP_LINK));</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN204_GAP_CB_HANDLER"></a>
6.3.4 GAP Callback Handler</h4>
<p>app_gap_callback function is used to handle GAP callback messages. More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga50575af7f1139b4fec93ecd40ea2b83d">ble_mgr_handle_gap_cb</a>(cb_type, p_cb_data);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_gap_callback: cb_type 0x%x&quot;</span>, cb_type);</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="comment">/* common msg*/</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga6e7052b75a1a71ca8de684a3e8e58675">GAP_MSG_LE_READ_RSSI</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;GAP_MSG_LE_READ_RSSI:conn_id 0x%x cause 0x%x rssi %d&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2fb94f2fdffbd76cb43a16233f23827">p_le_read_rssi_rsp</a>-&gt;<a class="code" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2fb94f2fdffbd76cb43a16233f23827">p_le_read_rssi_rsp</a>-&gt;<a class="code" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2fb94f2fdffbd76cb43a16233f23827">p_le_read_rssi_rsp</a>-&gt;<a class="code" href="struct_t___l_e___r_e_a_d___r_s_s_i___r_s_p.html#a3b962e67ba74725bd60ca3c29f785abe">rssi</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN204_PROFILE_CLIENT_MSG_CB"></a>
6.3.5 Profile Client Message Callback</h4>
<p>When APP uses XXX_add_client to register specific client, APP shall register the callback function to handle the message from the specific client. APP can register different callback functions to handle different clients or register the common callback function to handle all messages from specific clients. app_client_callback function is the common callback function. app_client_callback can distinguish different clients by client id. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_client_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___client___common___exported___functions.html#ga8154deffc5d5e230be3159ebd77b8ac9">client_init</a>(3);</div><div class="line">    gaps_client_id  = <a class="code" href="group___g_a_p_s___client___exported___functions.html#gaf8deaa2a8975bdd3ca7700e536292acf">gaps_add_client</a>(app_client_callback, APP_MAX_LINKS);</div><div class="line">    simple_ble_client_id = <a class="code" href="group___s_i_m_p___client___exported___functions.html#ga76bea50116d524128da76b093954ed64">simp_ble_add_client</a>(app_client_callback, APP_MAX_LINKS);</div><div class="line">    bas_client_id = <a class="code" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gaeeb647a2ef6ccaa581cb5ca91c171ec5">bas_add_client</a>(app_client_callback, APP_MAX_LINKS);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_client_callback(<a class="code" href="group___g_a_t_t___client___common___exported___types.html#ga1dbc30752777dfb1ca20ca68b7bcf827">T_CLIENT_ID</a> client_id, uint8_t conn_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a>  result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_client_callback: client_id %d, conn_id %d&quot;</span>,</div><div class="line">                    client_id, conn_id);</div><div class="line">    <span class="keywordflow">if</span> (client_id == <a class="code" href="group___g_a_t_t___client___common___exported___macros.html#ga94e1b4c7a2509ddd01c4519683160525">CLIENT_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html">T_CLIENT_APP_CB_DATA</a> *p_client_app_cb_data = (<a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html">T_CLIENT_APP_CB_DATA</a> *)p_data;</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (p_client_app_cb_data-&gt;<a class="code" href="struct_t___c_l_i_e_n_t___a_p_p___c_b___d_a_t_a.html#a70b1275c6f7ff519922dfba8c350c1f4">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___general__cb__data.html#gga7b98a0f6df8596398cbb3314d955ae00a763d2c5ecbc047886c29010fb652f5c0">CLIENT_APP_CB_TYPE_DISC_STATE</a>:</div><div class="line">        ......</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client_id == gaps_client_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_GAPS_CLIENT_CB_DATA</a> *p_gaps_cb_data = (<a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html">T_GAPS_CLIENT_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_gaps_cb_data-&gt;<a class="code" href="struct_t___g_a_p_s___c_l_i_e_n_t___c_b___d_a_t_a.html#a324b415febc97f791d4f5b446395f90f">cb_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_p_s___client___exported___types.html#ggab875ae96297917a6abba4e091783b5dba984bb5328b9f376336229ea3eecd5a42">GAPS_CLIENT_CB_TYPE_DISC_STATE</a>:</div><div class="line">        .....</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li>client_init(3) Initialize parameters of GATT client and set the number of clients that needs to register. <br />
<br />
</li>
<li><a class="el" href="group___g_a_p_s___client___exported___functions.html#gaf8deaa2a8975bdd3ca7700e536292acf">gaps_add_client()</a> Add gap service client to application. <br />
<br />
</li>
<li><a class="el" href="group___s_i_m_p___client___exported___functions.html#ga76bea50116d524128da76b093954ed64">simp_ble_add_client()</a> Add simple ble service client to application. <br />
<br />
</li>
<li><a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gaeeb647a2ef6ccaa581cb5ca91c171ec5">bas_add_client()</a> Add battery service client to application.</li>
</ol>
<p>Scatternet APP supports several GATT profile clients including: <br />
</p><ul>
<li><a class="el" href="group___g_a_p_s___client.html">GAP Service Client</a></li>
<li><a class="el" href="group___s_i_m_p___client.html">Simple BLE Service Client</a></li>
<li><a class="el" href="group___b_a_s___c_l_i_e_n_t.html">Battery Service Client</a></li>
</ul>
<h4><a class="anchor" id="AN204_PROFILE_SERVICE_MSG_CB"></a>
6.3.6 Profile Service Message Callback</h4>
<p>When APP uses XXX_add_service to register specific service, APP shall register the callback function to handle the message from the specific service. APP shall call <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a> to register the callback function used to handle the message from the profile server layer. APP can register different callback functions to handle different services or register the common callback function to handle all messages from specific services and profile server layer. app_service_callback function is the common callback function which can distinguish different services by service id. <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_service_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(2);</div><div class="line">    simp_srv_id = <a class="code" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service</a>(app_service_callback);</div><div class="line">    bas_srv_id  = <a class="code" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a>(app_service_callback);</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a>(app_service_callback);</div><div class="line">}</div><div class="line"></div><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>:</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_service_callback: PROFILE_EVT_SRV_REG_COMPLETE result %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#a4a385380321b6b14cb5cc01f89d4ed02">service_reg_result</a>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">            ......</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init()</a> Initialize parameters of GATT Server and set the number of services that needs to register. <br />
<br />
</li>
<li><a class="el" href="group___s_i_m_p___service___exported___functions.html#ga67af3dc85c06595757de67de3e9918c6">simp_ble_service_add_service()</a> Add simple BLE service to the BLE stack database. <br />
<br />
</li>
<li><a class="el" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a> Add battery service to the BLE stack database. <br />
<br />
</li>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a> Register server callback function to send events to application. More information can be found in BLE_Profile_Server_User_Manual.</li>
</ol>
<p><a class="anchor" id="invalid"></a></p><h5>6.3.6.1 General profile server callback</h5>
<p><a class="el" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a> is the service id used by profile server layer. Profile server layer contains two message type:</p><ul>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a> : Services registration process has been completed in GAP Start Flow.</li>
<li><a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a> : This message is used by profile server layer to inform the result of sending the notification/indication.</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <span class="keywordflow">if</span> (service_id == <a class="code" href="group___general___service___i_d.html#ga57766a6280cddcc4dbc90f20319e777e">SERVICE_PROFILE_GENERAL_ID</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *p_param = (<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html">T_SERVER_APP_CB_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#aa5343b97d75671fa26fc9d752b24ef28">eventId</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540eabb6b113b293ad357e06fe37658872286">PROFILE_EVT_SRV_REG_COMPLETE</a>:<span class="comment">// srv register result event.</span></div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;PROFILE_EVT_SRV_REG_COMPLETE: result %d&quot;</span>,</div><div class="line">                            p_param-&gt;<a class="code" href="struct_t___s_e_r_v_e_r___a_p_p___c_b___d_a_t_a.html#ad0765da8b416d19e3c20261b5c060ccf">event_data</a>.<a class="code" href="union_t___s_e_r_v_e_r___c_b___d_a_t_a.html#a4a385380321b6b14cb5cc01f89d4ed02">service_reg_result</a>);</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___c_b___d_a_t_a.html#gga54eeb1ceeeb4e906d9793097cf0b540ea2154e2a880faa5a33fdeb6c52b910de4">PROFILE_EVT_SEND_DATA_COMPLETE</a>:</div><div class="line">        .....</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>6.3.6.2 Battery Service</h5>
<p>bas_srv_id is the service id of battery service. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (service_id == bas_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_BAS_CALLBACK_DATA</a> *p_bas_cb_data = (<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html">T_BAS_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_bas_cb_data-&gt;<a class="code" href="struct_t___b_a_s___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>:</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___b_a_s.html">Battery Service</a>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>6.3.6.3 Simple BLE Service</h5>
<p>simp_srv_id is the service id of simple BLE service. </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_service_callback(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (service_id == simp_srv_id)</div><div class="line">    {</div><div class="line">        <a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *p_simp_cb_data = (<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html">TSIMP_CALLBACK_DATA</a> *)p_data;</div><div class="line">        <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#ab7ead957ed5cb2f53052af5e39e98a79">msg_type</a>)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gga1ae3e282729216efbd709224940575a7afe1590116cfee64d544e663668cd1ab9">SERVICE_CALLBACK_TYPE_INDIFICATION_NOTIFICATION</a>:</div><div class="line">            {</div><div class="line">                <span class="keywordflow">switch</span> (p_simp_cb_data-&gt;<a class="code" href="struct_t_s_i_m_p___c_a_l_l_b_a_c_k___d_a_t_a.html#aaad4ba0052f839e3b4b82f70ff004a99">msg_data</a>.<a class="code" href="union_t_s_i_m_p___u_p_s_t_r_e_a_m___m_s_g___d_a_t_a.html#a3f378b9155ed3f389385389f97cf360c">notification_indification_index</a>)</div><div class="line">                {</div><div class="line">                <span class="keywordflow">case</span> <a class="code" href="group___s_i_m_p___service___notify___indicate___info.html#ga18622464158f0f8e8dee4322e53fd7fc">SIMP_NOTIFY_INDICATE_V3_ENABLE</a>:</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> More information can be found in <a class="el" href="group___s_i_m_p___service.html">Simple Ble Service</a>.</p>
<h3><a class="anchor" id="Scatternet_Config"></a>
6.4 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_scatternet_flags.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_AIRPLANE_MODE_SUPPORT          0</span></div><div class="line"><span class="preprocessor">#define F_BT_GAPS_CHAR_WRITEABLE            0</span></div><div class="line"><span class="preprocessor">#define F_BT_LE_5_0_SET_PHY_SUPPORT         1</span></div><div class="line"><span class="preprocessor">#define F_BT_LE_USE_STATIC_RANDOM_ADDR      0</span></div></div><!-- fragment --><p> User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN204_AIRPLAN_MODE"></a>
6.4.1 Airplane mode setting</h4>
<p>Need to configure F_BT_AIRPLANE_MODE_SUPPORT to open. <br />
 More information can be found in GapUse_Airplane.</p>
<h4><a class="anchor" id="AN204_GA_SERVICE_WRITE"></a>
6.4.2 GAP Service characteristic writeable</h4>
<p>Need to configure F_BT_GAPS_CHAR_WRITEABLE to open. <br />
 More information can be found in GapUse_GAPS.</p>
<h4><a class="anchor" id="AN204_STATIC_ADDR"></a>
6.4.3 Use static random address</h4>
<p>Need to configure F_BT_LE_USE_STATIC_RANDOM_ADDR to open. <br />
 More information can be found in GapUse_Random.</p>
<h4><a class="anchor" id="AN204_PHY_SET"></a>
6.4.4 PHY setting</h4>
<p>Need to configure F_BT_LE_5_0_SET_PHY_SUPPORT to open. <br />
 More information can be found in GapUse_Phy.</p>
<h3><a class="anchor" id="Scatternet_Cmd"></a>
6.5 User Command</h3>
<p>Please prepare three evb bord: <br />
</p><ul>
<li>The first evb board please dowload ble_scatternet application image, this evb board as DUT device and set address to 00:11:22:33:44:80 <br />
</li>
<li>The second evb board please dowload ble_peripheral application image, this evb board as RRD1 device and set address to 00:11:22:33:44:81 <br />
</li>
<li>The third evb board please dowload ble_central application image, this evb board as RRD5 device and set address to 00:11:22:33:44:85 <br />
</li>
</ul>
<p>BLE Scatternent Application need to perform interaction by inputting command through Data UART in PC. More information on user command can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a>.</p>
<h4><a class="anchor" id="Test_with_ble_peripheral_project_and_ble_central_project"></a>
6.5.1 Test with ble_peripheral project and ble_central project</h4>
<h5>6.5.1.1 Test with ble_peripheral project</h5>
<ul>
<li>Press the reset button for DUT and RRD1 respectively <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">&gt;&gt; Command Parse Init (scatternet) &lt;&lt;</div><div class="line">local bd addr: 0x00:11:22:33:44:80</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: bondclear <br />
 DUT Log tool shows: <div class="fragment"><div class="line">[GAP] !**le_clear_all_keys</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: scan <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">GAP scan start</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: stopscan <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">GAP scan stop</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: showdev <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Advertising and Scan response: filter uuid = 0xA00A dev list</div><div class="line">RemoteBd[0] = [00:11:22:33:44:81] type = 0</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: condev 0 <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 0</div></div><!-- fragment --></li>
</ul>
<h5>6.5.1.2 Test with ble_central project</h5>
<ul>
<li>Press the reset button for RRD5 <br />
 RRD5 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">&gt;&gt; Command Parse Init (central) &lt;&lt;</div><div class="line">local bd addr: 0x00:11:22:33:44:85</div></div><!-- fragment --> <br />
</li>
<li>RRD5 Serial port assistant tool input cmd: bondclear <br />
 RRD5 Log tool shows: <div class="fragment"><div class="line">[GAP] !**le_clear_all_keys</div></div><!-- fragment --> <br />
</li>
<li>DUT Serial port assistant tool input cmd: startadv <br />
 DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">GAP adv start</div></div><!-- fragment --> <br />
</li>
<li>RRD5 Serial port assistant tool input cmd: scan <br />
 RRD5 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">GAP scan start</div></div><!-- fragment --> <br />
</li>
<li>RRD5 Serial port assistant tool input cmd: stopscan <br />
 RRD5 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">GAP scan stop</div></div><!-- fragment --> <br />
</li>
<li>RRD5 Serial port assistant tool input cmd: showdev <br />
 RRD5 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Advertising and Scan response: filter uuid = 0xA00A dev list</div><div class="line">RemoteBd[0] = [00:11:22:33:44:81] type = 0</div></div><!-- fragment --> <br />
</li>
<li>RRD5 Serial port assistant tool input cmd: condev 0 <br />
 RRD5 Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 0</div></div><!-- fragment --> DUT Serial port assistant tool shows: <br />
 <div class="fragment"><div class="line">Connected success conn_id 1</div></div><!-- fragment --></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_BT5_Peripheral_Application"></a>
7 BLE BT5 Peripheral Application</h2>
<h3><a class="anchor" id="BT5_Periph_Intro"></a>
7.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE BT5 Peripheral Application. The BLE BT5 Peripheral Application project implements a very simple BLE BT5 Peripheral Application and it can be used as a framework to develop many different Peripheral-role based applications. BLE BT5 Peripheral Application will be introduced according to the following several parts:<br />
</p><ul>
<li>BLE BT5 Peripheral role support features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_PERIPHERAL_ROLE">7.1.1 Peripheral role features</a>.</li>
<li>BLE BT5 Peripheral Application expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_EXP_FEATURE">7.1.2 Expose features</a>.</li>
<li>BLE BT5 Peripheral Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Ov">7.2 Source Code Overview</a>.</li>
<li>BLE BT5 Peripheral Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Config">7.3 APP Configurable Functions</a>.</li>
<li>BLE BT5 Peripheral Application Test Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_Periph_Test">7.4 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN206_PERIPHERAL_ROLE"></a>
7.1.1 Peripheral role features</h4>
<p>Peripheral role features:<br />
 1.Send advertising events with LE Advertising Extensions<br />
 2.Enable one or more advertising sets at the same time<br />
 3.Enable advertising set for a duration or maximum number of extended advertising events<br />
 4.Hold more data with extended advertising PDUs (observer or central support LE Advertising Extensions)<br />
 5.Can accept the establishment of LE link and become a slave role in the link on LE 1M PHY, LE 2M PHY or LE Coded PHY (central support LE Advertising Extensions)<br />
</p>
<h4><a class="anchor" id="AN206_EXP_FEATURE"></a>
7.1.2 Expose features</h4>
<p>This application exposes the following features:<br />
</p><ol type="1">
<li>DLPS:<br />
 Need to configure F_BT_DLPS_EN to open. (Default opened)<br />
</li>
<li>Link number:<br />
 APP_MAX_LINKS in app_bt5_peripheral_flags.h. (Default one link)<br />
</li>
<li>Advertising PHY:<br />
 ADVERTISING_PHY in app_bt5_peripheral_flags.h. <br />
 Default ADVERTISING_PHY is APP_PRIMARY_1M_SECONDARY_1M, primary advertising PHY is LE 1M PHY, secondary advertising PHY is LE 1M PHY.<br />
</li>
</ol>
<h4><a class="anchor" id="AN206_Compatibility"></a>
7.1.3 Compatibility</h4>
<p>If peripheral device uses LE Advertising Extensions, user shall take compatibility with peer device of different Bluetooth Technology versions into account. Compatibility with peer device of different Bluetooth Technology versions is shown in Table 7-1.</p>
<center><div id="table_7_1"><b>Table 7-1 Compatibility Of Peripheral Device With LE Advertising Extensions </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">BLE 5<br />
Feature  </th><th class="markdownTableHeadLeft">Advertising<br />
PDUs  </th><th class="markdownTableHeadLeft">BLE 4.0  </th><th class="markdownTableHeadLeft">BLE 4.1  </th><th class="markdownTableHeadLeft">BLE 4.2  </th><th class="markdownTableHeadLeft">BLE 5.0 <br />
(not use LE<br />
Advertising<br />
Extensions)  </th><th class="markdownTableHeadLeft">BLE 5.0<br />
(use LE<br />
Advertising<br />
Ext   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">LE<br />
Advertising<br />
Extensions  </td><td class="markdownTableBodyLeft">Extended<br />
advertising<br />
PDUs  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">N  </td><td class="markdownTableBodyLeft">Y   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">LE<br />
Advertising<br />
Extensions  </td><td class="markdownTableBodyLeft">Legacy<br />
advertising<br />
PDUs  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
</table>
<h3><a class="anchor" id="AN206_Periph_Ov"></a>
7.2 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Peripheral role with LE Advertising Extensions. This chapter will be introduced according to the following several parts:</p><ul>
<li>Peripheral role with LE Advertising Extensions related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_INIT">7.2.1 Initialization</a>.</li>
<li>Peripheral role with LE Advertising Extensions related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_GAP_MSG_HANDLER">7.2.2 GAP Message Handler</a>.</li>
<li>Peripheral role with LE Advertising Extensions related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN206_GAP_CB_HANDLER">7.2.3 GAP Callback Handler</a>.</li>
</ul>
<p>Due to support of LE Advertising Extensions, device can use one or more advertising sets. Application needs to create an advertising handle to identify advertising set, and extended advertising related parameters are configured for a specified advertising set. Using LE Advertising Extensions, application can choose to send legacy advertising PDUs (Peripheral_Page can only send legacy advertising PDUs) or extended advertising PDUs by modifying advertising event properties. More information please refers to BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a>.<br />
</p>
<h4><a class="anchor" id="AN206_INIT"></a>
7.2.1 Initialization</h4>
<p>Main function is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    app_peripheral_gap_init();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>GAP initialization flow:<br />
</p><ol type="1">
<li><a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init()</a> Initialize GAP and set link number.<br />
 <br />
</li>
<li><a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init()</a> Initialize GAP utils lib.<br />
 <br />
</li>
<li><p class="startli">app_peripheral_gap_init() Initialize GAP parameters.<br />
 1) device name and appearance </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Device name and device appearance */</span></div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_BT5_PERIPHERAL&quot;</span>;</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">2) slave initialize mtu request </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* slave initialize mtu request */</span></div><div class="line">    uint8_t  slave_init_mtu_req = <span class="keyword">false</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11eaf04baac1b9d2ef5d9695b5f5c8159f43">GAP_PARAM_SLAVE_INIT_GATT_MTU_REQ</a>,</div><div class="line">                     <span class="keyword">sizeof</span>(slave_init_mtu_req), &amp;slave_init_mtu_req);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">3) set tx octets and tx times for coded phy </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">   #if F_BT_LE_CODED_PHY_SUPPORT</span></div><div class="line">    uint16_t max_data_len_tx_oct = 251;</div><div class="line"><span class="preprocessor">#if LE_CODED_PHY_S8</span></div><div class="line">    uint16_t max_data_len_tx_time = 17040;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    uint16_t max_data_len_tx_time = 4542;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea6e01cd22a4f45beca91edd3688c5c91c">GAP_PARAM_DEFAULT_DATA_LEN_MAX_TX_OCTETS</a>, <span class="keyword">sizeof</span>(max_data_len_tx_oct),</div><div class="line">                     &amp;max_data_len_tx_oct);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea7e6f57b5f7db13e58e125655d0a5444e">GAP_PARAM_DEFAULT_DATA_LEN_MAX_TX_TIME</a>, <span class="keyword">sizeof</span>(max_data_len_tx_time),</div><div class="line">                     &amp;max_data_len_tx_time);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">4) GAP Bond Manager parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">   uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a> | <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga8c6188c207f5f749b0733453f7bf9ee0">GAP_AUTHEN_BIT_SC_FLAG</a>;</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#gafa5f8a475a6c3126ab20d51881e8dc8d">T_GAP_IO_CAP</a>  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a> | <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga8c6188c207f5f749b0733453f7bf9ee0">GAP_AUTHEN_BIT_SC_FLAG</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p class="startli">5) extended advertising related parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* set to enable LE Advertising Extensions */</span></div><div class="line">    <span class="keywordtype">bool</span> use_extended = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, <span class="keyword">sizeof</span>(use_extended), &amp;use_extended);</div><div class="line"></div><div class="line">    <span class="comment">/* ble manager module initialize ble extended advertising module*/</span></div><div class="line">    app_peripheral_gap_ble_mgr_init();</div><div class="line"></div><div class="line">    <span class="comment">/*advertising parameters initialize: use public address to advertise connectable undirected advertising*/</span></div><div class="line">    app_peripheral_adv_init_conn_undirect_public();</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<p>More information on LE GAP initialization and startup flow can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a>.<br />
 If BT5 peripheral application needs to support GATT Profiles, please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN200_PROFILE_SERVER_CB">4.3.4 Profile Message Callback</a> in Peripheral_Page.<br />
</p>
<h4><a class="anchor" id="AN206_GAP_MSG_HANDLER"></a>
7.2.2 GAP Message Handler</h4>
<p>app_peripheral_gap_handle_gap_msg() function is invoked whenever a GAP messages is received from the GAP.<br />
 More information on GAP messages can be found in UM021_BLE_GAP_Message.<br />
 <a class="el" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#gaa3f9acaeff2921be050227c988665a73">ble_mgr_handle_gap_msg()</a> in app_peripheral_gap_handle_gap_msg() is used to handle <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#ga8a61e3422055b5738fd0d5f24ac2d235">GAP_MSG_LE_EXT_ADV_STATE_CHANGE</a>.<br />
</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_gap_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_gap_msg)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t___l_e___g_a_p___m_s_g.html">T_LE_GAP_MSG</a> gap_msg;</div><div class="line"></div><div class="line">    memcpy(&amp;gap_msg, &amp;p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>, <span class="keyword">sizeof</span>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>));</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#gaa3f9acaeff2921be050227c988665a73">ble_mgr_handle_gap_msg</a>(p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>, &amp;gap_msg);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_gap_msg: subtype %d&quot;</span>, p_gap_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>);</div></div><!-- fragment --><p>when ble protocol stack init ready, call app_peripheral_adv_start() to start advertising. and when advertise has need success enabled app will receive <a class="el" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a> in app_peripheral_adv_callback(). </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_dev_state_evt: init state %d, adv state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>, new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a3e0c56e4030e8a65a67c54100483026e">gap_adv_state</a>, cause);</div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_init_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a> == <a class="code" href="group___g_a_p___i_n_i_t___s_t_a_t_e.html#ga895d6a97497c74480994ad044504aa13">GAP_INIT_STATE_STACK_READY</a>)</div><div class="line">        {</div><div class="line">            ......</div><div class="line">            <span class="comment">/*start advertising*/</span></div><div class="line">            app_peripheral_adv_start(0);</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_peripheral_adv_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a> cb_data;</div><div class="line">    memcpy(&amp;cb_data, p_cb_data, <span class="keyword">sizeof</span>(<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#gad2dc0692029ca3df07b95326745fcddd">BLE_EXT_ADV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: adv_state %d, adv_handle %d&quot;</span>,</div><div class="line">                             cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a96dc09ff81c490ab93ccf8145b2f9429">adv_handle</a>);</div><div class="line">            adv_state = cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: BLE_EXT_ADV_MGR_ADV_ENABLED&quot;</span>);</div><div class="line">            }</div><div class="line">            ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>BT5 peripheral application will call app_peripheral_adv_start() to enable specified advertising set when receives <a class="el" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>. <br />
When advertise has been success enabled app will receive <a class="el" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a> in app_peripheral_adv_callback(). </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_peripheral_gap_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state, uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_conn_state_evt: conn_id %d old_state %d new_state %d, disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, gap_conn_state, new_state, disc_cause);</div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_peripheral_gap_handle_conn_state_evt: connection lost cause 0x%x&quot;</span>, disc_cause);</div><div class="line">            }</div><div class="line">            <span class="comment">/*start advertising*/</span></div><div class="line">            app_peripheral_adv_start(0);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_peripheral_adv_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a> cb_data;</div><div class="line">    memcpy(&amp;cb_data, p_cb_data, <span class="keyword">sizeof</span>(<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html">T_BLE_EXT_ADV_CB_DATA</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#gad2dc0692029ca3df07b95326745fcddd">BLE_EXT_ADV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: adv_state %d, adv_handle %d&quot;</span>,</div><div class="line">                             cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>, cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a96dc09ff81c490ab93ccf8145b2f9429">adv_handle</a>);</div><div class="line">            adv_state = cb_data.<a class="code" href="union_t___b_l_e___e_x_t___a_d_v___c_b___d_a_t_a.html#a28834c69236a8dd84a2cb8cd96bd5679">p_ble_state_change</a>-&gt;<a class="code" href="struct_t___b_l_e___e_x_t___a_d_v___s_t_a_t_e___c_h_a_n_g_e.html#a4ba96644db04ef399056f6717d5666fa">state</a>;</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (adv_state == <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___types.html#ggac36a5ae5a7b98cc2dffe340704c8f2e3a3ad5f9978c6861ed2042360cef5e5186">BLE_EXT_ADV_MGR_ADV_ENABLED</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_peripheral_adv_callback: BLE_EXT_ADV_MGR_ADV_ENABLED&quot;</span>);</div><div class="line">            }</div><div class="line">            ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN206_GAP_CB_HANDLER"></a>
7.2.3 GAP Callback Handler</h4>
<p>app_peripheral_gap_callback function is used to handle GAP callback messages.<br />
 More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>. <br />
 <a class="el" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga50575af7f1139b4fec93ecd40ea2b83d">ble_mgr_handle_gap_cb()</a> in app_peripheral_gap_callback() is used to handle <a class="el" href="group___g_a_p___l_e___m_s_g___types.html#gaa97136cc735f2d28296ab3f93b1bab4a">GAP_MSG_LE_EXT_ADV_START_SETTING</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_peripheral_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga50575af7f1139b4fec93ecd40ea2b83d">ble_mgr_handle_gap_cb</a>(cb_type, p_cb_data);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_peripheral_gap_callback: cb_type = 0x%x&quot;</span>, cb_type);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="AN206_Periph_Config"></a>
7.3 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_bt5_peripheral_flags.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define ADVERTISING_PHY APP_PRIMARY_1M_SECONDARY_1M</span></div><div class="line"><span class="preprocessor">#define APP_MAX_LINKS 1</span></div><div class="line"><span class="preprocessor">#define F_BT_DLPS_EN  1</span></div></div><!-- fragment --><p> User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN206_DLPS"></a>
7.3.1 DLPS</h4>
<p>DLPS reference code is shown below: </p><div class="fragment"><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line"><span class="preprocessor">#include &lt;dlps.h&gt;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> pwr_mgr_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_BT_DLPS_EN</span></div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga973442724abf827f29d83a4b2f9369e2acc50404a0e14859034d4d8d7643e6977">BTPOWER_DEEP_SLEEP</a>);</div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddafefe15dc6f9b2184fb58be2274d5bb4e">POWER_DLPS_MODE</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h3><a class="anchor" id="AN206_Periph_Test"></a>
7.4 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE BT5 Peripheral application to the Evolution Board.</li>
<li>When BLE BT5 Peripheral Application is running on Evolution Board, the BLE device becomes discoverable and connectable. Remote device can scan the peripheral device and create connection with peripheral device.</li>
<li>After disconnection, BLE Peripheral Application will be discoverable and connectable again.</li>
</ol>
<h4><a class="anchor" id="AN206_BLE_CENTRAL_TEST"></a>
7.4.1 Test with BLE BT5 Central Application Device</h4>
<p>BLE BT5 peripheral Application can test with BLE BT5 central application. More information on central application can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Central_Application">8 BLE BT5 Central Application</a>. Please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Test_Periph">8.5.1 Test with BLE BT5 Peripheral Application Device</a> for the test procedure .</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_BT5_Central_Application"></a>
8 BLE BT5 Central Application</h2>
<h3><a class="anchor" id="BT5_Central_Intro"></a>
8.1 Introduction</h3>
<p>The purpose of this document is to give an overview of the BLE BT5 central application. The BLE BT5 central project implements a very simple BLE BT5 central device and it can be used as a framework to develop many different central-role based applications. BLE BT5 Central Application will be introduced according to the following several parts:<br />
</p><ul>
<li>Central role features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_CENTRAL_ROLE">8.1.1 Central role features</a>.</li>
<li>BLE BT5 Central Application Expose features will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_EXP_FEATURE">8.1.2 Expose features</a>.</li>
<li>BLE BT5 Central Application Source Code Overview will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Ov">8.2 Source Code Overview</a>.</li>
<li>BLE BT5 Central Application Configurable Functions will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Config">8.3 APP Configurable Functions</a>.</li>
<li>BLE BT5 Central Application User Command will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Cmd">8.4 User Command</a>.</li>
<li>BLE BT5 Central Application Test Procedure will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BT5_Central_Test">8.5 Test Procedure</a>.</li>
</ul>
<h4><a class="anchor" id="AN207_CENTRAL_ROLE"></a>
8.1.1 Central role features</h4>
<ol type="1">
<li>Extended scan for advertising packets on the primary advertising channel (LE 1M PHY or/and LE Coded PHY) <br />
</li>
<li>Scan for a duration, period scan<br />
</li>
<li>Can initiate connection and become a master role in the link on LE 1M PHY, LE 2M PHY or LE Coded PHY (peripheral support LE Advertising Extensions)<br />
</li>
</ol>
<h4><a class="anchor" id="AN207_EXP_FEATURE"></a>
8.1.2 Expose features</h4>
<p>This application exposes the following features:<br />
</p>
<ol type="1">
<li>APP_MAX_LINKS: <br />
 Configure APP LE link number<br />
 <div class="fragment"><div class="line"><span class="preprocessor">#define APP_MAX_LINKS  1</span></div></div><!-- fragment --> <br />
</li>
<li>APP_RECOMBINE_ADV_DATA: <br />
 Configure APP to recombine advertising data: 0 - Disable recombine advertising data feature, 1 - recombine advertising data<br />
 <div class="fragment"><div class="line"><span class="preprocessor">#define APP_RECOMBINE_ADV_DATA  0</span></div></div><!-- fragment --> <br />
</li>
<li>Enable AE advertising and AE scan <div class="fragment"><div class="line"><span class="preprocessor">#define F_BT_LE_5_0_AE_ADV_SUPPORT              1</span></div><div class="line"><span class="preprocessor">#define F_BT_LE_5_0_AE_SCAN_SUPPORT             1</span></div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="AN207_Compatibility"></a>
8.1.3 Compatibility</h4>
<p>Central device with LE Advertising Extensions can communicate with device using legacy advertising PDUs or extended advertising PDUs, and set duration of scan. If central device uses LE Advertising Extensions, compatibility with peer device of different BT versions is shown in Table 8-1.<br />
</p>
<center><div id="table_8_1"><b>Table 8-1 Compatibility Of Central Device With LE Advertising Extensions </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">BLE 5<br />
Feature  </th><th class="markdownTableHeadLeft">BLE 4.0  </th><th class="markdownTableHeadLeft">BLE 4.1  </th><th class="markdownTableHeadLeft">BLE 4.2  </th><th class="markdownTableHeadLeft">BLE 5.0 <br />
(not use LE<br />
Advertising<br />
Extensions)  </th><th class="markdownTableHeadLeft">BLE 5.0<br />
(use LE <br />
Advertising<br />
Extensions)   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">LE<br />
Advertising<br />
Extensions  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y  </td><td class="markdownTableBodyLeft">Y   </td></tr>
</table>
<h3><a class="anchor" id="BT5_Central_Ov"></a>
8.2 Source Code Overview</h3>
<p>The main purpose of this chapter is to help APP developers familiar with the development process related to Central role with LE Advertising Extensions. This chapter will be introduced according to the following several parts:</p><ul>
<li>Central role with LE Advertising Extensions related parameters and Bluetooth protocol stack initialization please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_INIT">8.2.1 Initialization</a>.</li>
<li>Central role with LE Advertising Extensions related GAP message handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_GAP_MSG_HANDLER">8.2.2 GAP Message Handler</a>.</li>
<li>Central role with LE Advertising Extensions related GAP callback handler please refer to chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN207_GAP_CB_HANDLER">8.2.3 GAP Callback Handler</a>.</li>
</ul>
<h4><a class="anchor" id="AN207_INIT"></a>
8.2.1 Initialization</h4>
<p><a class="el" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Entry of APP code. ">main()</a> is invoked when the application is powered on or the chip is reset, and it performs the following initialization functions: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(APP_MAX_LINKS);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>();</div><div class="line">    pwr_mgr_init();</div><div class="line">    <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga2d5f6c88428ff65ce252e63964752e76">task_init</a>();</div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule___exported__functions.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>GAP initialization flow:<br />
 1.<a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init()</a> Initialize GAP and set link number.<br />
</p>
<p>2.<a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6413e985e869d949a7c5faba945c3ff3">gap_lib_init()</a> Initialize GAP utils lib.<br />
</p>
<p>3.app_le_gap_init() User can easily customize the application by modifying the following parameter values.<br />
 <br />
 1) device name and appearance </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Device name and device appearance */</span></div><div class="line">    uint8_t  device_name[<a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>] = <span class="stringliteral">&quot;BLE_CENTRAL&quot;</span>;</div><div class="line">    uint16_t appearance = <a class="code" href="group___g_a_p___a_p_p_e_a_r_a_n_c_e___v_a_l_u_e_s.html#ga595a88c273e0ba9b12497d259f77c1df">GAP_GATT_APPEARANCE_UNKNOWN</a>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, device_name);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p>2) set tx octets and tx times for coded phy </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_BT_LE_CODED_PHY_SUPPORT</span></div><div class="line">    uint16_t max_data_len_tx_oct = 251;</div><div class="line"><span class="preprocessor">#if LE_CODED_PHY_S8</span></div><div class="line">    uint16_t max_data_len_tx_time = 17040;</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    uint16_t max_data_len_tx_time = 4542;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea6e01cd22a4f45beca91edd3688c5c91c">GAP_PARAM_DEFAULT_DATA_LEN_MAX_TX_OCTETS</a>, <span class="keyword">sizeof</span>(max_data_len_tx_oct),</div><div class="line">                     &amp;max_data_len_tx_oct);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea7e6f57b5f7db13e58e125655d0a5444e">GAP_PARAM_DEFAULT_DATA_LEN_MAX_TX_TIME</a>, <span class="keyword">sizeof</span>(max_data_len_tx_time),</div><div class="line">                     &amp;max_data_len_tx_time);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p>3) GAP Bond Manager parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">   <span class="comment">/* GAP Bond Manager parameters */</span></div><div class="line">    uint8_t  auth_pair_mode = <a class="code" href="group___b_o_n_d___p_a_i_r_i_n_g___m_o_d_e___d_e_f_i_n_e_s.html#gad3d7b9d5543cf1e4743396ee3680dc16">GAP_PAIRING_MODE_PAIRABLE</a>;</div><div class="line">    uint16_t auth_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    uint8_t  auth_io_cap = <a class="code" href="group___g_a_p___common___exported___types.html#ggafa5f8a475a6c3126ab20d51881e8dc8da37845069e8fce0d25222ca70bf5af666">GAP_IO_CAP_NO_INPUT_NO_OUTPUT</a>;</div><div class="line">    uint8_t  auth_oob = <span class="keyword">false</span>;</div><div class="line">    uint8_t  auth_use_fix_passkey = <span class="keyword">false</span>;</div><div class="line">    uint32_t auth_fix_passkey = 0;</div><div class="line">    uint8_t  auth_sec_req_enable = <span class="keyword">false</span>;</div><div class="line">    uint16_t auth_sec_req_flags = <a class="code" href="group___b_o_n_d___m_i_t_m___d_e_f_i_n_e_s.html#ga7a7f5bff0fb0c0ecd4c7316420ea166d">GAP_AUTHEN_BIT_BONDING_FLAG</a>;</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(auth_pair_mode), &amp;auth_pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(auth_flags), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(auth_io_cap), &amp;auth_io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(auth_oob), &amp;auth_oob);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(auth_fix_passkey), &amp;auth_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(auth_use_fix_passkey),</div><div class="line">                      &amp;auth_use_fix_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(auth_sec_req_enable), &amp;auth_sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(auth_sec_req_flags),</div><div class="line">                      &amp;auth_sec_req_flags);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p>4) extended advertising related parameters </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* set to enable LE Advertising Extensions */</span></div><div class="line">    <span class="keywordtype">bool</span> use_extended = <span class="keyword">true</span>;</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea453065e66e1d221711e7e36769f3a609">GAP_PARAM_USE_EXTENDED_ADV</a>, <span class="keyword">sizeof</span>(use_extended), &amp;use_extended);</div><div class="line">}</div></div><!-- fragment --><p>5) register GAP Callback and initiate ble mgr module </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* register gap message callback */</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_gap_callback);</div><div class="line"></div><div class="line">    <span class="comment">/* ble manager module initialize*/</span></div><div class="line">    app_gap_ble_mgr_init();</div><div class="line">}</div></div><!-- fragment --><p>More information on LE GAP initialization and startup flow can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Initialization_and_Startup_Flow">2.2 GAP Initialization and Startup Flow</a>. If BT5 Central application needs to support GATT Profiles, please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_PROFILE_MSG_CB">5.3.5 Profile Message Callback</a> and <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_DIS_GATT_SERVICE_PROC">5.3.6 Discover GATT Services Procedure</a> in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Central_Application">5 BLE Central Application</a>. If BT5 central application needs to support multi link, please refer to <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#AN201_MULTI_LINK">5.3.2 Multi link Manager</a> in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Central_Application">5 BLE Central Application</a>.</p>
<h4><a class="anchor" id="AN207_GAP_MSG_HANDLER"></a>
8.2.2 GAP Message Handler</h4>
<p>app_handle_gap_msg function() is invoked whenever a GAP messages is received from the GAP. More information on GAP messages can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>. <a class="el" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#gaa3f9acaeff2921be050227c988665a73">ble_mgr_handle_gap_msg()</a> in app_handle_gap_msg() is used to handle <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#ga8a61e3422055b5738fd0d5f24ac2d235">GAP_MSG_LE_EXT_ADV_STATE_CHANGE</a>.<br />
</p>
<p>When receiving message <a class="el" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>, app_handle_conn_state_evt() will update the information in app_link_table. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(uint8_t conn_id, <a class="code" href="group___gap___msg___exported___types.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a> new_state, uint16_t disc_cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga9a333df08413dee3d9e1a88f2993e141">APP_PRINT_INFO4</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: conn_id %d, conn_state(%d -&gt; %d), disc_cause 0x%x&quot;</span>,</div><div class="line">                    conn_id, gap_conn_state, new_state, disc_cause);</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (new_state)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44ea1f99834fae71c71c7ad9e178f6cee6d9">GAP_CONN_STATE_DISCONNECTED</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#ga3937978461d6311e7b251e5d4ae98070">HCI_ERR_REMOTE_USER_TERMINATE</a>))</div><div class="line">                &amp;&amp; (disc_cause != (<a class="code" href="group___b_t___h_o_s_t___m_o_d_u_l_e___e_r_r_o_r.html#gae35728cf2b661cfdb28c841fed5a5ca3">HCI_ERR</a> | <a class="code" href="group___b_t___h_c_i___e_r_r_o_r.html#gad7d084a6a40ae0cb5d7f8ce5ec593c7a">HCI_ERR_LOCAL_HOST_TERMINATE</a>)))</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga57c6954e0ebb68c0ca06a0052659be48">APP_PRINT_ERROR1</a>(<span class="stringliteral">&quot;app_handle_conn_state_evt: connection lost cause 0x%x&quot;</span>, disc_cause);</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Disconnect conn_id %d, dis_cause 0x%x\r\n&quot;</span>, conn_id, disc_cause);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">            uint8_t tx_phy;</div><div class="line">            uint8_t rx_phy;</div><div class="line">            uint16_t conn_interval;</div><div class="line">            uint16_t conn_latency;</div><div class="line">            uint16_t conn_supervision_timeout;</div><div class="line">            uint8_t  remote_bd[6];</div><div class="line">            <a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a> remote_bd_type;</div><div class="line"></div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558a739e49c14dbfc00ad795334bc3f20eaf">GAP_PARAM_CONN_INTERVAL</a>, &amp;conn_interval, conn_id);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558a4dd84b91baf61991907358ba521cae9c">GAP_PARAM_CONN_LATENCY</a>, &amp;conn_latency, conn_id);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558a17dad61920a1192a73adf712823bb0e4">GAP_PARAM_CONN_TIMEOUT</a>, &amp;conn_supervision_timeout, conn_id);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga607918b3e0e11cd01b24cd05cafaeb96">le_get_conn_addr</a>(conn_id, remote_bd, (uint8_t *)&amp;remote_bd_type);</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;GAP_CONN_STATE_CONNECTED:remote_bd %s, remote_addr_type %d, conn_interval 0x%x, conn_latency 0x%x, conn_supervision_timeout 0x%x&quot;</span>,</div><div class="line">                            <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(remote_bd), remote_bd_type,</div><div class="line">                            conn_interval, conn_latency, conn_supervision_timeout);</div><div class="line"></div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558a3d74995cdc144af6e961c9298cfa1b6d">GAP_PARAM_CONN_TX_PHY_TYPE</a>, &amp;tx_phy, conn_id);</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga9ecb0f5bf1b2384ebadd03cbc47589ea">le_get_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga6550240507031f4b2f0ec2df90f27558ae6d66a109761e0a62b061dc955ab2e38">GAP_PARAM_CONN_RX_PHY_TYPE</a>, &amp;rx_phy, conn_id);</div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Connected success conn_id %d, tx_phy %d, rx_phy %d\r\n&quot;</span>, conn_id, tx_phy, rx_phy);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    gap_conn_state = new_state;</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN207_GAP_CB_HANDLER"></a>
8.2.3 GAP Callback Handler</h4>
<p>app_gap_callback function is used to handle GAP callback messages. More information on GAP callback can be found in BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a>. If device start extended scan and receives advertising data or scan response data, ble_mgr lib will use BLE_SCAN_REPORT message to inform application.<br />
</p>
<p>Sample codes are listed as below: </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> app_gap_callback(uint8_t cb_type, <span class="keywordtype">void</span> *p_cb_data)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a909f010ff315d17ec44d25243492a366">APP_RESULT_SUCCESS</a>;</div><div class="line">    <a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *p_data = (<a class="code" href="union_t___l_e___c_b___d_a_t_a.html">T_LE_CB_DATA</a> *)p_cb_data;</div><div class="line">    <a class="code" href="group___l_e___m_g_r___i_n_i_t___exported___functions.html#ga50575af7f1139b4fec93ecd40ea2b83d">ble_mgr_handle_gap_cb</a>(cb_type, p_cb_data);</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_gap_callback: cb_type = 0x%x&quot;</span>, cb_type);</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (cb_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___l_e___m_s_g___types.html#ga2d2b24b33dcecc6feb9598941dcf593a">GAP_MSG_LE_CONN_UPDATE_IND</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga63d3804cafe8ed6f9165f9692b30fd96">APP_PRINT_INFO5</a>(<span class="stringliteral">&quot;GAP_MSG_LE_CONN_UPDATE_IND: conn_id %d, conn_interval_max 0x%x, conn_interval_min 0x%x, conn_latency 0x%x,supervision_timeout 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a6f2749c213f11ad9a16583079a554b39">conn_id</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a6314eb8c5825b90229985ed248052631">conn_interval_max</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a129a79eddd12f561d6719759c83cbec6">conn_interval_min</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#a1981f631548663fa86eb12cabcce2167">conn_latency</a>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a03abb468579ea178a5ed0723a743ed3b">p_le_conn_update_ind</a>-&gt;<a class="code" href="struct_t___l_e___c_o_n_n___u_p_d_a_t_e___i_n_d.html#ab9a2dab79f1bab2d97d672571c060bbc">supervision_timeout</a>);</div><div class="line">        <span class="comment">/* if reject the proposed connection parameter from peer device, use APP_RESULT_REJECT. */</span></div><div class="line">        result = <a class="code" href="group___g_a_p___common___exported___types.html#gga90b0c39404615bbdf0fc222483ed3fb9a301a48ddc8615894d01263a3858d4a90">APP_RESULT_ACCEPT</a>;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line"><span class="preprocessor">#if LE_CODED_PHY_S8</span></div><div class="line">    <span class="keywordflow">case</span> GAP_MSG_LE_AE_CODING_SCHEME:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;GAP_MSG_LE_AE_CODING_SCHEME: cause 0x%x&quot;</span>,</div><div class="line">                        p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#a7b9ea0123f3b6bbebf007f85373dc8c2">le_cause</a>.<a class="code" href="struct_t___l_e___c_a_u_s_e.html#aa4f2c0f4dd13d2ab4a435cbbc672c1f3">cause</a>);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="comment">//APP_PRINT_ERROR1(&quot;app_gap_callback: unhandled cb_type 0x%x&quot;, cb_type);</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> result;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_scan_cb(<a class="code" href="group___l_e___s_c_a_n___exported___types.html#ga6e85fb50ee707c971663f65652348926">BLE_SCAN_EVT</a> evt, <a class="code" href="union_b_l_e___s_c_a_n___e_v_t___d_a_t_a.html">BLE_SCAN_EVT_DATA</a> *data)</div><div class="line">{</div><div class="line">    uint8_t scan_state = <a class="code" href="group___l_e___s_c_a_n___exported___functions.html#ga0787889d67b266a772ff060bee38df31">ble_scan_get_cur_state</a>();</div><div class="line">    <span class="keywordflow">switch</span> (evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga76eac5d2f173d1e601bd9d2bd4a4d809">APP_PRINT_INFO6</a>(<span class="stringliteral">&quot;app_scan_cb: BLE_SCAN_REPORT event_type 0x%x, bd_addr %s, addr_type %d, rssi %d, data_len %d, data_status 0x%x&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;event_type,</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr),</div><div class="line">                        data-&gt;report-&gt;addr_type,</div><div class="line">                        data-&gt;report-&gt;rssi,</div><div class="line">                        data-&gt;report-&gt;data_len,</div><div class="line">                        data-&gt;report-&gt;data_status);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(data-&gt;report-&gt;rssi &gt; (0 - 60))</div><div class="line">    {</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_scan_cb: add device into device list rssi %d, bd_addr %b&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;rssi, <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr));</div><div class="line">        link_mgr_add_device(data-&gt;report-&gt;bd_addr, data-&gt;report-&gt;addr_type);</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if APP_RECOMBINE_ADV_DATA</span></div><div class="line">        <span class="keywordflow">if</span> (!(p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ab4a15007a579a157c4e6ca1f938e097c">event_type</a> &amp; <a class="code" href="group___e_x_t___a_d_v___r_e_p_o_r_t.html#ga795a2406a2e55c7d653684d189cc3dde">GAP_EXT_ADV_REPORT_BIT_USE_LEGACY_ADV</a>))</div><div class="line">        {</div><div class="line">            <span class="comment">/* If the advertisement uses extended advertising PDUs, recombine advertising data. */</span></div><div class="line">            app_handle_ext_adv_report(p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ab4a15007a579a157c4e6ca1f938e097c">event_type</a>,</div><div class="line">                                      p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#aa643aea6c1af20523b772fcba13642f9">data_status</a>, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>,</div><div class="line">                                      p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ac78cff7af99787faad2a285dffdde08e">data_len</a>, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#a8304c4af5da6e830b86d7199dc9a22e6">p_data</a>);</div><div class="line">        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="BT5_Central_Config"></a>
8.3 APP Configurable Functions</h3>
<p>APP Configurable Functions are defined in app_flags.h. </p><div class="fragment"><div class="line"></div><div class="line"><span class="preprocessor">#define APP_MAX_LINKS 1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_RECOMBINE_ADV_DATA 0</span></div></div><!-- fragment --><p>User can easily change the value of macro definition to switch the function or copy the referenced codes to other application.</p>
<h4><a class="anchor" id="AN207_Recombine_advertising_data"></a>
8.3.1 Recombine advertising data</h4>
<p>Recombination of advertising data implements a recombination for one advertising data or scan response data, and recombined advertising data is deleted before next recombination. The process of recombination can be used as a framework for recombining multi-advertising data at a time. Memory for recombining advertising data is allocated in GAP Initialization, and sample codes are listed as below. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___g_a_p___exported___functions.html#gaa4659bba121a58a654bbc3ceb66ce447">app_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">/* Allocate memory for recombining advertising data */</span></div><div class="line"><span class="preprocessor">#if APP_RECOMBINE_ADV_DATA</span></div><div class="line">    ext_adv_data = <a class="code" href="group___o_s__87x3d___memory.html#gaa1a340c697ba158359b84f652091b934">os_mem_zalloc</a>(<a class="code" href="group__x3e___m_e_m___c_o_n_f_i_g___exported___types.html#gga20f6fc28665b1bdf8326a4826ba69b77a53394a9ecf33e56adc53407220bae73d">RAM_TYPE_DATA_ON</a>, <span class="keyword">sizeof</span>(T_EXT_ADV_DATA));</div><div class="line">    ext_adv_data-&gt;flag = <span class="keyword">false</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> Message data structure is T_EXT_ADV_DATA. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t      bd_addr[<a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>];           </div><div class="line">    <span class="keywordtype">bool</span>         flag;                               </div><div class="line">    uint16_t     event_type;                         </div><div class="line">    uint16_t     data_len;                           </div><div class="line">    uint8_t      p_data[APP_MAX_EXT_ADV_TOTAL_LEN];  </div><div class="line">} T_EXT_ADV_DATA;</div></div><!-- fragment --><p>BT5 central application handles <a class="el" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> message which indicates the receipt of advertising data or scan response data in app_scan_cb() function, If the extended advertising report indicates extended advertising PDU is used, application calls app_handle_ext_adv_report() function to recombine advertising data. The following sections describe the recombination of advertising data, please refer to app_handle_ext_adv_report() function in app_bt5_central_adv.c.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_scan_cb(<a class="code" href="group___l_e___s_c_a_n___exported___types.html#ga6e85fb50ee707c971663f65652348926">BLE_SCAN_EVT</a> evt, <a class="code" href="union_b_l_e___s_c_a_n___e_v_t___d_a_t_a.html">BLE_SCAN_EVT_DATA</a> *data)</div><div class="line">{</div><div class="line">    uint8_t scan_state = <a class="code" href="group___l_e___s_c_a_n___exported___functions.html#ga0787889d67b266a772ff060bee38df31">ble_scan_get_cur_state</a>();</div><div class="line">    <span class="keywordflow">switch</span> (evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a>:</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga76eac5d2f173d1e601bd9d2bd4a4d809">APP_PRINT_INFO6</a>(<span class="stringliteral">&quot;app_scan_cb: BLE_SCAN_REPORT event_type 0x%x, bd_addr %s, addr_type %d, rssi %d, data_len %d, data_status 0x%x&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;event_type,</div><div class="line">                        <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr),</div><div class="line">                        data-&gt;report-&gt;addr_type,</div><div class="line">                        data-&gt;report-&gt;rssi,</div><div class="line">                        data-&gt;report-&gt;data_len,</div><div class="line">                        data-&gt;report-&gt;data_status);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span>(data-&gt;report-&gt;rssi &gt; (0 - 60))</div><div class="line">    {</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_scan_cb: add device into device list rssi %d, bd_addr %b&quot;</span>,</div><div class="line">                        data-&gt;report-&gt;rssi, <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(data-&gt;report-&gt;bd_addr));</div><div class="line">        link_mgr_add_device(data-&gt;report-&gt;bd_addr, data-&gt;report-&gt;addr_type);</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if APP_RECOMBINE_ADV_DATA</span></div><div class="line">        <span class="keywordflow">if</span> (!(p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ab4a15007a579a157c4e6ca1f938e097c">event_type</a> &amp; <a class="code" href="group___e_x_t___a_d_v___r_e_p_o_r_t.html#ga795a2406a2e55c7d653684d189cc3dde">GAP_EXT_ADV_REPORT_BIT_USE_LEGACY_ADV</a>))</div><div class="line">        {</div><div class="line">            <span class="comment">/* If the advertisement uses extended advertising PDUs, recombine advertising data. */</span></div><div class="line">            app_handle_ext_adv_report(p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ab4a15007a579a157c4e6ca1f938e097c">event_type</a>,</div><div class="line">                                      p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#aa643aea6c1af20523b772fcba13642f9">data_status</a>, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>,</div><div class="line">                                      p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#ac78cff7af99787faad2a285dffdde08e">data_len</a>, p_data-&gt;<a class="code" href="union_t___l_e___c_b___d_a_t_a.html#ac2ef6ff1e19ec26bb40b00f45ab3d804">p_le_ext_adv_report_info</a>-&gt;<a class="code" href="struct_t___l_e___e_x_t___a_d_v___r_e_p_o_r_t___i_n_f_o.html#a8304c4af5da6e830b86d7199dc9a22e6">p_data</a>);</div><div class="line">        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li>GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE <br />
 GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE indicates that the data is complete. The process of advertising report with data status GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE is shown in Figure 8-1.</li>
</ol>
<div class="image">
<img src="GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE.png" alt="GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE.png"/>
</div>
 <center><div id="figure_8_1"><b>Figure 8-1 GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE </b></div></center><p> <br />
</p>
<ol type="1">
<li>GAP_EXT_ADV_EVT_DATA_STATUS_MORE <br />
 GAP_EXT_ADV_EVT_DATA_STATUS_MORE indicates that the data is incomplete and more data will be received. The process of advertising report with data status GAP_EXT_ADV_EVT_DATA_STATUS_MORE is shown in Figure 8-2. <div class="image">
<img src="GAP_EXT_ADV_EVT_DATA_STATUS_MORE.png" alt="GAP_EXT_ADV_EVT_DATA_STATUS_MORE.png"/>
</div>
 <center><div id="figure_8_2"><b>Figure 8-2 GAP_EXT_ADV_EVT_DATA_STATUS_MORE </b></div></center></li>
</ol>
<p>After process advertising report with GAP_EXT_ADV_EVT_DATA_STATUS_MORE, application waits for advertising report to complete the recombination. The last advertising report with GAP_EXT_ADV_EVT_DATA_STATUS_COMPLETE indicates the recombination process is completed.</p>
<h3><a class="anchor" id="BT5_Central_Cmd"></a>
8.4 User Command</h3>
<p>BLE BT5 Central Application need to perform interaction by inputting command through Data UART in PC. More information on user command can be found in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a>. The following sections describe some commands used in BT5 central application.</p>
<h4><a class="anchor" id="BT5_Commands_about_Extended_Scanning"></a>
8.4.1 Commands about Extended Scanning</h4>
<p>Commands about extended scanning include escan and stopescan. <a class="anchor" id="invalid"></a></p><h5>8.4.1.1 command escan</h5>
<p>Command escan is used to start extended scanning. <br />
 application calls app_scan_start() to enable extended scanning. <br />
 Implementation of command escan is shown as below. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_escan(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause = <a class="code" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>;</div><div class="line">    uint8_t scan_phys = <a class="code" href="group___e_x_t___s_c_a_n___p_h_y.html#gaf648a1f46211910207c388eaa8409a5d">GAP_EXT_SCAN_PHYS_1M_BIT</a>;</div><div class="line"></div><div class="line">    uint16_t scan_interval     = 440;</div><div class="line">    uint16_t scan_window       = 220;</div><div class="line">    T_EXT_SCAN_MODE scan_mode  = SCAN_UNTIL_DISABLED;</div><div class="line"></div><div class="line">    link_mgr_clear_device_list();</div><div class="line">    <span class="keywordflow">if</span>(p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a9015f82c953a82e540d66eebb42fa0eb">param_count</a> &gt; 0)</div><div class="line">    {</div><div class="line">        scan_mode = (T_EXT_SCAN_MODE)p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a9015f82c953a82e540d66eebb42fa0eb">param_count</a> &gt; 1)</div><div class="line">    {</div><div class="line">        scan_phys = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[1];</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (scan_mode == SCAN_UNTIL_DISABLED)</div><div class="line">    {</div><div class="line">        app_scan_start(scan_interval, scan_window, scan_phys);</div><div class="line">    }</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p>Different from ble central application, bt5 central application receives advertising packets with legacy advertising PDUs and extended advertising PDUs on the primary advertising channel which could be LE 1M PHY or/and LE Coded PHY.</p>
<p>Definition of command escan is shown as below. </p><div class="fragment"><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___u_s_e_r___c_m_d___t_a_b_l_e___e_n_t_r_y.html">T_USER_CMD_TABLE_ENTRY</a> user_cmd_table[] =</div><div class="line">{</div><div class="line">    {</div><div class="line">        <span class="stringliteral">&quot;escan&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;escan [scan_mode] [scan_phys]\n\r&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Start extended scan\r\n\</span></div><div class="line"><span class="stringliteral">        [scan_mode]: 0-(continue scanning until scanning is disabled)\r\n\</span></div><div class="line"><span class="stringliteral">                     1-(scan for the duration within a scan period, and scan periods continue until scanning is disabled)\r\n\</span></div><div class="line"><span class="stringliteral">                     2-(continue scanning until duration has expired)\r\n\</span></div><div class="line"><span class="stringliteral">        [scan_phys]: set scan PHYs to 1(LE 1M PHY), 4(LE Coded PHY) or 5(LE 1M PHY and LE Coded PHY)\r\n\</span></div><div class="line"><span class="stringliteral">        sample: escan 0 1\n\r&quot;</span>,</div><div class="line">        cmd_escan</div><div class="line">    },</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="invalid"></a></p><h5>8.4.1.2 command stopescan</h5>
<p>Command stopescan is used to stop extended scanning by calling app_scan_stop(). <br />
 Implementation and usage of command stopescan are shown as below.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_stopescan(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause = <a class="code" href="group___g_a_p___common___exported___types.html#gga99268bc0507cd918edbd1c9d12c802aba517ae23e2fc4ffb7a6128b63e43a5afc">GAP_CAUSE_SUCCESS</a>;</div><div class="line">    app_scan_stop();</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___u_s_e_r___c_m_d___t_a_b_l_e___e_n_t_r_y.html">T_USER_CMD_TABLE_ENTRY</a> user_cmd_table[] =</div><div class="line">{</div><div class="line">    {</div><div class="line">        <span class="stringliteral">&quot;stopescan&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;stopescan\n\r&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Stop extended scan\n\r&quot;</span>,</div><div class="line">        cmd_stopescan</div><div class="line">    },</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="BT5_Command_about_Extended_Create_Connection"></a>
8.4.2 Commands about Extended Create Connection</h4>
<p>Commands about extended create connection include condev and disc.</p>
<p><a class="anchor" id="invalid"></a></p><h5>8.4.2.1 command condev</h5>
<p>Using LE Advertising Extensions, application uses command condev to create connection. Initiating PHYs parameter indicates the PHY(s) on which the advertising packets should be received on the primary advertising channel and the PHYs for which connection parameters have been specified. <br />
Primary advertising channel includes LE 1M PHY and LE Coded PHY, so Initiating PHYs parameter shall have one bit set for a PHY allowed for scanning on the primary advertising channel.</p>
<p>If peripheral uses extended advertising PDUs and secondary advertising PHY is LE 1M PHY, LE 2M PHY or LE Coded PHY, application can become a master role in the link on LE 1M PHY, LE 2M PHY or LE Coded PHY.</p>
<p>Implementation and usage of command condev are shown as below. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_condev(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    uint8_t dev_idx = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    <span class="keywordflow">if</span> (dev_idx &lt; dev_list_count)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line">        <a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html">T_GAP_LE_CONN_REQ_PARAM</a> conn_req_param;</div><div class="line">        <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#ga6a4a22188186cb0102eafa5628d4cb98">T_GAP_LOCAL_ADDR_TYPE</a> local_addr_type = <a class="code" href="group___g_a_p___l_e___t_y_p_e_s___exported___types.html#gga6a4a22188186cb0102eafa5628d4cb98a16656bc5ea16dce38877bf13f2d49a79">GAP_LOCAL_ADDR_LE_PUBLIC</a>;</div><div class="line">        uint8_t  init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#gab99b03fd15ba6338629013375f3b3192">GAP_PHYS_CONN_INIT_1M_BIT</a>;</div><div class="line">        uint32_t input_phys = 0x01;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#aee6704e14e4d5c590990ef4b80857b94">scan_interval</a> = 0x10;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a85da8bab044d1c19454c091830144e06">scan_window</a> = 0x10;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a129a79eddd12f561d6719759c83cbec6">conn_interval_min</a> = 80;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a6314eb8c5825b90229985ed248052631">conn_interval_max</a> = 80;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a1981f631548663fa86eb12cabcce2167">conn_latency</a> = 0;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a5500f51ef9a692005d351d7b65388707">supv_tout</a> = 1000;</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#ac2329d8a3be3b5f4ecb8ce47131ea377">ce_len_min</a> = 2 * (conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a129a79eddd12f561d6719759c83cbec6">conn_interval_min</a> - 1);</div><div class="line">        conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a656652179ea805e26b65a81d2675fe6b">ce_len_max</a> = 2 * (conn_req_param.<a class="code" href="struct_t___g_a_p___l_e___c_o_n_n___r_e_q___p_a_r_a_m.html#a6314eb8c5825b90229985ed248052631">conn_interval_max</a> - 1);</div><div class="line"></div><div class="line">        <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga112ae69a6210c0e25415ebade4c9b984">le_set_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga1a4efcba9e05c1fc0fa65d437be21d6ea1ff775ec27b4d162464674a11809ce32">GAP_CONN_PARAM_1M</a>, &amp;conn_req_param);</div><div class="line">        <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga112ae69a6210c0e25415ebade4c9b984">le_set_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga1a4efcba9e05c1fc0fa65d437be21d6eac7bf0d49f40b1b805fec9794f601834d">GAP_CONN_PARAM_2M</a>, &amp;conn_req_param);</div><div class="line"><span class="preprocessor">#if LE_CODED_PHY_SUPPORT</span></div><div class="line">        <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga112ae69a6210c0e25415ebade4c9b984">le_set_conn_param</a>(<a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___exported___types.html#gga1a4efcba9e05c1fc0fa65d437be21d6ea313969a1e1da656bb111a585b586366e">GAP_CONN_PARAM_CODED</a>, &amp;conn_req_param);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">if</span> (p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a9015f82c953a82e540d66eebb42fa0eb">param_count</a> &gt; 1)</div><div class="line">        {</div><div class="line">            input_phys = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[1];</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">switch</span> (input_phys)</div><div class="line">        {</div><div class="line">        <span class="keywordflow">case</span> 0x001:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#gab99b03fd15ba6338629013375f3b3192">GAP_PHYS_CONN_INIT_1M_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 0x011:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga49e2b29d35c2328887f85a219f53b5a5">GAP_PHYS_CONN_INIT_2M_BIT</a> | <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#gab99b03fd15ba6338629013375f3b3192">GAP_PHYS_CONN_INIT_1M_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#if LE_CODED_PHY_SUPPORT</span></div><div class="line">        <span class="keywordflow">case</span> 0x100:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga5593a15a98de08c56471ace7ffbd0fbf">GAP_PHYS_CONN_INIT_CODED_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 0x101:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga5593a15a98de08c56471ace7ffbd0fbf">GAP_PHYS_CONN_INIT_CODED_BIT</a> | <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#gab99b03fd15ba6338629013375f3b3192">GAP_PHYS_CONN_INIT_1M_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 0x110:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga5593a15a98de08c56471ace7ffbd0fbf">GAP_PHYS_CONN_INIT_CODED_BIT</a> | <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga49e2b29d35c2328887f85a219f53b5a5">GAP_PHYS_CONN_INIT_2M_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        <span class="keywordflow">case</span> 0x111:</div><div class="line">            init_phys = <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga5593a15a98de08c56471ace7ffbd0fbf">GAP_PHYS_CONN_INIT_CODED_BIT</a> |</div><div class="line">                        <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#ga49e2b29d35c2328887f85a219f53b5a5">GAP_PHYS_CONN_INIT_2M_BIT</a> |</div><div class="line">                        <a class="code" href="group___g_a_p___p_h_y_s___c_o_n_n___i_n_i_t.html#gab99b03fd15ba6338629013375f3b3192">GAP_PHYS_CONN_INIT_1M_BIT</a>;</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">default</span>:</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">        <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;init_phys %d\r\n&quot;</span>, init_phys);</div><div class="line">        cause = <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga41bf5d8b53dc380e209e09c24479945e">le_connect</a>(init_phys, dev_list[dev_idx].bd_addr,</div><div class="line">                           (<a class="code" href="group___g_a_p___common___exported___types.html#ga41dd9d848e985c7c492f8f43e1da9249">T_GAP_REMOTE_ADDR_TYPE</a>)dev_list[dev_idx].bd_type,</div><div class="line">                           local_addr_type,</div><div class="line">                           1000);</div><div class="line">        <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#ggab7f77eecc3c723d439e610daa838acecaed12a48e8a6db9d3e74d4e29e7eda08d">RESULT_ERR</a>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___u_s_e_r___c_m_d___t_a_b_l_e___e_n_t_r_y.html">T_USER_CMD_TABLE_ENTRY</a> user_cmd_table[] =</div><div class="line">{</div><div class="line">    {</div><div class="line">        <span class="stringliteral">&quot;condev&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;condev [idx] [init_phys]\n\r&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Connect to remote device: use showdev to show idx\r\n\</span></div><div class="line"><span class="stringliteral">        [idx]: use cmd showdev to show idx before use this cmd\r\n\</span></div><div class="line"><span class="stringliteral">        [init_phys]: 0x001(LE 1M PHY),0x100(LE Coded PHY),... \r\n\</span></div><div class="line"><span class="stringliteral">        sample: condev 0 0x001\n\r&quot;</span>,</div><div class="line">        cmd_condev</div><div class="line">    },</div><div class="line">}</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>8.4.2.2 command disc</h5>
<p>Command disc is used to terminate an existing connection by calling <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6739a5841cd3d00ee982df86bb732e46" title="Terminates the existing connection. When link is disconnected, app_handle_conn_state_evt will be call...">le_disconnect()</a>. Sample codes are listed as below. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_disc(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    uint8_t conn_id = p_parse_value-&gt;<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html#a90696670324926369a9646e55705bcbf">dw_param</a>[0];</div><div class="line">    <a class="code" href="group___g_a_p___common___exported___types.html#ga99268bc0507cd918edbd1c9d12c802ab">T_GAP_CAUSE</a> cause;</div><div class="line">    cause = <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6739a5841cd3d00ee982df86bb732e46">le_disconnect</a>(conn_id);</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a>)cause;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">const</span> <a class="code" href="struct_t___u_s_e_r___c_m_d___t_a_b_l_e___e_n_t_r_y.html">T_USER_CMD_TABLE_ENTRY</a> user_cmd_table[] =</div><div class="line">{</div><div class="line">    {</div><div class="line">        <span class="stringliteral">&quot;disc&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;disc [conn_id]\n\r&quot;</span>,</div><div class="line">        <span class="stringliteral">&quot;Disconnect to remote device\n\r&quot;</span>,</div><div class="line">        cmd_disc</div><div class="line">    },</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="BT5_command_about_Recombining_Advertising_Data"></a>
8.4.3 Commands about Recombining Advertising Data</h4>
<p>If macro definition APP_RECOMBINE_ADV_DATA is set to one, commands about recombining advertising data include sadvdata and radvdata. If user needs to develop function about recombining advertising data, please refer to the following section and Recombine advertising data. Command sadvdata is used to disable recombination of advertising data until scanning is disabled. If scanning is disabled, recombination of advertising data is enabled for next scanning. Sample codes are listed as below. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_sadvdata(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    ext_adv_data-&gt;flag = <span class="keyword">true</span>;</div><div class="line">    ext_adv_data-&gt;data_len = 0;</div><div class="line">    memset(ext_adv_data-&gt;bd_addr, 0, <a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>);</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#ggab7f77eecc3c723d439e610daa838aceca0acf8b75f6fcf2284c37a773d30b5864">RESULT_SUCESS</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_handle_dev_state_evt(<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html">T_GAP_DEV_STATE</a> new_state, uint16_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;app_handle_dev_state_evt: init state  %d, scan state %d, cause 0x%x&quot;</span>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#afa2a6bc3885c633950d87ae625b6bab4">gap_init_state</a>,</div><div class="line">                    new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a>, cause);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (gap_dev_state.gap_scan_state != new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (new_state.<a class="code" href="struct_t___g_a_p___d_e_v___s_t_a_t_e.html#a6a2612c1b253a71eaed5613ea7dbb4e9">gap_scan_state</a> == <a class="code" href="group___g_a_p___s_c_a_n___s_t_a_t_e.html#ga9ddd1c1e4c5f3215bfd929df4d482428">GAP_SCAN_STATE_IDLE</a>)</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;GAP scan stop&quot;</span>);</div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;GAP scan stop\r\n&quot;</span>);</div><div class="line"></div><div class="line">            <span class="comment">/* Reset flags of recombining advertising data when stop scanning */</span></div><div class="line"><span class="preprocessor">#if APP_RECOMBINE_ADV_DATA</span></div><div class="line">            ext_adv_data-&gt;flag = <span class="keyword">false</span>;</div><div class="line">            ext_adv_data-&gt;data_len = 0;</div><div class="line">            memset(fail_bd_addr, 0, <a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    gap_dev_state = new_state;</div><div class="line">}</div></div><!-- fragment --><p>Command radvdata is used to start new recombination of advertising data. Sample codes are listed as below. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#gab7f77eecc3c723d439e610daa838acec">T_USER_CMD_PARSE_RESULT</a> cmd_radvdata(<a class="code" href="struct_t___u_s_e_r___c_m_d___p_a_r_s_e_d___v_a_l_u_e.html">T_USER_CMD_PARSED_VALUE</a> *p_parse_value)</div><div class="line">{</div><div class="line">    ext_adv_data-&gt;flag = <span class="keyword">false</span>;</div><div class="line">    ext_adv_data-&gt;data_len = 0;</div><div class="line">    memset(fail_bd_addr, 0, <a class="code" href="group___g_a_p___common___macros.html#gabc4071e1504b01ea8bc4e09ff0b2f37a">GAP_BD_ADDR_LEN</a>);</div><div class="line">    <span class="keywordflow">return</span> (<a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___types.html#ggab7f77eecc3c723d439e610daa838aceca0acf8b75f6fcf2284c37a773d30b5864">RESULT_SUCESS</a>);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="BT5_Central_Test"></a>
8.5 Test Procedure</h3>
<p>Test preparation:<br />
</p><ol type="1">
<li>Please build and download the BLE BT5 Central application to the Evolution Board.</li>
<li>By using the commands described in <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_Application_User_Command">9 BLE Application User Command</a> , some processes of GAP Central Role and GATT Client can be demonstrated.</li>
<li>Please use DebugAnalyser Tool to get the log.</li>
</ol>
<h4><a class="anchor" id="BT5_Central_Test_Periph"></a>
8.5.1 Test with BLE BT5 Peripheral Application Device</h4>
<p>BLE BT5 central application can test with BLE BT5 peripheral application. More information on peripheral can be found in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#BLE_BT5_Peripheral_Application">7 BLE BT5 Peripheral Application</a>. Test Procedures are divided into two categories according to the configuration of BT5 peripheral application:</p><ul>
<li>Primary Advertising Channel is LE 1M PHY and Secondary Advertising Channel is LE 2M PHY</li>
<li>Primary Advertising Channel is LE Coded PHY and Secondary Advertising Channel is LE Coded PHY.</li>
</ul>
<ol type="1">
<li>Primary Advertising Channel is LE 1M PHY, Secondary Advertising Channel is LE 2M PHY<br />
 <br />
 Firstly, set macro definition ADVERTISING_PHY to APP_PRIMARY_1M_SECONDARY_2M. Please build and download the BLE BT5 peripheral application to the Evolution Board. Bluetooth address shall be configured by MCU Cfg Tool, please set the address to "x00 x11 x22 x33 x44 x00".<br />
 <br />
 1) Extended Scanning<br />
 Procedure Description: search for any discoverable Bluetooth LE device.<br />
 Procedure:<br />
 escan 0 1:<br />
 Scan mode is set to 0, continue scanning until user input stopescan to disable. <br />
 Scan PHYs is set to 1(LE 1M PHY).<br />
 Application starts extended scanning, and examines information on nearby Bluetooth LE device whose primary advertising channel is LE 1M PHY. <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">0000161  09-29#16:00:50.391  163  0008366.838  [APP] !**GAP scan start</div></div><!-- fragment --> <br />
 The serial port assistant tool shows scan state as well.<br />
 Serial port assistant tool shows :<br />
 <div class="fragment"><div class="line">escan 0 1</div><div class="line">GAP scan start</div></div><!-- fragment --> <br />
 If BT5 central device uses escan to set scan mode to 0 or 1, BT5 central device may use stopescan to stop extended scanning.<br />
 <br />
 Macro definition APP_RECOMBINE_ADV_DATA is set to one, the first advertising report from BT5 peripheral device is shown as below.<br />
 The advertising report indicates that BT5 peripheral device sends Connectable Undirected Advertising with extended advertising PDUs, and the primary advertising PHYvis LE 1M PHY, the secondary advertising PHY is LE 2M PHY. Due to more data to come, BT5 central device start the recombination and waiting for more data. <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">0000766  09-29#16:13:25.803  117  0014770.091  [APP] app_gap_callback: cb_type = 0x50</div><div class="line">0000767  09-29#16:13:25.803  118  0014770.184  [APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x1, bd_addr 00:11:22:33:44:00, addr_type 0, rssi -42, data_len 229, data_status 0x1</div><div class="line">0000768  09-29#16:13:25.803  119  0014770.228  [APP] !**app_scan_cb: add device into device list rssi -42, bd_addr 00:11:22:33:44:00</div><div class="line">0000769  09-29#16:13:25.803  120  0014770.255  [APP] !**app_handle_ext_adv_report: Old ext_adv_data-&gt;flag is 0, data status is 0x1</div><div class="line">0000770  09-29#16:13:25.803  121  0014770.317  [APP] !**app_handle_ext_adv_report:First Data from bd_addr 00:11:22:33:44:00, data length is 229, and waiting more data</div><div class="line">0000771  09-29#16:13:25.803  122  0014770.339  [APP] !**app_handle_ext_adv_report: New ext_adv_data-&gt;flag is 1</div></div><!-- fragment --> <br />
 The last advertising report from BT5 peripheral device is shown as below. <br />
 The advertising report indicates that the data is complete. BT5 central device completes the recombination, the length of advertising data received from BT5 peripheral device is 245 bytes.<br />
 <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">0000772  09-29#16:13:25.803  123  0014770.359  [APP] app_gap_callback: cb_type = 0x50</div><div class="line">0000780  09-29#16:13:25.957  131  0014920.351  [APP] !**app_scan_cb: <a class="code" href="group___l_e___s_c_a_n___exported___types.html#gga6e85fb50ee707c971663f65652348926a21828cf57f4835b3184097b3dc0963ca">BLE_SCAN_REPORT</a> event_type 0x1, bd_addr 00:11:22:33:44:00, addr_type 0, rssi -42, data_len 10, data_status 0x0</div><div class="line">0000781  09-29#16:13:25.957  132  0014920.396  [APP] !**app_scan_cb: add device into device list rssi -42, bd_addr 00:11:22:33:44:00</div><div class="line">0000782  09-29#16:13:25.957  133  0014920.422  [APP] !**app_handle_ext_adv_report: Old ext_adv_data-&gt;flag is 1, data status is 0x0</div><div class="line">0000783  09-29#16:13:25.957  134  0014920.472  [APP] !**app_handle_ext_adv_report: Data from bd_addr 00:11:22:33:44:00 is complete, <span class="keyword">event</span> type is 0x1, total data length is 239</div><div class="line">0000784  09-29#16:13:25.957  135  0014920.494  [APP] !**app_handle_ext_adv_report: First five datas are 0x2, 0x1, 0x5, 0x13, 0x9</div><div class="line">0000785  09-29#16:13:25.957  136  0014920.517  [APP] !**app_handle_ext_adv_report: Last five datas are 0xc, 0xd, 0xd, 0xd, 0xd</div><div class="line">0000786  09-29#16:13:25.957  137  0014920.541  [APP] !**app_handle_ext_adv_report: New ext_adv_data-&gt;flag is 0</div></div><!-- fragment --> <br />
 showdev:<br />
 Show scan device list.<br />
 Serial port assistant tool shows : <br />
 <div class="fragment"><div class="line">showdev</div><div class="line">dev list</div><div class="line">RemoteBd[0] = [97:23:89:45:67:10]</div><div class="line">RemoteBd[1] = [00:11:22:33:44:04]</div><div class="line">RemoteBd[2] = [00:11:22:33:44:00]</div><div class="line">RemoteBd[3] = [00:11:22:33:44:02]</div></div><!-- fragment --> <br />
<br />
 2) Connection and Reconnection <br />
 Procedure Description: <br />
 Demonstrate connecting and disconnecting with the peripheral device.<br />
 Procedure: <br />
 condev 2 x001:<br />
 Scan connectable advertisements on LE 1M PHY, and initiate connection. <br />
 Secondary advertising channel is LE 2M PHY, and then TX PHY type and RX PHY type are LE 2M PHY. <br />
 <br />
 Serial port assistant tool shows : <br />
 <div class="fragment"><div class="line">condev 2 x001</div><div class="line">Connected success conn_id 0, tx_phy 2, rx_phy 2 </div></div><!-- fragment --> <br />
 showcon : Show connection information. <br />
 Serial port assistant tool shows : <br />
 <div class="fragment"><div class="line">showcon</div><div class="line">ShowCon conn_id 0 state 0x00000002 role 1</div><div class="line">RemoteBd = [00:11:22:33:44:00] type = 0</div><div class="line">active link num 1, idle link num 0</div></div><!-- fragment --> <br />
 disc 0 : Disconnect with the peripheral device. <br />
 Serial port assistant tool shows : <br />
 disc 0 <br />
 Disconnect conn_id 0, dis_cause 0x00000116 <br />
 <br />
 condev 2 x001 : Reconnect with the peripheral device. <br />
 Serial port assistant tool shows : <br />
 <div class="fragment"><div class="line">condev 2 x001</div><div class="line">Connected success conn_id 0, tx_phy 2, rx_phy 2 </div></div><!-- fragment --> <br />
</li>
<li>Primary Advertising Channel is LE Coded PHY, Secondary Advertising Channel is LE Coded PHY.<br />
 <br />
 At first, set macro definition ADVERTISING_PHY to APP_PRIMARY_CODED_SECONDARY_CODED.<br />
 Please build and download the BLE BT5 peripheral application to the Evolution Board. <br />
 Bluetooth address shall be configured by MCU Cfg Tool, please set the address to "x00 x11 x22 x33 x44 x00".<br />
 <br />
 1) Extended Scanning<br />
 Procedure Description: Demonstrate search for any Bluetooth LE device discoverable nearby.<br />
 <br />
 Procedure:<br />
 escan 0 5 : <br />
 Scan mode is set to 0, continue scanning until scanning is disabled. <br />
 Scan PHYs is set to 5(LE 1M PHY and LE Coded PHY).<br />
 Start extended scanning and view information on Bluetooth LE device nearby whose primary advertising channel is LE 1M PHY or LE Coded PHY.<br />
 <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">[APP] !**GAP scan start</div></div><!-- fragment --> <br />
 The serial port assistant tool shows scan state as well.<br />
 Serial port assistant tool shows :<br />
 <div class="fragment"><div class="line">escan 0 5</div><div class="line">GAP scan start</div></div><!-- fragment --> <br />
 stopescan: Stop extended scanning. <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">[APP] !**GAP scan stop</div></div><!-- fragment --> <br />
 The serial port assistant tool shows scan state as well.<br />
 Serial port assistant tool shows :<br />
 <div class="fragment"><div class="line">stopescan</div><div class="line">GAP scan stop</div></div><!-- fragment --> <br />
 Macro definition APP_RECOMBINE_ADV_DATA is set to one, the first advertising report from BT5 peripheral device is shown as below. The advertising report indicates that BT5 peripheral device sends Connectable Undirected Advertising with extended advertising PDUs, and the primary advertising PHY is LE Coded PHY, the secondary advertising PHY is LE Coded PHY. Due to more data to come, BT5 central device start the recombination and waiting for more data.<br />
 <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">[APP] app_gap_callback: cb_type = 0x50</div><div class="line">[APP] !**app_handle_ext_adv_report: Old ext_adv_data-&gt;flag is 0, data status is 0x1</div><div class="line">[APP] !**app_handle_ext_adv_report:First Data from bd_addr 00::11::22::33::44::00, data length is</div><div class="line">229, and waiting more data</div><div class="line">[APP] !**app_handle_ext_adv_report: New ext_adv_data-&gt;flag is 1</div></div><!-- fragment --> <br />
 The last advertising report from BT5 peripheral device is shown as below. The advertising report indicates that the data is complete. BT5 central device completes the recombination, the length of advertising data received from BT5 peripheral device is 245 bytes.<br />
 <br />
 Log tool shows :<br />
 <div class="fragment"><div class="line">[APP] app_gap_callback: cb_type = 0x50</div><div class="line">[APP] !**app_handle_ext_adv_report: Old ext_adv_data-&gt;flag is 1, data status is 0x0</div><div class="line">[APP] !**app_handle_ext_adv_report: Data from bd_addr 00::11::22::33::44::00 is complete, <span class="keyword">event</span></div><div class="line">type is 0x1, total data length is 245</div><div class="line">[APP] !**app_handle_ext_adv_report: First five datas are 0x2, 0x1, 0x5, 0x13, 0x9</div><div class="line">[APP] !**app_handle_ext_adv_report: Last five datas are 0xd5, 0xd6, 0xd7, 0xd8, 0xd9v</div><div class="line">[APP] !**app_handle_ext_adv_report: New ext_adv_data-&gt;flag is 0</div></div><!-- fragment --> <br />
 showdev : Show scan device list. <br />
 Serial port assistant tool shows : <br />
 <div class="fragment"><div class="line">dev list</div><div class="line">RemoteBd[3] = [47:78:39:48:32:1a]</div><div class="line">RemoteBd[4] = [00:11:22:33:44:00]</div></div><!-- fragment --> <br />
</li>
</ol>
<p>2) Connection and Reconnection <br />
 Procedure Description: Demonstrate connecting and disconnecting with the peripheral device. <br />
 Procedure: <br />
 condev 4 x100:<br />
 Scan connectable advertisements on LE Coded PHY, and initiate connection. <br />
 Secondary advertising channel is LE Coded PHY, and then TX PHY type and RX PHY type are LE Coded PHY. <br />
 <br />
 Serial port assistant tool shows : <br />
 </p><div class="fragment"><div class="line">condev 4 x100 </div><div class="line">Connected success conn_id 0, tx_phy 3, rx_phy 3 </div></div><!-- fragment --><p> <br />
 showcon : Show connection information. <br />
 <br />
 Serial port assistant tool shows : <br />
 </p><div class="fragment"><div class="line">showcon </div><div class="line">ShowCon conn_id 0 state 0x00000002 role 1 </div><div class="line">RemoteBd = [00:11:22:33:44:00] type = 0</div><div class="line">active link num 1, idle link num 0  </div></div><!-- fragment --><p> <br />
 disc 0 : Disconnect with the peripheral device. <br />
 Serial port assistant tool shows : <br />
 </p><div class="fragment"><div class="line">disc 0 </div><div class="line">Disconnect conn_id 0, dis_cause 0x00000116 </div></div><!-- fragment --><p> <br />
 condev 4 x100 : Reconnect with the peripheral device. <br />
 Serial port assistant tool shows : <br />
 </p><div class="fragment"><div class="line">condev 4 x100 </div><div class="line">Connected success conn_id 0, tx_phy 3, rx_phy 3 </div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Application_User_Command"></a>
9 BLE Application User Command</h2>
<h3><a class="anchor" id="UserCmd_Intro"></a>
9.1 Introduction</h3>
<p>BLE Central and Scatternet Application support user command. BLE Central and Scatternet Application need to perform interaction by inputting command through Data UART in PC (USB port in PC is connected to Evolution Board via USB-to-serial port module). BLE Application User Command will be introduced according to the following several parts:<br />
</p><ul>
<li>User Command Implementation will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Rl">9.2 User Command Implementation</a>.</li>
<li>Data UART Connection will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Con">9.3 Data UART Connection</a>.</li>
<li>Supported User Commands will be introduced in chapter <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Cmd">9.4 User Commands (Central And Scatternet APP)</a> and <a class="el" href="_a_n200__b_l_e__s_a_m_p_l_e__p_r_o_j_e_c_t__a_p_p_l_i_c_a_t_i_o_n.html#UserCmd_Cmd_Sc">9.5 User Commands (Scatternet APP)</a>.</li>
</ul>
<h3><a class="anchor" id="UserCmd_Rl"></a>
9.2 User Command Implementation</h3>
<h4><a class="anchor" id="Related_file"></a>
9.2.1 Related file</h4>
<p>The descriptions of each file are shown below.</p>
<center><div id="table_9_1"><b>Table 9-1 Related File List </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">File name  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">data_uart.c  </td><td class="markdownTableBodyLeft">Initialize Data UART and print data through data UART.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">data_uart_dlps.c  </td><td class="markdownTableBodyLeft">Initialize Data UART DLPS.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">user_cmd_parse.c  </td><td class="markdownTableBodyLeft">Parse user command from lower Data UART data and execute right commands.   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">user_cmd.c  </td><td class="markdownTableBodyLeft">Define user commands.   </td></tr>
</table>
<p>More information on these files can be found in DATA_UART_CMD.</p>
<h4><a class="anchor" id="UART_Initialization"></a>
9.2.2 Initialization</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab31ebd8f8c8b560ef3c96e2b599dd653">app_main_task</a>(<span class="keywordtype">void</span> *p_param)</div><div class="line">{</div><div class="line">    uint8_t event;</div><div class="line">    .....</div><div class="line"></div><div class="line">    <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#ga300297f5ace3035cb59d05dde7b7ae2f">data_uart_init</a>(<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gaefd4e39cd81a67ec6bb571646ce73fec">evt_queue_handle</a>, <a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gab16d5e105b1c246220eda8b551cdeb67">io_queue_handle</a>);</div><div class="line">    <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___functions.html#ga633294c4bacb300a67a19c283e3553c5">user_cmd_init</a>(&amp;user_cmd_if, <span class="stringliteral">&quot;central&quot;</span>);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p> <a class="el" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#ga300297f5ace3035cb59d05dde7b7ae2f" title="Initializes the Data UART0. ">data_uart_init()</a> is used to initialize the data UART. <a class="el" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___functions.html#ga633294c4bacb300a67a19c283e3553c5" title="Initiate command interface structure. ">user_cmd_init()</a> is used to initialize the user command module.</p>
<h4><a class="anchor" id="Data_UART_RX_Handler"></a>
9.2.3 Data UART RX Handler</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_io_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_msg)</div><div class="line">{</div><div class="line">    uint16_t msg_type = io_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a>;</div><div class="line">    uint8_t rx_char;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (msg_type)</div><div class="line">    {</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074a46ed3255f00d4883a56c5a7304d6f505">IO_MSG_TYPE_UART</a>:</div><div class="line">        rx_char = (uint8_t)io_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>;</div><div class="line">        <a class="code" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___functions.html#ga4f52a01d7415b0eb5649b3fd0b8031e4">user_cmd_collect</a>(&amp;user_cmd_if, &amp;rx_char, <span class="keyword">sizeof</span>(rx_char), user_cmd_table);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> <a class="el" href="group___u_s_e_r___c_m_d___p_a_r_s_e___exported___functions.html#ga4f52a01d7415b0eb5649b3fd0b8031e4" title="Collect command characters. ">user_cmd_collect()</a> is used to collect cmd characters and execute the command. User can input the commands in serial port assistant tool. Command uses the Enter key as the end.</p>
<h4><a class="anchor" id="Data_UART_TX_Handler"></a>
9.2.4 Data UART TX Handler</h4>
<p>Data UART TX is used to output informations and logs. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_handle_conn_state_evt(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_msg)</div><div class="line">{</div><div class="line">    .......</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___gap___msg___exported___types.html#ggae236f1ba42a45ef51d2178ffa9acc44eaf55da45e50c905e90a11f4b73bc00f78">GAP_CONN_STATE_CONNECTED</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga607918b3e0e11cd01b24cd05cafaeb96">le_get_conn_addr</a>(conn_id, app_link_table[conn_id].bd_addr,</div><div class="line">                             &amp;app_link_table[conn_id].bd_type);</div><div class="line">            <a class="code" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf">data_uart_print</a>(<span class="stringliteral">&quot;Connected success conn_id %d\r\n&quot;</span>, conn_id);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><p> <a class="el" href="group___d_a_t_a___u_a_r_t___a_p_is___exported___functions.html#gaae1cfbf0ca4085bc9ad25a50573c5daf" title="Print the trace information through data uart. ">data_uart_print()</a> is used to output the informations through the Data UART. User can see the informations in serial port assistant tool.</p>
<h3><a class="anchor" id="UserCmd_Con"></a>
9.3 Data UART Connection</h3>
<p>BLE Central and Scatternet Application use P3_1 as TX pin for Data UART and P3_0 as RX pin for Data UART by default.</p>
<p>Each application has a copy of board.h file, which contains the definition of the Data UART Pin. </p><div class="fragment"><div class="line"><span class="preprocessor">#define DATA_UART_TX_PIN    P3_1</span></div><div class="line"><span class="preprocessor">#define DATA_UART_RX_PIN    P3_0</span></div></div><!-- fragment --><p> Data UART Pin can be configured according to the hardware environment.</p>
<p>Therefore PC is connected to Data UART of Evolution Board running BLE Central Application or Scatternet Application via USB-to-serial port module, as shown in Figure 9-1</p>
<div class="image">
<img src="data_uart_connection.jpg" alt="data_uart_connection.jpg"/>
</div>
 <center><div id="figure_9_1"><b>Figure 9-1 Data UART Connection of PC and EVB </b></div></center><p>Baud rate of Data UART is set to 115,200, while parameters for serial port assistant tool in PC can be set as shown in Figure 9-2</p>
<div class="image">
<img src="serial_port_setting.jpg" alt="serial_port_setting.jpg"/>
</div>
 <center><div id="figure_9_2"><b>Figure 9-2 Serial Port Setting </b></div></center><h3><a class="anchor" id="UserCmd_Cmd"></a>
9.4 User Commands (Central And Scatternet APP)</h3>
<p>This section describes in details the usage of user commands for BLE Central and Scatternet Application. Firstly, we briefly describe the format of user commands. Taking "conupdreq [conn_id] [type]" as example, "conupdreq" is the name of the command, followed by parameters separated with blank space. You can enter the command in serial port assistant tool in PC, and then press ENTER or click on "Send" to send it. The recommended serial port assistant tool is Tera Term.</p>
<h4><a class="anchor" id="UserCmd_Common"></a>
9.4.1 Common Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.1.1 conupdreq</h5>
<p><b>Format:</b> conupdreq [conn_id] [type] <br />
 <b>Meaning:</b> LE connection param update request <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(conn interval = 0x80), 1-(conn interval = 10)</li>
</ul>
<p><b>Example:</b> conupdreq 0 1 <br />
 <b>Realizing Function:</b> cmd_conupdreq <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga8c982b448421ad52c90509386de5d9cd">le_update_conn_param</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.1.2 showcon</h5>
<p><b>Format:</b> showcon <br />
 <b>Meaning:</b> Show the connecting status of all devices <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> showcon <br />
 <b>Realizing Function:</b> cmd_showcon <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga51323fa93a179e5e89ad9df8a167b6b4">le_get_conn_info</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.1.3 disc</h5>
<p><b>Format:</b> disc [conn_id] <br />
 <b>Meaning:</b> Disconnect from remote device <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> disc 0 <br />
 <b>Realizing Function:</b> cmd_disc <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga6739a5841cd3d00ee982df86bb732e46">le_disconnect</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Bond"></a>
9.4.2 Bond Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.1 authmode</h5>
<p><b>Format:</b> authmode [auth_flags] [io_cap] [sec_enable] <br />
 <b>Meaning:</b> Config authentication mode <br />
 <b>Parameters:</b></p><ul>
<li>auth_flags: authentication req bit field: bit0-(bonding), bit2-(MITM), bit3-(SC)</li>
<li>io_cap: set io Capabilities: 0-(display only), 1-(display yes/no), 2-(keyboard only), 3-(no IO), 4-(keyboard display)</li>
<li>sec_enable: Start smp pairing procedure when connected: 0-(disable), 1-(enable)</li>
</ul>
<p><b>Example:</b> authmode 0x5 2 1 <br />
 <b>Realizing Function:</b> cmd_authmode <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7ec7d654932f0990435b23580907ff2a">gap_set_pairable_mode</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.2 sauth</h5>
<p><b>Format:</b> sauth [conn_id] <br />
 <b>Meaning:</b> Send authentication request <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> sauth 0 <br />
 <b>Realizing Function:</b> cmd_sauth <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga3ef0dc8beeb331ee2fc3c942118dc287">le_bond_pair</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.3 userconf</h5>
<p><b>Format:</b> userconf [conn_id] [conf] <br />
 <b>Meaning:</b> Send user confirmation when showing LE_GAP_MSG_TYPE_BOND_USER_CONFIRMATION <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>conf: 0-(Reject), 1-(Accept)</li>
</ul>
<p><b>Example:</b> userconf 0 1 <br />
 <b>Realizing Function:</b> cmd_userconf <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga4d31b81e3c1c0e487126e1b313062a04">le_bond_user_confirm</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.4 authkey</h5>
<p><b>Format:</b> authkey [conn_id] [passkey] <br />
 <b>Meaning:</b> Input passkey when showing LE_GAP_MSG_TYPE_BOND_PASSKEY_INPUT <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>passkey: 0 - 999999</li>
</ul>
<p><b>Example:</b> authkey 0 123456 <br />
 <b>Realizing Function:</b> cmd_authkey <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga9f42bea4127cb8a461ebe2569b1e1d28">le_bond_passkey_input_confirm</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.5 bondinfo</h5>
<p><b>Format:</b> bondinfo <br />
 <b>Meaning:</b> Get all Bonded devices information <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> bondinfo <br />
 <b>Realizing Function:</b> cmd_bondinfo <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___s_t_o_r_a_g_e___e_x_p_o_r_t___functions.html#gad182e8557c1fff52850186e6c793998f">le_find_key_entry_by_idx</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.2.6 bondclear</h5>
<p><b>Format:</b> bondclear <br />
 <b>Meaning:</b> Clear all bonded devices information <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> bondclear <br />
 <b>Realizing Function:</b> cmd_bondclear <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a">le_bond_clear_all_keys</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Central"></a>
9.4.3 Central Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.3.1 scan</h5>
<p><b>Format:</b> scan [filter_policy] <br />
 <b>Meaning:</b> Start scan <br />
 <b>Parameters:</b></p><ul>
<li>filter_policy: 0-(any), 1-(whitelist), 2-(any RPA), 3-(whitelist RPA)</li>
</ul>
<p><b>Example:</b> scan 0 <br />
 <b>Realizing Function:</b> cmd_scan <br />
 <b>Reference API:</b> <a class="el" href="group___observer___exported___functions.html#gaf132aa10672c3f34a0e6796152cbad73">le_scan_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.3.2 stopscan</h5>
<p><b>Format:</b> stopscan <br />
 <b>Meaning:</b> Stop scan <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> stopscan <br />
 <b>Realizing Function:</b> cmd_stopscan <br />
 <b>Reference API:</b> <a class="el" href="group___observer___exported___functions.html#ga19adb874c6ea0dd8adf8c1ecfb4eb500">le_scan_stop</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.3.3 showdev</h5>
<p><b>Format:</b> showdev <br />
 <b>Meaning:</b> Show scan dev list: filter simple ble service <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> showdev <br />
 <b>Realizing Function:</b> cmd_showdev <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.3.4 con</h5>
<p><b>Format:</b> con [BD0] [BD1] [BD2] [BD3] [BD4] [BD5] [addr_type] <br />
 <b>Meaning:</b> Connect to remote device: use address <br />
 <b>Parameters:</b></p><ul>
<li>[BD0] [BD1] [BD2] [BD3] [BD4] [BD5]: remote device address</li>
<li>addr_type: 0-(public), 1-(random)</li>
</ul>
<p><b>Example:</b> con x11 x22 x33 x44 x55 x66 0 <br />
 <b>Realizing Function:</b> cmd_con <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga41bf5d8b53dc380e209e09c24479945e">le_connect</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.3.5 condev</h5>
<p><b>Format:</b> condev [idx] <br />
 <b>Meaning:</b> Connect to remote device: use showdev to show idx <br />
 <b>Parameters:</b></p><ul>
<li>idx: use cmd showdev to show idx before use this cmd</li>
</ul>
<p><b>Example:</b> condev 0 <br />
 <b>Realizing Function:</b> cmd_condev <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga41bf5d8b53dc380e209e09c24479945e">le_connect</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Client"></a>
9.4.4 GATT Client Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.1 gapread</h5>
<p><b>Format:</b> gapread [conn_id] [type] <br />
 <b>Meaning:</b> Read GAP service characteristic value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(read device name), 1-(read appearance)</li>
</ul>
<p><b>Example:</b> gapread 0 0 <br />
 <b>Realizing Function:</b> cmd_gapread <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p_s___client___exported___functions.html#gad2116a3dcefc15499489a3bc8da09a56">gaps_read</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.2 gaphdl</h5>
<p><b>Format:</b> gaphdl [conn_id] <br />
 <b>Meaning:</b> List GAP service handle cache <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> gaphdl 0 <br />
 <b>Realizing Function:</b> cmd_gaphdl <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p_s___client___exported___functions.html#gac5122d853084bf8a85ee36bedcf9ed35">gaps_get_hdl_cache</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.3 simpread</h5>
<p><b>Format:</b> simpread [conn_id] [type] [pattern] <br />
 <b>Meaning:</b> Read simple ble service characteristic and descriptor value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(read v1), 1-(v3 cccd), 2-(v4 cccd)</li>
<li>pattern: 0-(read by handle), 1-(read by uuid)</li>
</ul>
<p><b>Example:</b> simpread 0 1 0 <br />
 <b>Realizing Function:</b> cmd_simpread <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga1d7f055fbe5c0452b9647c9317867c6d">simp_ble_client_read_by_uuid</a> , <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga46d9f1bf38c95764b31f84ade213f672">simp_ble_client_read_by_handle</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.4 simpcccd</h5>
<p><b>Format:</b> simpcccd [conn_id] [type] [enable] <br />
 <b>Meaning:</b> Config simple ble service client characteristic configuration descriptor value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(v3 notify), 1-(v4 indication)</li>
<li>enable: 0-(disable), 1-(enable)</li>
</ul>
<p><b>Example:</b> simpcccd 0 1 1 <br />
 <b>Realizing Function:</b> cmd_simpcccd <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga1a7842b38fd9acf4e6386262d6eb64aa">simp_ble_client_set_v3_notify</a> , <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga3445b0ea2754bb66dda1d99d92551076">simp_ble_client_set_v4_ind</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.5 simpwritev2</h5>
<p><b>Format:</b> simpwritev2 [conn_id] [type] [len] <br />
 <b>Meaning:</b> Write simple ble service V2 characteristic value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 1-(write request), 2-(write command)</li>
<li>len: type=1 len range:0-270, type=2 len range: 0-(mtu-3)</li>
</ul>
<p><b>Example:</b> simpwritev2 0 1 10 <br />
 <b>Realizing Function:</b> cmd_simpwritev2 <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga25d721a061120814d0b8b2dc172c549b">simp_ble_client_write_v2_char</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.6 simphdl</h5>
<p><b>Format:</b> simphdl [conn_id] <br />
 <b>Meaning:</b> List simple ble service handle cache <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> simphdl 0 <br />
 <b>Realizing Function:</b> cmd_simphdl <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga0f77c9e213a3532bddb65a7077766b1f">simp_ble_client_get_hdl_cache</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.7 basread</h5>
<p><b>Format:</b> basread [conn_id] [type] <br />
 <b>Meaning:</b> Read battery service characteristic and descriptor value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(battery level value), 1-(battery cccd)</li>
</ul>
<p><b>Example:</b> basread 0 1 <br />
 <b>Realizing Function:</b> cmd_basread <br />
 <b>Reference API:</b> <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#gadd7a7fab65116e44bce9a1a33eb3686e">bas_read_battery_level</a> , <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#ga00dd541690565cd189f9a3ab032f5eb8">bas_read_notify</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.8 bascccd</h5>
<p><b>Format:</b> bascccd [conn_id] [notify] <br />
 <b>Meaning:</b> Config battery service client characteristic configuration descriptor value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>notify: 0-(disable), 1-(enable)</li>
</ul>
<p><b>Example:</b> bascccd 0 1 <br />
 <b>Realizing Function:</b> cmd_bascccd <br />
 <b>Reference API:</b> <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#ga43690a317738aaed099080ab5c2bcfdb">bas_set_notify</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.4.4.9 bashdl</h5>
<p><b>Format:</b> bashdl [conn_id] <br />
 <b>Meaning:</b> List battery service handle cache <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> bashdl 0 <br />
 <b>Realizing Function:</b> cmd_bashdl <br />
 <b>Reference API:</b> <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#ga926e63644278c867b2c46aa95a1f8233">bas_get_hdl_cache</a> <br />
</p>
<h3><a class="anchor" id="UserCmd_Cmd_Sc"></a>
9.5 User Commands (Scatternet APP)</h3>
<h4><a class="anchor" id="UserCmd_Common2"></a>
9.5.1 Common Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.1.1 rssiread</h5>
<p><b>Format:</b> rssiread [conn_id] <br />
 <b>Meaning:</b> Read the RSSI value <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> rssiread 0 <br />
 <b>Realizing Function:</b> cmd_rssiread <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga4835945c8e2368325970316179e41fdb">le_read_rssi</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.1.2 wl</h5>
<p><b>Format:</b> wl [conn_id] [op] <br />
 <b>Meaning:</b> Use connected device address to modify whitelist <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>op: 0-(clear), 1-(add), 2-(remove)</li>
</ul>
<p><b>Example:</b> wl 0 1 <br />
 <b>Realizing Function:</b> cmd_wl <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga36252f7752759c51513639e0b1622901">le_modify_white_list</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.1.3 wairplane</h5>
<p><b>Format:</b> wairplane [mode] <br />
 <b>Meaning:</b> Write airplane mode <br />
 <b>Parameters:</b></p><ul>
<li>mode: 0-(normal), 1-(airplane)</li>
</ul>
<p><b>Example:</b> wairplane 1 <br />
 <b>Realizing Function:</b> cmd_wairplane <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gaa97cd1293511c913574fc16ab3846ced">gap_write_airplan_mode</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.1.4 rairplane</h5>
<p><b>Format:</b> rairplane <br />
 <b>Meaning:</b> Read airplane mode <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> rairplane <br />
 <b>Realizing Function:</b> cmd_rairplane <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga97e20b8ce82c33400d378dfb4802ce0a">gap_read_airplan_mode</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.1.5 setphy</h5>
<p><b>Format:</b> setphy [conn_id] [type] <br />
 <b>Meaning:</b> Set the PHY preferences for the connection <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>type: 0-(1M), 1-(2M), 2-(CODED-S8), 3-(CODED-S2), 4-(tx 2M, rx 1M)</li>
</ul>
<p><b>Example:</b> setphy 0 1 <br />
 <b>Realizing Function:</b> cmd_setphy <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gab098b1132273017baf0e010f259aeda1">le_set_phy</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Central2"></a>
9.5.2 Central Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.2.1 chanclassset</h5>
<p><b>Format:</b> chanclassset [idx0] [idx1] [idx2] [idx3] [idx4] <br />
 <b>Meaning:</b> Set Host Channel Classification <br />
 <b>Parameters:</b></p><ul>
<li>[idx0] [idx1] [idx2] [idx3] [idx4]: channel bit map</li>
</ul>
<p><b>Example:</b> chanclassset xff xff x3f xff x00 <br />
 <b>Realizing Function:</b> cmd_chanclassset <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga22f9b4a35d4c3a0809971458f2dba134">le_set_host_chann_classif</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Client2"></a>
9.5.3 GATT Client Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.3.1 srvdis</h5>
<p><b>Format:</b> srvdis [conn_id] <br />
 <b>Meaning:</b> Service discovery. Discover all primary services. <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> srvdis 0 <br />
 <b>Realizing Function:</b> cmd_srvdis <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_t_t___client___exported___functions.html#ga85ebe07880c727d884cfd93e61bacacd">client_all_primary_srv_discovery</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.3.2 gapdis</h5>
<p><b>Format:</b> gapdis [conn_id] <br />
 <b>Meaning:</b> Start discovery gap service <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> gapdis 0 <br />
 <b>Realizing Function:</b> cmd_gapdis <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p_s___client___exported___functions.html#ga7e1e3b25bc3121b881d042f7683408af">gaps_start_discovery</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.3.3 simpdis</h5>
<p><b>Format:</b> simpdis [conn_id] <br />
 <b>Meaning:</b> Start discovery simple ble service <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> simpdis 0 <br />
 <b>Realizing Function:</b> cmd_simpdis <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___client___exported___functions.html#ga3148c66a380b2d4e2a4ad8943cbb113b">simp_ble_client_start_discovery</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.3.4 basdis</h5>
<p><b>Format:</b> basdis [conn_id] <br />
 <b>Meaning:</b> Start discovery battery service <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
</ul>
<p><b>Example:</b> basdis 0 <br />
 <b>Realizing Function:</b> cmd_basdis <br />
 <b>Reference API:</b> <a class="el" href="group___b_a_s___c_l_i_e_n_t___exported___functions.html#ga923251cbf03d812d3f81b30d5c264b22">bas_start_discovery</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Periph"></a>
9.5.4 Peripheral Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.1 startadv</h5>
<p><b>Format:</b> startadv <br />
 <b>Meaning:</b> start advertising without setting advertising parameters <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> startadv <br />
 <b>Realizing Function:</b> cmd_startadv <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.2 stopadv</h5>
<p><b>Format:</b> stopadv <br />
 <b>Meaning:</b> Stop advertising <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> stopadv <br />
 <b>Realizing Function:</b> cmd_stopadv <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#ga595a44f828040d83fcadaa9fb4a8b21e">le_adv_stop</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.3 adv</h5>
<p><b>Format:</b> adv [adv_interval] [filter_policy] <br />
 <b>Meaning:</b> <br />
 <b>Parameters:</b> Start undirected advertising</p><ul>
<li>adv_interval: 0x0020 - 0x4000 (20ms - 10240ms, 0.625ms/step)</li>
<li>filter_policy: 0-(all), 1-(whitelist scan), 2-(whitelist conn), 3-(whitelist all)</li>
</ul>
<p><b>Example:</b> adv x40 0 <br />
 <b>Realizing Function:</b> cmd_adv <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.4 advld</h5>
<p><b>Format:</b> advld [BD0] [BD1] [BD2] [BD3] [BD4] [BD5] <br />
 <b>Meaning:</b> Start lower duty directed advertising<br />
 <b>Parameters:</b></p><ul>
<li>[BD0] [BD1] [BD2] [BD3] [BD4] [BD5]: peer address</li>
</ul>
<p><b>Example:</b> advld x11 x22 x33 x44 x55 x66 <br />
 <b>Realizing Function:</b> cmd_advld <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.5 advhd</h5>
<p><b>Format:</b> advhd [BD0] [BD1] [BD2] [BD3] [BD4] [BD5] <br />
 <b>Meaning:</b> Start high duty directed advertising <br />
 <b>Parameters:</b></p><ul>
<li>[BD0] [BD1] [BD2] [BD3] [BD4] [BD5]: peer address</li>
</ul>
<p><b>Example:</b> advhd x11 x22 x33 x44 x55 x66 <br />
 <b>Realizing Function:</b> cmd_advhd <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.6 advscan</h5>
<p><b>Format:</b> advscan <br />
 <b>Meaning:</b> Start scannable undirected advertising <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> advscan <br />
 <b>Realizing Function:</b> cmd_advscan <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.7 advnonconn</h5>
<p><b>Format:</b> advnonconn <br />
 <b>Meaning:</b> Start non_connectable undirected advertising <br />
 <b>Parameters:</b> None <br />
 <b>Example:</b> advnonconn <br />
 <b>Realizing Function:</b> cmd_advnonconn <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___broadcaster___exported___functions.html#gaab66fe11018e3705abf9b1a8c5bdddb1">le_adv_start</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.8 latency</h5>
<p><b>Format:</b> latency [conn_id] [on_off] <br />
 <b>Meaning:</b> Turn on and off slave latency <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>on_off: 0-(turn on the latency), 1-(turn off the latency)</li>
</ul>
<p><b>Example:</b> latency 0 1 <br />
 <b>Realizing Function:</b> cmd_latency <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga263cd6258581b6638f611931ad2fda37">le_disable_slave_latency</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.4.9 epassed</h5>
<p><b>Format:</b> epassed [enable] <br />
 <b>Meaning:</b> Update instant passed channel map <br />
 <b>Parameters:</b></p><ul>
<li>enable: 0 - (disable), 1-(enable)</li>
</ul>
<p><b>Example:</b> epassed 1 <br />
 <b>Realizing Function:</b> cmd_epassed <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___l_e___c_o_n_n_e_c_t_i_o_n___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#gaf57f738d3becf91f00592a56ace04f18">le_update_passed_chann_map</a> <br />
</p>
<h4><a class="anchor" id="UserCmd_Sv"></a>
9.5.5 GATT Services Related Commands</h4>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.5.1 gapprefconn</h5>
<p><b>Format:</b> gapprefconn [conn_interval_min] [conn_interval_max] [latency] [supervision_timeout] <br />
 <b>Meaning:</b> Set GAP service Peripheral Preferred Connection Parameters Char value <br />
 <b>Parameters:</b></p><ul>
<li>conn_interval_min: 0x0006 to 0x0C80(1.25ms/step)</li>
<li>conn_interval_max: 0x0006 to 0x0C80(1.25ms/step)</li>
<li>latency: 0x0000 to 0x01F3</li>
<li>supervision_timeout: 0x000A to 0x0C80(10ms/step)</li>
</ul>
<p><b>Example:</b> gapprefconn x80 x90 0 500 <br />
 <b>Realizing Function:</b> cmd_gapprefconn <br />
 <b>Reference API:</b> <a class="el" href="group___g_a_p___g_a_t_t___s_e_r_v_i_c_e___exported___functions.html#ga2b7437b28a6022a1f90f121b55f7a86d">gaps_set_peripheral_preferred_conn_param</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.5.2 simpv3notify</h5>
<p><b>Format:</b> simpv3notify [conn_id] [len] <br />
 <b>Meaning:</b> Send V3 notification <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>len: 0 - (mtu-3)</li>
</ul>
<p><b>Example:</b> simpv3notify 0 10 <br />
 <b>Realizing Function:</b> cmd_simpv3notify <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___service___exported___functions.html#ga8d644966c8211083be66835b367d2f4c">simp_ble_service_send_v3_notify</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.5.3 simpv4ind</h5>
<p><b>Format:</b> simpv4ind [conn_id] [len] <br />
 <b>Meaning:</b> Send V4 indication <br />
 <b>Parameters:</b></p><ul>
<li>conn_id: connection id</li>
<li>len: 0 - (mtu-3)</li>
</ul>
<p><b>Example:</b> simpv4ind 0 10 <br />
 <b>Realizing Function:</b> cmd_simpv4ind <br />
 <b>Reference API:</b> <a class="el" href="group___s_i_m_p___service___exported___functions.html#ga1ce4a85c68f96d9c00d944802265ff73">simp_ble_service_send_v4_indicate</a> <br />
</p>
<p><a class="anchor" id="invalid"></a></p><h5>9.5.5.4 basnotify</h5>
<p><b>Format:</b> basnotify [conn_id] [battery_level] <br />
 <b>Meaning:</b> Send battery level notification <br />
 <b>Parameters:</b></p><ul>
<li>battery_level: 0 - 100</li>
</ul>
<p><b>Example:</b> basnotify 0 80 <br />
 <b>Realizing Function:</b> cmd_basnotify <br />
 <b>Reference API:</b> <a class="el" href="group___b_a_s___exported___functions.html#gac7fc6dfb96aa2a4ed4de142a479c1ec1">bas_battery_level_value_notify</a> <br />
 </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
