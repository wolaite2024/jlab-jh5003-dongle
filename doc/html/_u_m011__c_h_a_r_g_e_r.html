<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Charger_Page"></a>
Charger Module User Manual </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2023/08/01</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Charger_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/08/01  </td><td class="markdownTableBodyCenter">Normal update   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Rev">Revision History</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Table_List">Table List</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Figure_List">Figure List</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Glossary">Glossary</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Intro">1 Introduction</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Interface_with_App_charger">2 How to Interface with app_charger</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Internal_Charger">3 Internal Charger</a><ul>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Principle_of_Internal_Charger">3.1 Principle of Internal Charger</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Charger_Configured_by_McuConfigTool">3.2 Charger Configured by McuConfigTool</a><ul>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#External_BJT_Charging">3.2.1 External BJT Charging</a></li>
</ul>
</li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Internal_Charger_APIs_from_ROM">3.3 Internal Charger APIs from ROM</a></li>
<li><a class="el" href="_u_m011__c_h_a_r_g_e_r.html#Internal_Charger_APIs_from_charger_utils">3.4 Internal Charger APIs from charger_utils</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Charger_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Charger_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 Charger System Architecture</a></li>
<li><a href="#figure_2_1">Figure 2-1 Internal Charger's Callback Flow as an Example</a></li>
<li><a href="#figure_3_1">Figure 3-1 Charger Curve</a></li>
<li><a href="#figure_3_2">Figure 3-2 High Current Charging Configuration</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Charger_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">SoC  </td><td class="markdownTableBodyCenter">State of Charge   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CC  </td><td class="markdownTableBodyCenter">Constant Current   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">CV  </td><td class="markdownTableBodyCenter">Constant Voltage   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">OCV  </td><td class="markdownTableBodyCenter">Open Circuit Voltage   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Charger_Intro"></a>
1  Introduction</h2>
<p>The whole charger system can be split into two layers. <br />
The <b>upper layer</b> is app_charger(app_charger.c) which reports SoC(State-of-Charge) and charge status to other module in APP layer. It is an abstract wrapper to hide difference between internal charger and external chargers. <br />
The <b>lower layer</b> is the implementation of charger that usually is internal charger, but an external charger is alternative. <br />
There is a rtk_charger.c in APP project as a wrapper for internal charger, because internal charger was placed in ROM. On the other hand, external charger should be implemented in APP project completely.</p>
<div class="image">
<img src="charger_architecture.png" alt="charger_architecture.png"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 Charger System Architecture</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Interface_with_App_charger"></a>
2  How to Interface with app_charger</h2>
<p>Internal charger from RTK is useful but external one is also optional. As described above, if you want to use external charger, you should interface with app_charger after finishing the driver of external charger. As to internal charger, RTK SDK have done it in rtk_charger.c. <br />
If you want the internal charger, you should set RTK_CHARGER_ENABLE to 1, and vice versa. All app_charger will switch between external and internal APIs as the code below.</p>
<div class="fragment"><div class="line"><a class="code" href="group___a_p_p___c_h_a_r_g_e_r___exported___types.html#ga579303d80c20fc65a43dd69c88411c0b">T_APP_CHARGER_STATE</a> <a class="code" href="group___a_p_p___c_h_a_r_g_e_r___exported___functions.html#ga6fff14eed74b428049768c4eb8742bb8">app_charger_get_charge_state</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___a_p_p___c_h_a_r_g_e_r___exported___types.html#ga579303d80c20fc65a43dd69c88411c0b">T_APP_CHARGER_STATE</a> app_charger_state = <a class="code" href="group___a_p_p___c_h_a_r_g_e_r___exported___types.html#gga579303d80c20fc65a43dd69c88411c0bade4b286682be02c1b437a6e15a330518">APP_CHARGER_STATE_ERROR</a>;</div><div class="line"></div><div class="line"><span class="preprocessor">#if RTK_CHARGER_ENABLE</span></div><div class="line">    <a class="code" href="group__x3e___c_h_a_r_g_e_r___a_p_i___exported___types.html#ga52fc9f613b9a072d17277ffaebb4c053">T_CHARGER_STATE</a> rtk_charger_state = rtk_charger_get_charge_state();</div><div class="line"></div><div class="line">    app_charger_state = app_charger_state_convert(rtk_charger_state);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> app_charger_state;</div><div class="line">}</div><div class="line"></div><div class="line">uint8_t <a class="code" href="group___a_p_p___c_h_a_r_g_e_r___exported___functions.html#gacb52ee1dc316fca2e31d202b02e503c6">app_charger_get_soc</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t soc = 0;</div><div class="line"></div><div class="line"><span class="preprocessor">#if RTK_CHARGER_ENABLE</span></div><div class="line">    soc = rtk_charger_get_soc();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> soc;</div><div class="line">}</div></div><!-- fragment --><p><br />
Generally, the major task for internal or external charger interfacing is to provide SoC and charge status to app_charger both by call and callbacks. <br />
<b>By call</b>, you should add your charger API in app_charger_get_charge_state and app_charger_get_soc. The content of these function is displayed as code as above. <br />
<b>By callbacks</b>, you should register callbacks to your own charger module(external charger). These callbacks finally send SoC and charge status in messages by app_io_msg_send. These messages will be handled in app_charger_handle_msg. Then app_charger is responsible for reporting information to other APP module. You can follow the flow of internal charger(rtk charger).</p>
<div class="image">
<img src="internal_charger_flow.png" alt="internal_charger_flow.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Internal Charger's Callback Flow as an Example</b></div></center><p><b>Note:</b></p><ol type="1">
<li>APP layer smoothly supports state of charge report during battery discharge. It will process state of charge reported by internal charger and calculate the average. Also, if state of charge drops greater than 3% in one time, APP charger will ignore this report to avoid unexpected noise. This feature can be disabled by turning off the macro "F_APP_SMOOTH_BAT_REPORT" in "app_flags.h".</li>
<li>APP layer supports battery report de-bounce. State of charge will be filtered by APP layer, so it can only drop in discharger mode and rise in charger mode.</li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Internal_Charger"></a>
3  Internal Charger</h2>
<h3><a class="anchor" id="Principle_of_Internal_Charger"></a>
3.1  Principle of Internal Charger</h3>
<p>Constant-current Constant-voltage (CC/CV) controlles the charge system. <br />
Considering the safety and efficiency of Li-Ion battery charging, the charging process is divided into three stages.</p>
<div class="image">
<img src="charger_curve.jpg" alt="charger_curve.jpg"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Charger Curve</b></div></center><p>Pre-charge Stage <br />
Before the battery voltage reaches the Pre-charge Voltage, the maximum (trickle) current can only be 1/10 (typically) of the general charge (CC). The excessive current will be converted into heat, which hasten the death of batteries.</p>
<p>Fast-charge Stage <br />
When the battery voltage exceeds the Pre-charge voltage then allowed enter the fast charging stage. In this stage, charging current should be limited (CC) and the charging voltage should be limited to the termination voltage (CV). In the early stage of fast charging, the charging rate will be bounding by the current limit. When the battery voltage is nearly to the full voltage, the charging current will gradually decrease, and the charging rate will be bounding by the limit voltage.</p>
<p>Finish Stage <br />
When the charging current is lower than the end current, it means that the battery is fully charged. Set the current upper limit to 0 to end the charging</p>
<h3><a class="anchor" id="Charger_Configured_by_McuConfigTool"></a>
3.2  Charger Configured by McuConfigTool</h3>
<p>Internal charger is configured by McuConfigTool. You can take a reference to "MCUConfig Tool User Guide.docx" within McuConfigTool.</p>
<div style="page-break-after: always;"></div><p><b>Note:</b></p><ol type="1">
<li>If the option "Disable Charger after charging finish 1 min" is on, charger will be disabled after entering finish state for 1 minute. This option is used to save power for charging box. If adapter in is detected, charger will be enabled again automatically. So this option is preferred to set in power down mode instead of DLPS mode.</li>
<li>If NTC is powered by PAD and uses Realtek's recommended hardware circuit for charger temperature detection, PAD rises slowly because of the capacitance on the hardware circuit, requiring a delay after pulling up PAD, using platform_delay_ms for a 6 ms delay, or os_delay for a 20 ms delay.</li>
<li>The input voltage range of the charger temperature detection pin is 0V ~ 0.9V.</li>
</ol>
<h3><a class="anchor" id="External_BJT_Charging"></a>
3.2.1  External BJT Charging</h3>
<p>The external BJT could be enabled for larger current charging for RTL8763D, and the charging current is supported up to 405mA to 1000mA. The configuration in McuConfigTool is shown in Figure 4. <br />
Note, the higher charging current leads to a higher voltage division in the internal resistance of the battery. And the voltage value get by API charger_utils_get_batt_volt is the OCV(open-circuit voltage) of the battery.</p><ul>
<li>when charging, OCV = vbat - i_charge * bettery_resistance</li>
<li>when discharging, OCV = vbat + i_discharge * battery_resitance</li>
</ul>
<p><br />
Therefore, the voltage value measured at the VBAT terminal is different from the value get by API charger_utils_get_batt_volt. To confirm the actual OCV when charging, users could measure the battery voltage separately when cutting off the charging line.</p>
<div class="image">
<img src="high_current_charging_configuration.bmp" alt="high_current_charging_configuration.bmp"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 High Current Charging Configuration</b></div></center><h3><a class="anchor" id="Internal_Charger_APIs_from_ROM"></a>
3.3  Internal Charger APIs from ROM</h3>
<p>Internal Charger source code is implemented in ROM. APIs' declarations are in charger_api.h.</p><ol type="1">
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga93eee8954c778fe791583c54e813ec59" title="register the user-defined callback function, which will be called by charger module when charge state...">charger_api_reg_state_of_charge_callback()</a> <br />
Register the user-defined callback function, which will be called by charger module when the state of charge(SOC, which is a term for charge, <a href="https://en.wikipedia.org/wiki/State_of_charge">https://en.wikipedia.org/wiki/State_of_charge</a>) changes. State of charge represents the quantity of electricity. User could append the APP code according to your demand.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#gac6fc2b2da215f9973d9929c89f5084c4" title="unregister the user-defined STATE_OF_CHARGE_CALLBACK callback function ">charger_api_unreg_state_of_charge_callback()</a> <br />
Unregister the user-defined STATE_OF_CHARGE_CALLBACK callback function.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga0f480ac5c23f661ef7f874893059a557" title="register the user-defined callback function, which will be called by charger moudle when charger modu...">charger_api_reg_charger_state_callback()</a> <br />
Register the user-defined callback function, which will be called by charger moudule when the charger module state (it is different from SOC mentioned above) changes.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga621ac7bb980686926639f66bd208e3dc" title="unregister the user-defined CHARGER_STATE_CALLBACK callback function ">charger_api_unreg_charger_state_callback()</a> <br />
Unregister the user-defined CHARGER_STATE_CALLBACK callback function.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga8d0ca41a345e386b94bd927305535e4a" title="enable charger module manually ">charger_api_enable_charger()</a> <br />
Enable charger module manually. IC's rom code calls it when USB adapter pluged. <br />
<b>Note:</b> it will cause soft reset of charger module and force discharger module to be disabled if discharger module is running.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga95e12841d6ef214c49628d5502fa26e6" title="disable charger module manually ">charger_api_disable_charger()</a> <br />
Disable charger module manually. IC's rom code calls it when USB adapter unpluged.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#gae8bb476f713ff946655c9538e9893f6b" title="enable discharger module manually ">charger_api_enable_discharger()</a> <br />
Enable discharger module manually. IC's rom code calls it when USB adapter unpluged. <br />
<b>Note:</b> it will cause soft reset of discharger module and force charger module to be disabled if charger module is running.</li>
<li><a class="el" href="group__x3e___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#gaae0a42890cecb7b89aa6aefa281b2004" title="disable discharger module manually ">charger_api_disable_discharger()</a> <br />
Disable discharger module manually. IC's rom code calls it when USB adapter pluged.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga3af01a0f68af6f509d87b445c552d26c" title="set maximum current of adapter ">charger_api_set_adapter_current()</a> <br />
Set maximum current of adapter. <br />
<b>Note:</b> it will trigger soft reset of charger module.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#gacf3e2af702a8b89b165e7a593a8bd46e" title="set full charge current (1C) ">charger_api_set_full_current()</a> <br />
Set full charge current, the alias is general current (CC). <br />
<b>Note:</b> it will trigger soft reset of charger module.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga04062770dc72c3ee3eee25aaa970f807" title="return state of charge ">charger_api_get_state_of_charge()</a> <br />
Get state of charge(SOC). If charger is in CHARGER_MODULE or DISCHARGER_MODULE, the fucntion would return a uint8_t value (0~100). The return value means battery's quentity of electricity (0%~100%). <br />
<b>Note:</b> it would return 255 when charger is in NO_ACTIVE_MODULE.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga6a75e3ff7f64ba7cf9d50d265a1a2765" title="return charger module state ">charger_api_get_charger_state()</a> <br />
Get the charger module state. The function would return the ChargerState_t type data.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___a_p_i___e_x_p_o_r_t___functions.html#ga59cea66e99e3a9d0e9368fad08219a59" title="return error code of charger module ">charger_api_get_error_code()</a> <br />
Get the error code of charger module. There are 11 error cases described as ChargerErrorCode_t.</li>
</ol>
<h3><a class="anchor" id="Internal_Charger_APIs_from_charger_utils"></a>
3.4  Internal Charger APIs from charger_utils</h3>
<ol type="1">
<li><a class="el" href="group___c_h_a_r_g_e_r___u_t_i_l_s___exported___functions.html#gad0baacf601a712e760f8105f782dd7c8" title="Get charging voltage. ">charger_utils_get_batt_volt()</a> <br />
Get the voltage of battery.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___u_t_i_l_s___exported___functions.html#ga972c7174af30e76a9605f81d3bfa1e74" title="Get charging current, unit: mA. ">charger_utils_get_batt_curr()</a> <br />
Get the current of battery.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___u_t_i_l_s___exported___functions.html#ga16120d49142503a8d512425bdc3d0c85" title="Get charging temperature1 and temperature2. ">charger_utils_get_batt_temp()</a> <br />
Get the temperature of battery.</li>
<li><a class="el" href="group___c_h_a_r_g_e_r___u_t_i_l_s___exported___functions.html#ga0b775623f620e91955655af5129101bb" title="Get charging adapter voltage, unit: mV. ">charger_utils_get_adapter_volt()</a> <br />
Get the voltage of adapter. </li>
</ol>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
