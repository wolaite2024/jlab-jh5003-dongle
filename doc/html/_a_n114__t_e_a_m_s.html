<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="TEAMS_Page"></a>
TEAMS Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.0.0.1</b></center><p><br />
 </p><center><b>2022/9/20</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Teams_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2021/11/05  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Teams_Rev">Revision History</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Teams_Table_List">Table List</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Teams_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Teams_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#TEAMS_enable">1 Feature enable</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#File_configuration">1.1 File configuration</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Keil_configuration">1.2 Keil configuration</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Macro_configuration">1.3 Macro configuration</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#TEAMS_Introduction">2 Introduction</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#ASP">2.1 ASP</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Telemetry">2.2 Telemetry</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#VP_update">3 VP update</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#BT_Policy">4 BT Policy</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Cod_Info">4.1 Cod Info</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Pairing_mode">4.2 Pairing mode</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Reconnect">4.3 Reconnect</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Qos">4.4 Qos</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Auto_power_off">4.5 Auto power off</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#BLE_Policy">5 Ble Policy</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#BLE_Reconnect">5.1 BLE reconnect</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#BLE_Disconnect">5.2 BLE disconnect</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Multilink_policy">6 Multilink policy</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Sco_and_Sco">6.1 Sco and Sco</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#A2dp_and_A2dp">6.2 A2dp and A2dp</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Recorder_and_Recorder">6.3 recorder and recorder</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#A2dp_and_Record">6.4 A2dp and Record</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Sco_and_A2dp_and_Recorder">6.5 Sco and A2dp and Recorder</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Default_Multilink_Policy">6.6 Multilink Policy</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#USB_channel">6.7 USB channel</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Active_link_index">6.8 Active link index</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Channel_Support_feature">6.9 Channel support feature</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Notification">6.10 Notification</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#UI">7 UI</a><ul>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Button">7.1 Button</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#Voice_prompt">7.2 Voice prompt</a></li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#LED">7.3 LED</a></li>
</ul>
</li>
<li><a class="el" href="_a_n114__t_e_a_m_s.html#MTE_Command">8 MTE Command</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Teams_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Teams_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 lib file path</a></li>
<li><a href="#figure_1_2">Figure 1-2 C file path</a></li>
<li><a href="#figure_1_3">Figure 1-3 Add lib file in keil</a></li>
<li><a href="#figure_1_4">Figure 1-4 Add C file in keil</a></li>
<li><a href="#figure_2_1">Figure 2-1 Teams Button set in Mcu Config Tool</a></li>
<li><a href="#figure_2_2">Figure 2-2 Telemetry Data Type</a></li>
<li><a href="#figure_3_1">Figure 3-1 VP update Tool in Windows OS</a></li>
<li><a href="#figure_3_2">Figure 3-2 PID and VID set in config file</a></li>
<li><a href="#figure_3_3">Figure 3-3 VP update cmd</a></li>
<li><a href="#figure_3_4">Figure 3-4 VP update success</a></li>
<li><a href="#figure_4_1">Figure 4-1 Pairing set in mcu config tool</a></li>
<li><a href="#figure_4_2">Figure 4-2 Linkback Set in MCU config tool</a></li>
<li><a href="#figure_4_3">Figure 4-3 Auto poweroff Set in MCU config tool</a></li>
<li><a href="#figure_5_1">Figure 5-1 ble adv broadcast rule</a></li>
<li><a href="#figure_6_1">Figure 6-1 Multilink policy</a></li>
<li><a href="#figure_6_2">Figure 6-2 fearure support on channel</a></li>
<li><a href="#figure_7_1">Figure 7-1 Mute Button Config</a></li>
<li><a href="#figure_7_2">Figure 7-2 VP Config1</a></li>
<li><a href="#figure_7_3">Figure 7-3 VP Config2</a></li>
</ul>
<p> <style>div.image img[src="teams_button_config.jpg"]{width:250px;}
                                                   img[src="vp_update_file.jpg"]{width:500px;}
                                                   img[src="PID_VID.jpg"]{width:500px;}
                                                   img[src="vp_update_cmd.jpg"]{width:500px;}
                                                   img[src="vp_update_result.jpg"]{width:500px;}
                                                   img[src="pairing_set.jpg"]{width:500px;}
                                                   img[src="linkback_set.jpg"]{width:500px;}
                                                   img[src="auto_power_off_set.jpg"]{width:500px;}
                                                   img[src="teams_lib_location.jpg"]{width:500px;}
                                                   img[src="teams_source_file_location.jpg"]{width:500px;}
                                                   img[src="keil_lib_set.jpg"]{width:500px;}
                                                   img[src="keil_source_file_set.jpg"]{width:500px;}
                                                   img[src="telemetry_data.jpg"]{width:500px;}
                                                   img[src="default_policy.jpg"]{width:700px;}
                                                   img[src="channel_feature.jpg"]{width:700px;}
</style> </p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Teams_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Teams  </td><td class="markdownTableBodyCenter">Microsoft Teams App   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">ASP  </td><td class="markdownTableBodyCenter">Protocol between client and server   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Telemetry  </td><td class="markdownTableBodyCenter">Server info about user experience and device attribute   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TEAMS_enable"></a>
1 Feature enable</h2>
<h3><a class="anchor" id="File_configuration"></a>
1.1 File configuration</h3>
<p>Copy teams.lib file from 3rd_service_teams to sdk. </p><div class="image">
<img src="teams_lib_location.jpg" alt="teams_lib_location.jpg"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 lib file path</b></div></center><p>Copy teams source files form 3rd_service_teams to the path of sdk. </p><div class="image">
<img src="teams_source_file_location.jpg" alt="teams_source_file_location.jpg"/>
</div>
 <center><div id="figure_1_2"><b>Figure 1-2 C file path</b></div></center><h3><a class="anchor" id="Keil_configuration"></a>
1.2 Keil configuration</h3>
<p>Add lib file to target. </p><div class="image">
<img src="keil_lib_set.jpg" alt="keil_lib_set.jpg"/>
</div>
 <center><div id="figure_1_3"><b>Figure 1-3 Add lib file in keil</b></div></center><p>Add source file to target. </p><div class="image">
<img src="keil_source_file_set.jpg" alt="keil_source_file_set.jpg"/>
</div>
 <center><div id="figure_1_4"><b>Figure 1-4 Add C file in keil</b></div></center><p>Asp feature including (teams.lib and app_asp_device.c and app_asp_device_rfc.c files) support private protocol with teams app.</p>
<p>Hid feature including (app_hid_rfc.c and app_teams_hid.c files) support data channel including spp/classic hid/ble.</p>
<p>CFU feature(include app_teams_cfu.c/pordCA.s/testCA.s/Crypto interface.c files) support ota for device.</p>
<p>app_teams_util.c: util function/variable value/macro for teams module.</p>
<p>app_teams_audio_policy.c: Support adaptation for ms project about audio include language set/vp play/mute state/etc.</p>
<p>app_teams_bt_policy.c: Support adaptation for ms project about bt policy include device detect/reconnect/pairing.</p>
<p>app_teams_ble_policy.c: Support adaptation for ms project about ble policy include device detect/reconnect/pairing.</p>
<p>app_teams_ext_ftl.c: Support flash api for teams.</p>
<p>app_teams_rws.c: Support teams feature could support rws mode.</p>
<p>app_teams_cmd.c:.</p>
<p>app_teams_customized_cmd.c:.</p>
<p>app_teams_extend_led.c:.</p>
<h3><a class="anchor" id="Macro_configuration"></a>
1.3 Macro configuration</h3>
<p>F_APP_SAMPLE_CONFIG_TEAMS_RWS_SUPPORT: Macro set for rws mode.</p>
<p>F_APP_SAMPLE_CONFIG_TEAMS_SINGLE_SUPPORT: Macro set for single mode.</p>
<p>These two mode macro set has some feature macro set, defines for these feature macro plaease see follow details:</p>
<p>F_APP_TEAMS_FEATURE_SUPPORT: Enable/disable asp/telemetry/cfu/teams UI.</p>
<p>F_APP_TEAMS_HID_SUPPORT: Enable/disable Classic hid.</p>
<p>F_APP_TEAMS_CUSTOMIZED_CMD_SUPPORT: Enable/disable MS customized cmd.</p>
<p>F_APP_TEAMS_VP_UPDATE_SUPPORT: Enable/disable VP update resource.</p>
<p>F_APP_TEAMS_BT_POLICY: Enable/disable teams bt policy.</p>
<p>F_APP_CFU_SUPPORT: Enable/disable CFU feature.</p>
<p>F_APP_SINGLE_MUTLILINK_SCENERIO_1: Enable/disable multilink policy for MS.</p>
<p>F_APP_USB_AUDIO_SUPPORT: Enable/disable audio feature in usb channel.</p>
<p>F_APP_SAMPLE_CONFIG_TEAMS_RWS_SUPPORT or F_APP_SAMPLE_CONFIG_TEAMS_SINGLE_SUPPORT has own macro set of feature macro, each combination details please see app_flags.h.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TEAMS_Introduction"></a>
2 Introduction</h2>
<p>The purpose of this document is to give an overview of the app teams module for customer. The document describes how to use teams module in app project, include communication with teams app, vp update in device, BT policy, UI, MTE cmd, Multilink. The details will be described in the following sections.</p>
<h3><a class="anchor" id="ASP"></a>
2.1 ASP</h3>
<p>ASP Protocol is format of msg in communication with teams app, user should set F_APP_TEAMS_FEATURE_SUPPORT to true in app_flags.h. 1). Firstly host will do auth process with device while link connected, auth process is a set of pkt by which host send version/enum/locale info to device and receice rsp from device, the state of device which has asp auth process is called active . User can get event about host becoming active or inactive: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_asp_device_handle_asp_info_cback(T_ASP_INFO_MSG *msg_data)</div><div class="line">{</div><div class="line">        .....</div><div class="line">    <span class="keywordflow">switch</span> (msg_data-&gt;asp_info_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> T_ASP_DEVICE_ASP_INFO_STATE:</div><div class="line">        <span class="comment">/* 1 : active; 0 : inactive */</span></div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_asp_device_handle_asp_info_cback: bd_addr %s, asp link state %d&quot;</span>,</div><div class="line">                        <a class="code" href="group___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(msg_data-&gt;asp_info_data.asp_link_state_data.bd_addr),</div><div class="line">                        msg_data-&gt;asp_info_data.asp_link_state_data.asp_link_state);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>2). Device also can receive notification with app_asp_device_handle_notification_cback api: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    T_ASP_DEVICE_CTOD_NOTIFICATION_CLEAR_ALL,</div><div class="line">    T_ASP_DEVICE_CTOD_NOTIFICATION_MISSING_MEETING,</div><div class="line">    T_ASP_DEVICE_CTOD_NOTIFICATION_UPCOMING_MEETING,</div><div class="line">    T_ASP_DEVICE_CTOD_NOTIFICATION_UNCHECKED_VOICE_MAIL</div><div class="line">} T_ASP_DEVICE_CTOD_NOTIFICATION_TYPE;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_asp_device_handle_notification_cback(uint8_t *bd_addr, T_ASP_DEVICE_CTOD_NOTIFICATION_TYPE event_type)</div><div class="line">{</div><div class="line">      .....</div><div class="line">}</div></div><!-- fragment --><p>3). User can use teams button by config mmi action of key. </p><div class="image">
<img src="teams_button_config.jpg" alt="teams_button_config.jpg"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Teams Button set in Mcu Config Tool</b></div></center><p>4). then user can press key to trigger teams button short press or long press.</p>
<p>5). If user want to control teams button trigger point by yourself: </p><div class="fragment"><div class="line">bd_addr = asp_device_api_get_active_link_addr();   <span class="comment">//get active host bd_addr</span></div><div class="line"><span class="keywordflow">if</span> (bd_addr)</div><div class="line">{</div><div class="line">      <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#gad344d6ea2ac6c5eac99b3cc66719f6ab">app_asp_device_send_teams_button_invoked_msg</a>(bd_addr, ASP_DEVICE_SOURCE_ID_SHORT_PRESS);  <span class="comment">//send teams button short press</span></div><div class="line">}</div></div><!-- fragment --><p>6). If in multilink scenario, there is a selected device, the other device is non-selected device, all msg from host could be handled by dut, but only selected device could send teams button and telemetry msg. The asp selected device would follow multilink active device which has asp auth process, thats means asp selected device would change to same device which is new multilink active device. There is one scenario that asp selected device is not same with multilink active device. a. Multilink active device not has asp auth process. There is one scenario that asp selected device may be not same with multilink active device. b. There is a device which has hold call and device voice status is idle.</p>
<h3><a class="anchor" id="Telemetry"></a>
2.2 Telemetry</h3>
<p>Telemetry is protocol for host get info from device, info about device is: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    T_ASP_DEVICE_TELEMETRY_ENDPOINT_FIRMWARE_VERSION = 1,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_DONGLE_FIRMWARE_VERSION,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_DON_ANSWER_SETTING,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_ENDPOINT_DEVICE_MODEL_ID,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_INVALID_ENUM              = 5,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_ENDPOINT_DEVICE_SERIAL_NUM,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_DONGLE_DEVICE_SERIAL_NUM,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_USER_MODIFIED_SIDETONE_LEVEL,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_AUDIO_CODEC_USED,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_DSP_EFFECTS               = 10,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_HARDMUTE_LOCK,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_HEADSET_WORN,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_BATTERY_LEVEL,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_DEVICE_READY,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_RADIO_LINK_QUALITY        = 15,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_ERROR_MSG,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_BUTTON_PRESS_INFO,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_CONNECTED_WIRELESS_DEVICE_CHANGE,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_PEOPLE_COUNT,</div><div class="line">    T_ASP_DEVICE_TELEMETRY_LOCAL_CONFERENCE_COUNT    = 20</div><div class="line">} T_ASP_DEVICE_TELEMETRY_TYPE;</div></div><!-- fragment --><p> not all info the host need, so if devcie rcv some msg which host not need, this msg would not get rsp.</p>
<p>when device receive telemetry req from host(CT mode), user can receice event in app_asp_device_handle_telemetry_cback(): </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_asp_device_handle_telemetry_cback(uint8_t *bd_addr, T_ASP_DEVICE_TELEMETRY_TYPE element_id,</div><div class="line">                                           uint8_t *data_len, uint8_t **data)</div><div class="line">{</div><div class="line">      .....</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (element_id)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> T_ASP_DEVICE_TELEMETRY_ENDPOINT_FIRMWARE_VERSION:</div><div class="line">        memcpy(telemetry_data, current_firmware, <span class="keyword">sizeof</span>(current_firmware));</div><div class="line">        *data_len = <span class="keyword">sizeof</span>(current_firmware) - 1 ;</div><div class="line">        *data = telemetry_data;</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">     }</div><div class="line">}</div></div><!-- fragment --><p> telemetry_data is static data which save rsp pkt data from user, and user must save data length and data pointer.</p>
<p>Device could send telemetry info to host forwardly(DT mode), user can use api <a class="el" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga4168410536c314836842f182f00c6501" title="interface for app to send telemetry update data msg ">app_asp_device_send_teams_telemetry_update_msg()</a>. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga4168410536c314836842f182f00c6501">app_asp_device_send_teams_telemetry_update_msg</a>(uint8_t *br_addr,</div><div class="line">                                                    uint32_t mask)</div><div class="line">{</div><div class="line">        bd_addr: user can <span class="keyword">get</span> from api asp_device_api_get_active_link_addr()</div><div class="line">        mask: user get form api app_asp_device_convert_elementid_to_mask() which param is T_ASP_DEVICE_TELEMETRY_TYPE that user want to send</div><div class="line">}</div></div><!-- fragment --><p> then process is same with CT mode.</p>
<p>if data format that user want to send is bool or uint8, user can send multi-data by setting param mask in api app_asp_device_send_teams_telemetry_update_msg with multi and corrcet bit. if data format that user want to send is uint32_t or string, user would send one by one using <a class="el" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga4168410536c314836842f182f00c6501" title="interface for app to send telemetry update data msg ">app_asp_device_send_teams_telemetry_update_msg()</a> which param mask only has one bit. Telemetry data detailed info: </p><div class="image">
<img src="telemetry_data.jpg" alt="telemetry_data.jpg"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Telemetry Data Type</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="VP_update"></a>
3 VP update</h2>
<p>VP update is the feature that user could change vp resource due to own need, in update process, user could play music. If vp user want to update is active index, active index would be change to default index(#0), and after process finished, user should reset active vp index. <br />
If user need device to support vp update feature, user should open macro(F_APP_TEAMS_VP_UPDATE_SUPPORT) in app_flags.h, and get special SDK inage from RTK.</p>
<p>vp update process: 1). Open vp update file, make sure PID and VID are same with device. </p><div class="image">
<img src="vp_update_file.jpg" alt="vp_update_file.jpg"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 VP update Tool in Windows OS</b></div></center><div class="image">
<img src="PID_VID.jpg" alt="PID_VID.jpg"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 PID and VID set in config file</b></div></center><p>2). Open Windows cmd, and input ".\VpUpdate.exe vp VpUpdate.cfg update VP_ar.bin", VP_ar.bin is what you want to update that must be in same folder. </p><div class="image">
<img src="vp_update_cmd.jpg" alt="vp_update_cmd.jpg"/>
</div>
 <center><div id="figure_3_3"><b>Figure 3-3 VP update cmd</b></div></center><p>3). After update finished, Please note result, if success. </p><div class="image">
<img src="vp_update_result.jpg" alt="vp_update_result.jpg"/>
</div>
 <center><div id="figure_3_4"><b>Figure 3-4 VP update success</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="BT_Policy"></a>
4 BT Policy</h2>
<p>User could set macro(F_APP_TEAMS_BT_POLICY) to true to support teams BT policy, the special is follow feature. </p>
<h3><a class="anchor" id="Cod_Info"></a>
4.1 Cod Info</h3>
<p>Device would know host type when link connected if it has paired, host type include default/dongle/computer/phone. Device type would be identification in first auth process, phone and computer are distinguished by cod data in conn ind, if cod data are not phone or computer, device would send sdp req for sepical service. if rsp is correct, this host would be dongle type. After get these info, device would save info in flash and sync with bond list. if user want to know host type, could use api. </p><div class="fragment"><div class="line">T_TEAMS_DEVICE_TYPE app_bt_policy_get_cod_type_by_addr(uint8_t *bd_addr)  <span class="comment">//if bd_addr are not found in flash, api would return default type</span></div></div><!-- fragment --><p>Device could save only one dongle host(could be replaced) in flash, so if user want to get dongle host in flash, can use api. </p><div class="fragment"><div class="line">uint8_t *app_bt_policy_find_dongle_device(<span class="keywordtype">void</span>)   <span class="comment">//if no dongle in flash, api would return NULL</span></div></div><!-- fragment --><p>Normal factory reset would erase phone and computer device type in flash, and not erase dongle type info, only MTE cmd could do this.</p>
<h3><a class="anchor" id="Pairing_mode"></a>
4.2 Pairing mode</h3>
<p>If device are support for multilink and link num is max now, if user want to entrt pairing, device would disconnect non-dongle device, this handle process. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_teams_bt_prepare_for_dedicated_enter_pairing_mode(<span class="keywordtype">void</span>)</div></div><!-- fragment --><p>Pairing mode timeout could set by mcu config tool: </p><div class="image">
<img src="pairing_set.jpg" alt="pairing_set.jpg"/>
</div>
 <center><div id="figure_4_1"><b>Figure 4-1 Pairing set in mcu config tool</b></div></center><h3><a class="anchor" id="Reconnect"></a>
4.3 Reconnect</h3>
<p>When device linkback, it would linkback dongle firstly, this code is in api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___l_i_n_k_b_a_c_k.html#gab56cbc30a058c81337a48ae5c1ed0ea4">linkback_load_bond_list</a>(uint8_t skip_node_num, uint16_t retry_timeout)</div></div><!-- fragment --><p>linkback config could set by mcu config tool. </p><div class="image">
<img src="linkback_set.jpg" alt="linkback_set.jpg"/>
</div>
 <center><div id="figure_4_2"><b>Figure 4-2 Linkback Set in MCU config tool</b></div></center><p> linkback have two types, power on linkback and linklost linkback. Non-discoverable when linkback config means if device enter pairing when linkback. Maximum trail linkback source count config means if try next device if linkback current device failed, the num could be max 8 which equal to max bond num.</p>
<h3><a class="anchor" id="Qos"></a>
4.4 Qos</h3>
<p>If device is running vp update or cfu update, there is one special qos policy.</p><ol type="1">
<li>The link qos is set to update mode which is running vp update or cfu.</li>
<li>The other link qos is set to idle mode.</li>
<li>The mode value could be set in app_bt_policy_api.c <div class="fragment"><div class="line"><span class="keyword">const</span> T_BP_TPOLL_MAPPING tpoll_table[BP_TPOLL_MAX] =</div><div class="line">{</div><div class="line">    {BP_TPOLL_INIT, 0},</div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">    {BP_TPOLL_IDLE, 16},</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    {BP_TPOLL_IDLE, 40},</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    {BP_TPOLL_GAMING_A2DP, 22},</div><div class="line">    {BP_TPOLL_GAMING_DONGLE_RWS, 6},</div><div class="line">    {BP_TPOLL_GAMING_DONGLE_RWS_SINGLE, 12},</div><div class="line">    {BP_TPOLL_GAMING_DONGLE_STEREO, 6},</div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">    {BP_TPOLL_A2DP, 10},</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    {BP_TPOLL_A2DP, 26},</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    {BP_TPOLL_TEAMS_UPDATE, 16},</div><div class="line">    {BP_TPOLL_IDLE_SINGLE_LINKBACK, 120},</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_bt_policy_qos_param_update(uint8_t *bd_addr, <a class="code" href="group___a_p_p___b_t___p_o_l_i_c_y.html#gab5a783728285a7d6ec7ccfca86488a45">T_BP_TPOLL_EVENT</a> event)</div><div class="line">{</div><div class="line">    .....</div><div class="line">#<span class="keywordflow">if</span> F_APP_TEAMS_BT_POLICY</div><div class="line">        <span class="comment">/* if there is anyone link is cfu or vp update running*/</span></div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_hid_vp_update_is_process_check(&amp;p_teams_link) ||</div><div class="line">                 app_teams_cfu_is_process_check(&amp;p_teams_link))</div><div class="line">        {</div><div class="line">            <span class="comment">/*set qos of teams update running link to 16 */</span></div><div class="line">            uint8_t index = p_teams_link-&gt;id;</div><div class="line">            <a class="code" href="group___b_t___b_t_m.html#gadba2350e49cdeada583e90fb97520235">bt_link_qos_set</a>(p_teams_link-&gt;bd_addr, <a class="code" href="group___b_t___b_t_m.html#gga2377c978c006dc6db6bb08b691209476ad84b0a0de8f70293d62b84d9235bfb08">BT_QOS_TYPE_GUARANTEED</a>,</div><div class="line">                            tpoll_table[BP_TPOLL_TEAMS_UPDATE].tpoll_value);</div><div class="line">            <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].tpoll_status = tpoll_table[BP_TPOLL_TEAMS_UPDATE].state;</div><div class="line"></div><div class="line">            <span class="comment">/* set the other link qos to 40*/</span></div><div class="line">            <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="group___a_p_p___l_i_n_k.html#ga51f528a501ab0487c37c465106298105">MAX_BR_LINK_NUM</a>; i++)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___l_i_n_k.html#gaa65db00af8ad57c9f54b286abf56bf96">app_check_b2s_link_by_id</a>(i))</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">if</span> ((index != i) &amp;&amp; (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[i].tpoll_status != tpoll_table[BP_TPOLL_IDLE].state))</div><div class="line">                    {</div><div class="line">                        app_bt_policy_set_normal_idle_tpoll(i);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    .....</div><div class="line">}</div></div><!-- fragment --> Note: The priority of qos adjust for vp update or cfu is lower than call and a2dp, so if these is call or a2dp, the qos may not this.</li>
</ol>
<h3><a class="anchor" id="Auto_power_off"></a>
4.5 Auto power off</h3>
<div class="image">
<img src="auto_power_off_set.jpg" alt="auto_power_off_set.jpg"/>
</div>
 <center><div id="figure_4_3"><b>Figure 4-3 Auto poweroff Set in MCU config tool</b></div></center><p> Auto power off timer: timeout for auto power off that these is no link. Auto power off while phone connected and anc apt off timer: timeout for auto power off that these is at least one link. User could set due to own need.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="BLE_Policy"></a>
5 Ble Policy</h2>
<h3><a class="anchor" id="BLE_Reconnect"></a>
5.1 BLE reconnect</h3>
<p>If bredr device has connected acl link and dut has ble bond info whose bd_addr is same with bredr, dut would xmit direct adv for ble link connecting with same device by ble channel. If ble link is disconnect or linkloss and bredr link is still existed, dut would also xmit direct adv for ble link connecting with same device by ble channel. Ble adv param could be set by follow data: </p><div class="fragment"><div class="line"><span class="preprocessor">#define APP_TEAMS_BLE_POLICY_ADV_DURATION (60*1000)</span></div><div class="line"><span class="preprocessor">#define APP_TEAMS_BLE_POLICY_ADV_PERIOD (120*1000)</span></div></div><!-- fragment --> <div class="image">
<img src="ble_adv_introduce.jpg" alt="ble_adv_introduce.jpg"/>
</div>
 <center><div id="figure_5_1"><b>Figure 5-1 ble adv broadcast rule</b></div></center><h3><a class="anchor" id="BLE_Disconnect"></a>
5.2 BLE disconnect</h3>
<p>If bredr link is disconnected, ble link would disconnected.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Multilink_policy"></a>
6 Multilink policy</h2>
<p>If user want teams multilink manager policy, user could set macro(F_APP_SINGLE_MUTLILINK_SCENERIO_1) to true. </p>
<h3><a class="anchor" id="Sco_and_Sco"></a>
6.1 Sco and Sco</h3>
<p>Sco priority is managered by HFP status in multilink. These is a array to save sco priority, index 0 is highest in sco priority. So when device rcv hfp status msg, multilink manager would compare this link priority with left index, if link priority is higher than left, multilink would swap index and index -1, this porcess would continue until priority is not higher or index is zero. After comparing, manager would start audio track due to index 0 device if device hfp status is not idle.</p>
<p>The entrance api of rcv hfp status: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_voice_priority_rearrangment(uint8_t index, <a class="code" href="group___b_t___h_f_p.html#gaef1b59a02955bcc23e27fb42721788d1">T_BT_HFP_CALL_STATUS</a> hfp_status)</div></div><!-- fragment --><p>hfp status map to priority level: </p><div class="fragment"><div class="line">High:</div><div class="line">BT_HFP_VOICE_ACTIVATION_ONGOING</div><div class="line"><a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a85f0b0a1b3b00478808a5fcc21d9397a">BT_HFP_CALL_ACTIVE</a></div><div class="line"><a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841ad32405407740084ca83cecacb581384d">BT_HFP_CALL_ACTIVE_WITH_CALL_WAITING</a></div><div class="line">BT_HFP_CALL_ACTIVE_WITH_CALL_HOLD</div><div class="line">BT_HFP_OUTGOING_CALL_ONGOING</div><div class="line"></div><div class="line">mid:</div><div class="line">BT_HFP_INCOMING_CALL_ONGOING</div><div class="line"></div><div class="line">low:</div><div class="line"><a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a6e4dbd4c6c100b2d903a4baf6c5057f3">BT_HFP_CALL_IDLE</a></div></div><!-- fragment --><p>Compare logical: </p><div class="fragment"><div class="line"><span class="comment">// 1: sec &gt; fir;</span></div><div class="line"><span class="comment">// 0: sec == fir</span></div><div class="line"><span class="comment">//-1: sec &lt; fir</span></div><div class="line">int8_t app_teams_multilink_compare_voice_priority(uint8_t fir_index, uint8_t sec_index)</div><div class="line">{</div><div class="line">    T_APP_TEAMS_MULTILINK_VOICE_PRIORITY_LEVEL fir_level =</div><div class="line">        app_teams_multilink_convert_hfp_status_to_priority(</div><div class="line">            app_teams_multilink_app_high_priority_mgr[fir_index].voice_status);</div><div class="line">    T_APP_TEAMS_MULTILINK_VOICE_PRIORITY_LEVEL sec_level =</div><div class="line">        app_teams_multilink_convert_hfp_status_to_priority(</div><div class="line">            app_teams_multilink_app_high_priority_mgr[sec_index].voice_status);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (fir_level &lt; sec_level)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fir_level == sec_level)</div><div class="line">    {</div><div class="line">        <span class="comment">// in active call scene, second &gt; first</span></div><div class="line">        <span class="keywordflow">if</span> (fir_level == APP_TEAMS_MULTILINK_VOICE_PRIORITY_HIGH)</div><div class="line">        {</div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">            <span class="keywordflow">if</span> (!fir_index)</div><div class="line">            {</div><div class="line">                app_teams_multilink_send_hold(app_teams_multilink_app_high_priority_mgr[fir_index].idx);</div><div class="line">            }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">            <span class="keywordflow">return</span> 1;</div><div class="line">        }</div><div class="line">        <span class="comment">// incoming or outgoing, second == first</span></div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fir_level == APP_TEAMS_MULTILINK_VOICE_PRIORITY_MIDM)</div><div class="line">        {</div><div class="line">            <span class="comment">// if fir and sec are not active voice link, second &gt; first.</span></div><div class="line">            <span class="keywordflow">if</span> (fir_index &amp;&amp; sec_index)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> 1;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <span class="comment">// first device is link disconnect and sec device is link connected</span></div><div class="line">            <span class="keywordflow">if</span> (!app_teams_multilink_check_hfp_profile_connected(</div><div class="line">                    app_teams_multilink_app_high_priority_mgr[fir_index].idx) &amp;&amp;</div><div class="line">                app_teams_multilink_check_hfp_profile_connected(</div><div class="line">                    app_teams_multilink_app_high_priority_mgr[sec_index].idx))</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> 1;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="A2dp_and_A2dp"></a>
6.2 A2dp and A2dp</h3>
<p>A2dp priority is managered by a2dp stream status in multilink. These is a low priority app array to save a2dp priority and record priority. When device rcv a2dp stream status, multilink manager would compare this link music priority with left index and get a music compare result. After comparing, manager would start audio track due to index 0 device if index0 device has changed in compare process.</p>
<p>The entrance api of rcv a2dp stream status: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_music_priority_rearrangment(uint8_t index, <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#ga8592a68bedc14473e77cdd505f77db42">T_APP_JUDGE_A2DP_EVENT</a> event)</div></div><!-- fragment --><p>a2dp status which multilink only handle four state: </p><div class="fragment"><div class="line"><a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a877508eb9e20609b2af4cb5d07a0c51f">JUDGE_EVENT_A2DP_CONNECTED</a></div><div class="line"><a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a0bd17e1fc4cebbe418842b4012473a8f">JUDGE_EVENT_A2DP_START</a></div><div class="line"><a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a9ac7fdbca0201cbb19c1b98054cd1ed5">JUDGE_EVENT_A2DP_DISC</a></div><div class="line"><a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42aa75018fb871a1441552f1997a4e2040a">JUDGE_EVENT_A2DP_STOP</a></div></div><!-- fragment --><p>Compare logical: </p><div class="fragment"><div class="line"><span class="comment">// 1: sec &gt; fir;</span></div><div class="line"><span class="comment">// 0: sec == fir</span></div><div class="line"><span class="comment">//-1: sec &lt; fir</span></div><div class="line">int8_t app_teams_multilink_compare_music_priority(uint8_t fir_index, uint8_t sec_index)</div><div class="line">{</div><div class="line">    <span class="comment">// playing music has highest priority</span></div><div class="line">    <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a0bd17e1fc4cebbe418842b4012473a8f">JUDGE_EVENT_A2DP_START</a> &amp;&amp;</div><div class="line">        app_teams_multilink_app_low_priority_mgr[fir_index].music_event != <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a0bd17e1fc4cebbe418842b4012473a8f">JUDGE_EVENT_A2DP_START</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">// disconnected a2dp profile has lowest priority</span></div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].music_event != <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a9ac7fdbca0201cbb19c1b98054cd1ed5">JUDGE_EVENT_A2DP_DISC</a> &amp;&amp;</div><div class="line">             app_teams_multilink_app_low_priority_mgr[fir_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a9ac7fdbca0201cbb19c1b98054cd1ed5">JUDGE_EVENT_A2DP_DISC</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">// profile connect and music stop has same priority</span></div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((app_teams_multilink_app_low_priority_mgr[sec_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42aa75018fb871a1441552f1997a4e2040a">JUDGE_EVENT_A2DP_STOP</a></div><div class="line">              &amp;&amp;</div><div class="line">              app_teams_multilink_app_low_priority_mgr[fir_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a877508eb9e20609b2af4cb5d07a0c51f">JUDGE_EVENT_A2DP_CONNECTED</a>) ||</div><div class="line">             (app_teams_multilink_app_low_priority_mgr[sec_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a877508eb9e20609b2af4cb5d07a0c51f">JUDGE_EVENT_A2DP_CONNECTED</a> &amp;&amp;</div><div class="line">              app_teams_multilink_app_low_priority_mgr[fir_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42aa75018fb871a1441552f1997a4e2040a">JUDGE_EVENT_A2DP_STOP</a>))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].music_event ==</div><div class="line">             app_teams_multilink_app_low_priority_mgr[fir_index].music_event)</div><div class="line">    {</div><div class="line">        <span class="comment">// if no voice, active music link can not be grab by other link, other link can grap</span></div><div class="line">        <span class="comment">// if voice is not idle, all music can grab</span></div><div class="line">        <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].music_event == <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a0bd17e1fc4cebbe418842b4012473a8f">JUDGE_EVENT_A2DP_START</a>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (fir_index || app_teams_call_status)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> 1;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Recorder_and_Recorder"></a>
6.3 recorder and recorder</h3>
<p>Recorder priority is managered by record status in multilink. These is a low priority app array to save a2dp priority and record priority. When device rcv sco connect or disconnect, multilink manager would map to recorder start or stop, then multilink manager compare this link recorder priority with left index and get a recorder compare result. After comparing, manager would start audio track due to index 0 device if index0 device has changed in compare process.</p>
<p>recorder status which multilink handle is two state: </p><div class="fragment"><div class="line"><span class="keyword">true</span>: recorder start</div><div class="line"><span class="keyword">false</span>: recorder stop</div></div><!-- fragment --><p>Compare logical: </p><div class="fragment"><div class="line"><span class="comment">// 1: sec &gt; fir;</span></div><div class="line"><span class="comment">// 0: sec == fir</span></div><div class="line"><span class="comment">//-1: sec &lt; fir</span></div><div class="line">int8_t app_teams_multilink_compare_record_priority(uint8_t fir_index, uint8_t sec_index)</div><div class="line">{</div><div class="line">    <span class="comment">// playing record &gt; other status</span></div><div class="line">    <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].record_status &amp;&amp;</div><div class="line">        !app_teams_multilink_app_low_priority_mgr[fir_index].record_status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].record_status ==</div><div class="line">             app_teams_multilink_app_low_priority_mgr[fir_index].record_status)</div><div class="line">    {</div><div class="line">        <span class="comment">// if no voice, active record link can not be grab by other link, other link can grap</span></div><div class="line">        <span class="comment">// if voice is not idle, all record can grab</span></div><div class="line">        <span class="keywordflow">if</span> (app_teams_multilink_app_low_priority_mgr[sec_index].record_status)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> ((fir_index || app_teams_call_status))</div><div class="line">            {</div><div class="line">                <span class="keywordflow">return</span> 1;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="A2dp_and_Record"></a>
6.4 A2dp and Record</h3>
<p>When get A2dp and Recorder compare result, multilink manager would compare these two results and other status, and get a finally result to check if sec link priority is higher than fir link priority in low priority app array. </p><div class="fragment"><div class="line"><span class="comment">// 1: sec &gt; fir;</span></div><div class="line"><span class="comment">// 0: sec == fir</span></div><div class="line"><span class="comment">//-1: sec &lt; fir</span></div><div class="line">int8_t app_teams_multilink_compare_app_low_priority_array_data(uint8_t fir_index, uint8_t sec_index)</div><div class="line">{</div><div class="line">    int8_t force_ret = 0;</div><div class="line">    int8_t music_ret = 0;</div><div class="line">    int8_t record_ret = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_teams_multilink_check_force_swap_action_condition(fir_index, sec_index, &amp;force_ret))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> force_ret;</div><div class="line">    }</div><div class="line"></div><div class="line">    music_ret = app_teams_multilink_compare_music_priority(fir_index, sec_index);</div><div class="line">    record_ret = app_teams_multilink_compare_record_priority(fir_index, sec_index);</div><div class="line"></div><div class="line">    <span class="comment">//music and record all priority of first device &gt; sec device</span></div><div class="line">    <span class="keywordflow">if</span> (music_ret == 1 &amp;&amp; record_ret == 1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">//music priority of first device &gt; sec device, but record priority not have swap and not swap effect</span></div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (music_ret == 1 &amp;&amp; record_ret == 0 &amp;&amp;</div><div class="line">             !app_teams_multilink_app_low_priority_mgr[fir_index].record_status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">//record priority of first device &gt; sec device, but music priority not have swap and not swap effect</span></div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (music_ret == 0 &amp;&amp; record_ret == 1 &amp;&amp;</div><div class="line">             (app_teams_multilink_app_low_priority_mgr[fir_index].music_event != <a class="code" href="group___a_p_p___m_u_l_t_i_l_i_n_k___exported___types.html#gga8592a68bedc14473e77cdd505f77db42a0bd17e1fc4cebbe418842b4012473a8f">JUDGE_EVENT_A2DP_START</a>))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (music_ret == 0 &amp;&amp; record_ret == 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> 0;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> -1;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Sco_and_A2dp_and_Recorder"></a>
6.5 Sco and A2dp and Recorder</h3>
<p>When device hfp status change from idle to non idle, music and recorder should stop, so multilink would do this and remember paused link which is stoped by device, after call finished, device should resume music and recorder, now only nbt host could trigger pause action, dongle and usb would not. Pause music: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_pause_music_link_stream(uint8_t index, uint8_t resume_fg)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (((index != multilink_usb_idx) &amp;&amp;</div><div class="line">         (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a087e2f6dc5d9eaf16961f3984f062df6">connected_profile</a> &amp; (<a class="code" href="group___a_p_p___l_i_n_k.html#gaad765ad29cb83f3abedb49901d855c3d">A2DP_PROFILE_MASK</a> | <a class="code" href="group___a_p_p___l_i_n_k.html#ga1216017b50a3d0ab20cfe5b97a808c13">AVRCP_PROFILE_MASK</a>)) &amp;&amp;</div><div class="line">         (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a6d3fcdb27200259acb89c561da584022">avrcp_play_status</a> == <a class="code" href="group___b_t___a_v_r_c_p.html#gga8e2e0b7ab9eac804f17ddf0368abf464a3ca654b9af586dd9bb5e2d4bad635b80">BT_AVRCP_PLAY_STATUS_PLAYING</a>)) ||</div><div class="line">        ((index == multilink_usb_idx) &amp;&amp; app_teams_multilink_check_usb_music_data_stream_running()))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (resume_fg)</div><div class="line">        {</div><div class="line">            teams_music_resume_mask |= 1 &lt;&lt; ((index == multilink_usb_idx) ? (APP_TEAMS_MAX_LINK_NUM - 1) :</div><div class="line">                                             index);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (index != multilink_usb_idx)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___b_t___a_v_r_c_p.html#ga4d945994677031f70199fc6f5fd9b50a">bt_avrcp_pause</a>(<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>);</div><div class="line">            <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a6d3fcdb27200259acb89c561da584022">avrcp_play_status</a> = <a class="code" href="group___b_t___a_v_r_c_p.html#gga8e2e0b7ab9eac804f17ddf0368abf464a0021d468d3b51673670ad865d86728f4">BT_AVRCP_PLAY_STATUS_PAUSED</a>;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line"><span class="preprocessor">#if F_APP_USB_HID_SUPPORT</span></div><div class="line">            app_usb_mmi_handle_action(MMI_USB_AUDIO_PLAY_PAUSE);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span>;</div><div class="line">}</div></div><!-- fragment --><p>Pause recorder: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_pause_record_link_stream(uint8_t index, uint8_t resume_fg)</div><div class="line">{</div><div class="line">    T_APP_TEAMS_MULTILINK_APP_LOW_PRIORITY_ARRAY_DATA *record_data = <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">    record_data = app_teams_multilink_find_app_low_priority_array_data_by_link_idx(index);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (record_data-&gt;record_status)</div><div class="line">    {</div><div class="line">        app_teams_multilink_record_priority_rearrangment(index, <span class="keyword">false</span>);</div><div class="line">        <span class="comment">//stop sco handle for usb if active voice link is usb channel</span></div><div class="line">        <span class="keywordflow">if</span> (index != multilink_usb_idx)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_u_d_i_o___t_r_a_c_k.html#ga19c9971c30943546627a9355b893a82c">audio_track_stop</a>(<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a39f70e8221d4fc61cbd963ea158f5272">sco_track_handle</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line"><span class="preprocessor">#if F_APP_USB_AUDIO_SUPPORT</span></div><div class="line">            <a class="code" href="group___a_p_p___u_s_b___a_u_d_i_o.html#gaecf590baf4757a0221cede067851cf84">app_usb_audio_stop</a>(<a class="code" href="group___a_p_p___u_s_b___a_u_d_i_o.html#gace452a495153df1302d5ebc2fcbfd4a3">USB_AUDIO_SCENARIO_CAPTURE</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (resume_fg)</div><div class="line">        {</div><div class="line">            teams_record_resume_mask |= 1 &lt;&lt; ((index == multilink_usb_idx) ? (APP_TEAMS_MAX_LINK_NUM - 1) :</div><div class="line">                                              index);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>Resume handle include music and recorder is not worked in current sdk due to MS need, Follow description is only code implementation. Device would resume all paused link which stoped by device while no sco data channel. resume music: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_resume_music_link_stream(uint8_t index)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (teams_music_resume_mask)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (teams_music_resume_mask &amp; (uint8_t)(1 &lt;&lt; ((index == multilink_usb_idx) ?</div><div class="line">                                                      (APP_TEAMS_MAX_LINK_NUM - 1) : index)))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (index == multilink_usb_idx)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (!app_teams_multilink_check_usb_music_data_stream_running())</div><div class="line">                {</div><div class="line"><span class="preprocessor">#if F_APP_USB_HID_SUPPORT</span></div><div class="line">                    app_usb_mmi_handle_action(MMI_USB_AUDIO_PLAY_PAUSE);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> ((<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a087e2f6dc5d9eaf16961f3984f062df6">connected_profile</a> &amp;</div><div class="line">                     (<a class="code" href="group___a_p_p___l_i_n_k.html#gaad765ad29cb83f3abedb49901d855c3d">A2DP_PROFILE_MASK</a> |</div><div class="line">                      <a class="code" href="group___a_p_p___l_i_n_k.html#ga1216017b50a3d0ab20cfe5b97a808c13">AVRCP_PROFILE_MASK</a>)) &amp;&amp;</div><div class="line">                    (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a6d3fcdb27200259acb89c561da584022">avrcp_play_status</a> !=</div><div class="line">                     <a class="code" href="group___b_t___a_v_r_c_p.html#gga8e2e0b7ab9eac804f17ddf0368abf464a3ca654b9af586dd9bb5e2d4bad635b80">BT_AVRCP_PLAY_STATUS_PLAYING</a>))</div><div class="line">                {</div><div class="line">                    <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a6d3fcdb27200259acb89c561da584022">avrcp_play_status</a> = <a class="code" href="group___b_t___a_v_r_c_p.html#gga8e2e0b7ab9eac804f17ddf0368abf464a3ca654b9af586dd9bb5e2d4bad635b80">BT_AVRCP_PLAY_STATUS_PLAYING</a>;</div><div class="line">                    <a class="code" href="group___b_t___a_v_r_c_p.html#gaec1cd5aedeea03a16f6bd9dc8be3174d">bt_avrcp_play</a>(<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[index].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>);</div><div class="line">                }</div><div class="line">            }</div><div class="line"></div><div class="line">            teams_music_resume_mask &amp;= ~(uint8_t)(1 &lt;&lt; ((index == multilink_usb_idx) ?</div><div class="line">                                                        (APP_TEAMS_MAX_LINK_NUM - 1) : index));</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>resume recorder: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_resume_record_link_stream(uint8_t index)</div><div class="line">{</div><div class="line">    T_APP_TEAMS_MULTILINK_APP_LOW_PRIORITY_ARRAY_DATA *record_data = <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;</div><div class="line">    record_data = app_teams_multilink_find_app_low_priority_array_data_by_link_idx(index);</div><div class="line">    <span class="keywordflow">if</span> (teams_record_resume_mask &amp;&amp; record_data)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (teams_record_resume_mask &amp; (uint8_t)(1 &lt;&lt; ((index == multilink_usb_idx) ?</div><div class="line">                                                       (APP_TEAMS_MAX_LINK_NUM - 1) : index)))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (!record_data-&gt;record_status &amp;&amp; app_teams_multilink_check_recorder_resume_condition(index))</div><div class="line">            {</div><div class="line">                app_teams_multilink_record_priority_rearrangment(index, <span class="keyword">true</span>);</div><div class="line">            }</div><div class="line"></div><div class="line">            teams_record_resume_mask &amp;= ~(uint8_t)(1 &lt;&lt; ((index == multilink_usb_idx) ?</div><div class="line">                                                         (APP_TEAMS_MAX_LINK_NUM - 1) : index));</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Default_Multilink_Policy"></a>
6.6 Multilink Policy</h3>
<p>Now multilink has default policy which manager voice/music/record. </p><div class="image">
<img src="default_policy.jpg" alt="default_policy.jpg"/>
</div>
 <center><div id="figure_6_1"><b>Figure 6-1 Multilink policy</b></div></center><h3><a class="anchor" id="USB_channel"></a>
6.7 USB channel</h3>
<p>USB link is also scheduled in multilink manager, application is unit in schedule, but usb has no application, it only has upstream and downstream, so multilink manager would map data stream to application firstly. teams app would inform call status to device usb module, and usb module would map msg to bt four hfp status: </p><div class="fragment"><div class="line"><a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a6e4dbd4c6c100b2d903a4baf6c5057f3">BT_HFP_CALL_IDLE</a></div><div class="line">BT_HFP_INCOMING_CALL_ONGOING</div><div class="line">BT_HFP_OUTGOING_CALL_ONGOING</div><div class="line"><a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a85f0b0a1b3b00478808a5fcc21d9397a">BT_HFP_CALL_ACTIVE</a></div></div><!-- fragment --><p>usb map logic: 1). us &amp;&amp; ds &amp;&amp; BT_HFP_CALL_ACTIVE&ndash;&gt;call active. 2). ds &amp;&amp; (BT_HFP_INCOMING_CALL_ONGOING || BT_HFP_OUTGOING_CALL_ONGOING)&ndash;&gt;incoming call || outgoing call. 3). ds&ndash;&gt;music. 4). us&ndash;&gt;record.</p>
<p>Code is in follow api: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_multilink_handle_voice_single_event(uint8_t index, <a class="code" href="group___a_p_p___t_y_p_e_s___exported___types.html#ga3d780dc8f03a1ae7b864c1e2b62842a4">T_APP_CALL_STATUS</a> hfp_status)</div><div class="line"><span class="keywordtype">void</span> app_teams_multilink_update_usb_stream_status(T_APP_TEAMS_MULTILINK_USB_STREAM_STATUS_EVENT event)</div></div><!-- fragment --><h3><a class="anchor" id="Active_link_index"></a>
6.8 Active link index</h3>
<p>Device should has active link which is used by key module or led module and so on, so multilink manager should give one active link, logic of comparing link priority is follow point: 1). if device is in call status, the highest call priority link is active link. 2). If no call, the highest music or recorder priority link is active link. 3). if no call and music running, the newest ending music or call link is active link. 4). if no call and music ever, the newest connecting link is active link.</p>
<p>User could get active link index by follow api: </p><div class="fragment"><div class="line">uint8_t app_teams_multilink_get_active_index(<span class="keywordtype">void</span>)</div></div><!-- fragment --><h3><a class="anchor" id="Channel_Support_feature"></a>
6.9 Channel support feature</h3>
<div class="image">
<img src="channel_feature.jpg" alt="channel_feature.jpg"/>
</div>
 <center><div id="figure_6_2"><b>Figure 6-2 fearure support on channel</b></div></center><h3><a class="anchor" id="Notification"></a>
6.10 Notification</h3>
<p>If host has a notification, this behavior would not has effect for active index managerment, when notification end, the multilink active device should comeback to pre-active device. Define notification: the data stream is less than 5s, the duration could be set: </p><div class="fragment"><div class="line"><span class="preprocessor">#define APP_TEAMS_MULTILINK_NOTIFICATION_MAX_TIMEOUT  (5000) //5000mS</span></div></div><!-- fragment --><p> This notification function could enable or disable: </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_APP_TEAMS_MULTILINK_NOTIFICATION_FLAG     1    //teams multilink notification enable</span></div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="UI"></a>
7 UI</h2>
<h3><a class="anchor" id="Button"></a>
7.1 Button</h3>
<p>To support Push_to_Talk, mute button needs to be redeveloped. The mute button is only effective under a specific call status.After clicking the button, the mute operation will be performed according to the active device. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> ((app_teams_multilink_get_voice_status() &gt;= <a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a85f0b0a1b3b00478808a5fcc21d9397a">BT_HFP_CALL_ACTIVE</a>) ||</div><div class="line">    (app_teams_multilink_get_voice_status() == BT_HFP_VOICE_ACTIVATION_ONGOING) ||</div><div class="line">    (app_teams_multilink_get_voice_status() == <a class="code" href="group___b_t___h_f_p.html#gga71dc8535e88cd8ea60bdf8f574317841a6e4dbd4c6c100b2d903a4baf6c5057f3">BT_HFP_CALL_IDLE</a>))</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (key == MIC_MUTE_KEY_MASK)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___t_i_m_e_r.html#ga90e208220b403c1622f5fc92a216ad55">gap_start_timer</a>(&amp;timer_handle_key_mute_long_press, <span class="stringliteral">&quot;key_mute_unmute_long&quot;</span>,</div><div class="line">                        key_timer_queue_id,</div><div class="line">                        APP_IO_TIMER_KEY_MUTE_LONG_PRESS, key,</div><div class="line">                        MIC_KEY_LONG_PRESS_INTERVAL * KEY_TIMER_UNIT_MS);</div><div class="line">        mute_key_long_press = <span class="keyword">false</span>;</div><div class="line">        <span class="keywordflow">if</span> (app_teams_multilink_get_active_voice_index() == 0xff)</div><div class="line">        {</div><div class="line">            app_usb_mmi_handle_action(MMI_USB_TEAMS_MIC_MUTE_UNMUTE);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___m_m_i.html#ga052f779c9e19fc32946d63b132fcae09">app_mmi_handle_action</a>(<a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1bad540f4f8ee68a9fa380dbd270bc39534">MMI_DEV_MIC_MUTE_UNMUTE</a>);</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#ga5e7344b36c23f6033a95bb4e650b9fbc">app_audio_is_mic_mute</a>())</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga563d1e50b8b5cf766788f40a48e069c3">app_asp_device_send_mute_button_status</a>(1);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga563d1e50b8b5cf766788f40a48e069c3">app_asp_device_send_mute_button_status</a>(0);</div><div class="line">        }</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;key_check_press: Start mute toggle1&quot;</span>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>When mute button is released, the mute operation is performed again. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> ((key == MIC_MUTE_KEY_MASK) &amp;&amp; mute_key_long_press &amp;&amp; (!<a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#ga5e7344b36c23f6033a95bb4e650b9fbc">app_audio_is_mic_mute</a>()) &amp;&amp;</div><div class="line">    (app_teams_cmd_data.<a class="code" href="struct_t___t_e_a_m_s___c_m_d___d_a_t_a.html#a693ff5dbc198e6687efd49da2c2fb59d">teams_ptt_status</a> == 1))</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (app_teams_multilink_get_active_voice_index() == 0xff)</div><div class="line">    {</div><div class="line">        app_usb_mmi_handle_action(MMI_USB_TEAMS_MIC_MUTE_UNMUTE);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___m_m_i.html#ga052f779c9e19fc32946d63b132fcae09">app_mmi_handle_action</a>(<a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1bad540f4f8ee68a9fa380dbd270bc39534">MMI_DEV_MIC_MUTE_UNMUTE</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#ga5e7344b36c23f6033a95bb4e650b9fbc">app_audio_is_mic_mute</a>())</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga563d1e50b8b5cf766788f40a48e069c3">app_asp_device_send_mute_button_status</a>(1);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga563d1e50b8b5cf766788f40a48e069c3">app_asp_device_send_mute_button_status</a>(0);</div><div class="line">    }</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;key_check_press: Start mute toggle2&quot;</span>);</div><div class="line"></div><div class="line">}</div><div class="line"><span class="keywordflow">if</span> (key == MIC_MUTE_KEY_MASK)</div><div class="line">{</div><div class="line">    <a class="code" href="group___g_a_p___t_i_m_e_r.html#gac58204b6e5f306f768d84c4a2b02760e">gap_stop_timer</a>(&amp;timer_handle_key_mute_long_press);</div><div class="line">    mute_key_long_press = <span class="keyword">false</span>;</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;key_check_press: Release mute unmute key&quot;</span>);</div><div class="line">}</div></div><!-- fragment --><p>If a key is occupied by mute button, user should configure this key to "No define" on mcu config tool. </p><div class="image">
<img src="mute_button_config.png" alt="mute_button_config.png"/>
</div>
 <center><div id="figure_7_1"><b>Figure 7-1 Mute Button Config</b></div></center><h3><a class="anchor" id="Voice_prompt"></a>
7.2 Voice prompt</h3>
<p>To support more VP, user need to occupy some infrequent VP fields. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">     ....</div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a24b25f6a528768878bebc820bcc47a4c">TONE_CHARGE_NOW</a>,                    <span class="comment">//0x55</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a0e8f02e0704c75be160eb821b7865945">TONE_HOURS_LEFT_1</a>,                  <span class="comment">//0x56</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403abb27939eff9a4479bf61a5976edfe678">TONE_HOURS_LEFT_2</a>,                  <span class="comment">//0x57</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403aeceaa940275b8b8f65b2f6d7d2232726">TONE_HOURS_LEFT_3</a>,                  <span class="comment">//0x58</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a00efb1d251c8fde6401ca8cd85eaae45">TONE_HOURS_LEFT_4</a>,                  <span class="comment">//0x59</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a2bb2fb546911837a3cae323a5e8cef3c">TONE_HOURS_LEFT_5</a>,                  <span class="comment">//0x5A</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a001aec5b7afbfc5d4aec352a9e447f9a">TONE_HOURS_LEFT_6</a>,                  <span class="comment">//0x5B</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403aec872a8b98400cb826553598ccd183cb">TONE_HOURS_LEFT_15</a>,                 <span class="comment">//0x5C</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a9c4da83e6fcce1090fa8f6975c172340">TONE_HOURS_LEFT_30</a>,                 <span class="comment">//0x5D</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403acf63e8d73f005b033fc487a71980cd6c">TONE_ERROR</a>,                         <span class="comment">//0x5E</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403af4c36a15508cc977a624053b18f5e006">TONE_AUDIO_EQ_0</a>,                    <span class="comment">//0x55</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a5d9dcfbeab66c4a42658584697332f1a">TONE_AUDIO_EQ_1</a>,                    <span class="comment">//0x56</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a2544bfbec172f17b3d5bd17450646a64">TONE_AUDIO_EQ_2</a>,                    <span class="comment">//0x57</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a15ed2c156ffc0a9a39c31788fe90b66b">TONE_AUDIO_EQ_3</a>,                    <span class="comment">//0x58</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403ac3457e4e0e462492dd768e3d976d467a">TONE_AUDIO_EQ_4</a>,                    <span class="comment">//0x59</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a3dff24a8d2a3bc2cc5c46982782d0733">TONE_AUDIO_EQ_5</a>,                    <span class="comment">//0x5A</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403afb8768f85bd9ed5b576515449ddf1268">TONE_AUDIO_EQ_6</a>,                    <span class="comment">//0x5B</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403af9a7342820717d4309ec8804a3d71087">TONE_AUDIO_EQ_7</a>,                    <span class="comment">//0x5C</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403afe7cf8f325a009bc2f1d50abf388a4b5">TONE_AUDIO_EQ_8</a>,                    <span class="comment">//0x5D</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a6a1a516727e3e2b61fe427f090f62b92">TONE_AUDIO_EQ_9</a>,                    <span class="comment">//0x5E</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403aadde1f5c0c46f73b8917962e8990b665">TONE_CONNECTED</a>,                     <span class="comment">//0x61</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403ab7629dfb39f9e044c36857783f1834ac">TONE_CONNECTED_TO_PHONE</a>,            <span class="comment">//0x62</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403ad03917bb4266b38f72209630905c1a7f">TONE_CONNECTED_TO_COMPUTER</a>,         <span class="comment">//0x63</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a8e1c87e63c335d2ab48c45a3b701bc74">TONE_CONNECTED_TO_USB_LINK</a>,         <span class="comment">//0x64</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a7e12b492539e50a3a307117814dc39d3">TONE_DISCONNECTED</a>,                  <span class="comment">//0x65</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a2ec3eb768dd916a35e1c54e15cab3cbf">TONE_DISCONNECTED_FROM_PHONE</a>,       <span class="comment">//0x66</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a1ac01353cfcccc2d7bb0eb2ed07bc7c6">TONE_DISCONNECTED_FROM_COMPUTER</a>,    <span class="comment">//0x67</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a87ddf614499d2a5f1661f6c275940fe1">TONE_DISCONNECTED_FROM_USB_LINK</a>,    <span class="comment">//0x68</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a207e251a3c8703c5c710f5e2f097b965">TONE_APT_EQ_0</a>,                      <span class="comment">//0x61</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a476880fbc4d4d12a4c6a38983ea40d19">TONE_APT_EQ_1</a>,                      <span class="comment">//0x62</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a4e327e345fe5231dea91c4e70657b607">TONE_APT_EQ_2</a>,                      <span class="comment">//0x63</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a18a27ab978d7a706301d36751546d9b4">TONE_APT_EQ_3</a>,                      <span class="comment">//0x64</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403ab08fbdd3599b99af08fbefab3fcb7664">TONE_APT_EQ_4</a>,                      <span class="comment">//0x65</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403ac3f00312a8095275af119221dde9b477">TONE_APT_EQ_5</a>,                      <span class="comment">//0x66</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a0bb9648734674eb8950464f90045f43f">TONE_APT_EQ_6</a>,                      <span class="comment">//0x67</span></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gga2ef56a924a54e335197b7d83d6a29403a22f0c3d0e6b2aaea565ad1d99b4a5d56">TONE_APT_EQ_7</a>,                      <span class="comment">//0x68</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">} T_APP_AUDIO_TONE_TYPE;</span></div></div><!-- fragment --><p>When device power on, it will play Remaining power, this code is in api: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_battery_vp_play(uint8_t power_on_bat)</div></div><!-- fragment --><p>It could set by mcu config tool: </p><div class="image">
<img src="VP_config_1.png" alt="VP_config_1.png"/>
</div>
 <center><div id="figure_7_2"><b>Figure 7-2 VP Config1</b></div></center><p>When device connected or disconnected, it will play device type, this code is in api: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_connected_state_vp_play(uint8_t *bd_addr, uint8_t is_new_device)</div><div class="line"><span class="keywordtype">void</span> app_teams_disconnected_state_vp_play(uint8_t *bd_addr)</div></div><!-- fragment --><p>It could set by mcu config tool: </p><div class="image">
<img src="VP_config_2.png" alt="VP_config_2.png"/>
</div>
 <center><div id="figure_7_3"><b>Figure 7-3 VP Config2</b></div></center><h3><a class="anchor" id="LED"></a>
7.3 LED</h3>
<p>HW controlled LED can't meet the needs of teams scene. Therefore, the SW controlled LED must be extended. </p><div class="fragment"><div class="line"><span class="preprocessor">#define LED_TEAMS_NUM   2 //MAX: 6 LED</span></div><div class="line"><span class="preprocessor">#define LED_OUT_0       P1_6</span></div><div class="line"><span class="preprocessor">#define LED_OUT_1       P1_7</span></div></div><!-- fragment --><p>After configure the SW led, user can control the extended led through the api: </p><div class="fragment"><div class="line"><span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="group___l_e_d___m_o_d_u_l_e___exported___types.html#ga958de1de07ccc2886c37a4c701a31410">teams_extend_led_set_mode</a>(<a class="code" href="group___l_e_d___m_o_d_u_l_e___exported___types.html#gaf0afefda5cc221a8e99b9a716957cb85">T_TEAMS_LED_MODE</a> mode);</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="MTE_Command"></a>
8 MTE Command</h2>
<p>When device connected, HidTestTool can send commands to devices, Commands receive code is in api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_hid_handle_config_report(uint8_t report_id, <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga57cb5c67f243d7b634c973f329703a30">T_APP_TEAMS_HID_REPORT_SOURCE</a> source_type,</div><div class="line">                                  <a class="code" href="union_t___a_p_p___t_e_a_m_s___h_i_d___d_a_t_a.html">T_APP_TEAMS_HID_DATA</a> *p_hid_data)</div></div><!-- fragment --><p>Command handle code is in api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_handle_cmd(uint8_t *bd_addr, uint8_t report_id, uint8_t report_type,</div><div class="line">                          <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga0873414f4548f1adfec1f0d784304754">T_APP_TEAMS_HID_REPORT_ACTION_TYPE</a> report_action,</div><div class="line">                          <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga57cb5c67f243d7b634c973f329703a30">T_APP_TEAMS_HID_REPORT_SOURCE</a> report_source,</div><div class="line">                          uint16_t len, uint8_t *data)</div></div><!-- fragment --><p>Command response code is in api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_teams_send_response_data(uint8_t *bd_addr, uint8_t report_id, uint8_t report_type,</div><div class="line">                                  <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga0873414f4548f1adfec1f0d784304754">T_APP_TEAMS_HID_REPORT_ACTION_TYPE</a> report_action,</div><div class="line">                                  <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga57cb5c67f243d7b634c973f329703a30">T_APP_TEAMS_HID_REPORT_SOURCE</a> report_source,</div><div class="line">                                  uint16_t len, uint8_t *data)</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
