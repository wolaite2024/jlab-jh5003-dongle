<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="DlpsPage"></a>
Low Power Mode User Manual   </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.9</b></center><p><br />
 </p><center><b>2023/06/25</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Dlps_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2021/12/02  </td><td class="markdownTableBodyCenter">Add rtl87x3d support   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.2  </td><td class="markdownTableBodyCenter">2022/08/18  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.3  </td><td class="markdownTableBodyCenter">2022/09/21  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.4  </td><td class="markdownTableBodyCenter">2023/02/28  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.5  </td><td class="markdownTableBodyCenter">2023/03/14  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.6  </td><td class="markdownTableBodyCenter">2023/03/24  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.7  </td><td class="markdownTableBodyCenter">2023/04/11  </td><td class="markdownTableBodyCenter">Normal Update   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.8  </td><td class="markdownTableBodyCenter">2023/05/23  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.9  </td><td class="markdownTableBodyCenter">2023/06/25  </td><td class="markdownTableBodyCenter">Change power off mode to ship mode   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#Dlps_Rev">Revision History</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#Dlps_Table_List">Table List</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#Dlps_Figure_List">Figure List</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#Dlps_Glossary">Glossary</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#Low_Power_Overview">1 Overview</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#LowPowerMode">2 Low Power Mode</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#PowerModeBriefIntro">2.1 Power Mode Brief Introduction</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#PlatformLowPower">2.1.1 Platform Low Power Mode</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#BTMACLowPower">2.1.2 BT MAC Low Power Mode</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#PowerManagerIntro">3 Power Manager Introduction</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#EnterDLPS">3.1 Enter DLPS</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#DLPSEntryFlow">3.1.1 DLPS Mode Entry Flow</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#EnterLowPowerConditions">3.1.2 Conditions For System To Enter Low Power Mode</a></li>
</ul>
</li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ExitDLPS">3.2 Exit DLPS</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#DLPSExitFlow">3.2.1 DLPS Exit Flow</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#PowerModeExitCondition">3.2.2 Conditions For Exiting From Low Power Mode</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#LowPowerApplication">4 How To Add Low Power Mode Support In Application</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ConfigurePowerMode">4.1 Configure Power Mode</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#LowPowerStage">4.2 Register Callback To Power Stage</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#IOUsageInPowerMode">4.3 IO Usage In Low Power Mode</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#UseWakeUpPin">4.3.1 Use Wakeup Pin</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#PADAON">4.3.2 PAD (AON)</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#GPIOKey">4.3.3 GPIO Key</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#MFB">4.3.4 MFB</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ADP">4.3.5 ADP</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#RTCInterrupt">4.3.6 RTC interrupt</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#CapTouch">4.3.7 CapTouch</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#DMARecovery">4.3.8 DMA Recovery</a></li>
</ul>
</li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ApplicationSampleCode">4.4 Application Sample Code</a></li>
</ul>
</li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#DlpsTroubleShooting">5 TroubleShooting</a><ul>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#EnterIssue">5.1 Entering Issue</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#CannotExitDlps">5.2 Cannot Exit DLPS</a></li>
<li><a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#UnexpectedWakeup">5.3 Unexpected Wakeup</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Dlps_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_2_1">Table 2-1 The peripheral power domain of rtl87x3e</a></li>
<li><a href="#table_2_2">Table 2-2 The peripheral power domain of rtl87x3d</a></li>
<li><a href="#table_2_3">Table 2-3 All the power domain behaviors</a></li>
<li><a href="#table_2_4">Table 2-4 Times for entering and exiting low power mode</a></li>
<li><a href="#table_5_1">Table 5-1 BT MAC Error code for low power mode</a></li>
<li><a href="#table_5_2">Table 5-2 Platform Error code for low power mode</a></li>
<li><a href="#table_5_3">Table 5-3 Wake up reason for rtl87x3e</a></li>
<li><a href="#table_5_4">Table 5-4 Wake up reason for rtl87x3d</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Dlps_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 AON_CLK Selected In Mcu Config Tool</a></li>
<li><a href="#figure_3_1">Figure 3-1 DLPS Enter Flow</a></li>
<li><a href="#figure_3_2">Figure 3-2 DLPS Restore Flow</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Dlps_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">DLPS  </td><td class="markdownTableBodyCenter">Deep Low Power State   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">PON  </td><td class="markdownTableBodyCenter">Partial ON   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">AON  </td><td class="markdownTableBodyCenter">Always ON   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">DPD  </td><td class="markdownTableBodyCenter">Deep Power Down   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Low_Power_Overview"></a>
1 Overview</h2>
<p>Low power mode : involves putting the device into a low-power state when it is not in use. In this state, the device consumes less power, but can quickly wake up and resume full functionality when needed. while most components such as Clock, CPU, Peripherals and RAM could be powered off to reduce system power consumption. For example, DLPS is one kind of low power mode. This article will introduce different low power mode, power manager, how to add low power mode support in application and DLPS troubleshooting.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="LowPowerMode"></a>
2 Low Power Mode</h2>
<p>For all ICs supports two power units which can enter low power mode: System platform, and BT MAC. The two unit is inherent in hardware power architecture. System platform supports five power modes: Ship, Power Down, DLPS(Deep Low Power State), LPS PFM, and active mode. And BT MAC support two power mode: Deep Sleep Mode and Active Mode.</p>
<p>This section describes these low power modes in detail.</p>
<h3><a class="anchor" id="PowerModeBriefIntro"></a>
2.1 Power Mode Brief Introduction</h3>
<h4><a class="anchor" id="PlatformLowPower"></a>
2.1.1 Platform Low Power Mode</h4>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.1.1 Platform Power Domain Introduction</h5>
<p>The system has four types of power domain, which is listed as: Core domain, PON(Partial ON) Domain, AON(always on) Domain, DPD(Deep Power Down) Domain.</p><ul>
<li>DPD Domain, which is the system's most fundamental domain, is active when the system is turned on. It has the modules required to bring the system out of low power mode.</li>
<li>AON Domain provides the power for AON Finite State Machine to control the clocks and power trails.</li>
<li>PON Domain supplies power to SRAM, some of the hardware modules for retention, and the BT MAC when it is in DLPS mode.</li>
<li>Core Domain supplies power for CPU and peripheral digital circuit.</li>
</ul>
<div style="page-break-after: always;"></div><p>Table 2-1 list the peripheral power domain of rtl87x3e. </p><center><div id="table_2_1"><b>Table 2-1 The peripheral power domain of rtl87x3e</b></div></center> <table class="doxtable">
<tr>
<th colspan="1"></th><th align="center">Core Domain  </th><th align="center">PON Domain  </th><th align="center">AON Domain   </th></tr>
<tr>
<td align="center" rowspan="1">GDMA </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">GPIO </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">I2C </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">IR </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">KEYSCAN </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">QDEC </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">ADC </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">CapTouch </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">SLEEP LED </td><td align="center" rowspan="1"></td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">RTC </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td><td align="center" rowspan="1">O   </td></tr>
<tr>
<td align="center" rowspan="1">SPI </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">TIM/PWM </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">UART </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">I2S </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
</table>
<p>Table 2-2 list the peripheral power domain of rtl87x3d. </p><center><div id="table_2_1"><b>Table 2-2 The peripheral power domain of rtl87x3d</b></div></center> <table class="doxtable">
<tr>
<th colspan="1"></th><th align="center">Core Domain  </th><th align="center">PON Domain  </th><th align="center">AON Domain   </th></tr>
<tr>
<td align="center" rowspan="1">GDMA </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">GPIO </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">I2C </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">IR </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">KEYSCAN </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">QDEC </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">ADC </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">SLEEP LED </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td><td align="center" rowspan="1">O   </td></tr>
<tr>
<td align="center" rowspan="1">RTC </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td><td align="center" rowspan="1">O   </td></tr>
<tr>
<td align="center" rowspan="1">SPI </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">TIM/PWM </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">UART </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
<tr>
<td align="center" rowspan="1">I2S </td><td align="center" rowspan="1">O  </td><td align="center" rowspan="1"></td><td align="center" rowspan="1"></td></tr>
</table>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.1.2 System Platform Support The Following Power Mode. Sorted By The Power Consumption.</h5>
<ul>
<li><b>ACTIVE Mode</b><ul>
<li>All power domains are on.</li>
<li>The system is running.</li>
</ul>
</li>
<li><b>DLPS Mode</b><ul>
<li>DPD Domain, AON Domain, PON domain is powered on. Core Domain is powered off.</li>
<li>SRAM and part of hw register can be retained automatically.</li>
<li>For the rtl87x3d, ANC and SPORT can work in DLPS mode.</li>
<li>The restore process will run when the system wakes up from DLPS mode, and recovery time will be quicker than when the system reboot.</li>
<li>In DLPS mode, system can be waken up by OS scheduler(software timer/delay task), BT MAC, RTC, PAD, MFB, ADP, CapTouch, etc.</li>
</ul>
</li>
<li><b>Power Down Mode</b><ul>
<li>DPD Domain and AON Domain is powered on. PON and Core Domain is powered off.</li>
<li>SRAM will be powered off. HW settings could not be backed up.</li>
<li>System will perform reboot flow when waken up from Power Down Mode. The wake up time is longer than DLPS mode.</li>
<li>In Power Down Mode, system can be waken up by Pad, Function Button(MFB), Adapter, RTC, CapTouch.</li>
</ul>
</li>
<li><b>Ship Off Mode</b><ul>
<li>AON Domain will be reset to default value in ship mode such as CPU clock source/frequency.</li>
<li>It will take some time when recover from ship mode for it will perform the whole reboot flow.</li>
<li>In ship Mode, system can only be waken up by Main Function Button(MFB) and Adapter.</li>
</ul>
</li>
</ul>
<p>Table 2-3 list all the power domain behaviors. </p><center><div id="table_2_3"><b>Table 2-3 All the power domain behaviors</b></div></center> <table class="doxtable">
<tr>
<th colspan="2"></th><th align="center">Ship  </th><th align="center">Power Down  </th><th align="center">DLPS  </th><th align="center">ACTIVE   </th></tr>
<tr>
<td align="center" rowspan="2">Core Domain </td><td align="center">CPU  </td><td align="center" rowspan="2">X  </td><td align="center" rowspan="2">X  </td><td align="center" rowspan="2">X  </td><td align="center" rowspan="2">O   </td></tr>
<tr>
<td align="center">Peripheral   </td></tr>
<tr>
<td align="center" rowspan="2">PON Domain </td><td align="center">BT MAC  </td><td align="center" rowspan="2">X  </td><td align="center" rowspan="2">X  </td><td align="center" rowspan="2">O  </td><td align="center" rowspan="2">O   </td></tr>
<tr>
<td align="center">Retention   </td></tr>
<tr>
<td align="center" rowspan="3">AON Domain </td><td align="center">AON REG  </td><td align="center" rowspan="3">X  </td><td align="center" rowspan="3">O  </td><td align="center" rowspan="3">O  </td><td align="center" rowspan="3">O   </td></tr>
<tr>
<td align="center">RTC   </td></tr>
<tr>
<td align="center">PAD   </td></tr>
<tr>
<td align="center" rowspan="2">DPD Domain </td><td align="center">ADP  </td><td align="center" rowspan="3">O  </td><td align="center" rowspan="3">O  </td><td align="center" rowspan="3">O  </td><td align="center" rowspan="3">O   </td></tr>
<tr>
<td align="center">MFB   </td></tr>
</table>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.1.3 Feartures</h5>
<ul>
<li>System will only enter DLPS/Power down/Ship mode when BT Mac is in Deep Sleep Mode.</li>
<li>Low power mode needs to be turned off while using Keil for online debugging because turning off the CPU will cause the SWD to disconnect.</li>
<li>Power-off of non-retention RAM would cause data loss in DLPS mode, and only data in retention RAM would be retained.</li>
<li>If some variables stored in non-retention RAM need to be retained in DLPS mode, they must be registered to system so that they can be saved to Buffer RAM when entering DLPS mode and recovered after exiting from DLPS mode.</li>
<li>To wake the system up from DLPS mode, the duration of PAD/MFB/ADP wake up pulse must be longer than 2T of AON CLK. The clock source of AON CLK can be selected in MCUConfigTool.</li>
<li>To wake the system up from Power Down mode, the duration of PAD/MFB/ADP wake up pulse must be longer than 2T of AON CLK when the 32K of AON CLK is on in Power Down mode. For more details about AON clock selecting, please refer to figure 1.</li>
<li>When the 32K of AON_CLK is turned off in Power down mode, system can be wake up by short pulse.</li>
</ul>
<div class="image">
<img src="Select_AON_CLK.JPG" alt="Select_AON_CLK.JPG"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 AON_CLK Selected In Mcu Config Tool</b></div></center><p>The times listed in Table 2-4 for entering and exiting low power mode. </p><center><div id="table_2_4"><b>Table 2-4 Times for entering and exiting low power mode</b></div></center> <table class="doxtable">
<tr>
<th colspan="2"></th><th align="center">Ship  </th><th align="center">Power Down  </th><th align="center">DLPS   </th></tr>
<tr>
<td align="center" rowspan="2">rtl87x3e </td><td align="center">enter(ms)  </td><td align="center">&lt; 1.5  </td><td align="center">&lt; 1  </td><td align="center">&lt; 5   </td></tr>
<tr>
<td align="center">exit(ms)  </td><td align="center">&lt; 420  </td><td align="center">&lt; 350  </td><td align="center">&lt; 7.2   </td></tr>
<tr>
<td align="center" rowspan="2">rtl87x3d </td><td align="center">enter(ms)  </td><td align="center">&lt; 3  </td><td align="center">&lt; 3  </td><td align="center">&lt; 6.5   </td></tr>
<tr>
<td align="center">exit(ms)  </td><td align="center">&lt; 780  </td><td align="center">&lt; 440  </td><td align="center">&lt; 4.3   </td></tr>
</table>
<p><b>Note:</b> The wake up time is a bit long for rtl87x3d and may affect the limit of wake up time.</p>
<h4><a class="anchor" id="BTMACLowPower"></a>
2.1.2 BT MAC Low Power Mode</h4>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.2.1 BT MAC Support The Following Power Mode. Sorted By The Power Consumption</h5>
<ul>
<li><b>Active Mode</b><ul>
<li>BT MAC working functionally, all the registers can be accessed. The clock source is 10MHz.</li>
</ul>
</li>
<li><b>Deep Sleep Mode</b><ul>
<li>Low power saving mode.</li>
<li>BT MAC is working with clock source 32KHz.</li>
<li>Most of the registers can not be accessed.</li>
</ul>
</li>
</ul>
<p><a class="anchor" id="invalid"></a></p><h5>2.1.2.2 Feartures</h5>
<ul>
<li>Support BT to enter/exit Deep Sleep mode when System is in Active State.</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="PowerManagerIntro"></a>
3 Power Manager Introduction</h2>
<p>Most of the time, the system is in idle state and only necessary data needs to be retained for system recovery, while most components such as Clock, CPU, Peripherals and RAM could be powered off to reduce system power consumption. When there are any events to be handled, the system would exit from low power mode. Clock, CPU, BT, Peripherals and RAM would be re-powered on and recovered to a previous state before entering DLPS, and then respond to wake-up event. Power Manager operates hardware modules as different system level. Each system level contains different power manager unit. Each Power Manager Unit should implement the check/store/enter/exit/restore functions. <br />
 This section describes the power manager in detail.</p>
<h3><a class="anchor" id="EnterDLPS"></a>
3.1 Enter DLPS</h3>
<h4><a class="anchor" id="DLPSEntryFlow"></a>
3.1.1 DLPS Mode Entry Flow</h4>
<p>DLPS mode entry flow is shown below.</p>
<div class="image">
<img src="DLPS_Enter_flow.JPG" alt="DLPS_Enter_flow.JPG"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 DLPS Enter Flow</b></div></center><ul>
<li><b>Disable interrupt</b></li>
<li><b>Enter check</b><ul>
<li>Inquire each module whether low power mode is allowed to enter. If a module needs to be inquired before entering low power mode, it should first register callback function to power manager. When power manager calls the callback functions, each module would inform power manager whether to enter low power mode based on its own condition. Low power mode is unavailable unless all modules allow entering low power mode.</li>
<li>Inquire each Queue whether any data to be handled. If any, the system would not enter DLPS.</li>
</ul>
</li>
<li><b>Store buffer of non-retention RAM</b><ul>
<li>When entering DLPS mode, this is implemented by registering a buffer callback function to the DLPS Framework if data restored in RAM with no retention has to be maintained.</li>
</ul>
</li>
<li><b>Store peripheral registers</b><ul>
<li>When entering DLPS, the system would automatically perform the storage actions of peripherals. In addition, the necessary CPU register storage actions are also implemented in this callback function. More details are described in app sample.</li>
</ul>
</li>
<li><b>Enter low power mode</b></li>
</ul>
<h4><a class="anchor" id="EnterLowPowerConditions"></a>
3.1.2 Conditions For System To Enter Low Power Mode</h4>
<p><a class="anchor" id="invalid"></a></p><h5>3.1.2.1 Conditions For System To Enter DLPS Mode</h5>
<p>The system could enter DLPS mode when:</p><ul>
<li>CPU executes in idle task, when any other tasks are in block or suspend state and no ISR execution exists.</li>
<li>All OS queue messages have been handled.</li>
<li>BT allows to enter Deep Sleep Mode.<ul>
<li>BT Mac will enter Deep Sleep mode when next wake up instance is less than 30ms.</li>
<li>BT Mac will only enter Deep Sleep mode when in one of the following state and corresponding interval is set.<ul>
<li>Standby State.</li>
<li>BT Scan state, Page Scan/Inquiry Scan interval &gt; 30ms.</li>
<li>BT Sniff mode, sniff interval &gt; 30ms.</li>
<li>BLE Connection state, Connection interval * 1.25ms &gt; 30ms.</li>
<li>BLE Advertising state, Advertising interval*0.625ms &gt; 30ms.</li>
<li>BLE Scan state, (Scan Interval-Scan Window)*0.625ms &gt; 30ms.</li>
</ul>
</li>
</ul>
</li>
<li>All the DLPS check callback functions return true, which are registered by platform, peripherals and application.</li>
<li>Data, including Tasks' stack, that needs to be backed up is not larger than backup space.</li>
<li>Charger is not in charging state.</li>
<li>There are no high precision system timer is in active state.</li>
<li>HW timer is not configured to block the DLPS and the arrival time interval of the HW timer is longer than 30ms.</li>
</ul>
<p>The system would perform data and registers backup and IO setting before entering DLPS mode if all entry conditions were satisfied. <br />
 <b>Note:</b> Users can configure the HW timer to block DLPS by calling the following API: </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___h_w___t_i_m___exported___functions.html#gabe5b3a8ad9f40ee8e25ba5c902ca82a2">hw_timer_lpm_set</a>(<a class="code" href="group___h_w___t_i_m___exported___types.html#ga09f0eca4d24ba3eb999603118b8cab28">T_HW_TIMER_HANDLE</a> handle, <span class="keywordtype">bool</span> enable)</div></div><!-- fragment --><p><a class="anchor" id="invalid"></a></p><h5>3.1.2.2 Special Condition For Entering Power Down/Off Mode</h5>
<ol type="1">
<li>The above DLPS entering conditions are met.</li>
<li>There are no active software timer, for the callback functions can not be called in power down mode. <br />
 <b>Note:</b> The error code for being unable to enter power down mode due to software time is PLATFORM_PM_ERROR_WAKEUP_TIME. It is recommended that the customer take the initiative to close the timer started by each module when entering the power down mode. In addition, the customer can close the timer through the following API: <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_m___exported___functions.html#ga9b3679c83332b1fa2959f5af6c27ccf1">power_stop_all_non_excluded_timer</a>(<span class="keywordtype">void</span>)</div></div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="ExitDLPS"></a>
3.2 Exit DLPS</h3>
<h4><a class="anchor" id="DLPSExitFlow"></a>
3.2.1 DLPS Exit Flow</h4>
<p>DLPS mode exit flow is shown below.</p><ul>
<li>Power and Clock should be recovered by CPU.</li>
<li>The RAM and Flash are powered up.</li>
<li>Recover BT.</li>
<li>Go to APP callback to restore peripherals.</li>
</ul>
<div class="image">
<img src="DLPS_Restore_Flow.JPG" alt="DLPS_Restore_Flow.JPG"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 DLPS Restore Flow</b></div></center><ul>
<li><b>Reset Handler</b><ul>
<li>In reset handler, the reset reason will be detected. If system is power-on, it will perform First Boot flow. If system exits from DLPS mode, it will perform DLPS recovery flow.</li>
</ul>
</li>
<li><b>Restore Buffer in retention RAM</b><ul>
<li>DLPS Framework will transfer Buffer data in backup space to non-retention RAM where it is from.</li>
</ul>
</li>
<li><b>Return to Idle task</b><ol type="1">
<li>Configure System Tick interrupt.</li>
<li>Recover PSP based on the stack top pointer saved by Idle Task (the address upon creation of Idle Task).</li>
<li>Enable interrupt.</li>
<li>Jump to the starting location of idle task to schedule again.</li>
</ol>
</li>
</ul>
<h4><a class="anchor" id="PowerModeExitCondition"></a>
3.2.2 Conditions For Exiting From Low Power Mode</h4>
<p>One of the following occurrences would awaken the system, which must be set up before entering DLPS mode.</p>
<ul>
<li>MFB can be used in DLPS/Power down/Ship Mode, details refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#MFB">4.3.4 MFB</a>.</li>
<li>ADP can be used in DLPS/Power down/Ship Mode, details refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ADP">4.3.5 ADP</a>.</li>
<li>PAD wakeup signal can be used in DLPS/Power down Mode, details refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#UseWakeUpPin">4.3.1 Use Wakeup Pin</a>.</li>
<li>BT interrupt, which would be generated in the following scenarios, can only be used in DLPS Mode.<ul>
<li>Scan anchor arrives when BT is in scan state.</li>
<li>Advertising anchor arrives when BLE is in advertising state.</li>
<li>Connection event anchor arrives when BT connection is established.</li>
<li>Any BT event occurs, such as remote connection request or receiving data.</li>
</ul>
</li>
<li>RTC interrupt can be used in DLPS/Power down Mode, details refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#RTCInterrupt">4.3.6 RTC interrupt</a>.</li>
<li>Software timer can be used in DLPS Mode, when there are software timer expires and callback function to be called, or when there are delay task expires and need to be active state.</li>
<li>CapTouch can be used in DLPS/Power down Mode, details refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#CapTouch">4.3.7 CapTouch</a>.</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="LowPowerApplication"></a>
4 How To Add Low Power Mode Support In Application</h2>
<p>Power Manager is a modular and extensible power management architechture. It consists of stages such as check, store, enter, exit, and restore, as well as other operations that are registered to Power Manager for unified management at the APP boot. Users only need to determine whether current low power mode is appropriate based on the application situation that they want to use.</p>
<h3><a class="anchor" id="ConfigurePowerMode"></a>
4.1 Configure Power Mode</h3>
<p>Users can use the listed API to switch system to different power mode.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___p_m___exported___variables.html#ga973442724abf827f29d83a4b2f9369e2">BtPowerMode</a> mode);</div><div class="line">int32_t <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___p_m___exported___variables.html#ga9a2caa2eb06b399f0b06bc9a7efdb2dd">POWERMode</a> mode);</div></div><!-- fragment --><p> These two functions set the current low power mode and are frequently called when an application boots.When the conditions are met in <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#EnterLowPowerConditions">3.1.2 Conditions For System To Enter Low Power Mode</a>, the system will enter low power mode.</p>
<p>Examples: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line">    <a class="code" href="group___p_m___exported___functions.html#ga65794bb7e8e0c39831b412a3a6deb06d">bt_power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga973442724abf827f29d83a4b2f9369e2acc50404a0e14859034d4d8d7643e6977">BTPOWER_DEEP_SLEEP</a>);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga5f7eae66b8a91184eb95d7d2c4410569">enable_power_off_to_dlps_mode</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddafefe15dc6f9b2184fb58be2274d5bb4e">POWER_DLPS_MODE</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___p_m___exported___functions.html#ga50c3964a5b07d2caa9e9390d0fd9f7e9">power_mode_set</a>(<a class="code" href="group___h_a_l__87x3_d___p_m___exported___variables.html#gga9a2caa2eb06b399f0b06bc9a7efdb2ddad1007588ea3c18ce998c22e8411e5664">POWER_POWERDOWN_MODE</a>);</div><div class="line">        <span class="comment">//...</span></div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="LowPowerStage"></a>
4.2 Register Callback To Power Stage</h3>
<ul>
<li>For the BT Mac Deep Sleep mode. The stage is handled in the rom.</li>
<li>For the platform low power mode. It must be restricted or compatible with OS task functions. Additionally, each low power stage has a function API that applications can register to call, and the power manager would call these callback functions when entering and exiting low power mode. In order to minimize the influence on the time of exiting low power mode, it is recommended to register the function in the PLATFORM PM PEND stage after the platform and CPU are ready.</li>
</ul>
<p>Users can use the listed API to register callbacks to platform low power stage. </p><div class="fragment"><div class="line">int32_t <a class="code" href="group___p_m___exported___functions.html#ga3a07444bef9e5fd82b89e39eead826d1">power_stage_cb_register</a>(<a class="code" href="group___p_m___exported___variables.html#ga9e60f8b20a1c2e7e632b61d6933dd119">POWERStageFunc</a> func, <a class="code" href="group___p_m___exported___variables.html#ga00943c52b90d6b6403df35f103e59a36">POWERStage</a> stage);</div></div><!-- fragment --><p>IO store/restore is automatically through check IO clock is active, users could call the following API to initialize io store/restore and not need to care which io peripheral need specific deal except DMA. <br />
 <b>Note:</b> Operations for DMA can ref to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#DMARecovery">4.3.8 DMA Recovery</a>.</p>
<div class="fragment"><div class="line"><a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gaf680139850022547e4b26ce0be319480">io_dlps_register</a>();</div></div><!-- fragment --><p>If some operations need to be performed during entering or exiting from DLPS, user can add code that can be called in the following API, and io_dlps will automatically store and restore the opened modules .</p>
<p>Examples: </p><div class="fragment"><div class="line">1.  <span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga0b868bc1c1e607ec15933e2840e3e5e9">app_dlps_enter_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">2.  {</div><div class="line">3.      <span class="comment">/* do something here */</span></div><div class="line">4.  }</div><div class="line">5.</div><div class="line">6.  <span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">7.  {</div><div class="line">8.      <span class="comment">/* do something here */</span></div><div class="line">9.  }</div><div class="line">10.</div><div class="line">11. <a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gad91f8fc981de27a19f60153902a9de92">io_dlps_register_enter_cb</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga0b868bc1c1e607ec15933e2840e3e5e9">app_dlps_enter_callback</a>);</div><div class="line">12. <a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gaff879f31236e6fb7a89d7632d767a605">io_dlps_register_exit_cb</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>);</div></div><!-- fragment --><p> In the case above, <b><a class="el" href="group___a_p_p___d_l_p_s___exported___functions.html#ga0b868bc1c1e607ec15933e2840e3e5e9" title="Need to handle message in this callback function,when App enter dlps mode. ">app_dlps_enter_callback()</a></b> and <b><a class="el" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3" title="Need to handle message in this callback function,when App exit dlps mode. ">app_dlps_exit_callback()</a></b> will be executed while entering and exiting from DLPS respectively, and the application could implement some operations in the two function, such as PAD setting, or operation on peripherals.</p>
<h3><a class="anchor" id="IOUsageInPowerMode"></a>
4.3 IO Usage In Low Power Mode</h3>
<h4><a class="anchor" id="UseWakeUpPin"></a>
4.3.1 Use Wakeup Pin</h4>
<p>Some pins have the wake-up function in DLPS mode. Developer could refer to related hardware manual to get more details. Developer could call the following API to enable wake-up function of a pin. When the polarity of a signal on the pin is the same as the wake-up level, the system will wake up, and then recover from DLPS mode to Active mode. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#ga67b5fcc4a1755f3fb33439270ba01d72">System_WakeUpPinEnable</a>(uint8_t Pin_Num, uint8_t Polarity)</div></div><!-- fragment --><p> For example, if the low level of P3_2 could wake up system from DLPS mode. When signal on the pin becomes high level, the following configuration should be set. </p><div class="fragment"><div class="line"><a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#ga67b5fcc4a1755f3fb33439270ba01d72">System_WakeUpPinEnable</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#ga7060bd469f1a43b0d5c130d35f291687">P3_2</a>, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5e5f38a5052474acc16a2ca50bb9933c">PAD_WAKEUP_POL_LOW</a>);</div></div><!-- fragment --><h4><a class="anchor" id="PADAON"></a>
4.3.2 PAD (AON)</h4>
<p>PAD will not be powered off when entering DLPS, so storage is not required. However, in order to prevent electric leakage, PAD must be set as below when entering DLPS:</p><ol type="1">
<li>Unused Pin, including the function of Pin not enabled in IC, must be set as SW mode, Input mode, Pull Down or Pull Up. This part is handled automatically in the IO store.</li>
<li>Any used pin should be set based on external circuit.</li>
<li>Wakeup pin is set as (SW mode, Input mode), and PD/PU setting should be opposite to wake-up polarity.</li>
<li>Pins should be recovered to the original settings after exiting from DLPS.</li>
</ol>
<div style="page-break-after: always;"></div><p>Sample code: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> gpio_dlps_enter_callback(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Config PAD pull up */</span></div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga5dc743da772d45de3b610ecc73382c47">Pad_PullUpOrDownValue</a>(TEST_Pin, 1);</div><div class="line"></div><div class="line">    <span class="comment">/* set wakeup pin and polarity */</span></div><div class="line">    <a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#ga67b5fcc4a1755f3fb33439270ba01d72">System_WakeUpPinEnable</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5e5f38a5052474acc16a2ca50bb9933c">PAD_WAKEUP_POL_LOW</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gpio_dlps_exit_callback(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* recover PAD as PINMUX mode */</span></div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a8309999f45f91d480cb6fbb7082efbf3">PAD_PINMUX_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a2c46edbcf7e322cae25b4a64fc568bb8">PAD_OUT_HIGH</a>);</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="GPIOKey"></a>
4.3.3 GPIO Key</h4>
<p><a class="anchor" id="invalid"></a></p><h5>4.3.3.1 Key Trigger Detection</h5>
<p>When any key event occurs, the key signal wakes up the system from DLPS and then the system goes to the next process stage (Power On -&gt; Restore). When IO Restore is completed, GPIO circuit starts working and system will switch to idle task. However, when the debouncing circuit first operates in the GPIO module, and until the debouncing duration expires, there is no GPIO interrupt. During this course, idle task keeps checking whether entering DLPS mode is permitted, as the system will enter DLPS again once the conditions are met. But if this key signal continues, the system would be wlil up from DLPS mode. This process will continue till the key signal ends, but the system has not detected this key-pressing event.</p>
<p><a class="anchor" id="invalid"></a></p><h5>4.3.3.2 PAD Settings</h5>
<p>Before entering DLPS mode, Key pin could be set to Pull up/down(opposite to polarity value)</p>
<p><a class="el" href="group___i_o___d_l_p_s___exported___functions.html#gad91f8fc981de27a19f60153902a9de92" title="Rrgister user-defined enter dlps callback function. ">io_dlps_register_enter_cb()</a> and <a class="el" href="group___i_o___d_l_p_s___exported___functions.html#gaff879f31236e6fb7a89d7632d767a605" title="Rrgister user-defined exit dlps callback function. ">io_dlps_register_exit_cb()</a> could be used in <a class="el" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f" title="dlps module init. ">app_dlps_init()</a> to register the corresponding callback function, sample code can refer to <a class="el" href="_u_m010__l_o_w__p_o_w_e_r__m_o_d_e.html#ApplicationSampleCode">4.4 Application Sample Code</a>.</p>
<h4><a class="anchor" id="MFB"></a>
4.3.4 MFB</h4>
<p>MFB could be enabled to wake up system by calling the following API: </p><div class="fragment"><div class="line">uint8_t  <a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#gae77b52c9af420e7e34217b89e09773bd">Pad_WakeUpCmd</a>(<a class="code" href="group___w_a_k_e_u_p___e_n_a_b_l_e___m_o_d_e.html#gac7576c9fdc6418faa52ce7277031f031">WAKEUP_EN_MODE</a> mode, <a class="code" href="group___w_a_k_e_u_p___p_o_l_a_r_i_t_y.html#ga019ea923e77311a2a6702cd7e747dda6">WAKEUP_POL</a> pol, <a class="code" href="group__x3d___r_t_l876x___exported__types.html#gac9a7e9a35d2513ec15c3b537aaa4fba1">FunctionalState</a> NewState);</div></div><!-- fragment --><h4><a class="anchor" id="ADP"></a>
4.3.5 ADP</h4>
<p>Adapter could be enabled to wake up system by calling the following API: <br />
Enable ADP wake up function </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__x3d___h_a_l___a_d_p.html#gaf96bb00026665a5dae79ce7756cc9ce1">adp_wake_up_enable</a>(<a class="code" href="group___w_a_k_e___u_p___m_o_d_e.html#ga3976b46baab64fc43e535be361ee7380">T_WAKE_UP_MODE</a> mode, <a class="code" href="group___w_a_k_e_u_p___p_o_l_a_r_i_t_y.html#ga019ea923e77311a2a6702cd7e747dda6">WAKEUP_POL</a> pol);</div></div><!-- fragment --><p> Disable ADP wake up function </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__x3d___h_a_l___a_d_p.html#ga9118e30806f07225cebea1f456814c39">adp_wake_up_disable</a>(<a class="code" href="group___w_a_k_e___u_p___m_o_d_e.html#ga3976b46baab64fc43e535be361ee7380">T_WAKE_UP_MODE</a> mode);</div></div><!-- fragment --><h4><a class="anchor" id="RTCInterrupt"></a>
4.3.6 RTC interrupt</h4>
<p>RTC could be enabled to wake up system by calling the following API. </p><div class="fragment"><div class="line"><span class="comment">/* 32K must be on in Power Down mode when using the RTC wake up feature */</span></div><div class="line">pmu_set_clk_32k_power_in_powerdown(<span class="keyword">true</span>);</div><div class="line"><span class="comment">/* Enable the wake-up signal for the corresponding comparator */</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___r_t_c___exported___functions.html#ga49e7341a19d496a9ae5610bbc7797a8a">RTC_INTEnableConfig</a>(uint32_t RTC_INT, <a class="code" href="group__x3d___r_t_l876x___exported__types.html#gac9a7e9a35d2513ec15c3b537aaa4fba1">FunctionalState</a> NewState);</div><div class="line"><span class="comment">/* Enable the total wake up singal */</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___r_t_c___exported___functions.html#gad05087f04a4a19207bc0ff1e719fae14">RTC_SystemWakeupConfig</a>(<a class="code" href="group__x3d___r_t_l876x___exported__types.html#gac9a7e9a35d2513ec15c3b537aaa4fba1">FunctionalState</a> NewState);</div></div><!-- fragment --><p> <b>Note:</b> pmu_set_clk_32k_power_in_powerdown(true) is not required to be called in DLPS mode.</p>
<h4><a class="anchor" id="CapTouch"></a>
4.3.7 CapTouch</h4>
<p>CapTouch only support for rtl87x3e and could be enabled to wake up system by calling the following API. </p><div class="fragment"><div class="line"><span class="comment">/* 32K must be on in Power Down mode when using the CAPTouch wake up feature */</span></div><div class="line">pmu_set_clk_32k_power_in_powerdown(<span class="keyword">true</span>);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group__x3e___cap_touch___exported___functions.html#gad68fc2794e0a4278e8412a10258adbc7">CapTouch_ChWakeupCmd</a>(<a class="code" href="group__x3e___cap_touch___c_h_a_n_n_e_l.html#ga651bc98bd25487ae4355df09636c5dab">CTC_CH_TYPE</a> channel, <a class="code" href="group__x3d___r_t_l876x___exported__types.html#gac9a7e9a35d2513ec15c3b537aaa4fba1">FunctionalState</a> new_state);</div></div><!-- fragment --><p> <b>Note:</b> pmu_set_clk_32k_power_in_powerdown(true) is not required to be called in DLPS mode.</p>
<h4><a class="anchor" id="DMARecovery"></a>
4.3.8 DMA Recovery</h4>
<p>When exiting from DLPS mode, DMA should be reinitialized</p>
<p><a class="el" href="group___i_o___d_l_p_s___exported___functions.html#gaff879f31236e6fb7a89d7632d767a605" title="Rrgister user-defined exit dlps callback function. ">io_dlps_register_exit_cb()</a> could be used in <a class="el" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f" title="dlps module init. ">app_dlps_init()</a> to register the corresponding callback function. The details can refer to the demo code in sdk\src\sample\io_demo\dlps\dlps_gdma_recover_demo.c.</p>
<h3><a class="anchor" id="ApplicationSampleCode"></a>
4.4 Application Sample Code</h3>
<p>Use GPIO in low power mode as an example.</p>
<p>Sample code: </p><div class="fragment"><div class="line"><span class="comment">/* This function is gpio isr callback, place in ram */</span></div><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#gaf901ecfe15c401262a5dfd752a0b0287">ISR_TEXT_SECTION</a></div><div class="line"><span class="keywordtype">void</span> gpio_isr_cb(uint32_t context)</div><div class="line">{</div><div class="line">    uint8_t pin_index = (uint32_t)context;</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#gaad2a5fc083589d27cc58e3e2de7b932f">T_GPIO_LEVEL</a> gpio_level = <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga72f8dccebef04fca81c21d69ede70381">hal_gpio_get_input_level</a>(pin_index);</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment">/* This function executed in idle task, place in ram for power saving */</span></div><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#ga501017c9d06ffea48e92d5ed3757b9f5">RAM_TEXT_SECTION</a> <span class="keywordtype">bool</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gacad250b01d6c630f8d4fbdadae4c4a12">app_dlps_check_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaccbb50f7afd6ea87657c30a0bfa1bf26">enable_dlps</a>) &amp;&amp; (dlps_bitmap == 0))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga0b868bc1c1e607ec15933e2840e3e5e9">app_dlps_enter_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* change PAD as SW mode */</span></div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a63d53e3c9ddf88d4806c1f7aa539564c">PAD_SW_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a2c46edbcf7e322cae25b4a64fc568bb8">PAD_OUT_HIGH</a>);</div><div class="line"></div><div class="line">    <span class="comment">/* set wakeup pin and polarity */</span></div><div class="line">    <a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#ga67b5fcc4a1755f3fb33439270ba01d72">System_WakeUpPinEnable</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5e5f38a5052474acc16a2ca50bb9933c">PAD_WAKEUP_POL_LOW</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* recover PAD to pinmux mode */</span></div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a8309999f45f91d480cb6fbb7082efbf3">PAD_PINMUX_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a2c46edbcf7e322cae25b4a64fc568bb8">PAD_OUT_HIGH</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga631663f36376f69f38f75935d6a436a4">System_WakeUpInterruptValue</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>) == <a class="code" href="group__x3e___r_t_l876x___exported__types.html#gga89136caac2e14c55151f527ac02daaffab44c8101cc294c074709ec1b14211792">SET</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* recall gpio interrupte handler for enter dlps IO interrupt lose*/</span></div><div class="line">        gpio_isr_cb(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>);</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="comment">/* Register inquiry callback function to DLPS Framework, and this function will be called each</span></div><div class="line"><span class="comment">       time before entering DLPS to decide whether DLPS is allowed to enter.</span></div><div class="line"><span class="comment">       DLPS would be disallowed if any inquiry callback function returns FALSE. */</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___p_m___exported___functions.html#ga05d2d76fcef72ca3e9eeec23e095b185">power_check_cb_register</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gacad250b01d6c630f8d4fbdadae4c4a12">app_dlps_check_callback</a>) == <span class="keyword">false</span>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;app_dlps_init: dlps_check_cb_reg failed&quot;</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* The callback function is used to save generic peripheral registers when entering DLPS mode.</span></div><div class="line"><span class="comment">    The storage actions of app-specific peripherals need to be encapsulated into function and registered through this API */</span></div><div class="line">    <a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gad91f8fc981de27a19f60153902a9de92">io_dlps_register_enter_cb</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga0b868bc1c1e607ec15933e2840e3e5e9">app_dlps_enter_callback</a>);</div><div class="line"></div><div class="line">    <span class="comment">/* The callback function is used to recover generic peripheral registers when exiting from DLPS and to process App-specific peripheral recovery.</span></div><div class="line"><span class="comment">      The recovery actions of app-specific peripheral need to be encapsulated into function and registered through this API. */</span></div><div class="line">    <a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gaff879f31236e6fb7a89d7632d767a605">io_dlps_register_exit_cb</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> gpio_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#gab5ae6f712980fbf6f16ecb6dc8ae1a36">hal_gpio_init</a>();</div><div class="line">    <a class="code" href="group__x3d___g_p_i_o___i_n_t___h__.html#ga960816c8e05cc820f66af432bc6de7ad">hal_gpio_int_init</a>();</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#gae5cfebfbc696e4b26c22a682a2bab5e5">hal_gpio_set_debounce_time</a>(30);</div><div class="line"></div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga3826ae3324dab5d23192d2101f2cab3b">hal_gpio_init_pin</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga18690463b43fb88963baf1098b54f075af9c945172bdc28d142ed7e79af279f32">GPIO_TYPE_AUTO</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga83e087b95bdbbc7626f48a407120b429a3f9cca83af864e65a125bb363f5cc1a6">GPIO_DIR_INPUT</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#ggac9b234191aefcbffa9f5cbfcb67ba911ae7d1b2a9078939dd744dd9a7cd61d9df">GPIO_PULL_UP</a>);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga33877bb6f864bf13365d530ea498f829">hal_gpio_set_up_irq</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#ggaf9fd97f2ddde04dd3ae2a54dbc0f27f7a2636d7c0a40a6aa62fdeab06e5343914">GPIO_IRQ_EDGE</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga73aa619532bdbf9d2b620ec419641690ad67ef08eb10e464490335f1267f5d61b">GPIO_IRQ_ACTIVE_LOW</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group__x3d___g_p_i_o___i_n_t___h__.html#ga986785a267647c840ad807c08dffa9c9">hal_gpio_register_isr_callback</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>, gpio_isr_cb, <a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#gaae922b7d64d09b96637d21715a386260">hal_gpio_irq_enable</a>(<a class="code" href="group__x3d___r_t_l876_x___pin___number.html#gaaae6a77f4b93ec74cb11947217dd8fd1">P2_1</a>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_main(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* Example for GPIO used in low power mode */</span></div><div class="line">    gpio_init();</div><div class="line"></div><div class="line">    <span class="comment">/* Low power mode init */</span></div><div class="line">    <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>();</div><div class="line">}</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="DlpsTroubleShooting"></a>
5 TroubleShooting</h2>
<h3><a class="anchor" id="EnterIssue"></a>
5.1 Entering Issue</h3>
<p>Reading the error code is the quickest approach for determining why low power mode cannot be entered. The error code list for each module that implements the enter check functions should be the corresponding. The appropriate error code must be recorded when the enter check functions determines that it cannot enter low power mode owing to specified circumstances.</p>
<div style="page-break-after: always;"></div><p>The system is got Error code about Platform and BT Mac, which are listed in the table 5-1 and table 5-2. </p><center><div id="table_5_1"><b>Table 5-1 BT MAC Error code for low power mode</b></div></center> <table class="doxtable">
<tr>
<th style="width:160">Power Unit  </th><th style="width:530px">Error Condition  </th><th style="width:110px">Error Code   </th></tr>
<tr>
<td rowspan="25">BT Mac Error code </td><td>BTMAC_POWERMODE_ERROR_NONE  </td><td>0x0   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_POWER_MODE  </td><td>0x1   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_LEGACY_SCAN  </td><td>0x2   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_ROLE_SWITCH  </td><td>0x3   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROE_BQB  </td><td>0x4   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_PSD  </td><td>0x5   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_CSB_ENABLE  </td><td>0x6   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_NOT_EMPTY_QUEUE_OF_LOWER </td><td>0x7   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_CONTROLLER_TO_HOST_BUSY  </td><td>0x8   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_TX_BUSY  </td><td>0x9   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_LEGACY_NOT_IDLE  </td><td>0xA   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_LE_REG_S_INST  </td><td>0xB   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_ADV_STATE_NOT_IDLE  </td><td>0xC   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_SCAN_STATE_NOT_IDLE  </td><td>0xD   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_INITIATOR_UNIT_ENABLE  </td><td>0xE   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_CHANNEL_MAP_UPDATE  </td><td>0xF   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_CONNECTION_UPDATE  </td><td>0x10   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_PHY_UPDATE  </td><td>0x11   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_CONN_STATE_NOT_IDLE  </td><td>0x12   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_LE_SCHE_NOT_READY  </td><td>0x13   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_INTERRUPT_PENDING  </td><td>0x14   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_WAKEUP_TIME  </td><td>0x15   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_32K_CHECK_LOCK  </td><td>0x16   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_HW_TIMER_RUNNING  </td><td>0x17   </td></tr>
<tr>
<td>BTMAC_POWERMODE_ERROR_LE_ISO_ACTIVE  </td><td>0x18   </td></tr>
</table>
<div style="page-break-after: always;"></div><center><div id="table_5_2"><b>Table 5-2 Platform Error code for low power mode</b></div></center> <table class="doxtable">
<tr>
<th style="width:160px">Power Unit  </th><th style="width:530px">Error Condition  </th><th style="width:110px">Error Code   </th></tr>
<tr>
<td rowspan="11">Platform Error code </td><td>PLATFORM_POWERMODE_ERROR_NONE  </td><td>0x0   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_POWER_MODE  </td><td>0x1   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_DISABLE_DLPS_TIME  </td><td>0x2   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_32K_CHECK_LOCK  </td><td>0x3   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_LOG_DMA_NOT_IDLE  </td><td>0x4   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_CALLBACK_CHECK  </td><td>0x5   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_INTERRUPT_OCCURRED  </td><td>0x6   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_WAKEUP_TIME  </td><td>0x7   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_FREE_BLOCK_STORE  </td><td>0x8   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_BUFFER_PRE_ALLOCATE  </td><td>0x9   </td></tr>
<tr>
<td>PLATFORM_POWERMODE_ERROR_DATA_UART  </td><td>0xa   </td></tr>
</table>
<p>Users can get error code by using the following API: <br />
Platform error code </p><div class="fragment"><div class="line"><a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___types.html#gaf2608c9316e1175690543547968d5dfe">T_PLATFORM_POWERMODE_ERROR_CODE</a>  <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#gab3a076df63e23e734d930190040cb0d6">dlps_util_get_platform_error_code</a>(<span class="keywordtype">void</span>);</div></div><!-- fragment --><p> BT Mac error code </p><div class="fragment"><div class="line"><a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___types.html#ga949b95bbb43c7539ff76db157fb1be61">T_BTMAC_POWERMODE_ERROR_CODE</a>  <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#gae682a74b5674e1e20badb740ece02f1d">dlps_util_get_btmac_error_code</a>(<span class="keywordtype">void</span>);</div></div><!-- fragment --><div style="page-break-after: always;"></div><p>Example code: Users can search for the log "(LPS) PlatformErrorCode: 0x%x, BTMACErrorCode: 0x%x." </p><div class="fragment"><div class="line">uint8_t timer_idx_profiling_dlps = 0;</div><div class="line">uint8_t app_dlps_timer_id = 0;</div><div class="line"></div><div class="line"><span class="preprocessor">#define APP_TIMER_PROFILING_DLPS    0x01</span></div><div class="line"><span class="preprocessor">#define PROFILING_DLPS_TIMER_MS     20*1000</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_dlps_timeout_cb(uint8_t timer_evt, uint16_t param)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (timer_evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> APP_TIMER_PROFILING_DLPS:</div><div class="line">        {</div><div class="line">            <a class="code" href="group__x3d___t_r_a_c_e.html#ga6d456e54c55b59abe01439d51242b934">TEST_PRINT_INFO2</a>(<span class="stringliteral">&quot;(LPS) PlatformErrorCode: 0x%x, BTMACErrorCode: 0x%x.&quot;</span>, <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#gab3a076df63e23e734d930190040cb0d6">dlps_util_get_platform_error_code</a>(), <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#gae682a74b5674e1e20badb740ece02f1d">dlps_util_get_btmac_error_code</a>());</div><div class="line">            <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga7e0ebc306e15dabba884fda9e981df9a">app_start_timer</a>(&amp;timer_idx_profiling_dlps, <span class="stringliteral">&quot;profiling_dlps&quot;</span>, app_dlps_timer_id,</div><div class="line">                            APP_TIMER_PROFILING_DLPS, 0, <span class="keyword">false</span>, PROFILING_DLPS_TIMER_MS);</div><div class="line"></div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga5d2a3ae9710b2036a2907647a1932f0f">app_timer_reg_cb</a>(app_dlps_timeout_cb, &amp;app_dlps_timer_id);</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga7e0ebc306e15dabba884fda9e981df9a">app_start_timer</a>(&amp;timer_idx_profiling_dlps, <span class="stringliteral">&quot;profiling_dlps&quot;</span>, app_dlps_timer_id, APP_TIMER_PROFILING_DLPS, 0, <span class="keyword">false</span>, PROFILING_DLPS_TIMER_MS);</div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga70501f054028d5dc07fa7477fa988581">app_timer_register_pm_excluded</a>(&amp;timer_idx_profiling_dlps);</div><div class="line"></div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="CannotExitDlps"></a>
5.2 Cannot Exit DLPS</h3>
<ol type="1">
<li>Check the wake up source is configured correctly, such as PAD, SW Timers, RTC, etc.</li>
<li>Check if the app exit callback is getting executed.</li>
</ol>
<h3><a class="anchor" id="UnexpectedWakeup"></a>
5.3 Unexpected Wakeup</h3>
<ul>
<li>Analyze whether it's an unexpected passive waking or an active wakeup.</li>
<li>First of all, there's no any active wake-up features in Power Down/Ship mode.</li>
<li>Check to see if the active wake-up was caused by an OS scheduling timeout or a BT Mac anchor.</li>
<li>It can be a PAD, RTC, MFB, or ADP when it is a passive wake up.</li>
<li>Checking the DLPS wake up reason can be done by calling the API dlps_utils_print_wake_up_info in <a class="el" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3" title="Need to handle message in this callback function,when App exit dlps mode. ">app_dlps_exit_callback()</a>.</li>
</ul>
<p>Sample code: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#gae047862b0a895be33005db8e9a751f39">dlps_utils_print_wake_up_info</a>();</div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">//...</span></div><div class="line"></div><div class="line">    <span class="comment">/* The callback function is used to recover generic peripheral registers when exiting from DLPS and to process App-specific peripheral recovery.</span></div><div class="line"><span class="comment">      The recovery actions of app-specific peripheral need to be encapsulated into function and registered through this API. */</span></div><div class="line">    <a class="code" href="group___i_o___d_l_p_s___exported___functions.html#gaff879f31236e6fb7a89d7632d767a605">io_dlps_register_exit_cb</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#gabd2edc2d67c7099b4b1076e617507cb3">app_dlps_exit_callback</a>);</div><div class="line">}</div></div><!-- fragment --><ul>
<li>Checking the Power Down wake up reason can be done by calling the API power_down_check_wake_up_reason at the start of app_main().</li>
</ul>
<p>Sample code: </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t wake_up_reason;</div><div class="line"></div><div class="line">    wake_up_reason = <a class="code" href="group___d_l_p_s___d_e_b_u_g___exported___functions.html#ga6403aa2333ef7e2624256d6a448b005f">power_down_check_wake_up_reason</a>();</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;power down wake_up_reason: 0x%x&quot;</span>, wake_up_reason);</div><div class="line">}</div></div><!-- fragment --><p> <b>Note:</b> The wake up reason is defined in <a class="el" href="dlps__util_8h_source.html">dlps_util.h</a>.</p>
<div style="page-break-after: always;"></div><center><div id="table_5_3"><b>Table 5-3 Wake up reason for rtl87x3e</b></div></center> <table class="doxtable">
<tr>
<th style="width:150px">Low power mode  </th><th style="width:350px">Wake Up Reason  </th><th style="width:50px">Code  </th><th style="width:150px">Description   </th></tr>
<tr>
<td rowspan="12">DLPS Wake Up <br />
Reason </td><td>PLATFORM_DLPS_WAKEUP_UNKNOWN  </td><td>0x0000  </td><td>Wake up reason <br />
unknown   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_USER  </td><td>0x0001  </td><td>User registered <br />
callback, such <br />
as HW Timer   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_OS  </td><td>0x0002  </td><td>OS timer or OS task wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_PRE_SYSTEM_LEVEL  </td><td>0x0003  </td><td>BT wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_PF_RTC  </td><td>0x0100  </td><td>PF RTC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_RTC  </td><td>0x0200  </td><td>RTC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_MAC  </td><td>0x0400  </td><td>MAC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_GPIO </td><td>0x0800  </td><td>GPIO wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_USB_RESUME  </td><td>0x1000  </td><td>USB wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_MFB  </td><td>0x2000  </td><td>MFB wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_POW  </td><td>0x4000  </td><td>Adapter wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_CTC  </td><td>0x8000  </td><td>CapTouch wake up   </td></tr>
<tr>
<td rowspan="5">Power Down Wake <br />
Up Reason </td><td>POWER_DOWN_WAKEUP_RTC  </td><td>0x01  </td><td>RTC wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_PAD  </td><td>0x02  </td><td>PAD wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_MFB  </td><td>0x04  </td><td>MFB wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_ADP  </td><td>0x08  </td><td>Adapter wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_CTC  </td><td>0x10  </td><td>CapTouch wake up   </td></tr>
</table>
<p><br />
</p>
<div style="page-break-after: always;"></div><center><div id="table_5_4"><b>Table 5-4 Wake up reason for rtl87x3d</b></div></center> <table class="doxtable">
<tr>
<th style="width:150px">Low power mode  </th><th style="width:350px">Wake Up Reason  </th><th style="width:50px">Code  </th><th style="width:150px">Description   </th></tr>
<tr>
<td rowspan="14">DLPS Wake Up <br />
Reason </td><td>PLATFORM_DLPS_WAKEUP_UNKNOWN  </td><td>0x0000  </td><td>Wake up reason <br />
unknown   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_USER  </td><td>0x0001  </td><td>User registered <br />
callback, such <br />
as HW Timer   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_OS  </td><td>0x0002  </td><td>OS timer or OS task wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_PRE_SYSTEM_LEVEL  </td><td>0x0003  </td><td>BT wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_PF_RTC  </td><td>0x0040  </td><td>PF RTC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_ADSP  </td><td>0x0080  </td><td>ADSP wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_POW  </td><td>0x0100  </td><td>Adapter wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_MFB </td><td>0x0200  </td><td>MFB wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_USB_RESUME  </td><td>0x0400  </td><td>USB wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_GPIO  </td><td>0x0800  </td><td>GPIO wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_MAC  </td><td>0x1000  </td><td>MAC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_RTC  </td><td>0x2000  </td><td>RTC wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_VAD  </td><td>0x4000  </td><td>VAD wake up   </td></tr>
<tr>
<td>PLATFORM_DLPS_WAKEUP_VADBUF  </td><td>0x8000  </td><td>VADBUF wake up   </td></tr>
<tr>
<td rowspan="4">Power Down Wake <br />
Up Reason </td><td>POWER_DOWN_WAKEUP_RTC  </td><td>0x01  </td><td>RTC wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_PAD  </td><td>0x02  </td><td>PAD wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_MFB  </td><td>0x04  </td><td>MFB wake up   </td></tr>
<tr>
<td>POWER_DOWN_WAKEUP_ADP  </td><td>0x08  </td><td>Adapter wake up   </td></tr>
</table>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
