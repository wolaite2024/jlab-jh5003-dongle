<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="MAP_USER_MANU"></a>
MAP Application Note </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/06/15</b></center><div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/05/24  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/06/15  </td><td class="markdownTableBodyCenter">Structure adjustment   </td></tr>
</table>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Content"></a>
Contents</h2>
<ul>
<li><a class="el" href="_m_a_p.html#MAP_Rev">Revision History</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Table_List">Table List</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Figure_List">Figure List</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Glossary">Glossary</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Intro">1 Introduction</a><ul>
<li><a class="el" href="_m_a_p.html#MAP_Profile_Stack">1.1 MAP Profile Stack</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Roles">1.2 MAP Roles</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Services">1.3 MAP Services</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Folder">1.4 MAP Folder</a></li>
<li><a class="el" href="_m_a_p.html#MAP_SDP_RECORD">1.5 MAP SDP Record</a></li>
<li><a class="el" href="_m_a_p.html#MAP_COD">1.6 Class of Device Field</a></li>
</ul>
</li>
<li><a class="el" href="_m_a_p.html#MAP_Flow">2 Message Access Procedure</a><ul>
<li><a class="el" href="_m_a_p.html#MAP_Init">2.1 MAP Initialization</a></li>
<li><a class="el" href="_m_a_p.html#MAP_Connect">2.2 MAP Connect</a></li>
<li><a class="el" href="_m_a_p.html#MAP_GET_MSG">2.3 MAP Get Message</a></li>
<li><a class="el" href="_m_a_p.html#MAP_PUSH_MSG">2.4 MAP Push Message</a></li>
<li><a class="el" href="_m_a_p.html#MAP_DISCONNECT">2.5 MAP Disconnect</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_1_1">Table 1-1 Bits for Supported Features</a></li>
</ul>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 MAP Profile Stack</a></li>
<li><a href="#figure_1_2">Figure 1-2 MAP Virtual Folder Structure</a></li>
<li><a href="#figure_2_1">Figure 2-1 Message Listing Retrieve Procedure</a></li>
<li><a href="#figure_2_2">Figure 2-2 Push Message Procedure over RFCOMM</a></li>
<li><a href="#figure_2_3">Figure 2-3 Push Message Procedure over L2CAP</a></li>
</ul>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">MAP  </td><td class="markdownTableBodyCenter">Message Access Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">MSE  </td><td class="markdownTableBodyCenter">Message Server Equipment   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">MCE  </td><td class="markdownTableBodyCenter">Message Client Equipment   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">MAS  </td><td class="markdownTableBodyCenter">Message Access Service   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">MNS  </td><td class="markdownTableBodyCenter">Message Notification Service   </td></tr>
</table>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Intro"></a>
1 Introduction</h2>
<p>This manual describes the <b>MAP API definition</b> and provides the capabilities of a client device for browsing, reading, and sending messages. <br />
</p>
<h3><a class="anchor" id="MAP_Profile_Stack"></a>
1.1 MAP Profile Stack</h3>
<ul>
<li>Figure 1-1 shows the protocols and entities used in this profile. <div class="image">
<img src="profile_map.png" alt="profile_map.png"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 MAP Profile Stack </b></div></center> The Baseband, LMP and L2CAP are the physical and data link layers of the Bluetooth protocols. RFCOMM is the Bluetooth serial port emulation entity. SDP is the Bluetooth Service Discovery Protocol.</li>
</ul>
<h3><a class="anchor" id="MAP_Roles"></a>
1.2 MAP Roles</h3>
<ul>
<li><b>MSE</b> - This is the device that provides the message repository engine (i.e., has the ability to provide a client unit with messages that are stored in this device and notifications of changes in its message repository).</li>
<li><b>MCE</b> - This is the device that uses the message repository engine of the MSE for browsing and displaying existing messages and to upload messages created on the MCE to the MSE.</li>
</ul>
<h3><a class="anchor" id="MAP_Services"></a>
1.3 MAP Services</h3>
<ul>
<li><b>MAS</b> - Allows the MCE to browse messages on the MSE and to retrieve individual messages from the MSE.</li>
<li><b>MNS</b> - Allows the MSE to send event reports to the MCE (e.g., message arrival notifications).</li>
</ul>
<h3><a class="anchor" id="MAP_Folder"></a>
1.4 MAP Folder</h3>
<ul>
<li>Figure 1-2 shows the MAP virtual folder structure. <div class="image">
<img src="map_folder.png" alt="map_folder.png"/>
</div>
 <center><div id="figure_1_2"><b>Figure 1-2 MAP Virtual Folder Structure </b></div></center></li>
<li>telecom/msg/inbox - This folder shall contain all the messages that have been received by the MSE.</li>
<li>telecom/msg/outbox - This folder shall contain all the messages that are queued for transmission by the MSE.</li>
<li>telecom/msg/sent - This folder shall contain messages that were successfully sent to the network by the MSE.</li>
<li>telecom/msg/draft - This folder is the repository for messages that have not been sent and may require further editing.</li>
<li>telecom/msg/deleted - This folder shall contain the messages that have been deleted on the MSE.</li>
</ul>
<h3><a class="anchor" id="MAP_SDP_RECORD"></a>
1.5 MAP SDP Record</h3>
<p>There shall be one service record for MCE device (Message Notification Service, server role). </p><div class="fragment"><div class="line"><span class="preprocessor">#define RFC_MAP_MNS_CHANN_NUM           20        //user defined</span></div><div class="line"><span class="preprocessor">#define L2CAP_MAP_MNS_PSM               0x1001    //user defined</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> uint8_t map_mce_sdp_record[] =</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x49,</div><div class="line">    <span class="comment">//attribute SDP_ATTR_SRV_CLASS_ID_LIST</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#gae6e31379df951f323d24e4f8b85d42d3">SDP_ATTR_SRV_CLASS_ID_LIST</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)<a class="code" href="group___b_t___t_y_p_e_s.html#gae6e31379df951f323d24e4f8b85d42d3">SDP_ATTR_SRV_CLASS_ID_LIST</a>,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x03,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga9d465beea934f5f89796f9c6901da35c">SDP_UUID16_HDR</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga50b861ff43efd4a2f6ef39cf5c999c49">UUID_MSG_NOTIFICATION_SERVER</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga50b861ff43efd4a2f6ef39cf5c999c49">UUID_MSG_NOTIFICATION_SERVER</a>),</div><div class="line"></div><div class="line">    <span class="comment">//attribute SDP_ATTR_PROTO_DESC_LIST</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga3e3afe98f67b0f02ee51ca67e2d257b6">SDP_ATTR_PROTO_DESC_LIST</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)<a class="code" href="group___b_t___t_y_p_e_s.html#ga3e3afe98f67b0f02ee51ca67e2d257b6">SDP_ATTR_PROTO_DESC_LIST</a>,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x11,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x03,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga9d465beea934f5f89796f9c6901da35c">SDP_UUID16_HDR</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga847ad44f6d4c69761ac39371da15020d">UUID_L2CAP</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga847ad44f6d4c69761ac39371da15020d">UUID_L2CAP</a>),</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x05,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga9d465beea934f5f89796f9c6901da35c">SDP_UUID16_HDR</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#gae79453f41389da4c5f2bdd1b31814dd0">UUID_RFCOMM</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#gae79453f41389da4c5f2bdd1b31814dd0">UUID_RFCOMM</a>),</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga87b74d21f9c850aa838ad27c2881982a">SDP_UNSIGNED_ONE_BYTE</a>,</div><div class="line">    <a class="code" href="group___a_p_p___s_d_p.html#gad995eb7294f51972f88670571d4dd1a5">RFC_MAP_MNS_CHANN_NUM</a>,  <span class="comment">//channel number</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x03,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga9d465beea934f5f89796f9c6901da35c">SDP_UUID16_HDR</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga557e72866e03a88e7f8af7936a0ef352">UUID_OBEX</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga557e72866e03a88e7f8af7936a0ef352">UUID_OBEX</a>),</div><div class="line"></div><div class="line">    <span class="comment">//Attribute SDP_ATTR_SRV_NAME</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)((<a class="code" href="group___b_t___t_y_p_e_s.html#ga3c3fbd0a8e6f368f0a3261835901488d">SDP_ATTR_SRV_NAME</a> + <a class="code" href="group___b_t___t_y_p_e_s.html#ga8724613c287eece3321573a98c81da5b">SDP_BASE_LANG_OFFSET</a>) &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga3c3fbd0a8e6f368f0a3261835901488d">SDP_ATTR_SRV_NAME</a> + <a class="code" href="group___b_t___t_y_p_e_s.html#ga8724613c287eece3321573a98c81da5b">SDP_BASE_LANG_OFFSET</a>),</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga7e6da9cd524f983c421d0d84d65d8855">SDP_STRING_HDR</a>,</div><div class="line">    0x0B,</div><div class="line">    <span class="charliteral">&#39;R&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;l&#39;</span>, <span class="charliteral">&#39;t&#39;</span>, <span class="charliteral">&#39;e&#39;</span>, <span class="charliteral">&#39;k&#39;</span>, <span class="charliteral">&#39;-&#39;</span>, <span class="charliteral">&#39;M&#39;</span>, <span class="charliteral">&#39;N&#39;</span>, <span class="charliteral">&#39;S&#39;</span>,</div><div class="line"></div><div class="line">    <span class="comment">//attribute SDP_ATTR_PROFILE_DESC_LIST</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga4aa7aa3090459d3056faa878fcfde257">SDP_ATTR_PROFILE_DESC_LIST</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)<a class="code" href="group___b_t___t_y_p_e_s.html#ga4aa7aa3090459d3056faa878fcfde257">SDP_ATTR_PROFILE_DESC_LIST</a>,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x08,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga3162e2d0cb09ada26915070f4082f82a">SDP_DATA_ELEM_SEQ_HDR</a>,</div><div class="line">    0x06,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga9d465beea934f5f89796f9c6901da35c">SDP_UUID16_HDR</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga04a70a3515ae52881bfcf65a4705eb4a">UUID_MSG_ACCESS_PROFILE</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)<a class="code" href="group___b_t___t_y_p_e_s.html#ga04a70a3515ae52881bfcf65a4705eb4a">UUID_MSG_ACCESS_PROFILE</a>,</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    0x01,</div><div class="line">    0x04,   <span class="comment">//version 1.4</span></div><div class="line"></div><div class="line">    <span class="comment">//attribute SDP_ATTR_L2C_PSM</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)((<a class="code" href="group___b_t___t_y_p_e_s.html#ga39084a08425c2c65188bbc291f86acc9">SDP_ATTR_L2C_PSM</a>) &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga39084a08425c2c65188bbc291f86acc9">SDP_ATTR_L2C_PSM</a>),</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)(<a class="code" href="group___a_p_p___s_d_p.html#ga25b821aef8c0c4f89cb66b6ef05b0fbf">L2CAP_MAP_MNS_PSM</a> &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___a_p_p___s_d_p.html#ga25b821aef8c0c4f89cb66b6ef05b0fbf">L2CAP_MAP_MNS_PSM</a>),</div><div class="line"></div><div class="line">    <span class="comment">//attribute SDP_ATTR_MAP_SUPPERTED_FEATS</span></div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga942a94138894beb2b2bc75daebc6e2d0">SDP_UNSIGNED_TWO_BYTE</a>,</div><div class="line">    (uint8_t)((<a class="code" href="group___b_t___t_y_p_e_s.html#ga56d824186c4e89fcd8023a54426d47b6">SDP_ATTR_MAP_SUPPERTED_FEATS</a>) &gt;&gt; 8),</div><div class="line">    (uint8_t)(<a class="code" href="group___b_t___t_y_p_e_s.html#ga56d824186c4e89fcd8023a54426d47b6">SDP_ATTR_MAP_SUPPERTED_FEATS</a>),</div><div class="line">    <a class="code" href="group___b_t___t_y_p_e_s.html#ga89f3b0ac5161530064bdd7c2c094ceb8">SDP_UNSIGNED_FOUR_BYTE</a>,</div><div class="line">    (uint8_t)(0x0000024F &gt;&gt; 24),</div><div class="line">    (uint8_t)(0x0000024F &gt;&gt; 16),</div><div class="line">    (uint8_t)(0x0000024F &gt;&gt; 8),</div><div class="line">    (uint8_t)(0x0000024F)</div><div class="line">};</div></div><!-- fragment --><div style="page-break-after: always;"></div> <center><div id="table_1_1"><b>Table 1-1 Bits for Supported Features </b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Bit  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">0  </td><td class="markdownTableBodyLeft">Notification Registration Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">1  </td><td class="markdownTableBodyLeft">Notification Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">2  </td><td class="markdownTableBodyLeft">Browsing Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">3  </td><td class="markdownTableBodyLeft">Uploading Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">4  </td><td class="markdownTableBodyLeft">Delete Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">5  </td><td class="markdownTableBodyLeft">Instance Information Feature   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">6  </td><td class="markdownTableBodyLeft">Extended Event Report 1.1   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">7  </td><td class="markdownTableBodyLeft">Event Report Version 1.2   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">8  </td><td class="markdownTableBodyLeft">Message Format Version 1.1   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">9  </td><td class="markdownTableBodyLeft">Messages-Listing Format Version 1.1   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">10  </td><td class="markdownTableBodyLeft">Persistent Message Handles   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">11  </td><td class="markdownTableBodyLeft">Database Identifier   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">12  </td><td class="markdownTableBodyLeft">Folder Version Counter   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">13  </td><td class="markdownTableBodyLeft">Conversation Version Counters   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">14  </td><td class="markdownTableBodyLeft">Participant Presence Change Notification   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">15  </td><td class="markdownTableBodyLeft">Participant Chat State Change Notification   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">16  </td><td class="markdownTableBodyLeft">PBAP Contact Cross Reference   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">17  </td><td class="markdownTableBodyLeft">Notification Filtering   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">18  </td><td class="markdownTableBodyLeft">UTC Offset Timestamp Format   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">19  </td><td class="markdownTableBodyLeft">MapSupportedFeatures in Connect Request   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">20  </td><td class="markdownTableBodyLeft">Conversation listing   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">21  </td><td class="markdownTableBodyLeft">Owner Status   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">22  </td><td class="markdownTableBodyLeft">Message Forwarding   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">23-31  </td><td class="markdownTableBodyLeft">RFA   </td></tr>
</table>
<p>The bits for supported features are set to 1. Others are set to 0.</p>
<h3><a class="anchor" id="MAP_COD"></a>
1.6 Class of Device Field</h3>
<p>There is no obvious correlation between the Class of Device/Service Field and the support for the Message Access Profile. Many types of devices might implement the Message Access Profile. <b>Notice</b>: The MSE may implement policies that prevent the device from accessing the SMS privileges of phone.</p>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="MAP_Flow"></a>
2 Message Access Procedure</h2>
<h3><a class="anchor" id="MAP_Init"></a>
2.1 MAP Initialization</h3>
<p>Main function is invoked when the application is powered on or the chip is reset. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___s_p_p___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___s_p_p___d_e_m_o___m_a_i_n.html#ga916f2adc2080b4fe88034086d107a8dc">board_init</a>();</div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#ga181a0798f9a3ec712cfb0db5ff55250a">bt_map_init</a>(3, <a class="code" href="group___a_p_p___s_d_p.html#gad995eb7294f51972f88670571d4dd1a5">RFC_MAP_MNS_CHANN_NUM</a>, <a class="code" href="group___a_p_p___s_d_p.html#ga25b821aef8c0c4f89cb66b6ef05b0fbf">L2CAP_MAP_MNS_PSM</a>, 0x0000024F);</div><div class="line"></div><div class="line">    ......</div><div class="line">    <a class="code" href="group___o_s__87x3e___task.html#gac6d28adc4486c67c033dcce58ca3f1d2">os_task_create</a>(&amp;<a class="code" href="group___p_e_r_i_p_h___a_p_p___t_a_s_k.html#gae5e66af33ac97474a05905b4cba5b529">app_task_handle</a>, <span class="stringliteral">&quot;app_task&quot;</span>, app_task, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 1024 * 4, 1);</div><div class="line">    ......</div><div class="line"></div><div class="line">    <a class="code" href="group___o_s__87x3e___schedule.html#ga3300197ad1a1b9d64a335dc4ffc0769f">os_sched_start</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="MAP_Connect"></a>
2.2 MAP Connect</h3>
<p>OBEX connections in MAP shall always be initiated by the MCE device. The establishment of a Message Notification Service connection is done with the MCE as OBEX Server and the MSE as OBEX Client. The establishment of a Message Notification connection requires the previous establishment of a Message Access Service connection.</p>
<p><a class="el" href="group___b_t___m_a_p.html#ga5f7600acad39df50ed144fb83b8d200a" title="Register or Unregister the message notifications. ">bt_map_mas_msg_notification_set()</a> is used to register for being notified of the arrival of new messages. After this API is called, the MSE device will establish obex connection for Message Notification service.</p>
<p><a class="el" href="group___b_t___m_a_p.html#ga5c7c6007067ad09d3d931abf4daa53cb" title="Accept or reject the incoming MNS Connection. ">bt_map_mns_connect_cfm()</a> Accept or reject the incoming MNS Connection.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_gap_bt_cback(<a class="code" href="group___b_t___b_t_m.html#ga60f938d2fe9ea1ac81e1bf400fbb5b03">T_BT_EVENT</a> event_type, <span class="keywordtype">void</span> *event_buf, uint16_t buf_len)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (event_type)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83a9320e2b7e774c93377720bf3327f7b5e">BT_EVENT_READY</a>:</div><div class="line">            {</div><div class="line">                uint8_t bd_addr[6] = {0x11, 0x22, 0x33, 0x44, 0x55, 0x66};</div><div class="line">                <a class="code" href="union_t___g_a_p___u_u_i_d___d_a_t_a.html">T_GAP_UUID_DATA</a> uuid;</div><div class="line"></div><div class="line">                uuid.<a class="code" href="union_t___g_a_p___u_u_i_d___d_a_t_a.html#af4fea99995e2110b688ca292edb5f462">uuid_16</a> = <a class="code" href="group___b_t___t_y_p_e_s.html#ga8d166e64e3636a224bb156d854ee0981">UUID_MSG_ACCESS_SERVER</a>;</div><div class="line">                legacy_start_sdp_discov(bd_addr, <a class="code" href="group___g_a_p___b_r_e_d_r.html#ggaa0986ce90f56b17df2aa7e55971fcf5faec9e3ab8b7cca88657e7c5ad9b8eb077">GAP_UUID16</a>, uuid);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_map_bt_cback(<a class="code" href="group___b_t___b_t_m.html#ga60f938d2fe9ea1ac81e1bf400fbb5b03">T_BT_EVENT</a> event_type, <span class="keywordtype">void</span> *event_buf, uint16_t buf_len)</div><div class="line">{</div><div class="line">    <a class="code" href="union_t___b_t___e_v_e_n_t___p_a_r_a_m.html">T_BT_EVENT_PARAM</a> *param = event_buf;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (event_type)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83a4d6b781d7df2a68759c22de424935578">BT_EVENT_SDP_ATTR_INFO</a>:</div><div class="line">            {</div><div class="line">                <a class="code" href="structt__bt__sdp__attr__info.html">T_BT_SDP_ATTR_INFO</a> *sdp_info = &amp;param-&gt;bt_sdp_attr_info.info;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (sdp_info-&gt;<a class="code" href="structt__bt__sdp__attr__info.html#a9fe9edcdd42620e0f0d86d9d6a74367d">srv_class_uuid_data</a>.<a class="code" href="uniont__bt__sdp__uuid__data.html#af4fea99995e2110b688ca292edb5f462">uuid_16</a> == <a class="code" href="group___b_t___t_y_p_e_s.html#ga8d166e64e3636a224bb156d854ee0981">UUID_MSG_ACCESS_SERVER</a>)</div><div class="line">                {</div><div class="line">                    <span class="keywordflow">if</span>(sdp_info-&gt;<a class="code" href="structt__bt__sdp__attr__info.html#a592a804a18acf35ae1a0441df2264d54">l2c_psm</a> != 0)</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___b_t___m_a_p.html#gaf0fd055159d11f50c7539df12b5abdea">bt_map_mas_connect_over_l2c_req</a>(bd_addr, sdp_info-&gt;<a class="code" href="structt__bt__sdp__attr__info.html#a592a804a18acf35ae1a0441df2264d54">l2c_psm</a>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___b_t___m_a_p.html#gad21956098d8cb1af98ee092b3e3737e7">bt_map_mas_connect_over_rfc_req</a>(bd_addr, sdp_info-&gt;<a class="code" href="structt__bt__sdp__attr__info.html#ace5623b10edbf3417840ed509e9614bb">server_channel</a>);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83a0447a280b0537234c717d408009891f5">BT_EVENT_MAP_MAS_CONN_CMPL</a>:</div><div class="line">            {</div><div class="line">                <a class="code" href="group___b_t___m_a_p.html#ga5f7600acad39df50ed144fb83b8d200a">bt_map_mas_msg_notification_set</a>(param-&gt;bt_map_mas_conn_cmpl.bd_addr, <span class="keyword">true</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83ad79798c12c56cd635725a757fed42124">BT_EVENT_MAP_MNS_CONN_IND</a>:</div><div class="line">            {</div><div class="line">                <a class="code" href="group___b_t___m_a_p.html#ga5c7c6007067ad09d3d931abf4daa53cb">bt_map_mns_connect_cfm</a>(param-&gt;bt_map_mns_conn_ind.bd_addr, <span class="keyword">true</span>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="MAP_GET_MSG"></a>
2.3 MAP Get Message</h3>
<h4>Set Folder</h4>
<p><a class="el" href="group___b_t___m_a_p.html#gac8421768e6f44bd984817388509b75f3" title="Request to navigate the folders of MSE. ">bt_map_mas_folder_set()</a> is used to navigate the folders of the MSE. <br />
 <b>Notice</b>: The default folder will be set to telecom/msg by framework when the MAS connection is established.</p>
<h4>Get Folder Listing</h4>
<p><a class="el" href="group___b_t___m_a_p.html#gaf1b2869f1116217b9cc08da2e5eb5862" title="Request to get the remote folder listing. ">bt_map_mas_folder_listing_get()</a> is used to retrieve the Folder-Listing object from the <b>current folder</b> of the MSE. The Folder-Listing object is an XML object and shall be encoded in UTF-8. In the context of the MAP profile, the Folder-Listing object shall not contain message entries. It shall only contain folder entries located in the current folder level.</p>
<h4>Get Message Listing</h4>
<p><a class="el" href="group___b_t___m_a_p.html#ga2071f6034accf68ce8b1ef525f5b53e1" title="Request to get the list of messages from the MSE folder. ">bt_map_mas_msg_listing_get()</a> is used to retrieve Messages-Listing objects from the MSE. The Messages-Listing object is an XML object and shall be encoded in UTF-8. The message listing retrieve procedure is shown in Figure 2-1. </p><div style="page-break-after: always;"></div> <div class="image">
<img src="map_get_msg_listing.png" alt="map_get_msg_listing.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Message Listing Retrieve Procedure </b></div></center> <div class="fragment"><div class="line">{</div><div class="line">    <span class="comment">//if current folder is telecom/msg</span></div><div class="line"></div><div class="line">    <span class="comment">//NULL terminated UNICODE : inbox</span></div><div class="line">    uint8_t map_path_inbox[12] =</div><div class="line">    {</div><div class="line">        0x00, 0x69, 0x00, 0x6e, 0x00, 0x62, 0x00, 0x6f, 0x00, 0x78, 0x00, 0x00</div><div class="line">    };</div><div class="line">    uint16_t max_list_count = 10;</div><div class="line">    uint16_t start_offset = 0;</div><div class="line"></div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#ga2071f6034accf68ce8b1ef525f5b53e1">bt_map_mas_msg_listing_get</a>(p, map_path_inbox, 12, max_list_count, start_offset);</div><div class="line">}</div></div><!-- fragment --><h4>Get Message</h4>
<p><a class="el" href="group___b_t___m_a_p.html#ga327ee9510a33db0d2a5ded5ec6a395a4" title="Request to get the message from the MSE folder. ">bt_map_mas_msg_get()</a> is used to retrieve a specific message from the MSE. The message retrieve procedure is similar to Figure 3, and the corresponding event is <a class="el" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83a74452eb867a9c1a99bfb6892bb6f1bcd">BT_EVENT_MAP_GET_MSG_CMPL</a>.</p>
<h3><a class="anchor" id="MAP_PUSH_MSG"></a>
2.4 MAP Push Message</h3>
<p><a class="el" href="group___b_t___m_a_p.html#ga16e63395dbb6da7731d655f9811c31a7" title="Request to send a new message. ">bt_map_mas_msg_push()</a> is used to push a message to a folder of the MSE. In the case of sending messages through the MSE, the messages shall be uploaded into the 'Outbox' folder of the MSE. In the case of uploading messages to the MSE, the messages shall not be uploaded into the 'Outbox' folder of the MSE, but any other folder is permitted. In the case of sending messages through the MSE, the MCE shall get a notification when the messages have been sent to the network and thus have been shifted by the MSE from the 'Outbox' to the 'Sent' folder. <b>Notice</b>: The MSE may implement policies that disable the sending of messages to the remote network, making sending messages through the MSE impossible to realize. Framework will not keep a record of the message data, for the purpose of reducing use of RAM. <a class="el" href="group___b_t___m_a_p.html#gad787f4e0e4cdf1151b51576941a19efa">T_BT_MAP_PUSH_MSG_ACTION</a> in <a class="el" href="group___b_t___b_t_m.html#ggad24078c623525f9ed318443fdc4e4c83a09f929bc7467cc594c04de0bf4c8b968">BT_EVENT_MAP_PUSH_MSG_CMPL</a> is used to indicate app which part of message data is to be sent. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#gga172a4522ffa90c59ede58a59481dd3aea99a6fefd35aafc3f09005adea498946c">BT_MAP_PUSH_MSG_COMPLETE</a>        = 0x00,  <span class="comment">/* Push complete */</span></div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#gga172a4522ffa90c59ede58a59481dd3aeaeccaa600ad1601a25d503d0dbaa4d6f7">BT_MAP_PUSH_MSG_CONTINUE</a>        = 0x01,  <span class="comment">/* Push next packet */</span></div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#gga172a4522ffa90c59ede58a59481dd3aead3a327ea24848971e709336afcb036fe">BT_MAP_PUSH_MSG_AGAIN</a>           = 0x02,  <span class="comment">/* Push previous packet again */</span></div><div class="line">    <a class="code" href="group___b_t___m_a_p.html#gga172a4522ffa90c59ede58a59481dd3aea116299bf496216e64f1f80028f79b0b1">BT_MAP_PUSH_MSG_TO_END</a>          = 0x03,  <span class="comment">/* Push packets one by one from beginning to end */</span></div><div class="line">} <a class="code" href="group___b_t___m_a_p.html#gad787f4e0e4cdf1151b51576941a19efa">T_BT_MAP_PUSH_MSG_ACTION</a>;</div></div><!-- fragment --><h4>Push Message over RFCOMM</h4>
<div class="image">
<img src="map_push_msg_rfc.png" alt="map_push_msg_rfc.png"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Push Message Procedure over RFCOMM </b></div></center><h4>Push Message over L2CAP</h4>
<div class="image">
<img src="map_push_msg_l2c.png" alt="map_push_msg_l2c.png"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Push Message Procedure over L2CAP </b></div></center><h3><a class="anchor" id="MAP_DISCONNECT"></a>
2.5 MAP Disconnect</h3>
<p><a class="el" href="group___b_t___m_a_p.html#ga51297eaff77559f90aad9fa9df0312a8" title="Send a MAS disconnection request. ">bt_map_mas_disconnect_req()</a> <br />
 Request to disconnect Message Access service. </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
