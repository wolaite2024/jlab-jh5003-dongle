<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="APP_Cfg_Page"></a>
APP Cfg Application Note    </h1>
<h2>Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n002__a_p_p__c_f_g.html#APP_CFG_Introduction">Introduction</a></li>
<li><a class="el" href="_a_n002__a_p_p__c_f_g.html#APP_cfg_const">app cfg const items</a></li>
<li><a class="el" href="_a_n002__a_p_p__c_f_g.html#APP_cfg_nv">app cfg nv items</a></li>
</ul>
<h2><a class="anchor" id="APP_CFG_Introduction"></a>
Introduction</h2>
<p>The purpose of this document is to introduce app cfg module. This document describes how to use app cfg module in app project. The source code consists of <a class="el" href="group___a_p_p___c_f_g.html">App Cfg</a> part. The details will be described in the following sections.</p>
<h2><a class="anchor" id="APP_cfg_const"></a>
app cfg const items</h2>
<p>The section decribes app cfg const items. These items are configured by <b>mcu config tool</b>, and consist of three structures: <b><a class="el" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html" title="Read only configurations for inbox audio application. ">T_APP_CFG_CONST</a></b>, <b><a class="el" href="struct_t___a_p_p___c_f_g2___c_o_n_s_t.html" title="Read only configurations for app configurations, max size:512 bytes. ">T_APP_CFG2_CONST</a></b>(Debug configurations for dsp) and <b><a class="el" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html" title="Read only extend configurations for inbox audio application, max size is 512 bytes. ">T_EXTEND_APP_CFG_CONST</a></b>. These structures <b>SHOULD NOT</b> be modified, which means that the offsets of these existing items <b>SHOULD NOT</b> be modified and user <b>SHOULD NOT</b> append items to the end of the structure. These const items are loaded from flash in <a class="el" href="group___a_p_p___c_f_g___exported___functions.html#ga0d6336bc144e24986b036b7fdc9dcc6e">app_cfg_init</a>, so the value of the item <b>COULD</b> be modified <b>AFTER</b> this function if user wants to change. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#ga8a648b1d65f86eb42348e019c459d418">app_cfg_load</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t sync_word = 0;</div><div class="line"></div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(FLASH_IMG_MCUDATA) +</div><div class="line">                        APP_CONFIG_OFFSET),</div><div class="line">                       (uint8_t *)&amp;sync_word, DATA_SYNC_WORD_LEN);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (sync_word == DATA_SYNC_WORD)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(FLASH_IMG_MCUDATA) +</div><div class="line">                            APP_CONFIG_OFFSET),</div><div class="line">                           (uint8_t *)&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html">T_APP_CFG_CONST</a>));</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        app_wdg_reset(<a class="code" href="group___h_a_l___w_d_g___a_p_i.html#gga7e84a0d3ffda2c32d57debffd582c5c6a54db1b98fbfcbee9cf5160e9221996bd">RESET_ALL</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412ae86902d5dff573136b3e33af39188112">FLASH_IMG_MCUCONFIG</a>) +</div><div class="line">                        APP_CONFIG2_OFFSET),</div><div class="line">                       (uint8_t *)&amp;sync_word, DATA_SYNC_WORD_LEN);</div><div class="line">    <span class="keywordflow">if</span> (sync_word == DATA_SYNC_WORD)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412ae86902d5dff573136b3e33af39188112">FLASH_IMG_MCUCONFIG</a>) +</div><div class="line">                            APP_CONFIG2_OFFSET),</div><div class="line">                           (uint8_t *)&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0d0f0053250ab674eb9a4abf99e987bd">app_cfg2_const</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g2___c_o_n_s_t.html">T_APP_CFG2_CONST</a>));</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        app_wdg_reset(<a class="code" href="group___h_a_l___w_d_g___a_p_i.html#gga7e84a0d3ffda2c32d57debffd582c5c6a54db1b98fbfcbee9cf5160e9221996bd">RESET_ALL</a>);</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_cfg_load_extend(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t sync_word = 0;</div><div class="line"></div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412ae86902d5dff573136b3e33af39188112">FLASH_IMG_MCUCONFIG</a>) +</div><div class="line">                        EXTEND_APP_CONFIG_OFFSET),</div><div class="line">                       (uint8_t *)&amp;sync_word, DATA_SYNC_WORD_LEN);</div><div class="line">    <span class="keywordflow">if</span> (sync_word == DATA_SYNC_WORD)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>((<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412ae86902d5dff573136b3e33af39188112">FLASH_IMG_MCUCONFIG</a>) +</div><div class="line">                            EXTEND_APP_CONFIG_OFFSET),</div><div class="line">                           (uint8_t *)&amp;<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html">T_EXTEND_APP_CFG_CONST</a>));</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        app_wdg_reset(<a class="code" href="group___h_a_l___w_d_g___a_p_i.html#gga7e84a0d3ffda2c32d57debffd582c5c6a54db1b98fbfcbee9cf5160e9221996bd">RESET_ALL</a>);</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="APP_cfg_nv"></a>
app cfg nv items</h2>
<p>The section decribes app cfg nv items. These items are user-defined, and the existing items are defined in structure <b><a class="el" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a></b>. They are storaged in FTL, and user can add private items at the last of the structure above. It's the same as APP_cfg_const that the offsets of the existing items <b>SHOULD NOT</b> be modified. The usage of this structure is as follows:</p>
<ul>
<li>If deleting existing items, positions of these items shall be reserved</li>
<li>If adding new items, the new items shall be appended in the end</li>
<li>If newly added item needs a default value, the default value should be given in <b>app_cfg_rw_default</b>. These const items are loaded from FTL in <a class="el" href="group___a_p_p___c_f_g___exported___functions.html#ga8a648b1d65f86eb42348e019c459d418">app_cfg_load</a> as follows: <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#ga8a648b1d65f86eb42348e019c459d418">app_cfg_load</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___f_t_l___exported___functions.html#ga6cc2f63950b59f65e3520364ea770eee">ftl_load_from_storage</a>(&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>, APP_RW_DATA_ADDR, <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>));</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaaa1124737e74fa03841425d44bcaf99e">sync_word</a> != DATA_SYNC_WORD)</div><div class="line">    {</div><div class="line">        <span class="comment">//Load factory reset bit first when mppgtool factory reset</span></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaebb70c2aab3407a9f05334c47131a43b">length</a> == 0)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___f_t_l___exported___functions.html#ga6cc2f63950b59f65e3520364ea770eee">ftl_load_from_storage</a>(&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gadb4b5fb4b6109b3b4ecb2914e44c1dd7">eq_idx_anc_mode_record</a>, APP_RW_DATA_ADDR + FACTORY_RESET_OFFSET,</div><div class="line">                                  4);</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#gacec57652e8e2274156160bccc34f736a">app_cfg_reset</a>();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        uint32_t load_len = <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaebb70c2aab3407a9f05334c47131a43b">length</a>;</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (load_len &gt; <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a>))</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;app_cfg_load, error&quot;</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            uint32_t res = <a class="code" href="group___f_t_l___exported___functions.html#ga6cc2f63950b59f65e3520364ea770eee">ftl_load_from_storage</a>(&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>, APP_RW_DATA_ADDR, load_len);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (res == 0)</div><div class="line">            {</div><div class="line">                <span class="keywordflow">if</span> (load_len &lt; <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a>))</div><div class="line">                {</div><div class="line">                    uint8_t *p_dst = ((uint8_t *)&amp;<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>) + load_len;</div><div class="line">                    uint8_t *p_src = ((uint8_t *)&amp;app_cfg_rw_default) + load_len;</div><div class="line">                    memcpy(p_dst, p_src, <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a>) - load_len);</div><div class="line">                }</div><div class="line">                <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga4163c81b558e653253a3e61a7f32e7e1">hdr</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaebb70c2aab3407a9f05334c47131a43b">length</a> = <span class="keyword">sizeof</span>(<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a>);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span></div><div class="line">            {</div><div class="line">                <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#gacec57652e8e2274156160bccc34f736a">app_cfg_reset</a>();</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> If some errors occur when load flash , such as these items have never been storaged in FTL, the items will use default values in <b>app_cfg_rw_default</b>. </li>
</ul>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
