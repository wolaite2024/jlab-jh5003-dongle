<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="FINDMY_Page"></a>
FINDMY Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.0.0.1</b></center><p><br />
 </p><center><b>2022/12/12</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2022/12/12  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Rev">Revision History</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Table_List">Table List</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Introduction">1 Introduction</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Find_My">1.1 Find My</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Find_My_app">1.2 Find My app</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Transport">1.3 Transport</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Roles">1.4 Roles</a></li>
</ul>
</li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_enable">2 Feature enable</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Add_Findmy_File">2.1 Add findmy file</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Keil_configuration">2.2 Findmy keil configuration</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Macro_configuration">2.3 Findmy macro configuration</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Configuration_of_MCU_Config_Tool">2.4 Configuration of MCU Config Tool</a></li>
</ul>
</li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Bluetooth_Requirements">3 Bluetooth Requirements</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Bluetooth_connection">3.1 Bluetooth connection</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Accessory_information_service">3.2 Accessory information service</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Find_My_network_service">3.3 Find My network service</a></li>
</ul>
</li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Bluetooth_LE_advertising">4 Bluetooth LE advertising</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Payload_for_pairing">4.1 Payload for pairing</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Payload_for_nearby_state">4.2 Payload for nearby state</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Payload_for_separated_state">4.3 Payload for separated state</a></li>
</ul>
</li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Pairing">5 Findmy pairing</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Pairing_mode">5.1 Findmy pairing mode</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Generate_pairing_data">5.2 Generate pairing data</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Send_pairing_data">5.3 Send pairing data</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Finalize_pairing">5.4 Finalize pairing</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_connected">5.5 Findmy connected</a></li>
</ul>
</li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Sound">6 Sound</a><ul>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Sound_start">6.1 Start sound</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Sound_stop">6.2 Stop sound</a></li>
<li><a class="el" href="_a_n120__f_i_n_d_m_y.html#FINDMY_Page_Sound_completed">6.3 Complete sound</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 Different roles in the Find My network</a></li>
<li><a href="#figure_2_1">Figure 2-1 crypto file path</a></li>
<li><a href="#figure_2_2">Figure 2-2 Add crypto file in keil</a></li>
<li><a href="#figure_2_3">Figure 2-3 Findmy LE config</a></li>
<li><a href="#figure_2_4">Figure 2-4 Config key of findmy serial number</a></li>
<li><a href="#figure_5_1">Figure 5-1 Add new item</a></li>
<li><a href="#figure_5_2">Figure 5-2 Connect accessory</a></li>
<li><a href="#figure_5_3">Figure 5-3 Choose emoji</a></li>
<li><a href="#figure_5_4">Figure 5-4 Agree connect</a></li>
<li><a href="#figure_6_1">Figure 6-1 Play sound</a></li>
<li><a href="#figure_6_2">Figure 6-2 Stop sound</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">FMNA  </td><td class="markdownTableBodyCenter">Find My Network Accessory   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of the findmy module for customer. The document describes how to enable findmy feature, use findmy module in app project, test findmy function.</p>
<h3><a class="anchor" id="FINDMY_Page_Find_My"></a>
1.1 Find My</h3>
<p>Find My is an application technology released by Apple. The magic of this technology is that the peripheral products that support this technology (such as AirTag) can use the Apple devices around it (iPhone, iPad, AirPods, AirTag, etc.) to help it locate even if they do not have a GPS module. Please refer to <a href="https://www.apple.com/icloud/find-my/">https://www.apple.com/icloud/find-my/</a> for specific functions.</p>
<h3><a class="anchor" id="FINDMY_Page_Find_My_app"></a>
1.2 Find My app</h3>
<p>The Find My app is where you locate your Apple devices, share your location with friends and family,and locate Find My network-enabled accessories. The app displays the location of findable items and includes additional features to protect your devices, such as playing sound and using Lost Mode.</p>
<h3><a class="anchor" id="FINDMY_Page_Transport"></a>
1.3 Transport</h3>
<p>The Find My network accessory protocol uses Bluetooth Low Energy (LE) as the primary transport to interact with Apple devices.</p>
<h3><a class="anchor" id="FINDMY_Page_Roles"></a>
1.4 Roles</h3>
<p>It includes the following four roles: Owner device, Accessory, Find My network and Apple server. The relationship between the four roles is shown in the following figure: </p><div class="image">
<img src="four_roles.jpg" alt="four_roles.jpg" width="781px" height="549px"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 Different roles in the Find My network</b></div></center><h2><a class="anchor" id="FINDMY_Page_enable"></a>
2 Feature enable</h2>
<h3><a class="anchor" id="FINDMY_Page_Add_Findmy_File"></a>
2.1 Add findmy file</h3>
<p>Copy crypto source files to the path of sdk. </p><div class="image">
<img src="findmy_source_file_location.jpg" alt="findmy_source_file_location.jpg" width="781px" height="494px"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Crypto file path</b></div></center><h3><a class="anchor" id="FINDMY_Page_Keil_configuration"></a>
2.2 Findmy keil configuration</h3>
<p>Add crypto source file to target. </p><div class="image">
<img src="findmy_keil_file_set.jpg" alt="findmy_keil_file_set.jpg" width="781px" height="587px"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Add crypto file in keil</b></div></center><h3><a class="anchor" id="FINDMY_Page_Macro_configuration"></a>
2.3 Findmy macro configuration</h3>
<p>F_APP_FINDMY_FEATURE_SUPPORT is a macro for FINDMY. Please enable it in app_flags.h </p><div class="fragment"><div class="line"><span class="comment">//----- [3rd party related] -----</span></div><div class="line"><span class="preprocessor">#define AMA_FEATURE_SUPPORT                         0</span></div><div class="line"><span class="preprocessor">#define BISTO_FEATURE_SUPPORT                       0</span></div><div class="line"><span class="preprocessor">#define GFPS_FEATURE_SUPPORT                        0</span></div><div class="line"><span class="preprocessor">#define F_APP_TUYA_SUPPORT                          0</span></div><div class="line"><span class="preprocessor">#define F_APP_BLE_SWIFT_PAIR_SUPPORT                0</span></div><div class="line"><span class="preprocessor">#define F_APP_TEAMS_FEATURE_SUPPORT                 0</span></div><div class="line"><span class="preprocessor">#define XM_XIAOAI_FEATURE_SUPPORT                   0</span></div><div class="line"><span class="preprocessor">#define F_APP_XIAOWEI_FEATURE_SUPPORT               0</span></div><div class="line"><span class="preprocessor">#define F_APP_FINDMY_FEATURE_SUPPORT                1</span></div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Configuration_of_MCU_Config_Tool"></a>
2.4 Configuration of MCU Config Tool</h3>
<p>To use Findmy, The BLE test usage option needed to be checked. The LE link number and le slave link number configuration are as follows: </p><div class="image">
<img src="MCUConfigTool_findmy.jpg" alt="MCUConfigTool_findmy.jpg" width="781px" height="425px"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Findmy LE config</b></div></center><p>In order to pass "Get Serial Number" test, the "FindMy Put S/N State" function to adjust serial number state needs to be mapped to a key on the page of KEY (Figure 2-4).</p>
<div class="image">
<img src="MCUConfigToolKey.jpg" alt="MCUConfigToolKey.jpg" width="781px" height="527px"/>
</div>
 <center><div id="figure_2_4"><b>Figure 2-4 Config key of findmy serial number</b></div></center><h2><a class="anchor" id="FINDMY_Page_Bluetooth_Requirements"></a>
3 Bluetooth Requirements</h2>
<p>Bluetooth Low Energy (LE) is used as the wireless transport for all communication between Apple products and accessories.</p>
<h3><a class="anchor" id="FINDMY_Page_Bluetooth_connection"></a>
3.1 Bluetooth connection</h3>
<p>The accessory must support at least two simultaneous connections in a peripheral role. </p><div class="fragment"><div class="line"><span class="preprocessor">#define APP_FINDMY_MAX_LINKS            2 </span></div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Accessory_information_service"></a>
3.2 Accessory information service</h3>
<p>The Accessory information service UUID: </p><div class="fragment"><div class="line"><span class="preprocessor">#define AIS_SERVICE_BASE_UUID                         {0x8B, 0x47, 0x38, 0xDC, 0xB9, 0x11, 0xA9, 0xA1, 0xB1, 0x43, 0x51, 0x3C, 0x02, 0x01, 0x29, 0x87}</span></div></div><!-- fragment --><p>The UUID for Accessory information service characteristics is 6AA5XXXX-6352-4D57- A7B4-003A416FBB0B, where XXXX is unique for each characteristic. </p><div class="fragment"><div class="line"><span class="preprocessor">#define  GATT_UUID128_PROD_DATA             0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x01, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_MANU_NAME             0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x02, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_MODEL_NAME            0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x03, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_RESERVED              0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x04, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_ACC_CATEGORY          0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x05, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_ACC_CAP               0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x06, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_FW_VERS               0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x07, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_FINDMY_VERS           0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x08, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_BATT_TYPE             0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x09, 0x00, 0xA5, 0x6A</span></div><div class="line"><span class="preprocessor">#define  GATT_UUID128_BATT_LVL              0x0B, 0xBB, 0x6F, 0x41, 0x3A, 0x00, 0xB4, 0xA7, 0x57, 0x4D, 0x52, 0x63, 0x0A, 0x00, 0xA5, 0x6A</span></div></div><!-- fragment --><p>Get characteristic data through the following interface: </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> ais_attr_read_cb(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id,</div><div class="line">                              uint16_t attrib_index, uint16_t offset, uint16_t *p_length, uint8_t **pp_value)</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Find_My_network_service"></a>
3.3 Find My network service</h3>
<p>The Find My network service UUID is </p><div class="fragment"><div class="line"><span class="preprocessor">#define FINDMY_UUID_SERVICE                           0xFD44</span></div></div><!-- fragment --><p>The UUID for Find My network service characteristics is 4F86XXXX-943B-49EF-BED4-2F730304427A, where XXXX is unique for each characteristic. </p><div class="fragment"><div class="line"><span class="preprocessor">#define GATT_UUID128_PAIR_CTRL_POINT                   0x7A, 0x42, 0x04, 0x03, 0x73, 0x2F, 0xD4, 0xBE, 0xEF, 0x49, 0x3B, 0x94, 0x01, 0x00, 0x86, 0x4F</span></div><div class="line"><span class="preprocessor">#define GATT_UUID128_CONF_CTRL_POINT                   0x7A, 0x42, 0x04, 0x03, 0x73, 0x2F, 0xD4, 0xBE, 0xEF, 0x49, 0x3B, 0x94, 0x02, 0x00, 0x86, 0x4F</span></div><div class="line"><span class="preprocessor">#define GATT_UUID128_NON_OWNER_CTRL_POINT              0x7A, 0x42, 0x04, 0x03, 0x73, 0x2F, 0xD4, 0xBE, 0xEF, 0x49, 0x3B, 0x94, 0x03, 0x00, 0x86, 0x4F</span></div><div class="line"><span class="preprocessor">#define GATT_UUID128_PAIRED_OWNER_INFO_CTRL_POINT      0x7A, 0x42, 0x04, 0x03, 0x73, 0x2F, 0xD4, 0xBE, 0xEF, 0x49, 0x3B, 0x94, 0x04, 0x00, 0x86, 0x4F</span></div><div class="line"><span class="preprocessor">#define GATT_UUID128_DEBUG_CTRL_POINT                  0x7A, 0x42, 0x04, 0x03, 0x73, 0x2F, 0xD4, 0xBE, 0xEF, 0x49, 0x3B, 0x94, 0x05, 0x00, 0x86, 0x4F</span></div></div><!-- fragment --><p>set and update characteristic data through the following interface: </p><div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> fns_attr_write_cb(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id,</div><div class="line">                               uint16_t attrib_index, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ga07c105220cd4d1b097c670b9d2841114">T_WRITE_TYPE</a> write_type, uint16_t length, uint8_t *p_value,</div><div class="line">                               <a class="code" href="group___p___f_u_n___w_r_i_t_e___i_n_d___p_o_s_t___p_r_o_c.html#gad0a0809497ada580e7025f1bff8ea913">P_FUN_WRITE_IND_POST_PROC</a> *p_write_ind_post_proc)</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> fns_cccd_update_cb(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, uint16_t index,</div><div class="line">                        uint16_t cccbits)</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="FINDMY_Page_Bluetooth_LE_advertising"></a>
4 Bluetooth LE advertising</h2>
<h3><a class="anchor" id="FINDMY_Page_Payload_for_pairing"></a>
4.1 Payload for pairing</h3>
<p>An accessory that is not Find My network paired shall advertise the Find My network service as a primary service when the user puts the accessory in pairing mode. The Bluetooth LE payload for pairing is:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> uint8_t pairing_adv_data[29] =</div><div class="line">{</div><div class="line">    <span class="comment">/* Flags */</span></div><div class="line">    0x18,             <span class="comment">/* length */</span></div><div class="line">    <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga26d15769ff3ce64a0827fe6eeb67974e">GAP_ADTYPE_SERVICE_DATA</a>, <span class="comment">/* type=&quot;Flags&quot; */</span></div><div class="line">    <a class="code" href="group___g_a_t_t___u_u_i_d___s_i_z_e.html#ga9628e53fd1b37c394cd1647102594db6">LO_WORD</a>(FINDMY_UUID_SERVICE),</div><div class="line">    <a class="code" href="group___g_a_t_t___u_u_i_d___s_i_z_e.html#ga51d482559947b7737c12cc1df307bd7a">HI_WORD</a>(FINDMY_UUID_SERVICE),</div><div class="line">};</div></div><!-- fragment --><p>To initialize pairing data, can use api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> fmna_adv_init_pairing(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    fmna_pairing_adv_service_data_init();</div><div class="line"></div><div class="line">    fmna_adv_platform_init_pairing((uint8_t *)&amp;m_fmna_pairing_adv_payload,</div><div class="line">                                   <span class="keyword">sizeof</span>(m_fmna_pairing_adv_payload));</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Payload_for_nearby_state"></a>
4.2 Payload for nearby state</h3>
<p>After Find My network pairing, the accessory shall advertise the Find My network Bluetooth LE payload for nearby state. Payload for nearby state defined in: </p><div class="fragment"><div class="line"><span class="keyword">static</span> uint8_t nearby_adv_data[31] =</div><div class="line">{</div><div class="line">    0x03,</div><div class="line">    0xFF,</div><div class="line">    0x4C, 0x00,</div><div class="line">};</div></div><!-- fragment --><p>To initialize nearby data, can use api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> fmna_adv_init_nearby(uint8_t pubkey[FMNA_PUBKEY_BLEN])</div><div class="line">{</div><div class="line">    <span class="comment">// Initialize Nearby manufacturing data with the public key</span></div><div class="line">    fmna_nearby_adv_manuf_data_init(pubkey);</div><div class="line"></div><div class="line">    fmna_adv_platform_init_nearby((uint8_t *)&amp;m_fmna_nearby_adv_packet,</div><div class="line">                                  <span class="keyword">sizeof</span>(m_fmna_nearby_adv_packet));</div><div class="line">    FMNA_LOG_INFO(<span class="stringliteral">&quot;NADV data %d&quot;</span>, <span class="keyword">sizeof</span>(m_fmna_nearby_adv_packet));</div><div class="line">    FMNA_LOG_HEXDUMP_DEBUG((uint8_t *)&amp;m_fmna_nearby_adv_packet,</div><div class="line">                           <span class="keyword">sizeof</span>(m_fmna_nearby_adv_packet));</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Payload_for_separated_state"></a>
4.3 Payload for separated state</h3>
<p>When the accessory is in the separated state, the accessory shall advertise the Find My network BLE payload for separated state. </p><div class="fragment"><div class="line"><span class="keyword">static</span> uint8_t separate_adv_data[31] =</div><div class="line">{</div><div class="line">    0x03,</div><div class="line">    0xFF,</div><div class="line">    0x4C, 0x00,</div><div class="line">};</div></div><!-- fragment --><p>To initialize separated data, can use api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> fmna_adv_platform_init_separated(uint8_t *separated_adv_manuf_data,</div><div class="line">                                      <span class="keywordtype">size_t</span> separated_adv_manuf_data_size)</div><div class="line">{</div><div class="line">    fmna_fast_adv_interval = fmna_separated_adv_fast_intv;</div><div class="line">    fmna_slow_adv_interval = fmna_separated_adv_slow_intv;</div><div class="line">    memcpy(separate_adv_data + MANU_DATA_OFFSET, separated_adv_manuf_data,</div><div class="line">           separated_adv_manuf_data_size);</div><div class="line">    separate_adv_data[0] = 3 + separated_adv_manuf_data_size;</div><div class="line">    <a class="code" href="group___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___functions.html#ga622a25fde393572f22a7db82345488f8">ble_ext_adv_mgr_set_adv_data</a>(app_findmy_adv_get_adv_handle(), 3 + separated_adv_manuf_data_size + 1,</div><div class="line">                                 (uint8_t *)separate_adv_data);</div><div class="line">    FMNA_LOG_INFO(<span class="stringliteral">&quot;ADV Separate len %d&quot;</span>, 3 + separated_adv_manuf_data_size + 1);</div><div class="line">    FMNA_LOG_HEXDUMP_INFO(separate_adv_data, 31);</div><div class="line">}</div></div><!-- fragment --><h2><a class="anchor" id="FINDMY_Page_Pairing"></a>
5 Findmy pairing</h2>
<p>An accessory must be paired to an owner device before it can be locatable.An owner device will initiate the standard Bluetooth LE encryption before it accesses the Find My network services.</p>
<h3><a class="anchor" id="FINDMY_Page_Pairing_mode"></a>
5.1 Findmy pairing mode</h3>
<p>Accessories automatically enter pairing mode after power on.To enter pairing mode,can also use api. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_findmy_enter_pair_mode(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_findmy_enter_pair_mode&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> != <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4acb29f360a1e5a69b4c8541f24b929343">REMOTE_SESSION_ROLE_SECONDARY</a>)</div><div class="line">    {</div><div class="line">        start_pair_adv();</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Generate_pairing_data"></a>
5.2 Generate pairing data</h3>
<p>The Send_pairing_data opcode must be used by the accessory to respond to a pairing session request. The accessory must respond in 60 seconds. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></div><div class="line">{</div><div class="line">    uint8_t  c1[C1_BLEN];</div><div class="line">    uint8_t  e2[E2_BLEN];</div><div class="line">} <a class="code" href="group___a_u_d_i_o___f_s.html#ga459c55798724c941a76cebcb78961380">__attribute__</a>((packed)) fmna_send_pairing_data_t;</div></div><!-- fragment --><p>Generate C1 use api. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> fm_crypto_ckg_gen_c1(<a class="code" href="structfm__crypto__ckg__context.html">fm_crypto_ckg_context_t</a> ctx, byte out[32])</div></div><!-- fragment --><p>Generate E2 use api. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> populate_e2_generation_encryption_msg(<span class="keywordtype">void</span>)</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Send_pairing_data"></a>
5.3 Send pairing data</h3>
<p>The accessory must send encrypted payload generated using Apple server encryption key (Q_E). </p><div class="fragment"><div class="line">fmna_ret_code_t fmna_crypto_generate_send_pairing_data_params(<span class="keywordtype">void</span>)</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Finalize_pairing"></a>
5.4 Finalize pairing</h3>
<p>The owner device initiates the finalize pairing process to complete pairing. </p><div class="fragment"><div class="line">fmna_ret_code_t fmna_crypto_generate_send_pairing_data_params(<span class="keywordtype">void</span>)</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_connected"></a>
5.5 Findmy connected</h3>
<p>The accessory will enable advertising after power on. Users could find the accessory in 'Find My' by clicking the button 'Other Supported Item' (Figure 5-1). Connect the Realtek Reference Implementation (Figure 5-2) and choose an Emoji (Figure 5-3). Click the 'Agree' button and the accessory will be Connected (Figure 5-4).</p>
<div class="image">
<img src="Addnewitem.jpg" alt="Addnewitem.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_5_1"><b>Figure 5-1 Add new item</b></div></center><div class="image">
<img src="Connectaccessory.jpg" alt="Connectaccessory.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_5_2"><b>Figure 5-2 Connect accessory</b></div></center><div class="image">
<img src="chooseemoji.jpg" alt="chooseemoji.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_5_3"><b>Figure 5-3 Choose emoji</b></div></center><div class="image">
<img src="agreeconnect.jpg" alt="agreeconnect.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_5_4"><b>Figure 5-4 Agree connect</b></div></center><h2><a class="anchor" id="FINDMY_Page_Sound"></a>
6 Sound</h2>
<p>Play sound requirements are applicable only for accessories that include a sound maker. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    FMNA_SERVICE_OPCODE_SOUND_START                                       = 0x0200,</div><div class="line">    FMNA_SERVICE_OPCODE_SOUND_STOP                                        = 0x0201,</div><div class="line">    FMNA_SERVICE_OPCODE_SOUND_COMPLETED                                   = 0x020D,</div><div class="line">} FMNA_Service_Opcode_t;</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Sound_start"></a>
6.1 Start sound</h3>
<p>clicking the button 'Play Sound' after the accessory connected(Figure 6-1).</p>
<div class="image">
<img src="playsound.jpg" alt="playsound.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_6_1"><b>Figure 6-1 Play sound</b></div></center><p>The Sound_Start opcode is used to play "TONE_PLAY_SOUND" tone on the sound maker of the accessory. </p><div class="fragment"><div class="line"><span class="keywordflow">case</span> FMNA_SERVICE_OPCODE_SOUND_START:</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___a_u_d_i_o___exported___functions.html#gafa3455d6700ac763d5d91284cee2907c">app_audio_tone_type_play</a>(TONE_PLAY_SOUND, <span class="keyword">false</span>, <span class="keyword">false</span>);<span class="comment">//play sound</span></div><div class="line">        FMNA_LOG_INFO(<span class="stringliteral">&quot;RX Sound Start&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (fmna_connection_is_status_bit_enabled(CONN_HANDLE_ALL, FMNA_MULTI_STATUS_PLAYING_SOUND))</div><div class="line">        {</div><div class="line">            FMNA_LOG_ERROR(<span class="stringliteral">&quot;Sound session already in progress&quot;</span>);</div><div class="line">            response_status = RESPONSE_STATUS_INVALID_STATE;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <span class="comment">// Update the multi status in case another play sound request comes before we execute play sound state machine handler.</span></div><div class="line">            fmna_connection_update_connection_info(conn_handle, FMNA_MULTI_STATUS_PLAYING_SOUND, <span class="keyword">true</span>);</div><div class="line">            response_status = RESPONSE_STATUS_SUCCESS;</div><div class="line">            fmna_state_machine_dispatch_event(FMNA_SM_EVENT_SOUND_START);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">break</span>;</div></div><!-- fragment --><p>If no operation, the sound will stop after ten seconds. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> fmna_sound_platform_start(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;Sound starting...&quot;</span>);</div><div class="line">    ret_code_t ret_code = app_timer_start(m_fmna_sound_timeout_timer_id,</div><div class="line">                                          MSEC_TO_TIMER_TICKS(SEC_TO_MSEC(10)),</div><div class="line">                                          <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div><div class="line">    APP_ERROR_CHECK(ret_code);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Sound_stop"></a>
6.2 Stop sound</h3>
<p>clicking the button 'Stop Sound' when play sound(Figure 6-2).</p>
<div class="image">
<img src="stopsound.jpg" alt="stopsound.jpg" width="400px" height="865px"/>
</div>
 <center><div id="figure_6_2"><b>Figure 6-2 Stop sound</b></div></center><p>The Sound_Stop opcode is used to stop an ongoing sound request. </p><div class="fragment"><div class="line"><span class="keywordflow">case</span> FMNA_SERVICE_OPCODE_SOUND_STOP:</div><div class="line">    {</div><div class="line">        FMNA_LOG_INFO(<span class="stringliteral">&quot;RX Sound Stop&quot;</span>);</div><div class="line">        <span class="keywordflow">if</span> (!fmna_connection_is_status_bit_enabled(CONN_HANDLE_ALL, FMNA_MULTI_STATUS_PLAYING_SOUND))</div><div class="line">        {</div><div class="line">            FMNA_LOG_WARNING(<span class="stringliteral">&quot;No sound session in progress&quot;</span>);</div><div class="line">            response_status = RESPONSE_STATUS_INVALID_STATE;</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            fmna_state_machine_dispatch_event(FMNA_SM_EVENT_SOUND_STOP);</div><div class="line">        }</div><div class="line">    } <span class="keywordflow">break</span>;</div></div><!-- fragment --><p>Then the accessory will be "FMNA_SM_EVENT_SOUND_COMPLETE" state. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> fmna_sound_platform_stop(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ret_code_t ret_code = app_timer_stop(m_fmna_sound_timeout_timer_id);</div><div class="line">    APP_ERROR_CHECK(ret_code);</div><div class="line">    fmna_state_machine_dispatch_event(FMNA_SM_EVENT_SOUND_COMPLETE);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="FINDMY_Page_Sound_completed"></a>
6.3 Complete sound</h3>
<p>The accessory shall confirm the completion of the stop sound procedure by sending the Sound_Completed message. </p><div class="fragment"><div class="line">uint32_t fmna_generic_evt_sound_complete_handler(FMNA_SM_Event_t fmna_evt, <span class="keywordtype">void</span> *p_context)</div><div class="line">{</div><div class="line">    uint16_t sound_conn_handle = fmna_connection_get_conn_handle_with_multi_status_enabled(</div><div class="line">                                     FMNA_MULTI_STATUS_PLAYING_SOUND);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (sound_conn_handle == CONN_HANDLE_INVALID)</div><div class="line">    {</div><div class="line">        FMNA_LOG_INFO(<span class="stringliteral">&quot;Sound initiator no longer connected&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> FMNA_SM_STATUS_SUCCESS;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (fmna_connection_is_status_bit_enabled(sound_conn_handle, FMNA_MULTI_STATUS_ENCRYPTED))</div><div class="line">    {</div><div class="line">        <span class="comment">// owner connection</span></div><div class="line">        fmna_gatt_send_indication(sound_conn_handle, FMNA_SERVICE_OPCODE_SOUND_COMPLETED, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="comment">// Non-owner connection</span></div><div class="line">        fmna_gatt_send_indication(sound_conn_handle, FMNA_SERVICE_NON_OWNER_OPCODE_SOUND_COMPLETED, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,</div><div class="line">                                  0);</div><div class="line">    }</div><div class="line"></div><div class="line">    fmna_connection_update_connection_info_all(FMNA_MULTI_STATUS_PLAYING_SOUND, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> FMNA_SM_STATUS_SUCCESS;</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
