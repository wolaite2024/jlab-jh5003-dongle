<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="APP_BLE_Module_Page"></a>
APP BLE Module Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/05/30</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Rws_LE_App_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/04/18  </td><td class="markdownTableBodyCenter">Modify Document Structure   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/05/30  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#Rws_LE_App_Rev">Revision History</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#Rws_LE_App_Table_List">Table List</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#Rws_LE_App_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#Rws_LE_App_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_Module_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_GAP">2 APP BLE GAP</a><ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_PARAM_INIT">2.1 GAP Parameter Initialize</a><ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_DEVICE_NAME_AND_APPER_CFG">2.1.1 Device Name And Appearance Configuration</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_CFG_BOND_MANAGER_PARAM">2.1.2 Configure Bond Manager Parameters</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_INIT_BLE_LINKs">2.1.3 Initialize BLE Link</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_CFG_SCAN_PARAM">2.1.4 Configure Scan Parameters</a></li>
</ul>
</li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_MSG">2.2 GAP Message</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_INIT">2.3 APP BLE GAP Initialize</a></li>
</ul>
</li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_SERVICE">3 APP BLE Service</a><ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_INIT_BLE_SERVICE">3.1 Initialize BLE Services</a></li>
</ul>
</li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_DEVICE">4 APP BLE Device</a><ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_FACTORT_RESET">4.1 Device Factory Reset</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_POWER_ON">4.2 Device Power On</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_POWER_OFF">4.3 Device Power Off</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_RADIO_MODE">4.4 Radio Mode</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_ROLE_SWAP">4.5 Role Swap</a></li>
</ul>
</li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_COMMON_ADV">5 APP BLE Common Advertising</a><ul>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_ENABLE_COMMON_ADV">5.1 Enable Common Advertising</a></li>
</ul>
</li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_SC_KEY_DERIVE">6 BLE LTK Generate BREDR Linkkey</a></li>
<li><a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_BOND">7 APP BLE Bond</a> <div style="page-break-after: always;"></div></li>
</ul>
<h2><a class="anchor" id="Rws_LE_App_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Rws_LE_App_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 BLE Link Number Configuration</a></li>
<li><a href="#figure_5_1">Figure 5-1 Enable Common Advertisement When Power On</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Rws_LE_App_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BLE  </td><td class="markdownTableBodyCenter">Bluetooth Low Energy   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">GAP  </td><td class="markdownTableBodyCenter">Generic Access Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">GATT  </td><td class="markdownTableBodyCenter">Generic Attribute Profile   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">GFPS  </td><td class="markdownTableBodyCenter">Google Fast Pair Service   </td></tr>
</table>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="AN008_APP_BLE_Module_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this application note is to give an overview of how to use BLE module in rws project. The source code will be introduced according to the following several parts:</p>
<ul>
<li>APP BLE GAP module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_GAP">2 APP BLE GAP</a></li>
<li>APP BLE service module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_SERVICE">3 APP BLE Service</a></li>
<li>AP BLE Device module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_DEVICE">4 APP BLE Device</a></li>
<li>APP BLE common advertisement module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_COMMON_ADV">5 APP BLE Common Advertising</a></li>
<li>APP BLE LTK generate BREDR link key module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_SC_KEY_DERIVE">6 BLE LTK Generate BREDR Linkkey</a></li>
<li>APP BLE BOND module will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_APP_BLE_BOND">7 APP BLE Bond</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_GAP"></a>
2 APP BLE GAP</h2>
<p>This section describes APP BLE GAP module. The reference file is shown in: sdk\src\sample\rws\app_ble_gap.c. This module is used to initialize GAP parameters and handle GAP message about connection status, device status and bond status, etc.</p><ul>
<li>GAP parameter initialize will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_PARAM_INIT">2.1 GAP Parameter Initialize</a></li>
<li>GAP message will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_MSG">2.2 GAP Message</a></li>
<li>APP BLE GAP initialize will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_GAP_INIT">2.3 APP BLE GAP Initialize</a></li>
</ul>
<h3><a class="anchor" id="AN008_GAP_PARAM_INIT"></a>
2.1 GAP Parameter Initialize</h3>
<p>GAP parameter initialize is fulfilled in app_ble_gap.c and function <a class="el" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init()</a> is used to initialize the GAP parameters. More information please refer to BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#BLE_STACK_Page">BLE Stack User Manual </a>.</p>
<h4><a class="anchor" id="AN008_DEVICE_NAME_AND_APPER_CFG"></a>
2.1.1 Device Name And Appearance Configuration</h4>
<ol type="1">
<li>Device Name <br />
<br />
 <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a> is used to set the device name in GAP service. If device name is set in advertising data or scan response data too, the device name set in advertising data or scan response data shall be the same with the value set in GAP service. Otherwise there may be an interoperability problem in them.<br />
 <br />
 1) Device name set in GAP service: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea1daa2b24ce87a7d0ca414d64f9d3838f">GAP_PARAM_DEVICE_NAME</a>, <a class="code" href="group___g_a_p___common___macros.html#gaf61e23036a464a4299b13309cb44b11d">GAP_DEVICE_NAME_LEN</a>, <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga25912cdaee636a3dfa7fc6df1e94bb5a">device_name_le</a>);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
<br />
 2) Device name set in scan response data: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga22fc5e8ca6953eb544ecedd25a90bca8">app_ble_gap_gen_scan_rsp_data</a>(uint8_t *p_scan_len, uint8_t *p_scan_data)</div><div class="line">{</div><div class="line">    uint8_t device_name_len;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (p_scan_len == <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || p_scan_data == <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    device_name_len = strlen((<span class="keyword">const</span> <span class="keywordtype">char</span> *)<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga25912cdaee636a3dfa7fc6df1e94bb5a">device_name_le</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (device_name_len &gt; <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#ga37b63a93bfde5eeca258a5fce04dc5f6">GAP_MAX_LEGACY_ADV_LEN</a> - 2)</div><div class="line">    {</div><div class="line">        device_name_len = <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___a_d_v___exported___macros.html#ga37b63a93bfde5eeca258a5fce04dc5f6">GAP_MAX_LEGACY_ADV_LEN</a> - 2;</div><div class="line">    }</div><div class="line"></div><div class="line">    p_scan_data[0] = device_name_len + 1;</div><div class="line">    p_scan_data[1] = <a class="code" href="group___a_d_v___d_a_t_a___t_y_p_e.html#ga73e43d425fe3ddbea114d87b2300c6a1">GAP_ADTYPE_LOCAL_NAME_COMPLETE</a>;</div><div class="line">    memcpy(&amp;p_scan_data[2], <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#ga25912cdaee636a3dfa7fc6df1e94bb5a">device_name_le</a>, device_name_len);</div><div class="line">    *p_scan_len = device_name_len + 2;</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___t_t_s___o_t_a___exported___functions.html#ga9cc1b5f72081250b45c8fe4d675334f3">app_ble_common_adv_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga22fc5e8ca6953eb544ecedd25a90bca8">app_ble_gap_gen_scan_rsp_data</a>(&amp;<a class="code" href="group___a_p_p___b_l_e___g_a_p.html#gaf79d883b90bf38f70f8787d9bd2b34b1">scan_rsp_data_len</a>, <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>);</div><div class="line"></div><div class="line">    <a class="code" href="group___b_l_e___e_x_t_e_n_d_e_d___a_d_v.html#ga7b8bcbea5cf112ca7c19ce757a89eeb0">ble_ext_adv_mgr_init_adv_params</a>(&amp;le_common_adv.adv_handle, adv_event_prop, adv_interval_min,</div><div class="line">                                    adv_interval_max, own_address_type, peer_address_type, peer_address,</div><div class="line">                                    filter_policy, 23 + data_len, app_ble_common_adv_data,</div><div class="line">                                    <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#gaf79d883b90bf38f70f8787d9bd2b34b1">scan_rsp_data_len</a>, <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga70462e89d6a5310e9ac4a03e25b7b5e3">scan_rsp_data</a>, le_random_addr);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> The permitted length of character string for Device Name is up to 40 bytes (including end mark) in BT Stack currently, so here the length of Device name defined is up to 40 bytes. If the string is longer than 40 bytes, it will be cut off. <div class="fragment"><div class="line"><span class="preprocessor">#define GAP_DEVICE_NAME_LEN           (39+1)</span></div></div><!-- fragment --> <br />
<br />
</li>
<li>Device Appearance <br />
<br />
 <a class="el" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a> is used to set the value of device appearance characteristic in GAP service. If device appearance is set in advertising data or scan response data too, the device appearance set in advertising data or scan response data shall be the same with the value set in GAP service. Otherwise there may be an interoperability problem in them. Device appearance is used to set the type of a device such as keyboard, mouse, thermometer, blood pressure meter, etc.<br />
 <br />
 1) Device appearance set in GAP service: <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga8fe79c2cf7435464c3e4d798a377fc79">le_set_gap_param</a>(<a class="code" href="group___g_a_p___l_e___exported___types.html#gga8ff0df4d4e94d9f086dce618d8d6a11ea368c1865af7fe27fd3b538334f65ef24">GAP_PARAM_APPEARANCE</a>, <span class="keyword">sizeof</span>(appearance), &amp;appearance);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="AN008_CFG_BOND_MANAGER_PARAM"></a>
2.1.2 Configure Bond Manager Parameters</h4>
<p>Bond manager parameters which can be configured by customers are listed below:</p><ol type="1">
<li><a class="el" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init()</a> set BLE bond parameters. <br />
<br />
 <div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="comment">// Setup the GAP Bond Manager</span></div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82abfccdc4864e8ac86cf8854b615dc597b">GAP_PARAM_BOND_FIXED_PASSKEY</a>, <span class="keyword">sizeof</span>(uint32_t), &amp;passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82aaa621c00cd637e65b83b048e99df184f">GAP_PARAM_BOND_FIXED_PASSKEY_ENABLE</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;use_fixed_passkey);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82ac67d75eb0faafe63c934c0f97aeebbb3">GAP_PARAM_BOND_SEC_REQ_ENABLE</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;sec_req_enable);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga18c6bca7b79d75bae12c3d4e73304606">le_bond_set_param</a>(<a class="code" href="group___g_a_p___l_e___b_o_n_d___m_a_n_a_g_e_r___exported___types.html#gga440dc453d051aeef569a5861c0f66b82a67273a2271e0a6826ac4bf27d59a4757">GAP_PARAM_BOND_SEC_REQ_REQUIREMENT</a>, <span class="keyword">sizeof</span>(uint16_t), &amp;sec_req_requirement);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --> <br />
<br />
</li>
<li><a class="el" href="group___s_p_p___d_e_m_o___m_a_i_n.html#ga475d55a0a331f1115e2986d39109f327">app_bt_gap_init()</a> set BLE and BR common bond parameters. <br />
<br />
 <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="group___s_p_p___d_e_m_o___m_a_i_n.html#ga475d55a0a331f1115e2986d39109f327">app_bt_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2ac1e0ac58313c76368f83ea15c17dfebc">GAP_PARAM_BOND_PAIRING_MODE</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;pair_mode);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a4caada923b034620e0692e3b5cc0d1c2">GAP_PARAM_BOND_AUTHEN_REQUIREMENTS_FLAGS</a>, <span class="keyword">sizeof</span>(uint16_t), &amp;auth_flags);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a85b5072df10e518def21aeca3d78e22a">GAP_PARAM_BOND_IO_CAPABILITIES</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;io_cap);</div><div class="line">    <a class="code" href="group___g_a_p___c_o_m_m_o_n___e_x_p_o_r_t___functions.html#ga7a7eae87166f80b6d5f17b2ce42fa049">gap_set_param</a>(<a class="code" href="group___g_a_p___common___exported___types.html#gga6b5a306a5b8edce2b24cc7c6019073a2a2c6acd9336a3701fe2d0108e7e2478b1">GAP_PARAM_BOND_OOB_ENABLED</a>, <span class="keyword">sizeof</span>(uint8_t), &amp;oob_enable);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<h4><a class="anchor" id="AN008_INIT_BLE_LINKs"></a>
2.1.3 Initialize BLE Link</h4>
<p>BLE link number can be configured in mcu cfg tool. LE link number = LE master link + LE slave link umber </p><div class="image">
<img src="ble_link_number_cfg.png" alt="ble_link_number_cfg.png" width="1000px" height="600px"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 BLE Link Number Configuration </b></div></center><p>le_gap_init(link_num) is used to initialize BLE link number: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    uint8_t supported_max_le_link_num = <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga13f6449e757dab08b87c3f08a855d1a5">le_get_max_link_num</a>();</div><div class="line">    uint8_t link_num = ((<a class="code" href="group___a_p_p___l_i_n_k.html#ga9875ca18a9c76318637e0df3774093ed">MAX_BLE_LINK_NUM</a> &lt;= supported_max_le_link_num) ? <a class="code" href="group___a_p_p___l_i_n_k.html#ga9875ca18a9c76318637e0df3774093ed">MAX_BLE_LINK_NUM</a> :</div><div class="line">                        supported_max_le_link_num);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga308e6c9213b6f1f6168e7dc729939cfd">le_gap_init</a>(link_num);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="AN008_CFG_SCAN_PARAM"></a>
2.1.4 Configure Scan Parameters</h4>
<p>Scan parameters can be set in <a class="el" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init()</a>: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga067a652a0b11b928f33f7e233ff861b7">app_ble_gap_param_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4facbf1ba953c01fb4fccb46bcd4f84891b">GAP_PARAM_EXT_SCAN_LOCAL_ADDR_TYPE</a>, <span class="keyword">sizeof</span>(own_address_type),</div><div class="line">                          &amp;own_address_type);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4fa688295e8feae3b46f0e4a79063db38e7">GAP_PARAM_EXT_SCAN_PHYS</a>, <span class="keyword">sizeof</span>(scan_phys),</div><div class="line">                          &amp;scan_phys);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4fa685c853ccee6f682336f7824dd82aa67">GAP_PARAM_EXT_SCAN_DURATION</a>, <span class="keyword">sizeof</span>(ext_scan_duration),</div><div class="line">                          &amp;ext_scan_duration);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4fa4851f4fa3c5297663c3c51b77276e87f">GAP_PARAM_EXT_SCAN_PERIOD</a>, <span class="keyword">sizeof</span>(ext_scan_period),</div><div class="line">                          &amp;ext_scan_period);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4fa5c326e089cdf8ac9574b5199bd4d7084">GAP_PARAM_EXT_SCAN_FILTER_POLICY</a>, <span class="keyword">sizeof</span>(scan_filter_policy),</div><div class="line">                          &amp;scan_filter_policy);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#gad37022012618944b4712b321d9314d1a">le_ext_scan_set_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#gga4c6079409f1265c1f29946b1c021df4fa118bfd93fc98fd364a6ab687348979be">GAP_PARAM_EXT_SCAN_FILTER_DUPLICATES</a>, <span class="keyword">sizeof</span>(scan_filter_duplicate),</div><div class="line">                          &amp;scan_filter_duplicate);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___functions.html#ga349e844854b0341ec15be10cbf40c308">le_ext_scan_set_phy_param</a>(<a class="code" href="group___g_a_p___l_e___e_x_t_e_n_d_e_d___s_c_a_n___exported___types.html#ggaa4a33bab9888ceb9b558f7496285f5afae8a6f1d7abcceae3e064aa5bd2d0141a">LE_SCAN_PHY_LE_1M</a>, &amp;extended_scan_param[0]);</div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><p>More information please reference BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#GAP_Parameters_Initialization">2.2.1 GAP Parameters Initialization</a>.</p>
<h3><a class="anchor" id="AN008_GAP_MSG"></a>
2.2 GAP Message</h3>
<p>All the BLE GAP message events are pre-handled in <a class="el" href="group___a_p_p___b_l_e___g_a_p.html#ga74db254007c7fbbe873ed69ab0fdd61b">app_ble_gap_handle_gap_msg()</a> function. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga74db254007c7fbbe873ed69ab0fdd61b">app_ble_gap_handle_gap_msg</a>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *p_io_msg)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (p_io_msg-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a>)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gae9874bb97b4d115932f5f124be42ad92">GAP_MSG_LE_DEV_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_ble_gap_handle_dev_state_change_evt(stack_msg.msg_data.gap_dev_state_change.new_state,</div><div class="line">                                                    stack_msg.msg_data.gap_dev_state_change.cause);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#ga3937cafa580489feee23b58296957e01">GAP_MSG_LE_CONN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_ble_gap_handle_new_conn_state_evt(stack_msg.msg_data.gap_conn_state_change.conn_id,</div><div class="line">                                                  (<a class="code" href="group___gap___msg___exported___macros.html#gae236f1ba42a45ef51d2178ffa9acc44e">T_GAP_CONN_STATE</a>)stack_msg.msg_data.gap_conn_state_change.new_state,</div><div class="line">                                                  stack_msg.msg_data.gap_conn_state_change.disc_cause);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gad09d9df87275d5f64d9b1885af179800">GAP_MSG_LE_CONN_MTU_INFO</a>:</div><div class="line">        {</div><div class="line">            app_ble_gap_handle_mtu_info(stack_msg.msg_data.gap_conn_mtu_info.conn_id, </div><div class="line">                                        stack_msg.msg_data.gap_conn_mtu_info.mtu_size);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___g_a_p___m_s_g___t_y_p_e.html#gaf4e6edb01c279d7966d8114ad2f55437">GAP_MSG_LE_AUTHEN_STATE_CHANGE</a>:</div><div class="line">        {</div><div class="line">            app_ble_gap_handle_authen_state_evt(stack_msg.msg_data.gap_authen_state.conn_id,</div><div class="line">                                                stack_msg.msg_data.gap_authen_state.new_state,</div><div class="line">                                                stack_msg.msg_data.gap_authen_state.status);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>More detail please reference BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Message">2.3 Bluetooth LE GAP Message</a>.</p>
<h3><a class="anchor" id="AN008_GAP_INIT"></a>
2.3 APP BLE GAP Initialize</h3>
<p><a class="el" href="group___a_p_p___b_l_e___g_a_p.html#ga5e597c87be17364dd4b7225dfa597861">app_ble_gap_init</a> is used to initialize modules used for GAP. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___g_a_p.html#ga5e597c87be17364dd4b7225dfa597861">app_ble_gap_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___b_t___b_t_m.html#gad5518472fde08b8e93d5fc9c40d72f85">bt_mgr_cback_register</a>(app_ble_gap_bt_cback);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___c_o_m_m_o_n___exported___functions.html#ga48e57db7a1bf19a362dd2190bc69dbec">le_register_app_cb</a>(app_ble_gap_cb);</div><div class="line">    app_ble_rand_addr_init();</div><div class="line">    app_ble_gap_ble_mgr_init();</div><div class="line"></div><div class="line">    <a class="code" href="group___o_s__87x3e___queue.html#gace09f1bc91cf55ef47b9c31109709947">os_queue_init</a>(&amp;white_list_op_q);</div><div class="line">    gap_register_vendor_cb(app_ble_gap_vendor_callback);</div><div class="line"><span class="preprocessor">#if F_APP_SC_KEY_DERIVE_SUPPORT</span></div><div class="line">    app_ble_key_derive_init();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><ol type="1">
<li><b>bt_mgr_cback_register:</b> <br />
 if some operations in GAP depends on <a class="el" href="group___b_t___b_t_m.html#ga60f938d2fe9ea1ac81e1bf400fbb5b03">T_BT_EVENT</a>,we shall use <a class="el" href="group___b_t___b_t_m.html#gad5518472fde08b8e93d5fc9c40d72f85">bt_mgr_cback_register</a> to register bt manager callback function. <br />
<br />
</li>
<li><b>le_register_app_cb:</b> <br />
 register GAP Callback function,The execution result of the asynchronous API is notified to the APP in the form of GAP Callback. More details please reference BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_GAP_Callback">2.4 Bluetooth LE GAP Callback</a> <br />
<br />
</li>
<li><b>app_ble_rand_addr_init:</b> <br />
 used to initialize ble random address manager module. <br />
<br />
</li>
<li><b>app_ble_gap_ble_mgr_init:</b> <br />
 used to initialize ble manager module. <br />
<br />
</li>
<li><b>app_ble_key_derive_init:</b> <br />
 used to initialize BLE LTK derive to BREDR LinkKey module.</li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_SERVICE"></a>
3 APP BLE Service</h2>
<p>This section describes APP BLE service module. The reference file is shown as follows: sdk\src\sample\rws\app_ble_service.c. <br />
This module is used to initialize BLE services and register BLE service callback functions.</p>
<h3><a class="anchor" id="AN008_INIT_BLE_SERVICE"></a>
3.1 Initialize BLE Services</h3>
<p>All BLE services are initialized in <a class="el" href="group___a_p_p___b_l_e___s_e_r_v_i_c_e___exported___functions.html#ga721aeeec02f1c42a4d1f9558688cbf2a">app_ble_service_init()</a>.<br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___s_e_r_v_i_c_e___exported___functions.html#ga721aeeec02f1c42a4d1f9558688cbf2a">app_ble_service_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint8_t server_num = 4;</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if F_APP_GATT_SERVER_EXT_API_SUPPORT</span></div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga6102ff8d3ad404ebecd3c5cf416a9fa6">server_cfg_use_ext_api</a>(<span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_ble_service_init: server_cfg_use_ext_api true&quot;</span>);</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___e_x_t___exported___functions.html#ga83fd5e5ad43a838a18bf21b122bcc263">server_ext_register_app_cb</a>(app_ble_service_general_srv_cb);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___exported___functions.html#ga2fcbc3f5f19d9fdfb3e48923145e98f4">server_register_app_cb</a>(app_ble_service_general_srv_cb);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if (F_APP_TMAP_CT_SUPPORT || F_APP_TMAP_UMR_SUPPORT || F_APP_TMAP_BMR_SUPPORT)</span></div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(server_num + MAX_BLE_SRV_NUM);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(server_num);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    ......</div><div class="line"></div><div class="line">    <a class="code" href="group___t_r_a_n_s_m_i_t___s_e_r_v_i_c_e___exported___functions.html#gad39f7db5f214ae72b55c6515cfa08130">transmit_srv_add</a>(app_ble_service_transmit_srv_cb);</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a3a435c9f3adb75b4362a3122066505d7">rtk_app_adv_support</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___functions.html#ga268c37e35bb34b56ed9d284c647bde6a">ota_add_service</a>(app_ble_service_ota_srv_cb);</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_BT_POLICY</span></div><div class="line">    teams_bas_id = <a class="code" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a>(app_ble_service_bas_srv_cb);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <a class="code" href="group___b_a_s___exported___functions.html#ga718af7cba22ef1b332212967d11b0504">bas_add_service</a>(app_ble_service_bas_srv_cb);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <a class="code" href="group___d_i_s___exported___functions.html#ga6a9d465b3db427a7cc2f17b97f28d3e3">dis_add_service</a>(app_ble_service_dis_srv_cb);<span class="comment">//Add for GFPS</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a46117c521390d0cab29f57edcc6eb706">xiaoai_support</a>)</div><div class="line">    {</div><div class="line">        xiaoai_ble_service_add_service(app_ble_service_xm_srv_cb);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_XIAOWEI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a7997528396bc811509ec031629c310b0">xiaowei_support</a>)</div><div class="line">    {</div><div class="line">        app_xiaowei_init();</div><div class="line">        xiaowei_ble_service_add_service(app_ble_service_xiaowei_srv_cb);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_TUYA_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a03d1aa57ee6e16957a0376a774a4a176">tuya_support</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_u_y_a___service___exported___functions.html#ga79a66a73998f4dddc50965fcc328eac3">app_tuya_ble_service_add_service</a>(app_ble_service_tuya_srv_cb);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_LOCAL_PLAYBACK_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a8eae190c23f4061194ec265b2d0030fc">local_playback_support</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___p_l_a_y_b_a_c_k___s_e_r_v_i_c_e___exported___functions.html#gad711aa415be281ab06c42634633dbff9">playback_add_service</a>(app_ble_service_playback_srv_cb);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_CFU_BLE_CHANNEL_SUPPORT</span></div><div class="line">    <a class="code" href="group___h_i_d_s___exported___functions.html#ga6d17071c9e7e0fd5310a575629fad8c7">hids_add_service</a>(app_ble_service_hids_cfu_srv_cb);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_FEATURE_SUPPORT</span></div><div class="line">    <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#ga51bdf4d897b9df15b4c62b4a5bfbad15">app_asp_device_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___t_e_a_m_s___h_i_d.html#ga1d58c67a512207a3cb07f1106caf7975">app_teams_hid_init</a>();</div><div class="line">    <a class="code" href="group___a_p_p___t_e_a_m_s___u_t_i_l.html#ga9f915a1e0f05c5153dd225815207755a">app_teams_util_init</a>();</div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_TEAMS_BT_POLICY</span></div><div class="line">    app_teams_ext_ftl_init();</div><div class="line">    app_teams_bt_policy_init();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if BT_GATT_CLIENT_SUPPORT</span></div><div class="line">    asp_add_service(app_ble_service_asp_gatt_srv_cb);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    asps_add_service(app_ble_service_asp_srv_cb);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_USB_AUDIO_SUPPORT</span></div><div class="line">    teams_util_init(app_hid_interrupt_in, <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#gaf81b56a8eb78c1004933b95d67ae978b">app_asp_device_send_pkt_by_ble</a>);</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    teams_util_init(<a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="group___a_p_p___a_s_p___d_e_v_i_c_e.html#gaf81b56a8eb78c1004933b95d67ae978b">app_asp_device_send_pkt_by_ble</a>);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> != <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a673a27baaad47fd731a4458b2250a6a6">REMOTE_SESSION_ROLE_SINGLE</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___t_e_a_m_s___r_w_s.html#ga7bc950cef5f9b04816c143918b0fa3ba">app_teams_rws_init</a>();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_FINDMY_FEATURE_SUPPORT</span></div><div class="line">    app_findmy_init();</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> != <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a673a27baaad47fd731a4458b2250a6a6">REMOTE_SESSION_ROLE_SINGLE</a>)</div><div class="line">    {</div><div class="line">        app_findmy_relay_init();</div><div class="line">    }</div><div class="line">    app_findmy_adv_init();</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">// add new service here</span></div><div class="line"></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><ol type="1">
<li>server_init(service_num):<br />
 Initialize ble service number and if more ble service are added, you need to modify service_num. Each time a new service is added, service_num needs to be incremented by one. <br />
<br />
</li>
<li>transmit_srv_add(app_ble_service_transmit_srv_cb):<br />
 Add transmit service and register callback function app_ble_service_transmit_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>ota_add_service(app_ble_service_ota_srv_cb):<br />
 Add ota service and register callback function app_ble_service_ota_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>bas_add_service(app_ble_service_bas_srv_cb):<br />
 Add battery service and register callback function app_ble_service_bas_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>dis_add_service(app_ble_service_dis_srv_cb):<br />
 Add device information service and register callback function app_ble_service_dis_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>xiaoai_ble_service_add_service(app_ble_service_xm_srv_cb):<br />
 add xiaoai service and register callback function app_ble_service_xm_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>playback_add_service(app_ble_service_playback_srv_cb):<br />
 add play back service and register callback function app_ble_service_playback_srv_cb() to the BLE stack database. <br />
<br />
</li>
<li>hids_add_service(app_ble_service_hids_cfu_srv_cb):<br />
 add hid service and register callabck function app_ble_service_hids_cfu_srv_cb() to the BLE stack database.</li>
</ol>
<p>More details please reference BLE Stack User Manual <a class="el" href="_u_m018__b_l_e__s_t_a_c_k__u_s_e_r__m_a_n_u_a_l.html#Bluetooth_LE_Profile_Server">3.1 Bluetooth LE Profile Server</a></p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_DEVICE"></a>
4 APP BLE Device</h2>
<p>This section describes app ble device module. The reference file is shown as follows: sdk\src\sample\rws\app_ble_device.c. This module is used to handle interaction between ble and other module.</p><ul>
<li>Device factory reset will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_FACTORT_RESET">4.1 Device Factory Reset</a></li>
<li>Device power on will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_POWER_ON">4.2 Device Power On</a></li>
<li>Device power off will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_POWER_OFF">4.3 Device Power Off</a></li>
<li>Radio mode state will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_RADIO_MODE">4.4 Radio Mode</a></li>
<li>Role swap state will be introduced in chapter <a class="el" href="_a_n008__a_p_p__b_l_e__m_o_d_u_l_e.html#AN008_ROLE_SWAP">4.5 Role Swap</a></li>
</ul>
<h3><a class="anchor" id="AN008_FACTORT_RESET"></a>
4.1 Device Factory Reset</h3>
<p>when factory reset, use <a class="el" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a">le_bond_clear_all_keys()</a> to clear bond keys in local and use app_gfps_device_handle_factory_reset() to clear gfps keys.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#ga030971602827b277eb919083cd20cdd5">app_ble_device_handle_factory_reset</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_ble_device_handle_factory_reset&quot;</span>);</div><div class="line">    <a class="code" href="group___g_a_p___l_e___b_o_n_d_m_g_r___exported___functions.html#ga1a29c96edc887066d6b68a9d5ab4da7a">le_bond_clear_all_keys</a>();</div><div class="line"><span class="preprocessor">#if GFPS_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#aa5c34de29a6f97fb5b8ab593a5e9e48e">gfps_support</a>)</div><div class="line">    {</div><div class="line">        app_gfps_device_handle_factory_reset();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">}</span></div></div><!-- fragment --><h3><a class="anchor" id="AN008_POWER_ON"></a>
4.2 Device Power On</h3>
<p>when power on the BLE module will do the following processing:</p><ul>
<li>app_gfps_device_handle_power_on(): start gfps advertisement when power on.</li>
<li>app_ama_accessory_handle_power_on(): start ama advertisement when power on.</li>
<li>app_xiaoai_handle_power_on(): start xiaoai advertisement when power on.</li>
<li>app_bisto_handle_power_on(): start bisto advertisement when power on.</li>
<li><a class="el" href="group___a_p_p___b_l_e___s_w_i_f_t___p_a_i_r___exported___functions.html#ga5fcab10dd4c12e2dabea7652ece44444">app_swift_pair_handle_power_on()</a>: start swift pair advertisement when power on.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#ga52ae27f4a737b9bc43dcf8d39ea777ef">app_ble_device_handle_power_on</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ......</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a3a435c9f3adb75b4362a3122066505d7">rtk_app_adv_support</a> &amp;&amp; (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> == <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a673a27baaad47fd731a4458b2250a6a6">REMOTE_SESSION_ROLE_SINGLE</a>))</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#gad6e5db9c624748429aa0c68114134bd2">app_ble_device_handle_power_on_rtk_adv</a>();</div><div class="line">    }</div><div class="line"></div><div class="line"><span class="preprocessor">#if GFPS_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#aa5c34de29a6f97fb5b8ab593a5e9e48e">gfps_support</a>)</div><div class="line">    {</div><div class="line">        app_gfps_device_handle_power_on(is_pairing);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if AMA_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#ae13eaf15d63f91b6a3f7eaaa54c05ce6">ama_support</a>)</div><div class="line">    {</div><div class="line">        app_ama_accessory_handle_power_on(is_pairing);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a46117c521390d0cab29f57edcc6eb706">xiaoai_support</a>)</div><div class="line">    {</div><div class="line">        app_xiaoai_handle_power_on(is_pairing);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if BISTO_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a149d732d348fe9a626ef5cdac754aaa8">bisto_support</a>)</div><div class="line">    {</div><div class="line">        app_bisto_handle_power_on(is_pairing);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_BLE_SWIFT_PAIR_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.swift_pair_support)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___b_l_e___s_w_i_f_t___p_a_i_r___exported___functions.html#ga5fcab10dd4c12e2dabea7652ece44444">app_swift_pair_handle_power_on</a>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a71d58ed9614e9047d3f404ad947ee670">timer_swift_pair_adv_timeout</a> * 100);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="AN008_POWER_OFF"></a>
4.3 Device Power Off</h3>
<p>when power off the BLE module will do the following processing:</p><ul>
<li><a class="el" href="group___a_p_p___b_l_e___t_t_s___exported___functions.html#gaef7bab0ec6712949f0c5623e27fadbc7">app_tts_handle_power_off()</a>: stop tts advertisement</li>
<li>app_gfps_device_handle_power_off(): stop gfps advertisement.</li>
<li>app_ama_accessory_handle_power_off(): stop ama advertisement.</li>
<li>app_xiaoai_handle_power_off(): stop xiaoai advertisement.</li>
<li><a class="el" href="group___a_p_p___b_l_e___s_w_i_f_t___p_a_i_r___exported___functions.html#ga223a3025232ca2986d7224f35740fe85">app_swift_pair_handle_power_off()</a>: stop swift pair advertisement.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#ga81b43fde62cb8f2e9203cfd83875a6d8">app_ble_device_handle_power_off</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if F_APP_TTS_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a7c9456a3acae54ac7fd4fc3c43c8ec76">tts_support</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___b_l_e___t_t_s___exported___functions.html#gaef7bab0ec6712949f0c5623e27fadbc7">app_tts_handle_power_off</a>();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if GFPS_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#aa5c34de29a6f97fb5b8ab593a5e9e48e">gfps_support</a>)</div><div class="line">    {</div><div class="line">        app_gfps_device_handle_power_off();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if AMA_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#ae13eaf15d63f91b6a3f7eaaa54c05ce6">ama_support</a>)</div><div class="line">    {</div><div class="line">        app_ama_accessory_handle_power_off();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a46117c521390d0cab29f57edcc6eb706">xiaoai_support</a>)</div><div class="line">    {</div><div class="line">        app_xiaoai_handle_power_off();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if F_APP_BLE_SWIFT_PAIR_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.swift_pair_support)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___b_l_e___s_w_i_f_t___p_a_i_r___exported___functions.html#ga223a3025232ca2986d7224f35740fe85">app_swift_pair_handle_power_off</a>();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ......</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="AN008_RADIO_MODE"></a>
4.4 Radio Mode</h3>
<p>when radio mode was changed the BLE module will do the following processing:</p><ul>
<li>app_gfps_handle_radio_mode(): handle gfps status when radio mode changed.</li>
<li>app_ama_handle_radio_mode(): handle ama status when radio mode changed.</li>
<li>app_xiaoai_handle_radio_mode(): handle xiaoai status when radio mode changed.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#ga08115b931d71c5880f0693f0ac014425">app_ble_device_handle_radio_mode</a>(<a class="code" href="group___b_t___b_t_m.html#ga1818d1a704113dd1b95741dd60754e77">T_BT_DEVICE_MODE</a> radio_mode)</div><div class="line">{</div><div class="line">    ......</div><div class="line"><span class="preprocessor">#if GFPS_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#aa5c34de29a6f97fb5b8ab593a5e9e48e">gfps_support</a>)</div><div class="line">    {</div><div class="line">        app_gfps_device_handle_radio_mode(radio_mode);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if AMA_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#ae13eaf15d63f91b6a3f7eaaa54c05ce6">ama_support</a>)</div><div class="line">    {</div><div class="line">        app_ama_handle_radio_mode(radio_mode);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a46117c521390d0cab29f57edcc6eb706">xiaoai_support</a>)</div><div class="line">    {</div><div class="line">        app_xiaoai_handle_radio_mode(radio_mode);</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">......</div><div class="line">}</div></div><!-- fragment --><p>when device enter into pairing mode the BLE module will do the following processing:</p><ul>
<li>app_xiaoai_handle_enter_pair_mode(): start xiaoai advertisement when device enter into pair mode.</li>
<li>app_ama_accessory_handle_enter_pair_mode(): start ama advertisement when device enter into pair mode.</li>
<li>app_bisto_handle_enter_pair_mode(): start bisto advertisement when device enter into pair mode.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#gafac56c8408e8d8b3784ac949a5ee732b">app_ble_device_handle_enter_pair_mode</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line"><span class="preprocessor">#if XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a46117c521390d0cab29f57edcc6eb706">xiaoai_support</a>)</div><div class="line">    {</div><div class="line">        app_xiaoai_handle_enter_pair_mode();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if AMA_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#ae13eaf15d63f91b6a3f7eaaa54c05ce6">ama_support</a>)</div><div class="line">    {</div><div class="line">        app_ama_accessory_handle_enter_pair_mode();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if BISTO_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a149d732d348fe9a626ef5cdac754aaa8">bisto_support</a>)</div><div class="line">    {</div><div class="line">        app_bisto_handle_enter_pair_mode();</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a3a435c9f3adb75b4362a3122066505d7">rtk_app_adv_support</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#gad6e5db9c624748429aa0c68114134bd2">app_ble_device_handle_power_on_rtk_adv</a>();</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="AN008_ROLE_SWAP"></a>
4.5 Role Swap</h3>
<p>When device do role swap action the BLE module will do the following processing:</p><ul>
<li>app_gfps_device_handle_role_swap(): handle gfps advertisement.</li>
<li><a class="el" href="group___a_p_p___r_w_s___a_m_a.html#gac086f3a77d21513e98181446e2403d93">app_ama_roleswap_handle_role_swap_success()</a>: handle ama advertisement.</li>
<li>app_xiaoai_handle_role_swap_success(): handle xiaoai advertisement.</li>
<li>app_bisto_roleswap_success(): handle bisto advertisement.</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___d_e_v_i_c_e___exported___functions.html#ga64932818364d78449894e9700196b30b">app_ble_device_handle_role_swap</a>(<a class="code" href="structt__bt__event__param__remote__roleswap__status.html">T_BT_EVENT_PARAM_REMOTE_ROLESWAP_STATUS</a> *p_role_swap_status)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (p_role_swap_status-&gt;<a class="code" href="structt__bt__event__param__remote__roleswap__status.html#a2cf51452400d22b0434898e88d08f082">status</a> == BTM_ROLESWAP_STATUS_SUCCESS)</div><div class="line">    {</div><div class="line">        ......</div><div class="line">        app_gfps_device_handle_role_swap(p_role_swap_status-&gt;<a class="code" href="structt__bt__event__param__remote__roleswap__status.html#aa4da486d94d25b2bd40800bde19c9af7">device_role</a>);</div><div class="line">        ......</div><div class="line">        <a class="code" href="group___a_p_p___r_w_s___a_m_a.html#gac086f3a77d21513e98181446e2403d93">app_ama_roleswap_handle_role_swap_success</a>(p_role_swap_status-&gt;<a class="code" href="structt__bt__event__param__remote__roleswap__status.html#aa4da486d94d25b2bd40800bde19c9af7">device_role</a>);</div><div class="line">        ......</div><div class="line">        app_xiaoai_handle_role_swap_success(p_role_swap_status-&gt;<a class="code" href="structt__bt__event__param__remote__roleswap__status.html#aa4da486d94d25b2bd40800bde19c9af7">device_role</a>);</div><div class="line">        ......</div><div class="line">        app_bisto_roleswap_success(p_role_swap_status-&gt;<a class="code" href="structt__bt__event__param__remote__roleswap__status.html#aa4da486d94d25b2bd40800bde19c9af7">device_role</a>);</div><div class="line">        ......</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_COMMON_ADV"></a>
5 APP BLE Common Advertising</h2>
<p>The purpose of this advertising is to establish a BLE connection with RTK's Audio Connect APP. when BLE Link established you can use Audio Connect APP to perform OTA, EQ parameter setting and other operations. Project source code directory: sdk\src\sample\rws\app_ble_common_adv.c.</p>
<h3><a class="anchor" id="AN008_ENABLE_COMMON_ADV"></a>
5.1 Enable Common Advertising</h3>
<p>APP can enable common advertising in McuConfigTool. More details please reference BLE Extended Advertising Manager User Manual <a class="el" href="_u_m020__b_l_e__e_x_t_e_n_d_e_d__a_d_v_e_r_t_i_s_i_n_g__m_a_n_a_g_e_r.html#BLEExtAdvertisingManager_Page">BLE Extended Advertising Manager User Manual </a>. </p><div class="image">
<img src="enable_common_adv.png" alt="enable_common_adv.png" width="1000px" height="600px"/>
</div>
 <center><div id="figure_5_1"><b>Figure 5-1 Enable Common Advertisement When Power On </b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_SC_KEY_DERIVE"></a>
6 BLE LTK Generate BREDR Linkkey</h2>
<p>If both the local and remote devices support Secure Connections over the LE transport, then the devices may use LE LTK generate the BR/EDR LinkKey. Project source code directory: sdk\src\sample\rws\app_ble_sc_key_derive.c.</p>
<p>Enable this function in rws project: </p><div class="fragment"><div class="line"><span class="preprocessor">#define F_APP_SC_KEY_DERIVE_SUPPORT         1</span></div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="AN008_APP_BLE_BOND"></a>
7 APP BLE Bond</h2>
<p>This module is used to sync BLE bond information between primary ear and secondary ear. Project source code directory: sdk\src\sample\rws\app_ble_bond.c </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
