<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="AMA_Page"></a>
AMA Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.0.0.2</b></center><p><br />
 </p><center><b>2022/08/15</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="AMA_DOC_rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2021/11/26  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.2  </td><td class="markdownTableBodyCenter">2022/08/15  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n111__a_m_a.html#AMA_DOC_rev">Revision History</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#AMA_Table_List">Table List</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#AMA_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#AMA_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Environment_Configuration">1 Environment Configuration</a><ul>
<li><a class="el" href="_a_n111__a_m_a.html#Enable_AMA">1.1 Enable AMA</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Assign_the_key_for_AMA">1.2 Assign the key for AMA</a></li>
</ul>
</li>
<li><a class="el" href="_a_n111__a_m_a.html#Hardware_wiring">2 Hardware wiring</a><ul>
<li><a class="el" href="_a_n111__a_m_a.html#Connect_I2C_interfaces_assigned_to_CP_chip">2.1 Connect I2C interfaces assigned to CP chip</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Connect_Microphone_and_Jumper_as_The_Picture_below">2.2 Connect Microphone and Jumper as The Picture below</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#jump_for_the_key_assigned_for_AMA">2.3 jump for the key assigned for AMA</a></li>
</ul>
</li>
<li><a class="el" href="_a_n111__a_m_a.html#Firmware_Configuration_for_AMA">3 Firmware Configuration for AMA</a><ul>
<li><a class="el" href="_a_n111__a_m_a.html#Add_AMA_Files">3.1 Add AMA Files</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Macro_for_AMA_Feature">3.2 Macro for AMA Feature</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Main_Settings_for_AMA_Device">3.3 Main Settings for AMA Device</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Choose_the_preference_initial_transport_for_IOS">3.4 Choose the preference/initial transport for IOS</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Other_settings_in_BLE_advertisement_data">3.5 Other settings in BLE advertisement data</a></li>
</ul>
</li>
<li><a class="el" href="_a_n111__a_m_a.html#Source_Code_File_Introduction">4 Source Code File Introduction</a><ul>
<li><a class="el" href="_a_n111__a_m_a.html#Basic_Building_Blocks">4.1 Basic Building Blocks</a></li>
<li><a class="el" href="_a_n111__a_m_a.html#Flow_of_Speech_Recognition">4.2 Flow of Speech Recognition</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AMA_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AMA_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 enable AMA in MCU Config Tool</a></li>
<li><a href="#figure_1_2">Figure 1-2 checkbox for iAP</a></li>
<li><a href="#figure_1_3">Figure 1-3 assign pin for CP chip</a></li>
<li><a href="#figure_1_4">Figure 1-4 assign P2_4 and P2_5 for KEY1 and KEY2</a></li>
<li><a href="#figure_2_1">Figure 2-1 connect CP chip on eval board</a></li>
<li><a href="#figure_2_2">Figure 2-2 MIC and its jumper on eval board</a></li>
<li><a href="#figure_3_1">Figure 3-1 AMA source files</a></li>
<li><a href="#figure_3_2">Figure 3-2 header files for ama library</a></li>
<li><a href="#figure_3_3">Figure 3-3 ama.lib</a></li>
<li><a href="#figure_4_1">Figure 4-1 basic building blocks for AMA</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="AMA_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">AMA  </td><td class="markdownTableBodyCenter">Alexa Mobile Accessory   </td></tr>
</table>
<div style="page-break-after: always;"></div><p> <style>div.image img[src="enable_AMA_functionality.png"]{width:500px;}
                           img[src="IAP_checkbox.png"]{width:500px;}
                           img[src="I2C_pin_assigned_for_CP_chip.png"]{width:500px;}
                           img[src="assign_P2_4_and_P2_5_for_KEY1_and_KEY2.png"]{width:500px;}
                           img[src="assign_Alexa_Wakeword(0xB0)_for_key 2.png"]{width:500px;}
                           img[src="connect_CP_chip.png"]{width:500px;}
                           img[src="MIC_and_jumper.png"]{width:500px;}

</style> </p>
<h2><a class="anchor" id="Environment_Configuration"></a>
1 Environment Configuration</h2>
<p>To use the AMA service, a 'Alexa' application should be installed on user's phone. The app is available on both Android and iOS. User's can install it from corresponding application store of the phone.</p>
<h3><a class="anchor" id="Enable_AMA"></a>
1.1 Enable AMA</h3>
<p>You can enable AMA by the checkbox. AMA ID is an identifier dispatched by amazon for produce manufactor. </p><div class="image">
<img src="enable_AMA_functionality.png" alt="enable_AMA_functionality.png"/>
<div class="caption">
Figure 1-1 enable AMA in MCU Config Tool</div></div>
<p>. For IAP transport, IAP switch on HW Feature page should be chosen and CP chip pin should also be assigned. </p><div class="image">
<img src="IAP_checkbox.png" alt="IAP_checkbox.png"/>
<div class="caption">
Figure 1-2 checkbox for iAP</div></div>
<p>. </p><div class="image">
<img src="I2C_pin_assigned_for_CP_chip.png" alt="I2C_pin_assigned_for_CP_chip.png"/>
<div class="caption">
Figure 1-3 assign pin for CP chip</div></div>
<p>.</p>
<h3><a class="anchor" id="Assign_the_key_for_AMA"></a>
1.2 Assign the key for AMA</h3>
<p>You should assign the pin for a key and associate a mmi with the key. </p><div class="image">
<img src="assign_P2_4_and_P2_5_for_KEY1_and_KEY2.png" alt="assign_P2_4_and_P2_5_for_KEY1_and_KEY2.png"/>
<div class="caption">
Figure 1-4 assign P2_4 and P2_5 for KEY1 and KEY2</div></div>
<p>. </p><div class="image">
<img src="assign_Alexa_Wakeword_for_key_2.png" alt="assign_Alexa_Wakeword_for_key_2.png"/>
<div class="caption">
Figure 1-5 assign Alexa Wakeword for key 2</div></div>
<p>.</p>
<h2><a class="anchor" id="Hardware_wiring"></a>
2 Hardware wiring</h2>
<h3><a class="anchor" id="Connect_I2C_interfaces_assigned_to_CP_chip"></a>
2.1 Connect I2C interfaces assigned to CP chip</h3>
<div class="image">
<img src="connect_CP_chip.png" alt="connect_CP_chip.png"/>
<div class="caption">
Figure 2-1 connect CP chip on eval board</div></div>
<p>.</p>
<h3><a class="anchor" id="Connect_Microphone_and_Jumper_as_The_Picture_below"></a>
2.2 Connect Microphone and Jumper as The Picture below</h3>
<div class="image">
<img src="MIC_and_jumper.png" alt="MIC_and_jumper.png"/>
<div class="caption">
Figure 2-2 MIC and its jumper on eval board</div></div>
<p>.</p>
<h3><a class="anchor" id="jump_for_the_key_assigned_for_AMA"></a>
2.3 jump for the key assigned for AMA</h3>
<h2><a class="anchor" id="Firmware_Configuration_for_AMA"></a>
3 Firmware Configuration for AMA</h2>
<h3><a class="anchor" id="Add_AMA_Files"></a>
3.1 Add AMA Files</h3>
<p>Copy three folders of 'bin', 'src', and 'inc' provided in '3rd_service_ama' to 'sdk/'.</p>
<div class="image">
<img src="ama_src_files.png" alt="ama_src_files.png"/>
<div class="caption">
Figure 3-1 AMA source files</div></div>
 <div class="image">
<img src="ama_lib_header_files.png" alt="ama_lib_header_files.png"/>
<div class="caption">
Figure 3-2 header files for ama library</div></div>
 <div class="image">
<img src="ama_lib.png" alt="ama_lib.png"/>
<div class="caption">
Figure 3-3 ama.lib</div></div>
 <h3><a class="anchor" id="Macro_for_AMA_Feature"></a>
3.2 Macro for AMA Feature</h3>
<p>AMA_FEATURE_SUPPORT is a macro for AMA. Please enable it in app_flags.h </p><div class="fragment"><div class="line"><span class="preprocessor">#if (TARGET_RTL8773CO|TARGET_RTL8763COM)</span></div><div class="line"><span class="preprocessor">#undef F_APP_IAP_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_IAP_SUPPORT   1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_IAP_RTK_SUPPORT</span></div><div class="line"><span class="preprocessor">#if F_APP_IAP_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_IAP_RTK_SUPPORT                 1</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#define F_APP_IAP_RTK_SUPPORT                 0</span></div><div class="line"><span class="preprocessor">#endif  </span><span class="comment">/* F_APP_IAP_SUPPORT */</span><span class="preprocessor"></span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_BLE_SWIFT_PAIR_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_BLE_SWIFT_PAIR_SUPPORT      1</span></div><div class="line"><span class="preprocessor">#undef GFPS_FEATURE_SUPPORT</span></div><div class="line"><span class="preprocessor">#define GFPS_FEATURE_SUPPORT            1</span></div><div class="line"><span class="preprocessor">#undef AMA_FEATURE_SUPPORT</span></div><div class="line"><span class="preprocessor">#define AMA_FEATURE_SUPPORT             0</span></div><div class="line"><span class="preprocessor">#undef BISTO_FEATURE_SUPPORT                </span></div><div class="line"><span class="preprocessor">#define BISTO_FEATURE_SUPPORT           1   //Set the BISTO_FEATURE_SUPPORT as 1</span></div><div class="line"><span class="preprocessor">#undef XM_XIAOAI_FEATURE_SUPPORT</span></div><div class="line"><span class="preprocessor">#define XM_XIAOAI_FEATURE_SUPPORT       1</span></div><div class="line"><span class="preprocessor">#undef F_APP_LOCAL_PLAYBACK_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_LOCAL_PLAYBACK_SUPPORT    1</span></div><div class="line"><span class="preprocessor">#endif  </span><span class="comment">/* (TARGET_RTL8773CO|TARGET_RTL8763COM) */</span><span class="preprocessor"></span></div></div><!-- fragment --><h3><a class="anchor" id="Main_Settings_for_AMA_Device"></a>
3.3 Main Settings for AMA Device</h3>
<p>The word 'device' refers to both ends of the AMA application while 'accessory device' is specially refers to our eval board. There are two main settings in app_ama_accessory.c:</p><ol type="1">
<li>app_ama_accessory_info: This function includes name, serial number, device type(ama id) and supported transports. The name is derive from BREDR name from MCU Config Tool. <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_ama_accessory_info(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">char</span> *serial_number = <span class="stringliteral">&quot;1234567890&quot;</span>;</div><div class="line">    <span class="keywordtype">char</span> name[<span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaf2dbb266dec477095d156ae715f53014">device_name_legacy</a>) + 1] = {<span class="charliteral">&#39;\0&#39;</span>}; <span class="comment">//local array, should check the length!!!</span></div><div class="line">    <span class="keywordtype">char</span> device_type[<span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a001ed425414966e734f36e5805565822">ama_id</a>) + 1] = {<span class="charliteral">&#39;\0&#39;</span>};<span class="comment">//local array, should check the length!!!</span></div><div class="line">    pb_size_t supported_transports_count = 0;</div><div class="line">    Transport supported_transports[DEVICE_SUPPORTED_TRANSPORTS_COUNT_MAX] = {(Transport)0};</div><div class="line"></div><div class="line">    memcpy(name, <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaf2dbb266dec477095d156ae715f53014">device_name_legacy</a>, <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaf2dbb266dec477095d156ae715f53014">device_name_legacy</a>));</div><div class="line">    memcpy(device_type, <a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a001ed425414966e734f36e5805565822">ama_id</a>, <span class="keyword">sizeof</span>(<a class="code" href="group___a_p_p___c_f_g.html#ga615ce55cdb35d36a2b0227908060801d">extend_app_cfg_const</a>.<a class="code" href="struct_t___e_x_t_e_n_d___a_p_p___c_f_g___c_o_n_s_t.html#a001ed425414966e734f36e5805565822">ama_id</a>));</div><div class="line"></div><div class="line">    supported_transports_count = 0;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_ama_transport_supported(AMA_SPP_STREAM))</div><div class="line">    {</div><div class="line">        supported_transports[supported_transports_count] = Transport_BLUETOOTH_RFCOMM;</div><div class="line">        supported_transports_count++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_ama_transport_supported(AMA_BLE_STREAM))</div><div class="line">    {</div><div class="line">        supported_transports[supported_transports_count] = Transport_BLUETOOTH_LOW_ENERGY;</div><div class="line">        supported_transports_count++;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_ama_transport_supported(AMA_IAP_STREAM))</div><div class="line">    {</div><div class="line">        supported_transports[supported_transports_count] = Transport_BLUETOOTH_IAP;</div><div class="line">        supported_transports_count++;</div><div class="line">    }</div><div class="line"></div><div class="line">    ama_set_device_info(serial_number, name, device_type,</div><div class="line">                        supported_transports_count,</div><div class="line">                        supported_transports);</div><div class="line">}</div></div><!-- fragment --></li>
<li>app_ama_accessory_speech_setting: This function specifies audio data format by app_ama_accessory.audio_format(OPUS by default). <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_ama_accessory_speech_setting(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    SpeechInitiator speech_initiator;</div><div class="line">    speech_initiator.type = SpeechInitiator_Type_TAP;</div><div class="line">    speech_initiator.wake_word.start_index_in_samples = 0;</div><div class="line">    speech_initiator.wake_word.end_index_in_samples = 0;</div><div class="line">    speech_initiator.wake_word.near_miss = 0;</div><div class="line">    speech_initiator.wake_word.metadata.size = 0;</div><div class="line">    <span class="comment">//speech_initiator.wake_word.metadata.bytes</span></div><div class="line"></div><div class="line"></div><div class="line">    ama_set_speech_setting(&amp;speech_initiator, AudioProfile_FAR_FIELD,</div><div class="line">                           app_ama_accessory.audio_format,</div><div class="line">                           AudioSource_STREAM);</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___r_w_s___a_m_a.html#gac6db620a3aeac97d3245a6044f2de2f9">app_ama_record_init</a>(app_ama_accessory.audio_format);</div><div class="line">}</div></div><!-- fragment --></li>
</ol>
<div class="fragment"><div class="line"><span class="keyword">struct</span></div><div class="line">{</div><div class="line">    AudioFormat audio_format;</div><div class="line">} app_ama_accessory = {.audio_format = AudioFormat_OPUS_16KHZ_32KBPS_CBR_0_20MS};</div></div><!-- fragment --><h3><a class="anchor" id="Choose_the_preference_initial_transport_for_IOS"></a>
3.4 Choose the preference/initial transport for IOS</h3>
<p>Alexa will choose SPP for Android phone as default. You can choose the preference/initial transport for IOS by BLE advertisement data: set the value as 0x03 or 0x01(should comment out another). </p><div class="fragment"><div class="line">0x03,              <span class="comment">/* Classic Bluetooth is discoverable */</span></div><div class="line"><span class="comment">//0x01,              /* Connection on RFCOMM is preferred */</span></div></div><!-- fragment --><h3><a class="anchor" id="Other_settings_in_BLE_advertisement_data"></a>
3.5 Other settings in BLE advertisement data</h3>
<p>There are 3 field could be set by SDK customer such as Vendor ID, device type, device color. </p><div class="fragment"><div class="line">0x5D, 0x00,        <span class="comment">/* Vendor ID assigned by BT */</span></div><div class="line">0x01, 0x00,        <span class="comment">/* Alexa Built-in Headphones */</span></div><div class="line">0x00,              <span class="comment">/* Color of the Accessory */</span></div></div><!-- fragment --><h2><a class="anchor" id="Source_Code_File_Introduction"></a>
4 Source Code File Introduction</h2>
<h3><a class="anchor" id="Basic_Building_Blocks"></a>
4.1 Basic Building Blocks</h3>
<ol type="1">
<li>Device module (app_ama_device.c) It's an entity represent remote/phone in multilink cases. This module get the packet from transport module for AMA lib and send packet from transport to transport module.</li>
<li>Transport module (app_ama_transport.c) provide data transmission for device module no matter what transport type(SPP/BLE/IAP) is it.</li>
<li>Record module(app_ama_record.c) It manages all resource from dsp for mic record including send audio data with a bluetooth address. The address is an identifier for remote/phone.</li>
<li>Stream modules(SPP/BLE/IAP) There are specific modules for data transmission.</li>
<li>AMA lib It is low layer module library.</li>
<li>Other There still some supportive modules which responsible for trivial functionality. <div class="image">
<img src="basic_building_blocks_for_AMA.png" alt="basic_building_blocks_for_AMA.png"/>
<div class="caption">
Figure 4-1 basic building blocks for AMA</div></div>
.</li>
</ol>
<h3><a class="anchor" id="Flow_of_Speech_Recognition"></a>
4.2 Flow of Speech Recognition</h3>
<ol type="1">
<li>Trigger AMA recognition by key MMI_ALEXA_WAKEWORD in app_mmi_handle_action will report key event to AMA by app_ama_device_va_start. <div class="fragment"><div class="line"><span class="preprocessor">#if AMA_FEATURE_SUPPORT</span></div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1ba742e6571d2c2506d2cd6f0cf9f87de1d">MMI_ALEXA_WAKEWORD</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_handle_mmi_message: MMI_ALEXA_WAKEWORD bud_role %d&quot;</span>, <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a>);</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> != <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4acb29f360a1e5a69b4c8541f24b929343">REMOTE_SESSION_ROLE_SECONDARY</a> &amp;&amp; <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#ae13eaf15d63f91b6a3f7eaaa54c05ce6">ama_support</a>)</div><div class="line">            {</div><div class="line"></div><div class="line"></div><div class="line">                uint8_t app_idx = <a class="code" href="group___a_p_p___a2_d_p___exported___functions.html#ga64e5317c844d638279db3fc8b13ba41f">app_a2dp_get_active_idx</a>();</div><div class="line">                app_ama_device_va_start(<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a790da4b2b0fd0935efe47dc4aad8f147">br_link</a>[app_idx].<a class="code" href="struct_t___a_p_p___b_r___l_i_n_k.html#a624fd24b46be2b40c8731334c9de5d06">bd_addr</a>);</div><div class="line"></div><div class="line"></div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --></li>
</ol>
<p>In app_ama_device_va_start, it will send a Command_START_SPEECH command to Alexa APP by ama_send_start_speech. </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (alexa_va_state == ALEXA_VA_STATE_IDLE)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (ama_send_start_speech(bd_addr))</div><div class="line">    {</div><div class="line">        p_device-&gt;alexa_va_state = ALEXA_VA_STATE_ACTIVE_PENDING;</div><div class="line">        app_ama_start_wait_speech_endpoint_timer();</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><ol type="1">
<li>Start Recording for Speech Recoginition When ama_lib receive Command_START_SPEECH response from Alexa APP, it will report AMA_EVT_START_SPEECH_RSP to APP layer. In this event, firmware will start recording by app_ama_record_start_recording <div class="fragment"><div class="line"><span class="keywordflow">case</span> AMA_EVT_START_SPEECH_RSP:</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (param-&gt;value.start_speech_rsp.error_code == ErrorCode_SUCCESS)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___r_w_s___a_m_a.html#gad863ffc1cf2aa3c07a75014864e6cb22">app_ama_record_start_recording</a>(bd_addr);</div><div class="line">            app_ama_device_set_va_state(bd_addr, ALEXA_VA_STATE_ACTIVE);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            app_ama_timer_stop_wait_speech_endpoint_timer();</div><div class="line">            <a class="code" href="group___a_p_p___r_w_s___a_m_a.html#ga1fe162093b8332feabe335cbce13d781">app_ama_record_stop_recording</a>(bd_addr);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --></li>
<li>Indicate States When Recoginition Alexa APP will indicate recognition state by AMA_EVT_NOTIFY_SPEECH_STATE. When a successful recognition, the state transition is as follows: SpeechState_IDLE &ndash;&gt; SpeechState_LISTENING &ndash;&gt; SpeechState_PROCESSING &ndash;&gt; SpeechState_SPEAKING &ndash;&gt; SpeechState_IDLE <div class="fragment"><div class="line"><span class="keywordflow">case</span> AMA_EVT_NOTIFY_SPEECH_STATE:</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga81687b044a4d8600c4be891734f4839a">APP_PRINT_INFO1</a>(<span class="stringliteral">&quot;app_ama_cback: AMA_EVT_NOTIFY_SPEECH_STATE speech_state %d&quot;</span>,</div><div class="line">                        param-&gt;value.speech_state);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --></li>
<li>Stop Speech Recognition Alexa APP will send Command_STOP_SPEECH command to AMA_lib. Then AMA lib will report AMA_EVT_STOP_SPEECH to APP layer. app_ama_record_stop_recording is responsible for stopping record. <div class="fragment"><div class="line"><span class="keywordflow">case</span> AMA_EVT_STOP_SPEECH:</div><div class="line">    {</div><div class="line">        app_ama_timer_stop_wait_speech_endpoint_timer();</div><div class="line">        <a class="code" href="group___a_p_p___r_w_s___a_m_a.html#ga1fe162093b8332feabe335cbce13d781">app_ama_record_stop_recording</a>(bd_addr);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --> </li>
</ol>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
