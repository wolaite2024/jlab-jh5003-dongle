<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ROLESWAP_Page"></a>
ROLESWAP Application Note    </h1>
<h2>Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n017__r_o_l_e_s_w_a_p.html#APP_roleswap_Introduction">Introduction</a></li>
<li><a class="el" href="_a_n017__r_o_l_e_s_w_a_p.html#APP_roleswap_state_machine">APP roleswap state machine</a></li>
<li><a class="el" href="_a_n017__r_o_l_e_s_w_a_p.html#APP_roleswap_trigger">APP roleswap trigger</a></li>
</ul>
<h2><a class="anchor" id="APP_roleswap_Introduction"></a>
Introduction</h2>
<p>The purpose of this document is to give a brief introduction of roleswap in app layer, including state machine, trigger events and roleswap flow.</p>
<h2><a class="anchor" id="APP_roleswap_state_machine"></a>
APP roleswap state machine</h2>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    APP_ROLESWAP_STATE_IDLE,</div><div class="line">    APP_ROLESWAP_STATE_BUSY,</div><div class="line">} T_APP_ROLESWAP_STATE;</div></div><!-- fragment --><div class="image">
<img src="Fig1_APP_roleswap_state_machine.PNG" alt="Fig1_APP_roleswap_state_machine.PNG"/>
<div class="caption">
Figure 1: APP roleswap state machine</div></div>
<p>.</p>
<h2><a class="anchor" id="APP_roleswap_trigger"></a>
APP roleswap trigger</h2>
<p>Roleswap need to be triggerred when pri is about to power off or mic of pri cannot be used. It would check whether to trigger roleswap when following events happen through api app_roleswap_ctrl_check. </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_LOCAL_IN_CASE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_REMOTE_IN_CASE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_LOCAL_OUT_CASE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_REMOTE_OUT_CASE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_LOCAL_IN_EAR,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_REMOTE_IN_EAR,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_LOCAL_OUT_EAR,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_REMOTE_OUT_EAR,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_SCO_CONN_CMPL,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ROLESWAP_IDLE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ROLESWAP_SUCCESS,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_BLE_DISC,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_B2B_CONNECTED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_LINK_MONITOR,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_BATTERY,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ACL_ROLE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_SNIFF_EVENT,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_RETRY,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_SINGLE_BUD_TO_POWER_OFF,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_CLOSE_CASE_POWER_OFF,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_OPEN_CASE,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_TIMEOUT,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_POWER_OFF,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_IN_CASE_TIMEOUT_TO_POWER_OFF,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_REJCT_BY_PEER,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ALL_PROFILE_CONNECTED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_BUFFER_LEVEL_CHANGED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ACL_DISC,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_DECODE_EMPTY,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_CALL_STATUS_CHAGNED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_DURIAN_MIC_CHANGED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ROLESWAP_TERMINATED,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ABS_VOL_CHECK_TIMEOUT,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_MMI_TRIGGER_ROLESWAP,</div><div class="line">    APP_ROLESWAP_CTRL_EVENT_ROLESWAP_FAILED_RETRY,</div><div class="line">} T_APP_ROLESWAP_CTRL_EVENT;</div></div><!-- fragment --><p> Roleswap would be rejected if some condition is not satisfied, such as: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    ROLESWAP_REJECT_REASON_NONE,</div><div class="line">    ROLESWAP_REJECT_REASON_NOT_B2B_PRIMARY,</div><div class="line">    ROLESWAP_REJECT_REASON_ONGOING,</div><div class="line">    ROLESWAP_REJECT_REASON_BLE_EXIST,</div><div class="line">    ROLESWAP_REJECT_REASON_VIOLATION,</div><div class="line">    ROLESWAP_REJECT_REASON_ACL_ROLE_SLAVE,</div><div class="line">    ROLESWAP_REJECT_REASON_OTA,</div><div class="line">    ROLESWAP_REJECT_REASON_TEAMS_CFU,</div><div class="line">    ROLESWAP_REJECT_REASON_ANC_HANDLING,</div><div class="line">    ROLESWAP_REJECT_REASON_SNIFF_STATE,</div><div class="line">    ROLESWAP_REJECT_REASON_PROFILE_NOT_CONN,</div><div class="line">    ROLESWAP_REJECT_REASON_PROFILE_CONNECTING,</div><div class="line">    ROLESWAP_REJECT_REASON_REMOTE_IN_BOX,</div><div class="line">    ROLESWAP_REJECT_REASON_SCO_REMOTE_IN_BOX,</div><div class="line">    ROLESWAP_REJECT_REASON_SCO_REMOTE_OUT_EAR,</div><div class="line">    ROLESWAP_REJECT_REASON_BLE_CONNECTED,</div><div class="line">    ROLESWAP_REJECT_REASON_MEDIA_BUFFER_NOT_ENOUGH,</div><div class="line">    ROLESWAP_REJECT_REASON_MULTILINK_EXIST,</div><div class="line">    ROLESWAP_REJECT_REASON_DISC_BLE_OR_INACTIVE_LINK,</div><div class="line">    ROLESWAP_REJECT_REASON_DURIAN_FIX_MIC_VIOLATION,</div><div class="line">    ROLESWAP_REJECT_REASON_CHECK_ABS_VOL,</div><div class="line">    ROLESWAP_REJECT_REASON_A2DP_STREAM_CHANN_CONNECTING,</div><div class="line">    ROLESWAP_REJECT_REASON_MEMS_START,</div><div class="line">    ROLESWAP_REJECT_REASON_AIRPLANE_MODE,</div><div class="line">    ROLESWAP_REJECT_REASON_CALL_COMMING,</div><div class="line">    ROLESWAP_REJECT_REASON_STOP_LINKBACK_ING,</div><div class="line">} T_APP_ROLESWAP_REJECT_REASON;</div></div><!-- fragment --><p> If some condition is not satisfied, which can be handled, roleswap would be triggerred again when these conditions are satisfied. The final reasons that roleswap is triggerred by can be conclued as: </p><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    ROLESWAP_TRIGGER_REASON_NONE,</div><div class="line">    ROLESWAP_TRIGGER_REASON_IN_NON_SMART_CASE,</div><div class="line">    ROLESWAP_TRIGGER_REASON_SCO_IN_SMART_CASE,</div><div class="line">    ROLESWAP_TRIGGER_REASON_SCO_OUT_EAR,</div><div class="line">    ROLESWAP_TRIGGER_REASON_RSSI,</div><div class="line">    ROLESWAP_TRIGGER_REASON_BATTERY,</div><div class="line">    ROLESWAP_TRIGGER_REASON_SINGLE_BUD_TO_POWER_OFF,</div><div class="line">    ROLESWAP_TRIGGER_REASON_CLOSE_CASE_POWER_OFF,</div><div class="line">    ROLESWAP_TRIGGER_REASON_DURIAN_FIX_MIC,</div><div class="line">    ROLESWAP_TRIGGER_REASON_MMI_TRIGGER,</div><div class="line">} T_APP_ROLESWAP_TRIGGER_REASON;</div></div><!-- fragment --><div class="image">
<img src="Fig2_APP_roleswap_trigger.png" alt="Fig2_APP_roleswap_trigger.png"/>
<div class="caption">
Figure 2: APP roleswap trigger</div></div>
<p>. </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
