<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Sensor_JSA_Manual"></a>
APP SENSOR JSA Module Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/07/26</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/07/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/07/26  </td><td class="markdownTableBodyCenter">Update doc format   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Rev">Revision History</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Table_List">Table List</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_McuConfigTool_Configuration">2 McuConfigTool Configuration</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Source_Code_Overview">3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Init">3.1 Initialize sensor jsa1225/jsa1227 settings</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Get_Status">3.2 Get sensor jsa1225/jsa1227 in/out ear status</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Handle_Interrupt">3.3 Handle jsa1225/jsa1227 interrupt</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Handle_Msg">3.4 Handle jsa1225/jsa1227 io msg</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Handle_Debounce">3.5 Handle jsa1225/jsa1227 debounce result</a></li>
<li><a class="el" href="_a_n055__a_p_p__s_e_n_s_o_r__j_s_a__m_o_d_u_l_e.html#APP_SENSOR_JSA_Module_Source_Code_Handle_In_Out_Ear_Event">3.6 Handle jsa1225/jsa1227 in/out ear event</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Module_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Module_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 JSA Enable</a></li>
<li><a href="#figure_2_2">Figure 2-2 JSA Pin Setting</a></li>
<li><a href="#figure_2_3">Figure 2-3 JSA Default Setting</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Module_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">LD  </td><td class="markdownTableBodyCenter">Light Detect   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Module_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of the app sensor JSA module for customer. The document describes how to use app sensor JSA module in app project. The source code consists of <b>APP_SENSOR_JSA</b> part. The details will be described in the following sections.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_McuConfigTool_Configuration"></a>
2 McuConfigTool Configuration</h2>
<p>Light sensor JSA1225/JSA1227 can be enabled in "HW Feature" page.</p>
<div class="image">
<img src="mcuconfig_jsa1225_enable.png" alt="mcuconfig_jsa1225_enable.png" width="50%" height="50%"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 JSA Enable</b></div></center><p>Select i2c and Sensor detect pin.</p>
<div class="image">
<img src="mcuconfig_jsa1225_pin_setting.png" alt="mcuconfig_jsa1225_pin_setting.png" width="50%" height="50%"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 JSA Pin Setting</b></div></center><p>Below is light sensor JSA1225 parameter's default value.</p>
<div class="image">
<img src="mcuconfig_jsa1225_default_settings.png" alt="mcuconfig_jsa1225_default_settings.png" width="50%" height="50%"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 JSA Default Setting</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_JSA_Source_Code_Overview"></a>
3 Source Code Overview</h2>
<p>This section describes app sensor jsa1225/jsa1227 module. The reference file is shown as follows:</p>
<ul>
<li>Project source code directory: sdk\src\mcu\sensor\ld_sensor\jsa\sensor_jsa.c This module is used to handle app sensor jsa1225/jsa1227 message.</li>
</ul>
<h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Init"></a>
3.1 Initialize sensor jsa1225/jsa1227 settings</h3>
<p>source code directory: sdk/src/mcu/sensor/ld_sensor/jsa/sensor_jsa.c <br />
 Configure i2c and ready pinmux settings.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> sensor_jsa_init(T_JSA_DEV *dev)</div><div class="line">{</div><div class="line">    memcpy((uint8_t *)&amp;jsa_dev, (uint8_t *)dev, <span class="keyword">sizeof</span>(jsa_dev));</div><div class="line">    sensor_int_init(jsa_dev.int_pinmux, jsa_dev.pull_value, <span class="keyword">true</span>, jsa_dev.gpio_cb);</div><div class="line">    sensor_i2c_init(JSA_I2C_ID, JSA_I2C_ADDR, JSA_I2C_LOCK,</div><div class="line">                    (jsa_dev.type == JSA_1225) ? JSA_1225_I2C_SPEED : JSA_1227_I2C_SPEED);</div><div class="line">    sensor_jsa_setup();</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Get_Status"></a>
3.2 Get sensor jsa1225/jsa1227 in/out ear status</h3>
<p>source code directory: sdk/src/mcu/sensor/ld_sensor/jsa/sensor_jsa.c <br />
 Get in-ear or out-ear status from jsa1225/jsa1227 sensor register.</p>
<div class="fragment"><div class="line">uint8_t sensor_jsa_get_status(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> sensor_i2c_read_one_byte(JSA_I2C_ID, JSA_I2C_ADDR, SENSOR_REG_JSA_INT_FLAG);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Handle_Interrupt"></a>
3.3 Handle jsa1225/jsa1227 interrupt</h3>
<p>source code directory: sdk/src/sample/rws/app_sensor_ld.c <br />
 Get jsa1225/jsa1227 in/out ear status and send io msg when interrupt is triggered.</p>
<div class="fragment"><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#gaf901ecfe15c401262a5dfd752a0b0287">ISR_TEXT_SECTION</a> <span class="keywordtype">void</span>  app_sensor_ld_jsa_isr_cb(uint32_t param)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="comment">//Get detect status, 1: appear (in-ear). 0: disapper (out-ear)</span></div><div class="line">    uint8_t val = sensor_jsa_get_status();</div><div class="line"></div><div class="line">    gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">    gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10a3a499521c6d9eb11324ee2ebb639d6d4">IO_MSG_GPIO_SENSOR_LD</a>;</div><div class="line">    gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = (val &amp; <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga3a8ea58898cb58fc96013383d39f482c">BIT</a>(5)) ? <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga78236708eb2be523c415d855a07fe707">SENSOR_LD_IN_EAR</a> : <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga7194ea9a291171a803a300b6fda30864">SENSOR_LD_OUT_EAR</a>;</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;gpio_msg);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Handle_Msg"></a>
3.4 Handle jsa1225/jsa1227 io msg</h3>
<p>source code directory: sdk/src/sample/rws/app_io_msg.c <br />
 Handle io msg which is sent from jsa1225/jsa1227 interrupt handler.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88736c50cf59b3ad0825710a6837cbe4">app_io_msg_handler</a>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_driver_msg_recv)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span> (msgtype)</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10a3a499521c6d9eb11324ee2ebb639d6d4">IO_MSG_GPIO_SENSOR_LD</a>:</div><div class="line">            {</div><div class="line">                app_sensor_ld_handle_msg(&amp;io_driver_msg_recv);</div><div class="line">            }</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_sensor_ld.c <br />
 Handle msg which is sent from io msg, start a debounce timer to prevent noise. The default debounce time is 500(ms).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_sensor_ld_handle_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *io_driver_msg_recv)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    uint8_t status = io_driver_msg_recv-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a>;</div><div class="line"></div><div class="line">    app_sensor_ld_start_debounce_timer(500, status);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Handle_Debounce"></a>
3.5 Handle jsa1225/jsa1227 debounce result</h3>
<p>source code directory: sdk/src/sample/rws/app_sensor_ld.c <br />
 Handle debounce result and send io msg.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_ld_timeout_cb(uint8_t timer_evt, uint16_t param)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> APP_TIMER_LD_DEBOUNCE:</div><div class="line">        {</div><div class="line">            app_sensor_ld_stop_debounce_timer();</div><div class="line">            app_sensor_ld_debounce_handle(param);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_ld_debounce_handle(uint8_t status)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a267279067de70c37a6bcc24307b66822">local_in_ear</a> = (status == <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga78236708eb2be523c415d855a07fe707">SENSOR_LD_IN_EAR</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;  </div><div class="line">    ...</div><div class="line">    app_sensor_ld_msg_send(status, CAUSE_ACTION_SENSOR_LD);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_ld_msg_send(uint8_t status, uint8_t cause)</div><div class="line">{</div><div class="line">    <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> adp_msg;</div><div class="line"></div><div class="line">    adp_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">    adp_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10ae0d838e26386c989049b4840b5865c01">IO_MSG_GPIO_BUD_LOC_CHANGE</a>;</div><div class="line"></div><div class="line">    <span class="keywordflow">switch</span> (status)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga78236708eb2be523c415d855a07fe707">SENSOR_LD_IN_EAR</a>:</div><div class="line">        adp_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = ((cause &lt;&lt; 8) | EVENT_IN_EAR);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga7194ea9a291171a803a300b6fda30864">SENSOR_LD_OUT_EAR</a>:</div><div class="line">        adp_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = ((cause &lt;&lt; 8) | EVENT_OUT_EAR);</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;adp_msg);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_JSA_Module_Source_Code_Handle_In_Out_Ear_Event"></a>
3.6 Handle jsa1225/jsa1227 in/out ear event</h3>
<p>source code directory: sdk/src/sample/rws/app_io_msg.c <br />
 Handle io msg which is sent from jsa1225/jsa1227 debounce handler and handle the in/out ear event.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___i_o___m_s_g.html#gab3416cc2898ca3f036749335997d4841">app_io_handle_msg</a>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_driver_msg_recv)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span> (msgtype)</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10ae0d838e26386c989049b4840b5865c01">IO_MSG_GPIO_BUD_LOC_CHANGE</a>:</div><div class="line">                {</div><div class="line">                    T_BUD_LOCATION_EVENT evt = (T_BUD_LOCATION_EVENT)(io_driver_msg_recv.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> &amp; 0x00FF);</div><div class="line">                    T_BUD_LOCATION_CAUSE_ACTION cause_action =</div><div class="line">                        (T_BUD_LOCATION_CAUSE_ACTION)((io_driver_msg_recv.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> &amp; 0xFF00) &gt;&gt; 8);</div><div class="line"></div><div class="line">                    app_loc_mgr_state_machine(evt, 0, cause_action);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
