<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="TUYA_Page"></a>
TUYA Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.4</b></center><p><br />
 </p><center><b>2023/07/05</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="TUYA_DOC_rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/12/28  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2022/08/15  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.3  </td><td class="markdownTableBodyCenter">2023/07/03  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.4  </td><td class="markdownTableBodyCenter">2023/07/05  </td><td class="markdownTableBodyCenter">Modify images and layout   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_DOC_rev">Revision History</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_Table_List">Table List</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_INTRODUCTION">1 Introduction</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_CONFIG">2 Enable TUYA Feature</a><ul>
<li><a class="el" href="_a_n115__t_u_y_a.html#Add_TUYA_Files">2.1 Add TUYA Files</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#SETUP_TUYA_IN_PROJ">2.2 Set up TUYA Environment in Keil Project</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#ENABLE_TUYA_IN_TOOL">2.3 Enable TUYA in Mcu Config Tool</a></li>
</ul>
</li>
<li><a class="el" href="_a_n115__t_u_y_a.html#ConnectTuyaApp">3 Connect with TUYA App</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TuyaOTA">4 TUYA OTA</a><ul>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_CREATE_PRODUCT">4.1 Create Product and Firmware</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_PACK_IMAGE">4.2 Pack OTA Package</a><ul>
<li><a class="el" href="_a_n115__t_u_y_a.html#GENERATE_APP_UI">4.2.1 Generate APP UI Paramerter Image with Version</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_PACK_METHOD1">4.2.2 Packing Method 1: Pack Images Manually</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_PACK_METHOD2">4.2.3 Packing Method 2: One-Click Pack for OTA</a></li>
</ul>
</li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_DEPLOY">4.3 Deploy Update</a></li>
<li><a class="el" href="_a_n115__t_u_y_a.html#TUYA_DO_OTA_ON_PHONE">4.4 OTA Process</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TUYA_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TUYA_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 Add Lib (sample for rtl87x3e)</a></li>
<li><a href="#figure_2_2">Figure 2-2 Add TUYA Files</a></li>
<li><a href="#figure_2_3">Figure 2-3 Build TUYA Lib in Keil</a></li>
<li><a href="#figure_2_4">Figure 2-4 Build TUYA in Keil</a></li>
<li><a href="#figure_2_5">Figure 2-5 Set Config File</a></li>
<li><a href="#figure_2_6">Figure 2-6 Enable TUYA in Mcu Config Tool</a></li>
<li><a href="#figure_3_1">Figure 3-1 Connect with TUYA App</a></li>
<li><a href="#figure_4_1">Figure 4-1 Create Product</a></li>
<li><a href="#figure_4_2">Figure 4-2 Get PID</a></li>
<li><a href="#figure_4_3">Figure 4-3 Hardware Development</a></li>
<li><a href="#figure_4_4">Figure 4-4 Add Custom Firmware</a></li>
<li><a href="#figure_4_5">Figure 4-5 Firmware Type</a></li>
<li><a href="#figure_4_6">Figure 4-6 Firmware Management</a></li>
<li><a href="#figure_4_7">Figure 4-7 TuYaSpecial.dll</a></li>
<li><a href="#figure_4_8">Figure 4-8 Fill in Version</a></li>
<li><a href="#figure_4_9">Figure 4-9 Combine Images</a></li>
<li><a href="#figure_4_10">Figure 4-10 Load Images</a></li>
<li><a href="#figure_4_11">Figure 4-11 OneClickPack Folder</a></li>
<li><a href="#figure_4_12">Figure 4-12 Create Firmware Version</a></li>
<li><a href="#figure_4_13">Figure 4-13 New Update Deployment</a></li>
<li><a href="#figure_4_14">Figure 4-14 Deploy Update</a></li>
<li><a href="#figure_4_15">Figure 4-15 Update on TUYA App</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TUYA_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">OTA  </td><td class="markdownTableBodyCenter">Over The Air   </td></tr>
</table>
<div style="page-break-after: always;"></div><p> <style>div.image img[src="tuya_ota14.png"]{width:400px;}
                           img[src="tuya_ota15.png"]{width:400px;}
</style> </p>
<h2><a class="anchor" id="TUYA_INTRODUCTION"></a>
1 Introduction</h2>
<p>Tuya is a third-party IOT platform. To use the TUYA service, the 'Tuya Smart' application should be installed on user's phone. The app is available on both Android and iOS. Users can install it from corresponding application store of the phone.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="TUYA_CONFIG"></a>
2 Enable TUYA Feature</h2>
<h3><a class="anchor" id="Add_TUYA_Files"></a>
2.1 Add TUYA Files</h3>
<p>Copy two folders of 'bin' and 'src' provided in '3rd_service_tuya' to 'sdk/'.</p>
<div class="image">
<img src="tuya_lib_rtl87x3e.jpg" alt="tuya_lib_rtl87x3e.jpg"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Add Lib (sample for rtl87x3e)</b></div></center><div class="image">
<img src="app_tuya_add_files.jpg" alt="app_tuya_add_files.jpg"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Add TUYA Files</b></div></center><h3><a class="anchor" id="SETUP_TUYA_IN_PROJ"></a>
2.2 Set up TUYA Environment in Keil Project</h3>
<ul>
<li>1. Define and set F_APP_TUYA_SUPPORT to 1 in app_flags.h:</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#undef F_APP_TUYA_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_TUYA_SUPPORT              1</span></div></div><!-- fragment --><ul>
<li>2. Enable build tuya_lib in keil project: find tuya_lib in keil project &ndash;&gt; right click &ndash;&gt; Options for File 'tuya_lib' &ndash;&gt; Tick in front of 'include in Target Build' <div class="image">
<img src="build_tuya_lib.jpg" alt="build_tuya_lib.jpg"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Build TUYA Lib in Keil</b></div></center></li>
<li>3. Enable build tuya in keil project: find tuya in keil project &ndash;&gt; right click &ndash;&gt; Options for Group 'tuya' &ndash;&gt; Tick in front of 'include in Target Build' <div class="image">
<img src="build_tuya.jpg" alt="build_tuya.jpg"/>
</div>
 <center><div id="figure_2_4"><b>Figure 2-4 Build TUYA in Keil</b></div></center></li>
<li>4. Config tuya config file as <a class="el" href="rtk__tuya__ble__config_8h_source.html">rtk_tuya_ble_config.h</a>: Add CUSTOMIZED_TUYA_BLE_CONFIG_FILE="rtk_tuya_ble_config.h" to Preprocesor Symbols.</li>
</ul>
<div class="image">
<img src="set_config_file.png" alt="set_config_file.png"/>
</div>
 <center><div id="figure_2_5"><b>Figure 2-5 Set Config File</b></div></center><h3><a class="anchor" id="ENABLE_TUYA_IN_TOOL"></a>
2.3 Enable TUYA in Mcu Config Tool</h3>
<p>To use tuya, users also need to check the tuya checkbox in third party page in MCU Config Tool. Also, the ADV timeout value could be configured by the ADV timeouts(s) text box.</p>
<div class="image">
<img src="tuya_mcu_config_tool.png" alt="tuya_mcu_config_tool.png"/>
</div>
 <center><div id="figure_2_6"><b>Figure 2-6 Enable TUYA in Mcu Config Tool</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="ConnectTuyaApp"></a>
3 Connect with TUYA App</h2>
<ul>
<li>1. Power on and enter pairing mode</li>
<li>2. Open TUYA APP</li>
<li>3. Press '+' and add device or wait for TUYA APP discovery the headphone automatically</li>
<li>4. When TUYA app discovery the headphone, click "add device"</li>
<li>5. When device is added successfully, click "next step"</li>
<li>6. Completed.</li>
</ul>
<div class="image">
<img src="add_tuya_device.png" alt="add_tuya_device.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Connect with TUYA App</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="TuyaOTA"></a>
4 TUYA OTA</h2>
<h3><a class="anchor" id="TUYA_CREATE_PRODUCT"></a>
4.1 Create Product and Firmware</h3>
<p>To update through OTA, you need to generate a PID by creating a product on tuya IoT platform (<a href="https://iot.tuya.com/">https://iot.tuya.com/</a>). The product solution is 'True Wireless Earphones' in category of 'Digital Entertainment-HeadPhone'.</p>
<div class="image">
<img src="tuya_ota1.png" alt="tuya_ota1.png" width="1000px" height="177px"/>
</div>
 <center><div id="figure_4_1"><b>Figure 4-1 Create Product</b></div></center><div class="image">
<img src="tuya_ota2.png" alt="tuya_ota2.png"/>
</div>
 <center><div id="figure_4_2"><b>Figure 4-2 Get PID</b></div></center><p>Copy the PID of your product and replace APP_PRODUCT_ID with your PID in <a class="el" href="rtk__tuya__ble__app__demo_8h_source.html">rtk_tuya_ble_app_demo.h</a>: </p><div class="fragment"><div class="line"><span class="preprocessor">#define APP_PRODUCT_ID      &quot;yourpid&quot;</span></div></div><!-- fragment --><p>Rebuild rws project and generate app images(bank0 for downloading and bank1 for updating) to make the change effective.</p>
<p>Enter the 'Deveplopment' page and select 'Hardware Development' -&gt; 'Add Custom Firmware'. Choose 'Bluetooth Firmware' in the option of 'Firmware Type'. Click 'Generta Firmware Key' to Generta a firmware.</p>
<div class="image">
<img src="tuya_ota3.png" alt="tuya_ota3.png" width="1000px" height="185px"/>
</div>
 <center><div id="figure_4_3"><b>Figure 4-3 Hardware Development</b></div></center><div class="image">
<img src="tuya_ota4.png" alt="tuya_ota4.png"/>
</div>
 <center><div id="figure_4_4"><b>Figure 4-4 Add Custom Firmware</b></div></center><div class="image">
<img src="tuya_ota5.png" alt="tuya_ota5.png"/>
</div>
 <center><div id="figure_4_5"><b>Figure 4-5 Firmware Type</b></div></center><p>You can find the firmware that you created in 'Firmware Management'. Multiple versions can be created for one firmware. OTA firmwares will be uploaded through 'Create Version'.</p>
<div class="image">
<img src="tuya_ota6.png" alt="tuya_ota6.png" width="1000px" height="267px"/>
</div>
 <center><div id="figure_4_6"><b>Figure 4-6 Firmware Management</b></div></center><h3><a class="anchor" id="TUYA_PACK_IMAGE"></a>
4.2 Pack OTA Package</h3>
<p><b>Before Packing images to generate OTA Package, please copy the TuYaSpecial.dll file from '3rd_service_tuya' folder to the mppg tool folder.</b></p>
<div class="image">
<img src="tuya_ota_dll.png" alt="tuya_ota_dll.png"/>
</div>
 <center><div id="figure_4_7"><b>Figure 4-7 TuYaSpecial.dll</b></div></center><h4><a class="anchor" id="GENERATE_APP_UI"></a>
4.2.1 Generate APP UI Paramerter Image with Version</h4>
<div class="image">
<img src="tuya_ota7.png" alt="tuya_ota7.png"/>
</div>
 <center><div id="figure_4_8"><b>Figure 4-8 Fill in Version</b></div></center><p>The APP UI Paramerter Image must be regenerated for version management. Open Mcu Config Tool and select General page. Fill in the version number you wanted. Please notice that the version number must be started by '0.0' because the length is stricted to 2 numbers by the tuya IoT platform(Sample: 0.0.3.0 means v3.0).</p>
<h4><a class="anchor" id="TUYA_PACK_METHOD1"></a>
4.2.2 Packing Method 1: Pack Images Manually</h4>
<p>1.Generate Primary merged image</p>
<p>Click Tool-&gt;Pack-&gt;For OTA in MPPG Tool and load the primary images to pack primary images.</p>
<p>2.Generate Secondary merged image (RWS needed)</p>
<p>Click Tool-&gt;Pack-&gt;For OTA in MPPG Tool and load the secondary images to pack secondary images.</p>
<p>3.Generate Combined image</p>
<p>Click Tool-&gt;Combine Image for OTA. Select 'For TUYA'(Check 'RWS' for RWS). Load Merged Image(s) and click 'Combine' to generate Combined Image.</p>
<div class="image">
<img src="tuya_ota9.png" alt="tuya_ota9.png"/>
</div>
 <center><div id="figure_4_9"><b>Figure 4-9 Combine Images</b></div></center><div class="image">
<img src="tuya_ota10.png" alt="tuya_ota10.png"/>
</div>
 <center><div id="figure_4_10"><b>Figure 4-10 Load Images</b></div></center><h4><a class="anchor" id="TUYA_PACK_METHOD2"></a>
4.2.3 Packing Method 2: One-Click Pack for OTA</h4>
<ul>
<li>1. Put the upgrade filea in the OneClickPack folder. OneClickPack is for flash map file. OneClickPack is for Primary or Single images. OneClickPack is for Secondary images (Only RWS needed).</li>
</ul>
<div class="image">
<img src="tuya_ota_oneclick.png" alt="tuya_ota_oneclick.png"/>
</div>
 <center><div id="figure_4_11"><b>Figure 4-11 OneClickPack Folder</b></div></center><ul>
<li>2. Click Tool-&gt;One-Click pack for OTA in MPPG Toolmppg tool, Select OneClickPack Folder and click Auto Pack to generate OTA Package.</li>
</ul>
<h3><a class="anchor" id="TUYA_DEPLOY"></a>
4.3 Deploy Update</h3>
<ul>
<li>1. Upload OTA package in IoT platform</li>
</ul>
<p>On the Firmware Management Page in IoT platform, click 'Create Version' and upload the combined image.</p>
<div style="color:#F00; font-weight:bold">Notice that the Firmware Version must be filled as same as the version of APP UI Paramerter Image(Sample: if the version number is 0.0.3.1, fill 3.1 in the Firmware Version).</div><p>Click 'Save &amp; Enabled'.</p>
<div class="image">
<img src="tuya_ota11.png" alt="tuya_ota11.png"/>
</div>
 <center><div id="figure_4_12"><b>Figure 4-12 Create Firmware Version</b></div></center><ul>
<li>2. Deploy</li>
</ul>
<p>On the Firmware Update Page in IoT platform, click 'New Update Deployment' and choose the firmware version in step (1). Click OK and set up deployment. Get back to Firmware Update Page, click 'Verify' and 'Add by Device ID'. Paste the device's virtual ID (TUYA app-&gt;connected device-&gt;icon in the right-hand corner-&gt;Device Information-&gt;Virtual ID) connected with tuya app and click ok to push the update message to TUYA app.</p>
<div class="image">
<img src="tuya_ota12.png" alt="tuya_ota12.png"/>
</div>
 <center><div id="figure_4_13"><b>Figure 4-13 New Update Deployment</b></div></center><div class="image">
<img src="tuya_ota13.png" alt="tuya_ota13.png"/>
</div>
 <center><div id="figure_4_14"><b>Figure 4-14 Deploy Update</b></div></center><h3><a class="anchor" id="TUYA_DO_OTA_ON_PHONE"></a>
4.4 OTA Process</h3>
<p>Click 'Update immediately' to start updating. After the update finished, Click 'Verify Update' in the verify page and the test result would show 'Verification succeeded'.</p>
<div class="image">
<img src="tuya_ota14.png" alt="tuya_ota14.png"/>
</div>
 <center><div id="figure_4_15"><b>Figure 4-15 Update on TUYA App and update successfully</b></div></center> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
