<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Mem_Hierarchy_D"></a>
Memory Hierarchy User Manual RTL87X3D   </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/06/05</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="MEMORY_HIERARCHY_RTL87X3D_rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/04/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/06/05  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_d.html#MEMORY_HIERARCHY_RTL87X3D_rev">Revision History</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_d.html#MEMORY_HIERARCHY_RTL87X3D_Table_List">Table List</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_d.html#MEMORY_HIERARCHY_RTL87X3D_Figure_List">Figure List</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_d.html#MEMORY_HIERARCHY_RTL87X3D_Glossary">Glossary</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_overview">1 Overview</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_rom">2 ROM</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_ram">3 RAM</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_flash">4 Flash</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_efuse">5 eFuse</a></li>
<li><a class="el" href="_m_e_m_o_r_y__h_i_e_r_a_r_c_h_y__r_t_l87_x3_e.html#mem_psram">6 PSRAM</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MEMORY_HIERARCHY_RTL87X3D_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_1_1">Table 1-1 Memory Overview</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MEMORY_HIERARCHY_RTL87X3D_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_3_1">Figure 3-1 General RAM Layout</a></li>
<li><a href="#figure_3_2">Figure 3-2 Heap RAM Layout</a></li>
<li><a href="#figure_3_3">Figure 3-3 APP Global Layout</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MEMORY_HIERARCHY_RTL87X3D_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ROM  </td><td class="markdownTableBodyCenter">Read-Only Memory   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">RAM  </td><td class="markdownTableBodyCenter">Random Access Memory   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">PSRAM  </td><td class="markdownTableBodyCenter">Pseudo static random access memory   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_overview"></a>
1 Overview</h2>
<p>This document introduces the memory system of RTL87X3D generally. RTL87X3D's memory system consists of ROM, RAM, Flash, and eFuse, which has a flexible configuration mechanism. The flexible configurability and extensibility make RTL87X3D support a wide range of applications with different memory usage. </p><center><div id="table_1_1"><b>Table 1-1 Memory Overview</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Memory Type  </th><th class="markdownTableHeadCenter">Start Addr  </th><th class="markdownTableHeadCenter">End Addr  </th><th class="markdownTableHeadCenter">Size (KB)  </th><th class="markdownTableHeadCenter">Block Size and Count   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ROM  </td><td class="markdownTableBodyCenter">0x00000000  </td><td class="markdownTableBodyCenter">0x00120000  </td><td class="markdownTableBodyCenter">1152  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">DATA RAM  </td><td class="markdownTableBodyCenter">0x00200000  </td><td class="markdownTableBodyCenter">0x00220000  </td><td class="markdownTableBodyCenter">128  </td><td class="markdownTableBodyCenter">4 x 32KB   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">BUFFER RAM  </td><td class="markdownTableBodyCenter">0x00280000  </td><td class="markdownTableBodyCenter">0x00290000  </td><td class="markdownTableBodyCenter">64  </td><td class="markdownTableBodyCenter">4 x 16KB   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">COMMON0 RAM  </td><td class="markdownTableBodyCenter">0x00300000  </td><td class="markdownTableBodyCenter">COMMON0 End <br />
Address  </td><td class="markdownTableBodyCenter">COMMON0 <br />
Size  </td><td class="markdownTableBodyCenter">N* x 32KB   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">COMMON1 RAM  </td><td class="markdownTableBodyCenter">COMMON1 <br />
Start <br />
Address  </td><td class="markdownTableBodyCenter">COMMON1 End <br />
Address  </td><td class="markdownTableBodyCenter">COMMON1 <br />
Size  </td><td class="markdownTableBodyCenter">256KB - N* x 32KB   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">COMMON2 RAM (Shared <br />
from dsp as general RAM)  </td><td class="markdownTableBodyCenter">0x00500000  </td><td class="markdownTableBodyCenter">COMMON2 End <br />
Address  </td><td class="markdownTableBodyCenter">&lt;=512  </td><td class="markdownTableBodyCenter">&lt;= (16 x 32KB)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">SPIC0 QPI Flash  </td><td class="markdownTableBodyCenter">0x02000000  </td><td class="markdownTableBodyCenter">0x03FFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">noncache mapping address to <br />
SPIC0  </td><td class="markdownTableBodyCenter">0x04000000  </td><td class="markdownTableBodyCenter">0x05FFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">SPIC1 QPI Psram; QPI Flash  </td><td class="markdownTableBodyCenter">0x06000000  </td><td class="markdownTableBodyCenter">0x07FFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">SPIC2 QPI Psram; QPI Flash  </td><td class="markdownTableBodyCenter">0x08000000  </td><td class="markdownTableBodyCenter">0x09FFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">SPIC3 QPI Psram; QPI Flash  </td><td class="markdownTableBodyCenter">0x10000000  </td><td class="markdownTableBodyCenter">0x1FFFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">PSRAM LPC CTRL OPI Psram  </td><td class="markdownTableBodyCenter">0xA6000000  </td><td class="markdownTableBodyCenter">0xA7FFFFFF  </td><td class="markdownTableBodyCenter">-  </td><td class="markdownTableBodyCenter">-   </td></tr>
</table>
<p><b>Note</b>:</p>
<ol type="1">
<li>COMMON0 and COMMON1Size are configurable in mem_config.h for the application project and the total size is 256KB (COMMON0 and COMMON1 RAM are 32K bytes aligned); COMMON0EndAddr = 0x00308000 + COMMON0Size; COMMON1EndAddr = COMMON1StartAddr + COMMON1Size; COMMON1StartAddr = COMMON0EndAddr + 0x100000. Recommend Settings: Text section located in COMMON0 RAM and data section located in COMMON1 RAM.</li>
<li>The address and size of COMMON2 RAM depend on configuration, which should match with dsp images.</li>
<li>DSP RAM is not shared as general RAM by default.</li>
<li>Efuse doesn't support access directly by address.</li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_rom"></a>
2 ROM</h2>
<p>Many fundamental functions are built in ROM(Read-Only Memory), such as Bootloader, RTOS, BT Stack, and IO Drivers. The ROM code is located at [0x00000000, 0x00120000]. RTK offers abundant APIs for users to access most ROM functions, which can improve users' development efficiency and reduce code size.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_ram"></a>
3 RAM</h2>
<p>RTL87X3D has three types of RAM: DATA, BUFFER, and COMMON(including COMMON0, COMMON1, and COMMON2). All types of memory could be used to store data and execute code. In the current SDK, Data RAM and Buffer RAM are provided for the vendor, and Common RAM is provided for the user. COMMON1 RAM is used to store data while COMMON0 RAM is used to run RAM code. <br />
The following picture shows the default RAM configuration. Some parts are already used by RTK internal functions(dark color blocks). The remaining parts should be allocated for global variables, RAM code, and Heap area. Users can configure these parts with the header file mem_config.h. <br />
1. The COMMON0 is recommended to be configured as APP RAM Text. <br />
2. COMMON1 is recommended to be configured as APP Global and Heap. </p><div class="image">
<img src="mem_ram_total_d.png" alt="mem_ram_total_d.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 General RAM Layout</b></div></center><p><br />
There are several physical Heap areas, but all of them are connected logically. Users can use malloc() to request RAM from the Heap area dynamically. Total Heap RAM size is 218KB by default, and some of it has already been used by RTK, which will be slightly different with different configurations generated by the mcu config tool. As for the heap for application, the RTK framework will cost about 37KB, which size will change when different features are supported. </p><div class="image">
<img src="mem_heap_cfg_d.png" alt="mem_heap_cfg_d.png"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 Heap RAM Layout</b></div></center><p><br />
The size of APP RAM Text is 48KB by default, which is used to run ram code. The size of the APP Global area is 12KB by default, which is used to store global variables. And RTK libs will cost about 4.3KB Global size. Users can configure them by modifying two macros in "mem_config.h" and other macros can not be modified in "mem_config.h". </p><div class="fragment"><div class="line"><span class="preprocessor">#define APP_RAM_TEXT_SIZE              (48*1024)</span></div><div class="line"><span class="preprocessor">#define APP_GLOBAL_SIZE                (12*1024)</span></div></div><!-- fragment --> <div class="image">
<img src="mem_app_global_d.png" alt="mem_app_global_d.png"/>
</div>
 <center><div id="figure_3_3"><b>Figure 3-3 APP Global Layout</b></div></center><p>The following log indicates that the heap is insufficient. </p><div class="fragment"><div class="line">0007138  03-02#09:29:53.651  154  0319630.477  [PATCH] !!!ALLOC FAIL!RAM type:5,wanted sz:2056,remain sz:4176</div></div><!-- fragment --><p>FAQs: <br />
1 How to get the current remaining heap size? <br />
The <a class="el" href="group___o_s__87x3d___memory.html#ga547499b415b854ec65add9c87bba577f" title="Peek the unused memory size of the specified RAM type. ">mem_peek()</a> API in os_mem.h can return the current remaining heap size. <br />
2 How to get heap water level and task stack water level? <br />
The <a class="el" href="group___h_a_l__87x3d___o_s___e_x_t___exported___functions.html#ga21041ca33568bee9619baefcb23f4d42" title="Create a os timer to monitor free heap and os timer. ">monitor_memory_and_timer()</a> API in os_ext.h will set up a timer to periodically print the heap water level, the current heap remaining size, the number of remaining timers, and the water levels of each task stack. <br />
3 How to get the heap size used by a piece of code? <br />
Refer to the following code. </p><div class="fragment"><div class="line"><span class="keywordtype">size_t</span> free_heap_start =  <a class="code" href="group___o_s__87x3d___memory.html#ga547499b415b854ec65add9c87bba577f">mem_peek</a>();</div><div class="line">test_api();</div><div class="line"><span class="keywordtype">size_t</span> free_heap_end =  <a class="code" href="group___o_s__87x3d___memory.html#ga547499b415b854ec65add9c87bba577f">mem_peek</a>();</div><div class="line"><span class="keywordtype">size_t</span> used_heap = free_heap_start - free_heap_end;</div></div><!-- fragment --><p> <br />
4 How to get the size currently used by APP RAM Text and APP Global? <br />
The app.map file shows the size currently used by APP RAM TEXT and APP RAM GLOBAL </p><div class="fragment"><div class="line">Execution Region RAM_TEXT (Exec base: 0x00208800, Load base: 0x021453cc, Size: 0x000011fc, Max: 0x00001400, ABSOLUTE)</div><div class="line">Execution Region RAM_GLOBAL (Exec base: 0x002c0000, Load base: 0x02144d0c, Size: 0x00002918, Max: 0x00003800, ABSOLUTE)</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_flash"></a>
4 Flash</h2>
<p>RTL87X3D supports external SPI flash by installing an SPI controller (SPIC). Each SPI flash on board is controlled by a SPIC which has a mapping memory to it. The maximum flash size considering different SPIC mapping memory ranges is as follows: 32M bytes for SPIC0, SPIC1, and SPIC2, and 256M bytes for SPIC3. RTL87X3D has a flash cache for SPIC0, which could increase both data reading and code execution efficiencies on SPI flash. Also, RTL87X3D provides a mapping address range, from 0x4000000 to 0x5FFFFFF, which allows the CPU or DMA to have direct access to the SPIC0 flash. Moreover, Realtek offers the low-level flash driver, FTL, and high-level flash storage APIs.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_efuse"></a>
5 eFuse</h2>
<p>eFuse is a block of one-time programming memory that is used to store important and fixed information, such as UUID, security key, and many other configurations. And only certain sections can be modified by the user. The single bit of eFuse could not be changed from 0 to 1, and there is no erase operation for eFuse, so be careful when updating eFuse.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="mem_psram"></a>
6 PSRAM</h2>
<p>For QPI PSRAM, RTL87X3D supports external AP memory SPI PSRAM by installing an SPI Controller (SPIC). Each SPI PSRAM on board is controlled by a SPIC which has a mapping memory to it. The maximum PSRAM size considering different SPIC mapping memory ranges is as follows: 32M bytes for SPIC0, SPIC1, and SPIC2, and 256M bytes for SPIC3. RTL87X3D supports APS1604M through SPIC1, SPIC2 and SPIC3. As for OPI PSRAM, RTL87X3D supports external Winbond hyper bus interface PSRAM (HyperRAM) by installing a PSRAM Low Pin Count Controller (PSRAM LPC CTRL). The Winbond OPI PSRAM on board is controlled by the PSRAM LPC CTRL which has a mapping memory to it. And the maximum OPI PSRAM size considering PSRAM LPC CTRL mapping memory range is 32M bytes. RTL87X3D supports two OPI PSRAMs: W955D8MBYA whose size is 4M bytes and W956D8MBKX whose size is 8M bytes. Further, Realtek offers APIs to initialize both OPI and QPI PSRAM where PSRAM can be read and written like SRAM after being initialized. </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
