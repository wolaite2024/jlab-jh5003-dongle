<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="APP_ANC_Module_Page"></a>
APP ANC Module Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2023/06/17</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/06/17  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Rev">Revision History</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Table_List">Table List</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Configuration">2 Anc Configuration</a><ul>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_AncDesignTool_Configuration">2.1 AncDesignTool Configuration</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_McuConfigTool_Configuration">2.2 McuConfigTool Configuration</a></li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANCMPTool_Configuration">2.3 ANCMPTool Configuration</a></li>
</ul>
</li>
<li><a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#ANC_Scource_code_overview">3 Source code overview for ANC module</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 ANC Selection</a></li>
<li><a href="#figure_2_2">Figure 2-2 ANC Design Tool Setting</a></li>
<li><a href="#figure_2_3">Figure 2-3 Setting different ANC scenarios in ANC Design Tool</a></li>
<li><a href="#figure_2_4">Figure 2-4 ANC Hardware setting</a></li>
<li><a href="#figure_2_5">Figure 2-5 ANC Audio Route setting</a></li>
<li><a href="#figure_2_6">Figure 2-6 Key Setting for ANC</a></li>
<li><a href="#figure_2_7">Figure 2-7 ANC ringtone setting</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ANC  </td><td class="markdownTableBodyCenter">Active Noise Cancellation   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of ANC application.The following topics are included:</p><ul>
<li>Configuration in McuConfigTool</li>
<li>Source code review</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Configuration"></a>
2 Anc Configuration</h2>
<p>For products with more than one ANC scenario, when executing ANC scenario switch case, for example MMI 0xD1, valid ANC idx should be choosed from selected list.</p>
<p>The following flow chart gives an overview of ANC selected list generation. Including:</p><ul>
<li>Output ANC bin form ANC Design Tool</li>
<li>Burn gain and activate ANC scenarios</li>
<li>Selection from remote tool</li>
<li>Configuration in McuConfigTool</li>
</ul>
<div class="image">
<img src="ANC_Selection.png" alt="ANC_Selection.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 ANC Selection</b></div></center><p> <br />
 There can be 5 scenarios at most in ANC selected list.</p>
<h3><a class="anchor" id="ANC_AncDesignTool_Configuration"></a>
2.1 AncDesignTool Configuration</h3>
<p>For ANC effect, users need to configure ANC effect parameter for ear bud, which is called ANC scenario. Make sure to check ANC enable check box, and set the configurations that align with the setting in MCU config tool. </p><div class="image">
<img src="ANC_Design_tool_01.png" alt="ANC_Design_tool_01.png"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 ANC Design Tool Setting</b></div></center><p> <br />
 Click to "Edit Group", then users can configure different ANC scenarios. </p><div class="image">
<img src="ANC_Design_tool_02.png" alt="ANC_Design_tool_02.png"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Setting different ANC scenarios in ANC Design Tool</b></div></center><p> <br />
 <br />
</p>
<h3><a class="anchor" id="ANC_McuConfigTool_Configuration"></a>
2.2 McuConfigTool Configuration</h3>
<p>ANC can be enabled by changing some setting in "HW Feature" page and "Audio Route" page.<br />
 Users should choose an ANC type, and configure FF mic as well as FB mic if needed. </p><div class="image">
<img src="ANC_MCUconfig_setting.png" alt="ANC_MCUconfig_setting.png"/>
</div>
 <center><div id="figure_2_4"><b>Figure 2-4 ANC Hardware setting</b></div></center><p> <br />
 <br />
 </p><div class="image">
<img src="ANC_Audio_Route_Setting.png" alt="ANC_Audio_Route_Setting.png"/>
</div>
 <center><div id="figure_2_5"><b>Figure 2-5 ANC Audio Route setting</b></div></center><p> <br />
 Select trigger method and action in "KEY" page if needed. </p><div class="image">
<img src="Key_Setting_ANC.png" alt="Key_Setting_ANC.png"/>
</div>
 <center><div id="figure_2_6"><b>Figure 2-6 Key Setting for ANC</b></div></center><p> <br />
 <br />
 For ringtone configuration, once the order of ANC scenario groups is set by ANC Design Tool, the ringtone shall be configured in the same order. </p><div class="image">
<img src="Tone_Setting_ANC.png" alt="Tone_Setting_ANC.png"/>
</div>
 <center><div id="figure_2_7"><b>Figure 2-7 ANC ringtone setting</b></div></center><p> <br />
 <br />
</p>
<h3><a class="anchor" id="ANCMPTool_Configuration"></a>
2.3 ANCMPTool Configuration</h3>
<p>ANCMPTool is designed to be used in product line. The main purpose of this tool is to adjust ANC global gain. For more details please refer to <em>ANCMPTool User Guide.pdf</em> .</p>
<p>Default only the first ANC scenario is activated even more than one ANC scenarios existed in ANC bin. If more ANC scenarios are needed, burn action for required scenarios should be done in ANCMPTool.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="ANC_Scource_code_overview"></a>
3 Source code overview for ANC module</h2>
<p>This section describes ANC module in APP layer. <br />
The reference file is shown as follows:</p>
<ul>
<li>Project source code directory: sdk\src\sample\rws\app_anc.c</li>
</ul>
<p>This module is used to handle ANC related behaviors.</p>
<h3>3.1 ANC Initialization</h3>
<p>Initialize parameters and register related callback function. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_anc_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_anc_activated_scenario_init();</div><div class="line">    app_anc_set_first_anc_sceanrio(&amp;<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.last_anc_on_state);</div><div class="line"><span class="preprocessor">#if F_APP_SUPPORT_ANC_APT_COEXIST</span></div><div class="line">    <a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.last_anc_apt_on_state = ANC_TO_ANC_APT_STATE(<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.last_anc_on_state);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    <a class="code" href="group___a_u_d_i_o___m_a_n_a_g_e_r___a_u_d_i_o.html#ga67189dab89dfb141cf0ada6529f057bd">audio_mgr_cback_register</a>(app_anc_audio_cback);</div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga5d2a3ae9710b2036a2907647a1932f0f">app_timer_reg_cb</a>(app_anc_timeout_cb, &amp;anc_timer_id);</div><div class="line">    <a class="code" href="group___b_t___b_t_m.html#gad5518472fde08b8e93d5fc9c40d72f85">bt_mgr_cback_register</a>(app_anc_bt_cback);</div><div class="line">    <a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#ga6b27ecfe7b3dfa93341db098f907a839">sys_mgr_cback_register</a>(app_anc_dm_cback);</div><div class="line">    <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga3973f461a62ef1eadfe82daa3f18ce8e">app_relay_cback_register</a>(app_anc_relay_cback, app_anc_parse_cback,</div><div class="line">                             <a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedea166778ec58ff8edffd2a5a29a9099348">APP_MODULE_TYPE_ANC</a>, APP_REMOTE_MSG_ANC_TOTAL);</div><div class="line">}</div></div><!-- fragment --><h3>3.2 ANC Enable</h3>
<p>Enable ANC with scenario_id. The scenario_id can refer to the offset in activated list.<br />
</p>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_enable(uint8_t scenario_id)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (anc_state != ANC_STARTED)</div><div class="line">    {</div><div class="line">        anc_state = ANC_STARTING;</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___a_u_d_i_o___a_n_c.html#ga9b603573c35b301c3d0013450d25db04">anc_enable</a>(scenario_id);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><p>For example: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (app_anc_is_anc_on_state(new_state))</div><div class="line">{</div><div class="line">    uint8_t new_anc_scenario = new_state - <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a>;</div><div class="line">    uint8_t coff_idx = app_anc_get_coeff_idx(new_anc_scenario);</div><div class="line">    app_anc_enable(coff_idx);</div><div class="line">}</div></div><!-- fragment --><h3>3.3 ANC Disable</h3>
<div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_disable(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (anc_state != ANC_STOPPED)</div><div class="line">    {</div><div class="line">        anc_state = ANC_STOPPING;</div><div class="line">        <span class="keywordflow">return</span> <a class="code" href="group___a_u_d_i_o___a_n_c.html#ga57e621ca2586893c3533262f0fcde4eb">anc_disable</a>();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><h3>3.4 Other APIs for ANC module</h3>
<h4>void app_anc_cmd_pre_handle(uint16_t anc_cmd, uint8_t *param_ptr, uint16_t param_len, uint8_t path, uint8_t app_idx, uint8_t *ack_pkt);</h4>
<p>Send event ack to Controller before starting to handle ANC-related commands. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_anc_cmd_pre_handle(uint16_t anc_cmd, uint8_t *param_ptr, uint16_t param_len, uint8_t path,</div><div class="line">                            uint8_t app_idx, uint8_t *ack_pkt)</div><div class="line">{</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gab68a0f6aaed4553d0c5bad7608f434dc">app_report_event</a>(path, <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a224b309b64b9729b2ce0b57bc39a84a4">EVENT_ACK</a>, app_idx, ack_pkt, 3);</div><div class="line">    app_anc_cmd_handle(anc_cmd, param_ptr, param_len, path, app_idx);</div><div class="line">}</div></div><!-- fragment --><h4>void app_anc_cmd_handle(uint16_t anc_cmd, uint8_t *param_ptr, uint16_t param_len, uint8_t path, uint8_t app_idx);</h4>
<p>Handle ANC-related commands sent from SPP/UART/LE.</p>
<h4>bool app_anc_is_anc_on_state(T_ANC_APT_STATE state)</h4>
<p>Check if ANC is on or not. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_is_anc_on_state(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a> state)</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> ret = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((state == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a>) ||</div><div class="line">        (state == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341aa2dd4c5fefcac92a43205b2e3d49aa38">ANC_ON_SCENARIO_2_APT_OFF</a>) ||</div><div class="line">        (state == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341acb2169318716bd35a7cde88f3014bf80">ANC_ON_SCENARIO_3_APT_OFF</a>) ||</div><div class="line">        (state == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a9c2326808f15496c0f3e6e7389ad5e43">ANC_ON_SCENARIO_4_APT_OFF</a>) ||</div><div class="line">        (state == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341ab57eec225cf014779706759231b875c9">ANC_ON_SCENARIO_5_APT_OFF</a>))</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --><h4>uint8_t app_anc_get_activated_scenario_cnt(void)</h4>
<p>Get the numbers of ANC scenarios that is enable in ANC image. </p><div class="fragment"><div class="line">uint8_t app_anc_get_activated_scenario_cnt(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> app_listening_count_1bits((uint32_t)anc_group_data.anc_activated_list);</div><div class="line">}</div></div><!-- fragment --><h4>uint8_t app_anc_get_selected_scenario_cnt(void)</h4>
<p>Get the numbers of ANC scenarios that is enable in phone tool. </p><div class="fragment"><div class="line">uint8_t app_anc_get_selected_scenario_cnt(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> app_listening_count_1bits((uint32_t)<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a59e4b08fdf4993f1132aee66099cfe04">anc_selected_list</a>);</div><div class="line">}</div></div><!-- fragment --><h4>bool app_anc_set_first_anc_sceanrio(T_ANC_APT_STATE *state);</h4>
<p>Set the first ANC scenario when listening mode status is switched to ANC on. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_set_first_anc_sceanrio(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a> *state)</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    uint8_t first_scenario_index;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (first_scenario_index = 0; first_scenario_index &lt; ANC_MP_GRP_INFO_BITS; first_scenario_index++)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a59e4b08fdf4993f1132aee66099cfe04">anc_selected_list</a> &amp; <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga3a8ea58898cb58fc96013383d39f482c">BIT</a>(first_scenario_index))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (first_scenario_index + <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a> &gt; <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341ab57eec225cf014779706759231b875c9">ANC_ON_SCENARIO_5_APT_OFF</a>)</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (ret)</div><div class="line">    {</div><div class="line">        *state = (<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a>)(first_scenario_index + <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --><h4>T_ANC_SWITCH_SCENARIO app_anc_switch_next_scenario(uint8_t anc_current_scenario)</h4>
<p>Check if the next ANC scenario is available or not. </p><div class="fragment"><div class="line">T_ANC_SWITCH_SCENARIO app_anc_switch_next_scenario(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a> anc_current_scenario,</div><div class="line">                                                   <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a> *anc_next_scenario)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (!app_anc_is_anc_on_state(anc_current_scenario))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> ANC_SWITCH_SCENARIO_NO_DEFINE;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a> scenario_index = ++anc_current_scenario;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (; scenario_index &lt;= <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341ab57eec225cf014779706759231b875c9">ANC_ON_SCENARIO_5_APT_OFF</a>; scenario_index++)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a59e4b08fdf4993f1132aee66099cfe04">anc_selected_list</a> &amp; <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga3a8ea58898cb58fc96013383d39f482c">BIT</a>(scenario_index - <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a>))</div><div class="line">        {</div><div class="line">            *anc_next_scenario = scenario_index;</div><div class="line">            <span class="keywordflow">return</span> ANC_SWITCH_SCENARIO_SUCCESS;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ANC_SWITCH_SCENARIO_MAX;</div><div class="line">}</div></div><!-- fragment --><h4>bool app_anc_open_condition_check(void)</h4>
<p>Check if ANC can be on or not. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_open_condition_check(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">/* check SCO condition to open ANC */</span></div><div class="line"><span class="preprocessor">#if F_APP_SINGLE_MUTLILINK_SCENERIO_1</span></div><div class="line">    <span class="keywordflow">if</span> ((app_teams_multilink_get_voice_status() != <a class="code" href="group___a_p_p___t_y_p_e_s___exported___types.html#ggaf2f8fc888bbf7f82bcfc5706b8edf1fdac8a8473bf674a3c7b5d5eabaa82ca24b">APP_CALL_IDLE</a>) &amp;&amp;</div><div class="line">        (!<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#ad0ffa66793b0b9a4085a44e2e114d7ae">enable_anc_when_sco</a>))</div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    <span class="keywordflow">if</span> ((<a class="code" href="group___a_p_p___h_f_p___exported___functions.html#gaef415e5a1bb0cf3dab1a460d3f48cf6b">app_hfp_get_call_status</a>() != <a class="code" href="group___a_p_p___t_y_p_e_s___exported___types.html#ggaf2f8fc888bbf7f82bcfc5706b8edf1fdac8a8473bf674a3c7b5d5eabaa82ca24b">APP_CALL_IDLE</a>) &amp;&amp; (!<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#ad0ffa66793b0b9a4085a44e2e114d7ae">enable_anc_when_sco</a>))</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group___g_s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga667e43446e8246b214bdbe96809e7d62">LIGHT_SENSOR_ENABLED</a> &amp;&amp;</div><div class="line">             (!<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a5a4f391f4e026ff06fa21d8bf5472dad">listening_mode_does_not_depend_on_in_ear_status</a>))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (((<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> != <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a673a27baaad47fd731a4458b2250a6a6">REMOTE_SESSION_ROLE_SINGLE</a>) &amp;&amp;</div><div class="line">             ((<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.remote_loc != <a class="code" href="group___a_p_p___m_a_i_n___exported___types.html#ga295a9e70616e975f6adeddb49dc23e7bafe90ad8bdfa1798d1bf2b221695c3b95">BUD_LOC_IN_EAR</a>)</div><div class="line">#<span class="keywordflow">if</span> <a class="code" href="group___a_p_p___f_l_a_g_s.html#gaf7dd5ccfb7e3a6df17b70357347b743c">F_APP_AIRPLANE_SUPPORT</a></div><div class="line">              &amp;&amp; (!app_airplane_mode_get())</div><div class="line">#endif</div><div class="line">             )) ||</div><div class="line">            (<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.local_loc != <a class="code" href="group___a_p_p___m_a_i_n___exported___types.html#ga295a9e70616e975f6adeddb49dc23e7bafe90ad8bdfa1798d1bf2b221695c3b95">BUD_LOC_IN_EAR</a>))</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.gaming_mode)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#acf2ce4d924ad90b855b3713705780a23">disallow_listening_mode_on_when_gaming_mode</a>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (app_anc_get_selected_scenario_cnt() == 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">}</div></div><!-- fragment --><h4>uint8_t app_anc_get_coeff_idx(uint8_t scenario_id)</h4>
<p>Convert the index number to match the index in Codec layer. </p><div class="fragment"><div class="line">uint8_t app_anc_get_coeff_idx(uint8_t scenario_id)</div><div class="line">{</div><div class="line">    int8_t order = -1;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; ANC_MP_GRP_INFO_BITS; i++)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (anc_group_data.anc_activated_list &amp; <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga3a8ea58898cb58fc96013383d39f482c">BIT</a>(i))</div><div class="line">        {</div><div class="line">            order++;</div><div class="line">            <span class="keywordflow">if</span> (order == scenario_id)</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#gadbd6667019aa1db0ec6456ec90268f4f">APP_PRINT_TRACE1</a>(<span class="stringliteral">&quot;app_anc_get_coeff_idx, coeff idx:%d&quot;</span>, i);</div><div class="line">                <span class="keywordflow">return</span> i;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;app_anc_get_coeff_idx, scenario id out of range&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0xFF;</div><div class="line">}</div></div><!-- fragment --><h4>bool app_anc_related_event(T_ANC_APT_EVENT event)</h4>
<p>Check the input event is related to ANC or not. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_related_event(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ga1f67a027bf5550cc90d38c8fd68cab76">T_ANC_APT_EVENT</a> event)</div><div class="line">{</div><div class="line">    <span class="keywordtype">bool</span> ret = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> ((event == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76ab4df6a4345f054fbf68c6cfc5cd1b49d">EVENT_ANC_ON_SCENARIO_1</a>) || (event == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76ab5d479a3b8c5870e714fa60a40d49b40">EVENT_ANC_ON_SCENARIO_2</a>) ||</div><div class="line">        (event == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76a9252cad27ceabd1bc06ce2f873759b53">EVENT_ANC_ON_SCENARIO_3</a>) || (event == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76aaca65ad8e56518458f897f2248fa36c7">EVENT_ANC_ON_SCENARIO_4</a>) ||</div><div class="line">        (event == <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76a4fe6acb6782b1c3d51860155f3590123">EVENT_ANC_ON_SCENARIO_5</a>))</div><div class="line">    {</div><div class="line">        ret = <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> ret;</div><div class="line">}</div></div><!-- fragment --><h4>void app_anc_enter_scenario_select_mode(void)</h4>
<p>Enter phone tool's ANC scenario selection mode. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_anc_enter_scenario_select_mode(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    anc_group_data.enter_anc_select_mode = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76ad0cd1074ac132eeef5098f05fdfd46a0">EVENT_ALL_OFF</a>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">}</div></div><!-- fragment --><h4>uint8_t app_anc_scenario_select_is_busy(void);</h4>
<p>Check if phone tool's ANC scenario selection mode is active or not. </p><div class="fragment"><div class="line">uint8_t app_anc_scenario_select_is_busy(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">return</span> anc_group_data.enter_anc_select_mode;</div><div class="line">}</div></div><!-- fragment --><h4>void app_anc_exit_scenario_select_mode(void)</h4>
<p>Exit phone tool's ANC scenario selection mode. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_anc_exit_scenario_select_mode(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76ad0cd1074ac132eeef5098f05fdfd46a0">EVENT_ALL_OFF</a>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    anc_group_data.enter_anc_select_mode = <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><h4>bool app_anc_is_busy(void)</h4>
<p>Check if listening mode status is during switching ANC on/off or not. </p><div class="fragment"><div class="line"><span class="keywordtype">bool</span> app_anc_is_busy(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (anc_state == ANC_STOPPING ||</div><div class="line">        anc_state == ANC_STARTING)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
