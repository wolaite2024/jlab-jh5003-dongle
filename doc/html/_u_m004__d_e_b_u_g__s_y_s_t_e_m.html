<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="DbgSys"></a>
Debugging System  </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/06/05</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="DbgSys_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/04/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/06/05  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSys_Rev">Revision History</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSys_Table_List">Table List</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSys_Figure_List">Figure List</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSys_Glossary">Glossary</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSysIntro">1 Introduction</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech">2 Log Mechanism</a><ul>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Debug_Level">2.1 Debug Level</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Wrapped_Interface">2.2 Wrapped Interfaces for Log Printing</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Auxiliary_Interface">2.3 Auxiliary Interfaces</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Print_Example">2.4 Log Print Example</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Control_Interfaces">2.5 Log Control Interfaces</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#LogMech_Control_Sample">2.6 Log Control Sample Scenarios</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#Direct_Log_Printing">2.7 Direct Log Printing</a></li>
</ul>
</li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#Dbg_and_Trace">3 Debug and Trace</a><ul>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSwd_CoreSight_Intro">3.1 CoreSight Introduction</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSwd_CoreSight_Features">3.2 Implemented CoreSight Features</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSwd_DWT">3.3 Using Trace Port Interface DWT</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSwd_SWD">3.4 Using SWD Debug Interface</a><ul>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#SWD_Hardware">3.4.1 SWD Hardware</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#SWD_with_Keil">3.4.2 SWD with Keil</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#Download_with_Keil">3.4.3 Download with Keil</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#SWD_with_Jlink_Commander">3.4.3 SWD with Jlink Commander</a></li>
</ul>
</li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#traceAlyzer">3.5 TraceAlyzer</a><ul>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#traceAlyzer_Intro">3.5.1 TraceAlyzer Introduction</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#traceAlyzer_ADD_ISR_Info">3.5.2 Add ISR Trace Info</a></li>
<li><a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#traceAlyzer_Setting">3.5.3 TraceAlyzer Setting</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="DbgSys_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_2_1">Table 2-1 Debug Level</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="DbgSys_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_3_1">Figure 3-1 CoreSight Structure in Cortex-M3/M4</a></li>
<li><a href="#figure_3_2">Figure 3-2 The definition of SWD Interface</a></li>
<li><a href="#figure_3_3">Figure 3-3 Reserve P1_0 and P1_1 Pins in the MCU Config Tool</a></li>
<li><a href="#figure_3_4">Figure 3-4 Set the Debug Interface</a></li>
<li><a href="#figure_3_5">Figure 3-5 Set the Configuration for Jlink</a></li>
<li><a href="#figure_3_6">Figure 3-6 Disable Target Update</a></li>
<li><a href="#figure_3_7">Figure 3-7 Debug Start</a></li>
<li><a href="#figure_3_8">Figure 3-8 Input Command and Set Breakpoints</a></li>
<li><a href="#figure_3_9">Figure 3-9 Click the Run Button</a></li>
<li><a href="#figure_3_10">Figure 3-10 Pop-up dialog for no SW device</a></li>
<li><a href="#figure_3_11">Figure 3-11 Add a Delay before main()</a></li>
<li><a href="#figure_3_12">Figure 3-12 PC Stop at main()</a></li>
<li><a href="#figure_3_13">Figure 3-13 Keil Download Setting</a></li>
<li><a href="#figure_3_14">Figure 3-14 Download Bin with Keil</a></li>
<li><a href="#figure_3_15">Figure 3-15 Jlink Software and Documentation Pack</a></li>
<li><a href="#figure_3_16">Figure 3-16 Start Jlink Commander</a></li>
<li><a href="#figure_3_17">Figure 3-17 Connect MCU</a></li>
<li><a href="#figure_3_18">Figure 3-18 Specify Device/Core</a></li>
<li><a href="#figure_3_19">Figure 3-19 Select Cortex-M4 for RTL87X3D</a></li>
<li><a href="#figure_3_20">Figure 3-20 Specify Target Interface as SWD</a></li>
<li><a href="#figure_3_21">Figure 3-21 Specify the SWD Speed as 1MHz</a></li>
<li><a href="#figure_3_22">Figure 3-22 Debug Info</a></li>
<li><a href="#figure_3_23">Figure 3-23 Add a Dead Loop in system_init()</a></li>
<li><a href="#figure_3_24">Figure 3-24 (a)PC in Jlink Commander (b) Addr of while(1)</a></li>
<li><a href="#figure_3_25">Figure 3-25 PC in Jlink Commander</a></li>
<li><a href="#figure_3_26">Figure 3-26 Set BP and Check the PC</a></li>
<li><a href="#figure_3_27">Figure 3-27 Let MCU Go and It Will Halted at BP</a></li>
<li><a href="#figure_3_28">Figure 3-28 Clear BP with its Handle</a></li>
<li><a href="#figure_3_29">Figure 3-29 Assembly Addr for Hello++</a></li>
<li><a href="#figure_3_30">Figure 3-30 Figure 3-28 Addr for Hello</a></li>
<li><a href="#figure_3_31">Figure 3-31 Set a Watchpoint</a></li>
<li><a href="#figure_3_32">Figure 3-32 Check the Regsters</a></li>
<li><a href="#figure_3_33">Figure 3-33 LDR at 0x8322de</a></li>
<li><a href="#figure_3_34">Figure 3-34 Value in 1000769C is 0x5</a></li>
<li><a href="#figure_3_35">Figure 3-35 Halt MCU and Single Step</a></li>
<li><a href="#figure_3_36">Figure 3-36 TraceAlyzer Setting</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="DbgSys_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">JTAG  </td><td class="markdownTableBodyCenter">JointTest Action Group   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">SWD  </td><td class="markdownTableBodyCenter">Serial Wire Debug   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ETM  </td><td class="markdownTableBodyCenter">Embedded Trace Macrocell   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">ITM  </td><td class="markdownTableBodyCenter">Instrumentation Trace Macrocell   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">DWT  </td><td class="markdownTableBodyCenter">Data Watchpoint &amp; Trace Unit   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="DbgSysIntro"></a>
1 Introduction</h2>
<p>There are two debugging methods to debug user applications:</p><ol type="1">
<li>Use a log mechanism to trace code procedures and data.</li>
<li>Use Keil MDK and SWD to do the running control, add/delete breakpoints, access/trace memory, and so on.</li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="LogMech"></a>
2 Log Mechanism</h2>
<p>There is a configurable log UART pin (P2_0 as default) to print logs, and several APIs have been provided to easily control.</p>
<ol type="1">
<li>As log output is disabled as default, users should enable it in MCU Config Tool and download the output config file through MPPG Tool.</li>
<li>Log data is output in a specific format, and the corresponding <em>*.trace</em> file would be generated in the <em>bin</em> folder of the current App project. Debug Analyzer Tool provides the ability to load the trace file, and it can retrieve, analyze, display, and save the logs. Please refer to <em>Debug Analyzer Tool User Manual</em> for detailed usage of the tool.</li>
<li>If the log pin is changed to the other pin through MCU Config Tool, the new log pin will be valid in the sys patch image for the ic rtl87x3e, or the rom patch image for the ic rtl87x3d. There will be some boot logs output through the default log pin P2_0.</li>
</ol>
<h3><a class="anchor" id="LogMech_Debug_Level"></a>
2.1 Debug Level</h3>
<p>There is a concept named Debug Level, and it indicates which level the log is displayed. Four levels are defined: </p><center><div id="table_2_1"><b>Table 2-1 Debug Level</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Debug Level  </th><th class="markdownTableHeadCenter">Usage Scenario   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">LEVEL_ERROR  </td><td class="markdownTableBodyCenter">fatal, the procedure could not advance (Log Token !!!)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">LEVE_WARN  </td><td class="markdownTableBodyCenter">abnormal condition occurred, but procedure could advance (Log Token !!*)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">LEVEL_INFO  </td><td class="markdownTableBodyCenter">important notification (Log Token !**)   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">LEVEL_TRACE  </td><td class="markdownTableBodyCenter">verbose debug   </td></tr>
</table>
<p>The DBG_BUFFER() API is flexible and powerful but may be difficult to use. SDK has wrapped it and provided some readable APIs in trace. h.</p>
<h3><a class="anchor" id="LogMech_Wrapped_Interface"></a>
2.2 Wrapped Interfaces for Log Printing</h3>
<p>There are several wrapped APIs for the user to print logs, and all of them have a common syntax: </p><div class="fragment"><div class="line">{MODULE}_PRINT_{LEVEL}{PARAMNUM}(...)</div></div><!-- fragment --><p> <b>{MODULE}</b> could be replaced with the module name defined in trace.h, such as APP/GAP/USB/FLASH...</p>
<p><b>{LEVEL}</b> could be replaced with the debug level: ERROR/WARN/INFO/TRACE.</p>
<p><b>{PARAMNUM}</b> could be replaced with numbers 0 to 8, which means the number of parameters this log would print out.</p>
<p>For example, if the user wants to print a warning log with 2 parameters in the application, the code should be written like this: </p><div class="fragment"><div class="line"><a class="code" href="group__x3d___t_r_a_c_e.html#ga119fd2acd5891c483b8424bb3b93d41a">APP_PRINT_WARN2</a>(<span class="stringliteral">&quot;Test app: ID = %d, data = 0x%x&quot;</span>, <span class="keywordtype">id</span>, data);</div></div><!-- fragment --><p> Then Debug Analyzer Tool would show this log like: </p><div class="fragment"><div class="line">00494 10-13#17:06:45.994 087 02145.435 [APP] !!*Test app: ID = 3, data = 0xF0</div></div><!-- fragment --><ol type="1">
<li>Do not exceed 8 parameters (Maximum 20 parameters if using DBG_BUFFER() directly).</li>
<li>Put all parameters into a single print if possible.</li>
</ol>
<h3><a class="anchor" id="LogMech_Auxiliary_Interface"></a>
2.3 Auxiliary Interfaces</h3>
<p>The DBG_BUFFER() API can only print simple formats like Integer (d, i, u, o, x), Character (c), and Pointer (p). Sometimes the user wants to print a string, binary array, or BT Address, thus three auxiliary interfaces have been provided.</p>
<ol type="1">
<li><p class="startli"><code><a class="el" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ga78c7b103f1c05e69c26a3b5d615de7e8">TRACE_STRING(char* data)</a></code></p>
<p class="startli">Directly put the string into log data, and the conversion directive is <b>s</b>.</p>
</li>
<li><p class="startli"><code><a class="el" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ga03cf46dce6a4203e1317aaa89f6875d5">TRACE_BINARY(uint16_t length, uint8_t* data)</a></code></p>
<p class="startli">Output binary stream in Hex format, and the conversion directive is <b>b</b>.</p>
</li>
<li><p class="startli"><code><a class="el" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR(char* bd_addr)</a></code></p>
<p class="startli">Output binary array in BT address format, for example:</p>
<p class="startli">Hex Array: 0xaa 0xbb 0xcc 0xdd 0xee 0xff &ndash;&gt; Literal String: FF::EE::DD::CC::BB::AA</p>
</li>
</ol>
<h3><a class="anchor" id="LogMech_Print_Example"></a>
2.4 Log Print Example</h3>
<p>A sample of the common use of log APIs and the corresponding output in Debug Analyzer Tool is shown below.</p>
<p>Log print code: </p><div class="fragment"><div class="line">uint32_t n = 77777;</div><div class="line">uint8_t m = 0x5A;</div><div class="line">uint8_t bd1[6] = {0x00, 0x11, 0x22, 0x33, 0x44, 0x55};</div><div class="line">uint8_t bd2[6] = {0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF};</div><div class="line"><span class="keywordtype">char</span> c1[10] = {<span class="charliteral">&#39;1&#39;</span>, <span class="charliteral">&#39;2&#39;</span>, <span class="charliteral">&#39;3&#39;</span>, <span class="charliteral">&#39;4&#39;</span>, <span class="charliteral">&#39;5&#39;</span>, <span class="charliteral">&#39;6&#39;</span>, <span class="charliteral">&#39;7&#39;</span>, <span class="charliteral">&#39;8&#39;</span>, <span class="charliteral">&#39;9&#39;</span>, <span class="charliteral">&#39;0&#39;</span>};</div><div class="line"><span class="keywordtype">char</span> c2[8] = {<span class="charliteral">&#39;a&#39;</span>, <span class="charliteral">&#39;b&#39;</span>, <span class="charliteral">&#39;C&#39;</span>, <span class="charliteral">&#39;d&#39;</span>, <span class="charliteral">&#39;E&#39;</span>, <span class="charliteral">&#39;F&#39;</span>, <span class="charliteral">&#39;g&#39;</span>, <span class="charliteral">&#39;H&#39;</span>};</div><div class="line"><span class="keywordtype">char</span> *s1 = <span class="stringliteral">&quot;Hello world!&quot;</span>;</div><div class="line"><span class="keywordtype">char</span> *s2 = <span class="stringliteral">&quot;Log Test&quot;</span>;</div><div class="line"><a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ga5929dc01a22c79a86540408c30db91b9">ADC_PRINT_TRACE1</a>(<span class="stringliteral">&quot;ADC value is %d&quot;</span>, n);</div><div class="line"><a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ga1bfe44ca207b56d76dff8791b47c5b99">UART_PRINT_INFO3</a>(<span class="stringliteral">&quot;Serial data: 0x%x, c1[%b], s1[%s]&quot;</span>, m, <a class="code" href="group__x3d___t_r_a_c_e.html#ga03cf46dce6a4203e1317aaa89f6875d5">TRACE_BINARY</a>(10, c1), <a class="code" href="group__x3d___t_r_a_c_e.html#ga78c7b103f1c05e69c26a3b5d615de7e8">TRACE_STRING</a>(s1));</div><div class="line"><a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#gac1b16d19c042d048897becfb6c6b2eb9">GAP_PRINT_WARN6</a>(<span class="stringliteral">&quot;n[%d], m[%c] bd1[%s], bd2[%s], c2[%b], s2[%s]&quot;</span>, n, m, <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(bd1),</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga21deae8960b0d6088c2d18b04a151e66">TRACE_BDADDR</a>(bd2), <a class="code" href="group__x3d___t_r_a_c_e.html#ga03cf46dce6a4203e1317aaa89f6875d5">TRACE_BINARY</a>(8, c2), <a class="code" href="group__x3d___t_r_a_c_e.html#ga78c7b103f1c05e69c26a3b5d615de7e8">TRACE_STRING</a>(s2));</div><div class="line"><a class="code" href="group__x3d___t_r_a_c_e.html#gaf20aac2fd019420214bcab2eadd15156">APP_PRINT_ERROR0</a>(<span class="stringliteral">&quot;APP ERROR OCCURED...&quot;</span>);</div></div><!-- fragment --><p> The corresponding result is shown in Debug Analyzer Tool: </p><div class="fragment"><div class="line">00252 10-25#17:12:02.021 132 10241 [<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga54d148b91f3d356713f7e367a2243bea">ADC</a>] <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga54d148b91f3d356713f7e367a2243bea">ADC</a> value is 77777</div><div class="line">00253 10-25#17:12:02.021 133 10241 [<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#gaf7cb12b462b4594bd759d1b4e241ec4c">UART</a>] !**Serial data: 0x5a, c1[31-32-33-34-35-36-37-38-39-30], s1[Hello world!]</div><div class="line">00254 10-25#17:12:02.022 134 10241 [GAP] !!*n[77777], m[Z] bd1[55::44::33::22::11::00], bd2[FF::EE::DD::CC::BB::AA], c2[61-62-43-64-45-46-67-48], s2[Log Test]</div><div class="line">00255 10-25#17:12:02.022 135 10241 [APP] !!!APP ERROR OCCURRED...</div></div><!-- fragment --><h3><a class="anchor" id="LogMech_Control_Interfaces"></a>
2.5 Log Control Interfaces</h3>
<p>Sometimes user wants to turn on some logs and turn off others. One method is to set the trace mask in MCU Config Tool, and then burn the config file.</p>
<div class="image">
<img src="Set_the_Trace_Mask_in_MCU_Config_Tool.png" alt="Set_the_Trace_Mask_in_MCU_Config_Tool.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Set the Trace Mask in MCU Config Tool</b></div></center><p>However this is not flexible enough as the user may want to change the log level frequently, and it is unwise to re-burn the config file every time. Three APIs have been provided to control the log at a specific level of a specific module:</p>
<ol type="1">
<li><a class="el" href="group___t_r_a_c_e.html#gad89c48545c139cd9243e4f0fd54e65c1" title="Initialize module trace mask. ">log_module_trace_init()</a></li>
<li><a class="el" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5" title="Enable/Disable the module ID&#39;s trace. ">log_module_trace_set()</a></li>
<li><a class="el" href="group___t_r_a_c_e.html#ga9d5855ab8f5b7c416f5608c8017c9f00" title="Enable/Disable module bitmap&#39;s trace. ">log_module_bitmap_trace_set()</a></li>
</ol>
<p>Refer to the SDK API document for details of parameters.</p>
<h3><a class="anchor" id="LogMech_Control_Sample"></a>
2.6 Log Control Sample Scenarios</h3>
<p>Here are some sample scenarios to help understand how to use log control APIs in user applications. Assuming that log print is already enabled and all log trace masks have been set to Enable in MCU Config Tool, this means all types of logs at all levels could be output.</p>
<p><b>Senario 1:</b> Disable all trace level and info level logs of the APP module. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a57c322a1e278e0f390c1d6a2fc570d71">MODULE_APP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#ga3d180faf3ef7ae097b000712909b0e7a">LEVEL_INFO</a>, <span class="keyword">false</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a57c322a1e278e0f390c1d6a2fc570d71">MODULE_APP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#gab559f47bba41e05823554ddf69dc61c2">LEVEL_TRACE</a>, <span class="keyword">false</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> <b>Senario 2:</b> Only enable logs of PROFILE module. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint64_t mask[<a class="code" href="group__x3d___t_r_a_c_e.html#ga24113251522475514a3a547a7bdf5779">LEVEL_NUM</a>];</div><div class="line">    memset(mask, 0, <span class="keyword">sizeof</span>(mask));</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#gad89c48545c139cd9243e4f0fd54e65c1">log_module_trace_init</a>(mask);</div><div class="line"></div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953adef5a4645a70e190e0037fa28d7a6718">MODULE_PROFILE</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#ga2019547e7f5bf5d56a09e5cfa98d0598">LEVEL_ERROR</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953adef5a4645a70e190e0037fa28d7a6718">MODULE_PROFILE</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#gab9684ed10647f8745295829b0b59b959">LEVEL_WARN</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953adef5a4645a70e190e0037fa28d7a6718">MODULE_PROFILE</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#ga3d180faf3ef7ae097b000712909b0e7a">LEVEL_INFO</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953adef5a4645a70e190e0037fa28d7a6718">MODULE_PROFILE</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#gab559f47bba41e05823554ddf69dc61c2">LEVEL_TRACE</a>, <span class="keyword">true</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> <b>Senario 3:</b> Disable trace level logs of PROFILE/PROTOCOL/GAP/APP modules. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga9d5855ab8f5b7c416f5608c8017c9f00">log_module_bitmap_trace_set</a>(<a class="code" href="group__x3d___t_r_a_c_e.html#gae9228673e4e7345aa27475aa434a874e">MODULE_BIT_PROFILE</a> | <a class="code" href="group__x3d___t_r_a_c_e.html#ga0f70deb155831f842fe7239aeee9e1e9">MODULE_BIT_PROTOCOL</a> | <a class="code" href="group__x3d___t_r_a_c_e.html#gadc96a4a473872e441bc150f448f16010">MODULE_BIT_GAP</a> |</div><div class="line">                            <a class="code" href="group__x3d___t_r_a_c_e.html#gae26fb3b9838c8e716b8b7df7ffb8db7f">MODULE_BIT_APP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#gab559f47bba41e05823554ddf69dc61c2">LEVEL_TRACE</a>, <span class="keyword">false</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> <b>Senario 4:</b> Disable all trace level and info level logs except the APP module, and disable BT Snoop logs as well. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">for</span> (uint8_t i = 0; i &lt; <a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a33d08efaa57d69670e25ac55e1ed39df">MODULE_NUM</a>; i++)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>((<a class="code" href="group__x3d___t_r_a_c_e.html#gaefcc1db7449882cf95443afa56b40953">T_MODULE_ID</a>)i, <a class="code" href="group__x3d___t_r_a_c_e.html#gab559f47bba41e05823554ddf69dc61c2">LEVEL_TRACE</a>, <span class="keyword">false</span>);</div><div class="line">        <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>((<a class="code" href="group__x3d___t_r_a_c_e.html#gaefcc1db7449882cf95443afa56b40953">T_MODULE_ID</a>)i, <a class="code" href="group__x3d___t_r_a_c_e.html#ga3d180faf3ef7ae097b000712909b0e7a">LEVEL_INFO</a>, <span class="keyword">false</span>);</div><div class="line">    }</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a57c322a1e278e0f390c1d6a2fc570d71">MODULE_APP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#ga3d180faf3ef7ae097b000712909b0e7a">LEVEL_INFO</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a57c322a1e278e0f390c1d6a2fc570d71">MODULE_APP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#gab559f47bba41e05823554ddf69dc61c2">LEVEL_TRACE</a>, <span class="keyword">true</span>);</div><div class="line">    <a class="code" href="group___t_r_a_c_e.html#ga8dde0c46b33c8604bc3a0c041ce568b5">log_module_trace_set</a>(<a class="code" href="group__x3_e___t_r_a_c_e___e_x_p_o_r_t_e_d___m_a_c_r_o_s.html#ggaefcc1db7449882cf95443afa56b40953a7233806ebaf2793257dd9d530fffd620">MODULE_SNOOP</a>, <a class="code" href="group__x3d___t_r_a_c_e.html#ga2019547e7f5bf5d56a09e5cfa98d0598">LEVEL_ERROR</a>, <span class="keyword">false</span>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><blockquote class="doxtable">
<p>Note that Debug Analyzer Tool could generate a BT Snoop log file (*.cfa) if the LEVEL_ERROR log of MODULE_SNOOP is enabled. In other words, if users turn off the log of MODULE_SNOOP, the BT Snoop log file would not be generated, such as Scenario 2 and Scenario 4. </p>
</blockquote>
<h3><a class="anchor" id="Direct_Log_Printing"></a>
2.7 Direct Log Printing</h3>
<p>DBG_DIRECT() API prints log directly, which supports Integer and string parameters. Its function is the same as the C standard library function printf. Print format and the number of parameters are not limited. Note that this method may cause system performance degradation and incorrect UART data. Therefore, we recommend using it only for debugging. Log print code: </p><div class="fragment"><div class="line">uint32_t n = 77777;</div><div class="line"><span class="keywordtype">char</span> *s1 = <span class="stringliteral">&quot;Hello world!&quot;</span>;</div><div class="line">DBG_DIRECT(<span class="stringliteral">&quot;DBG_DIRECT test %d %s&quot;</span>, n, s1);</div></div><!-- fragment --><p> The corresponding result is shown in Debug Analyzer Tool: </p><div class="fragment"><div class="line">0000047  04-17#12:28:16.181  070  0000359.757  DBG_DIRECT test 77777 Hello world!</div></div><!-- fragment --> <div style="page-break-after: always;"></div><h2><a class="anchor" id="Dbg_and_Trace"></a>
3 Debug and Trace</h2>
<h3><a class="anchor" id="DbgSwd_CoreSight_Intro"></a>
3.1 CoreSight Introduction</h3>
<p>CoreSight is an on-chip debugging and tracing technology designed by ARM. The device manufacturer could implement CoreSight features in various combinations.</p>
<div class="image">
<img src="coresight_in_cortex_m3.png" alt="coresight_in_cortex_m3.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 CoreSight Structure in Cortex-M3/M4</b></div></center><p>CoreSight features could be accessed through a JointTest Action Group (JTAG) or Serial Wire interface. It is impossible to debug in JTAG and Serial Wire mode at the same time. Cortex-M processor-based devices include:</p>
<p><b>Debug Interface</b></p>
<p>The debug interface offers two modes:</p><ul>
<li><b>JTAG Debug</b> is the industry-standard interface that allows device chaining.</li>
<li><b>Serial Wire Debug (SWD)</b> is a 2-pin interface with an optional Serial Wire Trace Output. In contrast to JTAG, devices can not be chained.</li>
</ul>
<p>The debug interface communicates with the following units:</p><ul>
<li><b>Run Control:</b> allows to start, stop, and single-step through the source code.</li>
<li><b>Breakpoint Unit:</b> allows to set breakpoints even while the processor is running.</li>
<li><b>Memory Access Unit:</b> allows to read or write to memory and peripheral registers even while the program is running.</li>
</ul>
<p><b>Trace Port Interface</b></p>
<p>The Trace Port Interface encodes and provides trace information via two possible interfaces:</p><ul>
<li>The <b>Serial Wire Trace Output</b> pin (SWO) could be used in Serial Wire Debug mode only.</li>
<li>The <b>4-Pin Trace Output</b> has a greater bandwidth than Serial Wire Trace Output and it uses 5 functional pins. It is the only way to output ETM trace data.</li>
</ul>
<p>The Trace Port Interface communicates with the following units:</p><ul>
<li><b>Embedded Trace Macrocell (ETM):</b> could be used for instruction tracing to debug historical sequences, software profiling, and code coverage analysis. ETM data are output through an extra 4-bit interface.</li>
<li><b>Instrumentation Trace Macrocell (ITM):</b> provides application information like debug printf, RTOS information, unit test, or UML annotation.</li>
<li><b>Data Watchpoint &amp; Trace Unit (DWT):</b> provides PC sampling, event counters, timing, and interrupt execution information. In addition, it allows access breakpoints for up to four memory addresses.</li>
</ul>
<p><b>Serial Wire-JTAG Switch (SWJ)</b></p>
<p>Jlink/J-Trace generates sequences to automatically switch between Serial Wire Debug and JTAG Debug mode.</p>
<h3><a class="anchor" id="DbgSwd_CoreSight_Features"></a>
3.2 Implemented CoreSight Features</h3>
<p>The following three basic debug interfaces are supported: run control, breakpoint, and memory access. Besides, an advanced feature named access-breakpoint (a.k.a. Debug Monitor) which is one of the features of DWT, is also supported. The usage of this feature is introduced in the following chapter <a class="el" href="_u_m004__d_e_b_u_g__s_y_s_t_e_m.html#DbgSwd_DWT">3.3 Using Trace Port Interface DWT</a>.</p>
<h3><a class="anchor" id="DbgSwd_DWT"></a>
3.3 Using Trace Port Interface DWT</h3>
<p>provides a method to trace memory using DWT. And a group of four APIs is provided to monitor up to four memory areas: <a class="el" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___functions.html#ga77a673b34e40af6d793b22658da95ae8" title="Check if debug monitor is enbale. ">debug_monitor_point_set()</a>.</p>
<p>Here is a sample to show how to use the debug monitor APIs. </p><div class="fragment"><div class="line"><a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___functions.html#gad81e69fc2406408ee1bb70e49a061f07">debug_monitor_enable</a>();</div><div class="line"><a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___functions.html#ga77a673b34e40af6d793b22658da95ae8">debug_monitor_point_set</a>(<a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#ggaed42ddaaddb3fc573edf1c540b81edffa92ca7b07c69cf298fd28cce010590f6f">WATCH_POINT_INDEX0</a>, 0x200000, <a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#ggabb9ad058ce6b4cbc0aee46fbfa33161ba5ae5d9eeb327ba2da47bc44f8a3dd40d">WATCH_POINT_BYTE</a>, <a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#gga4b30e9abb0856d52ca45c78f532dafdca4e450b0ac428ed980323dbb80ee9093c">WATCH_POINT_FUNCTION_DADDR_W</a>);</div><div class="line"><a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___functions.html#ga77a673b34e40af6d793b22658da95ae8">debug_monitor_point_set</a>(<a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#ggaed42ddaaddb3fc573edf1c540b81edffa9d22c83d1bcb0ce277832e7f34c76691">WATCH_POINT_INDEX1</a>, 0x200008, <a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#ggabb9ad058ce6b4cbc0aee46fbfa33161ba5ae5d9eeb327ba2da47bc44f8a3dd40d">WATCH_POINT_BYTE</a>, <a class="code" href="group___h_a_l___p_l_a_t_f_o_r_m___e_x_t___exported___variables.html#gga4b30e9abb0856d52ca45c78f532dafdca4e450b0ac428ed980323dbb80ee9093c">WATCH_POINT_FUNCTION_DADDR_W</a>);</div></div><!-- fragment --><p> If the interested memory is accessed, the debug monitor interrupt would be triggered. PC register which is the broken position would be printed to the log UART and it could be traced by Debug Analyzer Tool.</p>
<h3><a class="anchor" id="DbgSwd_SWD"></a>
3.4 Using SWD Debug Interface</h3>
<p>Customers can use SWD debugging with Keil or Jlink Commander.</p>
<h4><a class="anchor" id="SWD_Hardware"></a>
3.4.1 SWD Hardware</h4>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.1.1 RTL87X3E to Jlink Connection</h5>
<p>The SWD interface is as follows: </p><div class="image">
<img src="definition_of_SWD_interface.png" alt="definition_of_SWD_interface.png"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 The definition of SWD Interface</b></div></center><p> There are four pins to connect to the Jlink - VCC, SWCLK, SWDIO, and GND. These pins correspond to VDD, CLK, IO, and GND on the EVB board.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.1.2 MCU Config Tool Settings</h5>
<p>P1_0 and P1_1 pins are set to SWDIO and SWCLK. Therefore, Do not use P1_0 and P1_1 pins in the MCU Config Tool </p><div class="image">
<img src="pin_setting_in_the_MCU_Config_Tool.png" alt="pin_setting_in_the_MCU_Config_Tool.png"/>
</div>
 <center><div id="figure_3_3"><b>Figure 3-3 Reserve P1_0 and P1_1 Pins in the MCU Config Tool</b></div></center> <h4><a class="anchor" id="SWD_with_Keil"></a>
3.4.2 SWD with Keil</h4>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.2.1 Set the Debug Interface</h5>
<p>Install the appropriate Jlink driver and then select the corresponding one in Debug Tab of 'Options for Target...'. We need to choose 'Jlink / J-trace Cortex' for RTL87X3E. Then, Disable 'Load Application at Startup' which would reset the MCU </p><div class="image">
<img src="set_the_debug_interface.png" alt="set_the_debug_interface.png"/>
</div>
 <center><div id="figure_3_4"><b>Figure 3-4 Set the Debug Interface</b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.4.2.2 Set the Configuration for Jlink</h5>
<p>Make sure the MCU is not in the DLPS state and click the "Settings" button beside the "debug driver" as figure_3_4. There will be a "Cortex Jlink/Jtrace Target Driver Setup" window. </p><div class="image">
<img src="set_the_configuration_for_jlink.png" alt="set_the_configuration_for_jlink.png"/>
</div>
 <center><div id="figure_3_5"><b>Figure 3-5 Set the Configuration for Jlink</b></div></center><p> First, set the port to SWD and speed to 1MHz, and do not choose "Reset after Connect". Then click the Scan Button, and you can see the device name with IDCODE in the SW device. If there is no information in "SW device", please hardware reset the MCU and check the wiring for jlink. By doing so, Keil can find <b>SW device</b>.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.2.3 Disable the Target Download before Debugging</h5>
<p>By default, Keil will download the image through jlink when it starts debugging, so you need to disable the "Update Target before Debugging" option. This option is in the Utilities Tab of "Options for Target...". </p><div class="image">
<img src="disable_target_update.png" alt="disable_target_update.png"/>
</div>
 <center><div id="figure_3_6"><b>Figure 3-6 Disable Target Update</b></div></center><h5>3.4.2.4 Disable Watchdog and DLPS before Build</h5>
<p>The purpose of disabling the watchdog is to not reset the MCU when it is halted by SWD. The way to disable the watchdog is as follows. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> system_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___h_a_l___w_d_g___a_p_i___exported___functions.html#ga519f15c95d646baeefc21f151477d817">wdg_disable</a>();</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> Make sure the MCU is not in the DLPS state. The way to disable DLPS is as follows. </p><div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe">main</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___c_f_g___exported___functions.html#ga0d6336bc144e24986b036b7fdc9dcc6e">app_cfg_init</a>();</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="group___a_p_p___c_f_g.html#gaccbb50f7afd6ea87657c30a0bfa1bf26">enable_dlps</a> = 0;</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga5d40c496c313ad7b90046a2d00ed4c2f">app_dlps_init</a>();</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> <a class="anchor" id="invalid"></a></p><h5>3.4.2.5 Start a Debug Session during Running</h5>
<p>Step 1: Click the 'Debug' button to start a Keil debugging session in Keil main window and MCU will be halted. </p><div class="image">
<img src="keil_debug_start.png" alt="keil_debug_start.png"/>
</div>
 <center><div id="figure_3_7"><b>Figure 3-7 Debug Start</b></div></center><p> Step 2: Input the command "LOAD %L INCREMENTAL" in the command window </p><div class="image">
<img src="Input_command_and_set_breakpoints.png" alt="Input_command_and_set_breakpoints.png"/>
</div>
 <center><div id="figure_3_8"><b>Figure 3-8 Input Command and Set Breakpoints</b></div></center><p> Step 3: Click the run button and MCU will be halted at the breakpoint </p><div class="image">
<img src="Click_the_run_button.png" alt="Click_the_run_button.png"/>
</div>
 <center><div id="figure_3_9"><b>Figure 3-9 Click the Run Button</b></div></center><p> If there is a pop-up window that mentions that it cannot find <b>SW device</b>, please reset the MCU and go back to "Cortex Jlink/Jtrace Target Driver Setup" and follow the steps in <b>section 3.2</b> to check "SW device" information, which means Keil scanned and found <b>SW device</b>. </p><div class="image">
<img src="cannot_found_device.png" alt="cannot_found_device.png"/>
</div>
 <center><div id="figure_3_10"><b>Figure 3-10 Pop-up dialog for no SW device</b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.4.2.6 Debug from Main Function</h5>
<p>For the sake of capturing the MCU before running over the main function, we need to add a delay before the main function. We can add it in system_init of system_rtl8763.c. After pressing the reset key, you need to click Debug to start the simulation as soon as possible. Too fast and it will be too late to identify Jlink, too slow and it will run out of the main function. </p><div class="image">
<img src="add_a_delay_before_main.png" alt="add_a_delay_before_main.png"/>
</div>
 <center><div id="figure_3_11"><b>Figure 3-11 Add a Delay before <a class="el" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Entry of APP code. ">main()</a></b></div></center><p>Step 1: Reset the MCU and click the 'Debug' button to make the MCU halt before main.</p>
<p>Step 2: Input the command "LOAD %L INCREMENTAL" in the command window</p>
<p>Step 3: Set a breakpoint at the main and click the run button</p>
<div class="image">
<img src="PC_stop_at_main.png" alt="PC_stop_at_main.png"/>
</div>
 <center><div id="figure_3_12"><b>Figure 3-12 PC Stop at <a class="el" href="group___b_t___p_a_n___d_e_m_o___m_a_i_n.html#ga840291bc02cba5474a4cb46a9b9566fe" title="Entry of APP code. ">main()</a></b></div></center><p>Jlink download is not supported, so the modified code needs to be recompiled and returned before debugging. During debugging, the 'RESET' button of Keil is not available. Please press the hardware reset on the EVB to start debugging from scratch.</p>
<h4><a class="anchor" id="Download_with_Keil"></a>
3.4.3 Download with Keil</h4>
<p>Step 1: Do 3.4.2.1 SWD_Set_the_Debug_Interface and 3.4.2.2 SWD_Set_Jlink_Configuration</p>
<p>Step 2: Copy RTL87X3E_FLASH.FLM in sdk to keil root directory Keil and load the RTL87X3E_FLASH.FLM file as below figure</p>
<div class="image">
<img src="keil_download_setting.png" alt="keil_download_setting.png"/>
</div>
 <center><div id="figure_3_13"><b>Figure 3-13 Keil Download Setting</b></div></center><p>Step 3: Download bin with keil</p>
<div class="image">
<img src="download_bin_with_keil.png" alt="download_bin_with_keil.png"/>
</div>
 <center><div id="figure_3_14"><b>Figure 3-14 Download Bin with Keil</b></div></center><h4><a class="anchor" id="SWD_with_Jlink_Commander"></a>
3.4.3 SWD with Jlink Commander</h4>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.3.1 Preparation</h5>
<p>This section describes the preparation before starting SWD debugging with Jlink Commander.</p>
<p>Jlink Commander (Jlink.exe) is a command-line-based utility that can be used for verifying the proper functionality of Jlink (the debugger) and for simple analysis of the target system. It supports some simple commands, such as memory dump, halt, step, go, etc. to verify the target connection.</p>
<p>The Jlink Commander installation package is packed into the <a href="https://www.segger.com/downloads/jlink/#JlinkSoftwareAndDocumentationPack">https://www.segger.com/downloads/jlink/#JlinkSoftwareAndDocumentationPack</a>. You can click the website and choose the platform you used. </p><div class="image">
<img src="J_link_software_and_documentation_pack.png" alt="J_link_software_and_documentation_pack.png"/>
</div>
 <center><div id="figure_3_15"><b>Figure 3-15 Jlink Software and Documentation Pack</b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.4.3.2 Debug Feature Introduction</h5>
<p>There are two categories of debugging methods: invasive debugging and noninvasive debugging.</p><ul>
<li>Invasive debugging:<ul>
<li>Program halt and stepping</li>
<li>Hardware breakpoints</li>
<li>Breakpoint instruction</li>
<li>Data watchpoint on access to data address, address range, or data value</li>
<li>Register value accesses (both read and write)</li>
<li>Debug monitor exception</li>
<li>ROM-based debugging (Flash patch)</li>
</ul>
</li>
<li>Noninvasive debugging:<ul>
<li>Memory accesses (memory contents can be accessed even when the core is running)</li>
<li>Instruction trace (via the optional Embedded Trace Module)</li>
<li>Data trace</li>
<li>Software trace (via the Instrumentation Trace Module)</li>
<li>Profiling (via the Data Watchpoint and Trace Module)</li>
</ul>
</li>
</ul>
<p>The most common debugging method is invasive debugging, which is used in this guide. So it should be emphasized that you should <b>halt</b> MCU with the command "h" every time you need to read or write registers.</p>
<p><a class="anchor" id="invalid"></a></p><h5>3.4.3.3 Debug Procedures</h5>
<p><b>(1) Debug Configuration:</b></p>
<p>In the debugging setting, it needs to set the parameters about the target and debugging sessions.</p><ol type="1">
<li>Start the Jlink commander (by CONNA or desktop shortcut) <div class="image">
<img src="Start_Jlink.png" alt="Start_Jlink.png"/>
</div>
 <center><div id="figure_3_16"><b>Figure 3-16 Start Jlink Commander</b></div></center></li>
<li>After Jlink Commander starts, you should use the command 'connect' to start the setting for the debugging session. <div class="image">
<img src="connect_MCU.png" alt="connect_MCU.png"/>
</div>
 <center><div id="figure_3_17"><b>Figure 3-17 Connect MCU</b></div></center></li>
<li>Then you should select the device/core to which the MCU belongs. It is Cortex-M4 for RTL87X3D and Cortex-M3 for RTL87X3E. <div class="image">
<img src="specify_device_core.png" alt="specify_device_core.png"/>
</div>
 <center><div id="figure_3_18"><b>Figure 3-18 Specify Device/Core</b></div></center> <div class="image">
<img src="Select_Cortex_M4_for_BBpro.png" alt="Select_Cortex_M4_for_BBpro.png"/>
</div>
 <center><div id="figure_3_19"><b>Figure 3-19 Select Cortex-M4 for RTL87X3D</b></div></center></li>
<li>Please specify SWD as the target interface. <div class="image">
<img src="specify_target_interface_as_SWD.png" alt="specify_target_interface_as_SWD.png"/>
</div>
 <center><div id="figure_3_20"><b>Figure 3-20 Specify Target Interface as SWD</b></div></center></li>
<li>You can also set the interface speed of SWD. The default speed is 4000kHz, and you can use this value by inputting Enter key directly. It is recommended to be below 2000kHz for debugging stability. <div class="image">
<img src="specify_the_SWD_speed.png" alt="specify_the_SWD_speed.png"/>
</div>
 <center><div id="figure_3_21"><b>Figure 3-21 Specify the SWD Speed as 1MHz</b></div></center></li>
<li>Finally, Jlink Commander will print the following information. It means debugging configuration is finished! <div class="image">
<img src="debug_info.png" alt="debug_info.png"/>
</div>
 <center><div id="figure_3_22"><b>Figure 3-22 Debug Info</b></div></center></li>
</ol>
<p><b>(2) Capture MCU before main:</b></p>
<p>Because the first 32KB in ROM was protected for security, SWD could not halt MCU by its reset command 'h'. To this limitation, it is difficult to debug the app from the main function directly. It needs to add a dead loop and set PC to the top of the main loop.</p>
<p>The steps are as follows.</p><ol type="1">
<li>Add a dead loop in system_init in system_rtl8763.c: <div class="image">
<img src="add_dead_loop.png" alt="add_dead_loop.png"/>
</div>
 <center><div id="figure_3_23"><b>Figure 3-23 Add a Dead Loop in system_init()</b></div></center></li>
<li>Connect MCU by following the steps in <b>Debug Configuration</b>.</li>
<li>Halt MCU by 'h', and check whether MCU is running in the loop: <div class="image">
<img src="PC_addr.png" alt="PC_addr.png"/>
</div>
 <center><div id="figure_3_24"><b>Figure 3-24 (a)PC in Jlink Commander (b) Addr of while(1)</b></div></center></li>
<li>Set the PC to the top of the main function by the 'SetPC' command. Here app's main function is at 0x831e96: <div class="image">
<img src="PC_in_Jlink.png" alt="PC_in_Jlink.png"/>
</div>
 <center><div id="figure_3_25"><b>Figure 3-25 PC in Jlink Commander</b></div></center></li>
</ol>
<p><b>(3) Breakpoint Debugging:</b></p>
<p>The most commonly used debugging function is breakpoint. In Jlink Command, the breakpoint command is 'SetBP'. For actual debugging, it should be used in combination with the command 'go'.</p><ol type="1">
<li>Use SetBP to set a breakpoint in the form of an assembly address. 'Handle' is the number used to remove a breakpoint with ClrBP. <div class="image">
<img src="Set_BP.png" alt="Set_BP.png"/>
</div>
 <center><div id="figure_3_26"><b>Figure 3-26 Set BP and Check the PC</b></div></center></li>
<li>Input 'g' or 'go' to make MCU run at full speed. You will see there is no response, but MCU has been halted at the breakpoint you set before. And you can use regs to check this. <div class="image">
<img src="halted_at_BP.png" alt="halted_at_BP.png"/>
</div>
 <center><div id="figure_3_27"><b>Figure 3-27 Let MCU Go and It Will Halted at BP</b></div></center></li>
<li>If you don't need the breakpoint anymore, 'ClrBP' should be used. You will see the hint that Breakpoint is cleared. <div class="image">
<img src="Clear_BP.png" alt="Clear_BP.png"/>
</div>
 <center><div id="figure_3_28"><b>Figure 3-28 Clear BP with its Handle</b></div></center></li>
</ol>
<p><b>(4) Watchpoint Debugging:</b></p>
<p>Watchpoint can be considered as a kind of condition breakpoint. For example, a variable 'hello' of type uint8_t is added and it is added in the main while loop as follows.</p><ol type="1">
<li>You can check its address and the code in the .disasm file. <div class="image">
<img src="assembly_addr_for_hello.png" alt="assembly_addr_for_hello.png"/>
</div>
 <center><div id="figure_3_29"><b>Figure 3-29 Assembly Addr for Hello++</b></div></center> <div class="image">
<img src="addr_for_hello.png" alt="addr_for_hello.png"/>
</div>
 <center><div id="figure_3_30"><b>Figure 3-30 Addr for Hello</b></div></center></li>
<li>Set a watchpoint at 0x1000769C for 'hello'. <div class="image">
<img src="Set_a_watchpoint.png" alt="Set_a_watchpoint.png"/>
</div>
 <center><div id="figure_3_31"><b>Figure 3-31 Set a Watchpoint</b></div></center></li>
<li>Let MCU run and it will be halted automatically when 'hello' grows up to 5. Check the registers and you will find that 0x8322DE is near 0x8322D4. 0x8322DE is the place MCU writes the value back to 0x1000769C. <div class="image">
<img src="Check_the_regsters.png" alt="Check_the_regsters.png"/>
</div>
 <center><div id="figure_3_32"><b>Figure 3-32 Check the Regsters</b></div></center> <div class="image">
<img src="LDR_at_0x8322de.png" alt="LDR_at_0x8322de.png"/>
</div>
 <center><div id="figure_3_33"><b>Figure 3-33 LDR at 0x8322de</b></div></center></li>
<li>Finally, you can look into the 0x1000769C by 'mem': <div class="image">
<img src="value_in_1000769C.png" alt="value_in_1000769C.png"/>
</div>
 <center><div id="figure_3_34"><b>Figure 3-34 Value in 1000769C is 0x5</b></div></center></li>
</ol>
<p><b>(5) Single Step Debugging:</b></p>
<p>The single-step debugging command is 's'. If you want to single step through your program, you should halt MCU by 'h' first. Then you are enabled to go through the program step by step with 's'. </p><div class="image">
<img src="halt_MCU_and_single_step.png" alt="halt_MCU_and_single_step.png"/>
</div>
 <center><div id="figure_3_35"><b>Figure 3-35 Halt MCU and Single Step</b></div></center><p><a class="anchor" id="invalid"></a></p><h5>3.4.3.4 Common Commands</h5>
<p><b>connect</b></p>
<p>Syntax: connect</p>
<p>This command is not listed in the commands help list. As depicted in <b>Debug Configuration</b>, it starts the setting for the debugging session. It is always the first step when using the SWD to debug.</p>
<p><b>h</b></p>
<p>Syntax: h</p>
<p>'h' means 'halt', which will stop MCU. It's a common command in MCU debugging.</p>
<p><b>s</b></p>
<p>Syntax: s</p>
<p>Single step the target chip.</p>
<p><b>mem, mem8, mem16, mem32</b></p>
<p>Syntax: <br />
mem &lt;Addr&gt;, &lt;NumBytes&gt; <br />
mem8 &lt;Addr&gt;, &lt;NumBytes&gt; <br />
mem16 &lt;Addr&gt;, &lt;NumBytes&gt; <br />
mem32 &lt;Addr&gt;, &lt;NumBytes&gt;</p>
<p>All these commands are used to read the memory. Both 'mem' and 'mem32' are the most common commands. 'mem' can read the memory with arbitrary size and 'mem32' can read the memory with the unit of one word in ARM.</p>
<p><b>w1, w2, w4</b></p>
<p>Syntax: <br />
w1 &lt;Addr&gt;, &lt;Data&gt; <br />
w2 &lt;Addr&gt;, &lt;Data&gt; <br />
w4 &lt;Addr&gt;, &lt;Data&gt;</p>
<p>These commands can write a value to a certain address.</p>
<p><b>q</b></p>
<p>Syntax: q</p>
<p>'q' means 'quit', which can close Jlink Commander.</p>
<p><b>r, rx</b></p>
<p>Syntax: <br />
r <br />
rx &lt;DelayAfterReset&gt;</p>
<p>'r' and 'rx' can reset the target chip. 'rx' can reset the MCU after a specified interval.</p>
<p><b>Regs</b></p>
<p>Syntax: Regs</p>
<p>'Regs' is a very common command in almost all command-line debuggers. It can read all the general purpose registers, such as R0-R12, LR, and PC.</p>
<p><b>wreg</b></p>
<p>Syntax: wreg &lt;RegName&gt;, &lt;Data&gt;</p>
<p>'wreg' can write a value to a specific register.</p>
<p><b>SetBP</b></p>
<p>Syntax: SetBP &lt;addr&gt;</p>
<p>This command is used to set the breakpoint. It is usually used in combination with the command 'g'. Command 'g' makes MCU run at full speed and if it reaches the breakpoint, MCU can be suspended by Jlink.</p>
<p><b>ClrBP</b></p>
<p>Syntax: ClrBP &lt;BP_Handle&gt;</p>
<p>This command is used to clear breakpoints which you don't need anymore.</p>
<p><b>SetPC</b></p>
<p>Syntax: SetPC &lt;Addr&gt;</p>
<p>This command can set the current PC to a specified address.</p>
<h3><a class="anchor" id="traceAlyzer"></a>
3.5 TraceAlyzer</h3>
<h4><a class="anchor" id="traceAlyzer_Intro"></a>
3.5.1 TraceAlyzer Introduction</h4>
<p>rtl87x3D supports profiling with traceAlyzer. traceAlyzer download link: <a href="https://percepio.com/downloadform/">https://percepio.com/downloadform/</a></p>
<p>traceAlyzer communicates with rtl87x3D through JLink. Before using traceAlyzer, please ensure that JLink is connected correctly and this function is turned on in MCUConfig Tool.</p>
<p>Most of the trace info can be added automatically. However, ISR trace info needs to be added manually.</p>
<h4><a class="anchor" id="traceAlyzer_ADD_ISR_Info"></a>
3.5.2 Add ISR Trace Info</h4>
<p>Using the following functions to add ISR trace info.</p><ul>
<li><a class="el" href="group___o_s__87x3e___trace.html#ga1a55c1772288241d2133bc8fb1c054a2" title="Stores a name and priority level for an Interrupt Service Routine, to allow for better visualization...">os_trace_isr_create()</a> function is used by APP to create a handler to trace isr info. Include the user's name and priority.</li>
<li><a class="el" href="group___o_s__87x3e___trace.html#gaac94760154f9bcfd3031bc4731e20c26" title="Registers the beginning of an Interrupt Service Routine, using a handle provided by os_trace_isr_crea...">os_trace_isr_begin()</a> function is used to identify the isr started.</li>
<li><a class="el" href="group___o_s__87x3e___trace.html#ga679d3d9aab0aa69069f2a527f572f64d" title="Registers the end of an Interrupt Service Routine. ">os_trace_isr_end()</a> function is used to identify the isr ended.</li>
</ul>
<p>A brief demo: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;os_trace.h&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> *p_Handle;</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> testIsrInit(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___o_s__87x3e___trace.html#ga1a55c1772288241d2133bc8fb1c054a2">os_trace_isr_create</a>(&amp;p_Handle, <span class="stringliteral">&quot;test isr&quot;</span>, 4);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> testIsrHandler(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="comment">//notify tracklayer that the current isr start running</span></div><div class="line">    <a class="code" href="group___o_s__87x3e___trace.html#gaac94760154f9bcfd3031bc4731e20c26">os_trace_isr_begin</a>(p_Handle);</div><div class="line"></div><div class="line">    .....</div><div class="line"></div><div class="line">    <span class="comment">//notify traceAlyzer that the current isr finished running</span></div><div class="line">    <a class="code" href="group___o_s__87x3e___trace.html#ga679d3d9aab0aa69069f2a527f572f64d">os_trace_isr_end</a>();</div><div class="line">}</div></div><!-- fragment --><p>After adding all isr trace info, the user can open traceAlyzer to profile rtl87x3D.</p>
<h4><a class="anchor" id="traceAlyzer_Setting"></a>
3.5.3 TraceAlyzer Setting</h4>
<p>Settings-&gt;PSF Streaming Settings:</p>
<p>Target Connection: SEGGER RTT</p>
<p>RTT Control Block Address: Search "_SEGGER_RTT" in ROM.lib, and fill in its address.</p>
<p>for example: </p><div class="image">
<img src="traceAlyzer_setting.png" alt="traceAlyzer_setting.png"/>
</div>
 <center><div id="figure_3_36"><b>Figure 3-36 TraceAlyzer Setting</b></div></center><p>After setting traceAlyzer, click "Start Session". TraceAlyzer will display profiling info. More info could be found in traceAlyzer's "Help-&gt;User Manual" window. </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
