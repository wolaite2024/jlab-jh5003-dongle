<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p>melleus audio init with switch cycle</p><ul>
<li></li>
</ul>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Page"></a>
MALLEUS_SPATIAL_AUDIO Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2023/07/12</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Malleus_Spatial_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2022/06/24  </td><td class="markdownTableBodyCenter">Stable release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/07/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#Malleus_Spatial_Rev">Revision History</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Table_List">Table List</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Terminology">2 Terminology</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_HW_Setup">3 HW Set Up</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview">4 Source Code Overview</a><ul>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Function">4.1 Melleus Audio Effect Function</a><ul>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Feature">4.1.1 Melleus Audio Feature</a> <br />
 - <a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Enable">4.1.2 Melleus Audio Enable</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Init">4.1.3 Melleus Audio Init</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Set">4.1.4 Melleus Audio Effect Set</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Function">4.2 Spatial Audio Function</a><ul>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Feature">4.2.1 Spatial Audio Feature</a><ul>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Enable">4.2.2 Spatial Audio Enable</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Init">4.2.3 Spatial Audio Init</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Setup">4.2.4 Spatial Audio Setup</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Raw_Data">4.2.5 Spatial Audio Read Raw Data</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Attitude">4.2.6 Spatial Audio Change Raw Data To Attitude</a></li>
<li><a class="el" href="_a_n118__m_a_l_l_e_u_s__s_p_a_t_i_a_l__a_u_d_i_o.html#MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Feed">4.2.7 Feed attitude data to dsp</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_3_1">Figure 3-1 MEMS HW Enable</a></li>
<li><a href="#figure_3_2">Figure 3-2 MEMS IC Select</a></li>
<li><a href="#figure_3_3">Figure 3-3 MEMS Position Config</a></li>
<li><a href="#figure_3_4">Figure 3-4 MEMS Pin Setting</a></li>
<li><a href="#figure_4_1">Figure 4-1 Inv42607 Driver Enable</a></li>
<li><a href="#figure_4_2">Figure 4-2 Enable Cwm Lib</a></li>
<li><a href="#figure_4_3">Figure 4-3 Enable Qmi8658 Driver</a></li>
<li><a href="#figure_4_4">Figure 4-4 Enable Imu Lib</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">MEMS  </td><td class="markdownTableBodyCenter">Micro Electro Mechanical System   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">CWM  </td><td class="markdownTableBodyCenter">Cywee   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">IMU  </td><td class="markdownTableBodyCenter">Inertial Measuring Unit   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of malleus audio and spatial audio effect function. The document describes how to use these two funcitons in app project. The details will be described in the following sections.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Terminology"></a>
2 Terminology</h2>
<p>Malleus audio and spatial audio have different effects:</p><ol type="1">
<li>Malleus audio and spatial audio are all need to be supportd by malleus dsp algorithm lib. It can be included individually.</li>
<li>Malleus audio has different audio effects such as gaming,music, movie etc.</li>
<li>Spatial auido is a feature by using MEMS sensor to track the head movement in 3 dimantional space.</li>
<li>With the infomation of head movenment in 3 dimantional space, we can perform a 3D sound effect for user, which is so call spatial audio.</li>
<li>MEMS sensor is required for spatial audio, however malleus audio is not.</li>
</ol>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_HW_Setup"></a>
3 HW Set Up</h2>
<p>spatial audio MEMS sensor can be enabled in "HW Feature" page. </p><div class="image">
<img src="mcuconfig_mems_enable.png" alt="mcuconfig_mems_enable.png" width="80%" height="80%"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 MEMS HW Enable</b></div></center><p>Select MEMS IC according to design(inv42607 and qmi8658). </p><div class="image">
<img src="mcuconfig_mems_select.png" alt="mcuconfig_mems_select.png" width="80%" height="80%"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 MEMS IC Select</b></div></center><p>The user must refer to the real position in each project when configuring the sensor position based on the IC position in the PCBA.</p>
<div class="image">
<img src="mcuconfig_mems_position.png" alt="mcuconfig_mems_position.png" width="80%" height="80%"/>
</div>
 <center><div id="figure_3_3"><b>Figure 3-3 MEMS Position Config</b></div></center><p>Select MEMS i2c and ready(Sensor interrupt) pin. </p><div class="image">
<img src="mcuconfig_mems_pin_setting.png" alt="mcuconfig_mems_pin_setting.png" width="80%" height="80%"/>
</div>
 <center><div id="figure_3_4"><b>Figure 3-4 MEMS Pin Setting</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview"></a>
4 Source Code Overview</h2>
<h3><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Function"></a>
4.1  Melleus Audio Effect Function</h3>
<h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Feature"></a>
4.1.1 Melleus Audio Feature</h4>
<p>We support Malleus audio in our sdk develope kit. One can enable Malleus audio by following the step below</p><ol type="1">
<li>Set F_APP_DUAL_AUDIO_EFFECT to 1.</li>
<li>dual_audio_lib project file need to be compiled.</li>
<li>In main rws project need to include the dual_audio_lib.lib.</li>
</ol>
<p>With the step been performed, one can generate the malleus audio app image for ear buds.</p>
<p>Note:</p><ol type="1">
<li>If the APP image support Malleus audio then the dsp image should also support Malleus audio.</li>
<li>If the dsp doesn't support Malleus audio while APP does, than ear buds will have no sound output.</li>
<li>The Malleus audio is a third party sound effect that is secure by it's security key.</li>
<li>The IC should has a set of Malleus key in effuse 0xAE, 0xAF field.</li>
<li>If there is no security key in efuse or the security doesn't match the key in Malleus sound effect image, after 2 minutes if play the sound will mute for 1 second then unmute for 1 second make the ear bud unuseable.</li>
</ol>
<p>There are at most four malleus effect, music, gaming, movie, party, with bit mask as follow</p><ol type="1">
<li>MALLEUS_MUSIC = 1</li>
<li>MALLEUS_GAMING = 2</li>
<li>MALLEUS_MOVIE = 4</li>
<li>MALLEUS_PARTY = 8</li>
</ol>
<p>Note:</p><ol type="1">
<li>Malleus effect can be switched individually under normal mode and gaming mode.</li>
<li>Gaming and normal mode can be switched by MMI_DEV_GAMING_MODE_SWITCH.</li>
<li>Malleus effect cycle can be set individually with para normal_cycle and gaming cycle.</li>
</ol>
<p>user can call this api with parameter The following demo is set:</p><ol type="1">
<li>Normal cycle:music(1) -&gt; gaming(2) -&gt; party(8)</li>
<li>Gaming cycle:gaming(2) -&gt; movie(4)</li>
</ol>
<div class="fragment"><div class="line">normal_cycel = <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gaa1ec7b594aabb5bdd3041b669662f767">MALLEUS_MUSIC</a> | <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga05b2e57fd4f397162474204dc432e4ef">MALLEUS_GAMING</a> | <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga8a1ac9b605c73d9a557a81e118f22cf9">MALLEUS_PARTY</a></div><div class="line">gaming_cycle = <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga05b2e57fd4f397162474204dc432e4ef">MALLEUS_GAMING</a> | <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gaf8ec1847e330bf340f114755d37a5a50">MALLEUS_MOVIE</a>   </div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Enable"></a>
4.1.2 Melleus Audio Enable</h4>
<p>Enable mellues function </p><div class="fragment"><div class="line"><span class="preprocessor">#define RTL8763ESE_PRODUCT_3D_RWS       1  // DSP: 3d_rws</span></div><div class="line"></div><div class="line"><span class="preprocessor">#if RTL8763ESE_PRODUCT_3D_RWS</span></div><div class="line"><span class="preprocessor">#undef F_APP_SUPPORT_MALLEUS_AUDIO</span></div><div class="line"><span class="preprocessor">#define F_APP_SUPPORT_MALLEUS_AUDIO     1</span></div><div class="line"><span class="preprocessor">#undef F_APP_USER_EQ_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_USER_EQ_SUPPORT           0</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Init"></a>
4.1.3 Melleus Audio Init</h4>
<p>There is an api to set up dual audio effect cycle for normal mode and gaming mode</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gab37d3c235c5dd4d346a7c471bdab7e9e">app_dual_audio_effect_init</a>(uint8_t normal_cycle, uint8_t gaming_cycle);</div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Malleus_Set"></a>
4.1.4 Melleus Audio Effect Set</h4>
<p>Before set melleus audio effect, audio_effect_gaming_type and audio_effect_normal_type need to be set firstly base on normal or gaming mode. The demo follow is changed to music effect: </p><div class="fragment"><div class="line"><span class="preprocessor">#define dual_audio_mode_sel \</span></div><div class="line"><span class="preprocessor">    app_db.gaming_mode ? app_cfg_nv.audio_effect_gaming_type : app_cfg_nv.audio_effect_normal_type</span></div><div class="line"></div><div class="line"><span class="comment">/*set melleus audio effect</span></div><div class="line"><span class="comment">*</span></div><div class="line"><span class="comment">* @param audio effect mode,where mode can be MALLEUS_MUSIC,MALLEUS_GAMING,MALLEUS_MOVIE,MALLEUS_PARTY</span></div><div class="line"><span class="comment">* @return None</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga242bc325a7b166aa895302dc6272ff98">app_dual_audio_effect_set</a>(uint8_t mode);</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_dual_audio_effect_set_demo(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a7c8c9df5726bc1d40d3dab0d19269dde">gaming_mode</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#acf9f27533e8f10f014feb85b072c6554">audio_effect_gaming_type</a> = <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gaa1ec7b594aabb5bdd3041b669662f767">MALLEUS_MUSIC</a>;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a1212a52eec6d017d882fd14cdd07374d">audio_effect_normal_type</a> = <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gaa1ec7b594aabb5bdd3041b669662f767">MALLEUS_MUSIC</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga242bc325a7b166aa895302dc6272ff98">app_dual_audio_effect_set</a>(<a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga5d79ee2e0f17384756ed64421699abd2">dual_audio_mode_sel</a>);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Function"></a>
4.2  Spatial Audio Function</h3>
<h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Feature"></a>
4.2.1 Spatial Audio Feature</h4>
<p>Spatial audio need to use the MEMS sensor and cywee/imu spatial movement algorithm base on malleus dsp algorithm lib.</p>
<p>Follow the step list below to enable spatial audio feature.</p><ol type="1">
<li>Set F_APP_SUPPORT_SPATIAL_AUDIO macro to 1</li>
<li>rws project need to include CWM_LIB_Keil_m3_vq.lib or imualgo_axis9.lib</li>
<li>rws project need to include app_sensor_spatial.c, inv_imu_driver.c, inv_imu_transport.c or qmi8658.c</li>
</ol>
<p>Note:</p><ol type="1">
<li>If the APP image support spatial audio then the dsp image should also support spatial audio.</li>
<li>If the dsp doesn't support spatial audio while APP does, than ear buds will have no spatial audio effect.</li>
<li>Two ICs (inv42607/qmi8658)are currently supported for spatial audio</li>
<li>CWM_LIB_Keil_m3_vq.lib and imualgo_axis9.lib is a thrird party lib provide by Cywee Motion</li>
<li>inv_imu_driver.c, inv_imu_transport.c and CWM_LIB_Keil_m3_vq.lib are source file for MEMS sensor inv42607.</li>
<li>qmi8658.c and imualgo_axis9.lib are source file for qmi8658.</li>
</ol>
<p>MEMS data handle flow:</p><ol type="1">
<li>Head Movement</li>
<li>MEMS sensor data interrupt</li>
<li>Get raw Data</li>
<li>Spatial ovement algorithm (CWM_LIB_Keil_m3_vq or imualgo_axis9 process raw data)</li>
<li>Get attitude data</li>
<li>Change attitude to propor range</li>
<li>Feed attitude to DSP melleus lib</li>
<li>Spatial audio sound effect</li>
</ol>
<h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Enable"></a>
4.2.2 Spatial Audio Enable</h4>
<p>source code directory: <a class="el" href="rws_2app__flags_8h_source.html">sdk/src/sample/rws/app_flags.h</a> <br />
 </p><div class="fragment"><div class="line"><span class="preprocessor">#undef F_APP_SENSOR_SPATIAL_AUDIO_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_SENSOR_SPATIAL_AUDIO_SUPPORT    1</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p>The following demo is to include inv42607 driver and cwm lig: </p><div class="image">
<img src="enable_inv42607.png" alt="enable_inv42607.png" width="30%" height="30%"/>
</div>
 <center><div id="figure_4_1"><b>Figure 4-1 Inv42607 Driver Enable</b></div></center> <div class="image">
<img src="enable_cwm_lib.png" alt="enable_cwm_lib.png" width="30%" height="30%"/>
</div>
 <center><div id="figure_4_2"><b>Figure 4-2 Enable Cwm Lib</b></div></center><p>source code directory: <a class="el" href="rws_2app__flags_8h_source.html">sdk/src/sample/rws/app_flags.h</a> <br />
 In addition, the inv42607 and cwm lib macro must be enabled as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if F_APP_SENSOR_SPATIAL_AUDIO_SUPPORT</span></div><div class="line"><span class="preprocessor">#undef F_APP_SENSOR_INV42607_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_SENSOR_INV42607_SUPPORT         1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_SENSOR_QMI8658_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_SENSOR_QMI8658_SUPPORT          0</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_CWM_ALGO_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_CWM_ALGO_SUPPORT                1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_IMU_ALGO_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_IMU_ALGO_SUPPORT                0</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><p>The following demo is to include qmi8658 imu algo lib:</p>
<div class="image">
<img src="enable_qmi8658.png" alt="enable_qmi8658.png" width="30%" height="30%"/>
</div>
 <center><div id="figure_4_3"><b>Figure 4-3 Enable Qmi8658 Driver</b></div></center> <div class="image">
<img src="enable_imu_lib.png" alt="enable_imu_lib.png" width="30%" height="30%"/>
</div>
 <center><div id="figure_4_4"><b>Figure 4-4 Enable Imu Lib</b></div></center><p>source code directory: <a class="el" href="rws_2app__flags_8h_source.html">sdk/src/sample/rws/app_flags.h</a> <br />
 In addition, the qmi8658 and imu lib macro must be enabled as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#if F_APP_SENSOR_SPATIAL_AUDIO_SUPPORT</span></div><div class="line"><span class="preprocessor">#undef F_APP_SENSOR_INV42607_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_SENSOR_INV42607_SUPPORT         0</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_SENSOR_QMI8658_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_SENSOR_QMI8658_SUPPORT          1</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_CWM_ALGO_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_CWM_ALGO_SUPPORT                0</span></div><div class="line"></div><div class="line"><span class="preprocessor">#undef F_APP_IMU_ALGO_SUPPORT</span></div><div class="line"><span class="preprocessor">#define F_APP_IMU_ALGO_SUPPORT                1</span></div><div class="line"><span class="preprocessor">#endif</span></div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Init"></a>
4.2.3 Spatial Audio Init</h4>
<p>source code directory: sdk/src/sample/rws/app_sensor_spatial.c <br />
 This section describes app sensor spatial module(inv42607 for instance). This module is used to handle sensor MEMS message.</p>
<p>When the system restarts, configure the i2c and ready (Sensor interrupt) pinmux settings. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_spatial_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">#<span class="keywordflow">if</span> F_APP_SENSOR_INV42607_SUPPORT</div><div class="line">    sensor_inv_init(&amp;dev);</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Setup"></a>
4.2.4 Spatial Audio Setup</h4>
<p>After the system powers on, configure the MEMS device, including frequency,noise,power mode setting, etc. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_spatial_dm_cback(<a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#ga17c64f28c161ee1a43e988bbf7aa08ba">T_SYS_EVENT</a> event_type, <span class="keywordtype">void</span> *event_buf, uint16_t buf_len)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#gga58c18773b27c0caf62739de85017a0a8a89ffb71e8cb42c90440d17ddf58e9032">SYS_EVENT_POWER_ON</a>:</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.spatial_support)</div><div class="line">            {</div><div class="line">                app_sensor_spatial_setup();</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Raw_Data"></a>
4.2.5 Spatial Audio Read Raw Data</h4>
<p>When the spatial device data is ready, it pulled up the interrupt pin to inform application to read acc and gyro data. In order to handle data as quickly as possible, post the message to timer task to read MEMS FIFO data.</p>
<div class="fragment"><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#gaf901ecfe15c401262a5dfd752a0b0287">ISR_TEXT_SECTION</a> <span class="keywordtype">void</span> app_sensor_spatial_inv_irq(uint32_t param)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga915514c710f982852b566f59aa264692">hal_gpio_irq_disable</a>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.spatial_int_pinmux);</div><div class="line">    xTimerPendFunctionCallFromISR(app_sensor_spatial_inv42607_read_fifo, <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, &amp;high_pri_task_woken);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#gaae922b7d64d09b96637d21715a386260">hal_gpio_irq_enable</a>(<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.spatial_int_pinmux);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Read FIFO acc and gyro raw data in timer task. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_spatial_inv42607_read_fifo(<span class="keywordtype">void</span> *user_fun, uint32_t para)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    sensor_inv_get_imu_dat();</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> sensor_inv_get_imu_dat(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordtype">int</span> packets = inv_imu_get_data_from_fifo_wo_int_check(&amp;icm_driver);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> source code directory: sdk/src/mcu/mems_sensor/inv/inv_imu_driver.c <br />
 Post acc and gyro data to app task through io msg for further analysis.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> inv_imu_get_data_from_fifo_wo_int_check(<span class="keyword">struct</span> <a class="code" href="structinv__imu__device.html">inv_imu_device</a> *s)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    s-&gt;sensor_post_cb(s-&gt;report_dat);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_io_msg.c <br />
 Receive MEMS raw data (acc,gyro) in the app.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___i_o___m_s_g.html#gab3416cc2898ca3f036749335997d4841">app_io_handle_msg</a>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_driver_msg_recv)</div><div class="line">{</div><div class="line">     ...</div><div class="line">     <span class="keywordflow">switch</span> (msgtype)</div><div class="line">    {</div><div class="line">    ...</div><div class="line">    app_sensor_spatial_handle_data(io_driver_msg_recv.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#a5bc5fa69bee375df074734a2c4858604">buf</a>);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Attitude"></a>
4.2.6 Spatial Audio Change Raw Data To Attitude</h4>
<p>source code directory: sdk/src/sample/rws/app_sensor_spatial.c <br />
 Start to handle MEMS raw data (acc,gyro).</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_sensor_spatial_handle_data(<span class="keywordtype">void</span> *acc_gyro_data)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#aa0824efdba6622c42fce35690f3ea774">mems_vendor</a> == MEMS_VENDOR_INV42607)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___g_a_p___t_i_m_e_r.html#gac58204b6e5f306f768d84c4a2b02760e">gap_stop_timer</a>(&amp;timer_handle_inv_report);</div><div class="line">        app_sensor_spatial_inv42607_handle_data();</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Send acc and gyro data to algorithm, which is the third-party lib.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cwm_spatial_handle_fifo(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    sensor_cwm_algolib_in(cwm_accRaw, cwm_gyrRaw, cwm_delta.sensor_delta);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> sensor_cwm_algolib_in(<span class="keywordtype">float</span> *Acc, <span class="keywordtype">float</span> *Gyr, <span class="keywordtype">int</span> dt_us)</div></div><!-- fragment --><p>The algorithm library provides app with final attitude data after calculating using the raw acc and gyro data. By using the api above, we can input the IMU sensor data to Cywee lib.</p>
<p>Cywee Spatial Movement algrithm will calculate and output Yaw, Pitch, Roll data by MEMS sensor data. "IDX_ALGO_HS_FUSION" is the callback event when Cywee reprot angular movement.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> cwm_sensor_listen(<a class="code" href="struct_sensor_e_v_t__t.html">pSensorEVT_t</a> sensorEVT)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">case</span> IDX_ALGO_HS_FUSION:</div><div class="line">        app_sensor_spatial_atti_new_data(&amp;(sensorEVT-&gt;<a class="code" href="struct_sensor_e_v_t__t.html#afe35a891dd0970293a0b2c3f922fd853">fData</a>[0]), sensorEVT-&gt;<a class="code" href="struct_sensor_e_v_t__t.html#a77afd29946c626cf02d690ca37dfd83a">timestamp_ns</a>);</div><div class="line">    <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>Change attitude data to propor range.</p>
<div class="fragment"><div class="line"> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__dual__audio__pos.html">t_dual_audio_pos</a></div><div class="line"> {</div><div class="line">    int16_t <a class="code" href="structt__dual__audio__pos.html#a7574885923e9b8a59a7c7fa4b6ba55f9">horz</a>;</div><div class="line">    int16_t <a class="code" href="structt__dual__audio__pos.html#a6cd80630218044331cc3fa1fb5804cf0">vert</a>;</div><div class="line">    uint16_t <a class="code" href="structt__dual__audio__pos.html#ad559608d88ad73af7e7822bcf5a6111e">factor</a>;</div><div class="line"> } <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#ga99b10e29b20f14e44dd4ff1096960f83">T_DUAL_AUDIO_POS</a>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_spatial_atti_new_data(<span class="keywordtype">float</span> fData[7], uint64_t timestamp_ns)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">if</span> (fData[0] &lt;= 90 &amp;&amp; fData[0] &gt;= -90)  <span class="comment">// -90 ~ 90</span></div><div class="line">    {</div><div class="line">        horz = fData[0];<span class="comment">//- 180.0;</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fData[0] &gt; 90) <span class="comment">//90 ~ 180</span></div><div class="line">    {</div><div class="line">        horz = 180 - fData[0];<span class="comment">//- 180.0;</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fData[0] &lt; -90) <span class="comment">// -90 ~ -180</span></div><div class="line">    {</div><div class="line">        horz = - 180 - fData[0];<span class="comment">//- 180.0;</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span>  <span class="comment">//180.1 ~ 269</span></div><div class="line">    {</div><div class="line">        sensor_cwm_dbg_print(<span class="stringliteral">&quot;CWM SHOULD NOT HAPPENED %.5f&quot;</span>, fData[0]);</div><div class="line">    }</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a070baa3999451473bc481de199ca10a2">bud_side</a> == <a class="code" href="group___a_p_p___c_f_g.html#gac5dc0ff4da54ac7eb2352ca00e6689cfa57d07086a0a086d6ab101b4841cdc64f">DEVICE_BUD_SIDE_LEFT</a>)</div><div class="line">    {</div><div class="line">        horz *= -1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (horz &lt; -90)</div><div class="line">    {</div><div class="line">        horz = -90;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (horz &gt; 90)</div><div class="line">    {</div><div class="line">        horz = 90;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (vert &lt; -90)</div><div class="line">    {</div><div class="line">        vert = -90;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vert &gt; 90)</div><div class="line">    {</div><div class="line">        vert = 90;</div><div class="line">    }</div><div class="line"></div><div class="line">    <a class="code" href="structt__dual__audio__pos.html">T_DUAL_AUDIO_POS</a> temp;</div><div class="line">    temp.<a class="code" href="structt__dual__audio__pos.html#a7574885923e9b8a59a7c7fa4b6ba55f9">horz</a> = horz * 360;</div><div class="line">    temp.<a class="code" href="structt__dual__audio__pos.html#a6cd80630218044331cc3fa1fb5804cf0">vert</a> = vert * 360;</div><div class="line">    temp.<a class="code" href="structt__dual__audio__pos.html#ad559608d88ad73af7e7822bcf5a6111e">factor</a> = 0xfae0;</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="MALLEUS_SPATIAL_AUDIO_Source_Code_Overview_Spatial_Feed"></a>
4.2.7 Feed attitude data to dsp</h4>
<p>Feed the attitude data in dsp,then there is spatial audio effect. The code flow from cywee lib to dsp is shown as below.</p>
<div class="fragment"><div class="line"></div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___a_u_d_i_o___e_f_f_e_c_t.html#gaad827bf3267fb6592a4e1763cdb01814">app_dual_audio_update_pos</a>(<a class="code" href="structt__dual__audio__pos.html">T_DUAL_AUDIO_POS</a> pos, <span class="keywordtype">bool</span> real);</div><div class="line">{</div><div class="line">    ...</div><div class="line">    SECP_CTRL_INFO sitronix;</div><div class="line">    sitronix.cmd_dat[0] = temp.horz &amp; 0xFF;</div><div class="line">    sitronix.cmd_dat[1] = (temp.horz &gt;&gt; 8) &amp; 0xFF;</div><div class="line">    sitronix.cmd_dat[2] = temp.vert &amp; 0xFF;</div><div class="line">    sitronix.cmd_dat[3] = (temp.vert &gt;&gt; 8) &amp; 0xFF;</div><div class="line">    sitronix.cmd_dat[4] = temp.factor &amp; 0xFF;</div><div class="line">    sitronix.cmd_dat[5] = (temp.factor &gt;&gt; 8) &amp; 0xFF;</div><div class="line">    dual_audio_send_dsp_data(T_DSP_LOAD_AUDIO_SPACE, 6);</div><div class="line">    ...</div><div class="line">} </div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
