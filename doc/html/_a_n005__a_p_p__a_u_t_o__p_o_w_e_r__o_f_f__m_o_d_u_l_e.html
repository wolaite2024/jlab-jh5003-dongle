<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="APP_AUTO_POWER_OFF_Module_Page"></a>
APP AUTO POWER OFF Module Application Note    </h1>
<h2><a class="anchor" id="Rws_App_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n005__a_p_p__a_u_t_o__p_o_w_e_r__o_f_f__m_o_d_u_l_e.html#APP_AUTO_POWER_OFF_Module_Introduction">Introduction</a></li>
<li><a class="el" href="_a_n005__a_p_p__a_u_t_o__p_o_w_e_r__o_f_f__m_o_d_u_l_e.html#APP_AUTO_POWER_OFF">app auto power off</a></li>
</ul>
<h2><a class="anchor" id="APP_AUTO_POWER_OFF_Module_Introduction"></a>
Introduction</h2>
<p>The purpose of this document is to give an overview of the app auto power off module for customer. The document describes how to use auto power off module in app project. The source code consists of <b>APP_AUTO_POWER_OFF</b> part. The details will be described in the following sections.</p>
<h2><a class="anchor" id="APP_AUTO_POWER_OFF"></a>
app auto power off</h2>
<p>This section describes app auto power off module. The reference file is shown as follows:</p><ul>
<li>Project source code directory: sdk\src\sample\rws\app_auto_power_off.c This module is used to handle auto power off message.</li>
</ul>
<h3>Initialize auto power off</h3>
<p>Register auto power off timer callback. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_auto_power_off_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    poweroff_flag = 0;</div><div class="line"></div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga5d2a3ae9710b2036a2907647a1932f0f">app_timer_reg_cb</a>(app_auto_power_off_timeout_cb, &amp;auto_power_off_timer_id);</div><div class="line">    <a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#ga6b27ecfe7b3dfa93341db098f907a839">sys_mgr_cback_register</a>(app_auto_power_off_dm_cback);</div><div class="line">}</div></div><!-- fragment --><h3>Handle auto power off event</h3>
<p>power off directly until power off timer timeout when rws not engaged; sync power off until power off timer timeout when rws engaged; </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_auto_power_off_timeout_cb(uint8_t timer_evt, uint16_t param)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (timer_evt)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> APP_TIMER_AUTO_POWER_OFF:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___t_i_m_e_r.html#gab262773f9eb7292623795486a27219a2">app_stop_timer</a>(&amp;timer_idx_auto_power_off);</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___o_t_a___exported___functions.html#ga12f40296e5171d83d075c9b52f65af70">app_ota_mode_check</a>())</div><div class="line">            {</div><div class="line">                <a class="code" href="group__x3d___t_r_a_c_e.html#ga5d77ab23ef056676a6860b9959404140">APP_PRINT_INFO0</a>(<span class="stringliteral">&quot;app_ota_mode_check is true, stop auto power off&quot;</span>);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line"></div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.device_state == <a class="code" href="group___a_p_p___d_e_v_i_c_e___exported___types.html#gga15b39534ff1f5dd5236b4bcb615d24cda0deaa491ef64769f29a516604e2f29eb">APP_DEVICE_STATE_ON</a>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.power_off_cause = POWER_OFF_CAUSE_AUTO_POWER_OFF;</div><div class="line"></div><div class="line">                <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.remote_session_state == <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#gga3fafc6057a393641404e5040d6f0aca9a0d477163c2943e4e2aa3059ac6f26db4">REMOTE_SESSION_STATE_DISCONNECTED</a>)</div><div class="line">                {</div><div class="line">                    <a class="code" href="group___a_p_p___m_m_i.html#ga052f779c9e19fc32946d63b132fcae09">app_mmi_handle_action</a>(<a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1bae50ab1dc33d3f1323c6500f2e6576b8c">MMI_DEV_POWER_OFF</a>);</div><div class="line">                }</div><div class="line">                <span class="keywordflow">else</span></div><div class="line">                {</div><div class="line">                    uint8_t action = <a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1bae50ab1dc33d3f1323c6500f2e6576b8c">MMI_DEV_POWER_OFF</a>;</div><div class="line"></div><div class="line">                    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#ga0063edee2b4c1c981d2db26ef6ff820a">app_cfg_nv</a>.<a class="code" href="group___a_p_p___c_f_g.html#gabfb0c86126653790eb2fe7390d660496">bud_role</a> == <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#ggad48900c988433e8bd9e07b08a225fdf4a52f9edca7136cdeaabe8942e059fa05e">REMOTE_SESSION_ROLE_PRIMARY</a>)</div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga125c8ba076b5c98ee98d0cb530fbae02">app_relay_sync_single</a>(<a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedead77f1f2a9e55707aa66edb68e7d25972">APP_MODULE_TYPE_MMI</a>, action, <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#gga3c3ff337bc7252c709cee6e8495078efafcba9650d813dbd1b86ffa3daaad5ec6">REMOTE_TIMER_HIGH_PRECISION</a>,</div><div class="line">                                              0, <span class="keyword">false</span>);</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <a class="code" href="group___a_p_p___r_e_l_a_y.html#ga125c8ba076b5c98ee98d0cb530fbae02">app_relay_sync_single</a>(<a class="code" href="group___a_p_p___r_e_l_a_y.html#gga8fe3ea47e0bf7256d6bca08cb28eeedead77f1f2a9e55707aa66edb68e7d25972">APP_MODULE_TYPE_MMI</a>, action, <a class="code" href="group___r_e_m_o_t_e___c_o_n_t_r_o_l.html#gga3c3ff337bc7252c709cee6e8495078efafcba9650d813dbd1b86ffa3daaad5ec6">REMOTE_TIMER_HIGH_PRECISION</a>,</div><div class="line">                                              0, <span class="keyword">true</span>);</div><div class="line">                    }</div><div class="line">                }</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3>Handle auto power off event</h3>
<p>auto power off timer will stop when system go into power off </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_auto_power_off_dm_cback(<a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#ga17c64f28c161ee1a43e988bbf7aa08ba">T_SYS_EVENT</a> event_type, <span class="keywordtype">void</span> *event_buf, uint16_t buf_len)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (event_type)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___s_y_s_t_e_m___m_a_n_a_g_e_r.html#gga58c18773b27c0caf62739de85017a0a8a1ef8ec2159a968408f240fdefc6d1cc9">SYS_EVENT_POWER_OFF</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___t_i_m_e_r.html#gab262773f9eb7292623795486a27219a2">app_stop_timer</a>(&amp;timer_idx_auto_power_off);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">default</span>:</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3>Auto power off enable</h3>
<p>enable auto power off when poweroff_flag is zero. case1: do nothing when poweroff_flag and timeout are zero; case2: auto power off when poweroff_flag is zero and timeout is not zero </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_auto_power_off_enable(uint32_t flag, uint16_t timeout)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gaf34dcfea4922ac2ee4438be751135125">APP_PRINT_TRACE3</a>(<span class="stringliteral">&quot;app_auto_power_off_enable: curr flag 0x%08x, clear flag 0x%08x, timeout %u&quot;</span>,</div><div class="line">                     poweroff_flag, flag, timeout);</div><div class="line"></div><div class="line">    poweroff_flag &amp;= ~flag;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (poweroff_flag == 0)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (timeout == 0)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___t_i_m_e_r.html#gab262773f9eb7292623795486a27219a2">app_stop_timer</a>(&amp;timer_idx_auto_power_off);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga7e0ebc306e15dabba884fda9e981df9a">app_start_timer</a>(&amp;timer_idx_auto_power_off, <span class="stringliteral">&quot;auto_power_off&quot;</span>,</div><div class="line">                            auto_power_off_timer_id, APP_TIMER_AUTO_POWER_OFF, 0, <span class="keyword">false</span>,</div><div class="line">                            (timeout * 1000));</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3>Auto power off disable</h3>
<p>disable auto power off when poweroff_flag is not zero. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_auto_power_off_disable(uint32_t flag)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga517945d492f75547264f521def378025">APP_PRINT_TRACE2</a>(<span class="stringliteral">&quot;app_auto_power_off_disable: curr flag 0x%08x, set flag 0x%08x&quot;</span>,</div><div class="line">                     poweroff_flag, flag);</div><div class="line"></div><div class="line">    poweroff_flag |= flag;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (poweroff_flag != 0)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___t_i_m_e_r.html#gab262773f9eb7292623795486a27219a2">app_stop_timer</a>(&amp;timer_idx_auto_power_off);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
