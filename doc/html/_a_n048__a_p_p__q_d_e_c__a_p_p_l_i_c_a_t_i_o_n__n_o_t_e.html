<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="APP_Qdec_Page"></a>
APP QDEC Module Application Note </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2023/05/26</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0  </td><td class="markdownTableBodyCenter">2021/12/01  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/05/26  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Rev">Revision History</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Table_List">Table List</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_McuConfigTool_Configuration">2 McuConfigTool Configuration</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Source_Code_Overview">3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Initialization">3.1 QDEC Initialization</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Interrupt_Process">3.2 QDEC Interrupt Process</a></li>
<li><a class="el" href="_a_n048__a_p_p__q_d_e_c__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#APP_QDEC_Interrupt_Low_Power_Mode">3.3 QDEC Low Power Mode</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 QDEC enable</a></li>
<li><a href="#figure_2_2">Figure 2-2 QDEC pinmux configuration</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">QDEC  </td><td class="markdownTableBodyCenter">Quadrature Decoder   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Introduction"></a>
1 Introduction</h2>
<p>QDEC is used to detect the motion state of the rotation sensing device. For more details about operation principle of QDEC, please refer to <a class="el" href="_u_m012__i_o__d_e_m_o.html#QDEC">18 QDEC</a> in <a class="el" href="_u_m012__i_o__d_e_m_o.html#IO_Demo_App_Page">IO User Manual </a> .This document provides overview of APP QDEC module. The following topics are included:</p><ul>
<li>Configuration in McuConfigTool</li>
<li>Source code review</li>
</ul>
<p>Macro F_APP_QDECODE_SUPPORT should be defined when APP QDEC module is used.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_McuConfigTool_Configuration"></a>
2 McuConfigTool Configuration</h2>
<p>QDEC can be enabled in "HW Feature" page as shown in following figure. </p><div class="image">
<img src="app_qdec_enable.png" alt="app_qdec_enable.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 QDEC enable</b></div></center><p> <br />
 <br />
 QDEC pin can be set in following figure. </p><div class="image">
<img src="app_qdec_pinmux_config.png" alt="app_qdec_pinmux_config.png"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 QDEC pinmux configuration</b></div></center><p> <br />
 <br />
</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_QDEC_Source_Code_Overview"></a>
3 Source Code Overview</h2>
<p>This chapter provide overview of app QDEC source code. The following topics will be included:</p><ul>
<li>QDEC initialization</li>
<li>QDEC interrupt process</li>
<li>Process when enter and exit low power mode</li>
</ul>
<h3><a class="anchor" id="APP_QDEC_Initialization"></a>
3.1 QDEC Initialization</h3>
<p>The components of QDEC initialization are as follows:</p><ul>
<li>Pad and pinmux initialization</li>
<li>Driver initialization</li>
<li>Register callback function</li>
</ul>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_pad_config(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHA_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a8309999f45f91d480cb6fbb7082efbf3">PAD_PINMUX_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>,</div><div class="line">               <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>,</div><div class="line">               <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHB_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a8309999f45f91d480cb6fbb7082efbf3">PAD_PINMUX_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>,</div><div class="line">               <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>,</div><div class="line">               <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line">}</div></div><!-- fragment --><p>Read QDEC initial level status before pinmux initialization and driver initialization.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_init_status_read(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga3826ae3324dab5d23192d2101f2cab3b">hal_gpio_init_pin</a>(QDEC_Y_PHA_PIN, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga18690463b43fb88963baf1098b54f075ad6bf32430a2b7af6721521d3e247f978">GPIO_TYPE_CORE</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga83e087b95bdbbc7626f48a407120b429a3f9cca83af864e65a125bb363f5cc1a6">GPIO_DIR_INPUT</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#ggac9b234191aefcbffa9f5cbfcb67ba911ae7d1b2a9078939dd744dd9a7cd61d9df">GPIO_PULL_UP</a>);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga3826ae3324dab5d23192d2101f2cab3b">hal_gpio_init_pin</a>(QDEC_Y_PHB_PIN, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga18690463b43fb88963baf1098b54f075ad6bf32430a2b7af6721521d3e247f978">GPIO_TYPE_CORE</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#gga83e087b95bdbbc7626f48a407120b429a3f9cca83af864e65a125bb363f5cc1a6">GPIO_DIR_INPUT</a>, <a class="code" href="group___h_a_l___g_p_i_o___exported___constants.html#ggac9b234191aefcbffa9f5cbfcb67ba911ae7d1b2a9078939dd744dd9a7cd61d9df">GPIO_PULL_UP</a>);</div><div class="line">    qdecoder_a_status = <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga72f8dccebef04fca81c21d69ede70381">hal_gpio_get_input_level</a>(QDEC_Y_PHA_PIN);</div><div class="line">    qdecoder_b_status = <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga72f8dccebef04fca81c21d69ede70381">hal_gpio_get_input_level</a>(QDEC_Y_PHB_PIN);</div><div class="line"></div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p> Pinmux initialization and driver initialization.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_qdec_pinmux_config(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga54f185f00ccea46d0645189f40a4f8d0">Pinmux_Config</a>(QDEC_Y_PHA_PIN, <a class="code" href="group___pin___function___number.html#gac8a89d803c05dcf46fb6414b3f095b3e">QDEC_PHASE_A_Y</a>);</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga54f185f00ccea46d0645189f40a4f8d0">Pinmux_Config</a>(QDEC_Y_PHB_PIN, <a class="code" href="group___pin___function___number.html#ga7d8c6eced103871bb351428198dee799">QDEC_PHASE_B_Y</a>);</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_driver_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_c_c___exported___functions.html#ga883379580c235037d0c1ed70340fb680">RCC_PeriphClockCmd</a>(<a class="code" href="group___a_p_b___peripheral___define.html#ga4493bccbbd592ddb58fd4af530fdf2d2">APBPeriph_QDEC</a>, <a class="code" href="group___r_c_c___peripheral___clock.html#gaaab1246478accb9791d4e1240b9fc1fe">APBPeriph_QDEC_CLOCK</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>);</div><div class="line"></div><div class="line">    <a class="code" href="struct_q_d_e_c___init_type_def.html">QDEC_InitTypeDef</a> qdecInitStruct;</div><div class="line">    <a class="code" href="group___q_d_e_c___exported___functions.html#gaf179052c05265ee8e47bc54a067b38a1">QDEC_StructInit</a>(&amp;qdecInitStruct);</div><div class="line">    qdecInitStruct.<a class="code" href="struct_q_d_e_c___init_type_def.html#a137b165665887def79bc318296635500">axisConfigY</a>       = <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>;</div><div class="line">    qdecInitStruct.<a class="code" href="struct_q_d_e_c___init_type_def.html#a05b106fa875ab2346da5eaefc9211121">debounceEnableY</a>   = <a class="code" href="group___qdec___debounce.html#ga9686dfbc929dc08d7c4b28dcfccc0d26">Debounce_Enable</a>;</div><div class="line">    qdecInitStruct.<a class="code" href="struct_q_d_e_c___init_type_def.html#ab49a08cc69b14ec7d7d142e6fde2cc98">initPhaseY</a> = (qdecoder_a_status &lt;&lt; 1) | qdecoder_b_status;</div><div class="line">    qdecInitStruct.<a class="code" href="struct_q_d_e_c___init_type_def.html#a9a580eae054d166c9e963e9acf067f45">counterScaleY</a> = CounterScale_1_Phase;</div><div class="line">    <a class="code" href="group___q_d_e_c___exported___functions.html#gade5297f26899ed8d3088456b45fc1775">QDEC_Init</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, &amp;qdecInitStruct);</div><div class="line">    <a class="code" href="group___q_d_e_c___exported___functions.html#gacd994273775ba2eb899ac530aa82a433">QDEC_INTConfig</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___interrupts___definition.html#ga7a3db7c138155ec683950c2f0c7a42ef">QDEC_Y_INT_NEW_DATA</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>);</div><div class="line">    <a class="code" href="group___q_d_e_c___exported___functions.html#ga9ebd7591104d9ced9d87da0a02274634">QDEC_INTMask</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___interrupts___mask.html#ga220773fb62d72f5bbb0d170649ba237a">QDEC_Y_ILLEAGE_INT_MASK</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>);</div><div class="line">    <a class="code" href="group___q_d_e_c___exported___functions.html#ga9a87df4e73533150760596ab85c4b707">QDEC_Cmd</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___axis.html#gaa8acf9fe79a8db9b4e39d1ad9f564c55">QDEC_AXIS_Y</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>);</div><div class="line"></div><div class="line">    <a class="code" href="struct_n_v_i_c___init_type_def.html">NVIC_InitTypeDef</a> nvic_init_struct;</div><div class="line">    nvic_init_struct.<a class="code" href="struct_n_v_i_c___init_type_def.html#a921af0ab04e071d7d276c003e0048123">NVIC_IRQChannel</a>         = <a class="code" href="group__x3e___r_t_l876x___exported__types.html#gga666eb0caeb12ec0e281415592ae89083a59082da14040ed6cf7410cc2d0909c42">QDEC_IRQn</a>;</div><div class="line">    nvic_init_struct.<a class="code" href="struct_n_v_i_c___init_type_def.html#a3c5567ef024a0489884083c88f17b4d5">NVIC_IRQChannelCmd</a>      = (<a class="code" href="group__x3d___r_t_l876x___exported__types.html#gac9a7e9a35d2513ec15c3b537aaa4fba1">FunctionalState</a>)<a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>;</div><div class="line">    nvic_init_struct.<a class="code" href="struct_n_v_i_c___init_type_def.html#acd582bc2edce30e9d7ab5e0ede400f36">NVIC_IRQChannelPriority</a> = 3;</div><div class="line">    <a class="code" href="group__x3e___n_v_i_c___exported___functions.html#ga4e06b4f5c9109d6bc8990adf77e5f8d3">NVIC_Init</a>(&amp;nvic_init_struct);</div><div class="line"></div><div class="line">    app_qdec_ctx_clear();</div><div class="line">}</div></div><!-- fragment --><p>Register callback function. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga5d2a3ae9710b2036a2907647a1932f0f">app_timer_reg_cb</a>(app_qdec_timeout_cb, &amp;app_qdec_timer_id);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_QDEC_Interrupt_Process"></a>
3.2 QDEC Interrupt Process</h3>
<p>In QDEC interrupt handler, the following action will be done:</p><ul>
<li>Mask counter interrupt</li>
<li>Read direction and count</li>
<li>Send message to APP task</li>
</ul>
<div class="fragment"><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#ga501017c9d06ffea48e92d5ed3757b9f5">RAM_TEXT_SECTION</a> <span class="keywordtype">void</span> QDEC_Handler(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___q_d_e_c___exported___functions.html#gacc687346250976886fb5b053a597db2b">QDEC_GetFlagState</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___flag.html#ga8a6928392ed43cda6b57045d2d26c838">QDEC_FLAG_NEW_CT_STATUS_Y</a>) == <a class="code" href="group__x3e___r_t_l876x___exported__types.html#gga89136caac2e14c55151f527ac02daaffab44c8101cc294c074709ec1b14211792">SET</a>)</div><div class="line">    {</div><div class="line">        <span class="comment">/* Mask qdec interrupt */</span></div><div class="line">        <a class="code" href="group___q_d_e_c___exported___functions.html#ga9ebd7591104d9ced9d87da0a02274634">QDEC_INTMask</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___interrupts___mask.html#ga961f4ee009a521c220c462daad2994a0">QDEC_Y_CT_INT_MASK</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1a7d46875fa3ebd2c34d2756950eda83bf">ENABLE</a>);</div><div class="line"></div><div class="line">        <span class="comment">/* Read direction &amp; count */</span></div><div class="line">        qdec_ctx.dir = <a class="code" href="group___q_d_e_c___exported___functions.html#gabc4e98dccd551bd5d32d554bd5a4379e">QDEC_GetAxisDirection</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___axis.html#gaa8acf9fe79a8db9b4e39d1ad9f564c55">QDEC_AXIS_Y</a>);</div><div class="line">        qdec_ctx.cur_ct = <a class="code" href="group___q_d_e_c___exported___functions.html#gafa4699626001aaa370839adf020a9db5">QDEC_GetAxisCount</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___axis.html#gaa8acf9fe79a8db9b4e39d1ad9f564c55">QDEC_AXIS_Y</a>);</div><div class="line"></div><div class="line">        <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> qdec_msg;</div><div class="line"></div><div class="line">        qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">        qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10ad3744019b3fb32c0b05f4a5aafb934fa">IO_MSG_GPIO_QDEC</a>;</div><div class="line">        qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = (qdec_ctx.dir &lt;&lt; 16) | 1;</div><div class="line"></div><div class="line">        <a class="code" href="group__x3d___t_r_a_c_e.html#ga98e2dee240d2fde3119d3380b4d98762">APP_PRINT_INFO3</a>(<span class="stringliteral">&quot;QDEC_Handler: pre_ct %d , cur_ct %d  wakeup_2phase %d&quot;</span>, qdec_ctx.pre_ct,</div><div class="line">                        qdec_ctx.cur_ct, wakeup_2phase);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (qdec_ctx.pre_ct == 0)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (wakeup_2phase == <span class="keyword">false</span>)</div><div class="line">            {</div><div class="line">                <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;qdec_msg);</div><div class="line">                qdec_ctx.pre_ct = qdec_ctx.cur_ct;</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((qdec_ctx.cur_ct - qdec_ctx.pre_ct &gt;= 2) || (qdec_ctx.cur_ct - qdec_ctx.pre_ct &lt;= -2))</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;qdec_msg);</div><div class="line">            qdec_ctx.pre_ct = qdec_ctx.cur_ct;</div><div class="line">        }</div><div class="line"></div><div class="line">        <span class="comment">/* clear qdec interrupt flags */</span></div><div class="line">        QDEC_ClearINTPendingBit(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___clr___flag.html#gaf72dedc8836ad8fce9b97d32ce8b7426">QDEC_CLR_NEW_CT_Y</a>);</div><div class="line">        <span class="comment">/* Unmask qdec interrupt */</span></div><div class="line">        <a class="code" href="group___q_d_e_c___exported___functions.html#ga9ebd7591104d9ced9d87da0a02274634">QDEC_INTMask</a>(<a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga9acb39c1a508c83bf15e974d62c4a06f">QDEC</a>, <a class="code" href="group___q_d_e_c___interrupts___mask.html#ga961f4ee009a521c220c462daad2994a0">QDEC_Y_CT_INT_MASK</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1ad3a9df141be0ccf10389b640f492b26d">DISABLE</a>);</div><div class="line"></div><div class="line">    }</div><div class="line">    wakeup_2phase = <span class="keyword">false</span>;</div><div class="line">}</div></div><!-- fragment --><p>When QDEC msg received, do action accroding to QDEC rotation direction. Volume up/down MMI is called in the following sample code.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_msg_handler(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *io_driver_msg_recv)</div><div class="line">{</div><div class="line">    uint16_t direction = io_driver_msg_recv-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> &gt;&gt; 16;</div><div class="line">    uint16_t delta = (uint16_t)(io_driver_msg_recv-&gt;<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> &amp; 0xFFFF);</div><div class="line">    <span class="keywordtype">bool</span> vol_is_up = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#gacede19f539147e375272a511869b7a77">APP_PRINT_INFO2</a>(<span class="stringliteral">&quot;app_qdec_msg_handler: delta 0x%x , direction %d&quot;</span>, delta, direction);</div><div class="line"></div><div class="line">    vol_is_up = (direction != 0) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (delta == QDEC_WAKEUP_MAGIC_NUM)</div><div class="line">    {</div><div class="line">        <span class="comment">//only need start timer</span></div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (vol_is_up)</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___m_m_i.html#ga052f779c9e19fc32946d63b132fcae09">app_mmi_handle_action</a>(<a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1bae56062b30503adb2295ae991da5521a3">MMI_DEV_SPK_VOL_UP</a>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___m_m_i.html#ga052f779c9e19fc32946d63b132fcae09">app_mmi_handle_action</a>(<a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1ba3ea2c8afda57bdcea1867727bdb764da">MMI_DEV_SPK_VOL_DOWN</a>);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga4d38badd8336c312862e039f616933b0">app_dlps_disable</a>(<a class="code" href="group___a_p_p___d_l_p_s___exported___macros.html#ga49421429875f704f04e5d73fc9f50dd6">APP_DLPS_ENTER_CHECK_QDEC</a>);</div><div class="line">    <a class="code" href="group___a_p_p___t_i_m_e_r.html#ga7e0ebc306e15dabba884fda9e981df9a">app_start_timer</a>(&amp;timer_idx_qdec_block_dlps, <span class="stringliteral">&quot;qdec_block_dlps&quot;</span>,</div><div class="line">                    app_qdec_timer_id, 0, 0, <span class="keyword">false</span>,</div><div class="line">                    QDEC_BLOCK_DLPS_TIMER_MS);</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_QDEC_Interrupt_Low_Power_Mode"></a>
3.3 QDEC Low Power Mode</h3>
<p>This chapter will explain how to enter and exit low power mode. The following content is included:</p><ul>
<li>What will be done before entering low power mode</li>
<li>What will be done after exiting low power mode</li>
<li>What will be done before entering power down mode</li>
</ul>
<p>Before entering low power mode, do pad configuration and enable pad wakeup interrupt. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_pad_enter_dlps_config(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_qdec_init_status_read();</div><div class="line"></div><div class="line">    pre_a_status = qdecoder_a_status;</div><div class="line">    pre_b_status = qdecoder_b_status;</div><div class="line"></div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHA_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a63d53e3c9ddf88d4806c1f7aa539564c">PAD_SW_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHB_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a63d53e3c9ddf88d4806c1f7aa539564c">PAD_SW_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475ae7cf699523e72c6a7d461137324b4830">PAD_PULL_UP</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (qdecoder_a_status)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga10806ee110b753cfa6287382203b7777">app_dlps_set_pad_wake_up</a>(QDEC_Y_PHA_PIN, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5e5f38a5052474acc16a2ca50bb9933c">PAD_WAKEUP_POL_LOW</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga10806ee110b753cfa6287382203b7777">app_dlps_set_pad_wake_up</a>(QDEC_Y_PHA_PIN, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5311aef47d0e3482d1fdabdaa3ec2ad6">PAD_WAKEUP_POL_HIGH</a>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (qdecoder_b_status)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga10806ee110b753cfa6287382203b7777">app_dlps_set_pad_wake_up</a>(QDEC_Y_PHB_PIN, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5e5f38a5052474acc16a2ca50bb9933c">PAD_WAKEUP_POL_LOW</a>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___d_l_p_s___exported___functions.html#ga10806ee110b753cfa6287382203b7777">app_dlps_set_pad_wake_up</a>(QDEC_Y_PHB_PIN, <a class="code" href="group__x3e___p_a_d___wake_up___polarity___value.html#ggab0360a5d25ad691d3ce92f1270a7e0fca5311aef47d0e3482d1fdabdaa3ec2ad6">PAD_WAKEUP_POL_HIGH</a>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p> Enter QDEC wakeup handle when system wakeup form low power mode by QDEC pin. Send message to APP task in this handler. If level of two pins all changed, valid direction and delta parametrs will be included in the message.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_wakeup_handle(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_qdec_init_status_read();</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (pre_a_status != qdecoder_a_status ||</div><div class="line">        pre_b_status != qdecoder_b_status)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (pre_a_status != qdecoder_a_status &amp;&amp;</div><div class="line">            pre_b_status != qdecoder_b_status)</div><div class="line">        {</div><div class="line">            wakeup_2phase = <span class="keyword">true</span>;</div><div class="line">            <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> qdec_msg;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10ad3744019b3fb32c0b05f4a5aafb934fa">IO_MSG_GPIO_QDEC</a>;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = (qdec_ctx.dir &lt;&lt; 16) | 1;</div><div class="line">            <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;qdec_msg);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span></div><div class="line">        {</div><div class="line">            <span class="comment">//send msg to start qdec timer outside</span></div><div class="line">            <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> qdec_msg;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10ad3744019b3fb32c0b05f4a5aafb934fa">IO_MSG_GPIO_QDEC</a>;</div><div class="line">            qdec_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = QDEC_WAKEUP_MAGIC_NUM;</div><div class="line">            <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;qdec_msg);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>When exiting low power mode , driver initialization will be done. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_pad_exit_dlps_config(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_qdec_init_status_read();</div><div class="line">    app_qdec_driver_init();</div><div class="line">}</div></div><!-- fragment --><p> Considering power consumption, pad will be pulled down before entering power down mode.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_qdec_enter_power_down_cfg(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group___r_c_c___exported___functions.html#ga883379580c235037d0c1ed70340fb680">RCC_PeriphClockCmd</a>(<a class="code" href="group___a_p_b___peripheral___define.html#ga4493bccbbd592ddb58fd4af530fdf2d2">APBPeriph_QDEC</a>, <a class="code" href="group___r_c_c___peripheral___clock.html#gaaab1246478accb9791d4e1240b9fc1fe">APBPeriph_QDEC_CLOCK</a>, <a class="code" href="group__x3e___r_t_l876x___exported__types.html#ggac9a7e9a35d2513ec15c3b537aaa4fba1ad3a9df141be0ccf10389b640f492b26d">DISABLE</a>);</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHA_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a63d53e3c9ddf88d4806c1f7aa539564c">PAD_SW_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475a7428dd8f0f6a28898ca7abfbcc02c02b">PAD_PULL_DOWN</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line">    <a class="code" href="group___p_i_n_m_u_x___exported___functions.html#ga38de86a8ea4d49c04e681494cc1c69cc">Pad_Config</a>(QDEC_Y_PHB_PIN, <a class="code" href="group__x3e___p_a_d___mode.html#gga2cc156cba11040bcf54db2efeb9cb587a63d53e3c9ddf88d4806c1f7aa539564c">PAD_SW_MODE</a>, <a class="code" href="group__x3e___p_a_d___power___mode.html#ggac2e804c73a9d287080d1cf1207e6a177a64ef7041a073bac1e848da51333064e0">PAD_IS_PWRON</a>, <a class="code" href="group__x3e___p_a_d___pull___mode.html#ggaed6ddbb1abccbd7d16dd3dcb8319f475a7428dd8f0f6a28898ca7abfbcc02c02b">PAD_PULL_DOWN</a>, <a class="code" href="group__x3e___p_a_d___output___config.html#ggacfc9e3ea370eb8401828c4b97c110dd0addca868800d517c0513e6a87c3350a00">PAD_OUT_DISABLE</a>, <a class="code" href="group__x3e___p_a_d___output___value.html#gga1bbbfd046e26ccb142c1b42f1d4dccd7a05d2e6f1ea0162d1d61ab077a5e988a5">PAD_OUT_LOW</a>);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
