<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Listening_Mode_Page"></a>
Listening Mode Application Note </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2024/01/15</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0  </td><td class="markdownTableBodyCenter">2023/10/10  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2024/01/15  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Rev">Revision History</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Table_List">Table List</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Glossary">Glossary</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Typical_Use_Case">2 Typical Use Case</a><ul>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Power_On">2.1 Listening Mode State When Power On</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Key_MMI_Control">2.2 Listening Mode MMI Control Case</a><ul>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Key_MMI_Listening_Mode_Cycle">2.2.1 Listening Mode Cycle</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Key_MMI_Default_Listening_Mode_Cycle">2.2.2 Default Listening Mode Cycle</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_Key_MMI_Custom_Mode">2.2.3 Custom Cycle Mode</a></li>
</ul>
</li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_In_Out_Box">2.3 Listening Mode In Out Box</a></li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_In_Out_Ear">2.4 Listening Mode In Out Ear</a></li>
</ul>
</li>
<li><a class="el" href="_a_n049__l_i_s_t_e_n_i_n_g__m_o_d_e__a_p_p_l_i_c_a_t_i_o_n__n_o_t_e.html#Listening_Mode_State_Machine">3 Listening Mode State Machine</a> <div style="page-break-after: always;"></div></li>
</ul>
<h2><a class="anchor" id="Listening_Mode_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_1_1">Figure 1-1 Listening Mode Component</a></li>
<li><a href="#figure_2_1">Figure 2-1 Listening Mode Power On State</a></li>
<li><a href="#figure_2_2">Figure 2-2 Key MMI Listening Mode Cycle</a></li>
<li><a href="#figure_2_3">Figure 2-3 Key MMI Listening Mode Cycle Mode</a></li>
<li><a href="#figure_2_4">Figure 2-4 Listening Mode Cycle Example</a></li>
<li><a href="#figure_2_5">Figure 2-5 Key MMI Default Listening Mode Cycle</a></li>
<li><a href="#figure_2_6">Figure 2-6 Default_Listening Mode Cycle Example 1</a></li>
<li><a href="#figure_2_7">Figure 2-7 Default_Listening Mode Cycle Example 2</a></li>
<li><a href="#figure_2_8">Figure 2-8 Listening Mode In Out Ear</a></li>
<li><a href="#figure_2_9">Figure 2-9 Listening Mode In Out Ear Action</a></li>
<li><a href="#figure_3_1">Figure 3-1 Listening Mode State Machine</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">ANC  </td><td class="markdownTableBodyCenter">Active Noise Cancellation   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">APT  </td><td class="markdownTableBodyCenter">Audio Passthrough   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_Introduction"></a>
1 Introduction</h2>
<p>Listening mode is a mode that include ANC,APT features. Listening mode module is designed to control ANC and APT features for headset .Please refer to <a class="el" href="_a_n045__a_p_p__a_n_c__m_o_d_u_l_e.html#APP_ANC_Module_Page">APP ANC Module Application Note </a> for more detail about ANC. Please refer to <a class="el" href="_a_n041__normal__a_p_t__application__note.html#Normal_APT_Page">Normal APT Function Application Note </a> and <a class="el" href="_a_n040__l_l_a_p_t__application__note.html#LLAPT_Page">LLAPT Function Application Note </a> for more details about normal APT and Low latency APT.</p>
<div class="image">
<img src="listening_mode.png" alt="listening_mode.png"/>
</div>
 <center><div id="figure_1_1"><b>Figure 1-1 Listening Mode Component</b></div></center><p>This document provides overview of listening mode module. The following topics are included:</p><ul>
<li>Typical use case for listening mode in headset</li>
<li>Configuration in McuConfigTool</li>
<li>Listening mode state machine</li>
</ul>
<p>Macro F_APP_LISTENING_MODE_SUPPORT should be defined when listening mode module is used.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_Typical_Use_Case"></a>
2 Typical Use Case</h2>
<p>This chapter will show typical listening mode use cases.</p>
<h3><a class="anchor" id="Listening_Mode_Power_On"></a>
2.1 Listening Mode State When Power On</h3>
<h4><a class="anchor" id="Listening_Mode_Power_On_Configuration"></a>
2.1.1 Configuration</h4>
<p>Choose what listening mode state is wanted when power on in McuConfigTool. </p><div class="image">
<img src="listening_mode_power_on_state.png" alt="listening_mode_power_on_state.png"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Listening Mode Power On State</b></div></center><p> <br />
</p>
<h4><a class="anchor" id="Listening_Mode_Power_On_Code_Overview"></a>
2.1.2 Code Overview</h4>
<p>When power on, the following API will be called to decide the initial listening mode state and apply this listening mode via app_listening_state_machine .</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_listening_apply_when_power_on(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">...</div><div class="line">    <span class="keywordflow">switch</span> (listening_mode_power_on_status)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaa3964f2bf1d8dae8e2760ed87adb1142a0607916d135cfbe18ea89461453bce45">POWER_ON_LISTENING_MODE_FOLLOW_LAST</a>:</div><div class="line">        {</div><div class="line">        ...</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        ...</div><div class="line">    }</div><div class="line">...</div><div class="line"></div><div class="line">#<span class="keywordflow">if</span> <a class="code" href="group___a_p_p___f_l_a_g_s.html#ga220ee16573409797fa8235bd942a38c5">F_APP_APT_SUPPORT</a></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#ga542f01701b2a2a6972e1460bbf3033f7">app_apt_is_apt_on_state</a>(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state))</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#ga417ad36b365d3acec540dce56a3af65c">app_apt_get_apt_support_type</a>() == <a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#gga9373b09ef106af772d5258e9e81400d2a17c3406059b29e9ea22b42860a3bed19">APT_SUPPORT_TYPE_NORMAL_APT</a>)</div><div class="line">        {</div><div class="line">            app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76a2fc288b23739973216d7a0c4cab29dd7">EVENT_NORMAL_APT_ON</a>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#ga417ad36b365d3acec540dce56a3af65c">app_apt_get_apt_support_type</a>() == <a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#gga9373b09ef106af772d5258e9e81400d2a8832f1991d0cf6c325894d5024e15177">APT_SUPPORT_TYPE_LLAPT</a>)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#ga7e1ba9c553700bbba2aa777287962fd4">app_apt_is_llapt_on_state</a>(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state))</div><div class="line">            {</div><div class="line">                app_listening_state_machine(<a class="code" href="group___a_p_p___a_u_d_i_o___p_a_s_s_t_h_r_o_u_g_h.html#ga2c1b3115b995abe65e87c5d44ab448ad">LLAPT_STATE_TO_EVENT</a>(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state), <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">    {</div><div class="line"><span class="preprocessor">#if F_APP_ANC_SUPPORT</span></div><div class="line">        <span class="keywordflow">if</span> (app_anc_is_anc_on_state(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state))</div><div class="line">        {</div><div class="line">            app_listening_state_machine(ANC_STATE_TO_EVENT(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state), <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        }</div><div class="line"><span class="preprocessor">#if F_APP_SUPPORT_ANC_APT_COEXIST</span></div><div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (app_listening_is_anc_apt_on_state(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state))</div><div class="line">        {</div><div class="line">            app_listening_state_machine(ANC_APT_STATE_TO_EVENT(*<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.final_listening_state), <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">        }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        <span class="keywordflow">else</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line">        {</div><div class="line">            <span class="comment">//all off, do nothing</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><p>If "Following last listening mode status" is choosed and specific listening mode state is prefered when first power on after factory reset, setting in following NV struct will be helpfull. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct_t___a_p_p___c_f_g___n_v.html">T_APP_CFG_NV</a> app_cfg_rw_default =</div><div class="line">{</div><div class="line">...</div><div class="line">.anc_one_setting = ,</div><div class="line">.<a class="code" href="struct_t___a_p_p___c_f_g___n_v.html#a94971e62c99eed98e4db8cc14948aef9">anc_both_setting</a> = ,</div><div class="line">.anc_apt_state = ,</div><div class="line">...</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="Listening_Mode_Key_MMI_Control"></a>
2.2 Listening Mode MMI Control Case</h3>
<p>This chapter will show the typical listening mode control cases by key.</p>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Listening_Mode_Cycle"></a>
2.2.1 Listening Mode Cycle</h4>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Listening_Mode_Cycle_Configuration"></a>
2.2.1.1 Configuration</h4>
<p>Choose listening mode cycle MMI in McuConfigTool. </p><div class="image">
<img src="Key_MMI_Listening_Mode_Cycle.png" alt="Key_MMI_Listening_Mode_Cycle.png"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Key MMI Listening Mode Cycle</b></div></center><p> <br />
 Choose listening mode cycle mode in McuConfigTool. </p><div class="image">
<img src="Key_MMI_Listening_Mode_Cycle_Mode.png" alt="Key_MMI_Listening_Mode_Cycle_Mode.png"/>
</div>
 <center><div id="figure_2_3"><b>Figure 2-3 Key MMI Listening Mode Cycle Mode</b></div></center><p> <br />
 </p>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Listening_Mode_Cycle_Code_Overview"></a>
2.2.1.2 Code Overview</h4>
<p>Listening mode state machine will be called with input parameter EVENT_LISTENING_MODE_CYCLE.</p>
<div class="fragment"><div class="line"><span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1ba45a1f4ad4af8c98b35b285043b918af5">MMI_LISTENING_MODE_CYCLE</a>:</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76a77df9e2066e9a93c9741992fac8aa691">EVENT_LISTENING_MODE_CYCLE</a>, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --> <h4><a class="anchor" id="Listening_Mode_Key_MMI_Listening_Mode_Cycle_Example"></a>
2.2.1.3 Example</h4>
<p>If the product needs cycle listening mode between All Off - ANC - LLAPT, and there are two ANC groups and two LLAPT groups. Then listening mode cycle mode ALL off -&gt; ANC on -&gt; APT on should be choosed, and listening mode state cycle sequence will be as following picture. </p><div class="image">
<img src="Listening_Mode_Cycle_Example.png" alt="Listening_Mode_Cycle_Example.png"/>
</div>
 <center><div id="figure_2_4"><b>Figure 2-4 Listening Mode Cycle Example</b></div></center><p> <br />
</p>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Default_Listening_Mode_Cycle"></a>
2.2.2 Default Listening Mode Cycle</h4>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Default_Listening_Mode_Cycle_Configuration"></a>
2.2.2.1 Configuration</h4>
<p>Choose default listening mode cycle MMI in McuConfigTool. </p><div class="image">
<img src="Key_MMI_Default_Listening_Mode_Cycle.png" alt="Key_MMI_Default_Listening_Mode_Cycle.png"/>
</div>
 <center><div id="figure_2_5"><b>Figure 2-5 Key MMI Default Listening Mode Cycle</b></div></center><p> <br />
</p>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Default_Listening_Mode_Cycle_Code_Overview"></a>
2.2.1.2 Code Overview</h4>
<p>Listening mode state machine will be called with input parameter EVENT_DEFAULT_LISTENING_MODE_CYCLE.</p>
<div class="fragment"><div class="line"><span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_m_i.html#gga9d149ac6a749587538729a0111e48e1ba70789a5d03f11ac7a5d614e36820414b">MMI_DEFAULT_LISTENING_MODE_CYCLE</a>:</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76aafc76d105ee1ddfb5506dc7cb3b4600e">EVENT_DEFAULT_LISTENING_MODE_CYCLE</a>, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --> <h4><a class="anchor" id="Listening_Mode_Key_MMI_Default_Listening_Mode_Cycle_Example"></a>
2.2.1.3 Example</h4>
<p>If the product needs cycle listening mode between All Off - ANC - LLAPT, and there are one ANC group and one LLAPT group. Then listening mode cycle mode ALL off -&gt; ANC on -&gt; APT on should be choosed, and listening mode state cycle sequence is shown as following picture. </p><div class="image">
<img src="Default_Listening_Mode_Cycle_Example_1.png" alt="Default_Listening_Mode_Cycle_Example_1.png"/>
</div>
 <center><div id="figure_2_6"><b>Figure 2-6 Default_Listening Mode Cycle Example 1</b></div></center><p> <br />
 If there are two ANC groups and two LLAPT groups, then listening mode state cycle sequence is shown as following picture. </p><div class="image">
<img src="Default_Listening_Mode_Cycle_Example_2.png" alt="Default_Listening_Mode_Cycle_Example_2.png"/>
</div>
 <center><div id="figure_2_7"><b>Figure 2-7 Default_Listening Mode Cycle Example 2</b></div></center><p> ANCx may be ANC1 or ANC2, it depends on the value in global variable app_db.last_anc_on_state. LLAPTx may be LLAPT1 or LLAPT2, it depends on the value in global variable app_db.last_llapt_on_state. <br />
</p>
<h4><a class="anchor" id="Listening_Mode_Key_MMI_Custom_Mode"></a>
2.2.3 Custom Cycle Mode</h4>
<p>It is recommeded to customize the cycle list according to the requirement of the product. Following steps guide you to customize the cycle list.<br />
</p><ul>
<li>Choose "Custom mode" in figure_2_3</li>
<li>Change following cycle list table according to the requirement <div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a></div><div class="line">app_listening_cycle_list[APP_LISTENING_CYCLE_MODE_TOTAL][LISTENING_CYCLE_LIST_MAX_NUM] =</div><div class="line">{</div><div class="line">...</div><div class="line">    <span class="comment">/*custom mode*/</span></div><div class="line">    {</div><div class="line">        <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a268d213a73b337e5ad084bfcc337b10a">ANC_OFF_APT_OFF</a>, <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a6f83c8d8294eeb938d54236ad4784484">ANC_ON_SCENARIO_1_APT_OFF</a>, <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341af3526a536e7ef28ee080c288636e4385">ANC_OFF_NORMAL_APT_ON</a>, <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341ab3ef8ce58a4d5dba02de4c12a29763d4">ANC_OFF_LLAPT_ON_SCENARIO_1</a>, <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341ad2ec453e08d23464697138964a486d04">ANC_ON_SCENARIO_2_APT_ON</a>,</div><div class="line">        (<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gaf545c8348aedcb7205b361bf378af341">T_ANC_APT_STATE</a>)0xFF</div><div class="line">    },</div><div class="line">...</div><div class="line">};</div></div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="Listening_Mode_In_Out_Box"></a>
2.3 Listening Mode In Out Box</h3>
<p>When bud is put into box, listening mode state will turn to All off state. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_listening_rtk_in_case(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_listening_rtk_in_case&quot;</span>);</div><div class="line">    app_listening_special_event_trigger(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga4fc6728824e99b584aa36f1e576b0eb1a36b746a17968e23118f567273976758e">LISTENING_MODE_SPECIAL_EVENT_IN_BOX</a>);</div><div class="line">}</div></div><!-- fragment --> <div class="fragment"><div class="line"><span class="keywordflow">case</span> <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga4fc6728824e99b584aa36f1e576b0eb1a36b746a17968e23118f567273976758e">LISTENING_MODE_SPECIAL_EVENT_IN_BOX</a>:</div><div class="line">    {</div><div class="line">        listening_special_event_bitmap |= <a class="code" href="group__x3d___r_t_l876_x___exported___macros.html#ga3a8ea58898cb58fc96013383d39f482c">BIT</a>(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ga8830f183899d1492fbd70690bb7fb6e6">APP_LISTENING_EVENT_BOX</a>);</div><div class="line"></div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___b_t___p_a_n___d_e_m_o___l_i_n_k.html#gac563cf0f8ddf7768f3da4ab95cdd884e">app_db</a>.current_listening_state != <a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ggaf545c8348aedcb7205b361bf378af341a268d213a73b337e5ad084bfcc337b10a">ANC_OFF_APT_OFF</a>)</div><div class="line">        {</div><div class="line">            app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76ad0cd1074ac132eeef5098f05fdfd46a0">EVENT_ALL_OFF</a>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div></div><!-- fragment --><p> When bud is get out of box, listening mode state will turn to final listening mode state which depends on the value in app_db.final_listening_state. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_listening_rtk_out_case(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_listening_rtk_out_case&quot;</span>);</div><div class="line">    app_listening_special_event_trigger(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga4fc6728824e99b584aa36f1e576b0eb1a4f066c6f3a57d129da59b1cdd08d3666">LISTENING_MODE_SPECIAL_EVENT_OUT_BOX</a>);</div><div class="line">}</div></div><!-- fragment --> <div class="fragment"><div class="line">app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga1f67a027bf5550cc90d38c8fd68cab76a4194b05c3f2a8d68d4f6f76b29a1af3a">EVENT_APPLY_FINAL_STATE</a>, <span class="keyword">false</span>, <span class="keyword">false</span>);</div></div><!-- fragment --><h3><a class="anchor" id="Listening_Mode_In_Out_Ear"></a>
2.4 Listening Mode In Out Ear</h3>
<h4><a class="anchor" id="Listening_Mode_In_Out_Ear_Configuration"></a>
2.4.1 Configuration</h4>
<p>Select "Light sensor support" in McuConfigTool. If "Listening mode does not depend on in ear status" is not selected, then in ear status will have influnce on listening mode state, otherwise, in ear status will have no influnce on listening mode state. </p><div class="image">
<img src="Listening_Mode_In_Out_Ear.png" alt="Listening_Mode_In_Out_Ear.png"/>
</div>
 <center><div id="figure_2_8"><b>Figure 2-8 Listening Mode In Out Ear</b></div></center><p> <br />
</p>
<h4><a class="anchor" id="Listening_Mode_In_Out_Ear_Code_Overview"></a>
2.4.2 Code Overview</h4>
<p>This chapter will show related code if "Listening mode does not depend on in ear status" is not selected.</p>
<p>If local bud or remote bud is put into ear or get out of ear, two buds will change listening mode state as following flow. </p><div class="image">
<img src="Listening_Mode_In_Out_Ear_Action.png" alt="Listening_Mode_In_Out_Ear_Action.png"/>
</div>
 <center><div id="figure_2_9"><b>Figure 2-9 Listening Mode In Out Ear Action</b></div></center><p> <br />
 </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_listening_rtk_in_ear(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">            app_listening_special_event_trigger(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga4fc6728824e99b584aa36f1e576b0eb1ac77b3cfa88a0a82a15fab02b94d214a3">LISTENING_MODE_SPECIAL_EVENT_IN_EAR</a>);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keywordtype">void</span> app_listening_rtk_out_ear(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <a class="code" href="group__x3d___t_r_a_c_e.html#ga3865df28228d19d7a9c874cddfada3c4">APP_PRINT_TRACE0</a>(<span class="stringliteral">&quot;app_listening_rtk_out_ear&quot;</span>);</div><div class="line"></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___g_s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga667e43446e8246b214bdbe96809e7d62">LIGHT_SENSOR_ENABLED</a> &amp;&amp;</div><div class="line">        !<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.<a class="code" href="struct_t___a_p_p___c_f_g___c_o_n_s_t.html#a5a4f391f4e026ff06fa21d8bf5472dad">listening_mode_does_not_depend_on_in_ear_status</a>)</div><div class="line">    {</div><div class="line">        app_listening_special_event_trigger(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#gga4fc6728824e99b584aa36f1e576b0eb1a9c0f2c9e1d98ab0d7ceb7fe03134bdd6">LISTENING_MODE_SPECIAL_EVENT_OUT_EAR</a>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="Listening_Mode_State_Machine"></a>
3 Listening Mode State Machine</h2>
<p>The following flow chart shows the work flow of listening mode state machine. <br />
 </p><div class="image">
<img src="Listening_Mode_State_Machine.png" alt="Listening_Mode_State_Machine.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Listening Mode State Machine</b></div></center><p> <br />
</p>
<p>For detail code flow ,please refer to following function. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_listening_state_machine(<a class="code" href="group___a_p_p___l_i_s_t_e_n_i_n_g___m_o_d_e.html#ga1f67a027bf5550cc90d38c8fd68cab76">T_ANC_APT_EVENT</a> event, <span class="keywordtype">bool</span> is_need_push_tone,</div><div class="line">                                 <span class="keywordtype">bool</span> is_need_update_final_state)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
