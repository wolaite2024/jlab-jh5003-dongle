<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="Sensor_HX3001_Manual"></a>
APP SENSOR HX3001 Module Application Note    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.1</b></center><p><br />
 </p><center><b>2023/07/12</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="Rws_App_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.1  </td><td class="markdownTableBodyCenter">2023/07/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#Rws_App_Rev">Revision History</a></li>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Table_List">Table List</a></li>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Figure_List">Figure List</a></li>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Glossary">Glossary</a> <br />
 + <a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Introduction">1 Introduction</a></li>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_McuConfigTool_Configuration">2 McuConfigTool Configuration</a></li>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Source_Code_Overview">3 Source Code Overview</a><ul>
<li><a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Source_Code_Init">3.1 Initialize sensor hx3001 settings</a> <br />
 - <a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Source_Code_HW_Timer">3.2 Handle hx3001 HW timer</a> <br />
 - <a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Source_Code_Handle_Msg">3.3 Handle hx3001 message</a> <br />
 - <a class="el" href="_a_n056__a_p_p__s_e_n_s_o_r__h_x3001__m_o_d_u_l_e.html#APP_SENSOR_HX3001_Module_Source_Code_Push_Event">3.4 Push hx3001 location event</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Table_List"></a>
Table List</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_2_1">Figure 2-1 Hx3001 Sensor enable</a></li>
<li><a href="#figure_2_2">Figure 2-2 Hx3001 Pin Setting</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Glossary"></a>
Glossary</h2>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Module_Introduction"></a>
1 Introduction</h2>
<p>The purpose of this document is to give an overview of the app sensor HX3001 module for customer. The document describes how to use app sensor HX3001 module in app project. The source code consists of <b>APP_SENSOR_HX3001</b> part. The details will be described in the following sections.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Module_McuConfigTool_Configuration"></a>
2 McuConfigTool Configuration</h2>
<p>Light detect sensor HX3001 can be enabled in "HW Feature" page.</p>
<div class="image">
<img src="mcuconfig_hx3001_enable.png" alt="mcuconfig_hx3001_enable.png" width="50%" height="50%"/>
</div>
 <center><div id="figure_2_1"><b>Figure 2-1 Hx3001 Sensor enable</b></div></center><p>Select light sensor detect and result pin.</p>
<div class="image">
<img src="mcuconfig_hx3001_pin_setting.png" alt="mcuconfig_hx3001_pin_setting.png" width="50%" height="50%"/>
</div>
 <center><div id="figure_2_2"><b>Figure 2-2 Hx3001 Pin Setting</b></div></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="APP_SENSOR_HX3001_Module_Source_Code_Overview"></a>
3 Source Code Overview</h2>
<p>This section describes app sensor hx300 module. The reference file is shown as follows:</p>
<ul>
<li>Project source code directory: sdk\src\mcu\sensor\ld_sensor\hx\sensor_hx.c This module is used to handle app sensor hx3001 message.</li>
</ul>
<h3><a class="anchor" id="APP_SENSOR_HX3001_Module_Source_Code_Init"></a>
3.1 Initialize sensor hx3001 settings</h3>
<p>source code directory: sdk/src/mcu/sensor/ld_sensor/hx/sensor_hx.c <br />
 Configure detect,result pin and hw timer settings.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> sensor_hx3001_init(T_HX_DEV *dev)</div><div class="line">{</div><div class="line">    memcpy((uint8_t *)&amp;hx_dev, (uint8_t *)dev, <span class="keyword">sizeof</span>(hx_dev));</div><div class="line"></div><div class="line">    <a class="code" href="group__x3e___p_i_n_m_u_x___exported___functions.html#ga3fea33489153eefe58ded1d645ddbfcc">Pad_SetPinDrivingCurrent</a>(hx_dev.detect_pin, <a class="code" href="group__x3e___p_a_d___d_r_i_v_i_n_g___c_u_r_r_e_n_t.html#ggac9fd7895616b89c74dd8f125f83d4690a32187f6279619afdb13e71151dd5ed0b">LEVEL3</a>);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga3826ae3324dab5d23192d2101f2cab3b">hal_gpio_init_pin</a>(hx_dev.detect_pin, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#gga18690463b43fb88963baf1098b54f075a4558e2fc1e35a2f4c0b285b06fda30fc">GPIO_TYPE_AON</a>, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#gga83e087b95bdbbc7626f48a407120b429a2faef38751d4761242d11663f4cf75e5">GPIO_DIR_OUTPUT</a>, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#ggac9b234191aefcbffa9f5cbfcb67ba911a30d0c1278ee190bdc8d66a3d95810728">GPIO_PULL_NONE</a>);</div><div class="line">    <a class="code" href="group__x3d___h_a_l___g_p_i_o___h__.html#ga3826ae3324dab5d23192d2101f2cab3b">hal_gpio_init_pin</a>(hx_dev.result_pin, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#gga18690463b43fb88963baf1098b54f075ad6bf32430a2b7af6721521d3e247f978">GPIO_TYPE_CORE</a>, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#gga83e087b95bdbbc7626f48a407120b429a3f9cca83af864e65a125bb363f5cc1a6">GPIO_DIR_INPUT</a>, <a class="code" href="group__x3e___h_a_l___g_p_i_o___h__.html#ggac9b234191aefcbffa9f5cbfcb67ba911a93970a9b4ab92816371682f4e537a8e2">GPIO_PULL_DOWN</a>);</div><div class="line"></div><div class="line">    hx3001_timer_handle = <a class="code" href="group___h_w___t_i_m___exported___functions.html#gaf99a867dfdd34bbeb67989388b6022c9">hw_timer_create</a>(<span class="stringliteral">&quot;hx3001_sensor_timer&quot;</span>, hx_dev.time_us, <span class="keyword">false</span>,</div><div class="line">                                          hx_dev.timer_cb);</div><div class="line">    <span class="keywordflow">if</span> (hx3001_timer_handle != <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___h_w___t_i_m___exported___functions.html#gabe5b3a8ad9f40ee8e25ba5c902ca82a2">hw_timer_lpm_set</a>(hx3001_timer_handle, <span class="keyword">true</span>);</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_HX3001_Module_Source_Code_HW_Timer"></a>
3.2 Handle hx3001 HW timer</h3>
<p>source code directory: sdk/src/mcu/sensor/mems_sensor/iqs/sensor_jsa.c <br />
 Handle hx3001 hw timer interrupt.</p>
<div class="fragment"><div class="line"><a class="code" href="group___s_e_c_t_i_o_n___exported___macros.html#gaf901ecfe15c401262a5dfd752a0b0287">ISR_TEXT_SECTION</a> <span class="keywordtype">void</span> app_sensor_ld_hx3001_isr_cb(<a class="code" href="group___h_w___t_i_m___exported___types.html#ga09f0eca4d24ba3eb999603118b8cab28">T_HW_TIMER_HANDLE</a> handle)</div><div class="line">{</div><div class="line">...</div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.sensor_ld_support)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.ld_sensor_vendor == SENSOR_VENDOR_HX)</div><div class="line">        {</div><div class="line">            <span class="keywordflow">switch</span> (hx3001_db.state)</div><div class="line">            {</div><div class="line">            <span class="keywordflow">case</span> HX_STATE_CHECK_IN_EAR:</div><div class="line">                {</div><div class="line">                    uint8_t status;</div><div class="line"></div><div class="line">                    <span class="comment">//Read detect result twice to make sure stable</span></div><div class="line">                    status = HX3001_LEVEL_EAR_MAP[sensor_hx3001_get_level()];</div><div class="line">                    <span class="keywordflow">if</span> (status == HX3001_LEVEL_EAR_MAP[sensor_hx3001_get_level()])</div><div class="line">                    {</div><div class="line">                        ...</div><div class="line">                        sensor_hx3001_hw_timer_restart(HX3001_DETECT_HW_US);</div><div class="line">                        ...</div><div class="line">                    }</div><div class="line">                    <span class="keywordflow">else</span></div><div class="line">                    {</div><div class="line">                        <span class="comment">//Detect result unstable: bypass and polling again</span></div><div class="line">                        <span class="comment">//Pull high light detect pin to disable light detect</span></div><div class="line">                        sensor_hx3001_light_off();</div><div class="line">                    }</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line"></div><div class="line">            <span class="keywordflow">case</span> HX_STATE_FILTER_HIGH_LIGHT:</div><div class="line">                {</div><div class="line">                    ...</div><div class="line">                    <span class="comment">//If detect result is high (in-ear) when light detect is disabled,</span></div><div class="line">                    <span class="comment">//this is treated as high light interference and the detect result should be filter out.</span></div><div class="line">                    uint8_t status;</div><div class="line"></div><div class="line">                    <span class="comment">//Read detect result twice to make sure stable</span></div><div class="line">                    status = HX3001_LEVEL_EAR_MAP[sensor_hx3001_get_level()];</div><div class="line"></div><div class="line">                        <span class="keywordflow">if</span> (hx3001_db.stable_count &gt;= HX3001_STABLE_COUNT)</div><div class="line">                        {</div><div class="line">                            <a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> gpio_msg;</div><div class="line"></div><div class="line">                            gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#acb5cfd209ba75c853d03f701e7f91679">type</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#gga468a59751cf5bb96e120b43fea01e074af11ba4096588dc277d9bd604f1007024">IO_MSG_TYPE_GPIO</a>;</div><div class="line">                            gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac5d9ab8403fb9ca24facc32b821dd53b">subtype</a> = <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10a3a499521c6d9eb11324ee2ebb639d6d4">IO_MSG_GPIO_SENSOR_LD</a>;</div><div class="line">                            gpio_msg.<a class="code" href="struct_t___i_o___m_s_g.html#ac3cb856d7e1befacacda7d89dbaabd13">u</a>.<a class="code" href="struct_t___i_o___m_s_g.html#aba18f3d521fde3af39c58b809a9c7ef0">param</a> = hx3001_db.cur_status;</div><div class="line">                            hx3001_db.pre_status = hx3001_db.cur_status;</div><div class="line">                            hx3001_db.poll = HX3001_POLL_NORMAL_MS;</div><div class="line">                            hx3001_db.stable_count = 0;</div><div class="line"></div><div class="line">                            <a class="code" href="group___a_p_p___i_o___m_s_g.html#ga88a966ae202533d382e23ae22b27b819">app_io_msg_send</a>(&amp;gpio_msg);</div><div class="line">                        }</div><div class="line">                    }</div><div class="line">                    ...</div><div class="line">                }</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line">...</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_HX3001_Module_Source_Code_Handle_Msg"></a>
3.3 Handle hx3001 message</h3>
<p>source code directory: sdk/src/sample/rws/app_io_msg.c <br />
 Handle io msg which is sent from hx3001 interrupt handler.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___i_o___m_s_g.html#gab3416cc2898ca3f036749335997d4841">app_io_handle_msg</a>(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> io_driver_msg_recv)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span> (msgtype)</div><div class="line">    {</div><div class="line">        ...</div><div class="line">        <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___m_s_g___exported___types.html#ggac53061b3924b56c44eacd7e43a711f10a3a499521c6d9eb11324ee2ebb639d6d4">IO_MSG_GPIO_SENSOR_LD</a>:</div><div class="line">                app_sensor_ld_handle_msg(&amp;io_driver_msg_recv);</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><p>source code directory: sdk/src/sample/rws/app_sensor_ld.c <br />
 Handle click msg from io msg and open debounce timer.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> app_sensor_ld_handle_msg(<a class="code" href="struct_t___i_o___m_s_g.html">T_IO_MSG</a> *io_driver_msg_recv)</div><div class="line">{</div><div class="line">    ...</div><div class="line">#<span class="keywordflow">if</span> <a class="code" href="group___a_p_p___f_l_a_g_s.html#gad11e925e4598933fb3a68c57a04cc67f">F_APP_SENSOR_HX3001_SUPPORT</a></div><div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group___a_p_p___c_f_g___exported___types.html#gae5da1e58b53e3ae552aafa6d26ade7a2">app_cfg_const</a>.ld_sensor_vendor == SENSOR_VENDOR_HX)</div><div class="line">    {</div><div class="line">        debounce = 1;</div><div class="line">    }</div><div class="line">    <span class="keywordflow">else</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line">    {</div><div class="line">        debounce = 500;</div><div class="line">    }</div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line">    app_sensor_ld_start_debounce_timer(debounce, status);</div><div class="line">    ...</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_ld_timeout_cb(uint8_t timer_evt, uint16_t param)</div><div class="line">{</div><div class="line">    <span class="keywordflow">case</span> APP_TIMER_LD_DEBOUNCE:</div><div class="line">    {</div><div class="line">        app_sensor_ld_debounce_handle();</div><div class="line">    }</div><div class="line">    <span class="keywordflow">break</span>;</div><div class="line">}</div></div><!-- fragment --><h3><a class="anchor" id="APP_SENSOR_HX3001_Module_Source_Code_Push_Event"></a>
3.4 Push hx3001 location event</h3>
<p>Push the final in ear and out ear to app. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_sensor_ld_debounce_handle(uint8_t status)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___m_a_i_n___exported___variables.html#gacfc09f2731e227125edccf8bcf944926">app_db</a>.<a class="code" href="struct_t___a_p_p___d_b.html#a267279067de70c37a6bcc24307b66822">local_in_ear</a> = (status == <a class="code" href="group___s_e_n_s_o_r___p_r_o_c_e_s_s___exported___macros.html#ga78236708eb2be523c415d855a07fe707">SENSOR_LD_IN_EAR</a>) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    app_bud_loc_cause_action_flag_set(cause_action);</div><div class="line">    app_sensor_ld_msg_send(status, CAUSE_ACTION_SENSOR_LD);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
