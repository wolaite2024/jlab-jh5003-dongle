<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="DSP_Cfg_Page"></a>
DSP Cfg Application Note    </h1>
<h2>Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
</table>
<h2>Contents</h2>
<ul>
<li><a class="el" href="_a_n010__d_s_p__c_f_g.html#DSP_CFG_Introduction">Introduction</a></li>
<li><a class="el" href="_a_n010__d_s_p__c_f_g.html#DSP_CFG_DATA">dsp cfg items</a></li>
</ul>
<h2><a class="anchor" id="DSP_CFG_Introduction"></a>
Introduction</h2>
<p>The purpose of this document is to introduce dsp cfg module. This document describes how to use dsp cfg module in app project. The source code consists of APP_DSP_CFG part. The details will be described in the following sections.</p>
<h2><a class="anchor" id="DSP_CFG_DATA"></a>
dsp cfg items</h2>
<p>The section decribes dsp cfg items. These items are configured by <b>dsp config tool</b>, and consist of structure:<b>T_APP_DSP_CFG_DATA</b>. It contains EQ and gain table params.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__app__dsp__cfg__data.html">t_app_dsp_cfg_data</a></div><div class="line">{</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a473a5df8f6a593bf2f4aafea5bdc1463">audio_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a4f57b02a387956794f5fd16cfd8e2e40">voice_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a22c2cc0962609d46cb607da6e5d30d36">voice_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a49008a8b4fa795417a795dc0670045dd">record_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a2942ad5ab91c64b28eed1128e77bbfba">aux_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#ad7289db0e264f7825a827a90af3cb568">aux_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#ae2843b89c2ca7a4ac6dd511bd5af8291">ringtone_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a4e800fe30a38ca8631b9944ee9673654">vp_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a5bcc79d0fe129c8e457637c3d79fa088">apt_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a246b6612eb230209c6ba612a43a620e7">apt_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a619857c5a1985b36b0b216f9a6e32067">llapt_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a5603b1bbd588de4dcc44bb578130361b">llapt_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a63698c04d91f7eae7121e4b025a05b51">anc_dac_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#a01dcb3a4b94d14760e7e9e77711383cb">anc_adc_gain_table</a>[16];</div><div class="line">    int16_t <a class="code" href="structt__app__dsp__cfg__data.html#ab9802d7f86451f87182111e46cb41401">vad_adc_gain_table</a>[16];</div><div class="line">    <a class="code" href="structt__app__dsp__param__r__only.html">T_APP_DSP_PARAM_R_ONLY</a> <a class="code" href="structt__app__dsp__cfg__data.html#aa5bba345524c100b784eb08cb522d1fa">dsp_cfg_header</a>;</div><div class="line">    <a class="code" href="structt__app__dsp__eq__param.html">T_APP_DSP_EQ_PARAM</a>     <a class="code" href="structt__app__dsp__cfg__data.html#ad0c540d75430dafd2adbc68897da1961">eq_param</a>;</div><div class="line">    <a class="code" href="structt__app__dsp__extensible__param.html">T_APP_DSP_EXTENSIBLE_PARAM</a> <a class="code" href="structt__app__dsp__cfg__data.html#a43b2035b83f124d820e0914ea615470a">dsp_extensible_param</a>;</div><div class="line">} <a class="code" href="structt__app__dsp__cfg__data.html">T_APP_DSP_CFG_DATA</a>;</div></div><!-- fragment --><p>These const items are loaded from flash in app_dsp_cfg_init, so the value of some item <b>SHOULD</b> be modified <b>AFTER</b> this function if user wants to change the existing value.</p>
<h3>Initialize app dsp cfg parameters</h3>
<p>APP will use this following API to load dsp cfg image header/eq_param/extensible_param/gain_table </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> app_dsp_cfg_init(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_dsp_cfg_load_header();</div><div class="line">    app_dsp_cfg_eq_param_load();</div><div class="line">    app_dsp_cfg_extensible_param_load();</div><div class="line">    app_dsp_cfg_gain_table_load();</div><div class="line">}</div></div><!-- fragment --><h3>Load dsp cfg image header</h3>
<p>The function will get dsp cfg image header, the structures <b>T_APP_DSP_PARAM_R_ONLY</b> params offset is fixed ,you <b>should not</b> modify it. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> app_dsp_cfg_load_header(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    app_dsp_cfg_data = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__cfg__data.html">T_APP_DSP_CFG_DATA</a>));</div><div class="line">    <span class="keywordflow">if</span> (app_dsp_cfg_data != <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>(<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412a20b15b2d2d20784016e57866e44fda1c">FLASH_IMG_DSPCONFIG</a>) + DSP_PARAM_OFFSET,</div><div class="line">                           &amp;app_dsp_cfg_data-&gt;<a class="code" href="structt__app__dsp__cfg__data.html#aa5bba345524c100b784eb08cb522d1fa">dsp_cfg_header</a>, <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__param__r__only.html">T_APP_DSP_PARAM_R_ONLY</a>));</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__app__dsp__param__r__only.html">t_app_dsp_param_r_only</a></div><div class="line">{</div><div class="line">    uint16_t <a class="code" href="structt__app__dsp__param__r__only.html#ab122d7b71839d22419e90a4875af3f43">sync_word</a>;</div><div class="line">    uint16_t <a class="code" href="structt__app__dsp__param__r__only.html#a6b89b86dfe0266be2fc46cf46f6e7b72">reserved1</a>;</div><div class="line">    uint32_t dsp_tool_version_info;</div><div class="line">    uint16_t <a class="code" href="structt__app__dsp__param__r__only.html#a08485ec80b34a6dca6561b8df20ded5c">user_version</a>;</div><div class="line">    uint16_t <a class="code" href="structt__app__dsp__param__r__only.html#a0fc429b055e74830a4583ec37f5c3846">reserved2</a>;</div><div class="line">    uint32_t algo_para_block_offset;</div><div class="line">    uint32_t <a class="code" href="structt__app__dsp__param__r__only.html#a749831eb4c326b3cd4bff55be0346e88">eq_cmd_block_offset</a>;</div><div class="line">    uint32_t fixed_param_block_offset;</div><div class="line">    uint32_t <a class="code" href="structt__app__dsp__param__r__only.html#a5e8534b32243d8028d50e80d3f770420">vad_param_block_offset</a>;</div><div class="line">    uint32_t <a class="code" href="structt__app__dsp__param__r__only.html#a3c2b7570fb4aed14468f69abe8c55c08">eq_extend_info_offset</a>;</div><div class="line">    uint32_t hw_eq_offset;</div><div class="line">    uint32_t <a class="code" href="structt__app__dsp__param__r__only.html#a9f04f0aaf67542c83b1eb764525e7d5b">extensible_param_offset</a>;</div><div class="line">    uint8_t  <a class="code" href="structt__app__dsp__param__r__only.html#a2f13145febf6046b78c982f6d4cf3394">reserved</a>[8];</div><div class="line">    uint32_t <a class="code" href="structt__app__dsp__param__r__only.html#a67ed620980708cdd42de420fcb854788">pacakge_features</a>; <span class="comment">//need check it in patch</span></div><div class="line">    <a class="code" href="struct_t___v_o_i_c_e___p_r_o_c___e_n_b.html">T_VOICE_PROC_ENB</a> <a class="code" href="structt__app__dsp__param__r__only.html#a90cfc7657e20c760cff4825dbbd33b82">voice_stream_feature_bit</a>;</div><div class="line">    <a class="code" href="struct_t___a_u_d_i_o___p_r_o_c___e_n_b.html">T_AUDIO_PROC_ENB</a> <a class="code" href="structt__app__dsp__param__r__only.html#a6a4aacb5fc1af5142e3258e5337fbb5c">audio_stream_feature_bit</a>;</div><div class="line">} <a class="code" href="structt__app__dsp__param__r__only.html">T_APP_DSP_PARAM_R_ONLY</a>;</div></div><!-- fragment --><h3>load eq parameters</h3>
<p>By the header, you can find the eq locaton in flash. this function will load eq param to the RAM. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> app_dsp_cfg_eq_param_load(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    uint32_t                   data_offset;</div><div class="line">    int32_t                    ret = 0;</div><div class="line">    <a class="code" href="structt__app__dsp__eq__param__header.html">T_APP_DSP_EQ_PARAM_HEADER</a>  *header;</div><div class="line">    <a class="code" href="structt__app__dsp__eq__spk__header.html">T_APP_DSP_EQ_SPK_HEADER</a>    *spk_header;</div><div class="line">    <a class="code" href="structt__app__dsp__eq__mic__header.html">T_APP_DSP_EQ_MIC_HEADER</a>    *mic_header;</div><div class="line">    uint32_t eq_spk_applications_num;</div><div class="line"></div><div class="line">    app_dsp_cfg_data-&gt;<a class="code" href="structt__app__dsp__cfg__data.html#ad0c540d75430dafd2adbc68897da1961">eq_param</a>.<a class="code" href="structt__app__dsp__eq__param.html#a0ee490c5116299fab57877f9ae183a23">header</a> = calloc(1, <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__eq__param__header.html">T_APP_DSP_EQ_PARAM_HEADER</a>));</div><div class="line">    header = app_dsp_cfg_data-&gt;<a class="code" href="structt__app__dsp__cfg__data.html#ad0c540d75430dafd2adbc68897da1961">eq_param</a>.<a class="code" href="structt__app__dsp__eq__param.html#a0ee490c5116299fab57877f9ae183a23">header</a>;</div><div class="line">    <span class="keywordflow">if</span> (header == <a class="code" href="group___platform___types___exported___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)</div><div class="line">    {</div><div class="line">        ret = 1;</div><div class="line">        <span class="keywordflow">goto</span> fail_alloc_eq_param_head;</div><div class="line">    }</div><div class="line"></div><div class="line">    data_offset = DSP_PARAM_OFFSET + app_dsp_cfg_data-&gt;<a class="code" href="structt__app__dsp__cfg__data.html#aa5bba345524c100b784eb08cb522d1fa">dsp_cfg_header</a>.<a class="code" href="structt__app__dsp__param__r__only.html#a749831eb4c326b3cd4bff55be0346e88">eq_cmd_block_offset</a>;</div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>(<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412a20b15b2d2d20784016e57866e44fda1c">FLASH_IMG_DSPCONFIG</a>) + data_offset,</div><div class="line">                       header, <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__eq__param__header.html">T_APP_DSP_EQ_PARAM_HEADER</a>) - 12);</div><div class="line">    .............</div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>(<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412a20b15b2d2d20784016e57866e44fda1c">FLASH_IMG_DSPCONFIG</a>) + data_offset,</div><div class="line">                       spk_header, header-&gt;eq_spk_applications_num * <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__eq__spk__header.html">T_APP_DSP_EQ_SPK_HEADER</a>));</div><div class="line">    .............</div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>(<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412a20b15b2d2d20784016e57866e44fda1c">FLASH_IMG_DSPCONFIG</a>) + data_offset,</div><div class="line">                       mic_header, header-&gt;eq_mic_applications_num * <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__eq__mic__header.html">T_APP_DSP_EQ_MIC_HEADER</a>));</div><div class="line">    .............</div><div class="line">    <a class="code" href="group___f_m_c___exported___flash___functions.html#ga3374cd4db74d705f4fa380cbb199ea4b">fmc_flash_nor_read</a>(<a class="code" href="group___f_m_c___exported___flash___functions.html#ga4c1c6e55533fff44d518cb18d5493ab6">flash_cur_bank_img_payload_addr_get</a>(<a class="code" href="group___f_m_c___t_y_p_e.html#ggaf6c9f3bf08cd9ee9a5fda26a73306412a20b15b2d2d20784016e57866e44fda1c">FLASH_IMG_DSPCONFIG</a>) + data_offset,</div><div class="line">                       header-&gt;sub_header, header-&gt;eq_cmd_num * <span class="keyword">sizeof</span>(<a class="code" href="structt__app__dsp__eq__sub__param__header.html">T_APP_DSP_EQ_SUB_PARAM_HEADER</a>));</div><div class="line">    .............</div><div class="line">}</div></div><!-- fragment --><h3>load extensible parameters</h3>
<p>By the header, you can find the extensible parameters locaton in flash. this function will load extensible param to the RAM. ~~~~~~~~~~~~~~~{.c} static bool app_dsp_cfg_extensible_param_load(void) { uint32_t data_offset; uint16_t index = 0; int32_t ret = 0; T_APP_DSP_EXTENSIBLE_PARAM *header;</p>
<p>header = (T_APP_DSP_EXTENSIBLE_PARAM *)(&amp;app_dsp_cfg_data-&gt;dsp_extensible_param); header-&gt;sync_word = 0;</p>
<p>if (app_dsp_cfg_data-&gt;dsp_cfg_header.extensible_param_offset == 0) { //for DSP configuration bin compatibility ret = 1; goto extensible_invalid_address; }</p>
<p>data_offset = DSP_PARAM_OFFSET + app_dsp_cfg_data-&gt;dsp_cfg_header.extensible_param_offset; fmc_flash_nor_read((flash_cur_bank_img_payload_addr_get(FLASH_IMG_DSPCONFIG) + data_offset), (uint8_t *)header, sizeof(header-&gt;sync_word) + sizeof(header-&gt;extensible_len)); ............. <br />
 fmc_flash_nor_read((flash_cur_bank_img_payload_addr_get(FLASH_IMG_DSPCONFIG) + data_offset), header-&gt;raw_data, header-&gt;extensible_len); ............. }</p>
<h3>load gain table</h3>
<p>By the header, you can find the gain table locaton in flash. this function will load gain table to the RAM. ~~~~~~~~~~~~~~~{.c} static void app_dsp_cfg_gain_table_load(void) { T_APP_DSP_GAIN_TABLE_BLOCK *block; int32_t ret = 0;</p>
<p>block = calloc(1, sizeof(T_APP_DSP_GAIN_TABLE_BLOCK)); if (block == NULL) { ret = 1; goto fail_calloc; }</p>
<p>app_dsp_cfg_load_param_r_data(block, app_dsp_cfg_data-&gt;dsp_cfg_header.gain_table_block_offset, sizeof(T_APP_DSP_GAIN_TABLE_BLOCK)); ............. <br />
} </p>
</div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
