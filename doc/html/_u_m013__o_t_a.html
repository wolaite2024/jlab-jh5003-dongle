<!-- HTML header for doxygen 1.8.14-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BT AUDIO SDK: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="customdoxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="bbpro-h55px.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BT AUDIO SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,true,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="contents">
<div class="textblock"><p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p>
<h1><a class="anchor" id="OTA_Page"></a>
OTA User Manual    </h1>
<p><br />
<br />
<br />
<br />
<br />
<br />
<br />
<br />
 </p><center><b>V1.2</b></center><p><br />
 </p><center><b>2023/06/05</b></center><div style="page-break-after: always;"></div><h2><a class="anchor" id="OTA_Rev"></a>
Revision History</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Version  </th><th class="markdownTableHeadCenter">Date  </th><th class="markdownTableHeadCenter">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.0.0.0  </td><td class="markdownTableBodyCenter">2021/10/21  </td><td class="markdownTableBodyCenter">Stable Release   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">V1.0.0.1  </td><td class="markdownTableBodyCenter">2023/04/12  </td><td class="markdownTableBodyCenter">Optimize content   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">V1.2  </td><td class="markdownTableBodyCenter">2023/06/05  </td><td class="markdownTableBodyCenter">Change version number to 2 digits   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2>Contents</h2>
<ul>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Rev">Revision History</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Table_List">Table List</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Figure_List">Figure List</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Glossary">Glossary</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTAIntro">1 OTA Introduction</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Flash_Layout">2 Flash Layout</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Dual_Bank">2.1 Dual Bank</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Bank_Switch_Check_Rules">2.2 Bank Switch Check Rules</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Flow">3 OTA Flow</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Dual_Bank_OTA_Mode">3.1 Dual Bank OTA Mode</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Dual_Bank_OTA_Mode_Flow">3.2 Dual Bank OTA Mode Flow</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Image_Data_Push">3.3 Image Data Push</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Buffer_Check">3.3.1 Buffer Check</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Encrypted_transmission">3.3.2 Encrypted transmission</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Image_Validation">3.3.3 Image Validation</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#Image_Skip_and_Copy">3.4 Image Skip and Copy</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Image_Skip">3.4.1 Image Skip</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Image_Copy">3.4.2 Image Copy</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#OTAIntro_OTAService">4 BLE OTA Service Introduction</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#OTAService_OTA_Service">4.1 OTA Service</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTAService_DFU_Service">4.2 DFU Service</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#SPP_Introduction">5 SPP OTA CMD and EVENT Introduction</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Detailed_OTA_Flow">6 Detailed OTA Flow</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#HowToPortingCode">7 How to Port Code</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Copy_Flies">7.1 Copy files</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#BLE_Porting">7.2 BLE Service Porting Guide</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Register_OTA_Service">7.2.1 Register OTA Service</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Update_UUID">7.2.2 Update UUID</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#OTA_Callback">7.2.3 Add process to the callback function</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Add_New_Service">7.2.4 Add new service and characteristic</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Handle_Operations">7.2.5 Handle the Write and Read Operations from controller</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Add_New_BLE_Handle">7.2.6 Add new BLE control point handle BLE to this function</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#Porting_Guide">7.3 SPP OTA Porting guide</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#SPP_Code">7.3.1 Add SPP OTA command and event ID to the ID tables</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#SPP_CMD_Handle">7.3.2 Add SPP command handle function to the spp data entrance</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#SPP_ACK_Handle">7.3.3 Add SPP ACK handle function to the spp data entrance</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#ADD_SPP_CMD">7.3.4 Add new SPP command handle to this function</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#Sync_Message">7.4 Sync message between two buds</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#HowToUseTool">8 How to Use Tool</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Prepare_images">8.1 Prepare the image to update</a><ul>
<li><a class="el" href="_u_m013__o_t_a.html#Generate_OTA_Header">8.1.1 Generate OTA Header</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Pack_Whole_Image">8.1.2 Pack whole Image</a></li>
</ul>
</li>
<li><a class="el" href="_u_m013__o_t_a.html#IOS_OTA">8.2 IOS OTA Tool User Guide</a></li>
<li><a class="el" href="_u_m013__o_t_a.html#Android_OTA">8.3 Android OTA Tool User Guide</a></li>
</ul>
</li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="OTA_Table_List"></a>
Table List</h2>
<ul>
<li><a href="#table_2_1">Table 2-1 Bank Switch Example 1</a></li>
<li><a href="#table_2_2">Table 2-2 Bank Switch Example 2</a></li>
<li><a href="#table_3_1">Table 3-1 OTA Service UUID</a></li>
<li><a href="#table_3_2">Table 3-2 OTA Service Characteristics</a></li>
<li><a href="#table_3_3">Table 3-3 DFU Service UUID</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="OTA_Figure_List"></a>
Figure List</h2>
<ul>
<li><a href="#figure_3_1">Figure 3-1 Flow Of Single OTA</a></li>
<li><a href="#figure_3_2">Figure 3-2 Skip and Copy Flow</a></li>
<li><a href="#figure_6_1">Figure 6-1 FDetailed Flow Via SPP</a></li>
<li><a href="#figure_8_1">Figure 8-1 MP Programing Tool</a></li>
<li><a href="#figure_8_2">Figure 8-2 Generate OTA Header</a></li>
<li><a href="#figure_8_3">Figure 8-3 Pack Whole Image</a></li>
<li><a href="#figure_8_4">Figure 8-4 Enable RTK App advertising</a></li>
<li><a href="#figure_8_5">Figure 8-5 Trigger BLE adv1</a></li>
<li><a href="#figure_8_6">Figure 8-6 Trigger BLE adv2</a></li>
<li><a href="#figure_8_7">Figure 8-7 IOS Select Device</a></li>
<li><a href="#figure_8_8">Figure 8-8 IOS Device Information</a></li>
<li><a href="#figure_8_9">Figure 8-9 IOS Select Firmware</a></li>
<li><a href="#figure_8_10">Figure 8-10 IOS Firmware Version</a></li>
<li><a href="#figure_8_11">Figure 8-11 IOS Updating Progress</a></li>
<li><a href="#figure_8_12">Figure 8-12 Android Select Device</a></li>
<li><a href="#figure_8_13">Figure 8-13 Android Device Information</a></li>
<li><a href="#figure_8_14">Figure 8-14 Android Select Firmware</a></li>
<li><a href="#figure_8_15">Figure 8-15 Android Firmware Version</a></li>
<li><a href="#figure_8_16">Figure 8-16 Android Updating Progress</a></li>
</ul>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="OTA_Glossary"></a>
Glossary</h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Terms  </th><th class="markdownTableHeadCenter">Definitions   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">OTA  </td><td class="markdownTableBodyCenter">Over The Air   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="OTAIntro"></a>
1 OTA Introduction</h2>
<p>OTA (Over The Air) represents the technology that applies Bluetooth to update image (code and data) that runs in Flash. SDK supports two OTA modes for Android and IOS: OTA via BLE(IOS/Android) and OTA via SPP(Android). As shown in <a class="el" href="_u_m007__f_l_a_s_h.html#FLASH">Flash User Guide </a>, there are two bank areas allocated (bank0 and bank1) to save the images. But only one bank is active at a time. The images in the two banks will be authenticated when the soc boots up. If images in both banks are all legal, the bank with the larger version(ver_val or git_ver)(refer to <a class="el" href="_u_m008__i_m_a_g_e__l_a_y_o_u_t.html#IMAGE_LAYOUT">Image Layout User Guide </a>) will be selected to run in. The versions of images in two banks will be compared as a specific sequence until the versions of a certain image are different. If only one bank images are all legal, then this bank will be selected to run. For OTA, all the images in two banks should be packed together, and the OTA tool will select the images to transfer to inactive bank automatically. This application note describes OTA related information. The following topics are included to help users to establish OTA environment.</p>
<ul>
<li>Flash Layout</li>
<li>OTA Flow</li>
<li>BLE OTA Service Introduction</li>
<li>SPP OTA CMD and EVENT Introduction</li>
<li>Detailed OTA Flow</li>
<li>How to Port Code</li>
<li>How to Use Tool <div style="page-break-after: always;"></div></li>
</ul>
<h2><a class="anchor" id="Flash_Layout"></a>
2 Flash Layout</h2>
<p>The flash layout of the chip can be modified according to the user requirement, which is affected by the flash size and affect OTA policy. The layout information is stored in the system configuration image (OEM) and OTA Header image. Please refer to SDK Document (<a class="el" href="_u_m008__i_m_a_g_e__l_a_y_o_u_t.html#IMAGE_LAYOUT">Image Layout User Guide </a> and <a class="el" href="_u_m007__f_l_a_s_h.html#FLASH">Flash User Guide </a>) to get more detailed information. User can view flash_map.ini, images in front of OTA bank cannot be upgraded. </p>
<h3><a class="anchor" id="Dual_Bank"></a>
2.1 Dual Bank</h3>
<p>Two bank areas (bank0 and bank1) can be allocated to save images. But only one bank is active at a time, the other one is a backup. SOC will decide which bank is active when booting as certain rules. </p>
<h3><a class="anchor" id="Bank_Switch_Check_Rules"></a>
2.2 Bank Switch Check Rules</h3>
<p>The bootloader authenticates the bank with a higher image version first. If all the images in this bank are authenticated successfully, this bank will be activated. Otherwise, the other bank will be turned to do authentication. If both banks are authenticated fail, the MCU will boot fail and can not be recovered by OTA. The bootloader compares the versions of images in the following sequence until finding out one bank with a higher image version, and the sequence is determined by the importance of MCU running:</p>
<p>87X3E: OTA Header image &gt; FSBL image &gt; MCU APP image &gt; DSP system image &gt; DSP APP image &gt; APP Data image &gt; DSP Data image &gt; ANC Image &gt; SYS Patch image &gt; Stack Patch image.</p>
<p>87X3D: OTA Header image &gt; FSBL image &gt; ROM Patch image &gt; MCU APP image &gt; DSP system image &gt; DSP APP image &gt; APP Data image &gt; DSP Data image &gt; ANC Image &gt; DSP2 system image &gt; DSP2 APP image &gt; DSP3 image.</p>
<p>For Example:</p>
<p>1 Assume the version of the OTA Header image in two banks are same, and the version of the FSBL image of bank1 is higher than bank0, so bank1 will be selected to do authentication first.</p>
<center><div id="table_2_1"><b>Table 2-1 Bank Switch Example 1</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Bank Name  </th><th class="markdownTableHeadNone">Image Version  </th><th class="markdownTableHeadNone">Result   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><div style="width:200px">Bank0</div>  </td><td class="markdownTableBodyNone"><div style="width:450px">OTA Header(version: 0.0.0.1), FSBL(verison:0.0.0.2), <br />
Other images</div>  </td><td class="markdownTableBodyNone"><div style="width:350px">Bank1 will be selected first regardless <br />
other images.</div>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Bank1  </td><td class="markdownTableBodyNone">OTA Header(version: 0.0.0.1), FSBL(verison:0.0.0.3), <br />
Other images  </td><td class="markdownTableBodyNone"></td></tr>
</table>
<p>2 Assume the version of the OTA Header image of bank0 is higher than bank1, so bank0 will be selected to do authentication first. </p><center><div id="table_2_2"><b>Table 2-2 Bank Switch Example 2</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Bank Name  </th><th class="markdownTableHeadNone">Image Version  </th><th class="markdownTableHeadNone">Result   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><div style="width:200px">Bank0</div>  </td><td class="markdownTableBodyNone"><div style="width:450px">OTA Header(version: 0.0.0.2), Other images</div>  </td><td class="markdownTableBodyNone"><div style="width:350px">Bank0 will be selected first regardless <br />
other images.</div>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Bank1  </td><td class="markdownTableBodyNone">OTA Header(version: 0.0.0.1), Other images  </td><td class="markdownTableBodyNone"></td></tr>
</table>
<div style="page-break-after: always;"></div> <h2><a class="anchor" id="OTA_Flow"></a>
3 OTA Flow</h2>
<h3><a class="anchor" id="Dual_Bank_OTA_Mode"></a>
3.1 Dual Bank OTA Mode</h3>
<p>Images pushed by the OTA tool will always be saved in the inactive bank in OTA progress. The MCU will reboot after all images have been pushed and validated successfully. The advantage of Dual Bank OTA is that there is always a backup bank. Users do not need to worry about MCU crashing if OTA fails. Because the bank with all legal images and higher versions will be selected to be actived by the bootloader, the upgraded images should have a higher version and be integrated. Otherwise, the images will not be activated when the chip reboots. Users should ensure images in the inactive bank are integrated and with a higher version.</p>
<h3><a class="anchor" id="Dual_Bank_OTA_Mode_Flow"></a>
3.2 Dual Bank OTA Mode Flow</h3>
<p>The dual bank OTA flow is shown in the following chart. </p><div class="image">
<img src="Flow_Of_BLE_OTA.png" alt="Flow_Of_BLE_OTA.png"/>
</div>
 <center><div id="figure_3_1"><b>Figure 3-1 Flow Of Single OTA</b></div></center><div style="page-break-after: always;"></div><h3><a class="anchor" id="Image_Data_Push"></a>
3.3 Image Data Push</h3>
<p>In the progress of pushing one image from the OTA Tool to the headset, we designed the following mechanism to make sure correctness.</p>
<h4><a class="anchor" id="Buffer_Check"></a>
3.3.1 Buffer Check</h4>
<p>This function can be considered as a simple moving-window detection method. OTA tool calculates the CRC of every N-bytes payload and sends this checksum value to MCU after pushing these data to MCU. 1 The size of the N-bytes payload is negotiated by MCU and OTA tool before OTA starts. 2 MCU saves this N-bytes payload in one temp buffer first, then calculates the data checksum and compares it with the checksum value received from the OTA tool. 3 If the checksum value is equal, MCU saves these data to the inactive bank. If the checksum value is different, MCU discards these data and notifies the tool. The tool will retransmit these payload data. This function is default enabled. It can detect transmission errors as early as possible.</p>
<h4><a class="anchor" id="Encrypted_transmission"></a>
3.3.2 Encrypted transmission</h4>
<p>The OTA tool and MCU support encrypted transmission which is set by configure tool. One algorithm (AES256) is supported currently. The OTA tool encrypts every N-bytes payload before being pushed to MCU. When buffer check is enabled, the N-bytes payload will be encrypted together. When buffer check is disabled, every packet will be encrypted separately before pushed to MCU. MCU decrypts the data before it saving to Flash.</p>
<h4><a class="anchor" id="Image_Validation"></a>
3.3.3 Image Validation</h4>
<p>When an image is pushed to SOC completely, the OTA tool will send the command to make MCU validate the whole image. The checksum value (SHA256 or CRC) will be calculated and filled in the image header when the image is generated. MCU calculates the checksum value and compares it with the value in the image header. If the two values are different, it will notify the OTA tool, and the OTA progress will be considered as fail and be terminated.</p>
<h3><a class="anchor" id="Image_Skip_and_Copy"></a>
3.4 Image Skip and Copy</h3>
<p>As mentioned above, to avoid image mismatches and omitted, packing whole images is mandatory. To improve upgrade efficiency, some mechanism is designed to avoid unnecessary image transmission. At the beginning of OTA progress, the OTA tool will query versions and checksums of all the images (including both banks) of the headset. </p><div class="image">
<img src="Skip_and_Copy_Flow.png" alt="Skip_and_Copy_Flow.png"/>
</div>
 <center><div id="figure_3_2"><b>Figure 3-2 Skip and Copy Flow</b></div></center><h4><a class="anchor" id="Image_Skip"></a>
3.4.1  Image Skip</h4>
<p>The tool will compare each image version and SHA256 with SOC inactive bank image. If both version and SHA256 value are the same, the tool regards the image as already existing in the inactive bank. The tool will send a command to validate this image directly, and then SOC checks the validation and integration of this image in the inactive bank. 1 If validation success, this image will be skipped to transfer. 2 If validation failed, some images can go to the Image Copy (Chapter 3.2.2) flow.</p>
<h4><a class="anchor" id="Image_Copy"></a>
3.4.2 Image Copy</h4>
<p>For some address-independent images (For example, DSP sys image, DSP app image, App configure image, DSP configure image, and ANC configure image), the image copy mechanism may also increase OTA efficiency. The tool compares the address-independent images version and SHA256 with the headset active bank image. If both version and SHA256 value are the same, the tool will send the copy image command to the headset, and SOC copies this image from the active bank to the inactive bank, then validates the image. If copy and validate success, this image can also be skipped to transfer. If both the Image Skip and Image Copy methods fail, the tool will run the normal Image Data Push transfer flow.</p>
<h4>3.5 Reset and version Re-check</h4>
<p>When all the images are pushed, copied, or skipped, the OTA tool will trigger MCU active and reset. And MCU will reboot to select a new active bank to activate the upgraded images. OTA tool will try to reconnect MCU, and query versions of all the images in the currently active bank to check whether OTA takes effect.</p>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="OTAIntro_OTAService"></a>
4 BLE OTA Service Introduction</h2>
<p>OTA attribute table is a C array defined in ota_service.c, which is used to declare two OTA-related services: OTA Service and DFU Service. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct_t___a_t_t_r_i_b___a_p_p_l.html">T_ATTRIB_APPL</a> <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___constants.html#ga55d8852b190bf661697dd487f324d0cf">gatt_extended_service_table</a>[] = {...};</div></div><!-- fragment --><h3><a class="anchor" id="OTAService_OTA_Service"></a>
4.1 OTA Service</h3>
<p>OTA service is used to acquire device information or enter OTA Mode. Service UUID used in OTA Demo are defined in the following Table.</p>
<center><div id="table_3_1"><b>Table 3-1 OTA Service UUID</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Service Name  </th><th class="markdownTableHeadLeft">Service UUID   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><div style="width:200px">OTA Service</div>  </td><td class="markdownTableBodyLeft">0x12, 0xA2, 0x4D, 0x2E, 0xFE, 0x14, 0x48, 0x8e, 0x93, 0xD2, 0x17, 0x3C, 0xFF, 0xD0, 0x00, 0x00   </td></tr>
</table>
<p>The characteristics are shown in the following Table. </p><center><div id="table_3_2"><b>Table 3-2 OTA Service Characteristics</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Characteristic Name  </th><th class="markdownTableHeadCenter">Requirement  </th><th class="markdownTableHeadCenter">Characteristic UUID  </th><th class="markdownTableHeadLeft">Properties   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Enter OTA Mode  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFD1  </td><td class="markdownTableBodyLeft">WriteWithoutResponse   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">BD Address  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFD2  </td><td class="markdownTableBodyLeft">Read   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Device Information  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFF1  </td><td class="markdownTableBodyLeft">Read   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Image Version  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFE0 ~ 0XFFEF  </td><td class="markdownTableBodyLeft">Read   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Protocol Type  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFE3  </td><td class="markdownTableBodyLeft">Read   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Image Section Size  </td><td class="markdownTableBodyCenter">M  </td><td class="markdownTableBodyCenter">0xFFF4~FFF6  </td><td class="markdownTableBodyLeft">Read   </td></tr>
</table>
<h3><a class="anchor" id="OTAService_DFU_Service"></a>
4.2 DFU Service</h3>
<p>DFU service is used to do the updating process. Service UUID used in OTA Demo are defined in the following Table. </p><center><div id="table_3_3"><b>Table 3-3 DFU Service UUID</b></div></center> <table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Service Name  </th><th class="markdownTableHeadLeft">Service UUID   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><div style="width:200px">DFU Service</div>  </td><td class="markdownTableBodyLeft">0x12, 0xA2, 0x4D, 0x2E, 0xFE, 0x14, 0x48, 0x8e, 0x93, 0xD2, 0x17, 0x3C, 0x87, 0x62, 0x00, 0x00   </td></tr>
</table>
<p><br />
The characteristics are shown in the following Table. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Characteristic Name  </th><th class="markdownTableHeadLeft">Requirement  </th><th class="markdownTableHeadLeft">Characteristic UUID  </th><th class="markdownTableHeadLeft">Properties   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">DFU Data  </td><td class="markdownTableBodyLeft">M  </td><td class="markdownTableBodyLeft">0x8763  </td><td class="markdownTableBodyLeft">WriteWithoutResponse   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">DFU Control Point  </td><td class="markdownTableBodyLeft">M  </td><td class="markdownTableBodyLeft">0x8764  </td><td class="markdownTableBodyLeft">Write, Notify   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="SPP_Introduction"></a>
5 SPP OTA CMD and EVENT Introduction</h2>
<p><br />
The CMD is from controller to target and the event is from target to controller. All OTA CMD and EVENT are shown in the following Table. </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">CMD NAME  </th><th class="markdownTableHeadLeft">CMD ID  </th><th class="markdownTableHeadLeft">EVENT NAME  </th><th class="markdownTableHeadLeft">EVENT ID  </th><th class="markdownTableHeadLeft">Description   </th></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft"><div style="width:200px">CMD_OTA_DEV_INFO</div>  </td><td class="markdownTableBodyLeft"><div style="width:100px">0x0600</div>  </td><td class="markdownTableBodyLeft"><div style="width:200px">EVENT_OTA_DEV_INFO</div>  </td><td class="markdownTableBodyLeft"><div style="width:120px">0x0600</div>  </td><td class="markdownTableBodyLeft"><div style="width:380px">get device info of target</div>   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_ACTIVE_BANK_VER  </td><td class="markdownTableBodyLeft">0x0601  </td><td class="markdownTableBodyLeft">EVENT_OTA_GET_IMG_VER  </td><td class="markdownTableBodyLeft">0x0601  </td><td class="markdownTableBodyLeft">get image version of target   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_START  </td><td class="markdownTableBodyLeft">0x0602  </td><td class="markdownTableBodyLeft">EVENT_OTA_START  </td><td class="markdownTableBodyLeft">0x0602  </td><td class="markdownTableBodyLeft">start OTA and transfer header   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_PACKET  </td><td class="markdownTableBodyLeft">0x0603  </td><td class="markdownTableBodyLeft">EVENT_OTA_PACKET  </td><td class="markdownTableBodyLeft">0x0603  </td><td class="markdownTableBodyLeft">transfer data packet   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_VALID  </td><td class="markdownTableBodyLeft">0x0604  </td><td class="markdownTableBodyLeft">EVENT_OTA_VALID  </td><td class="markdownTableBodyLeft">0x0604  </td><td class="markdownTableBodyLeft">valid the received image   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_RESET  </td><td class="markdownTableBodyLeft">0x0605  </td><td class="markdownTableBodyLeft">NONE  </td><td class="markdownTableBodyLeft">NONE  </td><td class="markdownTableBodyLeft">stop ota flow and reset parameters   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_ACTIVE_RESET  </td><td class="markdownTableBodyLeft">0x0606  </td><td class="markdownTableBodyLeft">EVENT_OTA_ACTIVE_ACK  </td><td class="markdownTableBodyLeft">0x060B  </td><td class="markdownTableBodyLeft">reset to active new image   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_BUFFER_CHECK_ENABLE  </td><td class="markdownTableBodyLeft">0x0607  </td><td class="markdownTableBodyLeft">EVENT_OTA_BUFFER_CHECK_ENABLE  </td><td class="markdownTableBodyLeft">0x0605  </td><td class="markdownTableBodyLeft">enable buffer check   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_BUFFER_CHECK  </td><td class="markdownTableBodyLeft">0x0608  </td><td class="markdownTableBodyLeft">EVENT_OTA_BUFFER_CHECK  </td><td class="markdownTableBodyLeft">0x0606  </td><td class="markdownTableBodyLeft">transfer crc value and start check   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_IMG_INFO  </td><td class="markdownTableBodyLeft">0x0609  </td><td class="markdownTableBodyLeft">EVENT_OTA_IMG_INFO  </td><td class="markdownTableBodyLeft">0x0607  </td><td class="markdownTableBodyLeft">get image info of target   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_SECTION_SIZE  </td><td class="markdownTableBodyLeft">0x060A  </td><td class="markdownTableBodyLeft">EVENT_OTA_SECTION_SIZE  </td><td class="markdownTableBodyLeft">0x0608  </td><td class="markdownTableBodyLeft">get layout size of image in active bank   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_DEV_EXTRA_INFO  </td><td class="markdownTableBodyLeft">0x060B  </td><td class="markdownTableBodyLeft">EVENT_OTA_DEV_EXTRA_INFO  </td><td class="markdownTableBodyLeft">0x0609  </td><td class="markdownTableBodyLeft">get extra info of target   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_PROTOCOL_TYPE  </td><td class="markdownTableBodyLeft">0x060C  </td><td class="markdownTableBodyLeft">EVENT_OTA_PROTOCOL_TYPE  </td><td class="markdownTableBodyLeft">0x060A  </td><td class="markdownTableBodyLeft">get protocol type   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_GET_RELEASE_VER  </td><td class="markdownTableBodyLeft">0x060D  </td><td class="markdownTableBodyLeft">EVENT_OTA_GET_RELEASE_VER  </td><td class="markdownTableBodyLeft">0x060C  </td><td class="markdownTableBodyLeft">get the release version of app_config bin   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_INACTIVE_BANK_VER  </td><td class="markdownTableBodyLeft">0x060E  </td><td class="markdownTableBodyLeft">EVENT_OTA_INACTIVE_BANK_VER  </td><td class="markdownTableBodyLeft">0x060D  </td><td class="markdownTableBodyLeft">get inactive bank image version   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowEven">
<td class="markdownTableBodyLeft">CMD_OTA_COPY_IMG  </td><td class="markdownTableBodyLeft">0x060F  </td><td class="markdownTableBodyLeft">EVENT_OTA_COPY_IMG  </td><td class="markdownTableBodyLeft">0x060E  </td><td class="markdownTableBodyLeft">copy image from active bank to inactive bank   </td></tr>
<tr class="markdownTableBody" class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">CMD_OTA_CHECK_SHA256  </td><td class="markdownTableBodyLeft">0x0610  </td><td class="markdownTableBodyLeft">EVENT_OTA_CHECK_SHA256  </td><td class="markdownTableBodyLeft">0x060F  </td><td class="markdownTableBodyLeft">check the field of sha256   </td></tr>
</table>
<div style="page-break-after: always;"></div><h2><a class="anchor" id="Detailed_OTA_Flow"></a>
6 Detailed OTA Flow</h2>
<p>The detailed flow via SPP is showed in the following chart. The flow via BLE is very similar to this. </p><div class="image">
<img src="Detailed_Flow_Via_SPP.png" alt="Detailed_Flow_Via_SPP.png"/>
</div>
 <center><div id="figure_6_1"><b>Figure 6-1 Detailed Flow Via SPP</b></div></center> <div style="page-break-after: always;"></div><h2><a class="anchor" id="HowToPortingCode"></a>
7 How to Port Code</h2>
<h3><a class="anchor" id="Copy_Flies"></a>
7.1 Copy files</h3>
<p>Copy files (ota_service.c/h) to the directory of your project Directory: ota_service.c: sdk/src/ble/profile/server <a class="el" href="ota__service_8h_source.html" title="Head file for using OTA service. ">ota_service.h</a>: sdk/inc/bluetooth/profile/server</p>
<p>Copy files(app_ota.c/h) to the directory of your project Directory: sdk/src/sample/ota_demo </p>
<h3><a class="anchor" id="BLE_Porting"></a>
7.2 BLE Service Porting Guide</h3>
<h4><a class="anchor" id="Register_OTA_Service"></a>
7.2.1 Register OTA Service</h4>
<p>Register OTA service in the initialization process and increase the server number of <a class="el" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b" title="Initialize parameters of GATT Server. ">server_init()</a> </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___b_l_e___s_e_r_v_i_c_e___exported___functions.html#ga721aeeec02f1c42a4d1f9558688cbf2a">app_ble_service_init</a>(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___functions.html#ga69f3a8c88a1c2d5255f87e69e135311b">server_init</a>(...);</div><div class="line">    <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___functions.html#ga268c37e35bb34b56ed9d284c647bde6a">ota_add_service</a>(audio_app_ota_srv_cb);</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="Update_UUID"></a>
7.2.2 Update UUID</h4>
<p>Re-generate 128-bit UUID of OTA service by generator tool, and fill it to GATT_UUID_OTA_SERVICE[16]. Also, update the UUID at iOS/Android Controller. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___constants.html#gad4451e2dae0321c60caf69a4fd8d7d49">GATT_UUID_OTA_SERVICE</a>[16] = {...};</div></div><!-- fragment --><h4><a class="anchor" id="OTA_Callback"></a>
7.2.3 Add process to the callback function</h4>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> audio_app_ota_srv_cb(<a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id, <span class="keywordtype">void</span> *p_data)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="Add_New_Service"></a>
7.2.4 Add new service and characteristic</h4>
<p>The OTA attribute table defined in ota_service.c is used to declare the two OTA-related services, you can add services and characteristics here. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="struct_t___a_t_t_r_i_b___a_p_p_l.html">T_ATTRIB_APPL</a> <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___constants.html#ga55d8852b190bf661697dd487f324d0cf">gatt_extended_service_table</a>[] = {...};</div></div><!-- fragment --><h4><a class="anchor" id="Handle_Operations"></a>
7.2.5 Handle the Write and Read Operations from controller</h4>
<p>If you add a new service or characteristic to the attribute table, you can handle it in the following two functions. </p><div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___functions.html#gaa0b591ba9dfbbc6f70769ef8bc97b4a8">ota_service_attr_write_cb</a>(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id,</div><div class="line">                                              uint16_t attr_index, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#ga07c105220cd4d1b097c670b9d2841114">T_WRITE_TYPE</a> write_type, uint16_t length,</div><div class="line">                                              uint8_t *p_value, <a class="code" href="group___p___f_u_n___w_r_i_t_e___i_n_d___p_o_s_t___p_r_o_c.html#gad0a0809497ada580e7025f1bff8ea913">P_FUN_WRITE_IND_POST_PROC</a> *p_write_ind_post_proc)</div></div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> <a class="code" href="group___o_t_a___s_e_r_v_i_c_e___exported___functions.html#gad45991cf34ca697984764594bd948a75">ota_service_attr_read_cb</a>(uint8_t conn_id, <a class="code" href="group___g_a_t_t___s_e_r_v_e_r___c_o_m_m_o_n___exported___types.html#gada7cb21908790f5a0751f80b733f5287">T_SERVER_ID</a> service_id,</div><div class="line">                                             uint16_t attr_index,</div><div class="line">                                             uint16_t offset, uint16_t *p_length, uint8_t **pp_value)</div></div><!-- fragment --><h4><a class="anchor" id="Add_New_BLE_Handle"></a>
7.2.6 Add new BLE control point handle BLE to this function</h4>
<div class="fragment"><div class="line"><a class="code" href="group___g_a_p___common___exported___types.html#ga90b0c39404615bbdf0fc222483ed3fb9">T_APP_RESULT</a> <a class="code" href="group___a_p_p___o_t_a___s_e_r_v_i_c_e___exported___functions.html#ga72d3f482d0e84e4e526557a545de72a0">app_ota_ble_handle_cp_req</a>(uint8_t conn_id, uint16_t length, uint8_t *p_value)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> <h3><a class="anchor" id="Porting_Guide"></a>
7.3 SPP OTA Porting guide</h3>
<h4><a class="anchor" id="SPP_Code"></a>
7.3.1 Add SPP OTA command and event ID to the ID tables</h4>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a0d780a1e57a6e42f19c0bef6bbf53a96">EVENT_OTA_DEV_INFO</a> = 0x0600,</div><div class="line">    EVENT_OTA_GET_IMG_VER,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7ac163720f5972d102eeb9c24efc401ba2">EVENT_OTA_START</a>,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a9fed8dd3d4d8e1803491757502da832c">EVENT_OTA_PACKET</a>,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a2b15052b14f5733fa8ae1e577003c122">EVENT_OTA_VALID</a>,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7ac81b39d7bbbad6d3ed1d74dfe2df79d6">EVENT_OTA_BUFFER_CHECK_ENABLE</a>,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a70ef6ceefc11161f220ac25ba5ab7c42">EVENT_OTA_BUFFER_CHECK</a>,</div><div class="line">    <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a7b024aba44f6451ea717bfba6e2f3adf">EVENT_OTA_IMG_INFO</a>,</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></div><div class="line">{</div><div class="line">    ...</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cb15fca5776a80f9251e86fd20523b3">CMD_OTA_DEV_INFO</a> = 0x0600,</div><div class="line">    CMD_OTA_GET_IMG_VER,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a9ec5978f9ee74f28d42ff95a9cd26803">CMD_OTA_START</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157aac6fcc64e8e7dab4db490e52bb17c8c2">CMD_OTA_PACKET</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cbca8c84cf870c468ee7f7905c7c7ea">CMD_OTA_VALID</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a20c27fc92afbae371c109d1ffa21fe98">CMD_OTA_RESET</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a76f9d30e57f1c1c5c6b93e7f0835b69f">CMD_OTA_ACTIVE_RESET</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cec88d14c9e56501fec6839a19ed0b3">CMD_OTA_BUFFER_CHECK_ENABLE</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157ad6cb8e14c28145118b574848cf99bd03">CMD_OTA_BUFFER_CHECK</a>,</div><div class="line">    <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a95dc40f45e868deaeeeba8054ea8d931">CMD_OTA_IMG_INFO</a>,</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="SPP_CMD_Handle"></a>
7.3.2 Add SPP command handle function to the spp data entrance</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_m_d___exported___functions.html#gae6e146af6a4381218d925b2dc90433e8">app_cmd_handler</a>(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t rx_seqn,</div><div class="line">                     uint8_t app_idx)</div><div class="line">{</div><div class="line">    <span class="keywordflow">switch</span> (cmd_id)</div><div class="line">    {</div><div class="line">        ...</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cb15fca5776a80f9251e86fd20523b3">CMD_OTA_DEV_INFO</a> :</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a886262a1f8e778d13f92964a597709b4">CMD_OTA_ACTIVE_BANK_VER</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a9ec5978f9ee74f28d42ff95a9cd26803">CMD_OTA_START</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157aac6fcc64e8e7dab4db490e52bb17c8c2">CMD_OTA_PACKET</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cbca8c84cf870c468ee7f7905c7c7ea">CMD_OTA_VALID</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a20c27fc92afbae371c109d1ffa21fe98">CMD_OTA_RESET</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a76f9d30e57f1c1c5c6b93e7f0835b69f">CMD_OTA_ACTIVE_RESET</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a7cec88d14c9e56501fec6839a19ed0b3">CMD_OTA_BUFFER_CHECK_ENABLE</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157ad6cb8e14c28145118b574848cf99bd03">CMD_OTA_BUFFER_CHECK</a>:</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a95dc40f45e868deaeeeba8054ea8d931">CMD_OTA_IMG_INFO</a>:</div><div class="line">        {</div><div class="line">            <a class="code" href="group___a_p_p___o_t_a___s_e_r_v_i_c_e___exported___functions.html#gae5f4db9ce82d4ec88555c7bfb35d6652">app_ota_cmd_handle</a>(cmd_len, cmd_ptr, app_idx);</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">        ...</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --><h4><a class="anchor" id="SPP_ACK_Handle"></a>
7.3.3 Add SPP ACK handle function to the spp data entrance</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___c_m_d___exported___functions.html#gae6e146af6a4381218d925b2dc90433e8">app_cmd_handler</a>(uint8_t *cmd_ptr, uint16_t cmd_len, uint8_t cmd_path, uint8_t rx_seqn,</div><div class="line">                     uint8_t app_idx)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span> (cmd_id)</div><div class="line">    {</div><div class="line">    <span class="keywordflow">case</span> <a class="code" href="group___a_p_p___c_m_d___exported___types.html#gga5cabd9d04994bbb9d426fa74f32b7157a43add34e0ccdb1ce00a21c0a0a28bf86">CMD_ACK</a>:</div><div class="line">        {</div><div class="line">            ...</div><div class="line">            <span class="keywordflow">if</span> (cmd_path == <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga5d33818623af7687eff8863825004c35a558e167e16c9c8f109efc813a025153f">CMD_PATH_UART</a>)</div><div class="line">            {</div><div class="line">               ...</div><div class="line">            }</div><div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cmd_path == <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga5d33818623af7687eff8863825004c35a2cfe9880e07a8da7b6433b13ee5639b4">CMD_PATH_LE</a>) || (cmd_path == <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga5d33818623af7687eff8863825004c35ad02df31c353532bddcf4743ad9d7725b">CMD_PATH_SPP</a>))</div><div class="line">            {</div><div class="line">                ...</div><div class="line">                <span class="keywordflow">if</span> (event_id == <a class="code" href="group___a_p_p___r_e_p_o_r_t.html#gga7726a52eb69945b78d3a5a1463a839c7a5247a95a843aa45833f8c2f90574bf70">EVENT_OTA_ACTIVE_ACK</a>)</div><div class="line">                {</div><div class="line">                   <a class="code" href="group___a_p_p___o_t_a___s_e_r_v_i_c_e___exported___functions.html#ga9d811a80c1972ddca4b0ff70af69a855">app_ota_cmd_ack_handle</a>(event_id, status);</div><div class="line">                }</div><div class="line">                ...</div><div class="line">            }</div><div class="line">        }</div><div class="line">        <span class="keywordflow">break</span>;</div><div class="line">    ...</div><div class="line">    }</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --> <h4><a class="anchor" id="ADD_SPP_CMD"></a>
7.3.4 Add new SPP command handle to this function</h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___o_t_a___s_e_r_v_i_c_e___exported___functions.html#gae5f4db9ce82d4ec88555c7bfb35d6652">app_ota_cmd_handle</a>(uint16_t length, uint8_t *p_value, uint8_t app_idx)</div><div class="line">{</div><div class="line">    ...</div><div class="line">    <span class="keywordflow">switch</span>(cmd_id)</div><div class="line">    {</div><div class="line">       ...</div><div class="line">    }</div><div class="line">}</div></div><!-- fragment --> <h3><a class="anchor" id="Sync_Message"></a>
7.4 Sync message between two buds</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___a_p_p___o_t_a___s_e_r_v_i_c_e___exported___functions.html#ga4e662910fae96cac24e54144ac648bc7">app_ota_handle_remote_msg</a>(<a class="code" href="group___a_p_p___r_e_l_a_y.html#ga5d2ae11db7e04f6c645f23fb43a963d0">T_APP_REMOTE_MSG</a> msg, <span class="keywordtype">void</span> *buf, uint16_t len)</div><div class="line">{</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><div style="page-break-after: always;"></div><h2><a class="anchor" id="HowToUseTool"></a>
8 How to Use Tool</h2>
<h3><a class="anchor" id="Prepare_images"></a>
8.1 Prepare the image to update</h3>
<p>The OTA header generate tool and image pack tool are all integrated into the MP Programming Tool </p><div class="image">
<img src="MP_Programing_Tool.png" alt="MP_Programing_Tool.png"/>
</div>
 <center><div id="figure_8_1"><b>Figure 8-1 MP Programing Tool</b></div></center> <h4><a class="anchor" id="Generate_OTA_Header"></a>
8.1.1 Generate OTA Header</h4>
<p>Load flash_map.ini(e.g. RTL87X3E-SDK-VX.X.X.X\bin\flash_map_config\flash_4M\flash_map.ini) and RSA key (e.g. RTL87X3E-SDK-VX.X.X.X\tool\Gadgets\default_rsa_key.pem). Select bank0 or bank1 and fill in the version(ver_val) manually to generate the OTA header bin. </p><div class="image">
<img src="Generate_OTA_Header.png" alt="Generate_OTA_Header.png"/>
</div>
 <center><div id="figure_8_2"><b>Figure 8-2 Generate OTA Header</b></div></center><h4><a class="anchor" id="Pack_Whole_Image"></a>
8.1.2 Pack whole Image</h4>
<p>Load flash_map.ini (e.g. RTL87X3E-SDK-VX.X.X.X\bin\flash_map_config\flash_4M\flash_map.ini), then select bank0 and bank1 to add files for packing the whole images in both banks(except System Config File and Boot Patch File). </p><div class="image">
<img src="Pack_Whole_Image.png" alt="Pack_Whole_Image.png"/>
</div>
 <center><div id="figure_8_3"><b>Figure 8-3 Pack Whole Image</b></div></center><p><b>Note:</b> Please refer to MPPG Tool Chain User Guide in the tool\MPPG Tool directory for details.</p>
<h3><a class="anchor" id="IOS_OTA"></a>
8.2 IOS OTA Tool User Guide</h3>
<p>Step 1 Enable RTK App advertising on the LE page in MCU Config Tool. Then switch to the key tab to configure the key to trigger BLE adv (here take Hybrid key 3 as an example). Click the Export button to generate a new APP and CFG config bin to download into EVB. So the user can press the configured key to trigger BLE adv after power on. </p><div class="image">
<img src="Trigger_BLE_adv3.png" alt="Trigger_BLE_adv3.png"/>
</div>
 <center><div id="figure_8_4"><b>Figure 8-4 Enable RTK App advertising</b></div></center> <div class="image">
<img src="Trigger_BLE_adv1.png" alt="Trigger_BLE_adv1.png"/>
</div>
 <center><div id="figure_8_5"><b>Figure 8-5 Trigger BLE adv1</b></div></center> <div class="image">
<img src="Trigger_BLE_adv2.png" alt="Trigger_BLE_adv2.png"/>
</div>
 <center><div id="figure_8_6"><b>Figure 8-6 Trigger BLE adv2</b></div></center><p>Step 2 Connect With Target Device. And the device information including the image version will be shown in the UI. </p><div class="image">
<img src="IOS_Select_Device.png" alt="IOS_Select_Device.png"/>
</div>
 <center><div id="figure_8_7"><b>Figure 8-7 IOS Select Device</b></div></center> <div class="image">
<img src="IOS_Device_Information.png" alt="IOS_Device_Information.png"/>
</div>
 <center><div id="figure_8_8"><b>Figure 8-8 IOS Device Information</b></div></center><p>Step 3 Select firmware and the firmware version will be shown below. </p><div class="image">
<img src="IOS_Select_Firmware.png" alt="IOS_Select_Firmware.png"/>
</div>
 <center><div id="figure_8_9"><b>Figure 8-9 IOS Select Firmware</b></div></center><div class="image">
<img src="IOS_Firmware_Version.png" alt="IOS_Firmware_Version.png"/>
</div>
 <center><div id="figure_8_10"><b>Figure 8-10 IOS Firmware Version</b></div></center><p>Step 4 Start Updating Progress </p><div class="image">
<img src="IOS_Updating_Progress.png" alt="IOS_Updating_Progress.png"/>
</div>
 <center><div id="figure_8_11"><b>Figure 8-11 IOS Updating Progress</b></div></center><h3><a class="anchor" id="Android_OTA"></a>
8.3 Android OTA Tool User Guide</h3>
<p>Step 1 Let your device support the spp profile and enter pairable mode</p>
<p>Step 2 Connect With Device Open the tool and scan the device to set up a connection. Click the device name after connecting, the device info will be shown below. </p><div class="image">
<img src="Android_Select_Device.png" alt="Android_Select_Device.png"/>
</div>
 <center><div id="figure_8_12"><b>Figure 8-12 Android Select Device</b></div></center> <div class="image">
<img src="Android_Device_Information.png" alt="Android_Device_Information.png"/>
</div>
 <center><div id="figure_8_13"><b>Figure 8-13 Android Device Information</b></div></center><p>Step3 Select the firmware to upgrade Select firmware, then the firmware version will be shown after clicking the firmware name. </p><div class="image">
<img src="Android_Select_Firmware.png" alt="Android_Select_Firmware.png"/>
</div>
 <center><div id="figure_8_14"><b>Figure 8-14 Android Select Firmware</b></div></center><div class="image">
<img src="Android_Firmware_Version.png" alt="Android_Firmware_Version.png"/>
</div>
 <center><div id="figure_8_15"><b>Figure 8-15 Android Firmware Version</b></div></center><p>Step4 Updating Progress There will be a bar to show Updating progress, and Updating results will also be shown. </p><div class="image">
<img src="Android_Updating_Progress.png" alt="Android_Updating_Progress.png"/>
</div>
 <center><div id="figure_8_16"><b>Figure 8-16 Android Updating Progress</b></div></center> </div></div><!-- contents -->

<HR SIZE=5>
<font size="3" color="black">Copyright(c) 2020, <a href=" http://www.realtek.com.tw/"><font size="3" color="#6FB7B7"><b>Realtek Semiconductor Corporation</b></font></a>. All rights reserved.</font> 
